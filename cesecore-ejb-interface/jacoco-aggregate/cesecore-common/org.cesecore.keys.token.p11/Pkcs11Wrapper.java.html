<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Pkcs11Wrapper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cesecore-ejb-interface</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.keys.token.p11</a> &gt; <span class="el_source">Pkcs11Wrapper.java</span></div><h1>Pkcs11Wrapper.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.keys.token.p11;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

import org.apache.log4j.Logger;

/**
 *
 * This class wraps sun.security.pkcs11.wrapper.PKCS11, so that we can access the native PKCS11 calls
 * directly.
 * A slot list and token labels for each slot is cached so that C_GetSlotList() only has to be called once and
 * so that C_GetTokenInfo() only has to be called once for each slot.
 *
 * The {@link #getInstance(File)} method must be called before any PKCS#11 provider is created.
 *
 *  @version $Id: Pkcs11Wrapper.java 27614 2017-12-21 08:55:51Z bastianf $
 *
 */
public class Pkcs11Wrapper {
<span class="nc" id="L40">    private static final Logger log = Logger.getLogger(Pkcs11Wrapper.class);</span>

<span class="nc" id="L42">    private static volatile Map&lt;String, Pkcs11Wrapper&gt; instances = new HashMap&lt;String, Pkcs11Wrapper&gt;();</span>
<span class="nc" id="L43">    private static final Lock lock = new ReentrantLock();</span>
    private final Method getSlotListMethod;
    private final Method getTokenInfoMethod;
    private final Field labelField;
    private final Object p11;
    private final HashMap&lt;Long, char[]&gt; labelMap;
    private final long slotList[];

<span class="nc" id="L51">    private Pkcs11Wrapper(final String fileName) {</span>
        final Class&lt;? extends Object&gt; p11Class;
        try {
<span class="nc" id="L54">            p11Class = Class.forName(&quot;sun.security.pkcs11.wrapper.PKCS11&quot;);</span>
<span class="nc" id="L55">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L56">            String msg = &quot;Class sun.security.pkcs11.wrapper.PKCS11 was not found locally, could not wrap.&quot;;</span>
<span class="nc" id="L57">            log.error(msg, e);</span>
<span class="nc" id="L58">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L59">        }</span>

        try {
<span class="nc" id="L62">            this.getSlotListMethod = p11Class.getDeclaredMethod(&quot;C_GetSlotList&quot;, new Class[] { boolean.class });</span>
<span class="nc" id="L63">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L64">            String msg = &quot;Method C_GetSlotList was not found in class sun.security.pkcs11.wrapper.PKCS11, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L66">            log.error(msg, e);</span>
<span class="nc" id="L67">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L68">        } catch (SecurityException e) {</span>
<span class="nc" id="L69">            String msg = &quot;Access was denied to method sun.security.pkcs11.wrapper.PKCS11.C_GetSlotList&quot;;</span>
<span class="nc" id="L70">            log.error(msg, e);</span>
<span class="nc" id="L71">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L72">        }</span>
        try {
<span class="nc" id="L74">            this.getTokenInfoMethod = p11Class.getDeclaredMethod(&quot;C_GetTokenInfo&quot;, new Class[] { long.class });</span>
<span class="nc" id="L75">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L76">            String msg = &quot;Method C_GetTokenInfo was not found in class sun.security.pkcs11.wrapper.PKCS11, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L78">            log.error(msg, e);</span>
<span class="nc" id="L79">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L80">        } catch (SecurityException e) {</span>
<span class="nc" id="L81">            String msg = &quot;Access was denied to method sun.security.pkcs11.wrapper.PKCS11.C_GetTokenInfo&quot;;</span>
<span class="nc" id="L82">            log.error(msg, e);</span>
<span class="nc" id="L83">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L84">        }</span>
        try {
<span class="nc" id="L86">            this.labelField = Class.forName(&quot;sun.security.pkcs11.wrapper.CK_TOKEN_INFO&quot;).getField(&quot;label&quot;);</span>
<span class="nc" id="L87">        } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L88">            String msg = &quot;Field 'label' was not found in class sun.security.pkcs11.wrapper.CK_TOKEN_INFO, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L90">            log.error(msg, e);</span>
<span class="nc" id="L91">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L92">        } catch (SecurityException e) {</span>
<span class="nc" id="L93">            String msg = &quot;Access was denied to field sun.security.pkcs11.wrapper.CK_TOKEN_INFO.label&quot;;</span>
<span class="nc" id="L94">            log.error(msg, e);</span>
<span class="nc" id="L95">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L96">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L97">            String msg = &quot;Class sun.security.pkcs11.wrapper.CK_TOKEN_INFO was not found locally, could not wrap.&quot;;</span>
<span class="nc" id="L98">            log.error(msg, e);</span>
<span class="nc" id="L99">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L100">        }</span>
        final Method getInstanceMethod;
        try {
<span class="nc" id="L103">            getInstanceMethod = p11Class.getDeclaredMethod(&quot;getInstance&quot;,</span>
<span class="nc" id="L104">                    new Class[] { String.class, String.class, Class.forName(&quot;sun.security.pkcs11.wrapper.CK_C_INITIALIZE_ARGS&quot;), boolean.class });</span>
<span class="nc" id="L105">        } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L106">            String msg = &quot;Method getInstance was not found in class sun.security.pkcs11.wrapper.PKCS11.CK_C_INITIALIZE_ARGS, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L108">            log.error(msg, e);</span>
<span class="nc" id="L109">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L110">        } catch (SecurityException e) {</span>
<span class="nc" id="L111">            String msg = &quot;Access was denied to method sun.security.pkcs11.wrapper.CK_C_INITIALIZE_ARGS.getInstance&quot;;</span>
<span class="nc" id="L112">            log.error(msg, e);</span>
<span class="nc" id="L113">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L114">        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L115">            String msg = &quot;Class sun.security.pkcs11.wrapper.CK_C_INITIALIZE_ARGS was not found locally, could not wrap.&quot;;</span>
<span class="nc" id="L116">            log.error(msg, e);</span>
<span class="nc" id="L117">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L118">        }</span>
        try {
<span class="nc" id="L120">            this.p11 = getInstanceMethod.invoke(null, new Object[] { fileName, &quot;C_GetFunctionList&quot;, null, Boolean.FALSE });</span>
<span class="nc" id="L121">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L122">            String msg = &quot;Method sun.security.pkcs11.wrapper.PKCS11.CK_C_INITIALIZE_ARGS.getInstance was not accessible, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L124">            log.error(msg, e);</span>
<span class="nc" id="L125">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L126">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L127">            String msg = &quot;Wrong arguments were passed to sun.security.pkcs11.wrapper.PKCS11.CK_C_INITIALIZE_ARGS.getInstance. This may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L129">            log.error(msg, e);</span>
<span class="nc" id="L130">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L131">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L132">            String msg = &quot;Wrong arguments were passed to sun.security.pkcs11.wrapper.PKCS11.CK_C_INITIALIZE_ARGS.getInstance threw an exception &quot;</span>
                    + &quot;for log.error(msg, e)&quot;;
<span class="nc" id="L134">            log.error(msg, e);</span>
<span class="nc" id="L135">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">        this.labelMap = new HashMap&lt;Long, char[]&gt;();</span>
<span class="nc" id="L138">        this.slotList = C_GetSlotList();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        for( long id : this.slotList) {</span>
<span class="nc" id="L140">            this.labelMap.put(Long.valueOf(id), getTokenLabelLocal(id));</span>
        }
<span class="nc" id="L142">    }</span>

    /**
     * Get an instance of the class.
     * @param file the p11 .so file.
     * @return the instance.
     * @throws IllegalArgumentException on fail
     */
    public static Pkcs11Wrapper getInstance(final File file) throws IllegalArgumentException {
        final String canonicalFileName;
        try {
<span class="nc" id="L153">            canonicalFileName = file.getCanonicalPath();</span>
<span class="nc" id="L154">        } catch (IOException e) {</span>
<span class="nc" id="L155">            throw new IllegalArgumentException(file+&quot; is not a valid filename.&quot;,e );</span>
<span class="nc" id="L156">        }</span>
        {
<span class="nc" id="L158">            final Pkcs11Wrapper storedP11 = instances.get(canonicalFileName);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (storedP11 != null) {</span>
<span class="nc" id="L160">                return storedP11;// if instance exist we don't have to wait for lock just grab it.</span>
            }
        }
        try {
<span class="nc" id="L164">            lock.lock();// wait for lock; some other tread might be creating the instance right now.</span>
<span class="nc" id="L165">            final Pkcs11Wrapper storedP11 = instances.get(canonicalFileName);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (storedP11 != null) {</span>
<span class="nc" id="L167">                return storedP11;// some other thread had already created the instance</span>
            }
            // no other thread has created the instance and no other will since this thread is locking.
<span class="nc" id="L170">            Pkcs11SlotLabel.doC_Initialize(file);// C_Initialize with multithreading args.</span>
<span class="nc" id="L171">            final Pkcs11Wrapper newP11 = new Pkcs11Wrapper(canonicalFileName);</span>
<span class="nc" id="L172">            instances.put(canonicalFileName, newP11);</span>
<span class="nc" id="L173">            return newP11;</span>
        } finally {
<span class="nc" id="L175">            lock.unlock();// now other threads might get the instance.</span>
        }
    }

    /**
     * Get a list of p11 slot IDs to slots that has a token.
     * @return the list.
     */
    public long[] getSlotList() {
<span class="nc" id="L184">        return this.slotList;</span>
    }

    /**
     * Get the token label of a specific slot ID.
     * @param slotID the ID of the slot
     * @return the token label, or null if no matching token was found.
     */
    public char[] getTokenLabel(long slotID) {
<span class="nc" id="L193">        return this.labelMap.get(Long.valueOf(slotID));</span>
    }

    private long[] C_GetSlotList() {
        try {
<span class="nc" id="L198">            return (long[]) this.getSlotListMethod.invoke(this.p11, new Object[] { Boolean.TRUE });</span>
<span class="nc" id="L199">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L200">            String msg = &quot;Access was denied to method sun.security.pkcs11.wrapper.PKCS11C.GetSlotList, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L202">            log.error(msg, e);</span>
<span class="nc" id="L203">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L204">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L205">            String msg = &quot;Incorrect parameters sent to sun.security.pkcs11.wrapper.PKCS11C.GetSlotList, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L207">            log.error(msg, e);</span>
<span class="nc" id="L208">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L209">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L210">            String msg = &quot;Method sun.security.pkcs11.wrapper.PKCS11C.GetSlotList threw an unknown exception.&quot;;</span>
<span class="nc" id="L211">            log.error(msg, e);</span>
<span class="nc" id="L212">            throw new IllegalStateException(msg, e);</span>
        }
    }

    private char[] getTokenLabelLocal(long slotID)  {
        final Object tokenInfo;
        try {
<span class="nc" id="L219">            tokenInfo = this.getTokenInfoMethod.invoke(this.p11, new Object[] { Long.valueOf(slotID) });</span>
<span class="nc" id="L220">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L221">            String msg = &quot;Access was denied to method sun.security.pkcs11.wrapper.PKCS11.C_GetTokenInfo, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L223">            log.error(msg, e);</span>
<span class="nc" id="L224">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L225">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L226">            String msg = &quot;Incorrect parameters sent to sun.security.pkcs11.wrapper.PKCS11.C_GetTokenInfo, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L228">            log.error(msg, e);</span>
<span class="nc" id="L229">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L230">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L231">            String msg = &quot;Method sun.security.pkcs11.wrapper.PKCS11.C_GetTokenInfo threw an unknown exception.&quot;;</span>
<span class="nc" id="L232">            log.error(msg, e);</span>
<span class="nc" id="L233">            return null;</span>
<span class="nc" id="L234">        }</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (tokenInfo == null) {</span>
<span class="nc" id="L236">            return null;</span>
        }
        try {
<span class="nc" id="L239">            String result = String.copyValueOf((char[]) this.labelField.get(tokenInfo));</span>
<span class="nc" id="L240">            return result.trim().toCharArray();</span>
<span class="nc" id="L241">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L242">            String msg = &quot;Field sun.security.pkcs11.wrapper.PKCS11.C_GetTokenInfo was not of type sun.security.pkcs11.wrapper.CK_TOKEN_INFO&quot;</span>
                    + &quot;, this may be due to a change in the underlying library.&quot;;
<span class="nc" id="L244">            log.error(msg, e);</span>
<span class="nc" id="L245">            throw new IllegalStateException(msg, e);</span>
<span class="nc" id="L246">        } catch (IllegalAccessException e) {</span>
<span class="nc" id="L247">            String msg = &quot;Access was denied to field sun.security.pkcs11.wrapper.CK_TOKEN_INFO.label, this may be due to&quot;</span>
                    + &quot; a change in the underlying library.&quot;;
<span class="nc" id="L249">            log.error(msg, e);</span>
<span class="nc" id="L250">            throw new IllegalStateException(msg, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>