<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserDataVO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ejbca-common</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ra</a> &gt; <span class="el_source">UserDataVO.java</span></div><h1>UserDataVO.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
 
package org.ejbca.core.model.ra;

import java.beans.XMLEncoder;
import java.io.IOException;
import java.io.Serializable;
import java.io.UnsupportedEncodingException;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.HashMap;

import org.cesecore.certificates.endentity.EndEntityInformation;
import org.cesecore.certificates.endentity.EndEntityType;
import org.cesecore.certificates.endentity.EndEntityTypes;
import org.cesecore.certificates.util.dn.DNFieldsUtil;
import org.cesecore.util.Base64GetHashMap;
import org.cesecore.util.Base64PutHashMap;
import org.cesecore.util.SecureXMLDecoder;
import org.cesecore.util.StringTools;


/**
 * Holds admin data collected from UserData in the database. Strings are stored in Base64 encoded format to be safe for storing in database, xml etc.
 *
 * NOTE! This class is not to be extended anymore. It is kept for backwards serialization compatibility only.
 * use class EndEntityInformation instead.
 *
 * @version $Id: UserDataVO.java 34165 2020-01-02 15:18:44Z samuellb $
 * @deprecated Use org.cesecore.certificates.endentity.EndEntityInformation instead. Since EJBCA 5.0.0.
 */
public class UserDataVO implements Serializable {

    /**
     * Determines if a de-serialized file is compatible with this class.
     *
     * Maintainers must change this value if and only if the new version
     * of this class is not compatible with old versions. See Sun docs
     * for &lt;a href=http://java.sun.com/products/jdk/1.1/docs/guide
     * /serialization/spec/version.doc.html&gt; details. &lt;/a&gt;
     *
     */
    private static final long serialVersionUID = 3837505643343885941L;

    // Public constants
    public static final int NO_ENDENTITYPROFILE    = 0;
    public static final int NO_CERTIFICATEPROFILE  = 0;


    private String username;
    private String subjectDN;
<span class="nc" id="L63">    transient private String subjectDNClean = null;</span>
    private int caid;
    private String subjectAltName;
    private String subjectEmail;
    private String password;
    private String cardNumber;
    /** Status of user, from EndEntityConstants.STATUS_XX */
    private int status;
    /** Type of user, from SecConst */
<span class="nc" id="L72">    private EndEntityType type = EndEntityTypes.INVALID.toEndEntityType();</span>
    private int endentityprofileid;
    private int certificateprofileid;
    private Date timecreated;
    private Date timemodified;
    private int tokentype;
    private int hardtokenissuerid;
    private ExtendedInformation extendedinformation;

    /** Creates new empty UserDataVO */
<span class="nc" id="L82">    public UserDataVO() {</span>
<span class="nc" id="L83">    }</span>

    /**
     * Creates new UserDataVO. All fields are almost required in this constructor. Password must
     * be set manually though. This is so you should be sure what you do with the password.
     *
     * @param user DOCUMENT ME!
     * @param dn DOCUMENT ME!
     * @param caid CA id of the CA that the user is registered with
     * @param subjectaltname DOCUMENT ME!
     * @param email DOCUMENT ME!
     * @param status DOCUMENT ME!
     * @param type one of SecConst.ENDUSER || ...
     * @param endentityprofileid DOCUMENT ME!
     * @param certificateprofileid DOCUMENT ME!
     * @param timecreated DOCUMENT ME!
     * @param timemodified DOCUMENT ME!
     * @param tokentype DOCUMENT ME!
     * @param hardtokenissuerid DOCUMENT ME!
     * @param extendedinfo Info

     */
    public UserDataVO(String user, String dn, int caid, String subjectaltname, String email, int status, EndEntityType type, int endentityprofileid, int certificateprofileid,
<span class="nc" id="L106">                         Date timecreated, Date timemodified, int tokentype, int hardtokenissuerid, ExtendedInformation extendedinfo) {</span>
<span class="nc" id="L107">        setUsername(user);</span>
<span class="nc" id="L108">        setPassword(null);</span>
<span class="nc" id="L109">        setCardNumber(null);</span>
<span class="nc" id="L110">        setDN(dn);</span>
<span class="nc" id="L111">        setCAId(caid);</span>
<span class="nc" id="L112">        setSubjectAltName(subjectaltname);</span>
<span class="nc" id="L113">        setEmail(email);</span>
<span class="nc" id="L114">        setStatus(status);</span>
<span class="nc" id="L115">        setType(type);</span>
<span class="nc" id="L116">        setEndEntityProfileId(endentityprofileid);</span>
<span class="nc" id="L117">        setCertificateProfileId(certificateprofileid);</span>
<span class="nc" id="L118">        setTimeCreated(timecreated);</span>
<span class="nc" id="L119">        setTimeModified(timemodified);</span>
<span class="nc" id="L120">        setTokenType(tokentype);</span>
<span class="nc" id="L121">        setHardTokenIssuerId(hardtokenissuerid);</span>
<span class="nc" id="L122">        setExtendedinformation(extendedinfo);</span>
<span class="nc" id="L123">        setCardNumber(null);</span>
<span class="nc" id="L124">    }</span>
    
    /**
     * Creates new UserDataVO. This constructor should only be used from UserDataSource 
     * implementations. Status and dates aren't used in these cases.
     * 
     *  @param user DOCUMENT ME!
     * @param dn DOCUMENT ME!
     * @param caid CA id of the CA that the user is registered with
     * @param subjectaltname DOCUMENT ME!
     * @param email DOCUMENT ME!
     * @param type one of SecConst.ENDUSER || ...
     * @param endentityprofileid DOCUMENT ME!
     * @param certificateprofileid DOCUMENT ME!
     * @param tokentype DOCUMENT ME!
     * @param hardtokenissuerid DOCUMENT ME!
     * @param extendedinfo Info
     */
    public UserDataVO(String user, String dn, int caid, String subjectaltname, String email,  EndEntityType type, int endentityprofileid, int certificateprofileid,
<span class="nc" id="L143">                          int tokentype, int hardtokenissuerid, ExtendedInformation extendedinfo) {</span>
<span class="nc" id="L144">        setUsername(user);</span>
<span class="nc" id="L145">        setPassword(null);</span>
<span class="nc" id="L146">        setDN(dn);</span>
<span class="nc" id="L147">        setCAId(caid);</span>
<span class="nc" id="L148">        setSubjectAltName(subjectaltname);</span>
<span class="nc" id="L149">        setEmail(email);        </span>
<span class="nc" id="L150">        setType(type);</span>
<span class="nc" id="L151">        setEndEntityProfileId(endentityprofileid);</span>
<span class="nc" id="L152">        setCertificateProfileId(certificateprofileid);</span>
<span class="nc" id="L153">        setTokenType(tokentype);</span>
<span class="nc" id="L154">        setHardTokenIssuerId(hardtokenissuerid);</span>
<span class="nc" id="L155">        setExtendedinformation(extendedinfo);</span>
<span class="nc" id="L156">        setCardNumber(null);</span>
<span class="nc" id="L157">    }</span>
    
    
<span class="nc" id="L160">    public void setUsername(String user) { this.username=StringTools.putBase64String(StringTools.stripUsername(user));}</span>
<span class="nc" id="L161">    public String getUsername() {return StringTools.getBase64String(username);}</span>
    public void setDN(String dn) {
<span class="nc" id="L163">    	final StringBuilder removedAllEmpties = new StringBuilder(dn.length());</span>
<span class="nc" id="L164">    	final StringBuilder removedTrailingEmpties = DNFieldsUtil.removeEmpties(dn, removedAllEmpties, true);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">    	if (removedTrailingEmpties == null) {</span>
<span class="nc" id="L166">        	this.subjectDNClean=StringTools.putBase64String(removedAllEmpties.toString());</span>
<span class="nc" id="L167">        	this.subjectDN=this.subjectDNClean;</span>
    	} else {
<span class="nc" id="L169">        	this.subjectDNClean=StringTools.putBase64String(removedAllEmpties.toString());</span>
<span class="nc" id="L170">        	this.subjectDN=StringTools.putBase64String(removedTrailingEmpties.toString());</span>
    	}
<span class="nc" id="L172">    }</span>
    /** User DN as stored in the database. If the registered DN has unused DN fields the empty ones are kept, i.e.
     * CN=Tomas,OU=,OU=PrimeKey,C=SE. See ECA-1841 for an explanation of this.
     * Use method getCertificateDN() to get the DN stripped from empty fields.
     * @see #getCertificateDN()
     * @return String with DN, might contain empty fields, use getCertificateDN to get without empty fields
     */
<span class="nc" id="L179">    public String getDN() {return StringTools.getBase64String(subjectDN);}</span>
<span class="nc" id="L180">    public int getCAId(){return this.caid;}</span>
<span class="nc" id="L181">    public void setCAId(int caid){this.caid=caid;}</span>
<span class="nc" id="L182">    public void setSubjectAltName( String subjectaltname) { this.subjectAltName=StringTools.putBase64String(subjectaltname); }</span>
<span class="nc" id="L183">    public String getSubjectAltName() {return StringTools.getBase64String(subjectAltName);}</span>
<span class="nc" id="L184">    public void setEmail(String email) {this.subjectEmail = StringTools.putBase64String(email);}</span>
<span class="nc" id="L185">    public String getEmail() {return StringTools.getBase64String(subjectEmail);}</span>
<span class="nc" id="L186">    public void setCardNumber(String cardNumber) {this.cardNumber =  StringTools.putBase64String(cardNumber);}</span>
<span class="nc" id="L187">    public String getCardNumber() {return StringTools.getBase64String(cardNumber);}</span>
<span class="nc" id="L188">    public void setPassword(String pwd) {this.password = StringTools.putBase64String(pwd);}</span>
<span class="nc" id="L189">    public String getPassword() {return StringTools.getBase64String(password);}</span>
<span class="nc" id="L190">    public void setStatus(int status) {this.status=status;}</span>
<span class="nc" id="L191">    public int getStatus() {return status;}</span>
<span class="nc" id="L192">    public void setType(EndEntityType type) {this.type=type;}</span>
<span class="nc" id="L193">    public EndEntityType getType() {return type;}</span>
<span class="nc" id="L194">    public void setEndEntityProfileId(int endentityprofileid) { this.endentityprofileid=endentityprofileid; }</span>
<span class="nc" id="L195">    public int getEndEntityProfileId(){ return this.endentityprofileid; }</span>
<span class="nc" id="L196">    public void setCertificateProfileId(int certificateprofileid) { this.certificateprofileid=certificateprofileid; }</span>
<span class="nc" id="L197">    public int getCertificateProfileId() {return this.certificateprofileid;}</span>
<span class="nc" id="L198">    public void setTimeCreated(Date timecreated) { this.timecreated=timecreated; }</span>
<span class="nc" id="L199">    public Date getTimeCreated() {return this.timecreated;}</span>
<span class="nc" id="L200">    public void setTimeModified(Date timemodified) { this.timemodified=timemodified; }</span>
<span class="nc" id="L201">    public Date getTimeModified() {return this.timemodified;}</span>
<span class="nc" id="L202">    public int getTokenType(){ return this.tokentype;}</span>
<span class="nc" id="L203">    public void setTokenType(int tokentype) {this.tokentype=tokentype;}</span>
<span class="nc" id="L204">    public int getHardTokenIssuerId() {return this.hardtokenissuerid;}</span>
<span class="nc" id="L205">    public void setHardTokenIssuerId(int hardtokenissuerid) { this.hardtokenissuerid=hardtokenissuerid;}</span>

    /**
     * @return bool
     * @deprecated from EJBCA 3.8.0. The admin property is no longer used. This method is still used for deserializing objects in CertReqHistoryDataBean. 
     */
    public boolean getAdministrator(){
<span class="nc" id="L212">      return type.contains(EndEntityTypes.ADMINISTRATOR);</span>
    }

    /**
     * @param administrator admin
     * @deprecated from EJBCA 3.8.0. The admin property is no longer used. This method is still used for deserializing objects in CertReqHistoryDataBean. 
     */
    public void setAdministrator(boolean administrator){
<span class="nc bnc" id="L220" title="All 2 branches missed.">      if(administrator) {</span>
<span class="nc" id="L221">        type.addType(EndEntityTypes.ADMINISTRATOR);</span>
      } else {
<span class="nc" id="L223">        type.removeType(EndEntityTypes.ADMINISTRATOR);</span>
      }
<span class="nc" id="L225">    }</span>

    public boolean getKeyRecoverable(){
<span class="nc" id="L228">      return type.contains(EndEntityTypes.KEYRECOVERABLE);</span>
    }

    public void setKeyRecoverable(boolean keyrecoverable){
<span class="nc bnc" id="L232" title="All 2 branches missed.">      if(keyrecoverable) {</span>
<span class="nc" id="L233">        type.addType(EndEntityTypes.KEYRECOVERABLE);</span>
      } else {
<span class="nc" id="L235">        type.removeType(EndEntityTypes.KEYRECOVERABLE);</span>
      }
<span class="nc" id="L237">    }</span>

    public boolean getSendNotification(){
<span class="nc" id="L240">      return type.contains(EndEntityTypes.SENDNOTIFICATION);</span>
    }

    
    public void setSendNotification(boolean sendnotification){
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if(sendnotification) {</span>
<span class="nc" id="L246">        type.addType(EndEntityTypes.SENDNOTIFICATION);</span>
      } else {
<span class="nc" id="L248">        type.removeType(EndEntityTypes.SENDNOTIFICATION);</span>
      }
<span class="nc" id="L250">    }</span>
    
    public boolean getPrintUserData(){
<span class="nc" id="L253">        return type.contains(EndEntityTypes.PRINT);</span>
      }

    public void setPrintUserData(boolean printUserData){
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if(printUserData) {</span>
<span class="nc" id="L258">          type.addType(EndEntityTypes.PRINT);</span>
        } else {
<span class="nc" id="L260">          type.removeType(EndEntityTypes.PRINT);</span>
        }
<span class="nc" id="L262">   }</span>

	/**
	 * @return Returns the extendedinformation or null if no extended information exists.
	 */
	public ExtendedInformation getExtendedinformation() {
<span class="nc" id="L268">		return extendedinformation;</span>
	}
	/**
	 * @param extendedinformation The extendedinformation to set.
	 */
	public void setExtendedinformation(ExtendedInformation extendedinformation) {
<span class="nc" id="L274">		this.extendedinformation = extendedinformation;</span>
<span class="nc" id="L275">	}</span>
	
	
    /**
     * Help Method used to create an ExtendedInformation from String representation.
     * Used when creating an ExtendedInformation from queries.
     * @param extendedinfostring Info
     * @return Admin
     */
    public static ExtendedInformation getExtendedInformation(String extendedinfostring) {
<span class="nc" id="L285">        ExtendedInformation returnval = null;</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">        if ( (extendedinfostring != null) &amp;&amp; (extendedinfostring.length() &gt; 0) ) {</span>
<span class="nc" id="L287">            try (SecureXMLDecoder decoder = new SecureXMLDecoder(new java.io.ByteArrayInputStream(extendedinfostring.getBytes(StandardCharsets.UTF_8)))) {            	</span>
            	@SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L289">                HashMap h = (HashMap) decoder.readObject();</span>
                // Handle Base64 encoded string values
                @SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc" id="L292">                HashMap data = new Base64GetHashMap(h);</span>
<span class="nc" id="L293">            	int type = ((Integer) data.get(ExtendedInformation.TYPE)).intValue();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            	switch(type){</span>
            	  case ExtendedInformation.TYPE_BASIC :
<span class="nc" id="L296">              		returnval = new ExtendedInformation();            	</span>
<span class="nc" id="L297">              		returnval.loadData(data);</span>
              		break;
            	}            	
<span class="nc" id="L300">            } catch (IOException e) {</span>
<span class="nc" id="L301">            	throw new RuntimeException(&quot;Problems generating extended information from String&quot;,e);</span>
<span class="nc" id="L302">            }</span>
        }
<span class="nc" id="L304">        return returnval;</span>
    }
    
    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    public static String extendedInformationToStringData(ExtendedInformation extendedinformation) throws UnsupportedEncodingException {
<span class="nc" id="L309">    	String ret = null;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    	if(extendedinformation != null){</span>
            // We must base64 encode string for UTF safety
<span class="nc" id="L312">            HashMap a = new Base64PutHashMap();</span>
<span class="nc" id="L313">            a.putAll((HashMap)extendedinformation.saveData());</span>
<span class="nc" id="L314">            java.io.ByteArrayOutputStream baos = new java.io.ByteArrayOutputStream();</span>
<span class="nc" id="L315">    	    try (XMLEncoder encoder = new XMLEncoder(baos)) {</span>
<span class="nc" id="L316">                encoder.writeObject(a);</span>
    	    }
<span class="nc" id="L318">            ret = baos.toString(&quot;UTF8&quot;);</span>
    	}
<span class="nc" id="L320">    	return ret;</span>
    }

    /**
     * Returns the DN to be used when creating a certificate (without empty fields).
     * If the registered DN has unused DN fields the empty ones are kept, i.e.
     * CN=Tomas,OU=,OU=PrimeKey,C=SE. See ECA-1841 for an explanation of this.
     * Use method getCertificateDN() to get the DN stripped from empty fields, getDN() returns DN with empty fields.
     * @see #getDN()
     * @return String with DN, with no empty fields, use getDN to get including empty fields
     */
    public String getCertificateDN() {
<span class="nc bnc" id="L332" title="All 2 branches missed.">    	if (subjectDNClean == null) {</span>
    		// This might be fetched from database serialization so we need to perform the cleaning all over again
<span class="nc" id="L334">    		return DNFieldsUtil.removeAllEmpties(getDN());</span>
    	} else {
<span class="nc" id="L336">            return StringTools.getBase64String(subjectDNClean);</span>
    	}
    }
    
    /** Helper method to convert this old deprecated type to the new EndEntityInformation
     * 
     * @return EndEntityInformation 
     */
    public EndEntityInformation toEndEntityInformation() {
<span class="nc" id="L345">    	org.cesecore.certificates.endentity.ExtendedInformation newee = null;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">    	if (extendedinformation != null) {</span>
<span class="nc" id="L347">        	newee = new org.cesecore.certificates.endentity.ExtendedInformation();</span>
<span class="nc" id="L348">        	newee.loadData(extendedinformation.saveData());    		</span>
    	}
<span class="nc" id="L350">    	EndEntityInformation eei = new EndEntityInformation(getUsername(), getDN(), caid, getSubjectAltName(), getEmail(), type, </span>
    			endentityprofileid, certificateprofileid, tokentype, hardtokenissuerid, newee);
<span class="nc" id="L352">    	eei.setPassword(getPassword());</span>
<span class="nc" id="L353">    	eei.setCardNumber(getCardNumber());</span>
<span class="nc" id="L354">    	eei.setStatus(status);</span>
<span class="nc" id="L355">    	eei.setTimeCreated(timecreated);</span>
<span class="nc" id="L356">    	eei.setTimeModified(timemodified);</span>
<span class="nc" id="L357">    	eei.setTokenType(tokentype);</span>
<span class="nc" id="L358">    	eei.setHardTokenIssuerId(hardtokenissuerid);</span>
<span class="nc" id="L359">    	return eei;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>