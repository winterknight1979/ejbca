<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseUserDataSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA Common code</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ra.userdatasource</a> &gt; <span class="el_source">BaseUserDataSource.java</span></div><h1>BaseUserDataSource.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
 
package org.ejbca.core.model.ra.userdatasource;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Set;

import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.internal.UpgradeableDataHashMap;



/**
 * BaseUserDataSource is a basic class that should be inherited by all types
 * of userdatasources in the system.
 * 
 * Contains data like description, applicable CAs and modifyable fields.
 *  
 *
 * @version $Id: BaseUserDataSource.java 22675 2016-01-29 16:07:49Z samuellb $
 */
public abstract class BaseUserDataSource extends UpgradeableDataHashMap implements Serializable, Cloneable {

    private static final long serialVersionUID = 2359037086634246374L;
    public static final String TRUE  = &quot;true&quot;;
    public static final String FALSE = &quot;false&quot;;
    
    /** Constant indicating that any CA can be used with this user data source.*/
    public static final int ANYCA = -1;

    // Protected Constants.
	public static final String TYPE                           = &quot;type&quot;;
	
    protected static final String DESCRIPTION                 = &quot;DESCRIPTION&quot;;
    protected static final String APPLICABLECAS                = &quot;APPLICABLECAS&quot;;
    protected static final String MODIFYABLEFIELDS            = &quot;MODIFYABLEFIELDS&quot;;
		
    // Public Methods

    /**
     * Creates a new instance of CertificateProfile
     */
<span class="nc" id="L58">    public BaseUserDataSource() {</span>
<span class="nc" id="L59">      setDescription(&quot;&quot;);	</span>
      
<span class="nc" id="L61">      ArrayList&lt;Integer&gt; applicablecas = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L62">      setApplicableCAs(applicablecas);</span>
      
<span class="nc" id="L64">      HashSet&lt;Integer&gt; modifyableFields = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">      for(int i=0; i&lt; UserDataSourceVO.AVAILABLEMODIFYABLEFIELDS.length; i++){</span>
<span class="nc" id="L66">    	  modifyableFields.add(Integer.valueOf(UserDataSourceVO.AVAILABLEMODIFYABLEFIELDS[i]));</span>
      }
<span class="nc" id="L68">      setModifiableFields(modifyableFields);</span>
  
<span class="nc" id="L70">    }</span>

    // Public Methods
    /**
     * Returns the description of publisher
     * @return String
     */
<span class="nc" id="L77">    public String getDescription() { return (String) data.get(DESCRIPTION);}</span>

	/**
	 * Sets the description. 
	 * @param description String
	 */
<span class="nc" id="L83">	public void setDescription(String description){ data.put(DESCRIPTION, description); }</span>

    /**
     * Returns a Collections of caids (Integer), indicating which CAs the user data source should
     * be applicable to.
     *
     * If it contains the constant ANYCA then the user data source is applicable to all CAs
     * @return CA IDs
     */
    @SuppressWarnings(&quot;unchecked&quot;)
	public Collection&lt;Integer&gt; getApplicableCAs(){
<span class="nc" id="L94">      return (Collection&lt;Integer&gt;) data.get(APPLICABLECAS);   </span>
    }
    
    /**
     * Saves the  list of CAs the  user data source is applicable to.
     *
     * @param applicablecas a Collection of caids (Integer)
     */
    
    public void setApplicableCAs(Collection&lt;Integer&gt; applicablecas){
<span class="nc" id="L104">      data.put(APPLICABLECAS, applicablecas);   </span>
<span class="nc" id="L105">    }</span>
    
    /**
     * 
     * @return true if user data source is applicable for all CAs
     */
    @SuppressWarnings(&quot;unchecked&quot;)
	public boolean isApplicableToAnyCA(){
<span class="nc" id="L113">    	return ((Collection&lt;Integer&gt;) data.get(APPLICABLECAS)).contains(Integer.valueOf(ANYCA));</span>
    } 
    
    /**
     * @return a Set of UserDataSourceVO.ISMODIFYABLE_ and DNFIELDExtractor constants (Integer) constants (All definded in the UserDataSourceVO.AVAILABLEMODIFYABLEFIELDS, 
     * indicating if the field should be modifyable by the CA or not.
     *
     */
    @SuppressWarnings(&quot;unchecked&quot;)
	public Set&lt;Integer&gt; getModifiableFields(){
<span class="nc" id="L123">      return (Set&lt;Integer&gt;) data.get(MODIFYABLEFIELDS);   </span>
    }
    
    /**
     * Saves the set of which fields of the CA that should be modifyable by the RA or not.
     * The set should only contain UserDataSourceVO.ISMODIFYABLE_ and DNFIELDExtractor constants (Integer)
     * @param modifiableFields Fields
     */
    
    public void setModifiableFields(Set&lt;Integer&gt; modifiableFields){	
<span class="nc" id="L133">      data.put(MODIFYABLEFIELDS, modifiableFields);   </span>
<span class="nc" id="L134">    }</span>
    
    /**
     * Method that returns the fetched UserDataSourceVOs with the isModifyableset set.
     * This method should be used by external UserDataSource callers
     * @param admin Admin
     * @param searchstring String
     * @return VOs
     * @throws UserDataSourceException On error
     */    
    public  Collection&lt;UserDataSourceVO&gt; fetchUserDataSourceVOs(AuthenticationToken admin, String searchstring) throws UserDataSourceException{
<span class="nc" id="L145">    	Collection&lt;UserDataSourceVO&gt; result = fetch(admin,searchstring);</span>
    	
<span class="nc" id="L147">    	Set&lt;Integer&gt; isModifyable = getModifiableFields();</span>
<span class="nc" id="L148">    	Iterator&lt;UserDataSourceVO&gt; iter = result.iterator();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">    	while(iter.hasNext()){</span>
<span class="nc" id="L150">    		UserDataSourceVO next = iter.next();</span>
<span class="nc" id="L151">    		next.setIsModifyableSet(isModifyable);</span>
<span class="nc" id="L152">    	}</span>
<span class="nc" id="L153">    	return result;</span>
    }
    
    // Abstact methods.
    
    /**
     * Searches for userdata given the searchstring
     * @param admin Admin
     *
     * @param searchstring the string the user data source should use to look for the data.
     *
     * @return a collection of UserDataSourceVO, returns an Empty Collection if no userdata could be found
     *
     * @throws UserDataSourceException if a communication or other error occurs.
     */    
    protected abstract Collection&lt;UserDataSourceVO&gt; fetch(AuthenticationToken admin, String searchstring) throws UserDataSourceException;
	
    /**
     * Optional method used to remove user data from a user data source.
     * It's up to the implementation if it should be supported or not.
     * 
     * Removes user data that matches the given search string.
     * @param admin Admin
     *
     * @param searchstring the string the user data source that should be removed
     * @param removeMultipleMatch use to indicate if all entries should be removed it the search string
     * @return true if the user was remove successfully from at least one of the user data sources.
     * matches more than one, if false will a UserDataSourceException be thrown if more than one User data
     * matches the search string.  
     * @throws MultipleMatchException On fail
     *
     *
     * @throws UserDataSourceException if a communication or other error occurs.
     */   
    public abstract boolean removeUserData(AuthenticationToken admin, String searchstring, boolean removeMultipleMatch) throws MultipleMatchException, UserDataSourceException;
    
    /**
     * Method used to test the connection to a user data source.
     * 
     * @param admin the administrator perfoming the test
     * @throws UserDataSourceConnectionException when a connection couldn't be set up correctly in any way.
     */
    public abstract void testConnection(AuthenticationToken admin) throws UserDataSourceConnectionException;
    

    @Override
    public abstract Object clone() throws CloneNotSupportedException;

    
    @Override
    public abstract float getLatestVersion();

    @Override
    public void upgrade(){
    	// Performing upgrade rutines
<span class="nc" id="L208">    }</span>
    
	

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>