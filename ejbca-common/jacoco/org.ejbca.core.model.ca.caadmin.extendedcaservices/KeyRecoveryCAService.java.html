<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeyRecoveryCAService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA Common code</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ca.caadmin.extendedcaservices</a> &gt; <span class="el_source">KeyRecoveryCAService.java</span></div><h1>KeyRecoveryCAService.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.model.ca.caadmin.extendedcaservices;

import java.io.Serializable;
import java.security.KeyPair;
import java.util.HashMap;
import java.util.LinkedHashMap;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.certificates.ca.CA;
import org.cesecore.certificates.ca.X509CA;
import org.cesecore.certificates.ca.catoken.CATokenConstants;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAService;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceInfo;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceNotActiveException;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceRequest;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceRequestException;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceResponse;
import org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceTypes;
import org.cesecore.certificates.ca.extendedservices.IllegalExtendedCAServiceRequestException;
import org.cesecore.certificates.certificate.certextensions.AvailableCustomCertificateExtensionsConfiguration;
import org.cesecore.keys.token.CryptoToken;
import org.cesecore.keys.util.KeyTools;
import org.cesecore.util.Base64;
import org.cesecore.util.CryptoProviderTools;
import org.ejbca.core.model.InternalEjbcaResources;

/** Handles and maintains the CA-part of the Key Recovery functionality
 * 
 * @version $Id: KeyRecoveryCAService.java 26180 2017-08-01 09:38:15Z samuellb $
 */
public class KeyRecoveryCAService extends ExtendedCAService implements Serializable {

	private static final long serialVersionUID = 2400252746958812175L;
<span class="nc" id="L48">    private static Logger log = Logger.getLogger(KeyRecoveryCAService.class);</span>
	/** Internal localization of logs and errors */
<span class="nc" id="L50">	private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>

	public static final float LATEST_VERSION = 1; 

	public static final String SERVICENAME = &quot;KEYRECOVERYCASERVICE&quot;;

	public KeyRecoveryCAService(final ExtendedCAServiceInfo serviceinfo)  {
<span class="nc" id="L57">		super(serviceinfo);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">		if (log.isDebugEnabled()) {</span>
<span class="nc" id="L59">		    log.debug(&quot;KeyRecoveryCAService : constructor &quot; + serviceinfo.getStatus());</span>
		}
<span class="nc" id="L61">		CryptoProviderTools.installBCProviderIfNotAvailable();</span>
<span class="nc" id="L62">		data = new LinkedHashMap&lt;Object, Object&gt;();</span>
<span class="nc" id="L63">		data.put(ExtendedCAServiceInfo.IMPLEMENTATIONCLASS, this.getClass().getName());</span>
<span class="nc" id="L64">		data.put(EXTENDEDCASERVICETYPE, Integer.valueOf(ExtendedCAServiceTypes.TYPE_KEYRECOVERYEXTENDEDSERVICE));</span>
<span class="nc" id="L65">		data.put(VERSION, Float.valueOf(LATEST_VERSION));</span>
<span class="nc" id="L66">		setStatus(serviceinfo.getStatus());</span>
<span class="nc" id="L67">	}</span>

	public KeyRecoveryCAService(final HashMap&lt;?, ?&gt; data) {
<span class="nc" id="L70">		super(data);</span>
<span class="nc" id="L71">		CryptoProviderTools.installBCProviderIfNotAvailable();</span>
<span class="nc" id="L72">		loadData(data);</span>
<span class="nc" id="L73">	}</span>

	@Override
	public void init(CryptoToken cryptoToken, final CA ca, final AvailableCustomCertificateExtensionsConfiguration cceConfig) throws Exception {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L78">            log.debug(&quot;KeyRecoveryCAService : init &quot;);</span>
        }
<span class="nc" id="L80">		setCA(ca);</span>
<span class="nc" id="L81">		final ExtendedCAServiceInfo info = getExtendedCAServiceInfo();</span>
<span class="nc" id="L82">		setStatus(info.getStatus());</span>
<span class="nc" id="L83">	}   </span>

	@Override
	public void update(CryptoToken cryptoToken, final ExtendedCAServiceInfo serviceinfo, final CA ca, final AvailableCustomCertificateExtensionsConfiguration cceConfig) {		   
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L88">            log.debug(&quot;KeyRecoveryCAService : update &quot; + serviceinfo.getStatus());</span>
        }
<span class="nc" id="L90">		setStatus(serviceinfo.getStatus());</span>
<span class="nc" id="L91">		setCA(ca);</span>
<span class="nc" id="L92">	}</span>

	@Override
	public ExtendedCAServiceResponse extendedService(CryptoToken cryptoToken, final ExtendedCAServiceRequest request) throws ExtendedCAServiceRequestException, IllegalExtendedCAServiceRequestException,ExtendedCAServiceNotActiveException {
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L97">		    log.trace(&quot;&gt;extendedService&quot;);</span>
		}
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (this.getStatus() != ExtendedCAServiceInfo.STATUS_ACTIVE) {</span>
<span class="nc" id="L100">			String msg = intres.getLocalizedMessage(&quot;caservice.notactive&quot;, &quot;KeyRecovery&quot;);</span>
<span class="nc" id="L101">			log.error(msg);</span>
<span class="nc" id="L102">			throw new ExtendedCAServiceNotActiveException(msg);                            </span>
		}
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (!(request instanceof KeyRecoveryCAServiceRequest)) {</span>
<span class="nc" id="L105">			throw new IllegalExtendedCAServiceRequestException(&quot;Not a KeyRecoveryCAServiceRequest: &quot;+request.getClass().getName());            </span>
		}

<span class="nc" id="L108">		final KeyRecoveryCAServiceRequest serviceReq = (KeyRecoveryCAServiceRequest)request;</span>
<span class="nc" id="L109">		ExtendedCAServiceResponse returnval = null; </span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (serviceReq.getCommand() == KeyRecoveryCAServiceRequest.COMMAND_ENCRYPTKEYS) {</span>
			try {
<span class="nc" id="L112">			    final String keyAlias = getCa().getCAToken().getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L114">                    log.debug(&quot;Encrypting using alias '&quot;+keyAlias+&quot;' from crypto token &quot;+cryptoToken.getId());</span>
                }
	            // Creating the KeyId may just throw an exception, we will log this but store the cert and ignore the error
<span class="nc" id="L117">	            String keyId = null;</span>
	            try {
<span class="nc" id="L119">	                keyId = new String(Base64.encode(KeyTools.createSubjectKeyId(cryptoToken.getPublicKey(keyAlias)).getKeyIdentifier(), false));</span>
<span class="nc" id="L120">	            } catch (Exception e) { // NOPMD: we catch wide here because we do not want this to cause a transaction failure</span>
<span class="nc" id="L121">	                log.warn(&quot;Error creating subjectKeyId for key recovery, cryptoToken: &quot; + cryptoToken.getId() + &quot;, keyAlias: &quot; + keyAlias, e);</span>
<span class="nc" id="L122">	            }</span>
<span class="nc" id="L123">				returnval = new KeyRecoveryCAServiceResponse(KeyRecoveryCAServiceResponse.TYPE_ENCRYPTKEYSRESPONSE, </span>
<span class="nc" id="L124">						X509CA.encryptKeys(cryptoToken, keyAlias, serviceReq.getKeyPair()), cryptoToken.getId(), keyAlias, keyId);</span>
<span class="nc" id="L125">			} catch(Exception e) {</span>
<span class="nc" id="L126">				throw new IllegalExtendedCAServiceRequestException(e);</span>
<span class="nc" id="L127">			}</span>
		} else {
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (serviceReq.getCommand() == KeyRecoveryCAServiceRequest.COMMAND_DECRYPTKEYS) {</span>
				try {
<span class="nc" id="L131">				    String keyAlias = serviceReq.getKeyAlias();</span>
<span class="nc" id="L132">				    final String defaultAlias = getCa().getCAToken().getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				    if (StringUtils.isEmpty(keyAlias)) {</span>
				        // If we haven't stored any key alias, in the entry, use the default one
<span class="nc" id="L135">                        keyAlias = defaultAlias;				        </span>
				    }
<span class="nc" id="L137">				    KeyPair keys = null;</span>
				    try {
<span class="nc bnc" id="L139" title="All 2 branches missed.">				        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L140">				            log.debug(&quot;Trying to decrypt using alias '&quot;+keyAlias+&quot;' from crypto token &quot;+cryptoToken.getId());</span>
				        }
<span class="nc" id="L142">				        keys = X509CA.decryptKeys(cryptoToken, keyAlias, serviceReq.getKeyData());</span>
<span class="nc" id="L143">				    } catch (Exception e) { // NOPMD: we have to catch wide here, using the wrong key to decrypt can result in several different errors</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">				        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L145">				            log.debug(&quot;Decryption with alias '&quot;+keyAlias+&quot;' failed, trying defaultAlias: &quot;, e);</span>
				        }
				        // Did we use the wrong key alias? Try with the default one, if we din't do that already
<span class="nc bnc" id="L148" title="All 2 branches missed.">				        if (!StringUtils.equals(keyAlias, defaultAlias)) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">	                        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L150">	                            log.debug(&quot;Trying to decrypt using default alias '&quot;+defaultAlias+&quot;' from crypto token &quot;+cryptoToken.getId());</span>
	                        }
<span class="nc" id="L152">	                        keys = X509CA.decryptKeys(cryptoToken, defaultAlias, serviceReq.getKeyData());</span>
				        } else {
				            // Just re-throw if we have nothing to test here
<span class="nc" id="L155">				            throw e;</span>
				        }
<span class="nc" id="L157">				    }</span>
	                // Creating the KeyId in String format may just throw an exception, we will log this but store the cert and ignore the error
<span class="nc" id="L159">	                String keyId = null;</span>
	                try {
<span class="nc" id="L161">	                    keyId = new String(Base64.encode(KeyTools.createSubjectKeyId(cryptoToken.getPublicKey(keyAlias)).getKeyIdentifier(), false));</span>
<span class="nc" id="L162">	                } catch (Exception e) {</span>
<span class="nc" id="L163">	                    log.warn(&quot;Error creating subjectKeyId for key recovery, cryptoToken: &quot; + cryptoToken.getId() + &quot;, keyAlias: &quot; + keyAlias, e);</span>
<span class="nc" id="L164">	                }</span>
<span class="nc" id="L165">					returnval = new KeyRecoveryCAServiceResponse(KeyRecoveryCAServiceResponse.TYPE_DECRYPTKEYSRESPONSE, </span>
<span class="nc" id="L166">							keys, cryptoToken.getId(), keyAlias, keyId);</span>
<span class="nc" id="L167">                } catch(RuntimeException e) {</span>
<span class="nc" id="L168">                    throw e; // Rethrow RuntimeExceptions, they always cause rollback</span>
<span class="nc" id="L169">				} catch(Exception e) {</span>
<span class="nc" id="L170">					throw new IllegalExtendedCAServiceRequestException(e);</span>
<span class="nc" id="L171">				}</span>
			} else {
<span class="nc" id="L173">				throw new IllegalExtendedCAServiceRequestException(&quot;Illegal command: &quot;+serviceReq.getCommand()); </span>
			}
		}
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L177">            log.trace(&quot;&lt;extendedService&quot;);</span>
        }
<span class="nc" id="L179">		return returnval;</span>
	}

	@Override
	public float getLatestVersion() {		
<span class="nc" id="L184">		return LATEST_VERSION;</span>
	}

	@Override
	public void upgrade() {
<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (Float.compare(LATEST_VERSION, getVersion()) != 0) {</span>
<span class="nc" id="L190">			String msg = intres.getLocalizedMessage(&quot;caservice.upgrade&quot;, Float.valueOf(getVersion()));</span>
<span class="nc" id="L191">			log.info(msg);</span>
<span class="nc" id="L192">			data.put(VERSION, Float.valueOf(LATEST_VERSION));</span>
		}  		
<span class="nc" id="L194">	}</span>

	@Override
	public ExtendedCAServiceInfo getExtendedCAServiceInfo() {	
<span class="nc" id="L198">		return new KeyRecoveryCAServiceInfo(getStatus());</span>
	}
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>