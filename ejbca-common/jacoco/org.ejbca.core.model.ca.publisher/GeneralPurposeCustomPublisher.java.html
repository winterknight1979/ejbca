<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GeneralPurposeCustomPublisher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ejbca-common</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ca.publisher</a> &gt; <span class="el_source">GeneralPurposeCustomPublisher.java</span></div><h1>GeneralPurposeCustomPublisher.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.model.ca.publisher;

import java.io.File;
import java.security.cert.CRLException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.X509CRL;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.x509.Extension;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.cesecore.certificates.endentity.ExtendedInformation;
import org.cesecore.util.CertTools;
import org.cesecore.util.ExternalProcessException;
import org.cesecore.util.ExternalProcessTools;
import org.ejbca.core.model.InternalEjbcaResources;

/**
 * This class is used for publishing to user defined script or command.
 * 
 * @version $Id: GeneralPurposeCustomPublisher.java 34192 2020-01-07 15:10:21Z aminkh $
 */
public class GeneralPurposeCustomPublisher extends CustomPublisherUiBase implements ICustomPublisher {
    /**
	 * 
	 */
	private static final long serialVersionUID = 8306182854748381700L;
<span class="nc" id="L46">	private static Logger log = Logger.getLogger(GeneralPurposeCustomPublisher.class);</span>
<span class="nc" id="L47">    private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>

    public static final String CRL_EXTERNAL_COMMAND_PROPERTY_NAME = &quot;crl.application&quot;;
    public static final String CALCULATE_DELTA_CRL_LOCALLY_PROPERTY_NAME = &quot;crl.calclulateDeltaCrlLocally&quot;;
    public static final String CERT_EXTERNAL_COMMAND_PROPERTY_NAME = &quot;cert.application&quot;;
    public static final String REVOKE_EXTERNAL_COMMAND_PROPERTY_NAME = &quot;revoke.application&quot;;
    public static final String CRL_FAIL_ON_ERRORCODE_PROPERTY_NAME = &quot;crl.failOnErrorCode&quot;;
    public static final String CERT_FAIL_ON_ERRORCODE_PROPERTY_NAME = &quot;cert.failOnErrorCode&quot;;
    public static final String REVOKE_FAIL_ON_ERRORCODE_PROPERTY_NAME = &quot;revoke.failOnErrorCode&quot;;
    public static final String CRL_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME = &quot;crl.failOnStandardError&quot;;
    public static final String CERT_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME = &quot;cert.failOnStandardError&quot;;
    public static final String REVOKE_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME = &quot;revoke.failOnStandardError&quot;;

<span class="nc" id="L60">    private String crlExternalCommandFileName = null;</span>
<span class="nc" id="L61">    private String certExternalCommandFileName = null;</span>
<span class="nc" id="L62">    private String revokeExternalCommandFileName = null;</span>
<span class="nc" id="L63">    private boolean calclulateDeltaCrlLocally = false;</span>
<span class="nc" id="L64">    private boolean crlFailOnErrorCode = true;</span>
<span class="nc" id="L65">    private boolean certFailOnErrorCode = true;</span>
<span class="nc" id="L66">    private boolean revokeFailOnErrorCode = true;</span>
<span class="nc" id="L67">    private boolean crlFailOnStandardError = true;</span>
<span class="nc" id="L68">    private boolean certFailOnStandardError = true;</span>
<span class="nc" id="L69">    private boolean revokeFailOnStandardError = true;</span>

    /**
     * Creates a new instance of DummyCustomPublisher
     */
<span class="nc" id="L74">    public GeneralPurposeCustomPublisher() {</span>
<span class="nc" id="L75">    }</span>

    /**
     * Load used properties.
     * 
     * @param properties
     *            The properties to load.
     * 
     * @see org.ejbca.core.model.ca.publisher.ICustomPublisher#init(java.util.Properties)
     */
    @Override
    public void init(Properties properties) {
<span class="nc bnc" id="L87" title="All 2 branches missed.">    	if (log.isTraceEnabled()) {</span>
<span class="nc" id="L88">    		log.trace(&quot;&gt;init&quot;);</span>
    	}
        // Extract system properties
<span class="nc" id="L91">        crlFailOnErrorCode = properties.getProperty(CRL_FAIL_ON_ERRORCODE_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L92">        crlFailOnStandardError = properties.getProperty(CRL_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L93">        crlExternalCommandFileName = properties.getProperty(CRL_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L94">        certFailOnErrorCode = properties.getProperty(CERT_FAIL_ON_ERRORCODE_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L95">        certFailOnStandardError = properties.getProperty(CERT_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L96">        certExternalCommandFileName = properties.getProperty(CERT_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L97">        revokeFailOnErrorCode = properties.getProperty(REVOKE_FAIL_ON_ERRORCODE_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L98">        revokeFailOnStandardError = properties.getProperty(REVOKE_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, &quot;true&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L99">        revokeExternalCommandFileName = properties.getProperty(REVOKE_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L100">        calclulateDeltaCrlLocally = properties.getProperty(CALCULATE_DELTA_CRL_LOCALLY_PROPERTY_NAME, &quot;false&quot;).equalsIgnoreCase(&quot;true&quot;);</span>
        
<span class="nc" id="L102">        addProperty(new CustomPublisherProperty(CRL_FAIL_ON_ERRORCODE_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(crlFailOnErrorCode)));</span>
<span class="nc" id="L103">        addProperty(new CustomPublisherProperty(CRL_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(crlFailOnStandardError)));</span>
<span class="nc" id="L104">        addProperty(new CustomPublisherProperty(CRL_EXTERNAL_COMMAND_PROPERTY_NAME, CustomPublisherProperty.UI_TEXTINPUT, crlExternalCommandFileName));</span>
<span class="nc" id="L105">        addProperty(new CustomPublisherProperty(CERT_FAIL_ON_ERRORCODE_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(certFailOnErrorCode)));</span>
<span class="nc" id="L106">        addProperty(new CustomPublisherProperty(CERT_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(certFailOnStandardError)));</span>
<span class="nc" id="L107">        addProperty(new CustomPublisherProperty(CERT_EXTERNAL_COMMAND_PROPERTY_NAME, CustomPublisherProperty.UI_TEXTINPUT, certExternalCommandFileName));</span>
<span class="nc" id="L108">        addProperty(new CustomPublisherProperty(REVOKE_FAIL_ON_ERRORCODE_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(revokeFailOnErrorCode)));</span>
<span class="nc" id="L109">        addProperty(new CustomPublisherProperty(REVOKE_FAIL_ON_STANDARD_ERROR_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(revokeFailOnStandardError)));</span>
<span class="nc" id="L110">        addProperty(new CustomPublisherProperty(REVOKE_EXTERNAL_COMMAND_PROPERTY_NAME, CustomPublisherProperty.UI_TEXTINPUT, revokeExternalCommandFileName));</span>
<span class="nc" id="L111">        addProperty(new CustomPublisherProperty(CALCULATE_DELTA_CRL_LOCALLY_PROPERTY_NAME, CustomPublisherProperty.UI_BOOLEAN, String.valueOf(calclulateDeltaCrlLocally)));</span>
        
<span class="nc" id="L113">    } </span>

    /**
     * Writes certificate to temporary file and executes an external command with
     * the full pathname of the temporary file as argument. The temporary file
     * is the encoded form of the certificate e.g. X.509 certificates would be
     * encoded as ASN.1 DER. All parameters but incert are ignored.
     * 
     * @param incert
     *            The certificate
     * @param username
     *            The username
     * @param type
     *            The certificate type
     * 
     * @see org.ejbca.core.model.ca.publisher.ICustomPublisher#storeCertificate
     */
    @Override
    public boolean storeCertificate(AuthenticationToken admin, Certificate incert, String username, String password, String userDN, String cafp, int status, int type, long revocationDate,
            int revocationReason, String tag, int certificateProfileId, long lastUpdate, ExtendedInformation extendedinformation) throws PublisherException {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L134">            log.trace(&quot;&gt;storeCertificate, Storing Certificate for user: &quot; + username);</span>
        }

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (status == CertificateConstants.CERT_REVOKED) {</span>
            // Call separate script for revocation
<span class="nc" id="L139">            revokeCertificate(admin, incert, revocationReason);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        } else if (status == CertificateConstants.CERT_ACTIVE) {</span>
            // Don't publish non-active certificates
            // Make sure that an external command was specified
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (certExternalCommandFileName == null) {</span>
<span class="nc" id="L144">                String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, CERT_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L145">                log.error(msg);</span>
<span class="nc" id="L146">                throw new PublisherException(msg);</span>
            }
            // Run internal method to create tempfile and run the command
<span class="nc" id="L149">            List&lt;String&gt; arguments = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L150">            arguments.add(String.valueOf(type));</span>
            try {
<span class="nc" id="L152">                arguments.add(CertTools.getSubjectDN(incert));</span>
<span class="nc" id="L153">                arguments.add(CertTools.getIssuerDN(incert));</span>
<span class="nc" id="L154">                arguments.add(CertTools.getSerialNumberAsString(incert));</span>
<span class="nc" id="L155">                ExternalProcessTools.launchExternalCommand(certExternalCommandFileName, incert.getEncoded(), </span>
                        certFailOnErrorCode, certFailOnStandardError, arguments, &quot;GeneralPurposeCustomPublisher&quot;);
<span class="nc" id="L157">            } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L158">                String msg = intres.getLocalizedMessage(&quot;publisher.errorcertconversion&quot;);</span>
<span class="nc" id="L159">                log.error(msg);</span>
<span class="nc" id="L160">                throw new PublisherException(msg);</span>
<span class="nc" id="L161">            } catch (ExternalProcessException e) {</span>
<span class="nc" id="L162">                throw new PublisherException(e.getMessage());</span>
<span class="nc" id="L163">            }</span>
        }
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L166">            log.trace(&quot;&lt;storeCertificate&quot;);</span>
        }
<span class="nc" id="L168">        return true;</span>
    } // storeCertificate

    /**
     * Writes the CRL to a temporary file and executes an external command with
     * the temporary file as argument. By default, a PublisherException is
     * thrown if the external command returns with an errorlevel or outputs to
     * stderr.
     * 
     * @see org.ejbca.core.model.ca.publisher.ICustomPublisher#storeCRL
     */
    @Override
    public boolean storeCRL(AuthenticationToken admin, byte[] incrl, String cafp, int number, String userDN) throws PublisherException {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L182">        	log.trace(&quot;&gt;storeCRL, Storing CRL&quot;);</span>
        }
        // Verify initialization
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (crlExternalCommandFileName == null) {</span>
<span class="nc" id="L186">            String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, CRL_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L187">            log.error(msg);</span>
<span class="nc" id="L188">            throw new PublisherException(msg);</span>
        }

<span class="nc" id="L191">        List&lt;String&gt; additionalArguments = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (calclulateDeltaCrlLocally) {</span>
            X509CRL crl;
            try {
<span class="nc" id="L196">                crl = CertTools.getCRLfromByteArray(incrl);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                additionalArguments.add(Boolean.toString(crl.getExtensionValue(Extension.deltaCRLIndicator.getId()) != null));</span>
<span class="nc" id="L198">            } catch (CRLException e) {</span>
<span class="nc" id="L199">                log.error(&quot;Byte array does not contain a correct CRL.&quot;, e);</span>
<span class="nc" id="L200">            }</span>
        }

        // Write temporary file and run the external script / command.
        try {
<span class="nc" id="L205">            ExternalProcessTools.launchExternalCommand(crlExternalCommandFileName, incrl, </span>
                crlFailOnErrorCode, crlFailOnStandardError, additionalArguments, &quot;GeneralPurposeCustomPublisher&quot;);
<span class="nc" id="L207">        } catch (ExternalProcessException e) {</span>
<span class="nc" id="L208">            throw new PublisherException(e.getMessage());</span>
<span class="nc" id="L209">        }</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L211">        	log.trace(&quot;&lt;storeCRL&quot;);</span>
        }
<span class="nc" id="L213">        return true;</span>
    }

    /**
     * Writes certificate to temporary file and executes an external command
     * with the full pathname of the temporary file as argument. The temporary
     * file is the encoded form of the certificate e.g. X.509 certificates would
     * be encoded as ASN.1 DER. All parameters but cert are ignored.
     * @param admin Token
     * 
     * @param cert
     *            The certificate
     * @param reason Reason
     * @throws PublisherException On error
     * 
     */
    public void revokeCertificate(AuthenticationToken admin, Certificate cert, int reason) throws PublisherException {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L231">        	log.trace(&quot;&gt;revokeCertificate, Rekoving Certificate&quot;);</span>
        }
        // Verify initialization
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (revokeExternalCommandFileName == null) {</span>
<span class="nc" id="L235">            String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, REVOKE_EXTERNAL_COMMAND_PROPERTY_NAME);</span>
<span class="nc" id="L236">            log.error(msg);</span>
<span class="nc" id="L237">            throw new PublisherException(msg);</span>
        }
        // Run internal method to create tempfile and run the command
<span class="nc" id="L240">        List&lt;String&gt; arguments = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L241">        arguments.add(String.valueOf(reason));</span>
        try {
<span class="nc" id="L243">            arguments.add(CertTools.getSubjectDN(cert));</span>
<span class="nc" id="L244">            arguments.add(CertTools.getIssuerDN(cert));</span>
<span class="nc" id="L245">            arguments.add(CertTools.getSerialNumberAsString(cert));</span>
<span class="nc" id="L246">            ExternalProcessTools.launchExternalCommand(revokeExternalCommandFileName, cert.getEncoded(), </span>
                    revokeFailOnErrorCode, revokeFailOnStandardError, arguments, &quot;GeneralPurposeCustomPublisher&quot;);
<span class="nc" id="L248">        } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L249">            String msg = intres.getLocalizedMessage(&quot;publisher.errorcertconversion&quot;);</span>
<span class="nc" id="L250">            log.error(msg);</span>
<span class="nc" id="L251">            throw new PublisherException(msg);</span>
<span class="nc" id="L252">        } catch (ExternalProcessException e) {</span>
<span class="nc" id="L253">            throw new PublisherException(e.getMessage());</span>
<span class="nc" id="L254">        }</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L256">        	log.trace(&quot;&lt;revokeCertificate&quot;);</span>
        }
<span class="nc" id="L258">    } // revokeCertificate</span>

    /**
     * Check if the specified external executable file(s) exist.
     * 
     * @see org.ejbca.core.model.ca.publisher.ICustomPublisher#testConnection()
     */
    @Override
    public void testConnection() throws PublisherConnectionException {
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L268">        	log.trace(&quot;testConnection, Testing connection&quot;);</span>
        }
        // Test if specified commands exist
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (StringUtils.isNotBlank(crlExternalCommandFileName)) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (!(new File(crlExternalCommandFileName)).exists()) {</span>
<span class="nc" id="L273">                String msg = intres.getLocalizedMessage(&quot;publisher.commandnotfound&quot;, crlExternalCommandFileName);</span>
<span class="nc" id="L274">                log.error(msg);</span>
<span class="nc" id="L275">                throw new PublisherConnectionException(msg);</span>
            }
        }
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if (StringUtils.isNotBlank(certExternalCommandFileName)) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (!(new File(certExternalCommandFileName)).exists()) {</span>
<span class="nc" id="L280">                String msg = intres.getLocalizedMessage(&quot;publisher.commandnotfound&quot;, certExternalCommandFileName);</span>
<span class="nc" id="L281">                log.error(msg);</span>
<span class="nc" id="L282">                throw new PublisherConnectionException(msg);</span>
            }
        }
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if (StringUtils.isNotBlank(revokeExternalCommandFileName)) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (!(new File(revokeExternalCommandFileName)).exists()) {</span>
<span class="nc" id="L287">                String msg = intres.getLocalizedMessage(&quot;publisher.commandnotfound&quot;, revokeExternalCommandFileName);</span>
<span class="nc" id="L288">                log.error(msg);</span>
<span class="nc" id="L289">                throw new PublisherConnectionException(msg);</span>
            }
        }
<span class="nc" id="L292">    } // testConnection</span>

    /**
     * Does nothing.
     */
    @SuppressWarnings(&quot;deprecation&quot;)
	@Override
    protected void finalize() throws Throwable {
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L301">        	log.trace(&quot;finalize, doing nothing&quot;);</span>
        }
<span class="nc" id="L303">        super.finalize();</span>
<span class="nc" id="L304">    }</span>

    @Override
    public boolean willPublishCertificate(int status, int revocationReason) {
<span class="nc" id="L308">        return true;</span>
    }
    
    @Override
    public boolean isReadOnly() {
<span class="nc" id="L313">        return false;</span>
    }

    @Override
    public void validateDataSource(String dataSource) throws PublisherException {
        // Method not applicable for this publisher type
<span class="nc" id="L319">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>