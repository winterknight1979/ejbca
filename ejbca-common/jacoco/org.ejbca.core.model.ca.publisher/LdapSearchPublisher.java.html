<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LdapSearchPublisher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA Common code</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ca.publisher</a> &gt; <span class="el_source">LdapSearchPublisher.java</span></div><h1>LdapSearchPublisher.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.model.ca.publisher;

import java.io.UnsupportedEncodingException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.regex.Pattern;

import org.apache.log4j.Logger;
import org.cesecore.util.CertTools;
import org.ejbca.core.model.InternalEjbcaResources;
import org.ejbca.util.TCPTool;

import com.novell.ldap.LDAPConnection;
import com.novell.ldap.LDAPEntry;
import com.novell.ldap.LDAPException;
import com.novell.ldap.LDAPSearchResults;

/**
 * 
 * @version $Id: LdapSearchPublisher.java 22117 2015-10-29 10:53:42Z mikekushner $
 *
 */

public class LdapSearchPublisher extends LdapPublisher {
	
	private static final long serialVersionUID = -4593116897226605008L;
<span class="nc" id="L40">    private static final Logger log = Logger.getLogger(LdapSearchPublisher.class);</span>
    /** Internal localization of logs and errors */
<span class="nc" id="L42">    private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>
	
	// Default Values
	protected static final String SEARCHBASEDN = &quot;searchbasedn&quot;;
	protected static final String SEARCHFILTER = &quot;searchfilter&quot;;
	
	public LdapSearchPublisher() {
<span class="nc" id="L49">		super();</span>
<span class="nc" id="L50">		data.put(TYPE, Integer.valueOf(PublisherConst.TYPE_LDAPSEARCHPUBLISHER));</span>
		
<span class="nc" id="L52">		setSearchBaseDN(&quot;&quot;);</span>
<span class="nc" id="L53">		setSearchFilter(&quot;&quot;);</span>
		
		// By default the LDAP search publisher should not modify any attributes except the certificate
<span class="nc" id="L56">		setModifyExistingAttributes(false);</span>
<span class="nc" id="L57">		setAddNonExistingAttributes(false);</span>
<span class="nc" id="L58">	}</span>
	
	// Public Methods
	

	private static String getPartFromDN(String certDN, String userDN, String dnpart) {
<span class="nc" id="L64">		final String certResult = CertTools.getPartFromDN(certDN, dnpart);</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">		if ( certResult!=null ) {</span>
<span class="nc" id="L66">			return certResult;</span>
		}
<span class="nc" id="L68">		return CertTools.getPartFromDN(userDN, dnpart);</span>
	}
    /** SearchOldEntity is the only method differing between regular ldap and ldap search publishers.
     *  Apart from how they find existing users, the publishing works the same.
     *  
     *  @param certDN the DN from the certificate, can be used to extract search information or a LDAP DN
     *  @return an existing LDAPEntry, or null if not found
     */
    protected LDAPEntry searchOldEntity(final String username, final int ldapVersion, final LDAPConnection lc, final String certDN, final String userDN, final String email) throws PublisherException {
<span class="nc" id="L77">        LDAPEntry oldEntry = null; // return value</span>

		// Try all the listed servers
<span class="nc" id="L80">		Iterator&lt;String&gt; servers = getHostnameList().iterator();</span>
		boolean connectionFailed;
		do {
<span class="nc" id="L83">			connectionFailed = false;</span>
<span class="nc" id="L84">			String currentServer = servers.next();</span>
	        // PARTE 1: Search for an existing entry in the LDAP directory
			//  If it exists, this will be returned to be populated
			//  if not exist, nothing will be returned and a new LDAP entry created
			try {
<span class="nc" id="L89">				TCPTool.probeConnectionLDAP(currentServer, Integer.parseInt(getPort()), getConnectionTimeOut());	// Avoid waiting for halfdead-servers</span>
				// connect to the server
<span class="nc" id="L91">				log.debug(&quot;Connecting to &quot; + currentServer);</span>
<span class="nc" id="L92">				lc.connect(currentServer, Integer.parseInt(getPort()));</span>
				// Execute a STARTTLS handshake if it was requested.
<span class="nc bnc" id="L94" title="All 2 branches missed.">				if (getConnectionSecurity() == ConnectionSecurity.STARTTLS) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L96">                        log.debug(&quot;STARTTLS to LDAP server &quot;+currentServer);</span>
                    }
<span class="nc" id="L98">					lc.startTLS();</span>
				}

				// authenticate to the server
<span class="nc" id="L102">				log.debug(&quot;Logging in with BIND DN &quot; + getLoginDN());</span>
<span class="nc" id="L103">				lc.bind(ldapVersion, getLoginDN(), getLoginPassword().getBytes(&quot;UTF8&quot;), ldapBindConstraints);</span>
				//searchFilter = &quot;(&amp;(objectclass=person)(uid=&quot; + username + &quot;))&quot;;
<span class="nc" id="L105">				String searchFilter = getSearchFilter();</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">				if (log.isDebugEnabled()) {</span>
<span class="nc" id="L107">					log.debug(&quot;Compiling search filter: &quot; +searchFilter+&quot;, from certDN '&quot;+certDN+&quot;' and userDN '&quot;+userDN+&quot;'.&quot;);</span>
				}
<span class="nc bnc" id="L109" title="All 2 branches missed.">				if (username != null) {</span>
<span class="nc" id="L110">					Pattern USER = Pattern.compile(&quot;\\$USERNAME&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L111">					searchFilter = USER.matcher(searchFilter).replaceAll(username);</span>
				}
<span class="nc bnc" id="L113" title="All 2 branches missed.">				if (email != null) {</span>
<span class="nc" id="L114">					Pattern EMAIL = Pattern.compile(&quot;\\$EMAIL&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L115">					searchFilter = EMAIL.matcher(searchFilter).replaceAll(email);</span>
				}
<span class="nc bnc" id="L117" title="All 2 branches missed.">				if (getPartFromDN(certDN, userDN, &quot;CN&quot;) != null) {</span>
<span class="nc" id="L118">					Pattern CN = Pattern.compile(&quot;\\$CN&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L119">					searchFilter = CN.matcher(searchFilter).replaceAll(getPartFromDN(certDN, userDN, &quot;CN&quot;));</span>
				}
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (getPartFromDN(certDN, userDN, &quot;O&quot;) != null) {</span>
<span class="nc" id="L122">					Pattern O = Pattern.compile(&quot;\\$O&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L123">					searchFilter = O.matcher(searchFilter).replaceAll(getPartFromDN(certDN, userDN, &quot;O&quot;));</span>
				}
<span class="nc bnc" id="L125" title="All 2 branches missed.">				if (getPartFromDN(certDN, userDN, &quot;OU&quot;) != null) {</span>
<span class="nc" id="L126">					Pattern OU = Pattern.compile(&quot;\\$OU&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L127">					searchFilter = OU.matcher(searchFilter).replaceAll(getPartFromDN(certDN, userDN, &quot;OU&quot;));</span>
				}
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if (getPartFromDN(certDN, userDN, &quot;C&quot;) != null) {</span>
<span class="nc" id="L130">					Pattern C = Pattern.compile(&quot;\\$C&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L131">					searchFilter = C.matcher(searchFilter).replaceAll(getPartFromDN(certDN, userDN, &quot;C&quot;));</span>
				}
<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (getPartFromDN(certDN, userDN, &quot;UID&quot;) != null) {</span>
<span class="nc" id="L134">					Pattern C = Pattern.compile(&quot;\\$UID&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L135">					searchFilter = C.matcher(searchFilter).replaceAll(getPartFromDN(certDN, userDN, &quot;UID&quot;));</span>
				}
<span class="nc" id="L137">				log.debug(&quot;Resulting search filter '&quot; + searchFilter+&quot;'.&quot;);</span>
<span class="nc" id="L138">				log.debug(&quot;Making SRCH with BaseDN '&quot; + getSearchBaseDN() + &quot;' and filter '&quot; + searchFilter+&quot;'.&quot;);</span>
<span class="nc" id="L139">				String searchbasedn = getSearchBaseDN();</span>
<span class="nc" id="L140">				int searchScope = LDAPConnection.SCOPE_SUB;</span>
<span class="nc" id="L141">		        String attrs[] = { LDAPConnection.NO_ATTRS };</span>
<span class="nc" id="L142">				boolean attributeTypesOnly = true;</span>
<span class="nc" id="L143">				LDAPSearchResults searchResults = lc.search(searchbasedn, // container to search</span>
						searchScope, // search scope
						searchFilter, // search filter
						attrs, // &quot;1.1&quot; returns entry name only
						attributeTypesOnly,
						ldapSearchConstraints); // no attribute values are returned
				// try to read the old object
<span class="nc bnc" id="L150" title="All 2 branches missed.">				if (log.isDebugEnabled()) {</span>
<span class="nc" id="L151">					log.debug(&quot;serachResults contains entries: &quot;+searchResults.hasMore());</span>
				}
				final String ldapDN;
<span class="nc bnc" id="L154" title="All 2 branches missed.">				if (searchResults.hasMore()) {</span>
<span class="nc" id="L155">					oldEntry = searchResults.next();</span>
<span class="nc" id="L156">					ldapDN = oldEntry.getDN();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">					if (searchResults.hasMore()) {</span>
<span class="nc" id="L158">						log.debug(&quot;Found more than one matches with filter '&quot; + searchFilter +</span>
<span class="nc" id="L159">								&quot;'. Using the first match with LDAP entry with DN: &quot; +oldEntry.getDN());</span>
					} else {
<span class="nc" id="L161">						log.debug(&quot;Found one match with filter: '&quot;+searchFilter+&quot;', match with DN: &quot; + oldEntry.getDN());</span>
					}
				} else {
<span class="nc" id="L164">					ldapDN = constructLDAPDN(certDN, userDN);</span>
<span class="nc" id="L165">					log.debug(&quot;No matches found using filter: '&quot; +searchFilter + &quot;'. Using DN: &quot; + ldapDN);</span>
				}
				// try to read the old object
				try {
<span class="nc" id="L169">					oldEntry = lc.read(ldapDN, ldapSearchConstraints);</span>
<span class="nc" id="L170">				} catch (LDAPException e) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">					if (e.getResultCode() == LDAPException.NO_SUCH_OBJECT) {</span>
<span class="nc" id="L172">						String msg = intres.getLocalizedMessage(&quot;publisher.noentry&quot;, ldapDN);</span>
<span class="nc" id="L173">						log.info(msg);</span>
<span class="nc" id="L174">					} else {</span>
<span class="nc" id="L175">						String msg = intres.getLocalizedMessage(&quot;publisher.infoexists&quot;, ldapDN);</span>
<span class="nc" id="L176">						log.info(msg);</span>
					}
<span class="nc" id="L178">				}</span>
<span class="nc" id="L179">			} catch (LDAPException e) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">				if (e.getResultCode() == LDAPException.NO_SUCH_OBJECT) {</span>
<span class="nc" id="L181">					String msg = intres.getLocalizedMessage(&quot;publisher.noentry&quot;, certDN +&quot;, &quot;+userDN);</span>
<span class="nc" id="L182">					log.info(msg);</span>
<span class="nc" id="L183">				} else {</span>
<span class="nc" id="L184">					connectionFailed = true;</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">					if (servers.hasNext()) {</span>
<span class="nc" id="L186">						log.debug(&quot;Failed to publish to &quot; + currentServer + &quot;. Trying next in list.&quot;);</span>
					} else {
<span class="nc" id="L188">		    			String msg = intres.getLocalizedMessage(&quot;publisher.errorldapbind&quot;, e.getMessage());</span>
<span class="nc" id="L189">		                log.error(msg, e);</span>
<span class="nc" id="L190">						throw new PublisherException(msg);</span>
					}
				}
<span class="nc" id="L193">	        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L194">				String msg = intres.getLocalizedMessage(&quot;publisher.errorpassword&quot;, getLoginPassword());</span>
<span class="nc" id="L195">	            throw new PublisherException(msg);            </span>
			} finally {
				// disconnect with the server
				try {
<span class="nc" id="L199">					lc.disconnect(ldapDisconnectConstraints);</span>
<span class="nc" id="L200">				} catch (LDAPException e) {</span>
<span class="nc" id="L201">					String msg = intres.getLocalizedMessage(&quot;publisher.errordisconnect&quot;);</span>
<span class="nc" id="L202">					log.error(msg, e);</span>
<span class="nc" id="L203">				}</span>
			}
<span class="nc bnc" id="L205" title="All 4 branches missed.">		} while (connectionFailed &amp;&amp; servers.hasNext()) ;</span>
<span class="nc" id="L206">        return oldEntry;</span>
    }
    
	/**
	 *  @return search base DN
	 */
	public String getSearchBaseDN() {
<span class="nc" id="L213">		return (String) data.get(SEARCHBASEDN);</span>
	}
	
	/**
	 *  Set search base DN.
	 * @param searchbasedn DN
	 */
	public void setSearchBaseDN(String searchbasedn) {
<span class="nc" id="L221">		data.put(SEARCHBASEDN, searchbasedn);</span>
<span class="nc" id="L222">	}</span>
	
	/**
	 *  @return LDAP search filter string
	 */
	public String getSearchFilter() {
<span class="nc" id="L228">		return (String) data.get(SEARCHFILTER);</span>
	}
	
	/**
	 *  Sets LDAP search filter string
	 * @param searchfilter Filter
	 */
	public void setSearchFilter(String searchfilter) {
<span class="nc" id="L236">		data.put(SEARCHFILTER, searchfilter);</span>
<span class="nc" id="L237">	}</span>
	
	
	// Private methods
	
	
	/**
	 * @see org.ejbca.core.model.ca.publisher.BasePublisher#clone()
	 */
	@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    public Object clone() throws CloneNotSupportedException {
<span class="nc" id="L248">		LdapSearchPublisher clone = new LdapSearchPublisher();</span>
<span class="nc" id="L249">        HashMap clonedata = (HashMap) clone.saveData();</span>
		
<span class="nc" id="L251">		Iterator&lt;Object&gt; i = (data.keySet()).iterator();</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		while (i.hasNext()) {</span>
<span class="nc" id="L253">			Object key = i.next();</span>
<span class="nc" id="L254">			clonedata.put(key, data.get(key));</span>
<span class="nc" id="L255">		}</span>
		
<span class="nc" id="L257">		clone.loadData(clonedata);</span>
<span class="nc" id="L258">		return clone;</span>
	}
		
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>