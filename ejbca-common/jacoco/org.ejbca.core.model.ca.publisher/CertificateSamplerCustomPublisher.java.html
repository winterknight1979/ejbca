<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CertificateSamplerCustomPublisher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA Common code</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.ca.publisher</a> &gt; <span class="el_source">CertificateSamplerCustomPublisher.java</span></div><h1>CertificateSamplerCustomPublisher.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.core.model.ca.publisher;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.util.Properties;

import org.apache.log4j.Logger;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.ejbca.core.model.InternalEjbcaResources;

/**
 * Publisher storing certificates to a specified folder.
 * 
 * The configured sampling method and its parameters (if any) determines which 
 * certificates that should be sampled.
 * 
 * @see SamplingMethod
 * @version $Id: CertificateSamplerCustomPublisher.java 23625 2016-06-07 19:32:11Z anatom $
 */
<span class="fc" id="L36">public class CertificateSamplerCustomPublisher implements ICustomPublisher {</span>
<span class="fc" id="L37">    private static final Logger LOG = Logger.getLogger(CertificateSamplerCustomPublisher.class);</span>
<span class="fc" id="L38">    private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>

    private static final String PROPERTY_OUTPUTFOLDER = &quot;outputfolder&quot;;
    
    private static final String PROPERTYPREFIX_PROFILEID = &quot;profileid.&quot;;
    
    private static final String PROPERTYSUFFIX_PVALUE = &quot;.pvalue&quot;;
    private static final String PROPERTYSUFFIX_SAMPLINGMETHOD = &quot;.samplingmethod&quot;;
    
    private static final String PROPERTY_DEFAULT_SAMPLINGMETHOD = &quot;default&quot; + PROPERTYSUFFIX_SAMPLINGMETHOD;
    private static final String PROPERTY_DEFAULT_PVALUE = &quot;default&quot; + PROPERTYSUFFIX_PVALUE;
    
    private Properties config;
    
    @Override
    public void init(Properties config) {
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">    	if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L55">    		LOG.trace(&quot;&gt;init: &quot; + this);</span>
    	}
<span class="fc" id="L57">        this.config = config;</span>
<span class="fc" id="L58">    }</span>
    
    @Override
    public void testConnection() throws PublisherConnectionException {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L63">        	LOG.trace(&quot;&gt;testConnection, Testing connection&quot;);</span>
        }
        
        // Test output folder
        File outputFolder;
        try {
<span class="fc" id="L69">            outputFolder = getOutputFolder();</span>
<span class="fc" id="L70">        } catch (PublisherException ex) {</span>
<span class="fc" id="L71">            LOG.error(null, ex);</span>
<span class="fc" id="L72">            throw new PublisherConnectionException(ex.getLocalizedMessage());</span>
<span class="fc" id="L73">        }</span>
<span class="pc bpc" id="L74" title="2 of 4 branches missed.">        if (!outputFolder.exists() || !outputFolder.isDirectory()) {</span>
<span class="nc" id="L75">            final String msg = intres.getLocalizedMessage(&quot;publisher.erroroutputpath&quot;, outputFolder.getAbsolutePath());</span>
<span class="nc" id="L76">            LOG.error(msg);</span>
<span class="nc" id="L77">            throw new PublisherConnectionException(msg);</span>
        }
        
        // Test default samplingmethod
<span class="fc" id="L81">        SamplingMethod defaultMethod = null;</span>
        try {
<span class="fc" id="L83">            String methodString = config.getProperty(PROPERTY_DEFAULT_SAMPLINGMETHOD);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (methodString == null) {</span>
<span class="fc" id="L85">                final String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, PROPERTY_DEFAULT_SAMPLINGMETHOD);</span>
<span class="fc" id="L86">                LOG.error(msg);</span>
<span class="fc" id="L87">                throw new PublisherConnectionException(msg);</span>
            } else {
<span class="fc" id="L89">                defaultMethod = SamplingMethod.valueOf(methodString);</span>
            }
<span class="fc" id="L91">        } catch (IllegalArgumentException ex) {</span>
<span class="fc" id="L92">            final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, PROPERTY_DEFAULT_SAMPLINGMETHOD, ex.getLocalizedMessage());</span>
<span class="fc" id="L93">            LOG.error(msg, ex);</span>
<span class="fc" id="L94">            throw new PublisherConnectionException(msg);</span>
<span class="fc" id="L95">        }</span>
        
        // Test default pvalue
<span class="fc" id="L98">        final String pvalueString = config.getProperty(PROPERTY_DEFAULT_PVALUE);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (pvalueString == null) {</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (SamplingMethod.SAMPLE_PROBABILISTIC.equals(defaultMethod)) {</span>
<span class="fc" id="L101">                final String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, PROPERTY_DEFAULT_PVALUE);</span>
<span class="fc" id="L102">                LOG.error(msg);</span>
<span class="fc" id="L103">                throw new PublisherConnectionException(msg);</span>
            }
        } else {
            try {
<span class="fc" id="L107">                final double defaultPvalue = Double.parseDouble(pvalueString);</span>
<span class="pc bpc" id="L108" title="3 of 4 branches missed.">                if (defaultPvalue &lt; 0.0 || defaultPvalue &gt; 1.0) {</span>
<span class="fc" id="L109">                    final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, PROPERTY_DEFAULT_PVALUE, intres.getLocalizedMessage(&quot;publisher.pvalueinterval&quot;));</span>
<span class="fc" id="L110">                    LOG.error(msg);</span>
<span class="fc" id="L111">                    throw new PublisherConnectionException(msg);</span>
                }
<span class="nc" id="L113">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L114">                final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, PROPERTY_DEFAULT_PVALUE, ex.getLocalizedMessage());</span>
<span class="nc" id="L115">                LOG.error(msg, ex);</span>
<span class="nc" id="L116">                throw new PublisherConnectionException(msg);</span>
<span class="nc" id="L117">            }</span>
        }
        
        // Test every profile specific values
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        for (String name : config.stringPropertyNames()) {</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (name.startsWith(PROPERTYPREFIX_PROFILEID)) {</span>
<span class="pc bpc" id="L123" title="1 of 4 branches missed.">                if (name.endsWith(PROPERTYSUFFIX_SAMPLINGMETHOD) &amp;&amp; name.length() &gt; PROPERTYPREFIX_PROFILEID.length() + PROPERTYSUFFIX_SAMPLINGMETHOD.length()) {</span>
<span class="fc" id="L124">                    final String profileIdString = name.substring(PROPERTYPREFIX_PROFILEID.length(), name.indexOf(PROPERTYSUFFIX_SAMPLINGMETHOD));</span>
                    int profileId;
                    try {
<span class="fc" id="L127">                        profileId = Integer.parseInt(profileIdString);</span>
<span class="fc" id="L128">                    } catch (NumberFormatException ex) {</span>
<span class="fc" id="L129">                        final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidkey&quot;, name);</span>
<span class="fc" id="L130">                        LOG.error(msg, ex);</span>
<span class="fc" id="L131">                        throw new PublisherConnectionException(msg);</span>
<span class="fc" id="L132">                    }</span>
                    try {
<span class="fc" id="L134">                        SamplingMethod profileMethod = SamplingMethod.valueOf(config.getProperty(name));</span>
                        
                        // Check that there is an pvalue for this profile
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">                        if (SamplingMethod.SAMPLE_PROBABILISTIC.equals(profileMethod)) {</span>
<span class="fc" id="L138">                            getPvalue(profileId); // Throws exception if the value (or default value) does not exist</span>
                        }
<span class="fc" id="L140">                    } catch (PublisherException ex) {</span>
<span class="fc" id="L141">                        throw new PublisherConnectionException(ex.getLocalizedMessage());</span>
<span class="fc" id="L142">                    } catch (IllegalArgumentException ex) {</span>
<span class="fc" id="L143">                        final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, name, ex.getLocalizedMessage());</span>
<span class="fc" id="L144">                        LOG.error(msg, ex);</span>
<span class="fc" id="L145">                        throw new PublisherConnectionException(msg);</span>
<span class="fc" id="L146">                    }</span>
<span class="pc bpc" id="L147" title="2 of 4 branches missed.">                } else if (name.endsWith(PROPERTYSUFFIX_PVALUE) &amp;&amp; name.length() &gt; PROPERTYPREFIX_PROFILEID.length() + PROPERTYSUFFIX_PVALUE.length()) {</span>
<span class="fc" id="L148">                    final String profileIdString = name.substring(PROPERTYPREFIX_PROFILEID.length(), name.indexOf(PROPERTYSUFFIX_PVALUE));</span>
                    try {
<span class="fc" id="L150">                        Integer.parseInt(profileIdString);</span>
<span class="nc" id="L151">                    } catch (NumberFormatException ex) {</span>
<span class="nc" id="L152">                        final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidkey&quot;, name);</span>
<span class="nc" id="L153">                        LOG.error(msg, ex);</span>
<span class="nc" id="L154">                        throw new PublisherConnectionException(msg);</span>
<span class="fc" id="L155">                    }</span>
                    try {
<span class="fc" id="L157">                        final double pvalue = Double.parseDouble(config.getProperty(name));</span>
<span class="pc bpc" id="L158" title="3 of 4 branches missed.">                        if (pvalue &lt; 0.0 || pvalue &gt; 1.0) {</span>
<span class="fc" id="L159">                            final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, name, intres.getLocalizedMessage(&quot;publisher.pvalueinterval&quot;));</span>
<span class="fc" id="L160">                            LOG.error(msg);</span>
<span class="fc" id="L161">                            throw new PublisherConnectionException(msg);</span>
                        }
<span class="nc" id="L163">                    } catch (NumberFormatException ex) {</span>
<span class="nc" id="L164">                        final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, name, ex.getLocalizedMessage());</span>
<span class="nc" id="L165">                        LOG.error(msg, ex);</span>
<span class="nc" id="L166">                        throw new PublisherConnectionException(msg);</span>
<span class="nc" id="L167">                    }</span>
                }
            }
<span class="fc" id="L170">        }</span>
<span class="nc" id="L171">    }</span>
    
    @Override
    public boolean storeCRL(AuthenticationToken admin, byte[] incrl, String cafp, int number, String userDN) throws PublisherException {
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L176">        	LOG.trace(&quot;CRL sampling is not supported&quot;);</span>
        }
<span class="fc" id="L178">        return true; // This ICustomPublisher does not care about CRLs and chooses to simply return SUCCESS for those.</span>
    }

    @Override
    public boolean storeCertificate(AuthenticationToken admin, Certificate incert, String username, String password, String userDN, String cafp, int status, int type, long revocationDate, int revocationReason, String tag, int certificateProfileId, long lastUpdate, org.cesecore.certificates.endentity.ExtendedInformation extendedinformation) throws PublisherException {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L184">            LOG.trace(&quot;&gt;storeCertificate, Storing Certificate of profileid: &quot; + certificateProfileId);</span>
        }
<span class="fc bfc" id="L186" title="All 2 branches covered.">        if (status == CertificateConstants.CERT_ACTIVE) {</span>
            // Sample the certificate if it is time for that
<span class="fc bfc" id="L188" title="All 2 branches covered.">            if (isTimeToSample(certificateProfileId)) {</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L190">                    LOG.trace(&quot;Sample&quot;);</span>
                }
<span class="fc" id="L192">                writeCertificate(incert, getOutputFolder(), username + &quot;-&quot;, &quot;.crt&quot;);</span>
            } else {
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">                if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L195">                    LOG.trace(&quot;No sampling&quot;);</span>
                }
            }
        }
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L200">            LOG.trace(&quot;&lt;storeCertificate&quot;);</span>
        }
<span class="fc" id="L202">        return true; // If we got this far either we chose to not store the certificate or it was stored correctly</span>
    }

    protected void writeCertificate(Certificate cert, File outFolder, String prefix, String suffix) throws PublisherException {
        try {
<span class="nc" id="L207">            final File destFile = File.createTempFile(prefix, suffix, outFolder);</span>
<span class="nc" id="L208">            try (FileOutputStream fos = new FileOutputStream(destFile)) {</span>
<span class="nc" id="L209">                fos.write(cert.getEncoded());</span>
            }
<span class="nc" id="L211">        } catch (CertificateEncodingException ex) {</span>
<span class="nc" id="L212">            final String msg = intres.getLocalizedMessage(&quot;publisher.errorcertconversion&quot;);</span>
<span class="nc" id="L213">            LOG.error(msg);</span>
<span class="nc" id="L214">            throw new PublisherException(msg);</span>
<span class="nc" id="L215">        } catch (IOException e) {</span>
<span class="nc" id="L216">            final String msg = intres.getLocalizedMessage(&quot;publisher.errortempfile&quot;);</span>
<span class="nc" id="L217">            LOG.error(msg, e);</span>
<span class="nc" id="L218">            throw new PublisherException(msg);</span>
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">    }</span>
    
    /**
     * Checks if the certificate should be sampled according to the sampling 
     * method.
     * @param profileId The profileId the certificate was issued for
     * @return True if it is &quot;time&quot; to take a sample.
     * @throws PublisherException in case of configuration errors
     */
    private boolean isTimeToSample(int profileId) throws PublisherException {
        final boolean result;
        
<span class="fc" id="L232">        SamplingMethod theMethod = getMethod(profileId);</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L234">            LOG.trace(&quot;samplingMethod: &quot; + theMethod);</span>
        }
        
<span class="pc bpc" id="L237" title="1 of 4 branches missed.">        switch (theMethod) {</span>
            case SAMPLE_NONE: {
<span class="fc" id="L239">                result = false;</span>
<span class="fc" id="L240">                break;</span>
            } 
            case SAMPLE_ALL: {
<span class="fc" id="L243">                result = true;</span>
<span class="fc" id="L244">                break;</span>
            }
            case SAMPLE_PROBABILISTIC: {
                // Get the ratio
<span class="fc" id="L248">                Double p = getPvalue(profileId);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">                if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L250">                    LOG.trace(&quot;pvalue: &quot; + p);</span>
                }

                // Gets an pseudorandomly value between 0 and 1 from an approximately uniform distribution
                // Notice: This method call is thread-safe, however uses synchronization which might decrease performance
                //         We can not use a random object as instance variable as a new instance of this class is created for every request and requests at the same time would then be initialized with the same seed
                //         When we switch to Java 7 we could possibly use ThreadLocalRandom instead.
<span class="fc" id="L257">                final double r = Math.random();</span>

                // r will be less than our p with the probability of p
<span class="fc bfc" id="L260" title="All 2 branches covered.">                result = r &lt; p;</span>
<span class="fc" id="L261">                    break;</span>
                }
            default: {
<span class="nc" id="L264">                final String msg = intres.getLocalizedMessage(&quot;publisher.errorsamplingmethod&quot;);</span>
<span class="nc" id="L265">                LOG.error(msg);</span>
<span class="nc" id="L266">                throw new PublisherException(msg);</span>
            }
        }
<span class="fc" id="L269">        return result;</span>
    }
    
    private SamplingMethod getMethod(int profileId) throws PublisherException {
        final SamplingMethod result;
        
<span class="fc" id="L275">        String propertyKey = PROPERTYPREFIX_PROFILEID + profileId + PROPERTYSUFFIX_SAMPLINGMETHOD;</span>
<span class="fc" id="L276">        String propertyString = config.getProperty(propertyKey);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (propertyString == null) {</span>
<span class="fc" id="L278">            propertyKey = PROPERTY_DEFAULT_SAMPLINGMETHOD;</span>
<span class="fc" id="L279">            propertyString = config.getProperty(propertyKey);</span>
        }
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (propertyString == null) {</span>
<span class="fc" id="L282">            final String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, propertyKey);</span>
<span class="fc" id="L283">            LOG.error(msg);</span>
<span class="fc" id="L284">            throw new PublisherException(msg);</span>
        }
        try {
<span class="fc" id="L287">            result = SamplingMethod.valueOf(propertyString);</span>
<span class="fc" id="L288">        } catch (IllegalArgumentException ex) {</span>
<span class="fc" id="L289">            final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, PROPERTY_DEFAULT_PVALUE, ex.getLocalizedMessage());</span>
<span class="fc" id="L290">            LOG.debug(msg, ex);</span>
<span class="fc" id="L291">            throw new PublisherException(msg);</span>
<span class="fc" id="L292">        }</span>
<span class="fc" id="L293">        return result;</span>
    }
    
    private Double getPvalue(int profileId) throws PublisherException {
        final Double result;
        
<span class="fc" id="L299">        String propertyKey = PROPERTYPREFIX_PROFILEID + profileId + PROPERTYSUFFIX_PVALUE;</span>
<span class="fc" id="L300">        String propertyString = config.getProperty(propertyKey);</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (propertyString == null) {</span>
<span class="fc" id="L302">            propertyKey = PROPERTY_DEFAULT_PVALUE;</span>
<span class="fc" id="L303">            propertyString = config.getProperty(propertyKey);</span>
        }
<span class="fc bfc" id="L305" title="All 2 branches covered.">        if (propertyString == null) {</span>
<span class="fc" id="L306">            final String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, propertyKey);</span>
<span class="fc" id="L307">            LOG.error(msg);</span>
<span class="fc" id="L308">            throw new PublisherException(msg);</span>
        }
        try {
<span class="fc" id="L311">            result = Double.parseDouble(propertyString);</span>
<span class="nc" id="L312">        } catch (NumberFormatException ex) {</span>
<span class="nc" id="L313">            final String msg = intres.getLocalizedMessage(&quot;publisher.errorinvalidvalue&quot;, PROPERTY_DEFAULT_PVALUE, ex.getLocalizedMessage());</span>
<span class="nc" id="L314">            LOG.debug(msg, ex);</span>
<span class="nc" id="L315">            throw new PublisherException(msg);</span>
<span class="fc" id="L316">        }</span>
<span class="fc" id="L317">        return result;</span>
    }
    
    private File getOutputFolder() throws PublisherException {
        final File result;
<span class="fc" id="L322">        String outputFolderString = config.getProperty(PROPERTY_OUTPUTFOLDER, &quot;&quot;).trim();</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">        if (outputFolderString.length() &lt; 1) {</span>
<span class="fc" id="L324">            final String msg = intres.getLocalizedMessage(&quot;publisher.errormissingproperty&quot;, PROPERTY_OUTPUTFOLDER);</span>
<span class="fc" id="L325">            LOG.error(msg);</span>
<span class="fc" id="L326">            throw new PublisherException(msg);</span>
        } else {
<span class="fc" id="L328">            result = new File(outputFolderString);</span>
        }
<span class="fc" id="L330">        return result;</span>
    }
    
<span class="fc" id="L333">    public enum SamplingMethod {</span>
        /** No certificates are sampled. */
<span class="fc" id="L335">        SAMPLE_NONE,</span>
        
        /** All certificates are sampled. */ 
<span class="fc" id="L338">        SAMPLE_ALL,</span>
        
        /** Every certificate is sampled with the probability as specified as the pvalue. */
<span class="fc" id="L341">        SAMPLE_PROBABILISTIC,</span>
    }

    @Override
    public boolean willPublishCertificate(int status, int revocationReason) {
<span class="nc" id="L346">        return true;</span>
    }
    
    @Override
    public boolean isReadOnly() {
<span class="nc" id="L351">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>