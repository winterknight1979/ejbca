<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EstConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA Common code</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.config</a> &gt; <span class="el_source">EstConfiguration.java</span></div><h1>EstConfiguration.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.config;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Properties;
import java.util.Set;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.certificates.certificateprofile.CertificateProfileConstants;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.configuration.ConfigurationBase;


/**
 * This is a  class containing EST configuration parameters.
 *
 * @version $Id: EstConfiguration.java 28048 2018-01-22 09:04:54Z anatom $
 */
public class EstConfiguration extends ConfigurationBase implements Serializable {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L44">    private static final Logger log = Logger.getLogger(EstConfiguration.class);</span>

    // Constants: Configuration keys
    public static final String CONFIG_DEFAULTCA     = &quot;defaultca&quot;;
    public static final String CONFIG_CERTPROFILE   = &quot;certprofile&quot;;
    public static final String CONFIG_EEPROFILE     = &quot;eeprofile&quot;;
    public static final String CONFIG_REQCERT       = &quot;requirecert&quot;;
    public static final String CONFIG_REQUSERNAME   = &quot;requsername&quot;;
    public static final String CONFIG_REQPASSWORD   = &quot;reqpassword&quot;;
    public static final String CONFIG_ALLOWUPDATEWITHSAMEKEY  = &quot;allowupdatewithsamekey&quot;;

<span class="nc" id="L55">    private final String ALIAS_LIST = &quot;aliaslist&quot;;</span>
    public static final String EST_CONFIGURATION_ID = &quot;4&quot;;

    // Default Values
    public static final float LATEST_VERSION = 3f;
<span class="nc" id="L60">    public static final String EJBCA_VERSION = InternalConfiguration.getAppVersion();</span>

    // Default values
<span class="nc" id="L63">    private static final Set&lt;String&gt; DEFAULT_ALIAS_LIST      = new LinkedHashSet&lt;&gt;();</span>
    private static final String DEFAULT_DEFAULTCA = &quot;&quot;;
<span class="nc" id="L65">    public static final String DEFAULT_EEPROFILE = String.valueOf(EndEntityConstants.EMPTY_END_ENTITY_PROFILE);</span>
<span class="nc" id="L66">    private static final String DEFAULT_CERTPROFILE = String.valueOf(CertificateProfileConstants.CERTPROFILE_FIXED_ENDUSER);</span>
    private static final String DEFAULT_REQCERT = &quot;true&quot;;
    private static final String DEFAULT_REQUSERNAME = &quot;&quot;;
    private static final String DEFAULT_REQPASSWORD = &quot;&quot;;
    private static final String DEFAULT_ALLOWUPDATEWITHSAMEKEY = &quot;true&quot;;

    // This List is used in the command line handling of updating a config value to ensure a correct value.
<span class="nc" id="L73">    public static final List&lt;String&gt; EST_BOOLEAN_KEYS = Arrays.asList(CONFIG_REQCERT, CONFIG_ALLOWUPDATEWITHSAMEKEY);</span>

    /** Creates a new instance of EstConfiguration */
    public EstConfiguration()  {
<span class="nc" id="L77">       super();</span>
<span class="nc" id="L78">    }</span>

<span class="nc" id="L80">    public EstConfiguration(Serializable dataobj) {</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L82">        LinkedHashMap&lt;Object, Object&gt; d = (LinkedHashMap&lt;Object, Object&gt;) dataobj;</span>
<span class="nc" id="L83">        data = d;</span>
<span class="nc" id="L84">    }</span>

    /**
     * Copy constructor for {@link EstConfiguration}
     * @param estConfiguration Config
     */
    public EstConfiguration(EstConfiguration estConfiguration) {
<span class="nc" id="L91">        super();</span>
<span class="nc" id="L92">        setAliasList(new LinkedHashSet&lt;String&gt;());</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for(String alias : estConfiguration.getAliasList()) {</span>
<span class="nc" id="L94">            addAlias(alias);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            for(String key : getAllAliasKeys(alias)) {</span>
<span class="nc" id="L96">                String value = estConfiguration.getValue(key, alias);</span>
<span class="nc" id="L97">                setValue(key, value, alias);</span>
<span class="nc" id="L98">            }</span>
<span class="nc" id="L99">        }</span>
<span class="nc" id="L100">    }</span>

    /** Initializes a new cmp configuration with default values. 
     * @param alias Alias */
    public void initialize(String alias){
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if(StringUtils.isNotEmpty(alias)) {</span>
<span class="nc" id="L106">            alias = alias + &quot;.&quot;;</span>
<span class="nc" id="L107">            data.put(alias + CONFIG_DEFAULTCA, DEFAULT_DEFAULTCA);</span>
<span class="nc" id="L108">            data.put(alias + CONFIG_CERTPROFILE, DEFAULT_CERTPROFILE);</span>
<span class="nc" id="L109">            data.put(alias + CONFIG_EEPROFILE, DEFAULT_EEPROFILE);</span>
<span class="nc" id="L110">            data.put(alias + CONFIG_REQCERT, DEFAULT_REQCERT);</span>
<span class="nc" id="L111">            data.put(alias + CONFIG_REQUSERNAME, DEFAULT_REQUSERNAME);</span>
<span class="nc" id="L112">            data.put(alias + CONFIG_REQPASSWORD, DEFAULT_REQPASSWORD);</span>
<span class="nc" id="L113">            data.put(alias + CONFIG_ALLOWUPDATEWITHSAMEKEY, DEFAULT_ALLOWUPDATEWITHSAMEKEY);</span>
        }
<span class="nc" id="L115">    }</span>

    // return all the key with an alias
    public static Set&lt;String&gt; getAllAliasKeys(String alias) {
<span class="nc" id="L119">        alias = alias + &quot;.&quot;;</span>
<span class="nc" id="L120">        Set&lt;String&gt; keys = new LinkedHashSet&lt;&gt;();</span>
<span class="nc" id="L121">        keys.add(alias + CONFIG_DEFAULTCA);</span>
<span class="nc" id="L122">        keys.add(alias + CONFIG_CERTPROFILE);</span>
<span class="nc" id="L123">        keys.add(alias + CONFIG_EEPROFILE);</span>
<span class="nc" id="L124">        keys.add(alias + CONFIG_REQCERT);</span>
<span class="nc" id="L125">        keys.add(alias + CONFIG_REQUSERNAME);</span>
<span class="nc" id="L126">        keys.add(alias + CONFIG_REQPASSWORD);</span>
<span class="nc" id="L127">        keys.add(alias + CONFIG_ALLOWUPDATEWITHSAMEKEY);</span>
<span class="nc" id="L128">        return keys;</span>
    }

    /**
     * @param alias the EST alias to get value from
     * @return CA ID in String format, String format to be backwards compatible with EJBCA 6.11 when it was stored as CA Name instead of ID
     */
    public String getDefaultCAID(String alias) {
<span class="nc" id="L136">        String key = alias + &quot;.&quot; + CONFIG_DEFAULTCA;</span>
<span class="nc" id="L137">        return getValue(key, alias);</span>
    }
    public void setDefaultCAID(String alias, int defaultCAID) {
<span class="nc" id="L140">        String key = alias + &quot;.&quot; + CONFIG_DEFAULTCA;</span>
<span class="nc" id="L141">        setValue(key, String.valueOf(defaultCAID), alias);</span>
<span class="nc" id="L142">    }</span>

    /**
     * @param alias the EST alias to get value from
     * @return Certificate Profile ID in String format, String format to be backwards compatible with EJBCA 6.11 when it was stored as CP Name instead of ID
     */
    public String getCertProfileID(String alias) {
<span class="nc" id="L149">        String key = alias + &quot;.&quot; + CONFIG_CERTPROFILE;</span>
<span class="nc" id="L150">        return getValue(key, alias);</span>
    }
    /**
     * @param alias the EST alias to edit
     * @param cprofileID Certificate Profile ID
     */
    public void setCertProfileID(String alias, int cprofileID) {
<span class="nc" id="L157">        String key = alias + &quot;.&quot; + CONFIG_CERTPROFILE;</span>
<span class="nc" id="L158">        setValue(key, String.valueOf(cprofileID), alias);</span>
<span class="nc" id="L159">    }</span>

    public int getEndEntityProfileID(String alias) {
<span class="nc" id="L162">        String key = alias + &quot;.&quot; + CONFIG_EEPROFILE;</span>
        try {
<span class="nc" id="L164">            Integer id = Integer.valueOf(getValue(key, alias));</span>
<span class="nc" id="L165">            return id;</span>
<span class="nc" id="L166">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L167">            log.error(&quot;Invalid End Entity Profile ID stored in EST alias, returning 0: &quot;+alias, e);</span>
<span class="nc" id="L168">            return 0;</span>
        }
    }
    /**
     * @param alias the EST alias to edit
     * @param eeprofileID End Entity Profile ID
     */
    public void setEndEntityProfileID(String alias, int eeprofileID) {
<span class="nc" id="L176">        String key = alias + &quot;.&quot; + CONFIG_EEPROFILE;</span>
<span class="nc" id="L177">        setValue(key, String.valueOf(eeprofileID), alias);</span>
<span class="nc" id="L178">    }</span>

    /**
     * @param alias the alias to check for
     *
     * @return true if we require a certificate for authentication
     */
    public boolean getCert(String alias) {
<span class="nc" id="L186">        String key = alias + &quot;.&quot; + CONFIG_REQCERT;</span>
<span class="nc" id="L187">        return StringUtils.equalsIgnoreCase(getValue(key, alias), &quot;true&quot;);</span>
    }

    public void setCert(String alias, boolean reqCert) {
<span class="nc" id="L191">        String key = alias + &quot;.&quot; + CONFIG_REQCERT;</span>
<span class="nc" id="L192">        setValue(key, Boolean.toString(reqCert), alias);</span>
<span class="nc" id="L193">    }</span>

    /**
     * @param alias the alias to check for
     *
     * @return username if any, or null if none
     */
    public String getUsername(String alias) {
<span class="nc" id="L201">        String key = alias + &quot;.&quot; + CONFIG_REQUSERNAME;</span>
<span class="nc" id="L202">        return getValue(key, alias);</span>
    }

    public void setUsername(String alias, String username) {
<span class="nc" id="L206">        String key = alias + &quot;.&quot; + CONFIG_REQUSERNAME;</span>
<span class="nc" id="L207">        setValue(key, username, alias);</span>
<span class="nc" id="L208">    }</span>

    /**
     * @param alias the alias to check for
     *
     * @return password if any, or null if none
     */
    public String getPassword(String alias) {
<span class="nc" id="L216">        String key = alias + &quot;.&quot; + CONFIG_REQPASSWORD;</span>
<span class="nc" id="L217">        return getValue(key, alias);</span>
    }

    public void setPassword(String alias, String password) {
<span class="nc" id="L221">        String key = alias + &quot;.&quot; + CONFIG_REQPASSWORD;</span>
<span class="nc" id="L222">        setValue(key, password, alias);</span>
<span class="nc" id="L223">    }</span>

    /**
     * @param alias the alias to check for
     *
     * @return true if allowed to reenroll with the same key
     */
    public boolean getKurAllowSameKey(String alias) {
<span class="nc" id="L231">        String key = alias + &quot;.&quot; + CONFIG_ALLOWUPDATEWITHSAMEKEY;</span>
<span class="nc" id="L232">        String value = getValue(key, alias);</span>
<span class="nc" id="L233">        return StringUtils.equalsIgnoreCase(value, &quot;true&quot;);</span>
    }

    public void setKurAllowSameKey(String alias, boolean allowSameKey) {
<span class="nc" id="L237">        String key = alias + &quot;.&quot; + CONFIG_ALLOWUPDATEWITHSAMEKEY;</span>
<span class="nc" id="L238">        setValue(key, Boolean.toString(allowSameKey), alias);</span>
<span class="nc" id="L239">    }</span>

    public String getValue(String key, String alias) {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if(aliasExists(alias)) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if(data.containsKey(key)) {</span>
<span class="nc" id="L244">                return (String) data.get(key);</span>
            } else {
<span class="nc" id="L246">                log.info(&quot;Could not find key '&quot; + key + &quot;' in the EST configuration data&quot;);</span>
            }
        } else {
<span class="nc" id="L249">            log.info(&quot;EST alias '&quot; + alias + &quot;' does not exist&quot;);</span>
        }
<span class="nc" id="L251">        return null;</span>
    }

    public void setValue(String key, String value, String alias) {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if(aliasExists(alias)) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if(data.containsKey(key)) {</span>
<span class="nc" id="L257">                data.put(key, value);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L259">                    log.debug(&quot;Added '&quot; + key + &quot;=&quot; + value + &quot;' to the EST configuration data&quot;);</span>
                }
            } else {
<span class="nc" id="L262">                data.put(key, value);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L264">                    log.debug(&quot;Key '&quot; + key + &quot;' does not exist in the EST configuration data, adding it&quot;);</span>
                }
            }
        } else {
<span class="nc" id="L268">            log.info(&quot;EST alias '&quot; + alias + &quot;' does not exist&quot;);</span>
        }
<span class="nc" id="L270">    }</span>

    public void setAliasList(final Set&lt;String&gt; aliaslist) {
<span class="nc" id="L273">        data.put(ALIAS_LIST, aliaslist);</span>
<span class="nc" id="L274">    }</span>

    public Set&lt;String&gt; getAliasList() {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L278">        Set&lt;String&gt; ret = (Set&lt;String&gt;) data.get(ALIAS_LIST);</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">        return (ret == null ? DEFAULT_ALIAS_LIST : ret);</span>
    }

    public List&lt;String&gt; getSortedAliasList() {
<span class="nc" id="L284">        List&lt;String&gt; result = new ArrayList&lt;&gt;(getAliasList());</span>
<span class="nc" id="L285">        Collections.sort(result, new Comparator&lt;String&gt;() {</span>
            @Override
            public int compare(String o1, String o2) {
<span class="nc" id="L288">                return o1.compareToIgnoreCase(o2);</span>
            }
        });
<span class="nc" id="L291">        return result;</span>
    }

    public boolean aliasExists(String alias) {
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if(StringUtils.isNotEmpty(alias)) {</span>
<span class="nc" id="L296">            Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc" id="L297">            return aliases.contains(alias);</span>
        }
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L300">            log.debug(&quot;EST alias '&quot; + alias+&quot;' does not exist.&quot;);</span>
        }
<span class="nc" id="L302">        return false;</span>
    }

    public void addAlias(String alias) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L307">            log.debug(&quot;Adding EST alias: &quot; + alias);</span>
        }

<span class="nc bnc" id="L310" title="All 2 branches missed.">        if(StringUtils.isEmpty(alias)) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L312">                log.debug(&quot;No alias is added because no alias was provided.&quot;);</span>
            }
<span class="nc" id="L314">            return;</span>
        }

<span class="nc" id="L317">        Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if(aliases.contains(alias)) {</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L320">                log.debug(&quot;EST alias '&quot; + alias + &quot;' already exists.&quot;);</span>
            }
<span class="nc" id="L322">            return;</span>
        }
<span class="nc" id="L324">        initialize(alias);</span>
<span class="nc" id="L325">        aliases.add(alias);</span>
<span class="nc" id="L326">        data.put(ALIAS_LIST, aliases);</span>
<span class="nc" id="L327">    }</span>

    public void removeAlias(String alias) {
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L331">            log.debug(&quot;Removing EST alias: &quot; + alias);</span>
        }

<span class="nc bnc" id="L334" title="All 2 branches missed.">        if(StringUtils.isEmpty(alias)) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L336">                log.debug(&quot;No alias is removed because no alias was provided.&quot;);</span>
            }
<span class="nc" id="L338">            return;</span>
        }

<span class="nc" id="L341">        Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if(!aliases.contains(alias)) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L344">                log.debug(&quot;EST alias '&quot; + alias + &quot;' does not exist&quot;);</span>
            }
<span class="nc" id="L346">            return;</span>
        }

<span class="nc bnc" id="L349" title="All 2 branches missed.">        for(String key : getAllAliasKeys(alias)) {</span>
<span class="nc" id="L350">            data.remove(key);</span>
<span class="nc" id="L351">        }</span>
<span class="nc" id="L352">        aliases.remove(alias);</span>
<span class="nc" id="L353">        data.put(ALIAS_LIST, aliases);</span>
<span class="nc" id="L354">    }</span>

    public void renameAlias(String oldAlias, String newAlias) {
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L358">            log.debug(&quot;Renaming EST alias '&quot; + oldAlias + &quot;' to '&quot; + newAlias + &quot;'&quot;);</span>
        }

<span class="nc bnc" id="L361" title="All 4 branches missed.">        if(StringUtils.isEmpty(oldAlias) || StringUtils.isEmpty(newAlias)) {</span>
<span class="nc" id="L362">            log.info(&quot;No alias is renamed because one or both aliases were not provided.&quot;);</span>
<span class="nc" id="L363">            return;</span>
        }

<span class="nc" id="L366">        Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if(!aliases.contains(oldAlias)) {</span>
<span class="nc" id="L368">            log.info(&quot;Cannot rename. EST alias '&quot; + oldAlias + &quot;' does not exists.&quot;);</span>
<span class="nc" id="L369">            return;</span>
        }

<span class="nc bnc" id="L372" title="All 2 branches missed.">        if(aliases.contains(newAlias)) {</span>
<span class="nc" id="L373">            log.info(&quot;Cannot rename. EST alias '&quot; + newAlias + &quot;' already exists.&quot;);</span>
<span class="nc" id="L374">            return;</span>
        }

<span class="nc" id="L377">        Set&lt;String&gt; oldKeys = getAllAliasKeys(oldAlias);</span>
<span class="nc" id="L378">        Iterator&lt;String&gt; itr = oldKeys.iterator();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">        while(itr.hasNext()) {</span>
<span class="nc" id="L380">            String oldkey = itr.next();</span>
<span class="nc" id="L381">            String newkey = oldkey;</span>
<span class="nc" id="L382">            newkey = StringUtils.replace(newkey, oldAlias, newAlias);</span>
<span class="nc" id="L383">            Object value = data.get(oldkey);</span>
<span class="nc" id="L384">            data.put(newkey, value);</span>
<span class="nc" id="L385">        }</span>
<span class="nc" id="L386">        removeAlias(oldAlias);</span>
<span class="nc" id="L387">        aliases.remove(oldAlias);</span>
<span class="nc" id="L388">        aliases.add(newAlias);</span>
<span class="nc" id="L389">        data.put(ALIAS_LIST, aliases);</span>
<span class="nc" id="L390">    }</span>

    public void cloneAlias(String originAlias, String cloneAlias) {
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L394">            log.debug(&quot;Cloning EST alias '&quot; + originAlias + &quot;' to '&quot; + cloneAlias + &quot;'&quot;);</span>
        }

<span class="nc bnc" id="L397" title="All 4 branches missed.">        if(StringUtils.isEmpty(originAlias) || StringUtils.isEmpty(cloneAlias)) {</span>
<span class="nc" id="L398">            log.info(&quot;No alias is cloned because one or both aliased were not provided&quot;);</span>
<span class="nc" id="L399">            return;</span>
        }

<span class="nc" id="L402">        Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if(!aliases.contains(originAlias)) {</span>
<span class="nc" id="L404">            log.info(&quot;Cannot clone. EST alias '&quot; + originAlias + &quot;' does not exist.&quot;);</span>
<span class="nc" id="L405">            return;</span>
        }

<span class="nc bnc" id="L408" title="All 2 branches missed.">        if(aliases.contains(cloneAlias)) {</span>
<span class="nc" id="L409">            log.info(&quot;Cannot clone. EST alias '&quot; + cloneAlias + &quot;' already exists.&quot;);</span>
<span class="nc" id="L410">            return;</span>
        }

<span class="nc" id="L413">        Iterator&lt;String&gt; itr = getAllAliasKeys(originAlias).iterator();</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">        while(itr.hasNext()) {</span>
<span class="nc" id="L415">            String originalKey = itr.next();</span>
<span class="nc" id="L416">            String cloneKey = originalKey;</span>
<span class="nc" id="L417">            cloneKey = StringUtils.replace(cloneKey, originAlias, cloneAlias);</span>
<span class="nc" id="L418">            Object value = data.get(originalKey);</span>
<span class="nc" id="L419">            data.put(cloneKey, value);</span>
<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">        aliases.add(cloneAlias);</span>
<span class="nc" id="L422">        data.put(ALIAS_LIST, aliases);</span>
<span class="nc" id="L423">    }</span>

    /**
     * @return the configuration as a regular Properties object
     */
    public Properties getAsProperties() {
<span class="nc" id="L429">        final Properties properties = new Properties();</span>
<span class="nc" id="L430">        Set&lt;String&gt; aliases = getAliasList();</span>
<span class="nc" id="L431">        Iterator&lt;String&gt; itr = aliases.iterator();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        while(itr.hasNext()) {</span>
<span class="nc" id="L433">            String alias = itr.next();</span>
<span class="nc" id="L434">            Properties aliasp = getAsProperties(alias);</span>
<span class="nc" id="L435">            properties.putAll(aliasp);</span>
<span class="nc" id="L436">        }</span>
<span class="nc" id="L437">        return properties;</span>
    }

    public Properties getAsProperties(String alias) {
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if(aliasExists(alias)) {</span>
<span class="nc" id="L442">            final Properties properties = new Properties();</span>
<span class="nc" id="L443">            final Iterator&lt;String&gt; i = getAllAliasKeys(alias).iterator();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            while (i.hasNext()) {</span>
<span class="nc" id="L445">                final String key = i.next();</span>
<span class="nc" id="L446">                final Object value = data.get(key);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                properties.setProperty(key, value == null? &quot;&quot; : value.toString());</span>
<span class="nc" id="L448">            }</span>
<span class="nc" id="L449">            return properties;</span>
        }
<span class="nc" id="L451">        return null;</span>
    }

    /** Implementation of UpgradableDataHashMap function getLatestVersion */
    @Override
    public float getLatestVersion() {
<span class="nc" id="L457">       return LATEST_VERSION;</span>
    }

    /** Implementation of UpgradableDataHashMap function upgrade. */
    @Override
    public void upgrade() {
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if(Float.compare(LATEST_VERSION, getVersion()) != 0) {</span>
<span class="nc" id="L464">            data.put(VERSION,  Float.valueOf(LATEST_VERSION));</span>
        }
<span class="nc" id="L466">    }</span>

    @Override
    public String getConfigurationId() {
<span class="nc" id="L470">        return EST_CONFIGURATION_ID;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>