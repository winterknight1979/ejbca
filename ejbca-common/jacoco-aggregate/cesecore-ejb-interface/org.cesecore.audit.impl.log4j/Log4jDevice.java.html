<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Log4jDevice.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-common</a> &gt; <a href="../index.html" class="el_bundle">cesecore-ejb-interface</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.audit.impl.log4j</a> &gt; <span class="el_source">Log4jDevice.java</span></div><h1>Log4jDevice.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.audit.impl.log4j;

import java.util.ArrayList;
import java.util.Date;
import java.util.Enumeration;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import org.apache.log4j.Appender;
import org.apache.log4j.Logger;
import org.apache.log4j.spi.ErrorHandler;
import org.cesecore.audit.AuditLogDevice;
import org.cesecore.audit.AuditLogEntry;
import org.cesecore.audit.audit.AuditExporter;
import org.cesecore.audit.audit.AuditLogExportReport;
import org.cesecore.audit.audit.AuditLogExporterException;
import org.cesecore.audit.audit.AuditLogValidationReport;
import org.cesecore.audit.audit.AuditLogValidatorException;
import org.cesecore.audit.enums.EventStatus;
import org.cesecore.audit.enums.EventType;
import org.cesecore.audit.enums.ModuleType;
import org.cesecore.audit.enums.ServiceType;
import org.cesecore.audit.log.AuditLogResetException;
import org.cesecore.audit.log.AuditRecordStorageException;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.keys.token.CryptoToken;
import org.cesecore.time.TrustedTime;
import org.cesecore.util.ValidityDate;
import org.cesecore.util.query.QueryCriteria;

/**
 * Simple implementation of (secure) audit that writes all log to Log4J.
 * 
 * This implementation does not comply to the CESeCore TSF regarding log protection and only provided as a compliment
 * to monitor operations or for use in high performance environments where compliance is not an issue.
 * 
 * @version $Id: Log4jDevice.java 18374 2014-01-16 13:13:34Z anatom $
 */
public class Log4jDevice implements AuditLogDevice {

<span class="nc" id="L54">	private static final Logger LOG = Logger.getLogger(Log4jDevice.class);</span>
<span class="nc" id="L55">	private static final String UNSUPPORTED = Log4jDevice.class.getSimpleName() + &quot; does not support query, verification or export operations.&quot;;</span>
<span class="nc" id="L56">	private final List&lt;Log4jDeviceErrorHandler&gt; errorHandlers = new ArrayList&lt;Log4jDeviceErrorHandler&gt;();</span>
	
<span class="nc" id="L58">	public Log4jDevice() {</span>
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L60">        final Enumeration&lt;Appender&gt; enumeration = LOG.getAllAppenders();</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">		while (enumeration.hasMoreElements()) {</span>
<span class="nc" id="L62">			final Appender appender = enumeration.nextElement();</span>
<span class="nc" id="L63">			final ErrorHandler errorHandler = appender.getErrorHandler();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (errorHandler != null) {</span>
<span class="nc" id="L65">				final Log4jDeviceErrorHandler wrappedErrorHandler = new Log4jDeviceErrorHandler(errorHandler);</span>
<span class="nc" id="L66">				errorHandlers.add(wrappedErrorHandler);</span>
<span class="nc" id="L67">				appender.setErrorHandler(wrappedErrorHandler);</span>
			}
<span class="nc" id="L69">		}</span>
<span class="nc" id="L70">	}</span>
	
	private void assertNoErrors() throws AuditRecordStorageException {
<span class="nc bnc" id="L73" title="All 2 branches missed.">		for (final Log4jDeviceErrorHandler errorHandler : errorHandlers) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">			if (!errorHandler.isOk()) {</span>
<span class="nc" id="L75">				throw new AuditRecordStorageException(&quot;A log4j device failed to log.&quot;);</span>
			}
<span class="nc" id="L77">		}</span>
<span class="nc" id="L78">	}</span>

	@Override
	public boolean isSupportingQueries() {
<span class="nc" id="L82">		return false;</span>
	}

	@Override
	public void setEjbs(final Map&lt;Class&lt;?&gt;, ?&gt; ejbs) {
		// Does not use any beans
<span class="nc" id="L88">	}</span>

	@Override
	public AuditLogExportReport exportAuditLogs(final AuthenticationToken token, final CryptoToken cryptoToken, final Date timestamp,
			final boolean deleteAfterExport, final Map&lt;String, Object&gt; signatureDetails, final Properties properties, final Class&lt;? extends AuditExporter&gt; c) throws AuditLogExporterException {
<span class="nc" id="L93">		throw new UnsupportedOperationException(UNSUPPORTED);</span>
	}

	@Override
	public List&lt;? extends AuditLogEntry&gt; selectAuditLogs(final AuthenticationToken token, final int startIndex, final int max, final QueryCriteria criteria, final Properties properties) {
<span class="nc" id="L98">		throw new UnsupportedOperationException(UNSUPPORTED);</span>
	}

	@Override
	public AuditLogValidationReport verifyLogsIntegrity(final AuthenticationToken token, final Date date, final Properties properties) throws AuditLogValidatorException {
<span class="nc" id="L103">		throw new UnsupportedOperationException(UNSUPPORTED);</span>
	}

	@Override
	public void log(final TrustedTime trustedTime, final EventType eventType, final EventStatus eventStatus, final ModuleType module, final ServiceType service,
			final String authToken, final String customId, final String searchDetail1, final String searchDetail2, final Map&lt;String, Object&gt; additionalDetails, Properties properties)
			throws AuditRecordStorageException {
	    // Log lines are usually between 117 and 1700 bytes. An initial length of 1024 will cover most of them, speeding things up.
<span class="nc" id="L111">		final StringBuilder sb = new StringBuilder(1024);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (trustedTime != null) {</span>
<span class="nc" id="L113">			sb.append(ValidityDate.formatAsISO8601(trustedTime.getTime(), ValidityDate.TIMEZONE_SERVER));</span>
		}
<span class="nc" id="L115">		appendIfNotNull(sb, eventType);</span>
<span class="nc" id="L116">		appendIfNotNull(sb, eventStatus);</span>
<span class="nc" id="L117">		appendIfNotNull(sb, module);</span>
<span class="nc" id="L118">		appendIfNotNull(sb, service);</span>
<span class="nc" id="L119">		appendIfNotNull(sb, authToken);</span>
<span class="nc" id="L120">		appendIfNotNull(sb, customId);</span>
<span class="nc" id="L121">		appendIfNotNull(sb, searchDetail1);</span>
<span class="nc" id="L122">		appendIfNotNull(sb, searchDetail2);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (additionalDetails != null) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">			for (final String detail : additionalDetails.keySet()) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				if (sb.length()!=0) {</span>
<span class="nc" id="L126">					sb.append(';');</span>
				}
<span class="nc" id="L128">				sb.append(detail).append('=');</span>
<span class="nc" id="L129">				final Object o = additionalDetails.get(detail);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">				if (o != null) {</span>
<span class="nc" id="L131">					sb.append(o.toString());</span>
				}
<span class="nc" id="L133">			}</span>
		}
<span class="nc" id="L135">		LOG.info(sb.toString());</span>
<span class="nc" id="L136">		assertNoErrors();</span>
<span class="nc" id="L137">	}</span>
	
	// TODO: Not perfect for parsing, since any of the appended values might contain a ';' char
	private void appendIfNotNull(final StringBuilder sb, final Object o) {
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (sb.length()!=0) {</span>
<span class="nc" id="L142">			sb.append(';');</span>
		}
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (o != null) {</span>
<span class="nc" id="L145">			sb.append(o.toString());</span>
		}
<span class="nc" id="L147">	}</span>

	@Override
	public void prepareReset() throws AuditLogResetException {
		// No action required
<span class="nc" id="L152">	}</span>

	@Override
	public void reset() throws AuditLogResetException {
		// No action required
<span class="nc" id="L157">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>