<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CRLData.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-common</a> &gt; <a href="../index.html" class="el_bundle">cesecore-entity</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.crl</a> &gt; <span class="el_source">CRLData.java</span></div><h1>CRLData.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.crl;

import java.io.Serializable;
import java.security.cert.CRLException;
import java.security.cert.X509CRL;
import java.util.Date;
import java.util.List;

import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.PostLoad;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Query;
import javax.persistence.Table;
import javax.persistence.Transient;

import org.apache.log4j.Logger;
import org.cesecore.dbprotection.ProtectedData;
import org.cesecore.dbprotection.ProtectionStringBuilder;
import org.cesecore.util.Base64;
import org.cesecore.util.CertTools;
import org.cesecore.util.QueryResultWrapper;

/**
 * Representation of a CRL.
 * 
 * @version $Id: CRLData.java 22592 2016-01-18 12:09:44Z marko $
 */
@Entity
@Table(name = &quot;CRLData&quot;)
public class CRLData extends ProtectedData implements Serializable {

    private static final long serialVersionUID = 5542295476157001912L;

<span class="nc" id="L48">    private static final Logger log = Logger.getLogger(CRLData.class);</span>

    private int cRLNumber;
    private int deltaCRLIndicator;
    private String issuerDN;
    private String fingerprint;
    private String cAFingerprint;
    private long thisUpdate;
    private long nextUpdate;
    private String base64Crl;
<span class="nc" id="L58">    private int rowVersion = 0;</span>
    private String rowProtection;

    /**
     * Entity holding info about a CRL. Create by sending in the CRL, which extracts (from the crl) fingerprint (primary key), CRLNumber, issuerDN,
     * thisUpdate, nextUpdate. CAFingerprint is the hash of the CA certificate.
     * 
     * @param incrl
     *            the (X509)CRL to be stored in the database.
     * @param number
     *            monotonically increasing CRL number
     * @param issuerDN DN
     * @param thisUpdate Date 
     * @param nextUpdate Date of next update
     * @param cafingerprint FP
     * @param deltaCRLIndicator
     *            -1 for a normal CRL and 1 for a deltaCRL
     */
<span class="nc" id="L76">    public CRLData(byte[] incrl, int number, String issuerDN, Date thisUpdate, Date nextUpdate, String cafingerprint, int deltaCRLIndicator) {</span>
<span class="nc" id="L77">        String b64Crl = new String(Base64.encode(incrl));</span>
<span class="nc" id="L78">        setBase64Crl(b64Crl);</span>
<span class="nc" id="L79">        String fp = CertTools.getFingerprintAsString(incrl);</span>
<span class="nc" id="L80">        setFingerprint(fp);</span>
        // Make sure names are always looking the same
<span class="nc" id="L82">        String issuer = CertTools.stringToBCDNString(issuerDN);</span>
<span class="nc" id="L83">        setIssuerDN(issuer);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L85">            log.debug(&quot;Creating crldata, fp=&quot; + fp + &quot;, issuer=&quot; + issuer + &quot;, crlNumber=&quot; + number + &quot;, deltaCRLIndicator=&quot; + deltaCRLIndicator);</span>
        }
<span class="nc" id="L87">        setCaFingerprint(cafingerprint);</span>
<span class="nc" id="L88">        setCrlNumber(number);</span>
<span class="nc" id="L89">        setThisUpdate(thisUpdate);</span>
<span class="nc" id="L90">        setNextUpdate(nextUpdate);</span>
<span class="nc" id="L91">        setDeltaCRLIndicator(deltaCRLIndicator);</span>
<span class="nc" id="L92">    }</span>

<span class="nc" id="L94">    public CRLData() {</span>
<span class="nc" id="L95">    }</span>

    // @Column
    public int getCrlNumber() {
<span class="nc" id="L99">        return cRLNumber;</span>
    }

    public void setCrlNumber(int cRLNumber) {
<span class="nc" id="L103">        this.cRLNumber = cRLNumber;</span>
<span class="nc" id="L104">    }</span>

    // @Column
    public int getDeltaCRLIndicator() {
<span class="nc" id="L108">        return deltaCRLIndicator;</span>
    }

    public void setDeltaCRLIndicator(int deltaCRLIndicator) {
<span class="nc" id="L112">        this.deltaCRLIndicator = deltaCRLIndicator;</span>
<span class="nc" id="L113">    }</span>

    // @Column
    public String getIssuerDN() {
<span class="nc" id="L117">        return issuerDN;</span>
    }

    /**
     * Use setIssuer instead
     * @param issuerDN DN
     * 
     * @see #setIssuer(String)
     */
    public void setIssuerDN(String issuerDN) {
<span class="nc" id="L127">        this.issuerDN = issuerDN;</span>
<span class="nc" id="L128">    }</span>

    // @Id @Column
    public String getFingerprint() {
<span class="nc" id="L132">        return fingerprint;</span>
    }

    public void setFingerprint(String fingerprint) {
<span class="nc" id="L136">        this.fingerprint = fingerprint;</span>
<span class="nc" id="L137">    }</span>

    // @Column
    public String getCaFingerprint() {
<span class="nc" id="L141">        return cAFingerprint;</span>
    }

    public void setCaFingerprint(String cAFingerprint) {
<span class="nc" id="L145">        this.cAFingerprint = cAFingerprint;</span>
<span class="nc" id="L146">    }</span>

    // @Column
    public long getThisUpdate() {
<span class="nc" id="L150">        return thisUpdate;</span>
    }

    /**
     * Date formated as seconds since 1970 (== Date.getTime())
     * @param thisUpdate Date
     */
    public void setThisUpdate(long thisUpdate) {
<span class="nc" id="L158">        this.thisUpdate = thisUpdate;</span>
<span class="nc" id="L159">    }</span>

    // @Column
    public long getNextUpdate() {
<span class="nc" id="L163">        return nextUpdate;</span>
    }

    /**
     * Date formated as seconds since 1970 (== Date.getTime())
     * @param nextUpdate date
     */
    public void setNextUpdate(long nextUpdate) {
<span class="nc" id="L171">        this.nextUpdate = nextUpdate;</span>
<span class="nc" id="L172">    }</span>

    // @Column @Lob
    public String getBase64Crl() {
<span class="nc" id="L176">        return base64Crl;</span>
    }

    public void setBase64Crl(String base64Crl) {
<span class="nc" id="L180">        this.base64Crl = base64Crl;</span>
<span class="nc" id="L181">    }</span>

    // @Version @Column
    public int getRowVersion() {
<span class="nc" id="L185">        return rowVersion;</span>
    }

    public void setRowVersion(int rowVersion) {
<span class="nc" id="L189">        this.rowVersion = rowVersion;</span>
<span class="nc" id="L190">    }</span>

    // @Column @Lob
    @Override
    public String getRowProtection() {
<span class="nc" id="L195">        return rowProtection;</span>
    }

    @Override
    public void setRowProtection(String rowProtection) {
<span class="nc" id="L200">        this.rowProtection = rowProtection;</span>
<span class="nc" id="L201">    }</span>

    //
    // Public methods used to help us manage CRLs
    //
    @Transient
    public X509CRL getCRL() {
<span class="nc" id="L208">        X509CRL crl = null;</span>
        try {
<span class="nc" id="L210">            String b64Crl = getBase64Crl();</span>
<span class="nc" id="L211">            crl = CertTools.getCRLfromByteArray(Base64.decode(b64Crl.getBytes()));</span>
<span class="nc" id="L212">        } catch (CRLException ce) {</span>
<span class="nc" id="L213">            log.error(&quot;Can't decode CRL.&quot;, ce);</span>
<span class="nc" id="L214">            return null;</span>
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">        return crl;</span>
    }

    public void setCRL(X509CRL incrl) {
        try {
<span class="nc" id="L221">            String b64Crl = new String(Base64.encode((incrl).getEncoded()));</span>
<span class="nc" id="L222">            setBase64Crl(b64Crl);</span>
<span class="nc" id="L223">        } catch (CRLException ce) {</span>
<span class="nc" id="L224">            log.error(&quot;Can't extract DER encoded CRL.&quot;, ce);</span>
<span class="nc" id="L225">        }</span>
<span class="nc" id="L226">    }</span>

    @Transient
    public byte[] getCRLBytes() {
<span class="nc" id="L230">        byte[] crl = null;</span>
<span class="nc" id="L231">        String b64Crl = getBase64Crl();</span>
<span class="nc" id="L232">        crl = Base64.decode(b64Crl.getBytes());</span>
<span class="nc" id="L233">        return crl;</span>
    }

    public void setIssuer(String dn) {
<span class="nc" id="L237">        setIssuerDN(CertTools.stringToBCDNString(dn));</span>
<span class="nc" id="L238">    }</span>

    public void setThisUpdate(Date thisUpdate) {
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (thisUpdate == null) {</span>
<span class="nc" id="L242">            setThisUpdate(-1L);</span>
        }
<span class="nc" id="L244">        setThisUpdate(thisUpdate.getTime());</span>
<span class="nc" id="L245">    }</span>

    public void setNextUpdate(Date nextUpdate) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (nextUpdate == null) {</span>
<span class="nc" id="L249">            setNextUpdate(-1L);</span>
        }
<span class="nc" id="L251">        setNextUpdate(nextUpdate.getTime());</span>
<span class="nc" id="L252">    }</span>

    //
    // Search functions.
    //

    /** @param entityManager EM
     * @param fingerprint FP
     * @return the found entity instance or null if the entity does not exist */
    public static CRLData findByFingerprint(EntityManager entityManager, String fingerprint) {
<span class="nc" id="L262">        return entityManager.find(CRLData.class, fingerprint);</span>
    }

    /**
     * @param entityManager EM
     * @param issuerDN DN
     * @param crlNumber CRL
     * @throws javax.persistence.NonUniqueResultException
     *             if more than one entity with the name exists
     * @return the found entity instance or null if the entity does not exist
     */
    public static CRLData findByIssuerDNAndCRLNumber(EntityManager entityManager, String issuerDN, int crlNumber) {
<span class="nc" id="L274">        final Query query = entityManager.createQuery(&quot;SELECT a FROM CRLData a WHERE a.issuerDN=:issuerDN AND a.crlNumber=:crlNumber&quot;);</span>
<span class="nc" id="L275">        query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L276">        query.setParameter(&quot;crlNumber&quot;, crlNumber);</span>
<span class="nc" id="L277">        return (CRLData) QueryResultWrapper.getSingleResult(query);</span>
    }
    
    /**
     * @param entityManager EM
     * @param issuerDN DN
     * @return the all list of CRLData for specified issuerDN
     */
    public static List&lt;CRLData&gt; findByIssuerDN(EntityManager entityManager, String issuerDN) {
<span class="nc" id="L286">        final Query query = entityManager.createQuery(&quot;SELECT a FROM CRLData a WHERE a.issuerDN=:issuerDN&quot;);</span>
<span class="nc" id="L287">        query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L289">        List&lt;CRLData&gt; resultList = query.getResultList();</span>
<span class="nc" id="L290">        return resultList;</span>
    }

    /**
     * @param entityManager EM
     * @param issuerDN DN
     * @param deltaCRL CRL
     * @return the highest CRL number or null if no CRL for the specified issuer exists.
     */
    public static Integer findHighestCRLNumber(EntityManager entityManager, String issuerDN, boolean deltaCRL) {
        Integer ret;
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (deltaCRL) {</span>
<span class="nc" id="L302">            final Query query = entityManager</span>
<span class="nc" id="L303">                    .createQuery(&quot;SELECT MAX(a.crlNumber) FROM CRLData a WHERE a.issuerDN=:issuerDN AND a.deltaCRLIndicator&gt;0&quot;);</span>
<span class="nc" id="L304">            query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L305">            ret = (Integer) QueryResultWrapper.getSingleResult(query);</span>
<span class="nc" id="L306">        } else {</span>
<span class="nc" id="L307">            final Query query = entityManager</span>
<span class="nc" id="L308">                    .createQuery(&quot;SELECT MAX(a.crlNumber) FROM CRLData a WHERE a.issuerDN=:issuerDN AND a.deltaCRLIndicator=-1&quot;);</span>
<span class="nc" id="L309">            query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L310">            ret = (Integer) QueryResultWrapper.getSingleResult(query);</span>
        }
<span class="nc" id="L312">        return ret;</span>
    }

    //
    // Start Database integrity protection methods
    //

    @Transient
    @Override
    protected String getProtectString(final int version) {
<span class="nc" id="L322">    	final ProtectionStringBuilder build = new ProtectionStringBuilder(3000);</span>
        // What is important to protect here is the data that we define
        // rowVersion is automatically updated by JPA, so it's not important, it is only used for optimistic locking
<span class="nc" id="L325">        build.append(getFingerprint()).append(getCrlNumber()).append(getDeltaCRLIndicator()).append(getIssuerDN()).append(getCaFingerprint())</span>
<span class="nc" id="L326">                .append(getThisUpdate()).append(getNextUpdate()).append(getBase64Crl());</span>
<span class="nc" id="L327">        return build.toString();</span>
    }

    @Transient
    @Override
    protected int getProtectVersion() {
<span class="nc" id="L333">        return 1;</span>
    }

    @PrePersist
    @PreUpdate
    @Override
    protected void protectData() {
<span class="nc" id="L340">        super.protectData();</span>
<span class="nc" id="L341">    }</span>

    @PostLoad
    @Override
    protected void verifyData() {
<span class="nc" id="L346">        super.verifyData();</span>
<span class="nc" id="L347">    }</span>

    @Override
    @Transient
    protected String getRowId() {
<span class="nc" id="L352">        return getFingerprint();</span>
    }
    //
    // End Database integrity protection methods
    //

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>