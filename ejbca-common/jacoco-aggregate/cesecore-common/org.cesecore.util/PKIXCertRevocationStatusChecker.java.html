<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PKIXCertRevocationStatusChecker.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-common</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.util</a> &gt; <span class="el_source">PKIXCertRevocationStatusChecker.java</span></div><h1>PKIXCertRevocationStatusChecker.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.util;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.math.BigInteger;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.SignatureException;
import java.security.cert.CRL;
import java.security.cert.CRLException;
import java.security.cert.CertPathValidatorException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.security.cert.PKIXCertPathChecker;
import java.security.cert.X509CRL;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashSet;
import java.util.Random;
import java.util.Set;

import org.apache.commons.io.IOUtils;
import org.apache.commons.io.output.NullOutputStream;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.ASN1InputStream;
import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.DEROctetString;
import org.bouncycastle.asn1.ocsp.OCSPObjectIdentifiers;
import org.bouncycastle.asn1.x509.Extension;
import org.bouncycastle.asn1.x509.Extensions;
import org.bouncycastle.cert.X509CertificateHolder;
import org.bouncycastle.cert.ocsp.BasicOCSPResp;
import org.bouncycastle.cert.ocsp.CertificateID;
import org.bouncycastle.cert.ocsp.CertificateStatus;
import org.bouncycastle.cert.ocsp.OCSPException;
import org.bouncycastle.cert.ocsp.OCSPReq;
import org.bouncycastle.cert.ocsp.OCSPReqBuilder;
import org.bouncycastle.cert.ocsp.OCSPResp;
import org.bouncycastle.cert.ocsp.OCSPRespBuilder;
import org.bouncycastle.cert.ocsp.SingleResp;
import org.bouncycastle.cert.ocsp.jcajce.JcaCertificateID;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.operator.jcajce.JcaContentVerifierProviderBuilder;
import org.cesecore.certificates.ocsp.SHA1DigestCalculator;

/**
 * A class to check whether a certificate is revoked or not using either OCSP or CRL. 
 * The revocation status will first be obtained using OCSP. If it turned out that that was not possible for 
 * some reason, a CRL will be used instead. If it was not possible to check the CRL for some reason, an 
 * exception will be thrown.
 * 
 * @version $Id: PKIXCertRevocationStatusChecker.java 24567 2016-10-25 05:36:17Z anatom $
 *
 */
public class PKIXCertRevocationStatusChecker extends PKIXCertPathChecker {

<span class="nc" id="L84">    private final Logger log = Logger.getLogger(PKIXCertRevocationStatusChecker.class);</span>

    
    private String ocspUrl;
    private String crlUrl;
    private X509Certificate issuerCert;
    private Collection&lt;X509Certificate&gt; caCerts;
    
<span class="nc" id="L92">    private SingleResp ocspResponse=null;</span>
<span class="nc" id="L93">    private CRL crl=null;</span>

    /**
     * With this constructor, the certificate revocation status will be checked using a CRL fetched using a URL 
     * extracted from the certificate's CRL Distribution Points extension.
     * 
     * @param issuerCert The certificate of the issuer of the certificate whose revocation status is to be checked. 
     * if 'null', the issuer certificate will be looked for among the certificates specified in 'cacerts'
     * @param cacerts A collection of certificates where one of them is the certificate of the issuer of the certificate 
     * whose status is to be checked. This parameter will be used only if 'issuerCert' is null

     */
<span class="nc" id="L105">    public PKIXCertRevocationStatusChecker(final X509Certificate issuerCert, final Collection &lt;X509Certificate&gt; cacerts) {</span>
<span class="nc" id="L106">        this.ocspUrl = null;</span>
<span class="nc" id="L107">        this.crlUrl = null;</span>
<span class="nc" id="L108">        this.issuerCert = issuerCert;</span>
<span class="nc" id="L109">        this.caCerts = cacerts;</span>
<span class="nc" id="L110">    }</span>
    
    /**
     * @param ocspurl The URL to use when sending an OCSP request. If 'null', the OCSP URL will be extracted from 
     * the certificate's AuthorityInformationAccess extension if it exists.
     * @param crlurl The URL to fetch the CRL from. If 'null', the CRL URL will be extracted from the certificate's 
     * CRLDistributionPoints extension if exists.
     * @param issuerCert The certificate of the issuer of the certificate whose revocation status is to be checked. 
     * if 'null', the issuer certificate will be looked for among the certificates specified in 'cacerts'
     * @param cacerts A collection of certificates where one of them is the certificate of the issuer of the certificate 
     * whose status is to be checked. This parameter will be used only if 'issuerCert' is null
     */
<span class="nc" id="L122">    public PKIXCertRevocationStatusChecker(final String ocspurl, final String crlurl, final X509Certificate issuerCert, final Collection &lt;X509Certificate&gt; cacerts) {</span>
<span class="nc" id="L123">        this.ocspUrl = ocspurl;</span>
<span class="nc" id="L124">        this.crlUrl = crlurl;</span>
<span class="nc" id="L125">        this.issuerCert = issuerCert;</span>
<span class="nc" id="L126">        this.caCerts = cacerts;</span>
<span class="nc" id="L127">    }</span>
    
    @Override
<span class="nc" id="L130">    public void init(boolean forward) throws CertPathValidatorException {}</span>

    @Override
    public boolean isForwardCheckingSupported() {
        // Not used
<span class="nc" id="L135">        return true;</span>
    }

    @Override
    public Set&lt;String&gt; getSupportedExtensions() {
<span class="nc" id="L140">        ArrayList&lt;String&gt; exts = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L141">        exts.add(Extension.cRLDistributionPoints.getId());</span>
<span class="nc" id="L142">        exts.add(Extension.authorityInfoAccess.getId());</span>
<span class="nc" id="L143">        return new HashSet&lt;String&gt;(exts);</span>
    }
    
    /**
     * @return The OCSP response containing the certificate status of the saught out certificate. Or 'null' if an OCSP response 
     * could not be obtained for any reason.
     */
    public SingleResp getOCSPResponse() {
<span class="nc" id="L151">        return this.ocspResponse;</span>
    }
    
    /**
     * @return The CRLs that were checked. Or an empty Collection if no CRLs were checked 
     */
    public CRL getcrl() {
<span class="nc" id="L158">        return this.crl;</span>
    }
    
    /**
     * Resets the OCSP response, the checked CRLs and whether the certificate was revoked in case the same instance of this class is 
     * used to check the revocation status of more that one certificate.
     */
    private void clearResult() {
<span class="nc" id="L166">        this.ocspResponse=null;</span>
<span class="nc" id="L167">        this.crl = null;</span>
<span class="nc" id="L168">    }</span>

    /**
     * Checks the revocation status of 'cert'; first by sending on OCSP request. If that fails for any reason, then through a CRL
     */
    @Override
    public void check(Certificate cert, Collection&lt;String&gt; unresolvedCritExts) throws CertPathValidatorException {
        
<span class="nc" id="L176">        clearResult();</span>
<span class="nc" id="L177">        Certificate cacert = getCaCert(cert);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if(cacert == null) {</span>
<span class="nc" id="L179">            final String msg = &quot;No issuer CA certificate was found. An issuer CA certificate is needed to create an OCSP request and to get the right CRL&quot;; </span>
<span class="nc" id="L180">            log.info(msg);</span>
<span class="nc" id="L181">            throw new CertPathValidatorException(msg);</span>
        }
        
<span class="nc" id="L184">        ArrayList&lt;String&gt; ocspurls = getOcspUrls(cert);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if(!ocspurls.isEmpty()) {</span>
<span class="nc" id="L186">            BigInteger certSerialnumber = CertTools.getSerialNumber(cert);</span>
<span class="nc" id="L187">            byte[] nonce = new byte[16];</span>
<span class="nc" id="L188">            final Random randomSource = new Random();</span>
<span class="nc" id="L189">            randomSource.nextBytes(nonce);</span>
<span class="nc" id="L190">            OCSPReq req = null;</span>
            try {
<span class="nc" id="L192">                req = getOcspRequest(cacert, certSerialnumber, nonce);</span>
<span class="nc" id="L193">            } catch (CertificateEncodingException | OCSPException e) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L195">                    log.debug(&quot;Failed to create OCSP request. &quot; + e.getLocalizedMessage());</span>
                }
<span class="nc" id="L197">                fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>
<span class="nc" id="L198">                return;</span>
                
<span class="nc" id="L200">            }</span>
            
<span class="nc" id="L202">            SingleResp ocspResp = null;</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            for(String url : ocspurls) {</span>
<span class="nc" id="L204">                ocspResp = getOCSPResponse(url, req, cert, nonce, OCSPRespBuilder.SUCCESSFUL, 200);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if(ocspResp != null) {</span>
<span class="nc" id="L206">                    log.info(&quot;Obtained OCSP response from &quot; + url);</span>
<span class="nc" id="L207">                    break;</span>
                } else {
<span class="nc bnc" id="L209" title="All 2 branches missed.">                    if(log.isDebugEnabled()) {</span>
<span class="nc" id="L210">                        log.debug(&quot;Failed to obtain an OCSP reponse from &quot; + url);</span>
                    }
                }
<span class="nc" id="L213">            }</span>
            
<span class="nc bnc" id="L215" title="All 2 branches missed.">            if(ocspResp==null) {</span>
<span class="nc" id="L216">                log.info(&quot;Failed to check certificate revocation status using OCSP. Falling back to check using CRL&quot;);</span>
<span class="nc" id="L217">                fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>
            } else {
<span class="nc" id="L219">                CertificateStatus status = ocspResp.getCertStatus();</span>
<span class="nc" id="L220">                this.ocspResponse = ocspResp;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    log.debug(&quot;The certificate status is: &quot; + (status==null? &quot;Good&quot; : status.toString()));</span>
                }
<span class="nc bnc" id="L224" title="All 2 branches missed.">                if(status != null) { // status==null -&gt; certificate OK</span>
<span class="nc" id="L225">                    throw new CertPathValidatorException(&quot;Certificate with serialnumber &quot; + CertTools.getSerialNumberAsString(cert) + &quot; was revoked&quot;);</span>
                }
                
<span class="nc bnc" id="L228" title="All 2 branches missed.">                if(unresolvedCritExts != null) {</span>
<span class="nc" id="L229">                    unresolvedCritExts.remove(Extension.authorityInfoAccess.getId());</span>
                }
            }

<span class="nc" id="L233">        } else {</span>
<span class="nc" id="L234">            fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>
            
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if(unresolvedCritExts != null) {</span>
<span class="nc" id="L237">                unresolvedCritExts.remove(Extension.cRLDistributionPoints.getId());</span>
            }
        }

<span class="nc" id="L241">    }</span>
    
    /**
     * Check the revocation status of 'cert' using a CRL
     * @param cert the certificate whose revocation status is to be checked
     * @param issuerDN DN
     * @throws CertPathValidatorException if invalid
     */
    private void fallBackToCrl(final Certificate cert, final String issuerDN) throws CertPathValidatorException {
<span class="nc" id="L250">        final ArrayList&lt;URL&gt; crlUrls = getCrlUrl(cert);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if(crlUrls.isEmpty()) {</span>
<span class="nc" id="L252">            final String errmsg = &quot;Failed to verify certificate status using the fallback CRL method. Could not find a CRL URL&quot;; </span>
<span class="nc" id="L253">            log.info(errmsg);</span>
<span class="nc" id="L254">            throw new CertPathValidatorException(errmsg);</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L257">            log.debug(&quot;Found &quot; + crlUrls.size() + &quot; CRL URLs&quot;);</span>
        }
        
<span class="nc" id="L260">        CRL crl = null;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        for(URL url : crlUrls) {</span>
<span class="nc" id="L262">            crl = getCRL(url);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if(crl != null) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if(isCorrectCRL(crl, issuerDN)) {</span>
<span class="nc" id="L265">                    final boolean isRevoked = crl.isRevoked(cert);</span>
<span class="nc" id="L266">                    this.crl = crl;</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    if(isRevoked) {</span>
<span class="nc" id="L268">                        throw new CertPathValidatorException(&quot;Certificate with serialnumber &quot; + CertTools.getSerialNumberAsString(cert) + &quot; was revoked&quot;);</span>
                    }
                    break;
                }
            }
<span class="nc" id="L273">        }</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if(this.crl==null) {</span>
<span class="nc" id="L275">            throw new CertPathValidatorException(&quot;Failed to verify certificate status using CRL. Could not find a CRL issued by &quot; + issuerDN + &quot; reasonably lately&quot;);</span>
        }
<span class="nc" id="L277">    }</span>
    
    private boolean isCorrectCRL(final CRL crl, final String issuerDN) {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if(!(crl instanceof X509CRL)) {</span>
<span class="nc" id="L281">            return false;</span>
        }
        
<span class="nc" id="L284">        X509CRL x509crl = (X509CRL) crl;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        if(!StringUtils.equals(issuerDN, CertTools.getIssuerDN(x509crl))) {</span>
<span class="nc" id="L286">            return false;</span>
        }
        
<span class="nc" id="L289">        final Date now = new Date(System.currentTimeMillis());</span>
<span class="nc" id="L290">        final Date nextUpdate = x509crl.getNextUpdate();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if(nextUpdate!=null) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if(nextUpdate.after(now)) {</span>
<span class="nc" id="L293">                return true;</span>
            }
            
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L297">                log.debug(&quot;CRL issued by &quot; + issuerDN + &quot; is out of date&quot;);</span>
            }
<span class="nc" id="L299">            return false;</span>
        }
        
<span class="nc" id="L302">        final Date thisUpdate = x509crl.getThisUpdate();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if(thisUpdate!=null) {</span>
<span class="nc" id="L304">            final GregorianCalendar gc = new GregorianCalendar();</span>
<span class="nc" id="L305">            gc.setTime(now);</span>
<span class="nc" id="L306">            gc.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L307">            final Date expire = gc.getTime();</span>
            
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if(expire.before(now)) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L311">                    log.debug(&quot;Could not find when CRL issued by &quot; + issuerDN + &quot; should be updated and this CRL is over one hour old. Not using it&quot;);</span>
                }
<span class="nc" id="L313">                return false;</span>
            }
            
<span class="nc" id="L316">            log.warn(&quot;Could not find when CRL issued by &quot; + issuerDN + &quot; should be updated, but this CRL was issued less than an hour ago, so we are using it&quot;);</span>
<span class="nc" id="L317">            return true;</span>
        }
            
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L321">            log.debug(&quot;Could not check issuance time for CRL issued by &quot; + issuerDN);</span>
        }
<span class="nc" id="L323">        return false;</span>
    }
    
    private CRL getCRL(final URL url) {
<span class="nc" id="L327">        CRL crl = null;</span>
        try {
<span class="nc" id="L329">            final URLConnection con = url.openConnection();</span>
<span class="nc" id="L330">            final InputStream is = con.getInputStream();</span>
<span class="nc" id="L331">            final CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="nc" id="L332">            crl = cf.generateCRL(is);</span>
<span class="nc" id="L333">            is.close();</span>
<span class="nc" id="L334">            log.info(&quot;Downloaded CRL from &quot; + url);</span>
<span class="nc" id="L335">        } catch(IOException | CertificateException | CRLException e) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L337">                log.debug(&quot;Fetching CRL from &quot; + url.toString() + &quot; failed. &quot; + e.getLocalizedMessage());</span>
            }
<span class="nc" id="L339">        }</span>
<span class="nc" id="L340">        return crl;</span>
    }
    
    /**
     * Construct an OCSP request
     * @param cacert The certificate of the issuer of the certificate to be checked
     * @param certSerialnumber the serialnumber of the certificate to be checked
     * @param nonce random nonce to be included in the OCSP request (OCSP POST)
     * @return OCSPReq
     * @throws CertificateEncodingException if cert is corrupt
     * @throws OCSPException if OCSP fails
     */
    private OCSPReq getOcspRequest(Certificate cacert, BigInteger certSerialnumber, final byte[] nonce) throws CertificateEncodingException, OCSPException {
<span class="nc" id="L353">        OCSPReqBuilder gen = new OCSPReqBuilder();</span>
<span class="nc" id="L354">        gen.addRequest(new JcaCertificateID(SHA1DigestCalculator.buildSha1Instance(), (X509Certificate) cacert, certSerialnumber));</span>
        
<span class="nc" id="L356">        Extension[] extensions = new Extension[1];</span>
<span class="nc" id="L357">        extensions[0] = new Extension(OCSPObjectIdentifiers.id_pkix_ocsp_nonce, false, new DEROctetString(nonce));</span>
<span class="nc" id="L358">        gen.setRequestExtensions(new Extensions(extensions));</span>

<span class="nc" id="L360">        return gen.build();</span>
    }

    
    
    /**
     * Sends an OCSP request, gets a response and verifies the response as much as possible before returning it to the caller.
     * @param ocspurl URL
     * @param ocspRequest Request 
     * @param cert Certificate
     * @param nonce Nonce
     * @param expectedOcspRespCode OCSP response 
     * @param expectedHttpRespCode HTTP response
     * 
     * @return The OCSP response, or null of no correct response could be obtained.
     */
    private SingleResp getOCSPResponse(final String ocspurl, final OCSPReq ocspRequest, final Certificate cert, final byte[] nonce, int expectedOcspRespCode, int expectedHttpRespCode) {
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L378">            log.debug(&quot;Sending OCSP request to &quot; + ocspurl + &quot; regarding certificate with SubjectDN: &quot; + CertTools.getSubjectDN(cert) </span>
<span class="nc" id="L379">                        + &quot; - IssuerDN: &quot; + CertTools.getIssuerDN(cert));</span>
        }
        
        //----------------------- Open connection and send the request --------------//
<span class="nc" id="L383">        OCSPResp response = null;</span>
<span class="nc" id="L384">        HttpURLConnection con = null;</span>
        try {
<span class="nc" id="L386">            final URL url = new URL(ocspurl);</span>
<span class="nc" id="L387">            con = (HttpURLConnection)url.openConnection();</span>
            // we are going to do a POST
<span class="nc" id="L389">            con.setDoOutput(true);</span>
<span class="nc" id="L390">            con.setRequestMethod(&quot;POST&quot;);</span>

            // POST it
<span class="nc" id="L393">            con.setRequestProperty(&quot;Content-Type&quot;, &quot;application/ocsp-request&quot;);</span>
<span class="nc" id="L394">            OutputStream os = con.getOutputStream();</span>
<span class="nc" id="L395">            os.write(ocspRequest.getEncoded());</span>
<span class="nc" id="L396">            os.close();</span>
        
        
<span class="nc" id="L399">            final int httpRespCode = ((HttpURLConnection)con).getResponseCode();</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (httpRespCode != expectedHttpRespCode) {</span>
<span class="nc" id="L401">                log.info(&quot;HTTP response from OCSP request was &quot; + httpRespCode + &quot;. Expected &quot; + expectedHttpRespCode );</span>
<span class="nc" id="L402">                handleContentOfErrorStream(con.getErrorStream());</span>
<span class="nc" id="L403">                return null; // if it is an http error code we don't need to test any more</span>
            }

<span class="nc" id="L406">            InputStream is = con.getInputStream();</span>
<span class="nc" id="L407">            response = new OCSPResp(IOUtils.toByteArray(is));</span>
<span class="nc" id="L408">            is.close();</span>
        
<span class="nc" id="L410">        } catch(IOException e) {</span>
<span class="nc" id="L411">            log.info(&quot;Unable to get an OCSP response. &quot; + e.getLocalizedMessage());</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">            if(con != null) {</span>
<span class="nc" id="L413">                handleContentOfErrorStream(con.getErrorStream());</span>
            }
<span class="nc" id="L415">            return null;</span>
<span class="nc" id="L416">        }</span>
        
        
        
        // ------------ Verify the response signature --------------//
<span class="nc" id="L421">        BasicOCSPResp brep = null;</span>
        try {
<span class="nc" id="L423">            brep = (BasicOCSPResp) response.getResponseObject();</span>

<span class="nc bnc" id="L425" title="All 4 branches missed.">            if ((expectedOcspRespCode != OCSPRespBuilder.SUCCESSFUL) &amp;&amp; (brep!=null)) {</span>
<span class="nc" id="L426">                log.warn(&quot;According to RFC 2560, responseBytes are not set on error, but we got some.&quot;);    </span>
<span class="nc" id="L427">                return null; // it messes up testing of invalid signatures... but is needed for the unsuccessful responses</span>
            }
        
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (brep==null) {</span>
<span class="nc" id="L431">                log.warn(&quot;Cannot extract OCSP response object. OCSP response status: &quot; + response.getStatus());</span>
<span class="nc" id="L432">                return null;</span>
            }
        
<span class="nc" id="L435">            X509CertificateHolder[] chain = brep.getCerts();</span>
<span class="nc" id="L436">            boolean verify = brep.isSignatureValid(new JcaContentVerifierProviderBuilder().setProvider(BouncyCastleProvider.PROVIDER_NAME).build(chain[0]));</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            if(!verify) {</span>
<span class="nc" id="L438">                log.warn(&quot;OCSP response signature was not valid&quot;);</span>
<span class="nc" id="L439">                return null;</span>
            }
<span class="nc" id="L441">        } catch (OCSPException | OperatorCreationException | CertificateException e) {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L443">                log.debug(&quot;Failed to obtain or verify OCSP response. &quot; + e.getLocalizedMessage());</span>
            }
<span class="nc" id="L445">            return null;</span>
<span class="nc" id="L446">        }</span>

        // ------------- Verify the nonce ---------------//
        byte[] noncerep;
        try {
<span class="nc" id="L451">            noncerep = brep.getExtension(OCSPObjectIdentifiers.id_pkix_ocsp_nonce).getExtnValue().getEncoded();</span>
<span class="nc" id="L452">        } catch (IOException e) {</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L454">                log.debug(&quot;Failed to read extension from OCSP response. &quot; + e.getLocalizedMessage());</span>
            }
<span class="nc" id="L456">            return null;</span>
<span class="nc" id="L457">        }</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if(noncerep == null) {</span>
<span class="nc" id="L459">            log.warn(&quot;Sent an OCSP request containing a nonce, but the OCSP response does not contain a nonce&quot;);</span>
<span class="nc" id="L460">            return null;</span>
        }
        
        try {
<span class="nc" id="L464">            ASN1InputStream ain = new ASN1InputStream(noncerep);</span>
<span class="nc" id="L465">            ASN1OctetString oct = ASN1OctetString.getInstance(ain.readObject());</span>
<span class="nc" id="L466">            ain.close();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">            if(!Arrays.equals(nonce, oct.getOctets())) {</span>
<span class="nc" id="L468">                log.warn(&quot;The nonce in the OCSP request and the OCSP response do not match&quot;);</span>
<span class="nc" id="L469">                return null;</span>
            }
<span class="nc" id="L471">        } catch (IOException e) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L473">                log.debug(&quot;Failed to read extension from OCSP response. &quot; + e.getLocalizedMessage());</span>
            }
<span class="nc" id="L475">            return null;</span>
<span class="nc" id="L476">        }</span>
        
        
        // ------------ Extract the single response and verify that it concerns a cert with the right serialnumber ----//
<span class="nc" id="L480">        SingleResp[] singleResps = brep.getResponses();</span>
<span class="nc bnc" id="L481" title="All 4 branches missed.">        if((singleResps==null) || (singleResps.length==0)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L483">                log.debug(&quot;The OCSP response object contained no responses.&quot;);</span>
            }
<span class="nc" id="L485">            return null;</span>
        }
        
<span class="nc" id="L488">        SingleResp singleResponse = singleResps[0];</span>
<span class="nc" id="L489">        CertificateID certId = singleResponse.getCertID();</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        if(!certId.getSerialNumber().equals(CertTools.getSerialNumber(cert))) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L492">                log.debug(&quot;Certificate serialnumber in response does not match certificate serialnumber in request.&quot;);</span>
            }
<span class="nc" id="L494">            return null;</span>
        }
        
        // ------------ Return the single response ---------------//
<span class="nc" id="L498">        return singleResponse;        </span>
    }
    
    /**
     * Reads the content of 'httpErrorStream' and ignores it. 
     * @param httpErrorStream stream
     */
    private void handleContentOfErrorStream(final InputStream httpErrorStream) {
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (httpErrorStream != null) {</span>
            try {
<span class="nc" id="L508">                OutputStream os = new NullOutputStream();</span>
<span class="nc" id="L509">                IOUtils.copy(httpErrorStream, os);</span>
<span class="nc" id="L510">                httpErrorStream.close();</span>
<span class="nc" id="L511">                os.close();</span>
<span class="nc" id="L512">            } catch(IOException ex) {}</span>
        }
<span class="nc" id="L514">    }</span>
    
    private ArrayList&lt;String&gt; getOcspUrls(Certificate cert) {
<span class="nc" id="L517">        ArrayList&lt;String&gt; urls = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if(StringUtils.isNotEmpty(this.ocspUrl)) {</span>
<span class="nc" id="L519">            urls.add(this.ocspUrl);</span>
        }
        
<span class="nc" id="L522">        urls.addAll(CertTools.getAuthorityInformationAccessOcspUrls((X509Certificate)cert));</span>
        
<span class="nc" id="L524">        return urls;</span>
    }
    
    private ArrayList&lt;URL&gt; getCrlUrl(final Certificate cert) {
        
<span class="nc" id="L529">        ArrayList&lt;URL&gt; urls = new ArrayList&lt;URL&gt;();</span>
        
<span class="nc bnc" id="L531" title="All 2 branches missed.">        if(StringUtils.isNotEmpty(this.crlUrl)) {</span>
            try {
<span class="nc" id="L533">                urls.add(new URL(this.crlUrl));</span>
<span class="nc" id="L534">            } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L536">                    log.debug(&quot;Failed to parse '&quot; + this.crlUrl + &quot;' as a URL. &quot; + e.getLocalizedMessage());</span>
                }
<span class="nc" id="L538">            }</span>
        }
        
<span class="nc" id="L541">        Collection&lt;URL&gt; crlUrlFromExtension = CertTools.getCrlDistributionPoints((X509Certificate)cert); </span>
<span class="nc" id="L542">        urls.addAll(crlUrlFromExtension);</span>
        
<span class="nc" id="L544">        return urls; </span>
    }
    
    private X509Certificate getCaCert(final Certificate targetCert) {
<span class="nc bnc" id="L548" title="All 2 branches missed.">        if(this.issuerCert != null) {</span>
<span class="nc" id="L549">            return issuerCert;</span>
        }
        
<span class="nc bnc" id="L552" title="All 2 branches missed.">        if(this.caCerts==null) { // no CA specified</span>
<span class="nc" id="L553">            return null;</span>
        }

<span class="nc bnc" id="L556" title="All 2 branches missed.">        for(final X509Certificate cacert : this.caCerts) {</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">            if(isIssuerCA(targetCert, cacert)) {</span>
<span class="nc" id="L558">                return cacert;</span>
            }
<span class="nc" id="L560">        }</span>
<span class="nc" id="L561">        return null;</span>
    }
    
    private boolean isIssuerCA(final Certificate cert, final Certificate cacert) {
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if(!StringUtils.equals(CertTools.getIssuerDN(cert), CertTools.getSubjectDN(cacert))) {</span>
<span class="nc" id="L566">            return false;</span>
        }
        try {
<span class="nc" id="L569">            cert.verify(cacert.getPublicKey());</span>
<span class="nc" id="L570">            return true;</span>
<span class="nc" id="L571">        } catch (InvalidKeyException | CertificateException | NoSuchAlgorithmException | NoSuchProviderException | SignatureException e) {</span>
<span class="nc" id="L572">            return false;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>