<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OcspSigningCacheEntry.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security Common Code</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.ocsp.cache</a> &gt; <span class="el_source">OcspSigningCacheEntry.java</span></div><h1>OcspSigningCacheEntry.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.ocsp.cache;

import java.security.PrivateKey;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.List;
import org.apache.log4j.Logger;
import org.bouncycastle.cert.ocsp.CertificateID;
import org.bouncycastle.cert.ocsp.OCSPException;
import org.bouncycastle.cert.ocsp.RespID;
import org.bouncycastle.cert.ocsp.jcajce.JcaRespID;
import org.cesecore.certificates.certificate.CertificateStatus;
import org.cesecore.certificates.ocsp.SHA1DigestCalculator;
import org.cesecore.config.OcspConfiguration;
import org.cesecore.keybind.impl.OcspKeyBinding;
import org.cesecore.util.CertTools;

/**
 * Hold information needed for creating an OCSP response without database
 * lookups.
 *
 * @version $Id: OcspSigningCacheEntry.java 28643 2018-04-06 08:53:57Z samuellb
 *     $
 */
public class OcspSigningCacheEntry {

    /** Logger. */
<span class="nc" id="L40">  private static final Logger LOG =</span>
<span class="nc" id="L41">      Logger.getLogger(OcspSigningCacheEntry.class);</span>

  /** ID. */
  private final List&lt;CertificateID&gt; certificateID;
  /** Chain. */
  private final List&lt;X509Certificate&gt; caCertificateChain;
  /** Cert. */
  private final X509Certificate ocspSigningCertificate;
  /** Chain. */
  private final List&lt;X509Certificate&gt; fullCertificateChain;
  /** Vert. */
  private final X509Certificate signingCertificate;
  /** DN. */
  private final String signingCertificateIssuerDn;
  /** Issuer. */
  private final String signingCertificateIssuerDnRaw;
  /** Key. */
  private final transient PrivateKey privateKey;
  /** Provider. */
  private final String signatureProviderName;
  /** Binding. */
  private final OcspKeyBinding ocspKeyBinding;
  /** CA cert. */
  private final X509Certificate issuerCaCertificate;
  /** Status. */
  private final CertificateStatus issuerCaCertificateStatus;
  /** Verified. */
<span class="nc" id="L68">  private boolean responseSignatureVerified = false;</span>
  /** Type. */
  private final OcspKeyBinding.ResponderIdType responderIdType;
  /** ID. */
  private RespID respId;
  /** Chain. */
  private final X509Certificate[] responseCertChain;
  /** Cert. */
  private final boolean signingCertificateForOcspSigning;

  /**
   * @param aIssuerCaCertificate Cert
   * @param aIssuerCaCertificateStatus Status
   * @param signingCaCertificateChain Chain
   * @param aOcspSigningCertificate Cert
   * @param aPrivateKey Key
   * @param aSignatureProviderName Provider
   * @param aOcspKeyBinding Binding
   * @param aResponderIdType Type
   */
  public OcspSigningCacheEntry(
      final X509Certificate aIssuerCaCertificate,
      final CertificateStatus aIssuerCaCertificateStatus,
      final List&lt;X509Certificate&gt; signingCaCertificateChain,
      final X509Certificate aOcspSigningCertificate,
      final PrivateKey aPrivateKey,
      final String aSignatureProviderName,
      final OcspKeyBinding aOcspKeyBinding,
<span class="nc" id="L96">      final OcspKeyBinding.ResponderIdType aResponderIdType) {</span>
<span class="nc" id="L97">    this.caCertificateChain = signingCaCertificateChain;</span>
<span class="nc" id="L98">    this.ocspSigningCertificate = aOcspSigningCertificate;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">    if (aOcspSigningCertificate == null) {</span>
      // We will sign with a CA key
<span class="nc" id="L101">      fullCertificateChain = signingCaCertificateChain;</span>
    } else {
      // We will sign with an OCSP Key Binding
<span class="nc" id="L104">      fullCertificateChain = new ArrayList&lt;X509Certificate&gt;();</span>
<span class="nc" id="L105">      fullCertificateChain.add(aOcspSigningCertificate);</span>
<span class="nc" id="L106">      fullCertificateChain.addAll(signingCaCertificateChain);</span>
    }
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (fullCertificateChain == null) {</span>
      // This is just a placeholder cache entry
<span class="nc" id="L110">      signingCertificate = null;</span>
    } else {
      // Get the certificate that corresponds to the private key
<span class="nc" id="L113">      signingCertificate = fullCertificateChain.get(0);</span>
    }
<span class="nc" id="L115">    this.privateKey = aPrivateKey;</span>
<span class="nc" id="L116">    this.signatureProviderName = aSignatureProviderName;</span>
<span class="nc" id="L117">    this.ocspKeyBinding = aOcspKeyBinding;</span>
<span class="nc" id="L118">    this.issuerCaCertificate = aIssuerCaCertificate;</span>
<span class="nc" id="L119">    this.certificateID =</span>
<span class="nc" id="L120">        OcspSigningCache.getCertificateIDFromCertificate(aIssuerCaCertificate);</span>
<span class="nc" id="L121">    this.issuerCaCertificateStatus = aIssuerCaCertificateStatus;</span>
<span class="nc" id="L122">    this.responderIdType = aResponderIdType;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    if (signingCertificate == null) {</span>
      // This is just a placeholder cache entry
<span class="nc" id="L125">      respId = null;</span>
<span class="nc" id="L126">      signingCertificateForOcspSigning = true;</span>
<span class="nc" id="L127">      signingCertificateIssuerDn = null;</span>
<span class="nc" id="L128">      signingCertificateIssuerDnRaw = null;</span>
    } else {
      // Pre-calculate the Responder ID
<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (OcspKeyBinding.ResponderIdType.NAME.equals(aResponderIdType)) {</span>
<span class="nc" id="L132">        respId = new JcaRespID(signingCertificate.getSubjectX500Principal());</span>
      } else {
        try {
<span class="nc" id="L135">          respId =</span>
              new JcaRespID(
<span class="nc" id="L137">                  signingCertificate.getPublicKey(),</span>
<span class="nc" id="L138">                  SHA1DigestCalculator.buildSha1Instance());</span>
<span class="nc" id="L139">        } catch (OCSPException e) {</span>
<span class="nc" id="L140">          LOG.warn(</span>
              &quot;Unable to contruct responder Id of type 'hash', falling back to&quot;
                  + &quot; using 'name' as responder Id.&quot;,
              e);
<span class="nc" id="L144">          respId = new JcaRespID(signingCertificate.getSubjectX500Principal());</span>
<span class="nc" id="L145">        }</span>
      }
<span class="nc bnc" id="L147" title="All 2 branches missed.">      if (aOcspSigningCertificate == null) {</span>
<span class="nc" id="L148">        signingCertificateForOcspSigning = true; // CA cert</span>
      } else {
<span class="nc" id="L150">        signingCertificateForOcspSigning =</span>
<span class="nc" id="L151">            CertTools.isOCSPCert(signingCertificate);</span>
      }
<span class="nc" id="L153">      signingCertificateIssuerDn = CertTools.getIssuerDN(signingCertificate);</span>
<span class="nc" id="L154">      signingCertificateIssuerDnRaw =</span>
<span class="nc" id="L155">          signingCertificate.getIssuerDN().getName();</span>
    }
<span class="nc bnc" id="L157" title="All 2 branches missed.">    if (fullCertificateChain == null) {</span>
<span class="nc" id="L158">      responseCertChain = null;</span>
    } else {
<span class="nc" id="L160">      responseCertChain =</span>
<span class="nc" id="L161">          getResponseCertChain(</span>
<span class="nc" id="L162">              fullCertificateChain.toArray(new X509Certificate[0]));</span>
    }
<span class="nc" id="L164">  }</span>

  /** @return certificate of the CA that we want to respond for */
  public X509Certificate getIssuerCaCertificate() {
<span class="nc" id="L168">    return issuerCaCertificate;</span>
  }

  /** @return certificate ID of the CA that we want to respond for */
  public List&lt;CertificateID&gt; getCertificateID() {
<span class="nc" id="L173">    return certificateID;</span>
  }

  /**
   * @return the certificate revocation status for the CA that we want to
   *     respond for at the time of cache reload
   */
  public CertificateStatus getIssuerCaCertificateStatus() {
<span class="nc" id="L181">    return issuerCaCertificateStatus;</span>
  }

  /** @return the chain of all CA certificates */
  public List&lt;X509Certificate&gt; getCaCertificateChain() {
<span class="nc" id="L186">    return caCertificateChain;</span>
  }

  /**
   * @return a OCSP signing certificate or null if this cache entry will use a
   *     CA key to sign the response
   */
  public X509Certificate getOcspSigningCertificate() {
<span class="nc" id="L194">    return ocspSigningCertificate;</span>
  }

  /**
   * @return the full certificate chain that will be used to sign the OCSP
   *     response. The first position is either an OCSP signing certificate or a
   *     CA certificate.
   */
  public List&lt;X509Certificate&gt; getFullCertificateChain() {
<span class="nc" id="L203">    return fullCertificateChain;</span>
  }

  /**
   * @return the certificate that will be used to sign the OCSP response. This
   *     is either an OCSP signing certificate or a CA certificate.
   */
  public X509Certificate getSigningCertificate() {
<span class="nc" id="L211">    return signingCertificate;</span>
  }

  /**
   * @return the Issuer DN of the certificate that will be used to sign the OCSP
   *     response. BC normalized.
   */
  public String getSigningCertificateIssuerDn() {
<span class="nc" id="L219">    return signingCertificateIssuerDn;</span>
  }

  /**
   * @return the Issuer DN of the certificate that will be used to sign the OCSP
   *     response. Not normalized.
   */
  public String getSigningCertificateIssuerDnRaw() {
<span class="nc" id="L227">    return signingCertificateIssuerDnRaw;</span>
  }

  /** @return the private key that will be used to sign the OCSP response. */
  public PrivateKey getPrivateKey() {
<span class="nc" id="L232">    return privateKey;</span>
  }

  /**
   * @return the signature provider that should be used with this cache entries
   *     private key.
   */
  public String getSignatureProviderName() {
<span class="nc" id="L240">    return signatureProviderName;</span>
  }

  /**
   * @return the OCSP key binding mapped by this entry or null if the private
   *     key belongs to a CA.
   */
  public OcspKeyBinding getOcspKeyBinding() {
<span class="nc" id="L248">    return ocspKeyBinding;</span>
  }

  /**
   * @return one of the OcspConfiguration.RESPONDERIDTYPE_* values used by this
   *     cache entry
   */
  public OcspKeyBinding.ResponderIdType getResponderIdType() {
<span class="nc" id="L256">    return responderIdType;</span>
  }

  /** @return the actual responder type ASN1 object used by this cache entry */
  public RespID getRespId() {
<span class="nc" id="L261">    return respId;</span>
  }

  /**
   * @return the part of the full certificate chain that has been configured to
   *     be included in the response.
   */
  public X509Certificate[] getResponseCertChain() {
<span class="nc" id="L269">    return responseCertChain;</span>
  }
  /**
   * Checks if the entry has a OCSP signing certificate separate from the
   * certificate chain. Only entries with a keybinding can have a separate
   * certificate.
   *
   * @return boolean
   */
  public boolean isUsingSeparateOcspSigningCertificate() {
<span class="nc bnc" id="L279" title="All 2 branches missed.">    return ocspSigningCertificate != null;</span>
  }

  /**
   * @return false when we are using a non-CA signing certificate and the
   *     certificate lacks the OCSP signing EKU
   */
  public boolean isSigningCertificateForOcspSigning() {
<span class="nc" id="L287">    return signingCertificateForOcspSigning;</span>
  }

  /**
   * @return true if this entry is just a temporary placeholder that should be
   *     replaced with the default responder when rebuilding the cache.
   */
  public boolean isPlaceholder() {
<span class="nc bnc" id="L295" title="All 2 branches missed.">    return privateKey == null;</span>
  }

  /**
   * @return false for the first thread that invokes this method (a caller that
   *     gets a false return value should verify the response signature)
   */
  public boolean checkResponseSignatureVerified() {
    // There is a small race condition here, so multiple callers might get a
    // &quot;false&quot; return value, but since this
    // is a hot-path we don't want the overhead of synchronization for a large
    // majority of the invocations
<span class="nc bnc" id="L307" title="All 2 branches missed.">    if (responseSignatureVerified) {</span>
<span class="nc" id="L308">      return true;</span>
    }
<span class="nc" id="L310">    responseSignatureVerified = true;</span>
<span class="nc" id="L311">    return false;</span>
  }

  /**
   * This method construct the certificate chain that will be included in the
   * OCSP response according to the following rules: - If includeSignCert &amp;&amp;
   * includeChain --&gt; include entire chain except for the root CA certificate -
   * If includeSignCert &amp;&amp; !includeChain --&gt; include only the signing
   * certificate whatever it is (even if it was a root CA cert) - If
   * !includingSignCert --&gt; not including any certificate or chain no matter
   * what value includeChain has. The value of the certificate chain will then
   * be an empty array.
   *
   * @param certChain certificate chain
   * @return the certificate chain that will be included in the OCSP response
   */
  private X509Certificate[] getResponseCertChain(
          final X509Certificate[] certChain) {
    X509Certificate[] chain;
<span class="nc" id="L330">    boolean includeSignCert = OcspConfiguration.getIncludeSignCert();</span>
<span class="nc" id="L331">    boolean includeChain = OcspConfiguration.getIncludeCertChain();</span>
    // If we have an OcspKeyBinding we use this configuration to override the
    // default
<span class="nc bnc" id="L334" title="All 2 branches missed.">    if (isUsingSeparateOcspSigningCertificate()) {</span>
<span class="nc" id="L335">      includeSignCert = getOcspKeyBinding().getIncludeSignCert();</span>
<span class="nc" id="L336">      includeChain = getOcspKeyBinding().getIncludeCertChain();</span>
    }
<span class="nc bnc" id="L338" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L339">      LOG.debug(&quot;Include signing cert: &quot; + includeSignCert);</span>
<span class="nc" id="L340">      LOG.debug(&quot;Include chain: &quot; + includeChain);</span>
    }
<span class="nc bnc" id="L342" title="All 2 branches missed.">    if (includeSignCert) {</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">      if (includeChain) {</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (certChain.length</span>
            &gt; 1) { // certChain contained more than the root cert
          // create a new array containing all the certs in certChain except for
          // the root cert
<span class="nc" id="L348">          chain = new X509Certificate[certChain.length - 1];</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">          for (int i = 0; i &lt; chain.length; i++) {</span>
<span class="nc" id="L350">            chain[i] = certChain[i];</span>
          }
        } else { // certChain contains only the root cert
<span class="nc" id="L353">          chain = certChain;</span>
        }
      } else { // only the signing cert should be included in the OCSP response
               // and not the entire cert chain
<span class="nc" id="L357">        chain = new X509Certificate[1];</span>
<span class="nc" id="L358">        chain[0] = certChain[0];</span>
      }
    } else {
<span class="nc bnc" id="L361" title="All 2 branches missed.">      if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L362">        LOG.debug(&quot;OCSP signing certificate is not included in the response&quot;);</span>
      }
<span class="nc" id="L364">      chain = new X509Certificate[0];</span>
    }
<span class="nc" id="L366">    return chain;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>