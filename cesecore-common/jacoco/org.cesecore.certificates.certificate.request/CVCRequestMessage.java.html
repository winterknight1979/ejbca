<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CVCRequestMessage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security Common Code</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate.request</a> &gt; <span class="el_source">CVCRequestMessage.java</span></div><h1>CVCRequestMessage.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate.request;

import java.math.BigInteger;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.SignatureException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.asn1.x509.Extensions;
import org.bouncycastle.cms.CMSSignedGenerator;
import org.cesecore.util.CertTools;
import org.ejbca.cvc.CVCAuthenticatedRequest;
import org.ejbca.cvc.CVCObject;
import org.ejbca.cvc.CVCertificate;
import org.ejbca.cvc.CardVerifiableCertificate;
import org.ejbca.cvc.CertificateParser;
import org.ejbca.cvc.HolderReferenceField;
import org.ejbca.cvc.exception.ConstructionException;
import org.ejbca.cvc.exception.ParseException;

/**
 * Class to handle CVC request messages sent to the CA.
 *
 * @version $Id: CVCRequestMessage.java 28201 2018-02-07 08:33:29Z andresjakobs
 *     $
 */
public class CVCRequestMessage implements RequestMessage {
  /**
   * Determines if a de-serialized file is compatible with this class.
   *
   * &lt;p&gt;Maintainers must change this value if and only if the new version of
   * this class is not compatible with old versions. See Sun docs for &lt;a
   * href=http://java.sun.com/products/jdk/1.1/docs/guide
   * /serialization/spec/version.doc.html&gt; details. &lt;/a&gt;
   */
  static final long serialVersionUID = 1L;

  /** Logger. */
<span class="nc" id="L59">  private static final Logger LOG = Logger.getLogger(CVCRequestMessage.class);</span>

  /** Raw form of the CVC message. */
  protected byte[] cvcmsg;

  /** manually set password. */
<span class="nc" id="L65">  protected String password = null;</span>

  /** manually set username. */
<span class="nc" id="L68">  protected String username = null;</span>

  /** The cvc request message, not serialized. */
<span class="nc" id="L71">  protected transient CVCertificate cvcert = null;</span>

  /** Extra certificates. */
<span class="nc" id="L74">  private List&lt;Certificate&gt; additionalCaCertificates =</span>
      new ArrayList&lt;Certificate&gt;();

  /** Extra certificates. */
<span class="nc" id="L78">  private List&lt;Certificate&gt; additionalExtraCertsCertificates =</span>
      new ArrayList&lt;Certificate&gt;();

  /** Constructs a new empty message handler object. */
<span class="nc" id="L82">  public CVCRequestMessage() {</span>
    // No constructor
<span class="nc" id="L84">  }</span>

  /**
   * Constructs a new message handler object.
   *
   * @param msg The DER encoded request.
   */
<span class="nc" id="L91">  public CVCRequestMessage(final byte[] msg) {</span>
<span class="nc" id="L92">    this.cvcmsg = msg;</span>
<span class="nc" id="L93">    init();</span>
<span class="nc" id="L94">  }</span>

  private void init() {
    try {
      CVCObject parsedObject;
<span class="nc" id="L99">      parsedObject = CertificateParser.parseCVCObject(cvcmsg);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (parsedObject instanceof CVCertificate) {</span>
<span class="nc" id="L101">        cvcert = (CVCertificate) parsedObject;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">      } else if (parsedObject instanceof CVCAuthenticatedRequest) {</span>
<span class="nc" id="L103">        CVCAuthenticatedRequest authreq =</span>
            (CVCAuthenticatedRequest) parsedObject;
<span class="nc" id="L105">        cvcert = authreq.getRequest();</span>
      }
<span class="nc" id="L107">    } catch (ParseException e) {</span>
<span class="nc" id="L108">      LOG.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L109">      throw new IllegalArgumentException(e);</span>
<span class="nc" id="L110">    } catch (ConstructionException e) {</span>
<span class="nc" id="L111">      LOG.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L112">      throw new IllegalArgumentException(e);</span>
<span class="nc" id="L113">    } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L114">      LOG.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L115">      throw new IllegalArgumentException(e);</span>
<span class="nc" id="L116">    }</span>
<span class="nc" id="L117">  }</span>

  @Override
  public PublicKey getRequestPublicKey()
      throws InvalidKeyException, NoSuchAlgorithmException,
          NoSuchProviderException {
    try {
<span class="nc bnc" id="L124" title="All 2 branches missed.">      if (cvcert == null) {</span>
<span class="nc" id="L125">        init();</span>
      }
<span class="nc" id="L127">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L128">      LOG.error(&quot;CVC not inited!&quot;);</span>
<span class="nc" id="L129">      return null;</span>
<span class="nc" id="L130">    }</span>

    PublicKey pk;
    try {
<span class="nc" id="L134">      pk = cvcert.getCertificateBody().getPublicKey();</span>
<span class="nc" id="L135">    } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L136">      throw new InvalidKeyException(e);</span>
<span class="nc" id="L137">    }</span>
<span class="nc" id="L138">    return pk;</span>
  }

  /**
   * force a password.
   *
   * @param pwd password
   */
  public void setPassword(final String pwd) {
<span class="nc" id="L147">    this.password = pwd;</span>
<span class="nc" id="L148">  }</span>

  @Override
  public String getPassword() {
<span class="nc" id="L152">    return password;</span>
  }

  /**
   * force a username, i.e. ignore the DN/username in the request
   *
   * @param aUsername username
   */
  public void setUsername(final String aUsername) {
<span class="nc" id="L161">    this.username = aUsername;</span>
<span class="nc" id="L162">  }</span>

  @Override
  public String getUsername() {
<span class="nc bnc" id="L166" title="All 2 branches missed.">    if (username != null) {</span>
<span class="nc" id="L167">      return username;</span>
    }
<span class="nc" id="L169">    String subject = null;</span>
    try {
<span class="nc" id="L171">      HolderReferenceField hr =</span>
<span class="nc" id="L172">          cvcert.getCertificateBody().getHolderReference();</span>
<span class="nc" id="L173">      subject = hr.getMnemonic() + hr.getCountry();</span>
<span class="nc" id="L174">    } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L175">      LOG.error(e);</span>
<span class="nc" id="L176">    }</span>
<span class="nc" id="L177">    return subject;</span>
  }

  @Override
  public String getIssuerDN() {
<span class="nc" id="L182">    CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L183">    return CertTools.getIssuerDN(cc);</span>
  }

  /**
   * Could get the sequence (of CVC cert). For CVC certificate this does not
   * combine well with getIssuerDN to identify the CA-certificate of the CA the
   * request is targeted for, so it always return null.
   *
   * @return null.
   */
  @Override
  public BigInteger getSerialNo() {
    // CardVerifiableCertificate cc = getCardVerifiableCertificate()
    // return CertTools.getSerialNumber(cc);
<span class="nc" id="L197">    return null;</span>
  }

  @Override
  public String getCRLIssuerDN() {
<span class="nc" id="L202">    return null;</span>
  }

  @Override
  public BigInteger getCRLSerialNo() {
<span class="nc" id="L207">    return null;</span>
  }

  @Override
  public String getRequestDN() {
<span class="nc" id="L212">    CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L213">    return CertTools.getSubjectDN(cc);</span>
  }

  @Override
  public X500Name getRequestX500Name() {
<span class="nc" id="L218">    String dn = getRequestDN();</span>
<span class="nc" id="L219">    return new X500Name(dn);</span>
  }

  @Override
  public String getRequestAltNames() {
<span class="nc" id="L224">    return null;</span>
  }

  @Override
  public Date getRequestValidityNotBefore() {
<span class="nc" id="L229">    CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L230">    return CertTools.getNotBefore(cc);</span>
  }

  @Override
  public Date getRequestValidityNotAfter() {
<span class="nc" id="L235">    CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L236">    return CertTools.getNotAfter(cc);</span>
  }

  @Override
  public Extensions getRequestExtensions() {
<span class="nc" id="L241">    return null;</span>
  }

  @Override
  public boolean verify()
      throws InvalidKeyException, NoSuchAlgorithmException,
          NoSuchProviderException {
<span class="nc" id="L248">    return verify(null);</span>
  }

  private boolean verify(final PublicKey pubKey)
      throws InvalidKeyException, NoSuchAlgorithmException,
          NoSuchProviderException {
<span class="nc" id="L254">    LOG.trace(&quot;&gt;verify()&quot;);</span>

<span class="nc" id="L256">    boolean ret = false;</span>

    try {
<span class="nc" id="L259">      CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">      if (cc != null) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (pubKey == null) {</span>
<span class="nc" id="L262">          cc.verify(cvcert.getCertificateBody().getPublicKey());</span>
<span class="nc" id="L263">          ret = true; // If we came here verification was successful</span>
        } else {
<span class="nc" id="L265">          cc.verify(pubKey);</span>
<span class="nc" id="L266">          ret = true; // If we came here verification was successful</span>
        }
      }
<span class="nc" id="L269">    } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L270">      LOG.error(&quot;CVC error!&quot;, e);</span>
<span class="nc" id="L271">    } catch (InvalidKeyException e) {</span>
<span class="nc" id="L272">      LOG.error(&quot;Error in CVC-request:&quot;, e);</span>
<span class="nc" id="L273">      throw e;</span>
<span class="nc" id="L274">    } catch (CertificateException e) {</span>
<span class="nc" id="L275">      LOG.error(&quot;Error in CVC-signature:&quot;, e);</span>
<span class="nc" id="L276">    } catch (SignatureException e) {</span>
<span class="nc" id="L277">      LOG.error(&quot;Error in CVC-signature:&quot;, e);</span>
<span class="nc" id="L278">    }</span>

<span class="nc" id="L280">    LOG.trace(&quot;&lt;verify()&quot;);</span>

<span class="nc" id="L282">    return ret;</span>
  }

  @Override
  public boolean requireKeyInfo() {
<span class="nc" id="L287">    return false;</span>
  }

  @Override
  public void setKeyInfo(final Certificate cert,
          final PrivateKey key, final String provider) {
      // NO-OP
<span class="nc" id="L294">  }</span>

  @Override
  public int getErrorNo() {
<span class="nc" id="L298">    return 0;</span>
  }

  @Override
  public String getErrorText() {
<span class="nc" id="L303">    return &quot;&quot;;</span>
  }

  @Override
  public String getSenderNonce() {
<span class="nc" id="L308">    return null;</span>
  }

  @Override
  public String getTransactionId() {
<span class="nc" id="L313">    return null;</span>
  }

  @Override
  public byte[] getRequestKeyInfo() {
<span class="nc" id="L318">    byte[] ret = null;</span>
    try {
<span class="nc" id="L320">      String seq =</span>
<span class="nc" id="L321">          cvcert.getCertificateBody().getHolderReference().getSequence();</span>
<span class="nc" id="L322">      ret = seq.getBytes();</span>
<span class="nc" id="L323">    } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L324">      LOG.error(&quot;CVC error!&quot;, e);</span>
<span class="nc" id="L325">    }</span>
<span class="nc" id="L326">    return ret;</span>
  }

  @Override
  public String getPreferredDigestAlg() {
    // Not used
<span class="nc" id="L332">    return CMSSignedGenerator.DIGEST_SHA256;</span>
  }

  @Override
  public boolean includeCACert() {
<span class="nc" id="L337">    return false;</span>
  }

  @Override
  public int getRequestType() {
<span class="nc" id="L342">    return 0;</span>
  }

  @Override
  public int getRequestId() {
<span class="nc" id="L347">    return 0;</span>
  }

  @Override
  public void setResponseKeyInfo(final PrivateKey key, final String provider) {
    // NOOP
<span class="nc" id="L353">  }</span>

  @Override
  public List&lt;Certificate&gt; getAdditionalCaCertificates() {
<span class="nc" id="L357">    return additionalCaCertificates;</span>
  }

  @Override
  public void setAdditionalCaCertificates(
      final List&lt;Certificate&gt; certificates) {
<span class="nc" id="L363">    this.additionalCaCertificates = certificates;</span>
<span class="nc" id="L364">  }</span>

  @Override
  public List&lt;Certificate&gt; getAdditionalExtraCertsCertificates() {
<span class="nc" id="L368">    return additionalExtraCertsCertificates;</span>
  }

  @Override
  public void setAdditionalExtraCertsCertificates(
      final List&lt;Certificate&gt; aAdditionalExtraCertsCertificates) {
<span class="nc" id="L374">    this.additionalExtraCertsCertificates = aAdditionalExtraCertsCertificates;</span>
<span class="nc" id="L375">  }</span>

  /**
   * Specific to CVC request messages, EAC requests contains a sequence.
   *
   * @return sequence
   */
  public String getKeySequence() {
<span class="nc" id="L383">    String ret = null;</span>
    try {
<span class="nc bnc" id="L385" title="All 2 branches missed.">      if (cvcert.getCertificateBody().getHolderReference() != null) {</span>
<span class="nc" id="L386">        ret = cvcert.getCertificateBody().getHolderReference().getSequence();</span>
      }
<span class="nc" id="L388">    } catch (NoSuchFieldException e) {</span>
      // No sequence found...
<span class="nc" id="L390">    }</span>
<span class="nc" id="L391">    return ret;</span>
  }

  private CardVerifiableCertificate getCardVerifiableCertificate() {
    try {
<span class="nc bnc" id="L396" title="All 2 branches missed.">      if (cvcert == null) {</span>
<span class="nc" id="L397">        init();</span>
      }
<span class="nc" id="L399">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L400">      LOG.error(&quot;CVC not inited!&quot;, e);</span>
<span class="nc" id="L401">      return null;</span>
<span class="nc" id="L402">    }</span>
<span class="nc" id="L403">    CardVerifiableCertificate cc = new CardVerifiableCertificate(cvcert);</span>
<span class="nc" id="L404">    return cc;</span>
  }
} // PKCS10RequestMessage
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>