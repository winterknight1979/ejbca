<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OcspKeyBinding.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security Common Code</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.keybind.impl</a> &gt; <span class="el_source">OcspKeyBinding.java</span></div><h1>OcspKeyBinding.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.keybind.impl;

import java.security.cert.Certificate;
import java.security.cert.CertificateParsingException;
import java.security.cert.X509Certificate;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

import org.apache.log4j.Logger;
import org.bouncycastle.asn1.x509.KeyPurposeId;
import org.cesecore.config.AvailableExtendedKeyUsagesConfiguration;
import org.cesecore.keybind.CertificateImportException;
import org.cesecore.keybind.InternalKeyBindingBase;
import org.cesecore.util.CertTools;
import org.cesecore.util.ui.DynamicUiProperty;

/**
 * Holder of &quot;external&quot; (e.g. non-CA signing key) OCSP InternalKeyBinding properties.
 * 
 * @version $Id: OcspKeyBinding.java 25867 2017-05-17 16:18:06Z mikekushner $
 */
<span class="fc" id="L35">public class OcspKeyBinding extends InternalKeyBindingBase {</span>
  
    private static final long serialVersionUID = 1L;
<span class="fc" id="L38">    private static final Logger log = Logger.getLogger(OcspKeyBinding.class);</span>
    
<span class="fc" id="L40">    public enum ResponderIdType {</span>
<span class="fc" id="L41">        KEYHASH(2, &quot;KeyHash&quot;), NAME(1, &quot;Name&quot;);</span>
        
        private final int numericValue;
        private final String label;
        private static Map&lt;Integer, ResponderIdType&gt; numericValueLookupMap;
        
        static {
<span class="fc" id="L48">            numericValueLookupMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L49" title="All 2 branches covered.">            for(ResponderIdType responderIdType : ResponderIdType.values()) {</span>
<span class="fc" id="L50">                numericValueLookupMap.put(responderIdType.getNumericValue(), responderIdType);</span>
            }
<span class="fc" id="L52">        }</span>
        
<span class="fc" id="L54">        private ResponderIdType(int numericValue, String label) {</span>
<span class="fc" id="L55">            this.numericValue = numericValue;</span>
<span class="fc" id="L56">            this.label = label;</span>
<span class="fc" id="L57">        }</span>
        
        public int getNumericValue() {
<span class="fc" id="L60">            return numericValue;</span>
        }
        
        public String getLabel() {
<span class="nc" id="L64">            return label;</span>
        }
        
        public static ResponderIdType getFromNumericValue(int numericValue) {
<span class="nc" id="L68">            return numericValueLookupMap.get(Integer.valueOf(numericValue));</span>
        }

    }

    public static final String IMPLEMENTATION_ALIAS = &quot;OcspKeyBinding&quot;; // This should not change, even if we rename the class in EJBCA 5.3+..
    public static final String PROPERTY_NON_EXISTING_GOOD = &quot;nonexistingisgood&quot;;
    public static final String PROPERTY_NON_EXISTING_REVOKED = &quot;nonexistingisrevoked&quot;;
    public static final String PROPERTY_NON_EXISTING_UNAUTHORIZED = &quot;nonexistingisunauthorized&quot;;
    public static final String PROPERTY_INCLUDE_CERT_CHAIN = &quot;includecertchain&quot;;
    public static final String PROPERTY_INCLUDE_SIGN_CERT = &quot;includesigncert&quot;;
    public static final String PROPERTY_RESPONDER_ID_TYPE = &quot;responderidtype&quot;;  // keyhash, name
    public static final String PROPERTY_REQUIRE_TRUSTED_SIGNATURE = &quot;requireTrustedSignature&quot;;
    public static final String PROPERTY_UNTIL_NEXT_UPDATE = &quot;untilNextUpdate&quot;;
    public static final String PROPERTY_MAX_AGE = &quot;maxAge&quot;;
    public static final String PROPERTY_ENABLE_NONCE = &quot;enableNonce&quot;;
    
    {
<span class="fc" id="L86">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_NON_EXISTING_GOOD, Boolean.FALSE));</span>
<span class="fc" id="L87">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_NON_EXISTING_REVOKED, Boolean.FALSE));</span>
<span class="fc" id="L88">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_NON_EXISTING_UNAUTHORIZED, Boolean.FALSE));</span>
<span class="fc" id="L89">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_INCLUDE_CERT_CHAIN, Boolean.TRUE));</span>
<span class="fc" id="L90">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_INCLUDE_SIGN_CERT, Boolean.TRUE));</span>
<span class="fc" id="L91">        addProperty(new DynamicUiProperty&lt;String&gt;(PROPERTY_RESPONDER_ID_TYPE, ResponderIdType.KEYHASH.name(),</span>
<span class="fc" id="L92">                Arrays.asList(ResponderIdType.KEYHASH.name(), ResponderIdType.NAME.name())));</span>
<span class="fc" id="L93">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_REQUIRE_TRUSTED_SIGNATURE, Boolean.FALSE));</span>
<span class="fc" id="L94">        addProperty(new DynamicUiProperty&lt;Long&gt;(PROPERTY_UNTIL_NEXT_UPDATE, Long.valueOf(0L)));</span>
<span class="fc" id="L95">        addProperty(new DynamicUiProperty&lt;Long&gt;(PROPERTY_MAX_AGE, Long.valueOf(0L)));</span>
<span class="fc" id="L96">        addProperty(new DynamicUiProperty&lt;Boolean&gt;(PROPERTY_ENABLE_NONCE, Boolean.TRUE));</span>
<span class="fc" id="L97">    }</span>

    
    @Override
    public String getImplementationAlias() {
<span class="nc" id="L102">        return IMPLEMENTATION_ALIAS;</span>
    }
    
    @Override
    public float getLatestVersion() {
<span class="fc" id="L107">        return serialVersionUID;</span>
    }

    @Override
    protected void upgrade(float latestVersion, float currentVersion) {
        // Nothing to do
<span class="nc" id="L113">    }</span>
    
    @Override
    public void assertCertificateCompatability(final Certificate certificate, final AvailableExtendedKeyUsagesConfiguration ekuConfig) throws CertificateImportException {
<span class="fc" id="L117">        assertCertificateCompatabilityInternal(certificate, ekuConfig);</span>
<span class="fc" id="L118">    }</span>

    public boolean getNonExistingGood() {
<span class="fc" id="L121">        return (Boolean) getProperty(PROPERTY_NON_EXISTING_GOOD).getValue();</span>
    }
    public void setNonExistingGood(boolean nonExistingGood) {
<span class="fc" id="L124">        setProperty(PROPERTY_NON_EXISTING_GOOD, Boolean.valueOf(nonExistingGood));</span>
<span class="fc" id="L125">    }</span>
    public boolean getNonExistingRevoked() {
<span class="nc" id="L127">        return (Boolean) getProperty(PROPERTY_NON_EXISTING_REVOKED).getValue();</span>
    }
    public void setNonExistingRevoked(boolean nonExistingRevoked) {
<span class="nc" id="L130">        setProperty(PROPERTY_NON_EXISTING_REVOKED, Boolean.valueOf(nonExistingRevoked));</span>
<span class="nc" id="L131">    }</span>
    public boolean getNonExistingUnauthorized() {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if(getProperty(PROPERTY_NON_EXISTING_UNAUTHORIZED) == null) {</span>
<span class="nc" id="L134">            setNonExistingUnauthorized(false);</span>
        }
<span class="nc" id="L136">        return (Boolean) getProperty(PROPERTY_NON_EXISTING_UNAUTHORIZED).getValue();</span>
    }
    public void setNonExistingUnauthorized(boolean nonExistingUnauthorized) {
<span class="nc" id="L139">        setProperty(PROPERTY_NON_EXISTING_UNAUTHORIZED, Boolean.valueOf(nonExistingUnauthorized));</span>
<span class="nc" id="L140">    }</span>
    public boolean getIncludeCertChain() {
<span class="fc" id="L142">        return (Boolean) getProperty(PROPERTY_INCLUDE_CERT_CHAIN).getValue();</span>
    }
    public void setIncludeCertChain(boolean includeCertChain) {
<span class="fc" id="L145">        setProperty(PROPERTY_INCLUDE_CERT_CHAIN, Boolean.valueOf(includeCertChain));</span>
<span class="fc" id="L146">    }</span>
    public boolean getIncludeSignCert() {
<span class="fc" id="L148">        return (Boolean) getProperty(PROPERTY_INCLUDE_SIGN_CERT).getValue();</span>
    }
    public void setIncludeSignCert(boolean includeCertChain) {
<span class="fc" id="L151">        setProperty(PROPERTY_INCLUDE_SIGN_CERT, Boolean.valueOf(includeCertChain));</span>
<span class="fc" id="L152">    }</span>
    public ResponderIdType getResponderIdType() {
<span class="fc" id="L154">        return ResponderIdType.valueOf((String) getProperty(PROPERTY_RESPONDER_ID_TYPE).getValue());</span>
    }
    public void setResponderIdType(ResponderIdType responderIdType) {
<span class="fc" id="L157">        setProperty(PROPERTY_RESPONDER_ID_TYPE, responderIdType.name());</span>
<span class="fc" id="L158">    }</span>
    public boolean getRequireTrustedSignature() {
<span class="fc" id="L160">        return (Boolean) getProperty(PROPERTY_REQUIRE_TRUSTED_SIGNATURE).getValue();</span>
    }
    public void setRequireTrustedSignature(boolean requireTrustedSignature) {
<span class="fc" id="L163">        setProperty(PROPERTY_REQUIRE_TRUSTED_SIGNATURE, Boolean.valueOf(requireTrustedSignature));</span>
<span class="fc" id="L164">    }</span>
    /** @return the value in seconds (granularity defined in RFC 5019) */
    public long getUntilNextUpdate() {
<span class="nc" id="L167">        return (Long) getProperty(PROPERTY_UNTIL_NEXT_UPDATE).getValue();</span>
    }
    /** Set the value in seconds (granularity defined in RFC 5019) 
     * @param untilNextUpdate time */
    public void setUntilNextUpdate(long untilNextUpdate) {
<span class="nc" id="L172">        setProperty(PROPERTY_UNTIL_NEXT_UPDATE, Long.valueOf(untilNextUpdate));</span>
<span class="nc" id="L173">    }</span>
    /** @return the value in seconds (granularity defined in RFC 5019) */
    public long getMaxAge() {
<span class="nc" id="L176">        return (Long) getProperty(PROPERTY_MAX_AGE).getValue();</span>
    }
    /** Set the value in seconds (granularity defined in RFC 5019) 
     * @param maxAge age*/
    public void setMaxAge(long maxAge) {
<span class="nc" id="L181">        setProperty(PROPERTY_MAX_AGE, Long.valueOf(maxAge));</span>
<span class="nc" id="L182">    }</span>
    
    /** @return true if NONCE's are to be used in replies */
    public boolean isNonceEnabled() {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if(getProperty(PROPERTY_ENABLE_NONCE) == null) {</span>
<span class="nc" id="L187">            setNonceEnabled(true);</span>
        }
<span class="nc" id="L189">        return (Boolean) getProperty(PROPERTY_ENABLE_NONCE).getValue();</span>
    }
    /** 
     * @param enabled as true of NONCE's are to be included in replies
     *  */
    public void setNonceEnabled(boolean enabled) {
<span class="nc" id="L195">        setProperty(PROPERTY_ENABLE_NONCE, Boolean.valueOf(enabled));</span>
<span class="nc" id="L196">    }</span>

    public static boolean isOcspSigningCertificate(final Certificate certificate, AvailableExtendedKeyUsagesConfiguration ekuConfig) {
        try {
<span class="fc" id="L200">            assertCertificateCompatabilityInternal(certificate, ekuConfig);</span>
<span class="fc" id="L201">        } catch (CertificateImportException e) {</span>
<span class="fc" id="L202">            return false;</span>
<span class="fc" id="L203">        }</span>
<span class="fc" id="L204">        return true;</span>
    }

    private static void assertCertificateCompatabilityInternal(final Certificate certificate, AvailableExtendedKeyUsagesConfiguration ekuConfig) throws CertificateImportException {
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (certificate == null) {</span>
<span class="nc" id="L209">            throw new CertificateImportException(&quot;No certificate provided.&quot;);</span>
        }
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (!(certificate instanceof X509Certificate)) {</span>
<span class="nc" id="L212">            throw new CertificateImportException(&quot;Only X509 certificates are supported for OCSP.&quot;);</span>
        }
        try {
<span class="fc" id="L215">            final X509Certificate x509Certificate = (X509Certificate) certificate;</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L217">                log.debug(&quot;SubjectDN: &quot; + CertTools.getSubjectDN(x509Certificate) + &quot; IssuerDN: &quot; + CertTools.getIssuerDN(x509Certificate));</span>
<span class="nc" id="L218">                final boolean[] ku = x509Certificate.getKeyUsage();</span>
<span class="nc" id="L219">                log.debug(&quot;Key usages: &quot; + Arrays.toString(ku));</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (ku != null) {</span>
<span class="nc" id="L221">                    log.debug(&quot;Key usage (digitalSignature): &quot; + x509Certificate.getKeyUsage()[0]);</span>
<span class="nc" id="L222">                    log.debug(&quot;Key usage (nonRepudiation):   &quot; + x509Certificate.getKeyUsage()[1]);</span>
<span class="nc" id="L223">                    log.debug(&quot;Key usage (keyEncipherment):  &quot; + x509Certificate.getKeyUsage()[2]);</span>
                }
            }
<span class="fc bfc" id="L226" title="All 2 branches covered.">            if (x509Certificate.getExtendedKeyUsage() == null) {</span>
<span class="fc" id="L227">                throw new CertificateImportException(&quot;No Extended Key Usage present in certificate.&quot;);</span>
            }
<span class="fc bfc" id="L229" title="All 2 branches covered.">            for (String extendedKeyUsage : x509Certificate.getExtendedKeyUsage()) {</span>
<span class="fc" id="L230">                log.debug(&quot;EKU: &quot; + extendedKeyUsage + &quot; (&quot; +</span>
<span class="fc" id="L231">                        ekuConfig.getAllEKUOidsAndNames().get(extendedKeyUsage) + &quot;)&quot;);</span>
<span class="fc" id="L232">            }</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">            if (!x509Certificate.getExtendedKeyUsage().contains(KeyPurposeId.id_kp_OCSPSigning.getId())) {</span>
<span class="nc" id="L234">                throw new CertificateImportException(&quot;Extended Key Usage 1.3.6.1.5.5.7.3.9 (EKU_PKIX_OCSPSIGNING) is required.&quot;);</span>
            }
<span class="fc bfc" id="L236" title="All 4 branches covered.">            if (!x509Certificate.getKeyUsage()[0] &amp;&amp; !x509Certificate.getKeyUsage()[1] ) {</span>
<span class="fc" id="L237">                throw new CertificateImportException(&quot;Key Usage digitalSignature is required (nonRepudiation would also be accepted).&quot;);</span>
            }
<span class="nc" id="L239">        } catch (CertificateParsingException e) {</span>
<span class="nc" id="L240">            throw new CertificateImportException(e.getMessage(), e);</span>
<span class="fc" id="L241">        }</span>
<span class="fc" id="L242">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>