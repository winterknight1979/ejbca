<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DynamicUiModel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security Common Code</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.util.ui</a> &gt; <span class="el_source">DynamicUiModel.java</span></div><h1>DynamicUiModel.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General                  *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.util.ui;

import java.beans.PropertyChangeListener;
import java.beans.PropertyChangeSupport;
import java.io.Serializable;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;

/**
 * Base implementation for domain objects (or other objects) with dynamic UI properties.
 *
 * @version $Id: DynamicUiModel.java 29467 2018-07-05 16:23:04Z mikekushner $
 *
 */
public class DynamicUiModel {

    public static final String BASECLASS_PREFIX = &quot;BASECLASS_&quot;;

    public static final String SUBCLASS_PREFIX = &quot;SUBCLASS_&quot;;

    public static final String LIST_SEPARATOR = &quot;;&quot;;
    
    /** Class logger. */
<span class="nc" id="L44">    private static final Logger log = Logger.getLogger(DynamicUiModel.class);</span>

    /** Reference to data map. */
    private LinkedHashMap&lt;Object, Object&gt; data;

    /** List of dynamic UI properties. */
<span class="nc" id="L50">    private final LinkedHashMap&lt;String, DynamicUiProperty&lt;? extends Serializable&gt;&gt; properties = new LinkedHashMap&lt;&gt;();</span>

    /** Property change support for dynamic UI components (MUST have same content as java.util.Map 'viewComponents'. */
    protected PropertyChangeSupport propertyChangeSupport;

    protected Map&lt;String,List&lt;DynamicUiComponent&gt;&gt; viewComponents;

    // True if the dynamic UI input components shall be disabled (i.e. view only).
<span class="nc" id="L58">    protected boolean disabled = false;</span>

    /**
     * Default constructor, required for serialization.
     */
    public DynamicUiModel() {
<span class="nc" id="L64">        super();</span>
<span class="nc" id="L65">    }</span>

    /**
     * Constructor with reference to the entity backing map.
     * @param data the map.
     */
    public DynamicUiModel(final LinkedHashMap&lt;Object, Object&gt; data) {
<span class="nc" id="L72">        super();</span>
<span class="nc" id="L73">        propertyChangeSupport = new PropertyChangeSupport(this);</span>
<span class="nc" id="L74">        viewComponents = new HashMap&lt;String,List&lt;DynamicUiComponent&gt;&gt;();</span>
<span class="nc" id="L75">        this.data = data;</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L77">            log.debug(&quot;Create dynmic UI model with data: &quot; + data);</span>
        }
<span class="nc" id="L79">    }</span>

    /**
     * Adds a dynamic UI property to UI properties template.
     *
     * @param property the dynamic UI property to add.
     */
    public void add(DynamicUiProperty&lt;? extends Serializable&gt; property) {
<span class="nc" id="L87">        property.setDynamicUiModel(this);</span>
<span class="nc" id="L88">        properties.put(property.getName(), property);</span>
<span class="nc" id="L89">    }</span>

    /**
     * Gets a copy of all dynamic UI properties from the UI properties template.
     *
     * @return the copy.
     */
    public Map&lt;String, DynamicUiProperty&lt;? extends Serializable&gt;&gt; getProperties() {
<span class="nc" id="L97">        return properties;</span>
    }

    /**
     * Gets a dynamic UI property from the UI properties template.
     *
     * @param name the name of the dynamic UI property.
     * @return the dynamic property.
     */
    public DynamicUiProperty&lt;? extends Serializable&gt; getProperty(String name) {
<span class="nc" id="L107">        final DynamicUiProperty&lt;? extends Serializable&gt; property = properties.get(name);</span>
//        property.setValueGeneric(getData(name, property.getDefaultValue()));
<span class="nc" id="L109">        return property;</span>
    }

    /**
     * Sets the value for a dynamic UI property.
     *
     * @param name the name of the dynamic UI property.
     * @param value the value.
     */
    public void setProperty(String name, Serializable value) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L120">            log.debug(&quot;Set domain object attribute by dynamic property &quot; + name + &quot; with value &quot; + value);</span>
        }
<span class="nc" id="L122">        putData(name, value);</span>
<span class="nc" id="L123">    }</span>

    /**
     * Gets the raw data map for the dynamic properties.
     * @return the raw data map.
     */
    public Map&lt;String,Object&gt; getRawData() {
<span class="nc" id="L130">        final LinkedHashMap&lt;String,Object&gt; result = new LinkedHashMap&lt;String,Object&gt;();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        for (Entry&lt;String,DynamicUiProperty&lt;?&gt;&gt; entry : properties.entrySet()) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (entry.getValue().isTransientValue()) {</span>
<span class="nc" id="L133">                continue;</span>
            }
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (entry.getValue().getHasMultipleValues()) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (entry.getValue().isSaveListAsString()) {</span>
<span class="nc" id="L137">                    result.put(entry.getKey(), StringUtils.join(entry.getValue().getValues(), LIST_SEPARATOR));</span>
                } else {
<span class="nc" id="L139">                    result.put(entry.getKey(), entry.getValue().getValues());</span>
                }
            } else {
                // BigInteger is written into XML object as String (XMLEncoder cannot write
                // data type classes without default constructor).
<span class="nc bnc" id="L144" title="All 6 branches missed.">                if (BigInteger.class.equals(entry.getValue().getType()) &amp;&amp; entry.getValue() != null &amp;&amp; entry.getValue().getValue() != null) {</span>
<span class="nc" id="L145">                    result.put(entry.getKey(), entry.getValue().getValue().toString());</span>
                } else {
<span class="nc" id="L147">                    result.put(entry.getKey(), entry.getValue().getValue());</span>
                }
            }
<span class="nc" id="L150">        }</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L152">            log.debug(&quot;Create dynamic UI properties raw data: &quot; + result);</span>
        }
<span class="nc" id="L154">        return result;</span>
    }

    /**
     * Writes the properties to the data map (does conversions, i.e. in case of BigInteger etc.).
     * @param data the data map of the entity.
     */
    public void writeProperties(Map&lt;Object, Object&gt; data) {
<span class="nc" id="L162">        data.putAll(getRawData());</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L164">            log.debug(&quot;Dynamic UI properties was written into data map: &quot; + data);</span>
        }
<span class="nc" id="L166">    }</span>

    /** Store data in the underlying map. Encourages use of String valued keys. 
     * @param key key
     * @param value value */
    private void putData(final String key, final Object value) {
<span class="nc" id="L172">        data.put(key, value);</span>
<span class="nc" id="L173">    }</span>

    /**
     * Adds a dynamic UI component for the property with the given name.
     * @param name the properties name.
     * @param component the dynamic UI component.
     */
    public void addDynamicUiComponent(final String name, final DynamicUiComponent component) {
<span class="nc" id="L181">        propertyChangeSupport.addPropertyChangeListener(name, (PropertyChangeListener) component);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (viewComponents.get(name) == null) {</span>
<span class="nc" id="L183">            viewComponents.put(name, new ArrayList&lt;DynamicUiComponent&gt;());</span>
        }
<span class="nc" id="L185">        viewComponents.get(name).add(component);</span>
<span class="nc" id="L186">    }</span>

    /**
     * Removes a dynamic UI component for the property with the given name.
     * @param name the properties name.
     * @param component the dynamic UI component.
     */
    public void removeDynamicUiComponent(final String name, final DynamicUiComponent component) {
<span class="nc" id="L194">        propertyChangeSupport.removePropertyChangeListener(name, (PropertyChangeListener) component);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (viewComponents.get(name) != null) {</span>
<span class="nc" id="L196">            viewComponents.get(name).remove(component);</span>
        }
<span class="nc" id="L198">    }</span>

    /**
     * Gets a list of dynamic UI components for the property with the given name.
     * @param name the properties name.
     * @return the list of dynamic UI components for this property.
     */
    public List&lt;DynamicUiComponent&gt; getViewComponents(String name) {
<span class="nc" id="L206">        final List&lt;DynamicUiComponent&gt; result = new ArrayList&lt;DynamicUiComponent&gt;();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (viewComponents.get(name) != null) {</span>
<span class="nc" id="L208">            result.addAll(viewComponents.get(name));</span>
        }
<span class="nc" id="L210">        return result;</span>
    }

    /**
     * Fires a property change event for the property with the given name.
     * @param name the properties name.
     * @param oldValue the old value.
     * @param newValue the new value.
     */
    public void firePropertyChange(final String name, final Object oldValue, final Object newValue) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L221">            log.trace(&quot;Fire dynamic UI model property change event for &quot; + name + &quot; with old value &quot; + oldValue + &quot;, new value &quot; + newValue);</span>
        }
<span class="nc" id="L223">        propertyChangeSupport.firePropertyChange(name, oldValue, newValue);</span>
<span class="nc" id="L224">        final DynamicUiProperty&lt;?&gt; property = getProperty(name);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        if (property != null) {</span>
<span class="nc" id="L226">            property.updateViewComponents();</span>
        }
<span class="nc" id="L228">    }</span>

    /**
     * Fire a property change event for the properties.
     * @param oldValues the map of old values.
     * @param newValues the map of new values.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void firePropertyChange(final Map&lt;Object, Object&gt; oldValues, final Map&lt;Object, Object&gt; newValues) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L238">            log.trace(&quot;Fire dynamic UI model property change event with old values &quot; + oldValues + &quot;, new values &quot; + newValues);</span>
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (propertyChangeSupport != null) {</span>
            DynamicUiProperty&lt;?&gt; property;
<span class="nc bnc" id="L242" title="All 2 branches missed.">            for (Object key : newValues.keySet()) {</span>
<span class="nc" id="L243">                property = getProperty((String) key);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (property != null) {</span>
                    // Update dynamic UI model (if not done already).
<span class="nc bnc" id="L246" title="All 2 branches missed.">                    if (property.getHasMultipleValues()) {</span>
<span class="nc" id="L247">                        property.setValuesGeneric((List&lt;Serializable&gt;) newValues.get(key));</span>
                    } else {
<span class="nc" id="L249">                        property.setValueGeneric((Serializable) newValues.get(key));</span>
                    }
                    // Update UIs.
<span class="nc" id="L252">                    firePropertyChange((String) key, oldValues.get(key), newValues.get(key));</span>
                }
<span class="nc" id="L254">            }</span>
        }
<span class="nc" id="L256">    }</span>

    /**
     * Gets if the dynamic UI input components shall be disabled.
     * @return true if the dynamic UI input components shall be disabled (i.e. view only).
     */
    public boolean isDisabled() {
<span class="nc" id="L263">        return disabled;</span>
    }

    /**
     * Sets if the dynamic UI input components shall be disabled.
     * @param disabled if the dynamic UI input components shall be disabled (i.e. view only).
     */
    public void setDisabled(boolean disabled) {
<span class="nc" id="L271">        this.disabled = disabled;</span>
<span class="nc" id="L272">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>