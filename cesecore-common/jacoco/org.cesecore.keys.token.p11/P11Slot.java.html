<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>P11Slot.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.keys.token.p11</a> &gt; <span class="el_source">P11Slot.java</span></div><h1>P11Slot.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.keys.token.p11;

import java.io.File;
import java.security.AuthProvider;
import java.security.Provider;
import java.security.Security;
import java.util.HashMap;
import java.util.Map;

import javax.security.auth.login.LoginException;

import org.apache.log4j.Logger;
import org.cesecore.internal.InternalResources;
import org.cesecore.keys.token.CryptoTokenOfflineException;
import org.cesecore.keys.token.p11.exception.NoSuchSlotException;

/**
 * Each instance of this class represents a slot on a P11 module.
 * Use an instance of this class for all your access of a specific P11 slot.
 * Use {@link P11Slot#getProvider()} to get a provider for the slot.
 *
 * @version $Id: P11Slot.java 30502 2018-11-14 13:44:43Z anatom $
 */
public class P11Slot {

<span class="nc" id="L38">    private static final Logger log = Logger.getLogger(P11Slot.class);</span>

    /** Used for library key map when a sun configuration file is used to specify a token (slot). In this case only one lib could be used. */
    private static final String ONLY_ONE = &quot;onlyOne&quot;;
    
<span class="nc" id="L43">    private final static Map&lt;String,P11Slot&gt; slotMap = new HashMap&lt;String, P11Slot&gt;();</span>
<span class="nc" id="L44">    private final Map&lt;Integer, P11SlotUser&gt; p11SlotUserMap = new HashMap&lt;Integer, P11SlotUser&gt;();</span>
    private final Pkcs11SlotLabelType slotLabelType;
    private final String slotLabel;
    private final String sharedLibrary;
    private final String sunP11ConfigFileName;
    private Provider provider;
    private final String libraryFileName;
    
    private P11Slot(final Pkcs11SlotLabelType slotLabelType, final String slotLabel, final String sharedLibrary, final String attributesFile,
<span class="nc" id="L53">            final String friendlyName, boolean addProvider) throws NoSuchSlotException {</span>
<span class="nc" id="L54">        this.slotLabelType = slotLabelType;</span>
<span class="nc" id="L55">        this.slotLabel = slotLabel;</span>
<span class="nc" id="L56">        this.sharedLibrary = sharedLibrary;</span>
<span class="nc" id="L57">        this.sunP11ConfigFileName = null;</span>
<span class="nc" id="L58">        this.libraryFileName = new File(sharedLibrary).getName();</span>
<span class="nc" id="L59">        provider = Pkcs11SlotLabel.getP11Provider(slotLabel, slotLabelType, sharedLibrary, attributesFile);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (provider==null) {</span>
<span class="nc" id="L61">            throw new NoSuchSlotException(&quot;Slot labeled &quot; + slotLabel + &quot; could not be located.&quot;);</span>
        }
<span class="nc" id="L63">        addProviderIfNotExisting(addProvider);</span>
<span class="nc" id="L64">    }</span>

<span class="nc" id="L66">    private P11Slot(final String sunP11ConfigFileName, boolean addProvider) throws NoSuchSlotException {</span>
<span class="nc" id="L67">        this.slotLabelType = Pkcs11SlotLabelType.SUN_FILE;</span>
<span class="nc" id="L68">        this.sunP11ConfigFileName = sunP11ConfigFileName;</span>
<span class="nc" id="L69">        this.slotLabel = null;</span>
<span class="nc" id="L70">        this.sharedLibrary = null;</span>
<span class="nc" id="L71">        this.libraryFileName = ONLY_ONE;</span>
<span class="nc" id="L72">        this.provider = new Pkcs11SlotLabel(Pkcs11SlotLabelType.SUN_FILE, null).getProvider(sunP11ConfigFileName, null, null);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (this.provider==null) {</span>
<span class="nc" id="L74">            throw new NoSuchSlotException(&quot;Slot configured in &quot; + sunP11ConfigFileName + &quot; could not be located.&quot;);</span>
        }
<span class="nc" id="L76">        addProviderIfNotExisting(addProvider);</span>
<span class="nc" id="L77">    }</span>

    /** Add a PKCS11 Crypto Provider to Java Security.addProvider, if it is not already added, and add==true.
     * The add parameter can seem redundant, but it is here in order to centralize control of what is added as a 
     * Crypto Provider, instead if distributing it to multiple places in the code.
     * @param add default value should be true, set to false to create a P11 slot without actually adding the P11 provider to Java Security
     */
    private void addProviderIfNotExisting(boolean add) {
        // If we already have a provider installed, it means there is another Crypto Token already using this slot
        // It can potentially be a Database Integrity Protection Crypto Token
        // We can't remove the already existing provider as that will cause the existing one to stop working. 
        // A classic error message when that happens is: 
        // java.security.InvalidKeyException: Private key must be instance of RSAPrivate(Crt)Key or have PKCS#8 encoding
        // Some HSMs (like Thales) only have one slot so in many cases it is a must to be able to use the same slot for
        // database integrity protection and a Crypto Token for CAs
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (Security.getProvider(provider.getName()) != null) {</span>
            // Because of the above, and how Sun P11 Provider works, we can re-use the existing provider
            // Of course, of this provider is not working (disconnected to HSM was disconnected or similar), this 
            // P11Slot will also just not work, while a remove and re-add might have caused it to start working
<span class="nc" id="L96">            provider = Security.getProvider(provider.getName());</span>
<span class="nc" id="L97">            log.info(&quot;Found an existing PKCS#11 Provider while activating Crypto Token, re-using that instead of a new one: &quot;+provider);</span>
        } else {
            // Give the possibility to create a P11 slot without actually adding the P11 provider to Java Security
<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (add) {</span>
<span class="nc" id="L101">                Security.addProvider(provider);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L103">                    log.debug(&quot;PKCS#11 Provider successfully added: &quot;+provider.getName());</span>
                }
            } else {
<span class="nc" id="L106">                log.info(&quot;Did not find an existing PKCS#11 Provider while activating Crypto Token, but was configured to not add one either: &quot;+provider.getName());</span>
            }
        }
<span class="nc" id="L109">    }</span>

    @Override
    public String toString() {
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (Pkcs11SlotLabelType.SUN_FILE.equals(slotLabelType)) {</span>
<span class="nc" id="L114">            return &quot;PKCS#11, Sun configuration file name: &quot; + sunP11ConfigFileName;</span>
        }
<span class="nc" id="L116">        return &quot;PKCS#11 slot &quot; + slotLabel + &quot; using library &quot; + sharedLibrary + &quot;.&quot;;</span>
    }

    /** Reset the HSM. Could be done if it has stopped working in a try to get it working again. */
    public void reset() {
<span class="nc" id="L121">        synchronized (slotMap) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            for (final P11Slot slot : slotMap.values()) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (slot.libraryFileName.equals(libraryFileName)) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                    for (final P11SlotUser p11SlotUser : slot.p11SlotUserMap.values()) {</span>
                        try {
<span class="nc" id="L126">                            p11SlotUser.deactivate();</span>
<span class="nc" id="L127">                        } catch (Exception e) {</span>
<span class="nc" id="L128">                            log.error(&quot;Not possible to deactivate token.&quot;, e);</span>
<span class="nc" id="L129">                        }</span>
<span class="nc" id="L130">                    }</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    if (Pkcs11SlotLabelType.SUN_FILE.equals(slotLabelType)) {</span>
<span class="nc" id="L132">                        break;</span>
                    }
                }
<span class="nc" id="L135">            }</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">    }</span>

    /** Unload if last active token on slot */
    public void logoutFromSlotIfNoTokensActive() {
<span class="nc" id="L141">        synchronized (slotMap) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            for (final P11SlotUser p11SlotUser : p11SlotUserMap.values()) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (p11SlotUser.isActive()) {</span>
<span class="nc" id="L144">                    return;</span>
                }
<span class="nc" id="L146">            }</span>
<span class="nc" id="L147">        }</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (provider instanceof AuthProvider) {</span>
            try {
<span class="nc" id="L150">                ((AuthProvider)provider).logout();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L152">                    log.debug(&quot;PKCS#11 session terminated for \&quot;&quot; + toString() + &quot;\&quot;.&quot;);</span>
                }
<span class="nc" id="L154">            } catch (LoginException e) {</span>
<span class="nc" id="L155">                log.warn(&quot;Not possible to logout from PKCS#11 Session. HW problems?&quot;, e);</span>
<span class="nc" id="L156">            }</span>
        } else {
<span class="nc" id="L158">            log.warn(&quot;Not possible to logout from PKCS#11 provider '&quot; + toString() + &quot;'. It is not implementing '&quot; + AuthProvider.class.getCanonicalName() + &quot;'.&quot;);</span>
        }
<span class="nc" id="L160">    }</span>

    /** @return the provider of the slot. */
    public Provider getProvider() {
<span class="nc" id="L164">        return provider;</span>
    }

    /**
     * Get P11 slot instance. Only one instance (provider) will ever be created for each slot regardless of how many times this method is called.
     * @param slotLabel the labeling of the slot, regardless of label type. 
     * @param sharedLibrary file path of shared
     * @param slotLabelType The type of the label. May be a slot number [0...9]*, slot index i[0...9]* or a label.
     * @param attributesFile Attributes file. Optional. Set to null if not used
     * @param token Token that should use this object
     * @param id unique ID of the user of the token. For EJBCA this is the caid. For the OCSP responder this is fixed since then there is only one user.
     * @param addProvider default value should be true, set to false to create a P11 slot without actually adding the P11 provider to Java Security
     * @return P11Slot
     * @throws CryptoTokenOfflineException if token can not be activated
     * @throws NoSuchSlotException if no slot with the label defined by slotLabel could be found
     */
    public static P11Slot getInstance(final String slotLabel, final String sharedLibrary, final Pkcs11SlotLabelType slotLabelType, 
            final String attributesFile, final P11SlotUser token, final int id, boolean addProvider) throws CryptoTokenOfflineException, NoSuchSlotException {       
<span class="nc" id="L182">        final String friendlyName = slotLabel + sharedLibrary + slotLabelType.toString();</span>
<span class="nc" id="L183">        return getInstance(friendlyName, slotLabel, sharedLibrary, slotLabelType, attributesFile, token, id, addProvider);</span>
    }

    /**
     * Get P11 slot instance. Only one instance (provider) will ever be created for each slot regardless of how many times this method is called.
     * @param friendlyName name to identify the instance
     * @param slotLabel the labeling of the slot, regardless of label type. 
     * @param sharedLibrary file path of shared
     * @param slotLabelType The type of the label. May be a slot number [0...9]*, slot index i[0...9]* or a label. 
     * @param attributesFile Attributes file. Optional. Set to null if not used
     * @param p11SlotUser Token that should use this object
     * @param id unique ID of the user of the token. For EJBCA this is the caid. For the OCSP responder this is fixed since then there is only one user.
     * @param addProvider default value should be true, set to false to create a P11 slot without actually adding the P11 provider to Java Security
     * @return P11Slot
     * @throws CryptoTokenOfflineException if token can not be activated
     * @throws NoSuchSlotException if no slot by the given label could be found
     */
    public static P11Slot getInstance(final String friendlyName, final String slotLabel, final String sharedLibrary, final Pkcs11SlotLabelType slotLabelType, 
            final String attributesFile, final P11SlotUser p11SlotUser, final int id, boolean addProvider) throws NoSuchSlotException, CryptoTokenOfflineException {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L203">            log.debug(&quot;P11Slot.getInstance(): &quot;+String.valueOf(slotLabelType)+&quot;'&quot;+slotLabel+&quot;', '&quot;+sharedLibrary+&quot;', &quot;+&quot;, '&quot;+attributesFile+&quot;', &quot;+id);</span>
        }
<span class="nc" id="L205">        return getInstance(slotLabelType, friendlyName, slotLabel, sharedLibrary, attributesFile, null, p11SlotUser, id, addProvider);</span>
    }
    /**
     * As {@link #getInstance(String, String, Pkcs11SlotLabelType, String, P11SlotUser, int, boolean)} but is using config file instead parameters. Do only use this method if the P11 shared library is ony specified in this config file.
     * @param sunP11ConfigFileName name of config file
     * @param p11SlotUser Token that should use this object.
     * @param id unique ID of the user of the token. For EJBCA this is the caid. For the OCSP responder this is fixed since then there is only one user.
     * @param addProvider default value should be true, set to false to create a P11 slot without actually adding the P11 provider to Java Security
     * @return a new P11Slot instance
     * @throws CryptoTokenOfflineException on fail
     * @throws NoSuchSlotException if no slot defined by the label in configFileName could be found.
     */
    public static P11Slot getInstance(final String sunP11ConfigFileName, final P11SlotUser p11SlotUser, final int id, boolean addProvider) throws NoSuchSlotException, CryptoTokenOfflineException {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L219">            log.debug(&quot;P11Slot.getInstance(): '&quot;+sunP11ConfigFileName+&quot;', &quot;+Pkcs11SlotLabelType.SUN_FILE.toString()+&quot;, &quot;+id);</span>
        }
<span class="nc" id="L221">        return getInstance(Pkcs11SlotLabelType.SUN_FILE, null, null, null, null, sunP11ConfigFileName, p11SlotUser, id, addProvider);</span>
    }

    private static P11Slot getInstance(final Pkcs11SlotLabelType slotLabelType, final String friendlyName, final String slotLabel, final String sharedLibrary,
            final String attributesFile, final String sunP11ConfigFileName, final P11SlotUser p11SlotUser, final int id, boolean addProvider) throws NoSuchSlotException, CryptoTokenOfflineException {
        try {
            final String slotMapKey;
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (Pkcs11SlotLabelType.SUN_FILE.equals(slotLabelType)) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                if (sunP11ConfigFileName==null) {</span>
<span class="nc" id="L230">                    throw new IllegalStateException(&quot;Can't initialize PKCS#11 slot of type &quot;+slotLabelType.name()+&quot; without providing a config file.&quot;);</span>
                }
<span class="nc" id="L232">                slotMapKey = new File(sunP11ConfigFileName).getName();</span>
            } else {
<span class="nc bnc" id="L234" title="All 4 branches missed.">                if (slotLabel==null || sharedLibrary==null) {</span>
<span class="nc" id="L235">                    throw new IllegalStateException(&quot;Can't initialize PKCS#11 slot of type &quot;+slotLabelType.name()+&quot; without providing library and slot label.&quot;);</span>
                }
<span class="nc" id="L237">                slotMapKey = friendlyName;</span>
            }
            P11Slot p11Slot;
<span class="nc" id="L240">            synchronized (slotMap) {</span>
<span class="nc" id="L241">                p11Slot = slotMap.get(slotMapKey);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                if (p11Slot==null) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                    if (Pkcs11SlotLabelType.SUN_FILE.equals(slotLabelType)) {</span>
<span class="nc" id="L244">                        p11Slot = new P11Slot(sunP11ConfigFileName, addProvider);</span>
                    } else {
<span class="nc" id="L246">                        p11Slot = new P11Slot(slotLabelType, slotLabel, sharedLibrary, attributesFile, friendlyName, addProvider);</span>
                    }
<span class="nc" id="L248">                    slotMap.put(slotMapKey, p11Slot);</span>
                }
<span class="nc" id="L250">                p11Slot.p11SlotUserMap.put(Integer.valueOf(id), p11SlotUser);</span>
<span class="nc" id="L251">            }</span>
<span class="nc" id="L252">            return p11Slot;</span>
<span class="nc" id="L253">        } catch (NoSuchSlotException e) {</span>
<span class="nc" id="L254">            throw e;</span>
<span class="nc" id="L255">        } catch (Exception e) {</span>
<span class="nc" id="L256">            throw new CryptoTokenOfflineException(InternalResources.getInstance().getLocalizedMessage(&quot;token.errorcreatetoken&quot;, id), e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>