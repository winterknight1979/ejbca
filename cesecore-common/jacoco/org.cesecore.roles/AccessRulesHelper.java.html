<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccessRulesHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security Common Code</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.roles</a> &gt; <span class="el_source">AccessRulesHelper.java</span></div><h1>AccessRulesHelper.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.roles;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map.Entry;
import org.apache.log4j.Logger;

/**
 * Helper methods for interactions with maps of access rules and resources.
 *
 * @version $Id: AccessRulesHelper.java 28354 2018-02-22 12:14:54Z anatom $
 */
<span class="nc" id="L29">public abstract class AccessRulesHelper {</span>

    /** Logger. */
<span class="nc" id="L32">  private static final Logger LOG = Logger.getLogger(AccessRulesHelper.class);</span>

  /**
   * @param accessRules Rules
   * @param resources list of resources
   * @return true if the provided map of access rules allows access to all the
   *     given resources
   */
  public static boolean hasAccessToResources(
      final HashMap&lt;String, Boolean&gt; accessRules, final String... resources) {
<span class="nc bnc" id="L42" title="All 2 branches missed.">    if (resources != null) {</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">      for (final String resource : resources) {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (!AccessRulesHelper.hasAccessToResource(accessRules, resource)) {</span>
<span class="nc" id="L45">          return false;</span>
        }
      }
    }
<span class="nc" id="L49">    return true;</span>
  }

  /**
   * @param accessRules rules
   * @param resource resource
   * @return true if the provided map of access rules allows access to the given
   *     resource
   */
  public static boolean hasAccessToResource(
      final HashMap&lt;String, Boolean&gt; accessRules, final String resource) {
<span class="nc bnc" id="L60" title="All 4 branches missed.">    if (resource == null || resource.charAt(0) != '/') {</span>
<span class="nc" id="L61">      return false;</span>
    }
    // Normalize from &quot;/a/b/c&quot; to &quot;/a/b/c/&quot;
    final String resourceWithTrailingSlash =
<span class="nc bnc" id="L65" title="All 2 branches missed.">        resource.endsWith(&quot;/&quot;) ? resource : resource + &quot;/&quot;;</span>
<span class="nc" id="L66">    int lastSlashIndex = resourceWithTrailingSlash.length() + 1;</span>
<span class="nc" id="L67">    while ((lastSlashIndex =</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            resourceWithTrailingSlash.lastIndexOf('/', lastSlashIndex - 1))</span>
        != -1) {
<span class="nc" id="L70">      final String subString =</span>
<span class="nc" id="L71">          resourceWithTrailingSlash.substring(0, lastSlashIndex);</span>
<span class="nc" id="L72">      Boolean state = accessRules.get(subString);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">      if (state == null) {</span>
        // Check if the non-normalized form is present
<span class="nc" id="L75">        state = accessRules.get(subString + &quot;/&quot;);</span>
      }
<span class="nc bnc" id="L77" title="All 2 branches missed.">      if (state != null) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L79">          LOG.trace(</span>
<span class="nc" id="L80">              &quot;hasAccessToResource: &quot; + resource + &quot;, &quot; + state.booleanValue());</span>
        }
<span class="nc" id="L82">        return state.booleanValue();</span>
      }
<span class="nc" id="L84">    }</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">    if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L86">      LOG.trace(&quot;hasAccessToResource: &quot; + resource + &quot;, &quot; + false);</span>
    }
<span class="nc" id="L88">    return false;</span>
  }

  /**
   * Normalize access rules tree (make sure rules always end with a '/').
   *
   * @param accessRules rules
   */
  public static void normalizeResources(
      final HashMap&lt;String, Boolean&gt; accessRules) {
    // For each rule, check if there are higher level rules (e.g. shorter path)
    // with the same access state
<span class="nc bnc" id="L100" title="All 2 branches missed.">    for (final String resource : new ArrayList&lt;&gt;(accessRules.keySet())) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">      if (!resource.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L102">        final String resourceWithTrailingSlash = resource + &quot;/&quot;;</span>
<span class="nc" id="L103">        final Boolean value = accessRules.remove(resource);</span>
<span class="nc" id="L104">        accessRules.put(resourceWithTrailingSlash, value);</span>
      }
<span class="nc" id="L106">    }</span>
<span class="nc" id="L107">  }</span>

  /**
   * Normalize access rules (make sure rules always end with a '/').
   *
   * @param resource rules
   * @return normalized string
   */
  public static String normalizeResource(final String resource) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">    if (!resource.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L117">      return resource + &quot;/&quot;;</span>
    }
<span class="nc" id="L119">    return resource;</span>
  }

  /**
   * Remove redundant rules. Assumes parameter is in normalized form.
   *
   * @param accessRules rules
   */
  public static void minimizeAccessRules(
      final HashMap&lt;String, Boolean&gt; accessRules) {
    // For each rule, check if there are higher level rules (e.g. shorter path)
    // with the same access state
    for (final String resourceWithTrailingSlash
<span class="nc bnc" id="L132" title="All 2 branches missed.">        : new ArrayList&lt;&gt;(accessRules.keySet())) {</span>
<span class="nc" id="L133">      final Boolean currentState = accessRules.get(resourceWithTrailingSlash);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">      if (currentState == null) {</span>
        // Already removed from map
<span class="nc" id="L136">        continue;</span>
      }
<span class="nc" id="L138">      int lastSlashIndex = resourceWithTrailingSlash.length() + 1;</span>
<span class="nc" id="L139">      while ((lastSlashIndex =</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">              resourceWithTrailingSlash.lastIndexOf('/', lastSlashIndex - 1))</span>
          != -1) {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (lastSlashIndex == resourceWithTrailingSlash.length() - 1) {</span>
<span class="nc" id="L143">          continue;</span>
        }
<span class="nc" id="L145">        final String subString =</span>
<span class="nc" id="L146">            resourceWithTrailingSlash.substring(0, lastSlashIndex + 1);</span>
<span class="nc" id="L147">        final Boolean state = accessRules.get(subString);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (state != null) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">          if (state.booleanValue() == currentState.booleanValue()) {</span>
            // A short path already provides this rule
<span class="nc" id="L151">            accessRules.remove(resourceWithTrailingSlash);</span>
          } else {
            // The rule is needed, since it reverts a short paths state
          }
          break;
        }
<span class="nc" id="L157">      }</span>
<span class="nc" id="L158">    }</span>
    // Remove all top level deny rules (if nothing is explicitly permitted, we
    // don't need to deny it)
    for (final String resourceWithTrailingSlash
<span class="nc bnc" id="L162" title="All 2 branches missed.">        : new ArrayList&lt;&gt;(accessRules.keySet())) {</span>
<span class="nc" id="L163">      final Boolean currentState = accessRules.get(resourceWithTrailingSlash);</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">      if (currentState != null &amp;&amp; !currentState.booleanValue()) {</span>
<span class="nc" id="L165">        boolean needed = false;</span>
<span class="nc" id="L166">        int lastSlashIndex = resourceWithTrailingSlash.length() + 1;</span>
<span class="nc" id="L167">        while ((lastSlashIndex =</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                resourceWithTrailingSlash.lastIndexOf('/', lastSlashIndex - 1))</span>
            != -1) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">          if (lastSlashIndex == resourceWithTrailingSlash.length() - 1) {</span>
<span class="nc" id="L171">            continue;</span>
          }
<span class="nc" id="L173">          final String subString =</span>
<span class="nc" id="L174">              resourceWithTrailingSlash.substring(0, lastSlashIndex + 1);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">          if (accessRules.get(subString) != null) {</span>
<span class="nc" id="L176">            needed = true;</span>
<span class="nc" id="L177">            break;</span>
          }
<span class="nc" id="L179">        }</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!needed) {</span>
<span class="nc" id="L181">          accessRules.remove(resourceWithTrailingSlash);</span>
        }
      }
<span class="nc" id="L184">    }</span>
<span class="nc" id="L185">  }</span>

  /**
   * @param accessRules1 First set of rules
   * @param accessRules2 Second set of rules
   * @return the rules for all resources granted by either sets of normalized
   *     accessRules. (The union of the sets.)
   */
  public static HashMap&lt;String, Boolean&gt; getAccessRulesUnion(
      final HashMap&lt;String, Boolean&gt; accessRules1,
      final HashMap&lt;String, Boolean&gt; accessRules2) {
<span class="nc" id="L196">    final HashMap&lt;String, Boolean&gt; accessRules = new HashMap&lt;&gt;();</span>
    /*
     * Simple example of algorithm:
     *
     * /a/   allow
     * /a/b/ deny    (remove this deny, since it is granted by other role)
     * /b/   deny    (keep since it is not granted by other role)
     *
     * /a/   allow
     * /a/c/ deny    (remove this deny, since it is granted by other role)
     * /c/d  deny    (keep since it is not granted by other role)
     * →
     * /a/   allow
     * /b/   deny
     * /c/d  deny
     */
    // Keep allow rules from accessRules1 and deny rules from accessRules1 that
    // are not granted by accessRules2
<span class="nc bnc" id="L214" title="All 2 branches missed.">    for (final Entry&lt;String, Boolean&gt; entry : accessRules1.entrySet()) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">      if (entry.getValue().booleanValue()</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">          || !hasAccessToResource(accessRules2, entry.getKey())) {</span>
<span class="nc" id="L217">        accessRules.put(entry.getKey(), entry.getValue());</span>
      }
<span class="nc" id="L219">    }</span>
    // Keep allow rules from accessRules1 and deny rules from accessRules1 that
    // are not granted by accessRules2
<span class="nc bnc" id="L222" title="All 2 branches missed.">    for (final Entry&lt;String, Boolean&gt; entry : accessRules2.entrySet()) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">      if (entry.getValue().booleanValue()</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">          || !hasAccessToResource(accessRules1, entry.getKey())) {</span>
<span class="nc" id="L225">        accessRules.put(entry.getKey(), entry.getValue());</span>
      }
<span class="nc" id="L227">    }</span>
<span class="nc" id="L228">    minimizeAccessRules(accessRules);</span>
<span class="nc" id="L229">    return accessRules;</span>
  }

  /**
   * @param accessRules1 First set of rules
   * @param accessRules2 Second set of rules
   * @return the rules for all resources granted by both sets of normalized
   *     accessRules. (The intersection of the sets.)
   */
  public static HashMap&lt;String, Boolean&gt; getAccessRulesIntersection(
      final HashMap&lt;String, Boolean&gt; accessRules1,
      final HashMap&lt;String, Boolean&gt; accessRules2) {
<span class="nc" id="L241">    final HashMap&lt;String, Boolean&gt; accessRules = new HashMap&lt;&gt;();</span>
    /*
     * Simple example of algorithm:
     *
     * /a/   allow
     * /a/b/ deny
     * /b/   deny
     * /c/d/ allow
     *
     * /a/   allow
     * /a/c/ deny
     * /c/d/ deny
     * →
     * /a/   allow
     * /a/b/ deny
     * /a/c/ deny
     * /b/   deny
     * /c/d/ deny
     */
    // Keep deny rules from accessRules1 and allow rules from accessRules1 and
    // that are also granted by accessRules2
<span class="nc bnc" id="L262" title="All 2 branches missed.">    for (final Entry&lt;String, Boolean&gt; entry : accessRules1.entrySet()) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">      if (!entry.getValue().booleanValue()</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">          || hasAccessToResource(accessRules2, entry.getKey())) {</span>
<span class="nc" id="L265">        accessRules.put(entry.getKey(), entry.getValue());</span>
      }
<span class="nc" id="L267">    }</span>
    // Keep deny rules from accessRules2 and allow rules from accessRules2 and
    // that are also granted by accessRules1
<span class="nc bnc" id="L270" title="All 2 branches missed.">    for (final Entry&lt;String, Boolean&gt; entry : accessRules2.entrySet()) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">      if (!entry.getValue().booleanValue()) {</span>
<span class="nc" id="L272">        accessRules.put(entry.getKey(), entry.getValue());</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">      } else if (hasAccessToResource(accessRules1, entry.getKey())) {</span>
<span class="nc" id="L274">        final Boolean currentValue = accessRules.get(entry.getKey());</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if (currentValue == null || currentValue.booleanValue()) {</span>
          // Only overwrite empty or allow rules
<span class="nc" id="L277">          accessRules.put(entry.getKey(), entry.getValue());</span>
        }
      }
<span class="nc" id="L280">    }</span>
<span class="nc" id="L281">    minimizeAccessRules(accessRules);</span>
<span class="nc" id="L282">    return accessRules;</span>
  }

  /**
   * Sort the provided access rules. (Useful for more readable persistence
   * format.)
   *
   * @param accessRules rules
   */
  public static void sortAccessRules(
      final LinkedHashMap&lt;String, Boolean&gt; accessRules) {
<span class="nc" id="L293">    final List&lt;Entry&lt;String, Boolean&gt;&gt; sortEntryList =</span>
<span class="nc" id="L294">        getAsListSortedByKey(accessRules);</span>
<span class="nc" id="L295">    accessRules.clear();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">    for (final Entry&lt;String, Boolean&gt; entry : sortEntryList) {</span>
<span class="nc" id="L297">      accessRules.put(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L298">    }</span>
<span class="nc" id="L299">  }</span>

  /**
   * @param accessRulesMap Rules
   * @param &lt;T1&gt; Type of key
   * @param &lt;T2&gt; Type of value
   * @return the map sorted by keys
   */
  public static &lt;T1, T2&gt; List&lt;Entry&lt;T1, T2&gt;&gt; getAsListSortedByKey(
      final HashMap&lt;T1, T2&gt; accessRulesMap) {
<span class="nc" id="L309">    final List&lt;Entry&lt;T1, T2&gt;&gt; accessRulesList =</span>
<span class="nc" id="L310">        new ArrayList&lt;&gt;(accessRulesMap.entrySet());</span>
<span class="nc" id="L311">    Collections.sort(</span>
        accessRulesList,
<span class="nc" id="L313">        new Comparator&lt;Entry&lt;T1, T2&gt;&gt;() {</span>
          @Override
          public int compare(
              final Entry&lt;T1, T2&gt; entry1, final Entry&lt;T1, T2&gt; entry2) {
<span class="nc" id="L317">            return String.valueOf(entry1.getKey())</span>
<span class="nc" id="L318">                .compareTo(String.valueOf(entry2.getKey()));</span>
          }
        });
<span class="nc" id="L321">    return accessRulesList;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>