<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CertificateDataSessionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security EJB Implementation</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate</a> &gt; <span class="el_source">CertificateDataSessionBean.java</span></div><h1>CertificateDataSessionBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate;

import java.math.BigInteger;
import java.security.cert.Certificate;
import java.util.Collection;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;
import java.util.TimeZone;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.TypedQuery;
import org.apache.commons.lang.time.FastDateFormat;
import org.apache.log4j.Logger;
import org.cesecore.certificates.crl.RevokedCertInfo;
import org.cesecore.config.CesecoreConfiguration;
import org.cesecore.util.QueryResultWrapper;
import org.cesecore.util.ValidityDate;
import org.cesecore.util.ValueExtractor;

/**
 * Low level CRUD functions to access CertificateData.
 *
 * @version $Id: CertificateDataSessionBean.java 28981 2018-05-21 14:10:49Z
 *     jekaterina_b_helmes $
 */
@Stateless // (mappedName = JndiConstants.APP_JNDI_PREFIX +
           // &quot;CertificateDataSessionRemote&quot;)
@TransactionAttribute(TransactionAttributeType.SUPPORTS)
<span class="nc" id="L47">public class CertificateDataSessionBean extends BaseCertificateDataSessionBean</span>
    implements CertificateDataSessionLocal {

    /** Logger. */
<span class="nc" id="L51">  private static final Logger LOG =</span>
<span class="nc" id="L52">      Logger.getLogger(CertificateDataSessionBean.class);</span>

  /** EM. */
  @PersistenceContext(unitName = CesecoreConfiguration.PERSISTENCE_UNIT)
  private EntityManager entityManager;

  @Override
  protected String getTableName() {
<span class="nc" id="L60">    return &quot;CertificateData&quot;;</span>
  }

  @Override
  protected EntityManager getEntityManager() {
<span class="nc" id="L65">    return entityManager;</span>
  }

  //
  // Search functions.
  //

  /** @return the found entity instance or null if the entity does not exist */
  @Override
  public CertificateData findByFingerprint(final String fingerprint) {
<span class="nc" id="L75">    return entityManager.find(CertificateData.class, fingerprint);</span>
  }

  /** @return return the query results as a Set. */
  @Override
  public Set&lt;String&gt; findUsernamesBySubjectDNAndIssuerDN(
      final String subjectDN, final String issuerDN) {
<span class="nc" id="L82">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L83">        entityManager.createQuery(</span>
            &quot;SELECT a.username FROM CertificateData a WHERE&quot;
                + &quot; a.subjectDN=:subjectDN AND a.issuerDN=:issuerDN&quot;,
            String.class);
<span class="nc" id="L87">    query.setParameter(&quot;subjectDN&quot;, subjectDN);</span>
<span class="nc" id="L88">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L89">    return new HashSet&lt;&gt;(query.getResultList());</span>
  }

  /** @return return the query results as a List. */
  @Override
  public List&lt;CertificateData&gt; findBySubjectDN(final String subjectDN) {
<span class="nc" id="L95">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L96">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.subjectDN=:subjectDN&quot;,
            CertificateData.class);
<span class="nc" id="L99">    query.setParameter(&quot;subjectDN&quot;, subjectDN);</span>
<span class="nc" id="L100">    return query.getResultList();</span>
  }

  /** @return return the query results as a List. */
  @Override
  public List&lt;CertificateData&gt; findBySerialNumber(final String serialNumber) {
<span class="nc" id="L106">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L107">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE&quot;
                + &quot; a.serialNumber=:serialNumber&quot;,
            CertificateData.class);
<span class="nc" id="L111">    query.setParameter(&quot;serialNumber&quot;, serialNumber);</span>
<span class="nc" id="L112">    return query.getResultList();</span>
  }

  /** @return return the query results as a List. */
  @Override
  public List&lt;CertificateData&gt; findByIssuerDNSerialNumber(
      final String issuerDN, final String serialNumber) {
<span class="nc" id="L119">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L120">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.issuerDN=:issuerDN AND&quot;
                + &quot; a.serialNumber=:serialNumber&quot;,
            CertificateData.class);
<span class="nc" id="L124">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L125">    query.setParameter(&quot;serialNumber&quot;, serialNumber);</span>
<span class="nc" id="L126">    return query.getResultList();</span>
  }

  @Override
  public CertificateInfo findFirstCertificateInfo(
      final String issuerDN, final String serialNumber) {
<span class="nc" id="L132">    CertificateInfo ret = null;</span>
<span class="nc" id="L133">    final Query query =</span>
<span class="nc" id="L134">        entityManager.createNativeQuery(</span>
            &quot;SELECT a.fingerprint, a.subjectDN, a.cAFingerprint, a.status,&quot;
                + &quot; a.type, a.serialNumber, a.notBefore, a.expireDate,&quot;
                + &quot; a.revocationDate, a.revocationReason, a.username, a.tag,&quot;
                + &quot; a.certificateProfileId, a.endEntityProfileId,&quot;
                + &quot; a.updateTime, a.subjectKeyId, a.subjectAltName FROM&quot;
                + &quot; CertificateData a WHERE a.issuerDN=:issuerDN AND&quot;
                + &quot; a.serialNumber=:serialNumber&quot;,
            &quot;CertificateInfoSubset2&quot;);
<span class="nc" id="L143">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L144">    query.setParameter(&quot;serialNumber&quot;, serialNumber);</span>
<span class="nc" id="L145">    query.setMaxResults(1);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L147">    final List&lt;Object[]&gt; resultList = query.getResultList();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">    if (!resultList.isEmpty()) {</span>
<span class="nc" id="L149">      final Object[] fields = resultList.get(0);</span>
      // The order of the results are defined by the SqlResultSetMapping
      // annotation
<span class="nc" id="L152">      final String fingerprint = (String) fields[0];</span>
<span class="nc" id="L153">      final String subjectDN = (String) fields[1];</span>
<span class="nc" id="L154">      final String cafp = (String) fields[2];</span>
<span class="nc" id="L155">      final int status = ValueExtractor.extractIntValue(fields[3]);</span>
<span class="nc" id="L156">      final int type = ValueExtractor.extractIntValue(fields[4]);</span>
      final Long notBefore;
<span class="nc bnc" id="L158" title="All 2 branches missed.">      if (fields[5] == null) {</span>
<span class="nc" id="L159">        notBefore = null;</span>
      } else {
<span class="nc" id="L161">        notBefore = ValueExtractor.extractLongValue(fields[5]);</span>
      }
<span class="nc" id="L163">      final long expireDate = ValueExtractor.extractLongValue(fields[6]);</span>
<span class="nc" id="L164">      final long revocationDate = ValueExtractor.extractLongValue(fields[7]);</span>
<span class="nc" id="L165">      final int revocationReason = ValueExtractor.extractIntValue(fields[8]);</span>
<span class="nc" id="L166">      final String username = (String) fields[9];</span>
<span class="nc" id="L167">      final String tag = (String) fields[10];</span>
<span class="nc" id="L168">      final int certificateProfileId =</span>
<span class="nc" id="L169">          ValueExtractor.extractIntValue(fields[11]);</span>
      final Integer endEntityProfileId;
<span class="nc bnc" id="L171" title="All 2 branches missed.">      if (fields[12] == null) {</span>
<span class="nc" id="L172">        endEntityProfileId = null;</span>
      } else {
<span class="nc" id="L174">        endEntityProfileId = ValueExtractor.extractIntValue(fields[12]);</span>
      }
      final long updateTime;
<span class="nc bnc" id="L177" title="All 2 branches missed.">      if (fields[13] == null) {</span>
<span class="nc" id="L178">        updateTime = 0; // Might be null in an upgraded installation</span>
      } else {
<span class="nc" id="L180">        updateTime = ValueExtractor.extractLongValue(fields[13]);</span>
      }
<span class="nc" id="L182">      final String subjectKeyId = (String) fields[14];</span>
<span class="nc" id="L183">      final String subjectAltName = (String) fields[15];</span>
<span class="nc" id="L184">      ret =</span>
          new CertificateInfo(
              fingerprint,
              cafp,
              serialNumber,
              issuerDN,
              subjectDN,
              status,
              type,
              notBefore,
              expireDate,
              revocationDate,
              revocationReason,
              username,
              tag,
              certificateProfileId,
              endEntityProfileId,
              updateTime,
              subjectKeyId,
              subjectAltName);
    }
<span class="nc" id="L205">    return ret;</span>
  }

  @Override
  public String findLastUsernameByIssuerDNSerialNumber(
      final String issuerDN, final String serialNumber) {
<span class="nc" id="L211">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L212">        entityManager.createQuery(</span>
            &quot;SELECT a.username FROM CertificateData a WHERE&quot;
                + &quot; a.issuerDN=:issuerDN AND a.serialNumber=:serialNumber&quot;,
            String.class);
<span class="nc" id="L216">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L217">    query.setParameter(&quot;serialNumber&quot;, serialNumber);</span>
    // Since no ordering is done this seems a bit strange, but this is what it
    // was like in previous versions..
<span class="nc" id="L220">    return QueryResultWrapper.getLastResult(query);</span>
  }

  @Override
  public List&lt;CertificateData&gt; findByUsernameOrdered(final String username) {
<span class="nc" id="L225">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L226">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.username=:username ORDER&quot;
                + &quot; BY a.expireDate DESC, a.serialNumber DESC&quot;,
            CertificateData.class);
<span class="nc" id="L230">    query.setParameter(&quot;username&quot;, username);</span>
<span class="nc" id="L231">    return query.getResultList();</span>
  }

  /** @return return the query results as a List. */
  @Override
  public List&lt;CertificateData&gt; findByUsernameAndStatus(
      final String username, final int status) {
<span class="nc" id="L238">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L239">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.username=:username AND&quot;
                + &quot; a.status=:status ORDER BY a.expireDate DESC,&quot;
                + &quot; a.serialNumber DESC&quot;,
            CertificateData.class);
<span class="nc" id="L244">    query.setParameter(&quot;username&quot;, username);</span>
<span class="nc" id="L245">    query.setParameter(&quot;status&quot;, status);</span>
<span class="nc" id="L246">    return query.getResultList();</span>
  }

  /** @return return the query results as a List. */
  @Override
  public List&lt;CertificateData&gt; findByUsernameAndStatusAfterExpireDate(
      final String username, final int status, final long afterExpireDate) {
<span class="nc" id="L253">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L254">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.username=:username AND&quot;
                + &quot; a.status=:status AND a.expireDate&gt;=:afterExpireDate ORDER&quot;
                + &quot; BY a.expireDate DESC, a.serialNumber DESC&quot;,
            CertificateData.class);
<span class="nc" id="L259">    query.setParameter(&quot;username&quot;, username);</span>
<span class="nc" id="L260">    query.setParameter(&quot;status&quot;, status);</span>
<span class="nc" id="L261">    query.setParameter(&quot;afterExpireDate&quot;, afterExpireDate);</span>
<span class="nc" id="L262">    return query.getResultList();</span>
  }

  // TODO: When only JPA is used, check if we can refactor this method to SELECT
  // DISTINCT a.username FROM ...
  @Override
  public Set&lt;String&gt; findUsernamesByIssuerDNAndSubjectKeyId(
      final String issuerDN, final String subjectKeyId) {
<span class="nc" id="L270">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L271">        entityManager.createQuery(</span>
            &quot;SELECT a.username FROM CertificateData a WHERE&quot;
                + &quot; a.issuerDN=:issuerDN AND a.subjectKeyId=:subjectKeyId&quot;,
            String.class);
<span class="nc" id="L275">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L276">    query.setParameter(&quot;subjectKeyId&quot;, subjectKeyId);</span>
<span class="nc" id="L277">    return new HashSet&lt;&gt;(query.getResultList());</span>
  }

  @Override
  public String findUsernameByIssuerDnAndSerialNumber(
      final String issuerDn, final String serialNumber) {
<span class="nc" id="L283">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L284">        entityManager.createQuery(</span>
            &quot;SELECT a.username FROM CertificateData a WHERE&quot;
                + &quot; a.issuerDN=:issuerDN AND a.serialNumber=:serialNumber&quot;,
            String.class);
<span class="nc" id="L288">    query.setParameter(&quot;issuerDN&quot;, issuerDn);</span>
<span class="nc" id="L289">    query.setParameter(&quot;serialNumber&quot;, serialNumber);</span>
<span class="nc" id="L290">    return query.getSingleResult();</span>
  }

  @Override
  public Set&lt;String&gt; findUsernamesBySubjectKeyIdOrDnAndIssuer(
      final String issuerDN,
      final String subjectKeyId,
      final String subjectDN) {
<span class="nc" id="L298">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L299">        entityManager.createQuery(</span>
            &quot;SELECT a.username FROM CertificateData a WHERE&quot;
                + &quot; (a.subjectKeyId=:subjectKeyId OR a.subjectDN=:subjectDN)&quot;
                + &quot; AND a.issuerDN=:issuerDN&quot;,
            String.class);
<span class="nc" id="L304">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L305">    query.setParameter(&quot;subjectKeyId&quot;, subjectKeyId);</span>
<span class="nc" id="L306">    query.setParameter(&quot;subjectDN&quot;, subjectDN);</span>
<span class="nc" id="L307">    return new HashSet&lt;&gt;(query.getResultList());</span>
  }

  @Override
  public List&lt;String&gt; findFingerprintsByIssuerDN(final String issuerDN) {
<span class="nc" id="L312">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L313">        entityManager.createQuery(</span>
            &quot;SELECT a.fingerprint FROM CertificateData a WHERE&quot;
                + &quot; a.issuerDN=:issuerDN&quot;,
            String.class);
<span class="nc" id="L317">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L318">    return query.getResultList();</span>
  }

  @Override
  public Collection&lt;RevokedCertInfo&gt; getRevokedCertInfos(
      final String issuerDN, final long lastbasecrldate) {
<span class="nc bnc" id="L324" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L325">      LOG.debug(</span>
          &quot;Quering for revoked certificates. IssuerDN: '&quot;
              + issuerDN
              + &quot;', Last Base CRL Date: &quot;
<span class="nc" id="L329">              + FastDateFormat.getInstance(</span>
                      ValidityDate.ISO8601_DATE_FORMAT,
<span class="nc" id="L331">                      TimeZone.getTimeZone(&quot;GMT&quot;))</span>
<span class="nc" id="L332">                  .format(lastbasecrldate));</span>
    }
<span class="nc" id="L334">    return getRevokedCertInfosInternal(issuerDN, lastbasecrldate, false);</span>
  }

  @Override
  public List&lt;CertificateData&gt; findByExpireDateWithLimit(
      final long expireDate, final int maxNumberOfResults) {
<span class="nc" id="L340">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L341">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.expireDate&lt;:expireDate&quot;
                + &quot; AND (a.status=:status1 OR a.status=:status2)&quot;,
            CertificateData.class);
<span class="nc" id="L345">    query.setParameter(&quot;expireDate&quot;, expireDate);</span>
<span class="nc" id="L346">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L347">    query.setParameter(</span>
<span class="nc" id="L348">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L349">    query.setMaxResults(maxNumberOfResults);</span>
<span class="nc" id="L350">    return query.getResultList();</span>
  }

  @Override
  public List&lt;CertificateData&gt; findByExpireDateWithLimitAndOffset(
      final long expireDate, final int maxNumberOfResults, final int offset) {
<span class="nc" id="L356">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L357">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.expireDate&lt;:expireDate&quot;
                + &quot; AND (a.status=:status1 OR a.status=:status2) order by&quot;
                + &quot; a.expireDate asc&quot;,
            CertificateData.class);
<span class="nc" id="L362">    query.setParameter(&quot;expireDate&quot;, expireDate);</span>
<span class="nc" id="L363">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L364">    query.setParameter(</span>
<span class="nc" id="L365">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L366">    query.setMaxResults(maxNumberOfResults);</span>
<span class="nc" id="L367">    query.setFirstResult(offset);</span>
<span class="nc" id="L368">    return query.getResultList();</span>
  }

  @Override
  public int countByExpireDate(final long expireDate) {
<span class="nc" id="L373">    Query query =</span>
<span class="nc" id="L374">        entityManager.createQuery(</span>
            &quot;SELECT count(a) FROM CertificateData a WHERE&quot;
                + &quot; a.expireDate&lt;:expireDate AND (a.status=:status1 OR&quot;
                + &quot; a.status=:status2) &quot;);
<span class="nc" id="L378">    query.setParameter(&quot;expireDate&quot;, expireDate);</span>
<span class="nc" id="L379">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L380">    query.setParameter(</span>
<span class="nc" id="L381">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L382">    return ((Long) query.getSingleResult()).intValue();</span>
  }

  @Override
  public List&lt;CertificateData&gt; findByExpireDateAndIssuerWithLimit(
      final long expireDate,
      final String issuerDN,
      final int maxNumberOfResults) {
<span class="nc" id="L390">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L391">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.expireDate&lt;:expireDate&quot;
                + &quot; AND (a.status=:status1 OR a.status=:status2) AND&quot;
                + &quot; issuerDN=:issuerDN&quot;,
            CertificateData.class);
<span class="nc" id="L396">    query.setParameter(&quot;expireDate&quot;, expireDate);</span>
<span class="nc" id="L397">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L398">    query.setParameter(</span>
<span class="nc" id="L399">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L400">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L401">    query.setMaxResults(maxNumberOfResults);</span>
<span class="nc" id="L402">    return query.getResultList();</span>
  }

  @Override
  public List&lt;CertificateData&gt; findByExpireDateAndTypeWithLimit(
      final long expireDate,
      final int certificateType,
      final int maxNumberOfResults) {
<span class="nc" id="L410">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L411">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.expireDate&lt;:expireDate&quot;
                + &quot; AND (a.status=:status1 OR a.status=:status2) AND&quot;
                + &quot; a.type=:ctype&quot;,
            CertificateData.class);
<span class="nc" id="L416">    query.setParameter(&quot;expireDate&quot;, expireDate);</span>
<span class="nc" id="L417">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L418">    query.setParameter(</span>
<span class="nc" id="L419">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L420">    query.setParameter(&quot;ctype&quot;, certificateType);</span>
<span class="nc" id="L421">    query.setMaxResults(maxNumberOfResults);</span>
<span class="nc" id="L422">    return query.getResultList();</span>
  }

  @Override
  public List&lt;String&gt; findUsernamesByExpireTimeWithLimit(
      final long minExpireTime,
      final long maxExpireTime,
      final int maxResults) {
    // TODO: Would it be more effective to drop the NOT NULL of this query and
    // remove it from the result?
<span class="nc" id="L432">    final TypedQuery&lt;String&gt; query =</span>
<span class="nc" id="L433">        entityManager.createQuery(</span>
            &quot;SELECT DISTINCT a.username FROM CertificateData a WHERE&quot;
                + &quot; a.expireDate&gt;=:minExpireTime AND&quot;
                + &quot; a.expireDate&lt;:maxExpireTime AND (a.status=:status1 OR&quot;
                + &quot; a.status=:status2) AND a.username IS NOT NULL&quot;,
            String.class);
<span class="nc" id="L439">    query.setParameter(&quot;minExpireTime&quot;, minExpireTime);</span>
<span class="nc" id="L440">    query.setParameter(&quot;maxExpireTime&quot;, maxExpireTime);</span>
<span class="nc" id="L441">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L442">    query.setParameter(</span>
<span class="nc" id="L443">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L444">    query.setMaxResults(maxResults);</span>
<span class="nc" id="L445">    return query.getResultList();</span>
  }

  @Override
  public List&lt;Certificate&gt; getCertificateList(final List&lt;CertificateData&gt; cdl) {
<span class="nc" id="L450">    final List&lt;Certificate&gt; cl = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">    for (final CertificateData cd : cdl) {</span>
<span class="nc" id="L452">      final Certificate cert = cd.getCertificate(entityManager);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">      if (cert == null) {</span>
<span class="nc" id="L454">        continue;</span>
      }
<span class="nc" id="L456">      cl.add(cert);</span>
<span class="nc" id="L457">    }</span>
<span class="nc" id="L458">    return cl;</span>
  }

  @Override
  public List&lt;Certificate&gt; findCertificatesByIssuerDnAndSerialNumbers(
      final String issuerDN, final Collection&lt;BigInteger&gt; serialNumbers) {
<span class="nc" id="L464">    final StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">    for (final BigInteger serno : serialNumbers) {</span>
<span class="nc" id="L466">      sb.append(&quot;, '&quot;);</span>
<span class="nc" id="L467">      sb.append(serno.toString());</span>
<span class="nc" id="L468">      sb.append(&quot;'&quot;);</span>
<span class="nc" id="L469">    }</span>
    // to save the repeating if-statement in the above closure not to add ', '
    // as the first characters in the StringBuilder we remove the two chars
    // here :)
<span class="nc" id="L473">    sb.delete(0, &quot;, &quot;.length());</span>
    // Derby: Columns of type 'LONG VARCHAR' may not be used in CREATE INDEX,
    // ORDER BY, GROUP BY, UNION, INTERSECT, EXCEPT or DISTINCT statements
    // because comparisons are not supported for that type.
    // Since two certificates in the database should never be the same, &quot;SELECT
    // DISTINCT ...&quot; was changed to &quot;SELECT ...&quot; here.
<span class="nc" id="L479">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L480">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE a.issuerDN=:issuerDN AND&quot;
                + &quot; a.serialNumber IN (:sb)&quot;,
            CertificateData.class);
<span class="nc" id="L484">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L485">    query.setParameter(&quot;sb&quot;, sb.toString());</span>
<span class="nc" id="L486">    return getCertificateList(query.getResultList());</span>
  }

  @Override
  public CertificateInfo getCertificateInfo(final String fingerprint) {
<span class="nc" id="L491">    CertificateInfo ret = null;</span>
<span class="nc" id="L492">    final Query query =</span>
<span class="nc" id="L493">        entityManager.createNativeQuery(</span>
            &quot;SELECT a.issuerDN as issuerDN, a.subjectDN as subjectDN,&quot;
                + &quot; a.cAFingerprint as cAFingerprint, a.status as status,&quot;
                + &quot; a.type as type, a.serialNumber as serialNumber,&quot;
                + &quot; a.notBefore as notBefore, a.expireDate as expireDate,&quot;
                + &quot; a.revocationDate as revocationDate, a.revocationReason as&quot;
                + &quot; revocationReason, a.username as username, a.tag as tag,&quot;
                + &quot; a.certificateProfileId as certificateProfileId,&quot;
                + &quot; a.endEntityProfileId as endEntityProfileId, a.updateTime&quot;
                + &quot; as updateTime, a.subjectKeyId as subjectKeyId,&quot;
                + &quot; a.subjectAltName as subjectAltName FROM CertificateData a&quot;
                + &quot; WHERE a.fingerprint=:fingerprint&quot;,
            &quot;CertificateInfoSubset&quot;);
<span class="nc" id="L506">    query.setParameter(&quot;fingerprint&quot;, fingerprint);</span>
    @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L508">    final List&lt;Object[]&gt; resultList = query.getResultList();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">    if (!resultList.isEmpty()) {</span>
<span class="nc" id="L510">      final Object[] fields = resultList.get(0);</span>
      // The order of the results are defined by the SqlResultSetMapping
      // annotation
<span class="nc" id="L513">      final String issuerDN = (String) fields[0];</span>
<span class="nc" id="L514">      final String subjectDN = (String) fields[1];</span>
<span class="nc" id="L515">      final String cafp = (String) fields[2];</span>
<span class="nc" id="L516">      final int status = ValueExtractor.extractIntValue(fields[3]);</span>
<span class="nc" id="L517">      final int type = ValueExtractor.extractIntValue(fields[4]);</span>
<span class="nc" id="L518">      final String serno = (String) fields[5];</span>
      final Long notBefore;
<span class="nc bnc" id="L520" title="All 2 branches missed.">      if (fields[6] == null) {</span>
<span class="nc" id="L521">        notBefore = null;</span>
      } else {
<span class="nc" id="L523">        notBefore = ValueExtractor.extractLongValue(fields[6]);</span>
      }
<span class="nc" id="L525">      final long expireDate = ValueExtractor.extractLongValue(fields[7]);</span>
<span class="nc" id="L526">      final long revocationDate = ValueExtractor.extractLongValue(fields[8]);</span>
<span class="nc" id="L527">      final int revocationReason = ValueExtractor.extractIntValue(fields[9]);</span>
<span class="nc" id="L528">      final String username = (String) fields[10];</span>
<span class="nc" id="L529">      final String tag = (String) fields[11];</span>
<span class="nc" id="L530">      final int certificateProfileId =</span>
<span class="nc" id="L531">          ValueExtractor.extractIntValue(fields[12]);</span>
      final Integer endEntityProfileId;
<span class="nc bnc" id="L533" title="All 2 branches missed.">      if (fields[13] == null) {</span>
<span class="nc" id="L534">        endEntityProfileId = null;</span>
      } else {
<span class="nc" id="L536">        endEntityProfileId = ValueExtractor.extractIntValue(fields[13]);</span>
      }
      final long updateTime;
<span class="nc bnc" id="L539" title="All 2 branches missed.">      if (fields[14] == null) {</span>
<span class="nc" id="L540">        updateTime = 0; // Might be null in an upgraded installation</span>
      } else {
<span class="nc" id="L542">        updateTime = ValueExtractor.extractLongValue(fields[14]);</span>
      }
<span class="nc" id="L544">      final String subjectKeyId = (String) fields[15];</span>
<span class="nc" id="L545">      final String subjectAltName = (String) fields[16];</span>
<span class="nc" id="L546">      ret =</span>
          new CertificateInfo(
              fingerprint,
              cafp,
              serno,
              issuerDN,
              subjectDN,
              status,
              type,
              notBefore,
              expireDate,
              revocationDate,
              revocationReason,
              username,
              tag,
              certificateProfileId,
              endEntityProfileId,
              updateTime,
              subjectKeyId,
              subjectAltName);
    }
<span class="nc" id="L567">    return ret;</span>
  }

  @Override
  public List&lt;Certificate&gt; findActiveCertificatesByType(
      final Collection&lt;Integer&gt; certificateTypes) {
    // Derby: Columns of type 'LONG VARCHAR' may not be used in CREATE INDEX,
    // ORDER BY, GROUP BY, UNION, INTERSECT, EXCEPT or DISTINCT statements
    // because comparisons are not supported for that type.
    // Since two certificates in the database should never be the same, &quot;SELECT
    // DISTINCT ...&quot; was changed to &quot;SELECT ...&quot; here.
<span class="nc" id="L578">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L579">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE (a.status=:status1 or&quot;
                + &quot; a.status=:status2) AND a.type IN (:ctypes)&quot;,
            CertificateData.class);
<span class="nc" id="L583">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L584">    query.setParameter(</span>
<span class="nc" id="L585">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L586">    query.setParameter(&quot;ctypes&quot;, certificateTypes);</span>
<span class="nc" id="L587">    return getCertificateList(query.getResultList());</span>
  }

  @Override
  public List&lt;Certificate&gt; findActiveCertificatesByTypeAndIssuer(
      final Collection&lt;Integer&gt; certificateTypes, final String issuerDN) {
    // Derby: Columns of type 'LONG VARCHAR' may not be used in CREATE INDEX,
    // ORDER BY, GROUP BY, UNION, INTERSECT, EXCEPT or DISTINCT statements
    // because comparisons are not supported for that type.
    // Since two certificates in the database should never be the same, &quot;SELECT
    // DISTINCT ...&quot; was changed to &quot;SELECT ...&quot; here.
<span class="nc" id="L598">    final TypedQuery&lt;CertificateData&gt; query =</span>
<span class="nc" id="L599">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE (a.status=:status1 or&quot;
                + &quot; a.status=:status2) AND a.type IN (:ctypes) AND&quot;
                + &quot; a.issuerDN=:issuerDN&quot;,
            CertificateData.class);
<span class="nc" id="L604">    query.setParameter(&quot;ctypes&quot;, certificateTypes);</span>
<span class="nc" id="L605">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L606">    query.setParameter(</span>
<span class="nc" id="L607">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L608">    query.setParameter(&quot;issuerDN&quot;, issuerDN);</span>
<span class="nc" id="L609">    return getCertificateList(query.getResultList());</span>
  }

  @Override
  @SuppressWarnings(&quot;unchecked&quot;)
  public List&lt;Object[]&gt; findExpirationInfo(
      final Collection&lt;String&gt; cas,
      final Collection&lt;Integer&gt; certificateProfiles,
      final long activeNotifiedExpireDateMin,
      final long activeNotifiedExpireDateMax,
      final long activeExpireDateMin) {
    // We don't select the base64 certificate data here, because it may be a
    // LONG data type which we can't simply select, or we don't want to read all
    // the data.
<span class="nc" id="L623">    final Query query =</span>
<span class="nc" id="L624">        entityManager.createNativeQuery(</span>
            &quot;SELECT DISTINCT fingerprint as fingerprint, username as username&quot;
                + &quot; FROM CertificateData WHERE &quot;
                + &quot;issuerDN IN (:cas) AND &quot;
                // If the list of certificate profiles is empty, ignore it as a
                // parameter
<span class="nc bnc" id="L630" title="All 2 branches missed.">                + (!certificateProfiles.isEmpty()</span>
<span class="nc" id="L631">                    ? &quot;certificateProfileId IN (:certificateProfiles) AND&quot;</span>
<span class="nc" id="L632">                    : &quot;&quot;)</span>
                + &quot;(expireDate&gt;:activeNotifiedExpireDateMin) AND&quot;
                + &quot; (expireDate&lt;:activeNotifiedExpireDateMax) AND&quot;
                + &quot; (status=:status1 OR status=:status2) AND&quot;
                + &quot; (expireDate&gt;=:activeExpireDateMin OR status=:status3)&quot;,
            &quot;FingerprintUsernameSubset&quot;);
<span class="nc" id="L638">    query.setParameter(&quot;cas&quot;, cas);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">    if (!certificateProfiles.isEmpty()) {</span>
<span class="nc" id="L640">      query.setParameter(&quot;certificateProfiles&quot;, certificateProfiles);</span>
    }
<span class="nc" id="L642">    query.setParameter(</span>
<span class="nc" id="L643">        &quot;activeNotifiedExpireDateMin&quot;, activeNotifiedExpireDateMin);</span>
<span class="nc" id="L644">    query.setParameter(</span>
<span class="nc" id="L645">        &quot;activeNotifiedExpireDateMax&quot;, activeNotifiedExpireDateMax);</span>
<span class="nc" id="L646">    query.setParameter(&quot;status1&quot;, CertificateConstants.CERT_ACTIVE);</span>
<span class="nc" id="L647">    query.setParameter(</span>
<span class="nc" id="L648">        &quot;status2&quot;, CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION);</span>
<span class="nc" id="L649">    query.setParameter(&quot;activeExpireDateMin&quot;, activeExpireDateMin);</span>
<span class="nc" id="L650">    query.setParameter(&quot;status3&quot;, CertificateConstants.CERT_ACTIVE);</span>
    // How to debug log the SQL query:
    // log.debug(&quot;findExpirationInfo:
    // &quot;+query.unwrap(org.hibernate.Query.class).getQueryString());
<span class="nc" id="L654">    return query.getResultList();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>