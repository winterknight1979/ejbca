<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SubjectDirAttrExtension.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cesecore-ejb</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.util.cert</a> &gt; <span class="el_source">SubjectDirAttrExtension.java</span></div><h1>SubjectDirAttrExtension.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.util.cert;

import java.security.cert.Certificate;
import java.security.cert.X509Certificate;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.ASN1EncodableVector;
import org.bouncycastle.asn1.ASN1GeneralizedTime;
import org.bouncycastle.asn1.ASN1ObjectIdentifier;
import org.bouncycastle.asn1.ASN1Primitive;
import org.bouncycastle.asn1.ASN1Sequence;
import org.bouncycastle.asn1.ASN1Set;
import org.bouncycastle.asn1.ASN1String;
import org.bouncycastle.asn1.DERGeneralizedTime;
import org.bouncycastle.asn1.DERPrintableString;
import org.bouncycastle.asn1.DERSet;
import org.bouncycastle.asn1.x509.Attribute;
import org.bouncycastle.asn1.x509.Extension;
import org.bouncycastle.asn1.x509.X509DefaultEntryConverter;
import org.cesecore.util.CertTools;

/**
 * A class for reading values from SubjectDirectoryAttributes extension.
 *
 * @version $Id: SubjectDirAttrExtension.java 25905 2017-05-27 00:53:42Z jeklund $
 */
public class SubjectDirAttrExtension extends CertTools {

<span class="fc" id="L47">    private static final Logger log = Logger.getLogger(SubjectDirAttrExtension.class);</span>
    
    /**
     * inhibits creation of new SubjectDirAttrExtension
     */
    private SubjectDirAttrExtension() {
    }

    /**
	 * SubjectDirectoryAttributes ::= SEQUENCE SIZE (1..MAX) OF Attribute
	 *
	 * Attribute ::= SEQUENCE {
     *  type AttributeType,
     *  values SET OF AttributeValue }
     *  -- at least one value is required
     * 
     * AttributeType ::= OBJECT IDENTIFIER
     * AttributeValue ::= ANY
     * 
	 * SubjectDirectoryAttributes is of form 
	 * dateOfBirth=&amp;lt;19590927&amp;gt;, placeOfBirth=&amp;lt;string&amp;gt;, gender=&amp;lt;M/F&amp;gt;, countryOfCitizenship=&amp;lt;two letter ISO3166&amp;gt;, countryOfResidence=&amp;lt;two letter ISO3166&amp;gt;
     * 
     * Supported subjectDirectoryAttributes are the ones above 
	 *
	 * @param certificate containing subject directory attributes
	 * @return String containing directoryAttributes of form the form specified above or null if no directoryAttributes exist. 
	 *   Values in returned String is from CertTools constants. 
	 *   DirectoryAttributes not supported are simply not shown in the resulting string.  
     *  
	 * @throws java.text.ParseException when id_pda_dateOfBirth is malformed
	 */
	public static String getSubjectDirectoryAttributes(Certificate certificate) throws ParseException {
<span class="fc" id="L79">		log.debug(&quot;Search for SubjectDirectoryAttributes&quot;);</span>
<span class="fc" id="L80">        String result = &quot;&quot;;</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (certificate instanceof X509Certificate) {</span>
<span class="fc" id="L82">			X509Certificate x509cert = (X509Certificate) certificate;</span>
<span class="fc" id="L83">	        ASN1Primitive obj = CertTools.getExtensionValue(x509cert, Extension.subjectDirectoryAttributes.getId());</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">	        if (obj == null) {</span>
<span class="nc" id="L85">	            return null;</span>
	        }
<span class="fc" id="L87">	        ASN1Sequence seq = (ASN1Sequence)obj;</span>
	        
<span class="fc" id="L89">	        String prefix = &quot;&quot;;</span>
<span class="fc" id="L90">			SimpleDateFormat dateF = new SimpleDateFormat(&quot;yyyyMMdd&quot;);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">	        for (int i = 0; i &lt; seq.size(); i++) {</span>
<span class="fc" id="L92">	        	Attribute attr = Attribute.getInstance(seq.getObjectAt(i));</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">	        	if (!StringUtils.isEmpty(result)) {</span>
<span class="fc" id="L94">	        		prefix = &quot;, &quot;;</span>
	        	}
<span class="fc bfc" id="L96" title="All 2 branches covered.">	        	if (attr.getAttrType().getId().equals(id_pda_dateOfBirth)) {</span>
<span class="fc" id="L97">	        		ASN1Set set = attr.getAttrValues();</span>
	        		// Come on, we'll only allow one dateOfBirth, we're not allowing such frauds with multiple birth dates
<span class="fc" id="L99">	        		ASN1GeneralizedTime time = ASN1GeneralizedTime.getInstance(set.getObjectAt(0));</span>
<span class="fc" id="L100">	        		Date date = time.getDate();</span>
<span class="fc" id="L101">	        		String dateStr = dateF.format(date);</span>
<span class="fc" id="L102">	        		result += prefix + &quot;dateOfBirth=&quot;+dateStr; </span>
	        	}
<span class="fc bfc" id="L104" title="All 2 branches covered.">	        	if (attr.getAttrType().getId().equals(id_pda_placeOfBirth)) {</span>
<span class="fc" id="L105">	        		ASN1Set set = attr.getAttrValues();</span>
	        		// same here only one placeOfBirth
<span class="fc" id="L107">	        		String pb = ((ASN1String)set.getObjectAt(0)).getString();</span>
<span class="fc" id="L108">	        		result += prefix + &quot;placeOfBirth=&quot;+pb;        			</span>
	        	}
<span class="fc bfc" id="L110" title="All 2 branches covered.">	        	if (attr.getAttrType().getId().equals(id_pda_gender)) {</span>
<span class="fc" id="L111">	        		ASN1Set set = attr.getAttrValues();</span>
	        		// same here only one gender
<span class="fc" id="L113">	        		String g = ((ASN1String)set.getObjectAt(0)).getString();</span>
<span class="fc" id="L114">	        		result += prefix + &quot;gender=&quot;+g;        			</span>
	        	}
<span class="fc bfc" id="L116" title="All 2 branches covered.">	        	if (attr.getAttrType().getId().equals(id_pda_countryOfCitizenship)) {</span>
<span class="fc" id="L117">	        		ASN1Set set = attr.getAttrValues();</span>
	        		// same here only one citizenship
<span class="fc" id="L119">	        		String g = ((ASN1String)set.getObjectAt(0)).getString();</span>
<span class="fc" id="L120">	        		result += prefix + &quot;countryOfCitizenship=&quot;+g;        			</span>
	        	}
<span class="fc bfc" id="L122" title="All 2 branches covered.">	        	if (attr.getAttrType().getId().equals(id_pda_countryOfResidence)) {</span>
<span class="fc" id="L123">	        		ASN1Set set = attr.getAttrValues();</span>
	        		// same here only one residence
<span class="fc" id="L125">	        		String g = ((ASN1String)set.getObjectAt(0)).getString();</span>
<span class="fc" id="L126">	        		result += prefix + &quot;countryOfResidence=&quot;+g;        			</span>
	        	}
	        }
        }
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (StringUtils.isEmpty(result)) {</span>
<span class="nc" id="L131">            return null;</span>
        }
<span class="fc" id="L133">        return result;            </span>
	}

    /**
     * From subjectDirAttributes string as defined in getSubjectDirAttribute 
     * @param dirAttr string of SubjectDirectoryAttributes
     * @return A Collection of ASN.1 Attribute (org.bouncycastle.asn1.x509), or an empty Collection, never null
     * @see #getSubjectDirectoryAttributes(Certificate)
     */
    public static Collection&lt;Attribute&gt; getSubjectDirectoryAttributes(String dirAttr) {
<span class="nc" id="L143">    	ArrayList&lt;Attribute&gt; ret = new ArrayList&lt;Attribute&gt;();</span>
<span class="nc" id="L144">    	Attribute attr = null;</span>
<span class="nc" id="L145">        String value = CertTools.getPartFromDN(dirAttr, &quot;countryOfResidence&quot;);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!StringUtils.isEmpty(value)) {</span>
<span class="nc" id="L147">        	ASN1EncodableVector vec = new ASN1EncodableVector();</span>
<span class="nc" id="L148">        	vec.add(new DERPrintableString(value));</span>
<span class="nc" id="L149">        	attr = new Attribute(new ASN1ObjectIdentifier(id_pda_countryOfResidence),new DERSet(vec));</span>
<span class="nc" id="L150">        	ret.add(attr);</span>
        }
<span class="nc" id="L152">        value = CertTools.getPartFromDN(dirAttr, &quot;countryOfCitizenship&quot;);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (!StringUtils.isEmpty(value)) {</span>
<span class="nc" id="L154">        	ASN1EncodableVector vec = new ASN1EncodableVector();</span>
<span class="nc" id="L155">        	vec.add(new DERPrintableString(value));</span>
<span class="nc" id="L156">        	attr = new Attribute(new ASN1ObjectIdentifier(id_pda_countryOfCitizenship),new DERSet(vec));</span>
<span class="nc" id="L157">        	ret.add(attr);</span>
        }
<span class="nc" id="L159">        value = CertTools.getPartFromDN(dirAttr, &quot;gender&quot;);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!StringUtils.isEmpty(value)) {</span>
<span class="nc" id="L161">        	ASN1EncodableVector vec = new ASN1EncodableVector();</span>
<span class="nc" id="L162">        	vec.add(new DERPrintableString(value));</span>
<span class="nc" id="L163">        	attr = new Attribute(new ASN1ObjectIdentifier(id_pda_gender),new DERSet(vec));</span>
<span class="nc" id="L164">        	ret.add(attr);</span>
        }
<span class="nc" id="L166">        value = CertTools.getPartFromDN(dirAttr, &quot;placeOfBirth&quot;);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (!StringUtils.isEmpty(value)) {</span>
<span class="nc" id="L168">        	ASN1EncodableVector vec = new ASN1EncodableVector();</span>
<span class="nc" id="L169">        	X509DefaultEntryConverter conv = new X509DefaultEntryConverter();</span>
<span class="nc" id="L170">        	ASN1Primitive obj = conv.getConvertedValue(new ASN1ObjectIdentifier(id_pda_placeOfBirth), value);</span>
<span class="nc" id="L171">        	vec.add(obj);</span>
<span class="nc" id="L172">        	attr = new Attribute(new ASN1ObjectIdentifier(id_pda_placeOfBirth),new DERSet(vec));</span>
<span class="nc" id="L173">        	ret.add(attr);</span>
        }        
        // dateOfBirth that is a GeneralizedTime
        // The correct format for this is YYYYMMDD, it will be padded to YYYYMMDD120000Z
<span class="nc" id="L177">        value = CertTools.getPartFromDN(dirAttr, &quot;dateOfBirth&quot;);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (!StringUtils.isEmpty(value)) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (value.length() == 8) {</span>
<span class="nc" id="L180">                value += &quot;120000Z&quot;; // standard format according to rfc3739</span>
<span class="nc" id="L181">            	ASN1EncodableVector vec = new ASN1EncodableVector();</span>
<span class="nc" id="L182">                vec.add(new DERGeneralizedTime(value));</span>
<span class="nc" id="L183">                attr = new Attribute(new ASN1ObjectIdentifier(id_pda_dateOfBirth),new DERSet(vec));</span>
<span class="nc" id="L184">                ret.add(attr);                </span>
<span class="nc" id="L185">            } else {</span>
<span class="nc" id="L186">                log.error(&quot;Wrong length of data for 'dateOfBirth', should be of format YYYYMMDD, skipping...&quot;);</span>
            }
        }
<span class="nc" id="L189">        return ret;</span>
    }
    

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>