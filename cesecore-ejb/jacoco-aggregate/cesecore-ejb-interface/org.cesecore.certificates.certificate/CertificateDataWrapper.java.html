<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CertificateDataWrapper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cesecore-ejb</a> &gt; <a href="../index.html" class="el_bundle">cesecore-ejb-interface</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate</a> &gt; <span class="el_source">CertificateDataWrapper.java</span></div><h1>CertificateDataWrapper.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate;

import java.io.Serializable;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateParsingException;

import org.cesecore.util.CertTools;

/**
 * 
 * Wrapper class for returning cloned specific CertificateData and Base64CertData objects. 
 * 
 * @version $Id: CertificateDataWrapper.java 30355 2018-11-01 15:54:35Z samuellb $
 *
 */
public class CertificateDataWrapper implements CertificateWrapper, Comparable&lt;CertificateDataWrapper&gt;, Serializable {

    private static final long serialVersionUID = 1L;

    private final BaseCertificateData certificateData;
    private final Base64CertData base64CertData;
    private final byte[] certificateBytes;
<span class="nc" id="L36">    private transient Certificate certificate = null;</span>

<span class="nc" id="L38">    public CertificateDataWrapper(final Certificate certificate, final CertificateData certificateData, final Base64CertData base64CertData) {</span>
<span class="nc" id="L39">        this.certificate = certificate;</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (certificate==null) {</span>
<span class="nc" id="L41">            this.certificateBytes = null;</span>
        } else {
            try {
<span class="nc" id="L44">                this.certificateBytes = certificate.getEncoded();</span>
<span class="nc" id="L45">            } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L46">                throw new IllegalStateException(e);</span>
<span class="nc" id="L47">            }</span>
        }
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (certificateData != null) {</span>
<span class="nc" id="L50">            this.certificateData = new CertificateData(certificateData);</span>
        } else {
<span class="nc" id="L52">            this.certificateData = null;</span>
        }
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (base64CertData != null) {</span>
<span class="nc" id="L55">            this.base64CertData = new Base64CertData(base64CertData);</span>
        } else {
<span class="nc" id="L57">            this.base64CertData = null;</span>
        }
<span class="nc" id="L59">    }</span>

<span class="nc" id="L61">    public CertificateDataWrapper(final CertificateData certificateData, final Base64CertData base64CertData) {</span>
<span class="nc" id="L62">        this.certificate = certificateData.getCertificate(base64CertData);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (certificate==null) {</span>
<span class="nc" id="L64">            this.certificateBytes = null;</span>
        } else {
            try {
<span class="nc" id="L67">                this.certificateBytes = certificate.getEncoded();</span>
<span class="nc" id="L68">            } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L69">                throw new IllegalStateException(e);</span>
<span class="nc" id="L70">            }</span>
        }
<span class="nc" id="L72">        this.certificateData = new CertificateData(certificateData);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (base64CertData != null) {</span>
<span class="nc" id="L74">            this.base64CertData = new Base64CertData(base64CertData);</span>
        } else {
<span class="nc" id="L76">            this.base64CertData = null;</span>
        }
<span class="nc" id="L78">    }</span>
    
<span class="nc" id="L80">    public CertificateDataWrapper(final NoConflictCertificateData noConflictCertData) {</span>
<span class="nc" id="L81">        this.certificateData = noConflictCertData;</span>
<span class="nc" id="L82">        this.certificateBytes = null;</span>
<span class="nc" id="L83">        this.base64CertData = null;</span>
<span class="nc" id="L84">    }</span>
    
    /**
     * @return the BaseCertificateData entity object, may be CertificateData or NoConflictCertificateData entity object.
     * 
     * Note that the NoConflictCertificateData table is append only, so no updates to existing objects!
     */
    public BaseCertificateData getBaseCertificateData() {
<span class="nc" id="L92">        return certificateData;</span>
    }

    /**
     * Returns the CertificateData entity object, or throws if the certificate is stored in NoConflictCertificateData
     * @return CertificateData object. Do not modify the returned object! Modifications might not be written back to the database.
     * @throws ClassCastException If certificate is stored in NoConflictCertificateData
     */
    public CertificateData getCertificateData() {
<span class="nc" id="L101">        return (CertificateData) certificateData;</span>
    }
    
    /**
     * Returns the CertificateData object, or a copy converted to CertificateData, if it was a NoConflictCertificateData entity object.
     * @return CertificateData object. Do not modify the returned object! Modifications might not be written back to the database.
     */
    public CertificateData getCertificateDataOrCopy() {
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (certificateData instanceof CertificateData) {</span>
<span class="nc" id="L110">            return (CertificateData) certificateData;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        } else if (certificateData instanceof NoConflictCertificateData) {</span>
<span class="nc" id="L112">            return new CertificateData(certificateData); </span>
        } else {
<span class="nc" id="L114">            throw new IllegalStateException(&quot;Unexpected subclass&quot;);</span>
        }
    }

    public Base64CertData getBase64CertData() {
<span class="nc" id="L119">        return base64CertData;</span>
    }

    @Override
    public Certificate getCertificate() {
<span class="nc bnc" id="L124" title="All 4 branches missed.">        if (certificate==null &amp;&amp; certificateBytes!=null) {</span>
            // Lazy restore in case of deserialization
            try {
<span class="nc" id="L127">                certificate = CertTools.getCertfromByteArray(certificateBytes, Certificate.class);</span>
<span class="nc" id="L128">            } catch (CertificateParsingException e) {</span>
<span class="nc" id="L129">                throw new IllegalStateException(e);</span>
<span class="nc" id="L130">            }</span>
        }
<span class="nc" id="L132">        return certificate;</span>
    }

    @Override
    public int compareTo(final CertificateDataWrapper other) {
<span class="nc bnc" id="L137" title="All 4 branches missed.">        if (getCertificate()!=null &amp;&amp; other.getCertificate()!=null) {</span>
            // Sort descending by issuance date if certificates are available 
<span class="nc" id="L139">            return Long.valueOf(CertTools.getNotBefore(other.getCertificate()).getTime()).compareTo(CertTools.getNotBefore(getCertificate()).getTime());          </span>
        } else {
            // Sort descending by expiration date if certificates are not available        
<span class="nc" id="L142">            return Long.valueOf(other.getCertificateData().getExpireDate()).compareTo(getCertificateData().getExpireDate());</span>
        }
    }

    @Override
    public boolean equals(final Object other) {
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (!(other instanceof CertificateDataWrapper)) {</span>
<span class="nc" id="L149">            return false;</span>
        }
<span class="nc" id="L151">        final CertificateDataWrapper otherCertData = (CertificateDataWrapper) other;</span>
<span class="nc" id="L152">        return certificateData.equals(otherCertData.getCertificateData());</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L157">        return certificateData.hashCode();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>