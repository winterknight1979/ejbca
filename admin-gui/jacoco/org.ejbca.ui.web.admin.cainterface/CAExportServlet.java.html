<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CAExportServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Administration GUI</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.web.admin.cainterface</a> &gt; <span class="el_source">CAExportServlet.java</span></div><h1>CAExportServlet.java</h1><pre class="source lang-java linenums">package org.ejbca.ui.web.admin.cainterface;

import java.io.IOException;

import javax.ejb.EJB;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.log4j.Logger;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authorization.control.StandardRules;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.ca.CaSessionLocal;
import org.cesecore.util.StringTools;
import org.ejbca.core.ejb.ca.caadmin.CAAdminSessionLocal;
import org.ejbca.ui.web.RequestHelper;
import org.ejbca.ui.web.admin.cainterface.exception.AdminWebAuthenticationException;
import org.ejbca.ui.web.pub.ServletUtils;

/**
 * This Servlet exports a CA as an octet/stream.
 */
<span class="nc" id="L25">public class CAExportServlet extends BaseAdminServlet {</span>
<span class="nc" id="L26">	private static final Logger log = Logger.getLogger(CAExportServlet.class);</span>
	private static final long serialVersionUID = 378499368926058906L;
	public static final String HIDDEN_CANAME				= &quot;hiddencaname&quot;;
	public static final String TEXTFIELD_EXPORTCA_PASSWORD	= &quot;textfieldexportcapassword&quot;;
	
	@EJB
	private CAAdminSessionLocal caAdminSession;
	@EJB
	private CaSessionLocal caSession;

	/**
	 * Initialize.
	 */
	@Override
    public void init(ServletConfig config) throws ServletException {
<span class="nc" id="L41">        super.init(config);</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">    	if (caAdminSession==null) {</span>
<span class="nc" id="L43">    		log.error(&quot;Local EJB injection failed.&quot;);</span>
    	}
<span class="nc" id="L45">    }</span>

    /**
     * Handle HTTP Post. Redirect the request to doGet(..). 
     * This method should not be called explicitly.
     * 
     * @param req The request.
     * @param res The response.
     */
	@Override
    public void doPost(HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException {
<span class="nc" id="L56">	    log.trace(&quot;&gt;doPost()&quot;);</span>
<span class="nc" id="L57">	    doGet(req, res);</span>
<span class="nc" id="L58">	    log.trace(&quot;&lt;doPost()&quot;);</span>
<span class="nc" id="L59">    }</span>

    /**
     * Validates the request parameters and outputs the CA as an PKCS#12 output/octet-stream.
     * This method should not be called explicitly.
     * 
     * @param req The request.
     * @param res The response.
	 */
	@Override
    public void doGet(HttpServletRequest req,  HttpServletResponse res) throws IOException, ServletException {
<span class="nc" id="L70">        log.trace(&quot;&gt;doGet()&quot;);</span>
        final AuthenticationToken admin;
        try {
<span class="nc" id="L73">            admin = authenticateAdmin(req, res, StandardRules.ROLE_ROOT.resource());</span>
<span class="nc" id="L74">        } catch (AdminWebAuthenticationException authExc) {</span>
        	// TODO: localize this.
<span class="nc" id="L76">        	log.info(&quot;Authentication failed&quot;, authExc);</span>
<span class="nc" id="L77">            res.sendError(HttpServletResponse.SC_FORBIDDEN, &quot;Authentication failed&quot;);</span>
<span class="nc" id="L78">            return;</span>
<span class="nc" id="L79">        }</span>
<span class="nc" id="L80">	    RequestHelper.setDefaultCharacterEncoding(req);</span>
<span class="nc" id="L81">	    String caname = req.getParameter(HIDDEN_CANAME);</span>
<span class="nc" id="L82">	    String capassword = req.getParameter(TEXTFIELD_EXPORTCA_PASSWORD);</span>
<span class="nc" id="L83">	    log.info(&quot;Got request from &quot;+req.getRemoteAddr()+&quot; to export &quot;+caname);</span>
  		try{
<span class="nc" id="L85">    		byte[] keystorebytes = null;</span>
<span class="nc" id="L86">        	CAInfo cainfo = caSession.getCAInfo(admin, caname);</span>
<span class="nc" id="L87">        	String ext = &quot;p12&quot;; // Default for X.509 CAs</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        	if (cainfo.getCAType() == CAInfo.CATYPE_CVC) {</span>
<span class="nc" id="L89">        		ext = &quot;pkcs8&quot;;</span>
        	}
<span class="nc" id="L91">			keystorebytes = caAdminSession.exportCAKeyStore(admin, caname, capassword, capassword, &quot;SignatureKeyAlias&quot;, &quot;EncryptionKeyAlias&quot;);</span>
<span class="nc" id="L92">            ServletUtils.removeCacheHeaders(res);	// We must remove cache headers for IE</span>
<span class="nc" id="L93">        	res.setContentType(&quot;application/octet-stream&quot;);</span>
<span class="nc" id="L94">        	res.setContentLength(keystorebytes.length);</span>
<span class="nc" id="L95">        	res.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=\&quot;&quot; + StringTools.stripFilename(caname+&quot;.&quot;+ext) + &quot;\&quot;&quot;);</span>
<span class="nc" id="L96">	        res.getOutputStream().write(keystorebytes);</span>
<span class="nc" id="L97">  		} catch(Exception e) {</span>
  			//TODO: localize
<span class="nc" id="L99">  			log.info(&quot;Bad request&quot;, e);</span>
<span class="nc" id="L100">	        res.setContentType(&quot;text/plain&quot;);</span>
<span class="nc" id="L101">	        res.sendError( HttpServletResponse.SC_BAD_REQUEST, &quot;Bad request.&quot; );</span>
<span class="nc" id="L102">  		} </span>
<span class="nc" id="L103">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>