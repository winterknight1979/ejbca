<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApprovalProfilesMBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Administration GUI</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.web.admin.approval</a> &gt; <span class="el_source">ApprovalProfilesMBean.java</span></div><h1>ApprovalProfilesMBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.ui.web.admin.approval;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import javax.ejb.EJB;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.model.ListDataModel;

import org.apache.commons.lang.StringUtils;
import org.cesecore.authorization.AuthorizationDeniedException;
import org.cesecore.authorization.control.StandardRules;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.ca.CaSessionLocal;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.certificates.certificateprofile.CertificateProfileSessionLocal;
import org.cesecore.util.StringTools;
import org.ejbca.core.ejb.approval.ApprovalProfileDoesNotExistException;
import org.ejbca.core.ejb.approval.ApprovalProfileExistsException;
import org.ejbca.core.ejb.approval.ApprovalProfileSessionLocal;
import org.ejbca.core.model.approval.profile.AccumulativeApprovalProfile;
import org.ejbca.core.model.approval.profile.ApprovalProfile;
import org.ejbca.ui.web.admin.BaseManagedBean;

/**
 * JSF MBean backing the approval profiles page.
 * @version $Id: ApprovalProfilesMBean.java 28844 2018-05-04 08:31:02Z samuellb $
 * TODO: Use CDI beans
 */
@SuppressWarnings(&quot;deprecation&quot;)
@SessionScoped
@ManagedBean(name=&quot;approvalProfilesMBean&quot;)
<span class="nc" id="L52">public class ApprovalProfilesMBean extends BaseManagedBean implements Serializable {</span>

    private static final long serialVersionUID = -2452049885728885525L;
        
    public class ApprovalProfileGuiInfo {
        private final int id;
        private final String name;
<span class="nc" id="L59">        public ApprovalProfileGuiInfo(final int id, final String name) {</span>
<span class="nc" id="L60">            this.name = name;</span>
<span class="nc" id="L61">            this.id = id;</span>
<span class="nc" id="L62">        }</span>
<span class="nc" id="L63">        public int getId() { return this.id; }</span>
<span class="nc" id="L64">        public String getName() { return this.name; }</span>
    }
    
    
    @EJB
    private ApprovalProfileSessionLocal approvalProfileSession;

<span class="nc" id="L71">    private boolean renameInProgress = false;</span>
<span class="nc" id="L72">    private boolean deleteInProgress = false;</span>
<span class="nc" id="L73">    private boolean addFromTemplateInProgress = false;</span>
<span class="nc" id="L74">    private ListDataModel&lt;ApprovalProfileGuiInfo&gt; approvalProfilesList = null;</span>
<span class="nc" id="L75">    private String approvalProfileName = &quot;&quot;;</span>
<span class="nc" id="L76">    private Integer selectedApprovalProfileId = null;</span>
<span class="nc" id="L77">    private boolean viewOnly = true;</span>
    
    public Integer getSelectedApprovalProfileId() {
<span class="nc" id="L80">        return selectedApprovalProfileId;</span>
    }

    public void setSelectedApprovalProfileId(final Integer selectedApprovalProfileId) {
<span class="nc" id="L84">        this.selectedApprovalProfileId = selectedApprovalProfileId;</span>
<span class="nc" id="L85">    }</span>
    
    public String getSelectedApprovalProfileName() {
<span class="nc" id="L88">        final Integer profileId = getSelectedApprovalProfileId();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (profileId != null) {</span>
<span class="nc" id="L90">            return approvalProfileSession.getApprovalProfileName(profileId.intValue());</span>
        }
<span class="nc" id="L92">        return null;</span>
    }
    
    public boolean isRenameInProgress() {
<span class="nc" id="L96">        return renameInProgress;</span>
    }
    
    public boolean isDeleteInProgress() {
<span class="nc" id="L100">        return deleteInProgress;</span>
    }
    
    public boolean isAddFromTemplateInProgress() {
<span class="nc" id="L104">        return addFromTemplateInProgress;</span>
    }
    
    public boolean isOperationInProgress() {
<span class="nc bnc" id="L108" title="All 6 branches missed.">        return isRenameInProgress() || isDeleteInProgress() || isAddFromTemplateInProgress();</span>
    }
    
    public void selectCurrentRowData() {
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (approvalProfilesList == null) {</span>
<span class="nc" id="L113">            getApprovalProfiles();</span>
        }
<span class="nc" id="L115">        final ApprovalProfileGuiInfo approvalProfileItem = approvalProfilesList.getRowData();</span>
<span class="nc" id="L116">        selectedApprovalProfileId = approvalProfileItem.getId();</span>
<span class="nc" id="L117">    }</span>

    public ListDataModel&lt;ApprovalProfileGuiInfo&gt; getApprovalProfiles() {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (approvalProfilesList == null) {</span>
<span class="nc" id="L121">            final List&lt;ApprovalProfileGuiInfo&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L122">            final List&lt;Integer&gt; authorizedProfileIds = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L124">            authorizedProfileIds.addAll(approvalProfileSession.getAuthorizedApprovalProfileIds(getAdmin()));</span>
<span class="nc" id="L125">            final Map&lt;Integer, String&gt; idToNameMap = approvalProfileSession.getApprovalProfileIdToNameMap();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            for (Integer profileId : authorizedProfileIds) {</span>
<span class="nc" id="L127">                final String name = idToNameMap.get(profileId);</span>
<span class="nc" id="L128">                items.add(new ApprovalProfileGuiInfo(profileId, name));</span>
<span class="nc" id="L129">            }</span>
            // Sort list by name
<span class="nc" id="L131">            Collections.sort(items, new Comparator&lt;ApprovalProfileGuiInfo&gt;() {</span>
                @Override
                public int compare(final ApprovalProfileGuiInfo a, final ApprovalProfileGuiInfo b) {
<span class="nc" id="L134">                    return a.getName().compareToIgnoreCase(b.getName());</span>
                }
            });
<span class="nc" id="L137">            approvalProfilesList = new ListDataModel&lt;&gt;(items);</span>
        }
<span class="nc" id="L139">        return approvalProfilesList;</span>
    }
    
    public String getResetApprovalProfilesTrigger() {
<span class="nc" id="L143">        approvalProfilesList = null;</span>
<span class="nc" id="L144">        return &quot;&quot;;</span>
    }
    
    public boolean isAuthorizedToEdit() {
<span class="nc" id="L148">        return isAuthorizedTo(StandardRules.APPROVALPROFILEEDIT.resource());</span>
    }
    
    public String getApprovalProfileName() {
<span class="nc" id="L152">        return approvalProfileName;</span>
    }
    
    public void setApprovalProfileName(String approvalProfileName) {
<span class="nc" id="L156">        approvalProfileName = approvalProfileName.trim();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (StringTools.checkFieldForLegalChars(approvalProfileName)) {</span>
<span class="nc" id="L158">            addErrorMessage(&quot;ONLYCHARACTERS&quot;);</span>
        } else {
<span class="nc" id="L160">            this.approvalProfileName = approvalProfileName;</span>
        }
<span class="nc" id="L162">    }</span>
    
    public String actionView() {
<span class="nc" id="L165">        selectCurrentRowData();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (selectedProfileExists()) {</span>
<span class="nc" id="L167">            viewOnly = true;</span>
<span class="nc" id="L168">            return &quot;view&quot;; // Outcome is defined in faces-config.xml</span>
        } else {
<span class="nc" id="L170">            return &quot;&quot;;</span>
        }
    }
    
    public String actionEdit() {
<span class="nc" id="L175">        selectCurrentRowData();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (selectedProfileExists()) {</span>
<span class="nc" id="L177">            viewOnly = false;</span>
<span class="nc" id="L178">            return &quot;edit&quot;; </span>
        } else {
<span class="nc" id="L180">            return &quot;&quot;;</span>
        }
    }
    
    public boolean getViewOnly() {
<span class="nc" id="L185">        return viewOnly;</span>
    }
    
    public void actionCancel() {
<span class="nc" id="L189">        addFromTemplateInProgress = false;</span>
<span class="nc" id="L190">        deleteInProgress = false;</span>
<span class="nc" id="L191">        renameInProgress = false;</span>
<span class="nc" id="L192">        approvalProfilesList = null;</span>
<span class="nc" id="L193">        selectedApprovalProfileId = null;</span>
<span class="nc" id="L194">        approvalProfileName = null;</span>
<span class="nc" id="L195">    }</span>
    

    
    
    public void actionDelete() {
<span class="nc" id="L201">        selectCurrentRowData();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (selectedProfileExists()) {</span>
<span class="nc" id="L203">            deleteInProgress = true;</span>
        }
<span class="nc" id="L205">    }</span>
    public void actionDeleteConfirm() {
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (canDeleteApprovalProfile()) {</span>
            try {
<span class="nc" id="L209">                approvalProfileSession.removeApprovalProfile(getAdmin(), getSelectedApprovalProfileId());</span>
<span class="nc" id="L210">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L211">                addNonTranslatedErrorMessage(&quot;Not authorized to remove approval profile.&quot;);</span>
<span class="nc" id="L212">            }</span>
        } else {
<span class="nc" id="L214">            addErrorMessage(&quot;COULDNTDELETEAPPROVALPROF&quot;);</span>
        }
<span class="nc" id="L216">        actionCancel();</span>
<span class="nc" id="L217">    }</span>
    private boolean canDeleteApprovalProfile() {
<span class="nc" id="L219">        boolean ret = true;</span>
<span class="nc" id="L220">        final int approvalProfileId = getSelectedApprovalProfileId().intValue();</span>
        // Check if approval profile is in use by any certificate profile
<span class="nc" id="L222">        final List&lt;String&gt; certProfilesReferencingAP = getCertProfilesUsingApprovalProfile(approvalProfileId);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (!certProfilesReferencingAP.isEmpty()) {</span>
<span class="nc" id="L224">            ret = false;</span>
<span class="nc" id="L225">            addNonTranslatedErrorMessage(getEjbcaWebBean().getText(&quot;APPROVALPROFILEUSEDINCERTPROFILES&quot;) + &quot; &quot;</span>
<span class="nc" id="L226">                        + getAsCommaSeparatedString(certProfilesReferencingAP)); </span>
            }
        
        // Check if approval profile is in use by a CA
<span class="nc" id="L230">        final List&lt;String&gt; casReferencingAP = getCAsUsingApprovalProfile(approvalProfileId);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (!casReferencingAP.isEmpty()) {</span>
<span class="nc" id="L232">            ret = false;</span>
<span class="nc" id="L233">            addNonTranslatedErrorMessage(getEjbcaWebBean().getText(&quot;APPROVALPROFILEUSEDINCAS&quot;) + &quot; &quot;</span>
<span class="nc" id="L234">                    + getAsCommaSeparatedString(casReferencingAP)); </span>
        }
        // TODO check whether an approval profiles is referenced in a waiting approval request
        
<span class="nc" id="L238">        return ret;</span>
    }
    public List&lt;String&gt; getCertProfilesUsingApprovalProfile(final int approvalProfileId) {
<span class="nc" id="L241">        final CertificateProfileSessionLocal certProfileSession = getEjbcaWebBean().getEjb().getCertificateProfileSession();</span>
<span class="nc" id="L242">        Map&lt;Integer, CertificateProfile&gt; allCertProfiles = certProfileSession.getAllCertificateProfiles();</span>
<span class="nc" id="L243">        Set&lt;Entry&lt;Integer, CertificateProfile&gt;&gt; entries = allCertProfiles.entrySet();</span>
<span class="nc" id="L244">        List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        for(Entry&lt;Integer, CertificateProfile&gt; entry : entries) {</span>
<span class="nc" id="L246">            final CertificateProfile certProfile = entry.getValue();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            if(certProfile.getApprovals().containsValue(Integer.valueOf(approvalProfileId))) {</span>
<span class="nc" id="L248">                result.add(certProfileSession.getCertificateProfileName(entry.getKey()));</span>
            }
<span class="nc" id="L250">        }</span>
<span class="nc" id="L251">        return result;</span>
    }
    
    public List&lt;String&gt; getCAsUsingApprovalProfile(final int approvalProfileId) {
<span class="nc" id="L255">        final CaSessionLocal caSession = getEjbcaWebBean().getEjb().getCaSession();</span>
<span class="nc" id="L256">        List&lt;Integer&gt; allCas = caSession.getAllCaIds();</span>
<span class="nc" id="L257">        List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (int caid : allCas) {</span>
<span class="nc" id="L259">            CAInfo cainfo = caSession.getCAInfoInternal(caid);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            if (cainfo.getApprovals().containsValue(Integer.valueOf(approvalProfileId))) {</span>
<span class="nc" id="L261">                result.add(cainfo.getName());</span>
            }
<span class="nc" id="L263">        }</span>
<span class="nc" id="L264">        return result;</span>
    } 
    
    private String getAsCommaSeparatedString(final List&lt;String&gt; list) {
<span class="nc" id="L268">        final StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        for (final String entry : list) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (sb.length() &gt; 0) {</span>
<span class="nc" id="L271">                sb.append(&quot;, &quot;);</span>
            }
<span class="nc" id="L273">            sb.append(entry);</span>
<span class="nc" id="L274">        }</span>
<span class="nc" id="L275">        return sb.toString();</span>
    }
    
    public void actionRename() {
<span class="nc" id="L279">        selectCurrentRowData();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (selectedProfileExists()) {</span>
<span class="nc" id="L281">            renameInProgress = true;</span>
        }
<span class="nc" id="L283">    }</span>

    public void actionRenameConfirm() {
<span class="nc" id="L286">        final String approvalProfileName = getApprovalProfileName();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(approvalProfileName)) {</span>
            try {
<span class="nc" id="L289">                approvalProfileSession.renameApprovalProfile(getAdmin(), approvalProfileSession.getApprovalProfile(getSelectedApprovalProfileId()),</span>
                        approvalProfileName);
<span class="nc" id="L291">                setApprovalProfileName(&quot;&quot;);</span>
<span class="nc" id="L292">            } catch (ApprovalProfileExistsException | ApprovalProfileDoesNotExistException e) {</span>
<span class="nc" id="L293">                addErrorMessage(e.getLocalizedMessage());</span>
<span class="nc" id="L294">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L295">                addNonTranslatedErrorMessage(&quot;Not authorized to rename certificate profile.&quot;);</span>
<span class="nc" id="L296">            }</span>
        }
<span class="nc" id="L298">        actionCancel();</span>
<span class="nc" id="L299">    }</span>
    
    public void actionAddFromTemplate() {
<span class="nc" id="L302">        selectCurrentRowData();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (selectedProfileExists()) {</span>
<span class="nc" id="L304">            addFromTemplateInProgress = true;</span>
        }
<span class="nc" id="L306">    }</span>
    
    public void actionAddFromTemplateConfirm() {
<span class="nc" id="L309">        final String approvalProfileName = getApprovalProfileName();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(approvalProfileName)) {</span>
            try {
<span class="nc" id="L312">                approvalProfileSession.cloneApprovalProfile(getAdmin(), approvalProfileSession.getApprovalProfile(getSelectedApprovalProfileId()),</span>
                        approvalProfileName);
<span class="nc" id="L314">                setApprovalProfileName(&quot;&quot;);</span>
<span class="nc" id="L315">            } catch (ApprovalProfileExistsException | ApprovalProfileDoesNotExistException | AuthorizationDeniedException e) {</span>
<span class="nc" id="L316">                addNonTranslatedErrorMessage(e.getLocalizedMessage());</span>
<span class="nc" id="L317">            }</span>
            
        }
<span class="nc" id="L320">        actionCancel();</span>
<span class="nc" id="L321">    }</span>
    
    /** @return true if there exists an approval profile with the selected id */
    private boolean selectedProfileExists() {
<span class="nc bnc" id="L325" title="All 2 branches missed.">        return getEjbcaWebBean().getEjb().getApprovalProfileSession().getApprovalProfile(selectedApprovalProfileId) != null;</span>
    }
    
    public void actionAdd() {
        
<span class="nc" id="L330">        final String approvalProfileName = getApprovalProfileName();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(approvalProfileName)) {</span>
           try {
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if(!approvalProfileSession.findByApprovalProfileName(approvalProfileName).isEmpty()) {</span>
                    //Handle this below
<span class="nc" id="L335">                    throw new ApprovalProfileExistsException(&quot;Approval profile of name &quot; + approvalProfileName + &quot; already exists&quot;);</span>
                }
<span class="nc" id="L337">                final ApprovalProfile approvalProfile = new AccumulativeApprovalProfile(approvalProfileName);</span>
<span class="nc" id="L338">                approvalProfileSession.addApprovalProfile(getAdmin(), approvalProfile);</span>
<span class="nc" id="L339">                setApprovalProfileName(&quot;&quot;);</span>
<span class="nc" id="L340">            } catch (ApprovalProfileExistsException e) {</span>
<span class="nc" id="L341">                addErrorMessage(&quot;APPROVAL_PROFILE_ALREADY_EXISTS&quot;);</span>
<span class="nc" id="L342">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L343">                addNonTranslatedErrorMessage(&quot;Not authorized to add approval profile.&quot;);</span>
<span class="nc" id="L344">            }</span>
        }
<span class="nc" id="L346">        approvalProfilesList = null;</span>
<span class="nc" id="L347">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>