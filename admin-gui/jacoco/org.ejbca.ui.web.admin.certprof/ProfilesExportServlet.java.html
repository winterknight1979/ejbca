<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProfilesExportServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Administration GUI</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.web.admin.certprof</a> &gt; <span class="el_source">ProfilesExportServlet.java</span></div><h1>ProfilesExportServlet.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.ui.web.admin.certprof;

import java.beans.XMLEncoder;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Collection;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.ejb.EJB;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authorization.AuthorizationSessionLocal;
import org.cesecore.authorization.control.StandardRules;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.certificates.certificateprofile.CertificateProfileConstants;
import org.cesecore.certificates.certificateprofile.CertificateProfileSessionLocal;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.configuration.GlobalConfigurationSessionLocal;
import org.cesecore.internal.UpgradeableDataHashMap;
import org.cesecore.keys.validation.KeyValidatorSessionLocal;
import org.cesecore.util.StringTools;
import org.ejbca.config.GlobalConfiguration;
import org.ejbca.core.ejb.authentication.web.WebAuthenticationProviderSessionLocal;
import org.ejbca.core.ejb.ra.raadmin.EndEntityProfileSessionLocal;
import org.ejbca.core.model.authorization.AccessRulesConstants;
import org.ejbca.core.model.ra.raadmin.EndEntityProfile;
import org.ejbca.ui.web.admin.cainterface.BaseAdminServlet;
import org.ejbca.ui.web.admin.cainterface.exception.AdminWebAuthenticationException;

/**
 * Servlet used to export certificate profiles and end entity profiles in a downloadable zip file.&lt;br&gt;
 *
 * The servlet is called with method GET or POST and syntax
 * &lt;code&gt;profileType=&amp;lt;type&amp;gt;&lt;/code&gt;.
 * &lt;p&gt;The following types are supported:&lt;br&gt;
 * &lt;ul&gt;
 * &lt;li&gt;cp - Certificate Profiles&lt;/li&gt;
 * &lt;li&gt;eep - End Entity Profiles &lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @version $Id: ProfilesExportServlet.java 34154 2019-12-23 13:38:17Z samuellb $
 */
<span class="nc" id="L69">public class ProfilesExportServlet extends BaseAdminServlet {</span>

    private static final long serialVersionUID = -8091852234056712787L;
<span class="nc" id="L72">    private static final Logger log = Logger.getLogger(ProfilesExportServlet.class);</span>

    @EJB
    private AuthorizationSessionLocal authorizationSession;
    @EJB
    private CertificateProfileSessionLocal certificateProfileSession;
    @EJB
    private EndEntityProfileSessionLocal endEntityProfileSession;
    @EJB
    private KeyValidatorSessionLocal keyValidatorSession;
    @EJB
    private GlobalConfigurationSessionLocal globalConfigurationSession;
    @EJB
    private WebAuthenticationProviderSessionLocal authenticationSession;

    @Override
    public void init(ServletConfig config) throws ServletException {
<span class="nc" id="L89">        super.init(config);</span>
<span class="nc" id="L90">    }</span>

    @Override
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
<span class="nc" id="L94">        log.trace(&quot;&gt;doPost()&quot;);</span>
<span class="nc" id="L95">        doGet(request, response);</span>
<span class="nc" id="L96">        log.trace(&quot;&lt;doPost()&quot;);</span>
<span class="nc" id="L97">    }</span>

    @Override
    public void doGet(HttpServletRequest request,  HttpServletResponse response) throws IOException, ServletException {
<span class="nc" id="L101">        log.trace(&quot;&gt;doGet()&quot;);</span>
        final AuthenticationToken admin;
        try {
<span class="nc" id="L104">            admin = authenticateAdmin(request, response, AccessRulesConstants.ROLE_ADMINISTRATOR);</span>
<span class="nc" id="L105">        } catch (AdminWebAuthenticationException authExc) {</span>
        	// TODO: localize this.
<span class="nc" id="L107">        	log.info(&quot;Authentication failed&quot;, authExc);</span>
<span class="nc" id="L108">            response.sendError(HttpServletResponse.SC_FORBIDDEN, &quot;Authentication failed&quot;);</span>
<span class="nc" id="L109">            return;</span>
<span class="nc" id="L110">        }</span>

<span class="nc" id="L112">        final String type = request.getParameter(&quot;profileType&quot;);</span>
<span class="nc" id="L113">        final boolean exportCertificateProfiles = StringUtils.equalsIgnoreCase(type, &quot;cp&quot;);</span>
<span class="nc" id="L114">        final boolean exportEndEntityProfiles = StringUtils.equalsIgnoreCase(type, &quot;eep&quot;);</span>

<span class="nc" id="L116">        String zipfilename = null;</span>
<span class="nc" id="L117">        int exportedprofiles = 0;</span>
<span class="nc" id="L118">        int totalprofiles = 0;</span>
<span class="nc" id="L119">        int missingprofiles = 0;</span>
<span class="nc" id="L120">        ByteArrayOutputStream zbaos = new ByteArrayOutputStream();</span>
<span class="nc" id="L121">        ZipOutputStream zos = new ZipOutputStream(zbaos);</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (exportCertificateProfiles) {</span>
<span class="nc" id="L124">            zipfilename = &quot;certprofiles.zip&quot;;</span>

<span class="nc" id="L126">            final List&lt;Integer&gt; certificateProfileTypes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L127">            certificateProfileTypes.add(CertificateConstants.CERTTYPE_ENDENTITY);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (authorizationSession.isAuthorizedNoLogging(admin, StandardRules.ROLE_ROOT.resource())) {</span>
                //Only root users may use CA profiles
<span class="nc" id="L130">                certificateProfileTypes.add(CertificateConstants.CERTTYPE_ROOTCA);</span>
<span class="nc" id="L131">                certificateProfileTypes.add(CertificateConstants.CERTTYPE_SUBCA);</span>
            }
<span class="nc" id="L133">            GlobalConfiguration globaConfiguration = (GlobalConfiguration) globalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (globaConfiguration.getIssueHardwareTokens()) {</span>
<span class="nc" id="L135">                certificateProfileTypes.add(CertificateConstants.CERTTYPE_HARDTOKEN);</span>
            }

<span class="nc" id="L138">            Collection&lt;Integer&gt; certprofids = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for(Integer certificateProfileType : certificateProfileTypes) {</span>
<span class="nc" id="L140">                certprofids.addAll(certificateProfileSession.getAuthorizedCertificateProfileIds(admin, certificateProfileType));</span>
<span class="nc" id="L141">            }</span>

<span class="nc" id="L143">            totalprofiles = certprofids.size();</span>
<span class="nc" id="L144">            log.info(&quot;Exporting non-fixed certificate profiles&quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            for (int profileid : certprofids) {</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (profileid == CertificateProfileConstants.CERTPROFILE_NO_PROFILE) { // Certificate profile not found i database.</span>
<span class="nc" id="L147">                    log.error(&quot;Couldn't find certificate profile '&quot; + profileid + &quot;' in database.&quot;);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                } else if (CertificateProfileConstants.isFixedCertificateProfile(profileid)) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L150">                        log.debug(&quot;Skipping export fixed certificate profile with id '&quot; + profileid + &quot;'.&quot;);</span>
                    }
                } else {
<span class="nc" id="L153">                    String profilename = certificateProfileSession.getCertificateProfileName(profileid);</span>
<span class="nc" id="L154">                    CertificateProfile profile = certificateProfileSession.getCertificateProfile(profileid);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if (profile == null) {</span>
<span class="nc" id="L156">                        missingprofiles++;</span>
<span class="nc" id="L157">                        log.error(&quot;Couldn't find certificate profile '&quot; + profilename + &quot;'-&quot; + profileid + &quot; in database.&quot;);</span>
                    } else {
                        String profilenameEncoded;
                        try {
<span class="nc" id="L161">                            profilenameEncoded = URLEncoder.encode(profilename, &quot;UTF-8&quot;);</span>
<span class="nc" id="L162">                        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L163">                            throw new IllegalStateException(&quot;UTF-8 was not a known encoding&quot;, e);</span>
<span class="nc" id="L164">                        }</span>

<span class="nc" id="L166">                        byte[] ba = getProfileBytes(profile);</span>
<span class="nc" id="L167">                        String filename = &quot;certprofile_&quot; + profilenameEncoded + &quot;-&quot; + profileid + &quot;.xml&quot;;</span>
<span class="nc" id="L168">                        ZipEntry ze = new ZipEntry(filename);</span>
<span class="nc" id="L169">                        zos.putNextEntry(ze);</span>
<span class="nc" id="L170">                        zos.write(ba);</span>
<span class="nc" id="L171">                        zos.closeEntry();</span>
<span class="nc" id="L172">                        exportedprofiles++;</span>
                    }
                }
<span class="nc" id="L175">            }</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">        } else if (exportEndEntityProfiles) {</span>

<span class="nc" id="L179">            zipfilename = &quot;entityprofiles.zip&quot;;</span>

<span class="nc" id="L181">            Collection&lt;Integer&gt; endentityprofids = endEntityProfileSession.getAuthorizedEndEntityProfileIds(admin, AccessRulesConstants.VIEW_END_ENTITY);</span>
<span class="nc" id="L182">            totalprofiles = endentityprofids.size();</span>
<span class="nc" id="L183">            log.info(&quot;Exporting non-fixed end entity profiles&quot;);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            for (int profileid : endentityprofids) {</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                if (profileid == EndEntityConstants.NO_END_ENTITY_PROFILE) { // Entity profile not found i database.</span>
<span class="nc" id="L186">                    missingprofiles++;</span>
<span class="nc" id="L187">                    log.error(&quot;Error : Couldn't find entity profile '&quot; + profileid + &quot;' in database.&quot;);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                } else if (profileid == EndEntityConstants.EMPTY_END_ENTITY_PROFILE) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if(log.isDebugEnabled()) {</span>
<span class="nc" id="L190">                        log.debug(&quot;Skipping export fixed end entity profile with id '&quot;+profileid+&quot;'.&quot;);</span>
                    }
                } else {
<span class="nc" id="L193">                    String profilename = endEntityProfileSession.getEndEntityProfileName(profileid);</span>
<span class="nc" id="L194">                    EndEntityProfile profile = endEntityProfileSession.getEndEntityProfile(profileid);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    if (profile == null) {</span>
<span class="nc" id="L196">                        log.error(&quot;Error : Couldn't find entity profile '&quot; + profilename + &quot;'-&quot; + profileid + &quot; in database.&quot;);</span>
                    } else {
                        String profilenameEncoded;
                        try {
<span class="nc" id="L200">                            profilenameEncoded = URLEncoder.encode(profilename, &quot;UTF-8&quot;);</span>
<span class="nc" id="L201">                        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L202">                            throw new IllegalStateException(&quot;UTF-8 was not a known encoding&quot;, e);</span>
<span class="nc" id="L203">                        }</span>

<span class="nc" id="L205">                        byte[] ba = getProfileBytes(profile);</span>
<span class="nc" id="L206">                        String filename = &quot;entityprofile_&quot; + profilenameEncoded + &quot;-&quot; + profileid + &quot;.xml&quot;;</span>
<span class="nc" id="L207">                        ZipEntry ze = new ZipEntry(filename);</span>
<span class="nc" id="L208">                        zos.putNextEntry(ze);</span>
<span class="nc" id="L209">                        zos.write(ba);</span>
<span class="nc" id="L210">                        zos.closeEntry();</span>

<span class="nc" id="L212">                        exportedprofiles++;</span>
                    }
                }
<span class="nc" id="L215">            }</span>
        }
<span class="nc" id="L217">        zos.close();</span>

<span class="nc" id="L219">        final byte[] zipfile = zbaos.toByteArray();</span>
<span class="nc" id="L220">        zbaos.close();</span>

<span class="nc" id="L222">        log.info(&quot;Found &quot; + totalprofiles + &quot; profiles. &quot; + exportedprofiles + &quot; profiles were exported to &quot; + zipfilename + &quot; and &quot; + missingprofiles</span>
                + &quot; were not found in the database.&quot;);

<span class="nc" id="L225">        response.setContentType(&quot;application/octet-stream&quot;);</span>
<span class="nc" id="L226">        response.setHeader(&quot;Content-disposition&quot;, &quot; attachment; filename=\&quot;&quot; + StringTools.stripFilename(zipfilename) + &quot;\&quot;&quot;);</span>
<span class="nc" id="L227">        response.getOutputStream().write(zipfile);</span>
<span class="nc" id="L228">        response.flushBuffer();</span>

<span class="nc" id="L230">        log.trace(&quot;&lt;doGet()&quot;);</span>
<span class="nc" id="L231">    } // doGet</span>

    private byte[] getProfileBytes(UpgradeableDataHashMap profile) {
<span class="nc" id="L234">        final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L235">        try (XMLEncoder encoder = new XMLEncoder(baos)) {</span>
<span class="nc" id="L236">            encoder.writeObject(profile.saveData());</span>
<span class="nc" id="L237">            encoder.close();</span>
<span class="nc" id="L238">            return baos.toByteArray();</span>
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>