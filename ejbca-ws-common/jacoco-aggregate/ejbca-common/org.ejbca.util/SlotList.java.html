<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SlotList.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-ws-common</a> &gt; <a href="../index.html" class="el_bundle">ejbca-common</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.util</a> &gt; <span class="el_source">SlotList.java</span></div><h1>SlotList.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.util;

import java.util.TreeSet;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * A list of slots numbers and indexes. Can contain ranges and individual entries.
 * 
 * @version $Id: SlotList.java 22117 2015-10-29 10:53:42Z mikekushner $
 */
<span class="nc" id="L24">public class SlotList {</span>
    
    private static final class Range implements Comparable&lt;Range&gt; { 
        public final int min, max;
<span class="nc" id="L28">        public Range(int min, int max) {</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">            if (min &gt; max) {</span>
<span class="nc" id="L30">                throw new IllegalArgumentException(&quot;Minimum value (&quot;+min+&quot;) in slot range is greater than maximum value (&quot;+max+&quot;)&quot;);</span>
            }
<span class="nc" id="L32">            this.min = min;</span>
<span class="nc" id="L33">            this.max = max;</span>
<span class="nc" id="L34">        }</span>
        
        @Override
        public int compareTo(Range o) {
<span class="nc bnc" id="L38" title="All 2 branches missed.">            if (min &lt; o.min) return -1;</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">            if (min &gt; o.min) return 1;</span>
<span class="nc" id="L40">            else return 0;</span>
        }
    }
    
<span class="nc" id="L44">    private final TreeSet&lt;Range&gt; ranges = new TreeSet&lt;Range&gt;();</span>
<span class="nc" id="L45">    private final TreeSet&lt;Range&gt; indexRanges = new TreeSet&lt;Range&gt;();</span>
    
    
    private int intval(String s, int defaultValue) {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        return s != null ? Integer.valueOf(s) : defaultValue;</span>
    }
    
    private void addRange(Matcher m, int groupMin, int groupMax) {
<span class="nc" id="L53">        final int min = intval(m.group(groupMin), Integer.MIN_VALUE);</span>
<span class="nc" id="L54">        final int max = intval(m.group(groupMax), Integer.MAX_VALUE);</span>
<span class="nc" id="L55">        addRangeTo(ranges, min, max);</span>
        
<span class="nc" id="L57">    }</span>
    
    private void addIndexRange(Matcher m, int groupMin, int groupMax) {
<span class="nc" id="L60">        final int min = intval(m.group(groupMin), Integer.MIN_VALUE);</span>
<span class="nc" id="L61">        final int max = intval(m.group(groupMax), Integer.MAX_VALUE);</span>
<span class="nc" id="L62">        addRangeTo(indexRanges, min, max);</span>
<span class="nc" id="L63">    }</span>
    
    private void addRangeTo(TreeSet&lt;Range&gt; r, int min, int max) {
<span class="nc" id="L66">        Range toAdd = new Range(min, max);</span>
        
        // Check for overlap with lower numbers
<span class="nc" id="L69">        final Range lower = r.floor(toAdd);</span>
<span class="nc bnc" id="L70" title="All 6 branches missed.">        if (lower != null &amp;&amp; (lower.max &gt;= min-1 || lower.max &gt;= min)) { // special handling for integer overflows</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (lower.max &gt;= max) return; // complete overlap</span>
<span class="nc" id="L72">            min = lower.min; // expand self</span>
<span class="nc" id="L73">            toAdd = new Range(min, max);</span>
<span class="nc" id="L74">            r.remove(lower);</span>
        }
        
        // Check for overlap with higher numbers
<span class="nc" id="L78">        final Range higher = r.ceiling(toAdd);</span>
<span class="nc bnc" id="L79" title="All 6 branches missed.">        if (higher != null &amp;&amp; (higher.min &lt;= max+1 || higher.min &lt;= max)) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (higher.min &lt;= min) return; // complete overlap</span>
<span class="nc" id="L81">            max = higher.max;</span>
<span class="nc" id="L82">            toAdd = new Range(min, max); // expand self</span>
<span class="nc" id="L83">            r.remove(higher);</span>
        }
        
<span class="nc" id="L86">        r.add(toAdd);</span>
<span class="nc" id="L87">    }</span>
    
    
<span class="nc" id="L90">    private static final Pattern slotListSingle = Pattern.compile(&quot;^([0-9]+)$&quot;);</span>
<span class="nc" id="L91">    private static final Pattern slotListRange = Pattern.compile(&quot;^([0-9]+)?-([0-9]+)?$&quot;);</span>
<span class="nc" id="L92">    private static final Pattern slotListISingle = Pattern.compile(&quot;^i([0-9]+)$&quot;);</span>
<span class="nc" id="L93">    private static final Pattern slotListIRange = Pattern.compile(&quot;^i([0-9]+)?-i([0-9]+)?$&quot;);</span>
    
    public static SlotList fromString(String s) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (s == null) return null;</span>
<span class="nc" id="L97">        final SlotList sl = new SlotList();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (s.trim().isEmpty()) return sl;</span>
        
<span class="nc bnc" id="L100" title="All 2 branches missed.">        for (String piece : s.split(&quot;,&quot;)) {</span>
<span class="nc" id="L101">            piece = piece.trim();</span>
            Matcher m;
            
            // Single entries
<span class="nc" id="L105">            m = slotListSingle.matcher(piece);</span>
            // create a range from the first matcher group
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (m.find()) { sl.addRange(m, 1, 1); continue; }</span>
            
<span class="nc" id="L109">            m = slotListISingle.matcher(piece);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (m.find()) { sl.addIndexRange(m, 1, 1); continue; }</span>
            
            
            // Range entries
<span class="nc" id="L114">            m = slotListRange.matcher(piece);</span>
            // create a range from the matcher groups 1 and 2
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (m.find()) { sl.addRange(m, 1, 2); continue; }</span>
            
<span class="nc" id="L118">            m = slotListIRange.matcher(piece);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            if (m.find()) { sl.addIndexRange(m, 1, 2); continue; }</span>
            
<span class="nc" id="L121">            throw new IllegalArgumentException(&quot;Invalid syntax of slot number or range: &quot;+piece);</span>
        }
        
<span class="nc" id="L124">        return sl;</span>
    }
    
    public boolean contains(String slot) {
<span class="nc" id="L128">        final boolean isIndexed = slot.startsWith(&quot;i&quot;);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        final int number = Integer.valueOf(isIndexed ? slot.substring(1) : slot);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        final TreeSet&lt;Range&gt; tree = (isIndexed ? indexRanges : ranges);</span>
        
<span class="nc" id="L132">        Range lower = tree.floor(new Range(number, number));</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">        return lower != null &amp;&amp; number &lt;= lower.max;</span>
    }
    
    @Override
    public String toString() {
<span class="nc" id="L138">        StringBuilder sb = new StringBuilder();</span>
        
        // Slot numbers
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (Range r : ranges) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (r.min != Integer.MIN_VALUE) {</span>
<span class="nc" id="L143">                sb.append(r.min);</span>
            }
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (r.min != r.max) {</span>
<span class="nc" id="L146">                sb.append('-');</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                if (r.max != Integer.MAX_VALUE) {</span>
<span class="nc" id="L148">                    sb.append(r.max);</span>
                }
            }
<span class="nc" id="L151">            sb.append(&quot;, &quot;);</span>
<span class="nc" id="L152">        }</span>
        
        // Slot index numbers
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (Range r : indexRanges) {</span>
<span class="nc" id="L156">            sb.append('i');</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (r.min != Integer.MIN_VALUE) {</span>
<span class="nc" id="L158">                sb.append(r.min);</span>
            }
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (r.min != r.max) {</span>
<span class="nc" id="L161">                sb.append(&quot;-i&quot;);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (r.max != Integer.MAX_VALUE) {</span>
<span class="nc" id="L163">                    sb.append(r.max);</span>
                }
            }
<span class="nc" id="L166">            sb.append(&quot;, &quot;);</span>
<span class="nc" id="L167">        }</span>
        
        // Remove trailing comma
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (sb.length() &gt; 1) {</span>
<span class="nc" id="L171">            sb.delete(sb.length()-2, sb.length());</span>
        }
        
<span class="nc" id="L174">        return sb.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>