<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from org.apache.maven.plugins:maven-pmd-plugin:3.13.0:cpd at 2020-09-30
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>EJBCA EJB Library &#x2013; CPD Results</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-1.9.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h2>EJBCA EJB Library</h2>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-09-30<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.0.0-SNAPSHOT</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-down"></span>Project Reports</a>
     <ul class="nav nav-list">
      <li><a href="xref/index.html" title="Source Xref"><span class="none"></span>Source Xref</a></li>
      <li><a href="xref-test/index.html" title="Test Source Xref"><span class="none"></span>Test Source Xref</a></li>
      <li><a href="checkstyle.html" title="Checkstyle"><span class="none"></span>Checkstyle</a></li>
      <li><a href="spotbugs.html" title="SpotBugs"><span class="none"></span>SpotBugs</a></li>
      <li class="active"><a href="#"><span class="none"></span>CPD</a></li>
      <li><a href="pmd.html" title="PMD"><span class="none"></span>PMD</a></li>
      <li><a href="surefire-report.html" title="Surefire Report"><span class="none"></span>Surefire Report</a></li>
      <li><a href="jacoco/index.html" title="JaCoCo"><span class="none"></span>JaCoCo</a></li>
     </ul></li>
   <li class="nav-header">Parent Project</li>
    <li><a href="../index.html" title="EJB-CA"><span class="none"></span>EJB-CA</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<section>
<h2><a name="CPD_Results"></a>CPD Results</h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="https://pmd.github.io/latest/pmd_userdocs_cpd.html">CPD</a> 6.21.0.</p></section><section>
<h2><a name="Duplications"></a>Duplications</h2>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1169">1169</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1385">1385</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            log.debug(&quot; issuerDN: &quot; + Arrays.toString(issuerDns.toArray()));
            if (!accessAnyCpAvailable || !request.getCpIds().isEmpty()) {
                log.debug(&quot; certificateProfileId: &quot; + Arrays.toString(authorizedCpIds.toArray()));
            } else {
                log.debug(&quot; certificateProfileId: Any (even deleted) profile(s) due to root access.&quot;);
            }
            if (!accessAnyEepAvailable || !request.getEepIds().isEmpty()) {
                log.debug(&quot; endEntityProfileId: &quot; + Arrays.toString(authorizedEepIds.toArray()));
            } else {
                log.debug(&quot; endEntityProfileId: Any (even deleted) profile(s) due to root access.&quot;);
            }
        }
        if (!subjectDnSearchString.isEmpty()) {
            if (request.isSubjectDnSearchExact()) {
                query.setParameter(&quot;subjectDN&quot;, subjectDnSearchString.toUpperCase());
            } else {
                query.setParameter(&quot;subjectDN&quot;, &quot;%&quot; + subjectDnSearchString.toUpperCase() + &quot;%&quot;);
            }
        }
        if (!subjectAnSearchString.isEmpty()) {
            if (request.isSubjectAnSearchExact()) {
                query.setParameter(&quot;subjectAltName&quot;, subjectAnSearchString);
            } else {
                query.setParameter(&quot;subjectAltName&quot;, &quot;%&quot; + subjectAnSearchString + &quot;%&quot;);
            }
        }
        if (!usernameSearchString.isEmpty()) {
            if (request.isUsernameSearchExact()) {
                query.setParameter(&quot;username&quot;, usernameSearchString.toUpperCase());
            } else {
                query.setParameter(&quot;username&quot;, &quot;%&quot; + usernameSearchString.toUpperCase() + &quot;%&quot;);
            }
        }
        if (!serialNumberSearchStringFromDec.isEmpty()) {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1041">1041</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1296">1296</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        if (issuerDns.isEmpty()) {
            // Empty response since there were no authorized CAs
            if (log.isDebugEnabled()) {
                log.debug(&quot;Client '&quot;+authenticationToken+&quot;' was not authorized to any of the requested CAs and the search request will be dropped.&quot;);
            }
            return response;
        }
        // Check Certificate Profile authorization
        final List&lt;Integer&gt; authorizedCpIds = new ArrayList&lt;&gt;(certificateProfileSession.getAuthorizedCertificateProfileIds(authenticationToken, 0));
        final boolean accessAnyCpAvailable = authorizedCpIds.containsAll(certificateProfileSession.getCertificateProfileIdToNameMap().keySet());
        if (!request.getCpIds().isEmpty()) {
            authorizedCpIds.retainAll(request.getCpIds());
        }
        if (authorizedCpIds.isEmpty()) {
            // Empty response since there were no authorized Certificate Profiles
            if (log.isDebugEnabled()) {
                log.debug(&quot;Client '&quot;+authenticationToken+&quot;' was not authorized to any of the requested CPs and the search request will be dropped.&quot;);
            }
            return response;
        }
        // Check End Entity Profile authorization
        final Collection&lt;Integer&gt; authorizedEepIds = new ArrayList&lt;&gt;(endEntityProfileSession.getAuthorizedEndEntityProfileIds(authenticationToken, AccessRulesConstants.VIEW_END_ENTITY));
        final boolean accessAnyEepAvailable = authorizedEepIds.containsAll(endEntityProfileSession.getEndEntityProfileIdToNameMap().keySet());
        if (!request.getEepIds().isEmpty()) {
            authorizedEepIds.retainAll(request.getEepIds());
        }
        if (authorizedEepIds.isEmpty()) {
            // Empty response since there were no authorized End Entity Profiles
            if (log.isDebugEnabled()) {
                log.debug(&quot;Client '&quot;+authenticationToken+&quot;' was not authorized to any of the requested EEPs and the search request will be dropped.&quot;);
            }
            return response;
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1767">1767</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L2692">2692</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                    ei.getKeyStoreAlgorithmType(), // Signature algorithm
                    null, // Not valid before
                    notAfter, // Not valid after
                    endEntity.getTokenType() == SecConst.TOKEN_SOFT_JKS, // Type of token
                    loadkeys, // Perform key recovery?
                    savekeys, // Save private keys?
                    reusecertificate, // Reuse recovered cert?
                    endEntity.getEndEntityProfileId()); // Identifier for end entity
        } catch (KeyStoreException | InvalidAlgorithmParameterException | CADoesntExistsException | IllegalKeyException
                | CertificateCreateException | IllegalNameException | CertificateRevokeException | CertificateSerialNumberException
                | CryptoTokenOfflineException | IllegalValidityException | CAOfflineException | InvalidAlgorithmException
                | CustomCertificateSerialNumberException | CertificateException | NoSuchAlgorithmException | InvalidKeySpecException
                | EndEntityProfileValidationException | CertificateSignatureException | NoSuchEndEntityException e) {
            throw new KeyStoreGeneralRaException(e);
        }
        if(endEntity.getTokenType() == EndEntityConstants.TOKEN_SOFT_PEM){
            try(ByteArrayOutputStream outputStream = new ByteArrayOutputStream()){
                outputStream.write(KeyTools.getSinglePemFromKeyStore(keyStore, endEntity.getPassword().toCharArray()));
                return outputStream.toByteArray();
            } catch (IOException | CertificateEncodingException | UnrecoverableKeyException | KeyStoreException | NoSuchAlgorithmException e) {
                log.error(e); //should never happen if keyStore is valid object
            }
        }else{
            try(ByteArrayOutputStream outputStream = new ByteArrayOutputStream()){
                keyStore.store(outputStream, endEntity.getPassword().toCharArray());
                return outputStream.toByteArray();
            } catch (IOException | KeyStoreException | NoSuchAlgorithmException | CertificateException e) {
                log.error(e); //should never happen if keyStore is valid object
            }
        }
        return null;
    }

    @Override
    public byte[] createCertificate(AuthenticationToken authenticationToken, EndEntityInformation endEntityInformation)</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L798">798</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L834">834</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                certificatechain.add(cacertificate);
                // set status to active

            } catch (CryptoTokenOfflineException e) {
                final String detailsMsg = intres.getLocalizedMessage(&quot;error.catokenoffline&quot;, cainfo.getName());
                auditSession.log(EventTypes.CA_CREATION, EventStatus.FAILURE, ModuleTypes.CA, ServiceTypes.CORE, authenticationToken.toString(),
                        String.valueOf(caid), null, null, detailsMsg);
                sessionContext.setRollbackOnly(); // This is an application exception so it wont trigger a roll-back automatically
                throw e;
            } catch (Exception fe) {
                String msg = intres.getLocalizedMessage(&quot;caadmin.errorcreateca&quot;, cainfo.getName());
                Map&lt;String, Object&gt; details = new LinkedHashMap&lt;String, Object&gt;();
                details.put(&quot;msg&quot;, msg);
                details.put(&quot;error&quot;, fe.getMessage());
                auditSession.log(EventTypes.CA_CREATION, EventStatus.FAILURE, ModuleTypes.CA, ServiceTypes.CORE, authenticationToken.toString(),
                        String.valueOf(caid), null, null, details);
                throw new EJBException(fe);
            }
        } else if (cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA) {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1808">1808</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L2748">2748</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        req = RequestMessageUtils.genPKCS10RequestMessage(endEntityInformation.getExtendedInformation().getCertificateRequest());
        req.setUsername(endEntityInformation.getUsername());
        req.setPassword(endEntityInformation.getPassword());
        final String encodedValidity = endEntityInformation.getExtendedInformation().getCertificateEndTime();
        req.setNotAfter(encodedValidity == null ? null : ValidityDate.getDate(encodedValidity, new Date()));
        try {
            ResponseMessage resp = signSessionLocal.createCertificate(authenticationToken, req, X509ResponseMessage.class, null);
            X509Certificate cert = CertTools.getCertfromByteArray(resp.getResponseMessage(), X509Certificate.class);
            return cert.getEncoded();
        } catch (NoSuchEndEntityException | CustomCertificateSerialNumberException | CryptoTokenOfflineException | IllegalKeyException
                | CADoesntExistsException | SignRequestException | SignRequestSignatureException | IllegalNameException | CertificateCreateException
                | CertificateRevokeException | CertificateSerialNumberException | IllegalValidityException | CAOfflineException
                | InvalidAlgorithmException | CertificateExtensionException e) {
            throw new EjbcaException(e);
        } catch (CertificateParsingException | CertificateEncodingException e) {
            throw new IllegalStateException(&quot;Internal error with creating X509Certificate from CertificateResponseMessage&quot;);
        }
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/keyrecovery/KeyRecoverySessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/keyrecovery/KeyRecoverySessionBean.html#L317">317</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/keyrecovery/KeyRecoverySessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/keyrecovery/KeyRecoverySessionBean.html#L361">361</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                        logMsg = intres.getLocalizedMessage(&quot;keyrecovery.sentdata&quot;, username, response.getKeyAlias(), response.getPublicKeyId(), response.getCryptoTokenId());                
        			}
        		}
        		if (logMsg == null) {
                    logMsg = intres.getLocalizedMessage(&quot;keyrecovery.nodata&quot;, username);                        		    
        		}
                final Map&lt;String, Object&gt; details = new LinkedHashMap&lt;&gt;();
                details.put(&quot;msg&quot;, logMsg);
                auditSession.log(EjbcaEventTypes.KEYRECOVERY_SENT, EventStatus.SUCCESS, EjbcaModuleTypes.KEYRECOVERY, EjbcaServiceTypes.EJBCA, admin.toString(), caidString, certSerialNumber, username, details);
        	} catch (Exception e) {
        		String msg = intres.getLocalizedMessage(&quot;keyrecovery.errorsenddata&quot;, username);            	
        		log.error(msg, e);
                final Map&lt;String, Object&gt; details = new LinkedHashMap&lt;&gt;();
                details.put(&quot;msg&quot;, msg);
                auditSession.log(EjbcaEventTypes.KEYRECOVERY_SENT, EventStatus.FAILURE, EjbcaModuleTypes.KEYRECOVERY, EjbcaServiceTypes.EJBCA, admin.toString(), null, null, username, details);
        	}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/protocol/cmp/CrmfMessageHandler.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/CrmfMessageHandler.html#L671">671</a></td></tr>
<tr class="a">
<td>org/ejbca/core/protocol/cmp/authentication/HMACAuthenticationModule.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/authentication/HMACAuthenticationModule.html#L304">304</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>	}

    /**
     * Gets the username by the DN component specified in the CMP configuration 'extract username component' 
     * and adds the RA name generation prefix and postfix.
     * 
     * @param dn the DN.
     * @return the username with RA name generation prefix and postfix.
     */
    private String getUsernameByDnComponent(String dn) {
        final String usernameComp = this.cmpConfiguration.getExtractUsernameComponent(this.confAlias);
        if (LOG.isDebugEnabled()) {
            LOG.debug(&quot;extractUsernameComponent: &quot;+usernameComp);
        }
        if(StringUtils.isNotEmpty(usernameComp)) {
            String username = CertTools.getPartFromDN(dn,usernameComp);
            String fix = cmpConfiguration.getRANameGenPrefix(this.confAlias);
            if (StringUtils.isNotBlank(fix)) {
                LOG.info(&quot;Preceded RA name prefix '&quot; + fix + &quot;' to username '&quot; + username + &quot;' in CMP vendor mode.&quot;);
                username = fix + username;
            }
            fix = cmpConfiguration.getRANameGenPostfix(this.confAlias);
            if (StringUtils.isNotBlank( cmpConfiguration.getRANameGenPostfix(this.confAlias))) {
                LOG.info(&quot;Attached RA name postfix '&quot; + fix + &quot;' to username '&quot; + username + &quot;' in CMP vendor mode.&quot;);
                username += fix;
            }
            return username;
        }    
        return null;
    }
}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/protocol/cmp/CmpConfirmResponseMessage.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/CmpConfirmResponseMessage.html#L157">157</a></td></tr>
<tr class="a">
<td>org/ejbca/core/protocol/cmp/CmpRevokeResponseMessage.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/CmpRevokeResponseMessage.html#L196">196</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>	}

	@Override
	public boolean requireSignKeyInfo() {
		return false;
	}
	
	@Override
	public void setSignKeyInfo(Collection&lt;Certificate&gt; certs, PrivateKey key, String provider) {
		this.signCertChain = certs;
		this.signKey = key;
		if (provider != null) {
			this.provider = provider;
		}
	}

	@Override
	public void setRecipientKeyInfo(byte[] recipientKeyInfo) {
	}

	@Override
	public void setPreferredDigestAlg(String digest) {
	    if(StringUtils.isNotEmpty(digest)) {
	        this.digestAlg = digest;
	    }
	}

	@Override
	public void setRequestType(int reqtype) {
	}

	@Override
	public void setRequestId(int reqid) {
	}

	@Override
    public void setProtectionParamsFromRequest(RequestMessage reqMsg) {
    }
}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/publisher/PublisherQueueSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/publisher/PublisherQueueSessionBean.html#L171">171</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/publisher/PublisherQueueSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/publisher/PublisherQueueSessionBean.html#L242">242</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        Iterator&lt;org.ejbca.core.ejb.ca.publisher.PublisherQueueData&gt; iter = datas.iterator();
        while (iter.hasNext()) {
            org.ejbca.core.ejb.ca.publisher.PublisherQueueData d = iter.next();
            PublisherQueueData pqd = new PublisherQueueData(d.getPk(), new Date(d.getTimeCreated()), new Date(d.getLastUpdate()),
                    d.getPublishStatus(), d.getTryCounter(), d.getPublishType(), d.getFingerprint(), d.getPublisherId(),
                    d.getPublisherQueueVolatileData());
            ret.add(pqd);
        }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1743">1743</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L2674">2674</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        KeyStore keyStore;
        try {
            final EndEntityProfile endEntityProfile = endEntityProfileSession.getEndEntityProfile(endEntity.getEndEntityProfileId());
            boolean usekeyrecovery = ((GlobalConfiguration) globalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID)).getEnableKeyRecovery();
            EndEntityInformation data = endEntityAccessSession.findUser(endEntity.getUsername());
            if (data == null) {
                throw new EjbcaException(ErrorCode.USER_NOT_FOUND, &quot;User '&quot;+endEntity.getUsername()+&quot;' does not exist&quot;);
            }
            final boolean savekeys = data.getKeyRecoverable() &amp;&amp; usekeyrecovery &amp;&amp; (data.getStatus() != EndEntityConstants.STATUS_KEYRECOVERY);
            final boolean loadkeys = (data.getStatus() == EndEntityConstants.STATUS_KEYRECOVERY) &amp;&amp; usekeyrecovery;
            final boolean reusecertificate = endEntityProfile.getReUseKeyRecoveredCertificate();</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/upgrade/UpgradeSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/upgrade/UpgradeSessionBean.html#L901">901</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/upgrade/UpgradeSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/upgrade/UpgradeSessionBean.html#L945">945</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                            String name = &quot;Require &quot; + numberOfRequiredApprovals + &quot; Approval&quot; + (numberOfRequiredApprovals &gt; 1 ? &quot;s&quot; : &quot;&quot;);
                            AccumulativeApprovalProfile newProfile = new AccumulativeApprovalProfile(name);
                            try {
                                newProfile.setNumberOfApprovalsRequired(numberOfRequiredApprovals);
                            } catch (PropertyValidationException e1) {
                                log.info(&quot;Attempted to upgrade an approval profile with negative value (&quot; + numberOfRequiredApprovals + &quot;). Setting 0 instead.&quot;);
                                try {
                                    newProfile.setNumberOfApprovalsRequired(0);
                                } catch (PropertyValidationException e) {
                                    throw new IllegalStateException(e);
                                }
                            }
                            addApprovalNotification(newProfile);
                            try {
                                int newProfileId = approvalProfileSession.addApprovalProfile(authenticationToken, newProfile);
                                approvalProfileCache.put(numberOfRequiredApprovals, newProfileId);
                                approvalPartitionCache.put(numberOfRequiredApprovals, newProfile.getFirstStep().getPartitions().values().iterator().next().getPartitionIdentifier());</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/protocol/cmp/authentication/EndEntityCertificateAuthenticationModule.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/authentication/EndEntityCertificateAuthenticationModule.html#L642">642</a></td></tr>
<tr class="a">
<td>org/ejbca/core/protocol/cmp/authentication/EndEntityCertificateAuthenticationModule.java</td>
<td><a href="./xref/org/ejbca/core/protocol/cmp/authentication/EndEntityCertificateAuthenticationModule.html#L692">692</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            }

            if(!authorizedToEndEntityProfile(reqAuthToken, eeprofid, AccessRulesConstants.EDIT_END_ENTITY)) {
                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was not authorized to edit end entities with EndEntityProfile &quot; + eepname);
                return false;
            } else {
                if(log.isDebugEnabled()) {
                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to edit end entities with EndEntityProfile &quot; + eepname);
                }
            }

            if(!authSession.isAuthorizedNoLogging(reqAuthToken, AccessRulesConstants.REGULAR_CREATECERTIFICATE)) {
                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is not authorized to create certificates.&quot;);
                return false;
            } else {
                if(log.isDebugEnabled()) {
                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to create certificates&quot;);</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2315">2315</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2429">2429</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            log.debug(&quot;ImportSignatureKeyAlgorithm=&quot; + p12PrivateSignatureKey.getAlgorithm());

            // Extract encryption keys
            PrivateKey p12PrivateEncryptionKey = null;
            PublicKey p12PublicEncryptionKey = null;
            Certificate caEncryptionCertificate = null;
            if (privateEncryptionKeyAlias != null) {
                if (!keystore.isKeyEntry(privateEncryptionKeyAlias)) {
                    throw new Exception(&quot;Alias \&quot;&quot; + privateEncryptionKeyAlias + &quot;\&quot; not found.&quot;);
                }
                Certificate[] encryptionCertChain = KeyTools.getCertChain(keystore, privateEncryptionKeyAlias);
                if (encryptionCertChain.length &lt; 1) {
                    String msg = &quot;Cannot load certificate chain with alias &quot; + privateEncryptionKeyAlias;
                    log.error(msg);
                    throw new Exception(msg);
                }
                caEncryptionCertificate = encryptionCertChain[0];
                p12PrivateEncryptionKey = (PrivateKey) keystore.getKey(privateEncryptionKeyAlias, privkeypass.toCharArray());
                p12PublicEncryptionKey = caEncryptionCertificate.getPublicKey();
            }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2300">2300</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2415">2415</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            keystore.load(new java.io.ByteArrayInputStream(p12file), keystorepass.toCharArray());
            // Extract signature keys
            if (privateSignatureKeyAlias == null || !keystore.isKeyEntry(privateSignatureKeyAlias)) {
                throw new Exception(&quot;Alias \&quot;&quot; + privateSignatureKeyAlias + &quot;\&quot; not found.&quot;);
            }
            Certificate[] signatureCertChain = KeyTools.getCertChain(keystore, privateSignatureKeyAlias);
            if (signatureCertChain.length &lt; 1) {
                String msg = &quot;Cannot load certificate chain with alias &quot; + privateSignatureKeyAlias;
                log.error(msg);
                throw new Exception(msg);
            }
            Certificate caSignatureCertificate = signatureCertChain[0];
            PublicKey p12PublicSignatureKey = caSignatureCertificate.getPublicKey();
            PrivateKey p12PrivateSignatureKey = null;
            p12PrivateSignatureKey = (PrivateKey) keystore.getKey(privateSignatureKeyAlias, privkeypass.toCharArray());</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1086">1086</a></td></tr>
<tr class="a">
<td>org/ejbca/core/model/era/RaMasterApiSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/model/era/RaMasterApiSessionBean.html#L1333">1333</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                !serialNumberSearchStringFromDec.isEmpty() || !serialNumberSearchStringFromHex.isEmpty()) {
            sb.append(&quot; AND (&quot;);
            boolean firstAppended = false;
            if (!subjectDnSearchString.isEmpty()) {
                sb.append(&quot;UPPER(a.subjectDN) LIKE :subjectDN&quot;);
                firstAppended = true;
            }
            if (!subjectAnSearchString.isEmpty()) {
                if (firstAppended) {
                    sb.append(&quot; OR &quot;);
                } else {
                    firstAppended = true;
                }
                sb.append(&quot;a.subjectAltName LIKE :subjectAltName&quot;);
            }
            if (!usernameSearchString.isEmpty()) {
                if (firstAppended) {
                    sb.append(&quot; OR &quot;);
                } else {
                    firstAppended = true;
                }
                sb.append(&quot;UPPER(a.username) LIKE :username&quot;);
            }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L1643">1643</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L1725">1725</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            throws AuthorizationDeniedException, CAExistsException, IllegalCryptoTokenException, CertificateImportException {
        List&lt;Certificate&gt; certificates = EJBTools.unwrapCertCollection(wrappedCerts);
        // Re-order if needed and validate chain
        if (certificates.size() != 1) {
            // In the case there is a chain, we require a full chain leading up to a root
            try {
                certificates = CertTools.createCertChain(certificates);
            } catch (CertPathValidatorException e) {
                throw new CertificateImportException(&quot;The provided certificates does not form a full certificate chain.&quot;);
            } catch (InvalidAlgorithmParameterException e) {
                throw new CertificateImportException(e);
            } catch (NoSuchAlgorithmException e) {
                throw new CertificateImportException(e);
            } catch (NoSuchProviderException e) {
                throw new CertificateImportException(e);
            } catch (CertificateException e) {
                throw new CertificateImportException(e);
            }
        }
        final Certificate caCertificate = certificates.iterator().next();</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L1302">1302</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L1356">1356</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        if (nextKeyAlias != null) {
            try {
                if (log.isDebugEnabled()) {
                    log.debug(&quot;SubjectKeyId for CA cert public key: &quot;
                            + new String(Hex.encode(KeyTools.createSubjectKeyId(caCertPublicKey).getKeyIdentifier())));
                    log.debug(&quot;SubjectKeyId for CA next public key: &quot;
                            + new String(Hex.encode(KeyTools.createSubjectKeyId(cryptoToken.getPublicKey(nextKeyAlias)).getKeyIdentifier())));
                }
                KeyTools.testKey(cryptoToken.getPrivateKey(nextKeyAlias), caCertPublicKey, cryptoToken.getSignProviderName());
            } catch (InvalidKeyException e) { // java exception
                throw new IllegalKeyException(e); // cesecore exception</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ra/EndEntityManagementSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ra/EndEntityManagementSessionBean.html#L2083">2083</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ra/EndEntityManagementSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ra/EndEntityManagementSessionBean.html#L2111">2111</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            throw new AuthorizationDeniedException(admin + &quot; not authorized to key recovery for end entity profile id &quot; + endEntityProfileId);
        }
        try {
            final UserData data = endEntityAccessSession.findByUsername(username);
            if (data == null) {
                log.info(intres.getLocalizedMessage(&quot;ra.errorentitynotexist&quot;, username));
                // This exception message is used to not leak information to the user
                final String msg = intres.getLocalizedMessage(&quot;ra.wrongusernameorpassword&quot;);
                log.info(msg);
                throw new FinderException(msg);
            }
            assertAuthorizedToCA(admin, data.getCaId());
            setUserStatus(admin, data, EndEntityConstants.STATUS_KEYRECOVERY, 0, null);
        } catch (FinderException e) {
            ret = false;
            log.info(&quot;prepareForKeyRecovery: No such user: &quot; + username);
        }
        
        return ret;
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/rest/EjbcaRestHelperSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/rest/EjbcaRestHelperSessionBean.html#L98">98</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ws/EjbcaWSHelperSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ws/EjbcaWSHelperSessionBean.html#L157">157</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        if ((admin != null) &amp;&amp; (!allowNonAdmins)) {
            if(!raMasterApiProxyBean.isAuthorizedNoLogging(admin, AccessRulesConstants.ROLE_ADMINISTRATOR)) {
                final String msg = intres.getLocalizedMessage(&quot;authorization.notauthorizedtoresource&quot;, AccessRulesConstants.ROLE_ADMINISTRATOR, null);
                throw new AuthorizationDeniedException(msg);
            }
        } else if (admin == null) {
            final String msg = intres.getLocalizedMessage(&quot;authentication.failed&quot;, &quot;No admin authenticated for certificate with serialNumber &quot; +
                    CertTools.getSerialNumber(cert) + &quot; and issuerDN '&quot; + CertTools.getIssuerDN(cert)+&quot;'.&quot;);
            throw new AuthorizationDeniedException(msg);
        }
        return admin;
    }

    @Override</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L733">733</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L741">741</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            } catch (CADoesntExistsException e) {
                String msg = intres.getLocalizedMessage(&quot;caadmin.errorcreateca&quot;, cainfo.getName());
                Map&lt;String, Object&gt; details = new LinkedHashMap&lt;String, Object&gt;();
                details.put(&quot;msg&quot;, msg);
                details.put(&quot;error&quot;, e.getMessage());
                auditSession.log(EventTypes.CA_CREATION, EventStatus.FAILURE, ModuleTypes.CA, ServiceTypes.CORE, admin.toString(),
                        String.valueOf(caid), null, null, details);
                throw new EJBException(e);
            } catch (CAOfflineException e) {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2609">2609</a></td></tr>
<tr class="a">
<td>org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.java</td>
<td><a href="./xref/org/ejbca/core/ejb/ca/caadmin/CAAdminSessionBean.html#L2661">2661</a></td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            final CAToken catoken = new CAToken(cryptoTokenId, caTokenProperties);
            // If this is a CVC CA we need to find out the sequence
            String sequence = CAToken.DEFAULT_KEYSEQUENCE;
            if (cacert instanceof CardVerifiableCertificate) {
                CardVerifiableCertificate cvccacert = (CardVerifiableCertificate) cacert;
                log.debug(&quot;Getting sequence from holderRef in CV certificate.&quot;);
                try {
                    sequence = cvccacert.getCVCertificate().getCertificateBody().getHolderReference().getSequence();
                } catch (NoSuchFieldException e) {
                    log.error(&quot;Can not get sequence from holderRef in CV certificate, using default sequence.&quot;);
                }
            }
            log.debug(&quot;Setting sequence &quot; + sequence);
            catoken.setKeySequence(sequence);
            log.debug(&quot;Setting default sequence format &quot; + StringTools.KEY_SEQUENCE_FORMAT_NUMERIC);
            catoken.setKeySequenceFormat(StringTools.KEY_SEQUENCE_FORMAT_NUMERIC);
            catoken.setSignatureAlgorithm(signatureAlgorithm);</pre></div></td></tr></table></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2020
</p>
        </div>
      </div>
    </footer>
  </body>
</html>