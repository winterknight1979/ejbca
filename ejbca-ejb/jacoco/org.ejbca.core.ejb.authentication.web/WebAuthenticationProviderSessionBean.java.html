<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebAuthenticationProviderSessionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA EJB Library</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.ejb.authentication.web</a> &gt; <span class="el_source">WebAuthenticationProviderSessionBean.java</span></div><h1>WebAuthenticationProviderSessionBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.core.ejb.authentication.web;

import java.security.cert.X509Certificate;
import java.util.Arrays;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Set;

import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;

import org.apache.log4j.Logger;
import org.cesecore.audit.enums.EventStatus;
import org.cesecore.audit.enums.EventTypes;
import org.cesecore.audit.log.SecurityEventsLoggerSessionLocal;
import org.cesecore.authentication.tokens.AuthenticationSubject;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authentication.tokens.PublicAccessAuthenticationToken;
import org.cesecore.authentication.tokens.X509CertificateAuthenticationToken;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.cesecore.certificates.certificate.CertificateStoreSessionLocal;
import org.cesecore.jndi.JndiConstants;
import org.cesecore.util.CertTools;
import org.ejbca.config.WebConfiguration;
import org.ejbca.core.ejb.audit.enums.EjbcaModuleTypes;
import org.ejbca.core.ejb.audit.enums.EjbcaServiceTypes;
import org.ejbca.core.model.InternalEjbcaResources;
import org.ejbca.core.model.log.LogConstants;

/**
 *
 * @version $Id: WebAuthenticationProviderSessionBean.java 29151 2018-06-07 15:11:05Z jeklund $
 * 
 */
@Stateless(mappedName = JndiConstants.APP_JNDI_PREFIX + &quot;WebAuthenticationProviderSessionLocal&quot;)
@TransactionAttribute(TransactionAttributeType.SUPPORTS)
<span class="nc" id="L52">public class WebAuthenticationProviderSessionBean implements WebAuthenticationProviderSessionLocal {</span>

    private static final long serialVersionUID = 1524951666783567785L;

<span class="nc" id="L56">    private final static Logger LOG = Logger.getLogger(WebAuthenticationProviderSessionBean.class);</span>
    /** Internal localization of logs and errors */
<span class="nc" id="L58">    private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>

    @EJB
    private CertificateStoreSessionLocal certificateStoreSession;
    @EJB
    private SecurityEventsLoggerSessionLocal securityEventsLoggerSession;

    @Override
    public X509CertificateAuthenticationToken authenticateUsingClientCertificate(final X509Certificate x509Certificate) {
<span class="nc" id="L67">        return (X509CertificateAuthenticationToken) authenticate(new AuthenticationSubject(null, new HashSet&lt;X509Certificate&gt;( Arrays.asList(new X509Certificate[]{ x509Certificate }))));</span>
    }

    @Override
    public PublicAccessAuthenticationToken authenticateUsingNothing(final String principal, final boolean confidentialTransport) {
<span class="nc" id="L72">        return new PublicAccessAuthenticationToken(principal, confidentialTransport);</span>
    }

    /**
     * Performs client certificate authentication for a subject. This requires:
     * - An AuthenticationSubject containing a Set&amp;lt;X509Certificate&amp;gt;, where there should be only one certificate 
     *   being the administrators client certificate.
     * If the admin certificate is required to be in the database (properties configuration option) it is
     * verified that the certificate is present in the database and that it is not revoked.
     * 
     * @param subject an AuthenticationSubject containing a Set&amp;lt;X509Certificate&amp;gt; of credentials, the set must contain one certificate which is the admin client certificate.
     * @return an AuthenticationToken if the subject was authenticated, null otherwise.
     */
    @Override
    public AuthenticationToken authenticate(AuthenticationSubject subject) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L88">        final Set&lt;X509Certificate&gt; certs = (Set&lt;X509Certificate&gt;) subject.getCredentials();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (certs.size() != 1) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L91">                LOG.debug(&quot;certificateArray contains &quot;+certs.size()+&quot; certificates, instead of 1 that is required.&quot;);</span>
            }
<span class="nc" id="L93">            return null;</span>
        } else {
<span class="nc" id="L95">            final X509Certificate certificate = certs.iterator().next();</span>
            // Check Validity
            try {
<span class="nc" id="L98">                certificate.checkValidity();</span>
<span class="nc" id="L99">            } catch (Exception e) {</span>
<span class="nc" id="L100">                final String msg = intres.getLocalizedMessage(&quot;authentication.certexpired&quot;, CertTools.getSubjectDN(certificate), CertTools.getNotAfter(certificate).toString());</span>
<span class="nc" id="L101">            	LOG.info(msg);</span>
<span class="nc" id="L102">                final Map&lt;String, Object&gt; details = new LinkedHashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L103">                details.put(&quot;msg&quot;, msg);</span>
<span class="nc" id="L104">                securityEventsLoggerSession.log(EventTypes.AUTHENTICATION, EventStatus.FAILURE, EjbcaModuleTypes.ADMINWEB, EjbcaServiceTypes.EJBCA, LogConstants.NO_AUTHENTICATION_TOKEN, null, null, null, details);</span>
<span class="nc" id="L105">            	return null;</span>
<span class="nc" id="L106">            }</span>
            // Find out if this is a certificate present in the local database (even if we don't require a cert to be present there we still want to allow a mix)
            // Database integrity protection verification not performed running this query
<span class="nc" id="L109">            final int status = certificateStoreSession.getFirstStatusByIssuerAndSerno(CertTools.getIssuerDN(certificate), CertTools.getSerialNumber(certificate));</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (status != -1) {</span>
                // The certificate is present in the database.
<span class="nc bnc" id="L112" title="All 4 branches missed.">                if (!(status == CertificateConstants.CERT_ACTIVE || status == CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION)) {</span>
                    // The certificate is neither active, nor active (but user is notified of coming revocation)
<span class="nc" id="L114">                    final String msg = intres.getLocalizedMessage(&quot;authentication.revokedormissing&quot;, CertTools.getSubjectDN(certificate));</span>
<span class="nc" id="L115">                    LOG.info(msg);</span>
<span class="nc" id="L116">                    final Map&lt;String, Object&gt; details = new LinkedHashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L117">                    details.put(&quot;msg&quot;, msg);</span>
<span class="nc" id="L118">                    securityEventsLoggerSession.log(EventTypes.AUTHENTICATION, EventStatus.FAILURE, EjbcaModuleTypes.ADMINWEB, EjbcaServiceTypes.EJBCA, LogConstants.NO_AUTHENTICATION_TOKEN, null, null, null, details);</span>
<span class="nc" id="L119">                    return null;</span>
                }
            } else {
                // The certificate is not present in the database.
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (WebConfiguration.getRequireAdminCertificateInDatabase()) {</span>
<span class="nc" id="L124">                    final String msg =  intres.getLocalizedMessage(&quot;authentication.revokedormissing&quot;, CertTools.getSubjectDN(certificate));</span>
<span class="nc" id="L125">                    LOG.info(msg);</span>
<span class="nc" id="L126">                    final Map&lt;String, Object&gt; details = new LinkedHashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L127">                    details.put(&quot;msg&quot;, msg);</span>
<span class="nc" id="L128">                    securityEventsLoggerSession.log(EventTypes.AUTHENTICATION, EventStatus.FAILURE, EjbcaModuleTypes.ADMINWEB, EjbcaServiceTypes.EJBCA, LogConstants.NO_AUTHENTICATION_TOKEN, null, null, null, details);</span>
<span class="nc" id="L129">                    return null;</span>
                }
                // TODO: We should check the certificate for CRL or OCSP tags and verify the certificate status
            }
<span class="nc" id="L133">            return new X509CertificateAuthenticationToken(certificate);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>