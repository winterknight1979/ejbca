<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NestedMessageContent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EJBCA EJB Library</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.protocol.cmp</a> &gt; <span class="el_source">NestedMessageContent.java</span></div><h1>NestedMessageContent.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.protocol.cmp;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.math.BigInteger;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.Signature;
import java.security.SignatureException;
import java.security.cert.Certificate;
import java.security.cert.CertificateExpiredException;
import java.security.cert.CertificateNotYetValidException;
import java.security.cert.CertificateParsingException;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.log4j.Logger;
import org.bouncycastle.asn1.cmp.PKIHeader;
import org.bouncycastle.asn1.cmp.PKIMessage;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.asn1.x509.Extensions;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.cesecore.certificates.certificate.request.RequestMessage;
import org.cesecore.util.CertTools;
import org.ejbca.config.CmpConfiguration;

/**
 * Nested Message Content according to RFC4210. The PKI message is signed by an RA authority.
 * The PKIMessage body is another PKIMessage containing the request to be processed. 
 * 
 * @version $Id: NestedMessageContent.java 28096 2018-01-25 05:34:38Z andresjakobs $
 *
 */
public class NestedMessageContent extends BaseCmpMessage implements RequestMessage {
  
    private static final long serialVersionUID = 1L;
    
<span class="nc" id="L57">    private static final Logger log = Logger.getLogger(NestedMessageContent.class);</span>
    
    private PKIMessage raSignedMessage;
    private String confAlias;
    private CmpConfiguration cmpConfiguration;
    
    /** Because PKIMessage is not serializable we need to have the serializable bytes save as well, so 
     * we can restore the PKIMessage after serialization/deserialization. */ 
<span class="nc" id="L65">    private byte[] pkimsgbytes = null;</span>

<span class="nc" id="L67">    public NestedMessageContent() {</span>
<span class="nc" id="L68">        this.confAlias = null;</span>
<span class="nc" id="L69">    }</span>
    
<span class="nc" id="L71">    public NestedMessageContent(final PKIMessage pkiMessage, final CmpConfiguration cmpConfiguration, String configAlias) {</span>
<span class="nc" id="L72">        this.raSignedMessage = pkiMessage;</span>
<span class="nc" id="L73">        this.confAlias = configAlias;</span>
<span class="nc" id="L74">        this.cmpConfiguration = cmpConfiguration;</span>
<span class="nc" id="L75">        setPKIMessageBytes(pkiMessage);</span>
<span class="nc" id="L76">        final PKIHeader pkiHeader = pkiMessage.getHeader();</span>
<span class="nc" id="L77">        setTransactionId(getBase64FromAsn1OctetString(pkiHeader.getTransactionID()));</span>
<span class="nc" id="L78">        setSenderNonce(getBase64FromAsn1OctetString(pkiHeader.getSenderNonce()));</span>
<span class="nc" id="L79">        setRecipient(pkiHeader.getRecipient());</span>
<span class="nc" id="L80">        setSender(pkiHeader.getSender());</span>
<span class="nc" id="L81">    }</span>

    public PKIMessage getPKIMessage() {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (getMessage() == null) {</span>
<span class="nc" id="L85">            setMessage(PKIMessage.getInstance(pkimsgbytes));</span>
        }
<span class="nc" id="L87">        return getMessage();</span>
    }
    public void setPKIMessageBytes(final PKIMessage msg) {
        try {
<span class="nc" id="L91">            this.pkimsgbytes = msg.toASN1Primitive().getEncoded();</span>
<span class="nc" id="L92">        } catch (IOException e) {</span>
<span class="nc" id="L93">            log.error(&quot;Error getting encoded bytes from PKIMessage: &quot;, e);</span>
<span class="nc" id="L94">        }</span>
<span class="nc" id="L95">        setMessage(msg);</span>
<span class="nc" id="L96">    }</span>

    
    @Override
    public boolean verify() {
        /*
         * Verifies the signature of the pkimessage using the trusted RA certificate stored in cmpConfiguration.getRaCertificatePath()
         */
<span class="nc" id="L104">        boolean ret = false;</span>
        try {
<span class="nc" id="L106">            final String raCertsPath = this.cmpConfiguration.getRACertPath(this.confAlias);</span>
<span class="nc" id="L107">            final List&lt;X509Certificate&gt; racerts = getRaCerts(raCertsPath);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (racerts.isEmpty()) {</span>
<span class="nc" id="L109">                log.info(&quot;No certificate files were found in &quot; + raCertsPath);</span>
            }
<span class="nc bnc" id="L111" title="All 2 branches missed.">            for (final X509Certificate cert : racerts) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L113">                    log.debug(&quot;Trying to verifying the NestedMessageContent using the RA certificate with subjectDN '&quot; + cert.getSubjectDN() + &quot;'&quot;);</span>
                }
                try {
<span class="nc" id="L116">                    cert.checkValidity();</span>
<span class="nc" id="L117">                } catch (CertificateExpiredException | CertificateNotYetValidException e) {                  </span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L119">                        log.debug(&quot;Certificate with subjectDN '&quot; + CertTools.getSubjectDN(cert) + &quot;' is not valid: &quot; + e.getMessage());</span>
                    }
<span class="nc" id="L121">                    continue;</span>
<span class="nc" id="L122">                }</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                if (raSignedMessage.getProtection() != null) {</span>
                    final String algId; 
<span class="nc bnc" id="L125" title="All 2 branches missed.">                    if (raSignedMessage.getHeader().getProtectionAlg() != null) {</span>
<span class="nc" id="L126">                        algId = raSignedMessage.getHeader().getProtectionAlg().getAlgorithm().getId();    </span>
                    } else {
<span class="nc" id="L128">                        algId = cert.getSigAlgName();</span>
                    }
<span class="nc bnc" id="L130" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L131">                        log.debug(&quot;Verifying message signature using algorithm id: &quot;+algId);</span>
                    }
<span class="nc" id="L133">                    Signature sig = Signature.getInstance(algId, BouncyCastleProvider.PROVIDER_NAME);</span>
<span class="nc" id="L134">                    sig.initVerify(cert.getPublicKey());</span>
<span class="nc" id="L135">                    sig.update(CmpMessageHelper.getProtectedBytes(raSignedMessage));</span>
<span class="nc" id="L136">                    ret = sig.verify(raSignedMessage.getProtection().getBytes());</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L138">                        log.debug(&quot;Verifying the NestedMessageContent using the RA certificate with subjectDN '&quot; + cert.getSubjectDN() + &quot;' returned &quot; + ret);</span>
                    }
<span class="nc" id="L140">                } else {</span>
<span class="nc" id="L141">                    log.info(&quot;No signature was found in NestedMessageContent&quot;);</span>
                }
<span class="nc" id="L143">            }</span>
<span class="nc" id="L144">        } catch (NoSuchAlgorithmException | NoSuchProviderException | InvalidKeyException | SignatureException e) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L146">                log.debug(e.getMessage());</span>
            }
<span class="nc" id="L148">        }</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L150">            log.debug(&quot;Verifying the NestedMessageContent returned &quot; + ret);</span>
        }
<span class="nc" id="L152">        return ret;</span>
    }

    /**
     * Reads the files in cmpConfiguration.getRaCertificatePath() and returns them as a list of certificates.
     *  
     * The certificate files should be PEM encoded.
     * @param raCertsPath Path
     * 
     * @return A list of the certificates in cmpConfiguration.getRaCertificatePath() that could be read and parsed. 
     */
    private List&lt;X509Certificate&gt; getRaCerts(final String raCertsPath) {
<span class="nc" id="L164">        final List&lt;X509Certificate&gt; racerts = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L166">            log.debug(&quot;Looking for trusted RA certificate in &quot; + raCertsPath);</span>
        }
<span class="nc" id="L168">        final File raCertDirectory = new File(raCertsPath);</span>
<span class="nc" id="L169">        final String[] files = raCertDirectory.list();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (files != null) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L172">                log.debug(&quot;Found &quot; + files.length + &quot; trusted RA certificate in &quot; + raCertsPath);</span>
            }
<span class="nc bnc" id="L174" title="All 2 branches missed.">            for (final String certFile : files) {</span>
<span class="nc" id="L175">                final String filepath = raCertsPath + &quot;/&quot; + certFile;</span>
                try {
<span class="nc" id="L177">                    racerts.add(CertTools.getCertsFromPEM(filepath, X509Certificate.class).iterator().next());</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L179">                        log.debug(&quot;Added &quot; + certFile + &quot; to the list of trusted RA certificates&quot;);</span>
                    }
<span class="nc" id="L181">                } catch (CertificateParsingException | FileNotFoundException e) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L183">                        log.debug(&quot;Failed to add &quot; + certFile + &quot; to the list of trusted RA certificates: &quot; + e.getMessage());</span>
                    }
<span class="nc" id="L185">                }</span>
            }
        }
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L189">            log.debug(&quot;Found &quot; + racerts.size() + &quot; certificates in &quot; + raCertsPath);</span>
        }
<span class="nc" id="L191">        return racerts;</span>
    }

    @Override
    public String getCRLIssuerDN() {
<span class="nc" id="L196">        return null;</span>
    }

    @Override
    public BigInteger getCRLSerialNo() {
<span class="nc" id="L201">        return null;</span>
    }

    @Override
    public int getErrorNo() {
<span class="nc" id="L206">        return 0;</span>
    }

    @Override
    public String getErrorText() {
<span class="nc" id="L211">        return null;</span>
    }

    @Override
    public String getIssuerDN() {
<span class="nc" id="L216">        return null;</span>
    }

    @Override
    public String getPassword() {
<span class="nc" id="L221">        return null;</span>
    }

    @Override
    public String getPreferredDigestAlg() {
<span class="nc" id="L226">        return null;</span>
    }

    @Override
    public String getRequestAltNames() {
<span class="nc" id="L231">        return null;</span>
    }

    @Override
    public String getRequestDN() {
<span class="nc" id="L236">        return null;</span>
    }

    @Override
    public Extensions getRequestExtensions() {
<span class="nc" id="L241">        return null;</span>
    }

    @Override
    public int getRequestId() {
<span class="nc" id="L246">        return 0;</span>
    }

    @Override
    public byte[] getRequestKeyInfo() {
<span class="nc" id="L251">        return null;</span>
    }

    @Override
    public PublicKey getRequestPublicKey() throws InvalidKeyException,
            NoSuchAlgorithmException, NoSuchProviderException {
<span class="nc" id="L257">        return null;</span>
    }

    @Override
    public int getRequestType() {
<span class="nc" id="L262">        return 0;</span>
    }

    @Override
    public Date getRequestValidityNotAfter() {
<span class="nc" id="L267">        return null;</span>
    }

    @Override
    public Date getRequestValidityNotBefore() {
<span class="nc" id="L272">        return null;</span>
    }

    @Override
    public X500Name getRequestX500Name() {
<span class="nc" id="L277">        return null;</span>
    }

    @Override
    public BigInteger getSerialNo() {
<span class="nc" id="L282">        return null;</span>
    }

    @Override
    public String getUsername() {
<span class="nc" id="L287">        return null;</span>
    }

    @Override
    public boolean includeCACert() {
<span class="nc" id="L292">        return false;</span>
    }

    @Override
    public boolean requireKeyInfo() {
<span class="nc" id="L297">        return false;</span>
    }

    @Override
<span class="nc" id="L301">    public void setKeyInfo(final Certificate cert, final PrivateKey key, final String provider) {}</span>

    
    @Override
    public void setResponseKeyInfo(PrivateKey key, String provider) {
<span class="nc" id="L306">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>