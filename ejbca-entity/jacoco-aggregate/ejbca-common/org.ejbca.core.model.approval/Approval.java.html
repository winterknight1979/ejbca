<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Approval.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-entity</a> &gt; <a href="../index.html" class="el_bundle">ejbca-common</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.approval</a> &gt; <span class="el_source">Approval.java</span></div><h1>Approval.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.core.model.approval;

import java.io.Externalizable;
import java.io.IOException;
import java.io.ObjectInput;
import java.io.ObjectOutput;
import java.math.BigInteger;
import java.security.cert.X509Certificate;
import java.util.Date;

import org.cesecore.authentication.tokens.AlwaysAllowLocalAuthenticationToken;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authentication.tokens.LocalJvmOnlyAuthenticationToken;
import org.cesecore.authentication.tokens.UsernamePrincipal;
import org.cesecore.authentication.tokens.X509CertificateAuthenticationToken;
import org.cesecore.util.CertTools;
import org.ejbca.core.model.log.Admin;



/**
 * Class representing an approval of a request. 
 * Includes information like:
 * Approval admin certificate
 * isApproved (rejected otherwise)
 * ApprovalDate
 * Comment
 *  
 * 
 * Approvals are sorted by dates.
 * 
 * @version $Id: Approval.java 26224 2017-08-04 15:11:12Z mikekushner $
 */

//Suppress warnings for deprecation of the Admin object, required for legacy support
@SuppressWarnings(&quot;deprecation&quot;) 
public class Approval implements Comparable&lt;Approval&gt;, Externalizable { 
	
	private static final long serialVersionUID = -1L;
	
	/*
	 * Version 4: Introduced approval profiles in 6.6.0. With this, approvals became specific for a certain sequence and partition. 
	 */
	private static final int LATEST_VERSION = 4;

<span class="fc" id="L58">	private AuthenticationToken admin = null;</span>
<span class="fc" id="L59">    private String adminCertIssuerDN = null;</span>
<span class="fc" id="L60">    private String adminCertSerialNumber = null;</span>
<span class="fc" id="L61">    private boolean approved = false;</span>
<span class="fc" id="L62">    private Date approvalDate = null;</span>
<span class="fc" id="L63">    private String comment = null;</span>
<span class="fc" id="L64">    private String approvalSignature = null; </span>
    private int stepId; //The identity of the step which this approval covers. 
    private int partitionId; //The identity of the partition which this approval covers.
    
	/**
	 * @param comment Comment
	 * @param stepId Step
	 * @param partitionId Partition
	 */
	public Approval(String comment, int stepId, int partitionId) {
<span class="fc" id="L74">		super();</span>
<span class="fc" id="L75">		this.approvalDate = new Date();</span>
<span class="fc" id="L76">		this.comment = comment;</span>
<span class="fc" id="L77">		setStepId(stepId);</span>
<span class="fc" id="L78">		setPartitionId(partitionId);</span>
<span class="fc" id="L79">	}</span>
	
	/**
	 * Constructor used in externalization only
	 */
<span class="fc" id="L84">	public Approval(){}</span>

	/**
	 * @return Returns the adminCertIssuerDN.
	 * @deprecated Use the information from the Admin object instead
	 */
	public String getAdminCertIssuerDN() {
<span class="fc" id="L91">		return adminCertIssuerDN;</span>
	}
	
	/**
	 * @return Returns the adminCertSerialNumber.
	 * @deprecated Use the information from the Admin object instead
	 */
	public BigInteger getAdminCertSerialNumber() {
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">		if (adminCertSerialNumber == null) {</span>
<span class="nc" id="L100">			return null;</span>
		}
<span class="fc" id="L102">		return new BigInteger(adminCertSerialNumber,16);</span>
	}
	
	
	/**
	 * @return Returns the approvalDate.
	 */
	public Date getApprovalDate() {
<span class="fc" id="L110">		return approvalDate;</span>
	}
	
	
	/** @return true for approved and false for rejection. */
	public boolean isApproved() {
<span class="fc" id="L116">		return approved;</span>
	}
	
	
	/**
	 * @return Returns the comment.
	 */
	public String getComment() {
<span class="fc" id="L124">		return comment;</span>
	}		
	
	/**
	 * @return the Admin that approved this Approval
	 */
<span class="fc" id="L130">	public AuthenticationToken getAdmin() { return admin; }</span>

	/**
	 * Used specify rejection or approval
	 * @param approved true for approved, false for rejected
	 * @param admin is the Admin that approved or rejected the current Approval
	 */
	public void setApprovalAdmin(boolean approved, AuthenticationToken admin) {
<span class="fc" id="L138">		this.approved = approved;</span>
<span class="fc" id="L139">		this.admin = admin;</span>
<span class="fc" id="L140">	}</span>
	
    /**
     * Sort by approval date
     */
	public int compareTo(Approval arg0) {				
<span class="nc" id="L146">		return approvalDate.compareTo(arg0.approvalDate);</span>
	}

	@Override
	public void writeExternal(ObjectOutput out) throws IOException {
<span class="fc" id="L151">		out.writeInt(LATEST_VERSION);</span>
<span class="fc" id="L152">		out.writeObject(this.admin);</span>
<span class="fc" id="L153">		out.writeBoolean(this.approved);</span>
<span class="fc" id="L154">		out.writeObject(this.approvalDate);</span>
<span class="fc" id="L155">		out.writeObject(this.comment);	</span>
<span class="fc" id="L156">		out.writeObject(this.approvalSignature);</span>
<span class="fc" id="L157">		out.writeObject(this.stepId);</span>
<span class="fc" id="L158">		out.writeObject(this.partitionId);</span>
<span class="fc" id="L159">	}</span>

	@Override
	public void readExternal(ObjectInput in) throws IOException, ClassNotFoundException {
<span class="fc" id="L163">		int version = in.readInt();</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">		if(version == 1){</span>
<span class="nc" id="L165">			this.adminCertIssuerDN = (String) in.readObject();</span>
<span class="nc" id="L166">			this.adminCertSerialNumber = (String) in.readObject();</span>
<span class="nc" id="L167">			this.approved = in.readBoolean();</span>
<span class="nc" id="L168">			this.approvalDate = (Date) in.readObject();</span>
<span class="nc" id="L169">			this.comment = (String) in.readObject();</span>
<span class="nc" id="L170">			this.approvalSignature = (String) in.readObject();</span>
			//this.username = (String) in.readObject(); This information is now available through the Admin object
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		} else if (version == 2) {</span>
<span class="nc" id="L173">            final Admin admin = (Admin) in.readObject();</span>
<span class="nc" id="L174">            final X509Certificate x509cert = (X509Certificate)admin.getAdminInformation().getX509Certificate();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (x509cert != null) {</span>
<span class="nc" id="L176">                this.admin = new X509CertificateAuthenticationToken(x509cert);            	</span>
<span class="nc" id="L177">				this.adminCertIssuerDN = CertTools.getIssuerDN(x509cert);</span>
<span class="nc" id="L178">				this.adminCertSerialNumber = CertTools.getSerialNumberAsString(x509cert);</span>
<span class="nc bnc" id="L179" title="All 4 branches missed.">            } else if ((admin.getAdminType() &gt;= 0) &amp;&amp; (admin.getAdminType() &lt;= 5)) {</span>
				// We trust this admin as if it were created internal to EJBCA and fill in the auth token
<span class="nc" id="L181">            	this.admin = new AlwaysAllowLocalAuthenticationToken(new UsernamePrincipal(admin.getUsername()));</span>
            }
<span class="nc" id="L183">			this.approved = in.readBoolean();</span>
<span class="nc" id="L184">			this.approvalDate = (Date) in.readObject();</span>
<span class="nc" id="L185">			this.comment = (String) in.readObject();</span>
<span class="nc" id="L186">			this.approvalSignature = (String) in.readObject();</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">		} else if (version == 3) {</span>
<span class="nc" id="L188">			this.admin = (AuthenticationToken) in.readObject();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">			if (this.admin instanceof AlwaysAllowLocalAuthenticationToken) {</span>
				// We trust this admin as if it were created internal to EJBCA and fill in the auth token
<span class="nc" id="L191">				this.admin = new AlwaysAllowLocalAuthenticationToken(this.admin.getPrincipals().iterator().next());</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">			} else if (this.admin instanceof X509CertificateAuthenticationToken) {</span>
<span class="nc" id="L193">				X509CertificateAuthenticationToken xtok = (X509CertificateAuthenticationToken)this.admin;</span>
<span class="nc" id="L194">				this.adminCertIssuerDN = CertTools.getIssuerDN(xtok.getCertificate());</span>
<span class="nc" id="L195">				this.adminCertSerialNumber = CertTools.getSerialNumberAsString(xtok.getCertificate());</span>
			}
<span class="nc" id="L197">			this.approved = in.readBoolean();</span>
<span class="nc" id="L198">			this.approvalDate = (Date) in.readObject();</span>
<span class="nc" id="L199">			this.comment = (String) in.readObject();</span>
<span class="nc" id="L200">			this.approvalSignature = (String) in.readObject();</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		} else if (version == 4) {</span>
<span class="fc" id="L202">            this.admin = (AuthenticationToken) in.readObject();</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (this.admin instanceof X509CertificateAuthenticationToken) {</span>
<span class="fc" id="L204">                X509CertificateAuthenticationToken xtok = (X509CertificateAuthenticationToken) this.admin;</span>
<span class="fc" id="L205">                this.adminCertIssuerDN = CertTools.getIssuerDN(xtok.getCertificate());</span>
<span class="fc" id="L206">                this.adminCertSerialNumber = CertTools.getSerialNumberAsString(xtok.getCertificate());          </span>
            }
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if(this.admin instanceof LocalJvmOnlyAuthenticationToken) {</span>
<span class="fc" id="L209">                LocalJvmOnlyAuthenticationToken localToken = (LocalJvmOnlyAuthenticationToken) this.admin;</span>
<span class="fc" id="L210">                localToken.initRandomToken();</span>
            }
<span class="fc" id="L212">            this.approved = in.readBoolean();</span>
<span class="fc" id="L213">            this.approvalDate = (Date) in.readObject();</span>
<span class="fc" id="L214">            this.comment = (String) in.readObject();</span>
<span class="fc" id="L215">            this.approvalSignature = (String) in.readObject();</span>
<span class="fc" id="L216">            this.stepId = (int) in.readObject();</span>
<span class="fc" id="L217">            this.partitionId = (int) in.readObject();</span>
        }
		
<span class="fc" id="L220">	}</span>

	/**
	 * @return the identity of the step which this approval covers. 
	 */
    public int getStepId() {
<span class="fc" id="L226">        return stepId;</span>
    }

    public void setStepId(int stepId) {
<span class="fc" id="L230">        this.stepId = stepId;</span>
<span class="fc" id="L231">    }</span>

    /**
     * @return the identity of the partition which this approval covers. 
     */
    public int getPartitionId() {
<span class="nc" id="L237">        return partitionId;</span>
    }

    public void setPartitionId(int partitionId) {
<span class="fc" id="L241">        this.partitionId = partitionId;</span>
<span class="fc" id="L242">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>