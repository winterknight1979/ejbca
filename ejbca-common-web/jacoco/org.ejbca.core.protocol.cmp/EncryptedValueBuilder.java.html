<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EncryptedValueBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ejbca-common-web</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.protocol.cmp</a> &gt; <span class="el_source">EncryptedValueBuilder.java</span></div><h1>EncryptedValueBuilder.java</h1><pre class="source lang-java linenums">package org.ejbca.core.protocol.cmp;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;

import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.DERBitString;
import org.bouncycastle.asn1.crmf.EncryptedValue;
import org.bouncycastle.asn1.pkcs.PrivateKeyInfo;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.cert.X509CertificateHolder;
import org.bouncycastle.cert.crmf.CRMFException;
import org.bouncycastle.cert.crmf.EncryptedValuePadder;
import org.bouncycastle.operator.KeyWrapper;
import org.bouncycastle.operator.OperatorException;
import org.bouncycastle.operator.OutputEncryptor;
import org.bouncycastle.pkcs.PKCS8EncryptedPrivateKeyInfo;
import org.bouncycastle.pkcs.PKCS8EncryptedPrivateKeyInfoBuilder;
import org.bouncycastle.util.Strings;

/**
 * Builder for EncryptedValue structures.
 * @deprecated Copied from BCPKIX 1.59b03, can be removed when we use BC 1.59
 */
@Deprecated
public class EncryptedValueBuilder
{
    private KeyWrapper wrapper;
    private OutputEncryptor encryptor;
    private EncryptedValuePadder padder;

    /**
     * Create a builder that makes EncryptedValue structures.
     *
     * @param wrapper a wrapper for key used to encrypt the actual data contained in the EncryptedValue.
     * @param encryptor  an output encryptor to encrypt the actual data contained in the EncryptedValue. 
     */
    public EncryptedValueBuilder(KeyWrapper wrapper, OutputEncryptor encryptor)
    {
<span class="nc" id="L41">        this(wrapper, encryptor, null);</span>
<span class="nc" id="L42">    }</span>

    /**
     * Create a builder that makes EncryptedValue structures with fixed length blocks padded using the passed in padder.
     *
     * @param wrapper a wrapper for key used to encrypt the actual data contained in the EncryptedValue.
     * @param encryptor  an output encryptor to encrypt the actual data contained in the EncryptedValue.
     * @param padder a padder to ensure that the EncryptedValue created will always be a constant length.
     */
    public EncryptedValueBuilder(KeyWrapper wrapper, OutputEncryptor encryptor, EncryptedValuePadder padder)
<span class="nc" id="L52">    {</span>
<span class="nc" id="L53">        this.wrapper = wrapper;</span>
<span class="nc" id="L54">        this.encryptor = encryptor;</span>
<span class="nc" id="L55">        this.padder = padder;</span>
<span class="nc" id="L56">    }</span>

    /**
     * Build an EncryptedValue structure containing the passed in pass phrase.
     *
     * @param revocationPassphrase  a revocation pass phrase.
     * @return an EncryptedValue containing the encrypted pass phrase.
     * @throws CRMFException on a failure to encrypt the data, or wrap the symmetric key for this value.
     */
    public EncryptedValue build(char[] revocationPassphrase)
        throws CRMFException
    {
<span class="nc" id="L68">        return encryptData(padData(Strings.toUTF8ByteArray(revocationPassphrase)));</span>
    }

    /**
     * Build an EncryptedValue structure containing the certificate contained in
     * the passed in holder.
     *
     * @param holder  a holder containing a certificate.
     * @return an EncryptedValue containing the encrypted certificate.
     * @throws CRMFException on a failure to encrypt the data, or wrap the symmetric key for this value.
     */
    public EncryptedValue build(X509CertificateHolder holder)
        throws CRMFException
    {
        try
        {
<span class="nc" id="L84">            return encryptData(padData(holder.getEncoded()));</span>
        }
<span class="nc" id="L86">        catch (IOException e)</span>
        {
<span class="nc" id="L88">            throw new CRMFException(&quot;cannot encode certificate: &quot; + e.getMessage(), e);</span>
        }
    }

    /**
     * Build an EncryptedValue structure containing the private key contained in
     * the passed info structure.
     *
     * @param privateKeyInfo  a PKCS#8 private key info structure.
     * @return an EncryptedValue containing an EncryptedPrivateKeyInfo structure.
     * @throws CRMFException on a failure to encrypt the data, or wrap the symmetric key for this value.
     */
    public EncryptedValue build(PrivateKeyInfo privateKeyInfo)
        throws CRMFException
    {
<span class="nc" id="L103">        PKCS8EncryptedPrivateKeyInfoBuilder encInfoBldr = new PKCS8EncryptedPrivateKeyInfoBuilder(privateKeyInfo);</span>

<span class="nc" id="L105">        AlgorithmIdentifier intendedAlg = privateKeyInfo.getPrivateKeyAlgorithm();</span>
<span class="nc" id="L106">        AlgorithmIdentifier symmAlg = encryptor.getAlgorithmIdentifier();</span>
        DERBitString encSymmKey;

        try
        {
<span class="nc" id="L111">            PKCS8EncryptedPrivateKeyInfo encInfo = encInfoBldr.build(encryptor);</span>

<span class="nc" id="L113">            wrapper.generateWrappedKey(encryptor.getKey());</span>
<span class="nc" id="L114">            encSymmKey = new DERBitString(wrapper.generateWrappedKey(encryptor.getKey()));</span>

<span class="nc" id="L116">            AlgorithmIdentifier keyAlg = wrapper.getAlgorithmIdentifier();</span>
<span class="nc" id="L117">            ASN1OctetString valueHint = null;</span>

<span class="nc" id="L119">            return new EncryptedValue(intendedAlg, symmAlg, encSymmKey, keyAlg, valueHint, new DERBitString(encInfo.getEncoded()));</span>
        }
<span class="nc" id="L121">        catch (IOException e)</span>
        {
<span class="nc" id="L123">            throw new CRMFException(&quot;cannot encode encrypted private key: &quot; + e.getMessage(), e);</span>
        }
<span class="nc" id="L125">        catch (IllegalStateException e)</span>
        {
<span class="nc" id="L127">            throw new CRMFException(&quot;cannot encode key: &quot; + e.getMessage(), e);</span>
        }
<span class="nc" id="L129">        catch (OperatorException e)</span>
        {
<span class="nc" id="L131">            throw new CRMFException(&quot;cannot wrap key: &quot; + e.getMessage(), e);</span>
        }
    }

    private EncryptedValue encryptData(byte[] data)
       throws CRMFException
    {
<span class="nc" id="L138">        ByteArrayOutputStream bOut = new ByteArrayOutputStream();</span>

<span class="nc" id="L140">        OutputStream eOut = encryptor.getOutputStream(bOut);</span>

        try
        {
<span class="nc" id="L144">            eOut.write(data);</span>

<span class="nc" id="L146">            eOut.close();</span>
        }
<span class="nc" id="L148">        catch (IOException e)</span>
        {
<span class="nc" id="L150">            throw new CRMFException(&quot;cannot process data: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L151">        }</span>

<span class="nc" id="L153">        AlgorithmIdentifier intendedAlg = null;</span>
<span class="nc" id="L154">        AlgorithmIdentifier symmAlg = encryptor.getAlgorithmIdentifier();</span>
        DERBitString encSymmKey;

        try
        {
<span class="nc" id="L159">            wrapper.generateWrappedKey(encryptor.getKey());</span>
<span class="nc" id="L160">            encSymmKey = new DERBitString(wrapper.generateWrappedKey(encryptor.getKey()));</span>
        }
<span class="nc" id="L162">        catch (OperatorException e)</span>
        {
<span class="nc" id="L164">            throw new CRMFException(&quot;cannot wrap key: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L165">        }</span>

<span class="nc" id="L167">        AlgorithmIdentifier keyAlg = wrapper.getAlgorithmIdentifier();</span>
<span class="nc" id="L168">        ASN1OctetString valueHint = null;</span>
<span class="nc" id="L169">        DERBitString encValue = new DERBitString(bOut.toByteArray());</span>

<span class="nc" id="L171">        return new EncryptedValue(intendedAlg, symmAlg, encSymmKey, keyAlg, valueHint, encValue);</span>
    }

    private byte[] padData(byte[] data)
    {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (padder != null)</span>
        {
<span class="nc" id="L178">            return padder.getPaddedData(data);</span>
        }

<span class="nc" id="L181">        return data;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>