<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Database Integration - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=41288339"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                     <li><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                            </ul>
</div>            <h1 id="src-41288339"> <span>Database Integration</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>EJBCA relies on a shared database model, which means that any data two EJBCA nodes in a cluster shares must be in the common storage.</p>
<p   
>For this purpose EJBCA uses an SQL database. Not all SQL databases are however created equal and some are definitely more equal than others.</p>
    <div class="section section-1" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Technologyused">
        <h1 class="heading "><span>Technology used</span></h1>
<p   
>Java Persistence API (JPA) is part of the Java Enterprise Edition (JEE) standard and abstraction for talking to the database. JPA is an abstraction layer on to of Java DataBase Connector (JDBC) API.</p>
<p   
>Just like JDBC we perform operations on the database via a DataSource. The DataSource is either configured in the application server with JDBC driver and injected or manually configured using the JPA provider in stand-alone CLI mode.</p>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-UsingJEEforpersistenceandtransactionmanagement">
        <h2 class="heading "><span>Using JEE for persistence and transaction management</span></h2>
<p   
>We like to use JEE (Java Enterprise Edition) since it allows us to declare transaction boundaries instead of handling this pragmatically which becomes hairy when multiple modules of the application is involved.</p>
<p   
>Java Persistence API (JPA) is used to abstract away many aspects of database specific variants (and does so well, but not perfectly).</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-JavaPersistenceAPIandtheObjectRelationMapping">
        <h2 class="heading "><span>Java Persistence API and the Object Relation Mapping</span></h2>
<p   
>Object Relation Mapping (ORM) is how Java objects called Entities are mapped to database columns. These mappings are defined in orm-ejbca-{database}.xml files included from persistence.xml. ORM is great since it allows us (theoretically) to work mostly with Java objects and not care so much about the SQL.</p>
<p   
>The Java Persistence API Query Language (JPQL) is a simplified query language that further tries to abstract the specifics of different SQL dialects making the application more portable.</p>
<p   
>For advanced operations, like reading presence of indexes we still need to use direct lower level JDBC calls.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLVdoeW1ha2V0aGVleHRyYWVmZm9ydG9md3JpdGluZ2RhdGFiYXNlYWdub3N0aWNjb2RlPw">
        <h2 class="heading "><span>Why make the extra effort of writing database agnostic code?</span></h2>
<p   
>Because the AwesomeSQL DB that we rely on today might be bought up, perverted and/or killed in X years from now.</p>
<p   
>Keeping things &quot;simple&quot; (or at least agnostic) will allow us to migrate the customers data to another DB that happens to be the best at that point in time.</p>
    </div>
    </div>
    <div class="section section-1" id="src-41288339_id-.DatabaseIntegrationv6.10.0-TheBasicsandPracticalGuidelines">
        <h1 class="heading "><span>The Basics and Practical Guidelines</span></h1>
<p   
>EJBCA relies on the Hibernate implementation as JPA provider even though we theoretically should be able to support others as long as we adhere to the standard.</p>
<p   
>We bundle the Hibernate JPA provider on application servers that does not provide it and use it in the EJBCA DB CLI.</p>
<p   
>If a new field is added to a Entity (mapped Java object), all these files must be updated and new table create scripts should be created for all databases.</p>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Whattodo">
        <h2 class="heading "><span>What to do </span></h2>
<ul class=" "><li class=" "><p   
>Use UpgradableHashMap for all non-searchable fields and store it as a CLOB. XML Serialize using Base64 (or maybe UTF-8).</p>
</li><li class=" "><p   
>Use simple types like int, long and String</p>
</li><li class=" "><p   
>Set a default value for non-nullable fields in the Entity constructor.</p>
</li><li class=" "><p   
>Don't construct queries as Strings. Use Query.setParameter(String, Object) instead.</p>
</li><li class=" "><p   
>Mark methods in Entites that begin with &quot;get&quot; with @Transient if you don't intend to map it to database column.</p>
</li><li class=" "><p   
>Use transactions if you update or insert</p>
</li><li class=" "><p   
>Don't require transactions if you only read (but it can still support transactions)</p>
</li><li class=" "><p   
>A declared transaction is only invoked when a method is invoked through an EJB interface.</p>
</li><li class=" "><p   
>Update org.ejbca.core.ejb.DatabaseSchemaTest to verify that your mapping can hold what you think it can. This tests also acts as documentation for maximum allowed size of different fields.</p>
</li><li class=" "><p   
>Read the rest of this document if you intend to make changes.</p>
</li></ul>    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Whatnottodo">
        <h2 class="heading "><span>What not to do </span></h2>
<ul class=" "><li class=" "><p   
>Don't use boolean data-type. Use an interger with value 0 (false) or 1 (true) instead. For example Ingres 9.x does not support BOOLEAN.</p>
</li><li class=" "><p   
>Don't use foreign keys. For example MySQL's MyISAM engine does not support foreign keys.</p>
</li><li class=" "><p   
>Don't use BLOB or try to store complex Java objects directly. JBoss Serilization in EJB 2.1 somewhat locked in the EJBCA user to the JBoss platform.</p>
</li><li class=" "><p   
>Don't expect an insert to fail (throw an Exception) in the middle of a transaction if it already exists. This will fail at commit-time.</p>
</li><li class=" "><p   
>Don't take Serializable isolation mode for granted. Different databases will be configured differently.</p>
</li><li class=" "><p   
>Store Date's as something other than &quot;long&quot; (in milliseconds).</p>
</li><li class=" "><p   
>Don't name database column after reserved words on _any_ database. We might support additional databases in the future&hellip;</p>
</li><li class=" "><p   
>Read the rest of this document if you intend to make changes.</p>
</li></ul><p   
>Database connections and statements with direct JDBC .</p>
<p   
>In some advanced use cases where direct JDBC is required, it is very important to clean up properly to avoid resource leakage.</p>
<p   
>Use the Java 7 try-with-resource-pattern under these circumstances:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">try (final Connection connection = dataSource.getConnection();) {</code></div>
<div class="line"><code class="plain">	final DatabaseMetaData databaseMetaData = connection.getMetaData();</code></div>
<div class="line"><code class="plain">	try (final ResultSet resultSetSchemas = databaseMetaData.getTables(null, null, null, null))</code></div>
<div class="line"><code class="plain">	{</code></div>
<div class="line"><code class="plain">            ...</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>You cannot count on that JDBC updates of a database is available from the current transaction and vice versa. So don't mix JDBC rows operations and JPA Entity operations.</p>
    </div>
    </div>
    <div class="section section-1" id="src-41288339_id-.DatabaseIntegrationv6.10.0-WritingdatabaseagnosticcodewithJavaPersistenceAPI">
        <h1 class="heading "><span>Writing database agnostic code with Java Persistence API</span></h1>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLVJ1bGUjMTpZb3VjYW4ndGlnbm9yZXRoZXJlYWxpdGllc29mdGhldW5kZXJseWluZ2RhdGFiYXNl">
        <h2 class="heading "><span>Rule #1: You can't ignore the realities of the underlying database</span></h2>
<p   
>It might look like you are juggling nice POJOs with some annotations in basic examples, but you are not (only) really doing that. There is a database behind all those shiny POJOs, so read the rest. <img  class="emoticon emoticon-smile"  src="images/s/en_US/8100/b0984b7297905b7c7bd946458f753ce0130bfc8c/_/images/icons/emoticons/smile.svg" alt="images/s/en_US/8100/b0984b7297905b7c7bd946458f753ce0130bfc8c/_/images/icons/emoticons/smile.svg"   />
</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-JPACriteriaAPIisnotgreatforunderstandingwhatwillbeexecuted">
        <h2 class="heading "><span>JPA Criteria API is not great for understanding what will be executed</span></h2>
<p   
>It is great for building dynamic and advanced queries, but a simple TypedQuery created as a String shows directly what will be executed without having to debug log the actual generated query from the CriteriaBuilder. Keep it simple unless you have to be super-flexible.</p>
<p   
>NEVER add untrusted input to the query String, always use setParameter(...) calls.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-AlwaysdefinetheORMforeachdatabasetype">
        <h2 class="heading "><span>Always define the ORM for each database type</span></h2>
<p   
>Each JPA provider (and version of the same) like Hibernate might map a Java type to a completely different database column type.</p>
<p   
>If we don't define the column type, we might end up with different database schemes for two customers that run different versions of the same application server even though they have the same database.</p>
<p   
>By having this well defined there will be no unpleasant automatic schema updates that prevents 100% uptime for the customer and we have an easier time trying to reproduce the customers environment when needed.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0dXNlQkxPQnNmb3JieXRl">
        <h2 class="heading "><span>Don't use BLOBs for byte</span></h2>
<p   
>Stick to the simple data types. For example Postgres will store them separated from the rest of the row data. When the row is removed, the BLOB will remain on storage.</p>
<p   
>Base64-encode the data. Store it as a CLOB. Enable compression in the database engine to get back the lost space if needed.</p>
<p   
>On Postgres, don't define the CLOB TEXT column as &lt;lob/&gt; (it will be stored of table exactly like we tried to avoid in the first place).</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0dXNlc3RvcmVkcHJvY2VkdXJlcw">
        <h2 class="heading "><span>Don't use stored procedures</span></h2>
<p   
>No. It wont be easy portable. Stick to more generic optimization techniques instead.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUF2b2lkQ09VTlQoKik">
        <h2 class="heading "><span>Avoid COUNT(*)</span></h2>
<p   
>For example Postgres and Oracle will really count every single row in the table &rarr;Full table scan.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUF2b2lkYm9vbGVhbi9Cb29sZWFu">
        <h2 class="heading "><span>Avoid boolean / Boolean</span></h2>
<p   
>Stick to the simple data types. Ingres followed an older version of the SQL standard and there is no boolean database type there. Use int / Integer with value (null,) 0 and 1 instead. Provide transient boolean getters and setters for your code.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-StoreemptyStringsinnullablecolumnsasNULL">
        <h2 class="heading "><span>Store empty Strings in nullable columns as NULL</span></h2>
<p   
>Oracle and DB2 in Oracle compatibility mode will do this anyway, so if you are hacking away on another database you might not realize the NPEs you are creating otherwise.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-NameJPAgettersandsettersforCLOBszzzSomething">
        <h2 class="heading "><span>Name JPA getters and setters for CLOBs zzzSomething</span></h2>
<p   
>Yep. Really. Oracle requires inserts of CLOBs to be last of the prepared statement and Hibernate will (currently 2017 at least) sort by these names. Still define the column name as &quot;something&quot; and provide getSomething() and setSomething() accessors for the rest of the code to use.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Checkthatyourqueryexecutionplanisdatabaseagnostic">
        <h2 class="heading "><span>Check that your query execution plan is database agnostic</span></h2>
<p   
>Don't assume that a query execution plan is database agnostic from an observation on your machine. It might very well be dependent on the how the database is currently populated and the specific type of database prioritizes.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0YXNzdW1ldGhhdHRoZWxvY2FsZW9mdGhlZGF0YWJhc2Vpc2tub3du">
        <h2 class="heading "><span>Don't assume that the locale of the database is known</span></h2>
<p   
>Sorting using ORDER BY might not yield the result you expect. Doing toLower() on data in the hope of being able to do case-insensitive search might fail in an Unicode world.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-JPAqueriesmightscanalltherowsyouwantittoignore">
        <h2 class="heading "><span>JPA queries might scan all the rows you want it to ignore</span></h2>
<p   
>Using setFirstResult on a JPA query might still scan all the rows you want it to ignore. Pagination with proper cleanup or sorting with &quot;greater than&quot; might be (less ideal, but anyhow) working solutions.</p>
<p   
>Don't use pagination if the database client will hit different EJBCA nodes with consecutive requests for next page.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUxpbWl0c2Zvcmhvd3dpZGVhcm93YW5kL29yaW5kZXhtYXliZQ">
        <h2 class="heading "><span>Limits for how wide a row and/or index may be</span></h2>
<p   
>There are limits for how wide a row and/or index may be in bytes on certain databases. If data doesn't need to be searchable, put it in a CLOB. It is not uncommon that a &quot;char&quot; might map to 3 bytes.</p>
<p   
>MySQL NDB cluster has historically been the most picky of the supported database, which makes it a good candidate to check for restrictions first.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Calculatingchecksumsondatabaserows">
        <h2 class="heading "><span>Calculating checksums on database rows</span></h2>
<p   
>When calculating checksums on database rows, perform calculation on actual data written. This is not as much a database question, commonly used for our database protection pattern in JPA entities.</p>
<p   
>Do the checksum over the actually written or read CLOB content instead of Java objects like Map that might not be as deterministic between Java versions as we would hope.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-AlldatesareUnixepochtime64-bitnumbers">
        <h2 class="heading "><span>All dates are Unix epoch time 64-bit numbers</span></h2>
<p   
>Stick to the simple data types. The code can easily work with this and there is no need to special time database column types.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-ReadandwritetheORMcommentssection">
        <h2 class="heading "><span>Read and write the ORM comments section</span></h2>
<p   
>This might inform you about additional quirks and limitations for proper mapping on the specific database type.</p>
<p   
>Also, please don't invent new type of column mappings unless you have properly researched the subject. It helps if the JPA provider has rather similar mapping to our custom one when it does validation and parsing of data.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-StoreanupgradeableJavaobjectasaCLOB">
        <h2 class="heading "><span>Store an upgradeable Java object as a CLOB</span></h2>
<p   
>An upgradeable Java object stored as a CLOB is easier to upgrade than the schema. If a fields doesn't have to be searchable, it can easily be added or removed from inside a CLOB without schema changes that might be painful for the customers.</p>
<p   
>(And if we have a policy to only make schema changes in major releases, this will allow us to add new data in minor releases as well.)</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Avoidwordsthatarereservedonanydatabase">
        <h2 class="heading "><span>Avoid words that are reserved on any database</span></h2>
<p   
>Don't use words that are reserved on any database. It is usually quite easy to find good list of what this might be. For example a working link 2017-03-31 is <a  class="external-link" href="https://www.drupal.org/docs/develop/coding-standards/list-of-sql-reserved-words">https://www.drupal.org/docs/develop/coding-standards/list-of-sql-reserved-words</a> .</p>
    </div>
    </div>
    <div class="section section-1" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Makingefficientuseofthedatabasefromthecode">
        <h1 class="heading "><span>Making efficient use of the database from the code</span></h1>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Avoidforeignkeymappingondatabaselevel">
        <h2 class="heading "><span>Avoid foreign key mapping on database level</span></h2>
<p   
>Avoiding foreign key mapping on database level makes Create, Read, Update, Delete (CRUD) simpler. In a perfect world it would make things easier, but perhaps you figure out that you really want to orphan an entry (let say a log entry you want to keep pointing to an object you want to remove).</p>
<p   
>Even if orphaning seems like a bad idea when designing a feature, keeping a virtual foreign key relation in the code allows this to be more easily changed in the unknown future.</p>
<p   
>Some databases engines like TokuDB or MySQL's MyIsam don't support foreign keys (but MyIsam does not support transactions either which makes it rather useless for advanced data operations.)</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0bm9ybWFsaXpldG9vaGFyZA">
        <h2 class="heading "><span>Don't normalize too hard</span></h2>
<p   
>If you end up doing an additional query to another table each time you fetch something, perhaps you should just have the data in the original row in the fist place and save a round-trip. Mind however that you need to keep replicas of data in sync when they change.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0YWRkbW9yZWluZGV4ZXN0aGFueW91cmVhbGx5bmVlZA">
        <h2 class="heading "><span>Don't add more indexes than you really need</span></h2>
<p   
>Whenever you do an update, your indexes over the updated data also needs to be updated. This makes updates slower.</p>
<p   
>Indexes might also share RAM with caches so consider if scanning through a few recently used rows that fit into memory is better a lookup table for fetching entries from disk. (A bit exaggerated.)</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Therearetwowaystouseindexes">
        <h2 class="heading "><span>There are two ways to use indexes</span></h2>
<p   
>Narrow down the number of rows (primary keys) for the rest of the query to search through or act an extra value lookup table (where no row lookup by primary key is needed).</p>
<p   
>Make sure you know why you added an index and why you selected the order of the columns in the way that you did.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Beoptimisticwhenlockingupdates">
        <h2 class="heading "><span>Be optimistic when locking updates</span></h2>
<p   
>Most of the time you wont have conflicting updates. Use optimistic locking (fail if there was concurrent conflicting updates) instead of blocking others from reading the stuff you want to involve in you transactions. No-one likes to wait.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0bWFrZXVwZGF0ZXN0aGF0ZG9uJ3RjaGFuZ2Vhbnl0aGluZw">
        <h2 class="heading "><span>Don't make updates that don't change anything</span></h2>
<p   
>Updating an object in the beginning of a transaction and then updating it back in the end will is a good way to waste locking and increases the probability that you will have conflicting updates.</p>
<p   
>Only tell the database about changes that actually change something and only do it once if you can.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Readobjectsonce">
        <h2 class="heading "><span>Read objects once</span></h2>
<p   
>Even if the object will be cached, it probably means that you are doing something wrong or have a problem with the module architecture if you need to ask the database for the same object twice.</p>
<p   
>And read the full object right away (eager loading) unless you are really sure that you wont use the rest so you don't end up with another round-trip to fetch the &quot;last&quot; pieces data.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Betolerantandidempotent">
        <h2 class="heading "><span>Be tolerant and idempotent</span></h2>
<p   
>If something is gone when you are trying to delete it, was it really a failure? If you make an update but the database already had the correct value, was it a failure? Sometimes yes (think atomic counters).</p>
<p   
>Most of the time however this is perfectly fine and instead of telling the EntityManager to delete a specific object, you can do an update query that removed any object that has this unique primary key.</p>
<p   
>Note that partial update queries are harder or impossible when each row is signed. But at least it is nice to not fail hard if the object is already updated with a correct value.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0c3RhcnRhdHJhbnNhY3Rpb251bmxlc3N5b3VpbnRlbmR0b3VzZWl0">
        <h2 class="heading "><span>Don't start a transaction unless you intend to use it</span></h2>
<p   
>If you are just going to read a value you are not going to mandate that it happens in a transaction.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Makesurethatyouaretransactionalwhenneeded">
        <h2 class="heading "><span>Make sure that you are transactional when needed </span></h2>
<p   
>If you are going to make changes that depend on input, your want to make sure that you do require a transaction and those readers support transactions.</p>
    </div>
    <div class="section section-2" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLURvbid0c3ByZWFkeW91cm9wZXJhdGlvbnNvdmVyYWxvdG9mc21hbGxzdWItdHJhbnNhY3Rpb25z">
        <h2 class="heading "><span>Don't spread your operations over a lot of small sub-transactions</span></h2>
<p   
>If you make many small sub-transactions and you have a database system without a battery backed-up cache, you will need to wait for each such transaction to be flushed to disks or cluster. Making all the changes in a single transaction would only require the client to wait for this operation once.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Interactingwithexternalnon-transactionalsystems">
        <h2 class="heading "><span>Interacting with external non-transactional systems</span></h2>
<p   
>If you involve external systems in a transaction, you are responsible for rolling back changes if the overall transaction is rolled back.</p>
<p   
>The sane thing to do is to not start the transaction at the border to the client, but instead in an internal call where the outcome can be monitored. The intent to interact with such external systems should be committed an queue as part of the inner transaction. If the inner transactions succeeds each such intent could be performed by background threads and taken off the intent-queue. The main call can choose weather to wait for these to complete or let them happen eventually/asynchronously.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Updatesmightleadtofragmentationofstorage">
        <h2 class="heading "><span>Updates might lead to fragmentation of storage</span></h2>
<p   
>Some databases might never modify written storage. When an existing row is &quot;modified&quot; it simply means that a new row is added marked with the id of the transaction that added it. This makes it easy for different transactions to include the line where the transaction id is confirmed and exclude those like where it isn't. The old row is then eventually garbage collected. Similar reasoning can happen when compression is used and the new data exceeds the existing allocated row space with fragmentations as a result.</p>
<p   
>This can be avoided by trying to organize data so that static data belonging to an object is stored in one table and dynamic data is organized into another table. This works better if the object will live for a long time and the dynamic part of the object is small. The dynamic part can even be made append-only with timestamps if lookup of the latest item is made fast (few items or indexes).</p>
<p   
>Having append only data with timestamps can also be used to tolerate merge after split-brain scenarios (or active-active asynchronous setups) where the application can determine from an objects history what the actual state of things is.</p>
    </div>
    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Behumanreadableifyoucanaffordit">
        <h2 class="heading "><span>Be human readable if you can afford it</span></h2>
<p   
>For debug and potential use by future clients, it is nice if non-searchable is readable in its raw (CLOB) form.</p>
<p   
>You should still encode non-ASCII UTF-8 Strings as Base64 in for non-searchable data to ensure what is written in one version will be correctly read by another version. (Remember that people upgrade their systems and might forget to change the specified encoding in the JDBC URL or other parts of the environment that is outside the control of the application.) This does not mean that you need to Base64-encode the entire CLOBs so that numbers and ASCII strings (like property keys and enums) are unreadable from looking at the raw data.</p>
<p   
>Opportunistic base64-encoding would be your friend and store all values in the CLOB in a semi-human-readable data format (like JSON or XML).</p>
    </div>
    </div>
    <div class="section section-1" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLU1ha2luZzEwMCV1cHRpbWVjb21wYXRpYmxlY29kZQ">
        <h1 class="heading "><span>Making 100% uptime compatible code</span></h1>
<p   
>The idea to make this work is quite simple, but hard to implement.</p>
<ul class=" "><li class=" "><p   
>It is allowed to add completely new tables</p>
</li><li class=" "><p   
>It is allowed to add completely new columns that are nullable (this requires that the database type can add new columns to large tables without locking the table for ongoing operations)</p>
</li><li class=" "><p   
>Old data that is no longer used should simply be ignored if it is nullable, but needs to be mapped and set to some default value if it is required by the schema.</p>
</li><li class=" "><p   
>Strategies for upgrading of how data is used or when existing functionality is extended is described below.</p>
</li></ul>    <div class="section section-2" id="src-41288339_id-.DatabaseIntegrationv6.10.0-UpgradingformatofdataXfromX1toX2">
        <h2 class="heading "><span>Upgrading format of data X from X1 to X2</span></h2>
<p   
>Note that these strategies applies both to searchable columns and application-serialized CLOB data.</p>
<p   
>The strategies depend on the following:</p>
<ul class=" "><li class=" "><p   
>Old nodes read and writes in old format X1. (Nothing we can really do about this.)</p>
</li><li class=" "><p   
>New nodes can read and write data both old format X1 and new format X2.</p>
</li></ul>    <div class="section section-3" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUFsZ29yaXRobSJBbHNvd3JpdGVpbmxlZ2FjeWZvcm1hdCI">
        <h3 class="heading "><span>Algorithm &quot;Also write in legacy format&quot;</span></h3>
<p   
>This is suitable for large data sets where migration of the data might not be feasible. There is need to wait for / check if all nodes have been upgraded.</p>
<p   
>Code to be able to read old format needs to be kept until data objects are no longer used (or can be assumed to have never been written in the old format.)</p>
<ul class=" "><li class=" "><p   
>New nodes write data in new format X2 and also old format X1</p>
</li></ul><ul class=" "><li class=" "><p   
>New nodes aways try to read the new format X2 first</p>
<ul class=" "><li class=" "><p   
>if X2 data is present, ignore the data in X1 format (faster once everything is upgraded)</p>
</li><li class=" "><p   
>if no X2 data is present, read the data as format X1</p>
</li></ul></li></ul>    </div>
    <div class="section section-3" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUFsZ29yaXRobSJUb2xlcmF0ZWFuZGtlZXBsZWdhY3lmb3JtYXQi">
        <h3 class="heading "><span>Algorithm &quot;Tolerate and keep legacy format&quot;</span></h3>
<p   
>This is suitable for large data sets where migration of the data might not be feasible.</p>
<p   
>Code to be able to read old format needs to be kept until data objects are no longer used (or can be assumed to have never been written in the old format.)</p>
<ul class=" "><li class=" "><p   
>New nodes write data in old format X1 until all nodes are running the new version.</p>
</li><li class=" "><p   
>New nodes aways try to read the new format X2 first</p>
<ul class=" "><li class=" "><p   
>if X2 data is present, ignore the data in X1 format (faster once everything is upgraded)</p>
</li><li class=" "><p   
>if no X2 data is present, read the data as format X1</p>
</li></ul></li></ul>    </div>
    <div class="section section-3" id="src-41288339_safe-id-aWQtLkRhdGFiYXNlSW50ZWdyYXRpb252Ni4xMC4wLUFsZ29yaXRobSJNaWdyYXRlZXZlcnl0aGluZ3RvbmV3Zm9ybWF0Ig">
        <h3 class="heading "><span>Algorithm &quot;Migrate everything to new format&quot;</span></h3>
<p   
>This is suitable for small data sets where migration of the data is feasible.</p>
<p   
>Code to be able to read old format can be phased out when upgrading from a version where writing this was used is no longer supported.</p>
<ul class=" "><li class=" "><p   
>New nodes write data in new format X2. New nodes also write data in old format X1 and until all nodes are running the new version.</p>
</li><li class=" "><p   
>New nodes aways try to read the new format X2 first</p>
<ul class=" "><li class=" "><p   
>if X2 data is present, ignore the data in X1 format (faster once everything is upgraded)</p>
</li><li class=" "><p   
>if no X2 data is present, read the data as format X1</p>
</li></ul></li><li class=" "><p   
>When last node is upgraded all existing rows are read and written in the new format.</p>
</li></ul>    </div>
    </div>
    </div>
    <div class="section section-1" id="src-41288339_id-.DatabaseIntegrationv6.10.0-Settingupdevelopmentenvironmentsforthesupporteddatabases">
        <h1 class="heading "><span>Setting up development environments for the supported databases</span></h1>
<p   
>Normally EJBCA expects the &quot;Read Committed&quot; transaction isolation level. Make sure that the database is set up for this. Too strict and you might end up in dead-locks, too weak and your transactions make make calculations on data that will be rolled back.</p>
<p   
>Below is a set of (by now pretty outdated) instructions for how to setup test environments for different database from the old EJBCA wiki. Please replace this with updated, working and proper confluence pages if you have to do any of these setups.</p>
<p   
></p>
<p   
><img    src="images/inline/32e7561242ed3e8e61ecbd02d2c2d497cef27f83.png" alt="images/inline/32e7561242ed3e8e61ecbd02d2c2d497cef27f83.png"  height="250" />
<img    src="images/inline/4df88ec41cd59040abb236b46d380012b2133c6a.png" alt="images/inline/4df88ec41cd59040abb236b46d380012b2133c6a.png"  height="250" />
<img    src="images/inline/2272822887676f00fdad6c026c5f5fa8c2dc6607.png" alt="images/inline/2272822887676f00fdad6c026c5f5fa8c2dc6607.png"  height="250" />
<img    src="images/inline/fcda653f2a5543fc35473f9af8fe904dad768f47.png" alt="images/inline/fcda653f2a5543fc35473f9af8fe904dad768f47.png"  height="250" />
<img    src="images/inline/f84931bedd8628ae8ec815759c9f417dcf4cb8c6.png" alt="images/inline/f84931bedd8628ae8ec815759c9f417dcf4cb8c6.png"  height="250" />
<img    src="images/inline/d7f45f577e2c47aeb5b5185ea01991c54afc8967.png" alt="images/inline/d7f45f577e2c47aeb5b5185ea01991c54afc8967.png"  height="250" />
<img    src="images/inline/e6126c9a3b90ab63650796d657c2092e68b9e68a.png" alt="images/inline/e6126c9a3b90ab63650796d657c2092e68b9e68a.png"  height="250" />
</p>
<p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="SensorNet_PKI.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>SensorNet PKI</span>
        </a>
                <a href="Hardware_Security_Modules_%28HSM%29.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Hardware Security Modules (HSM)</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
