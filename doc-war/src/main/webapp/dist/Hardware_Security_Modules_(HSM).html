<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Hardware Security Modules (HSM) - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=22380948"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                     <li><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                            </ul>
</div>            <h1 id="src-22380948"> <span>Hardware Security Modules (HSM)</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>EJBCA has support for several Hardware Security Modules (HSMs) and each HSM has its own specific interface for key generation and maintenance, independent of EJBCA. Make sure you are familiar with how your HSM works.</p>
<p   
>This section provides information on Hardware Security Modules (HSMs) in the following sections:</p>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTW1vZHVsZXNhdmFpbGFibGVpbnRoZUFkbWluR1VJSFNNX21vZHVsZXNfYXZhaWxhYmxlX2luX3RoZV9BZG1pbl9HVUk">HSM modules available in the Admin GUI</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbmZpZ3VyaW5nSFNNc0NvbmZpZ3VyaW5nX0hTTXM">Configuring HSMs</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVRlc3RpbmdQS0NTIzExa2V5c2ZvcnVzZWJ5RUpCQ0FUZXN0aW5nX1BLQ1MjMTFfa2V5c19mb3JfdXNlX2J5X0VKQkNB">Testing PKCS#11 keys for use by EJBCA</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUF1dG8tYWN0aXZhdGlvbm9mQ3J5cHRvVG9rZW5zQXV0by1hY3RpdmF0aW9uX29mX0NyeXB0b19Ub2tlbnM">Auto-activation of Crypto Tokens</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTXNhbmREU0FvckVDRFNBSFNNc19hbmRfRFNBX29yX0VDRFNB">HSMs and DSA or ECDSA</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyaWNQS0NTIzExcHJvdmlkZXJHZW5lcmljX1BLQ1NfMTFfcHJvdmlkZXI">Generic PKCS#11 provider</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVV0aW1hY29fQ3J5cHRvU2VydmVyVXRpbWFjb0NyeXB0b1NlcnZlcg">Utimaco CryptoServer</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfblNoaWVsZC9uZXRIU01uQ2lwaGVyblNoaWVsZC9uZXRIU00">nCipher nShield/netHSM</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfbG9hZF9iYWxhbmNpbmduQ2lwaGVybG9hZGJhbGFuY2luZw">nCipher load balancing</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFFUF9LZXlwZXJBRVBLZXlwZXI">AEP Keyper</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFSWF9Db1NpZ25BUlhDb1NpZ24">ARX CoSign</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUHJvdGVjY2lvQnVsbFRydXN0d2F5UHJvdGVjY2lv">Bull Trustway Proteccio</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUENJX0NyeXB0b19DYXJkQnVsbFRydXN0d2F5UENJQ3J5cHRvQ2FyZA">Bull Trustway PCI Crypto Card</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfTHVuYVNhZmVOZXRMdW5h">SafeNet Luna</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfUHJvdGVjdFNlcnZlclNhZmVOZXRQcm90ZWN0U2VydmVy">SafeNet ProtectServer</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNtYXJ0Q2FyZC1IU01TbWFydENhcmQtSFNN">SmartCard-HSM</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNvZnRIU01Tb2Z0SFNN">SoftHSM</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVBLQ1MxMVNweQ">PKCS11 Spy</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVN1cHBvcnRmb3JuZXdIU01zU3VwcG9ydF9mb3JfbmV3X0hTTXM">Support for new HSMs</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVVzaW5nX1NIQTI1NldpdGhSU0FhbmRNR0YxXyhSU0FTU0EtUFNTKVVzaW5nU0hBMjU2V2l0aFJTQWFuZE1HRjEoUlNBU1NBLVBTUyk">Using SHA256WithRSAandMGF1 (RSASSA-PSS)</a></p>
</li><li class=" "><p   
><a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUV4dGVuZGluZ19TdW5fUEtDUyMxMV90b19zZXRfQ0tBX01PRElGSUFFeHRlbmRpbmdTdW5QS0NTIzExdG9zZXRDS0FfTU9ESUZJQUJMRT1mYWxzZQ">Extending Sun PKCS#11 to set CKA_MODIFIABLE=false</a></p>
</li></ul>    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTW1vZHVsZXNhdmFpbGFibGVpbnRoZUFkbWluR1VJSFNNX21vZHVsZXNfYXZhaWxhYmxlX2luX3RoZV9BZG1pbl9HVUk">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTV9tb2R1bGVzX2F2YWlsYWJsZV9pbl90aGVfQWRtaW5fR1VJ" class="confluence-anchor-link"></span><span>HSM modules available in the Admin GUI </span></h1>
<p   
>You can manage crypto tokens fully in the EJBCA Admin GUI or CLI. and the Admin GUI automatically displays the HSMs available in your system.</p>
<p   
>When creating a new Crypto Token (<strong class=" ">Crypto Tokens&gt;Create New</strong>) you can select between Soft and PKCS#11 crypto tokens.</p>
<ul class=" "><li class=" "><p   
>The PKCS#11 option is only available if EJBCA is able to find any known PKCS#11 modules in the file system.</p>
</li></ul><p   
>If EJBCA finds known PKCS#11 modules in the file system, you can select PKCS#11 as <strong class=" ">Type.</strong> As <i class=" ">PKCS#11 Library</i> there is a list of the available known HSMs found in the file system.</p>
<p   
>If the PKCS#11 option is not available or your desired HSM is not in the list of available Libraries, there are a few options to configure:</p>
<ul class=" "><li class=" "><p   
>If you are using JBoss 7 you must make the java PKCS#11 classes exportable. For more information, see <a   href="Application_Servers.html">Application Servers</a>.</p>
</li><li class=" "><p   
>You can configure PKCS#11 modules that are not already known to EJBCA in conf/web.properties. See conf/web.properties.sample how to add new known modules and override existing (overriding should not be needed since you can add new locations with the same name).</p>
</li></ul><p   
>    <span style="color: #000000;">
For more information on creating and using     <span style="color: #000000;">
Crypto Tokens for HSMs, see <a   href="Managing_Crypto_Tokens.html">Managing Crypto Tokens</a> and <a   href="Managing_CAs.html">Managing CAs</a>.    </span>
<br/>    </span>
</p>
<p   
>The following sections describe the underlying operations and technical features of using HSMs and PKCS#11.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbmZpZ3VyaW5nSFNNc0NvbmZpZ3VyaW5nX0hTTXM">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbmZpZ3VyaW5nX0hTTXM" class="confluence-anchor-link"></span><span>Configuring HSMs </span></h1>
<p   
>The GUI configuration of CAs is backed by a properties field where properties unique to a particular CAs usage of the HSM is specified. All implemented HSM modules are using the same property keywords to define the identity and the purpose of the keys to be used. These keywords are:</p>
<ul class=" "><li class=" "><p   
>certSignKey: Key used when signing certificates, can be RSA or ECDSA.</p>
</li><li class=" "><p   
>crlSignKey: Key used when signing CLSs, can be RSA or ECDSA.</p>
</li><li class=" "><p   
>keyEncryptKey: Key used for key encryption and decryption, this must be an RSA key.</p>
</li><li class=" "><p   
>testKey: Key used by HSM status checks, can be RSA or ECDSA.</p>
</li><li class=" "><p   
>hardTokenEncrypt: Key used for hardtoken encryption and decryption. PUK will be decrypted by this key.</p>
</li><li class=" "><p   
>defaultKey: Key used when no other key is defined for a purpose. If this is the only definition, then this key will be used for all purposes.</p>
</li><li class=" "><p   
>pin: Optional pin code used for auto-activation of CA token, see below. Not recommended for high security set-ups, but very useful in some cases.</p>
</li></ul><p   
>You may omit defaultKey if you want to be sure that the right key is used, but then all the other keys must be specified. It is recommended that the certificate and CRL signing keys are linked to the same key since different keys are rarely supported by verifying applications.</p>
<p   
>When implementing support for a new HSM the <strong class=" ">KeyStrings</strong> class could be used to manage the key properties described above. When it is an JCA/JCE API for the HSM it could also be wise to extend the BaseCAToken class.</p>
<p   
>The same activation code must be used for all keys used by a CA.</p>
<p   
>There are four additional key properties that can (optionally) be used when renewing CA keys and to produce roll-over certificates. Some of these (in particular the <strong class=" ">next</strong> keys) are only used when using API methods (such as WS).</p>
<ul class=" "><li class=" "><p   
>previousCertSignKey : Alias of the previous signature key, as opposed to <strong class=" ">certSignKey</strong> which is the current signature key.</p>
</li><li class=" "><p   
>previousSequence: Sequence identifying the previous signature key, as opposed to the current sequence that is held in the CA token. This sequence will replace the current sequence in the caRef field when signing a request with the CAs previous key.</p>
</li><li class=" "><p   
>nextCertSigningKey: Alias of a new generated key on the HSM. When updating a CA signed by an external CA this is used to send a request, but the CA is still active using the old key. When the certificate response is received this key is activate and moved to certSignKey/crlSignKey.</p>
</li><li class=" "><p   
>nextSequence: Sequence identifying the next signature key.</p>
</li></ul><p   
>Supported and tested HSMs are described below, with sample configurations and HSM specific documentation.</p>
<p   
>As of EJBCA 3.6, the recommended HSM connector to use the PKCS#11 interface. Older JCE implementations are deprecated and removed. Contact PrimeKey if you need to migrate.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVRlc3RpbmdQS0NTIzExa2V5c2ZvcnVzZWJ5RUpCQ0FUZXN0aW5nX1BLQ1MjMTFfa2V5c19mb3JfdXNlX2J5X0VKQkNB">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVRlc3RpbmdfUEtDUyMxMV9rZXlzX2Zvcl91c2VfYnlfRUpCQ0E" class="confluence-anchor-link"></span><span>Testing PKCS#11 keys for use by EJBCA </span></h1>
<p   
>To test keys on the HSM for use by EJBCA, you can use the <a   href="EJBCA_Client_Toolbox.html">EJBCA Client Toolbox</a>.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ant clientToolBox</code></div>
<div class="line"><code class="functions">cd</code><code class="plain"> dist</code><code class="plain">/clientToolBox</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool </code><code class="functions">test</code></div>
</div>
    </div>
<p   
>The command gives further instructions about the parameters required, PKCS#11 library and slot.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUF1dG8tYWN0aXZhdGlvbm9mQ3J5cHRvVG9rZW5zQXV0by1hY3RpdmF0aW9uX29mX0NyeXB0b19Ub2tlbnM">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUF1dG8tYWN0aXZhdGlvbl9vZl9DcnlwdG9fVG9rZW5z" class="confluence-anchor-link"></span><span>Auto-activation of Crypto Tokens </span></h1>
<p   
>The <strong class=" ">pin</strong> property is used to be able to automatically activate a CA token. The activation code may be specified in the property field with the keyword <strong class=" ">pin</strong>. If this property is not specified, then the CA has to be manually activated after each restart or re-deployment of EJBCA. Manual activation is done in the Admin GUI under <strong class=" ">Basic Functions &gt; View Information</strong> or using the cli <strong class=" ">bin/ejbca.sh ca activateca</strong>.</p>
<p   
>The <strong class=" ">pin</strong> property can use a clear text password or an encrypted one.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">pin foo123</code></div>
<div class="line"><code class="plain">pin 6bc841b2745e2c95e042a68b4777b34c</code></div>
</div>
    </div>
<p   
>These two properties contain the same password. The obfuscated pin value can be obtained with the command <strong class=" ">bin/ejbca.sh encryptpwd</strong>:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ bin</code><code class="plain">/ejbca</code><code class="plain">.sh encryptpwd foo123</code></div>
<div class="line"><code class="plain">Using JBoss JNDI provider...</code></div>
<div class="line"><code class="plain">Please note that this encryption does not provide absolute security, ....</code></div>
<div class="line"><code class="plain">Enter word to encrypt:</code></div>
<div class="line"><code class="plain">hidden</code></div>
<div class="line"><code class="plain">Encrypting </code><code class="functions">pwd</code><code class="plain">...</code></div>
<div class="line"><code class="plain">6bc841b2745e2c95e042a68b4777b34c</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>This encrypted password is not a high security encryption. If the <strong class=" ">password.encryption.key</strong> property has not been customized it will not provide more security than just preventing accidental viewing since an EJBCA built-in encryption key is used. If an attacker gets hold of the encrypted password and the <strong class=" ">password.encryption.key</strong> has not been customized, the password can be decrypted using the source code of EJBCA</p>
        </div>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTXNhbmREU0FvckVDRFNBSFNNc19hbmRfRFNBX29yX0VDRFNB">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUhTTXNfYW5kX0RTQV9vcl9FQ0RTQQ" class="confluence-anchor-link"></span><span>HSMs and DSA or ECDSA </span></h1>
<p   
>Support for DSA or ECDSA in HSMs are dependent on the support for the algorithms in the HSM. You have to check if that support is available.</p>
<p   
>For more information on HSMs and ECDSA, see <a   href="ECDSA_Keys_and_Signatures.html">ECDSA Keys and Signatures</a>.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyaWNQS0NTIzExcHJvdmlkZXJHZW5lcmljX1BLQ1NfMTFfcHJvdmlkZXI">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyaWNfUEtDU18xMV9wcm92aWRlcg" class="confluence-anchor-link"></span><span>Generic PKCS#11 provider </span></h1>
<p   
>A PKCS#11 wrapper has been used to implement support for tokens with PKCS#11 libraries. The PKCS#11 provider is tested with:</p>
<ul class=" "><li class=" "><p   
>Utimaco CryptoServer</p>
</li><li class=" "><p   
>nCipher nShield/netHSM</p>
</li><li class=" "><p   
>SafeNet ProtectServer</p>
</li><li class=" "><p   
>SafeNet Luna</p>
</li><li class=" "><p   
>AEP Keyper</p>
</li><li class=" "><p   
>ARX CoSign</p>
</li><li class=" "><p   
>Bull TrustWay.</p>
</li></ul><p   
>Besides the keys previously described, the Crypto Token property field (matching with user friendly values of the Crypto Token in the Administration GUI) should contain the following properties:</p>
<ul class=" "><li class=" "><p   
>sharedLibrary: Path to the HSM PKCS#11 library (/etc/utimaco/libcs2_pkcs11.so, /usr/safenet/lunaclient/lib/libCryptoki2_64.so etc)</p>
</li><li class=" "><p   
>slotLabelType: Type of slot reference, see below</p>
</li><li class=" "><p   
>slotLabelValue: Value of the slot reference (1, myslot etc).</p>
</li></ul><p   
>The slot label type can be one of the following</p>
<ul class=" "><li class=" "><p   
>SLOT_NUMBER: Any positive integer, can be used to refer to slots in any HSM with consecutive slot numbering.</p>
</li><li class=" "><p   
>SLOT_INDEX: Any positive integer, prefaced by an 'i'.</p>
</li><li class=" "><p   
>SLOT_LABEL: The PKCS#11 standard allows for using strings for labeling slots. This label may also be an integer or an 'i' followed by an integer (like a number or an index)</p>
</li><li class=" "><p   
>SUN_FILE: The slot specified by a SUN config file. The slot label can be left blank.</p>
</li></ul><p   
>Optionally a few extra properties fields can be used:</p>
<ul class=" "><li class=" "><p   
>attributesFile: A file specifying PKCS#11 attributes (used mainly for key generation).</p>
</li><li class=" "><p   
>keyspec: Key specification used when generating new HSM keys from within the admin GUI. Keyspec that is used as first choice when generating new keys in the GUI of form &quot;1024&quot; for RSA keys, &quot;DSA1024&quot; for DSA keys and secp256r1 for EC keys. If keyspec is not given EJBCA tries to generate a key with the same specification as the current cert signing key.</p>
</li></ul><p   
>An attributes file is in the format specified in the <a  class="external-link" href="http://download.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html">JavaTM PKCS#11 Reference Guide</a> and the examples further down in this file.</p>
<p   
>Prior to EJBCA 3.11 there were no default attributes used when no <strong class=" ">attributesFile</strong> existed. Now there is a built-in default configuration used when no attributesFile is specified. Unless you have some strange HSM not working well with the defaults (see below) you should NOT use an <strong class=" ">attributesFile</strong>. Below is an example of an 'attributesFile' (that should not be used) which will give generated keys same attribute values as the default:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">name=SafeNet</code></div>
<div class="line"><code class="plain">library=</code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slot=1</code></div>
<div class="line"><code class="plain">attributes(*, CKO_PUBLIC_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">  CKA_ENCRYPT = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_VERIFY = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_WRAP = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_PRIVATE = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_SENSITIVE = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_EXTRACTABLE = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">  CKA_DECRYPT = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_SIGN = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_UNWRAP = </code><code class="functions">true</code></div>
<div class="line"><code class="plain">  CKA_DERIVE = </code><code class="functions">false</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">disabledMechanisms = {</code></div>
<div class="line"><code class="plain">  CKM_SHA1_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA256_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA384_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA512_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD2_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD5_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_DSA_SHA1</code></div>
<div class="line"><code class="plain">  CKM_ECDSA_SHA1</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>The only known occasion where the default is not working is when the module protected slot of a Thales/nCipher HSM is used; then the file must exist and have <strong class=" ">CKA_PRIVATE = false</strong> (see below).</p>
<p   
>The default attributes that are applied to each key generated by EJBCA will assure that:</p>
<ul class=" "><li class=" "><p   
>All needed operations could be done.</p>
</li><li class=" "><p   
>The private part of the key is stored in the HSM but not the public part (which is in a certificate that is stored on the HSM).</p>
</li><li class=" "><p   
>It will be impossible to read the private part of the key from the HSM.</p>
</li></ul><p   
>The default configuration will also disable certain signing mechanisms. The disabled mechanisms are for signing when the data to be signed is hashed by PKCS#11 before using the private key in the HSM. When these mechanisms are disabled, the sun PKCS#11 wrapper provider will do the hashing instead of the of the HSM. This speeds up the signing in most cases, especially when your HSM is on another host and will not have any security impacts as no secret in the HSM is used for the hashing.</p>
<p   
>However it will be possible not disable these hash/signing mechanisms, see the PKCS#11 section of '$EJBCA_HOME/conf/cesecore.properties'. You could try not to disable the mechanisms if you get the error CKR_FUNCTION_NOT_SUPPORTED (0x54) from PKCS#11 when signing.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If you are using an attributesFile and have more than one CA using the same slot it is very important that BOTH CA token properties configurations contains the attributesFile. This is because the attributes are applied when the provider is installed during startup. If one configuration does not have the attributesFile it cannot be applied later on by the other configuration.</p>
        </div>
    </div>
<p   
>The tool <strong class=" ">EJBCA_HOME/dist/clientToolBox/ejbcaClientToolBox.sh PKCS11HSMKeyTool</strong> is used to administrate and generate keys. Use it without parameters to get all valid options. Keys are generated either using a default specified slot and PKCS#11 library, or using a configuration file.</p>
<ul class=" "><li class=" "><p   
>To generate keys using the built-in default with a specified slot and PKCS#11 library, use:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">dist</code><code class="plain">/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate hsmp11.so 2048 defaultKey 1</code></div>
</div>
    </div>
<ul class=" "><li class=" "><p   
>To generate keys using a configuration file, use:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">dist</code><code class="plain">/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate hsmp11.conf 2048 defaultKey</code></div>
</div>
    </div>
<p   
>The contents of the configuration file is specified in the PKCS#11 wrapper documentation from Oracle. Generally it is sufficient to use the default but with some HSMs it may be necessary to define certain PKCS#11 attributes for the generated key.</p>
<p   
>Note that all keys to be used have to be generated prior to the application server is started.</p>
<p   
>The default attributes attempt to automatically set CKA_LABEL also when generating keys using the clientToolBox. You can set CKA_LABEL, which is hex encoded characters, also with an attributesFile, either by setting the CKA_LABEL value:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">  CKA_LABEL = 0h707269762d6b65796c6162656c</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>or by setting an empty CKA_LABEL string with two spaces before and nothing, not even a space after. This placeholder will then be dynamically replaced with the key alias value, hex encoded:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*, CKO_PRIVATE_KEY, *) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">  CKA_LABEL</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlZEhTTW9iamVjdHNHZW5lcmF0ZWRfSFNNX29iamVjdHM">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlZF9IU01fb2JqZWN0cw" class="confluence-anchor-link"></span><span>Generated HSM objects </span></h2>
<p   
>EJBCA needs (via the Java PKCS#11 provider) two object on the HSM, which are all generated by the generate commands above:</p>
<ul class=" "><li class=" "><p   
>A private key</p>
</li><li class=" "><p   
>A certificate - this is simply a holder of the public key used by java, and not the real certificate of a CA</p>
</li></ul>    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>A java keystore entry has no reference to a publickey pkcs#11 object, just a private key object and a certificate object, hence the public key object is not needed after the certificate object has been written to the keystore. By setting the CKA_TOKEN attribute to false for the public key its object will not be stored on the HSM. If CKA_TOKEN is true then all public keys will be on the HSM forever since no public key is deleted when a private key is deleted from the keystore. So in order not to waste memory on the HSM CKA_TOKEN must be false for the public key.</p>
        </div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>When generating keys with clientToolBox each private key has the CKA_LABEL attribute set to the <strong class=" ">alias</strong> of the key prefixed with <strong class=" ">priv-</strong>. But when generating a key in EJBCA there will normally not be a CKA_LABEL for the private key. If you want to have a label even when the key is generated by EJBCA you got to use an attribute file with a CKA_LABEL definition in your configuration. The value of the attribute is a hexadecimal string starting with &quot;0h&quot;. These labels are normally seen only when you use the native HSM tools to list and manipulate objects.</p>
        </div>
    </div>
<p   
>The above example would then include:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">attributes(*,CKO_PRIVATE_KEY,*) = {</code></div>
<div class="line"><code class="plain">  .</code></div>
<div class="line"><code class="plain">  .</code></div>
<div class="line"><code class="plain">  CKA_LABEL = 0h6b657931</code></div>
<div class="line"><code class="plain">} </code></div>
</div>
    </div>
<p   
>The example above gives the label <strong class=" ">key1</strong> to the private key. You can give any label by simply looking up the hex codes of characters in the ascii table.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVV0aW1hY29fQ3J5cHRvU2VydmVyVXRpbWFjb0NyeXB0b1NlcnZlcg">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVV0aW1hY29fQ3J5cHRvU2VydmVy" class="confluence-anchor-link"></span><span>Utimaco CryptoServer</span></h1>
<p   
>The Utimaco PKCS11 module have a configurable timeout (AppTimeout) that clears all session information if you do not use the keys for some time. The default time-out is 30 minutes, which may be way too short if your CA is not very active. We recommend that you set this timeout to a longer value, several days. Put a configuration file in /etc/utimaco/cs2_pkcs11.ini:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[Global]</code></div>
<div class="line"><code class="plain">Timeout = 5000</code></div>
<div class="line"><code class="plain">Logging = 0</code></div>
<div class="line"><code class="plain">Logpath = </code><code class="plain">/tmp</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[CryptoServer]</code></div>
<div class="line"><code class="plain">Device     = TCP:3001@172.16.175.128</code></div>
<div class="line"><code class="plain">Timeout    = 600000</code></div>
<div class="line"><code class="plain">AppTimeout = 172800</code></div>
<div class="line"><code class="plain">SlotCount  = 100</code></div>
</div>
    </div>
<p   
>The timeout in this example of 172800 seconds will allow your CA to idle for a long time.</p>
<p   
>When using a PKCS#11 token you should first create keys with the command: $EJBCA_HOME/dist/clientToolBox/ejbcaClientToolBox.sh PKCS11HSMKeyTool generate</p>
<p   
>Each CA should have its own slot.</p>
<p   
>Each slot must have been initialized before keys could be generated on the them. This includes setting a user PIN for it. The slot must also require login. Tools for doing this is not provided from EJBCA. The HSM vendor should provide this tool.</p>
<p   
>Here follows an example on how to initialize a slot and generate keys to be used by EJBCA. The password is user1:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/p11tool</code><code class="plain"> Slot=1 InitToken=officer1</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/p11tool</code><code class="plain"> Slot=1 Label=CVCA LoginSO=officer1 InitPin=user1</code></div>
<div class="line"><code class="plain">$EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate .</code><code class="plain">/libcs2_pkcs11</code><code class="plain">.so 4096 signKey 1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-libcs2_pkcs11.so-slot1] Password:</code></div>
<div class="line"><code class="plain">Creating certificate with entry signKey.</code></div>
<div class="line"><code class="plain">$EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate .</code><code class="plain">/libcs2_pkcs11</code><code class="plain">.so 2048 defaultKey 1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-libcs2_pkcs11.so-slot1] Password:</code></div>
<div class="line"><code class="plain">Creating certificate with entry defaultKey.</code></div>
<div class="line"><code class="plain">$EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate .</code><code class="plain">/libcs2_pkcs11</code><code class="plain">.so 512 testKey 1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-libcs2_pkcs11.so-slot1] Password:</code></div>
<div class="line"><code class="plain">Creating certificate with entry testKey. </code></div>
</div>
    </div>
<p   
>You can view the pkcs11 objects created with the command:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/p11tool</code><code class="plain"> Slot=1 Login=user1 ListObjects </code></div>
</div>
    </div>
<p   
>This is a example of a property field when creating the CA:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">defaultKey defaultKey</code></div>
<div class="line"><code class="plain">certSignKey signKey</code></div>
<div class="line"><code class="plain">crlSignKey signKey</code></div>
<div class="line"><code class="plain">testKey testKey</code></div>
<div class="line"><code class="plain">pin user1</code></div>
<div class="line"><code class="plain">sharedLibrary </code><code class="plain">/opt/utimaco/p11/libcs2_pkcs11</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slotLabelType=SLOT_NUMBER</code></div>
<div class="line"><code class="plain">slotLabelValue=1</code></div>
</div>
    </div>
<p   
>Utimaco have an emulator for their CryptoServer LAN HSM that can be used for test and development. If you have the emulation kit there is a howto in doc/howto/cryptoserver-lan-emulator.txt with steps to follow in order to use it with EJBCA.</p>
<p   
>You can check the status of a CryptoServer LAN device, for example the emulator with:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/csadm</code><code class="plain"> Device=TCP:3001@172.16.175.128 GetState</code></div>
</div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUltcG9ydF9hX1BLQ1MjMTJfZmlsZV9pbl9VdGltYWNvX0NyeXB0b1NJbXBvcnRhUEtDUyMxMmZpbGVpblV0aW1hY29DcnlwdG9TZXJ2ZXI">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUltcG9ydF9hX1BLQ1MjMTJfZmlsZV9pbl9VdGltYWNvX0NyeXB0b1M" class="confluence-anchor-link"></span><span>Import a PKCS#12 file in Utimaco CryptoServer</span></h2>
<p   
>Although not recommended it is possible to import keys from a p12 file to CryptoServer. These steps were contributed by Philipp Vogt and Helmut Edlhaimb-Rexeis. The tools used are a combination of p11tool that ships with Utimaco HSMs and <strong class=" ">ejbcaClientToolBox.sh PKCS11HSMKeyTool</strong>.</p>
<ul class=" "><li class=" "><p   
>Import the .p12 file with p11Tool from Utimaco (into slot 20 in this example). p11tool Slot=22 AuthRSASign=GenPKIAd,:cs2:cyb:/dev/ttyS0 Login=123456 ID=TestCA2XYID ImportP12=mycert.p12,1234 It is absolutely necessary to set an unique id (ID=...) at import time. The key alias for the imported key is set to <strong class=" ">X509 Certificate</strong> (taken from the imported certificate) and cannot be change at import time.</p>
</li><li class=" "><p   
>Rename the key alias to an unique key alias with <strong class=" ">PKCS11HSMKeyTool rename</strong> from ejbcaClientToolbox. ejbcaClientToolBox.sh PKCS11HSMKeyTool rename /etc/utimaco/libcs2_pkcs11.so 20 <strong class=" ">X509 Certificate</strong> <strong class=" ">TestCA2Key</strong> The new key alias is set to the label and the id of the CKO_CERTIFICATE and the id of the CKO_PRIVATE_KEY.</p>
</li><li class=" "><p   
>Optional: Delete the public key with p11Tool using Label=&quot;RSA Public Key&quot;. p11tool Slot=20 Login=123456 Label=&quot;RSA Public Key&quot; DeleteObject</p>
</li><li class=" "><p   
>Test the keys, to make sure they are usable from EJBCA. ejbcaClientToolBox.sh PKCS11HSMKeyTool test ./libcs2_pkcs11.so 20 1</p>
</li></ul><p   
>Make sure no other public keys using this label are present in the HSM. Even if more than one .p12 file needs to be imported only one at a time can be imported and renamed. The import and the rename process are tied together and cannot be separated.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfblNoaWVsZC9uZXRIU01uQ2lwaGVyblNoaWVsZC9uZXRIU00">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfblNoaWVsZC9uZXRIU00" class="confluence-anchor-link"></span><span>nCipher nShield/netHSM</span></h1>
<p   
>This subsection describes how the nShield card from nCipher is used.<br/>First the card has to be installed and admin and operator card sets has to be created. This is described in step 1.<br/>Step 2 describes environments variables that must be set before generating keys and installing a new CA.<br/>Step 3-5 describe PKCS#11 keys are generated and how different CAs within an installation is configured to use these keys. In earlier versions of this manual it was also described how the nCipher JCA provider could be used by EJBCA. This has been removed since PKCS#11 keys are better in every respect.</p>
<p   
><strong class=" ">Step 1. Install the nShield card</strong></p>
<ol class=" "><li class=" "><p   
>Make sure you have all necessary software and drivers installed and created the user and group nfast. In Linux should the software be installed to /opt/nfast or the location environment variable NFAST_HOME is pointing to.</p>
</li><li class=" "><p   
>Login as the nfast user: <strong class=" ">sudo su nfast</strong></p>
</li><li class=" "><p   
>Set the nCipher box to initialization mode by setting the switch to mode <strong class=" ">I</strong>.</p>
</li><li class=" "><p   
>Clear the nCipher box by pressing the reset button on the device.</p>
</li><li class=" "><p   
>Check that the mode is in <strong class=" ">pre-initialization mode</strong> and not in <strong class=" ">operational</strong>:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">nfast@donny:</code><code class="plain">/home/lars/work</code><code class="plain">$ </code><code class="plain">/opt/nfast/bin/enquiry</code></div>
<div class="line"><code class="plain">Server:</code></div>
<div class="line"><code class="plain"> enquiry reply flags  none</code></div>
<div class="line"><code class="plain"> enquiry reply level  Six</code></div>
<div class="line"><code class="plain"> serial number        41C5-BA04-6D2C</code></div>
<div class="line"><code class="plain"> mode                 operational</code></div>
<div class="line"><code class="plain"> version              2.23.6</code></div>
<div class="line"><code class="plain"> speed index          147</code></div>
<div class="line"><code class="plain"> rec. queue           442..642</code></div>
<div class="line"><code class="plain"> level one flags      Hardware HasTokens</code></div>
<div class="line"><code class="plain"> version string       2.23.6cam5, 2.22.6cam7 built on Apr 25 2005 18:15:46</code></div>
<div class="line"><code class="plain"> checked </code><code class="keyword">in</code><code class="plain">           00000000431dca98 Tue Sep  6 18:58:00 2005</code></div>
<div class="line"><code class="plain"> level two flags      none</code></div>
<div class="line"><code class="plain"> max. write size      8192</code></div>
<div class="line"><code class="plain"> level three flags    KeyStorage</code></div>
<div class="line"><code class="plain"> level four flags     OrderlyClearUnit HasRTC HasNVRAM HasNSOPermsCmd ServerHasPollCmds FastPollSlotList HasSEE HasKLF HasShareACL HasFeatureEnable HasFileOp HasLongJobs ServerHasLongJobs AESModuleKeys NTokenCmds LongJobsPreferred</code></div>
<div class="line"><code class="plain"> module </code><code class="functions">type</code><code class="plain"> code     0</code></div>
<div class="line"><code class="plain"> product name         nFast server</code></div>
<div class="line"><code class="plain"> device name</code></div>
<div class="line"><code class="plain"> EnquirySix version   4</code></div>
<div class="line"><code class="plain"> impath kx </code><code class="functions">groups</code></div>
<div class="line"><code class="plain"> feature ctrl flags   none</code></div>
<div class="line"><code class="plain"> features enabled     none</code></div>
<div class="line"><code class="plain"> version serial       0</code></div>
<div class="line"><code class="plain"> remote server port   9004</code></div>
<div class="line"><code class="plain">Module </code><code class="comments">#1:</code></div>
<div class="line"><code class="plain"> enquiry reply flags  none</code></div>
<div class="line"><code class="plain"> enquiry reply level  Six</code></div>
<div class="line"><code class="plain"> serial number        41C5-BA04-6D2C</code></div>
<div class="line"><code class="plain"> mode                 pre-initialisation</code></div>
<div class="line"><code class="plain"> version              2.22.6</code></div>
<div class="line"><code class="plain"> speed index          147</code></div>
<div class="line"><code class="plain"> rec. queue           9..152</code></div>
<div class="line"><code class="plain"> level one flags      Hardware HasTokens InitialisationMode PreMaintInitMode</code></div>
<div class="line"><code class="plain"> version string       2.22.6cam7 built on Apr 25 2005 18:15:46</code></div>
<div class="line"><code class="plain"> checked </code><code class="keyword">in</code><code class="plain">           00000000426636cd Wed Apr 20 13:02:37 2005</code></div>
<div class="line"><code class="plain"> level two flags      none</code></div>
<div class="line"><code class="plain"> max. write size      8192</code></div>
<div class="line"><code class="plain"> level three flags    KeyStorage</code></div>
<div class="line"><code class="plain"> level four flags     OrderlyClearUnit HasRTC HasNVRAM HasNSOPermsCmd ServerHasPollCmds FastPollSlotList HasSEE HasKLF HasShareACL HasFeatureEnable HasFileOp HasLongJobs ServerHasLongJobs AESModuleKeys NTokenCmds LongJobsPreferred</code></div>
<div class="line"><code class="plain"> module </code><code class="functions">type</code><code class="plain"> code     6</code></div>
<div class="line"><code class="plain"> product name         nC1002P</code><code class="plain">/nC3022P</code></div>
<div class="line"><code class="plain"> device name          </code><code class="comments">#1 nFast PCI device, bus 0, slot 13.</code></div>
<div class="line"><code class="plain"> EnquirySix version   5</code></div>
<div class="line"><code class="plain"> impath kx </code><code class="functions">groups</code><code class="plain">     DHPrime1024</code></div>
<div class="line"><code class="plain"> feature ctrl flags   LongTerm</code></div>
<div class="line"><code class="plain"> features enabled     StandardKM</code></div>
<div class="line"><code class="plain"> version serial       24</code></div>
<div class="line"><code class="plain"> rec. LongJobs queue  8</code></div>
<div class="line"><code class="plain"> SEE machine </code><code class="functions">type</code><code class="plain">     gen1AIF </code></div>
</div>
    </div>
</li><li class=" "><p   
>Create the security world with the command:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/new-world</code><code class="plain"> -i -Q 1</code><code class="plain">/1</code></div>
<div class="line"><code class="plain">15:04:50 WARNING: Module </code><code class="comments">#1: preemptively erasing module to see its slots!</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Create Security World:</code></div>
<div class="line"><code class="plain"> Module 1: 0 cards of 1 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: unknown card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - overwriting card</code></div>
<div class="line"><code class="plain">Card writing complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">security world generated on module </code><code class="comments">#0; hknso = 6807e0b031c4f797b739ec33ca7dba05279cf54f</code></div>
<div class="line"><code class="plain">$ </code></div>
</div>
    </div>
<p   
>The <strong class=" ">-Q K/N</strong> option tells how many administration cards that are created N. K of these cards will be needed to restore a module with a backup of the security world. <strong class=" ">1/1</strong> is a bad choice in production but will do in this example. Choose K&gt;=3 and N&gt;K in production.</p>
</li><li class=" "><p   
>Change mode on the switch on the device to mode <strong class=" ">O</strong>.</p>
</li><li class=" "><p   
>Press the <strong class=" ">Clear</strong> button again.</p>
</li><li class=" "><p   
>Check with <strong class=" ">enquiry</strong> that the mode has changed to <strong class=" ">Operational</strong><br/>Example on creation of operator cards:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/createocs</code><code class="plain"> -m 1 -Q 2</code><code class="plain">/3</code><code class="plain"> -N ejbca -M -p -T 0</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Creating Cardset:</code></div>
<div class="line"><code class="plain"> Module 1: 0 cards of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: Admin Card </code><code class="comments">#1</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 1')</code></div>
<div class="line"><code class="plain"> Module 1: 1 card of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: remove already-written card </code><code class="comments">#1</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 2')</code></div>
<div class="line"><code class="plain"> Module 1: 2 cards of 3 written</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: remove already-written card </code><code class="comments">#2</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: blank card</code></div>
<div class="line"><code class="plain">New passphrases </code><code class="keyword">do</code><code class="plain"> not match; please try again.</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase specified - writing card (naming `EJBCA card 3')</code></div>
<div class="line"><code class="plain">Card writing complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">cardset created; hkltu = 8d30f2ab5bdccacd8a4333aefed2c0ea1ff0e6db</code></div>
<div class="line"><code class="plain">$ </code></div>
</div>
    </div>
<p   
>This will generate 3 cards of the card set named <strong class=" ">ejbca</strong>. Any 2 of these cards will be needed when generating keys and starting ejbca. Different card sets could be used for different CAs.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>The preload command (see below) must always be called as the same user unless the directory /opt/nfast/kmdata/preload is removed.<br/>If you get a <strong class=" ">HostDataAccessDenied</strong> error when running preload or starting JBoss, it is because the file permissions on the directory /opt/nfast/kmdata/preload is wrong. It's probably because you (sometime) ran preload as another user, such as root or nfast.</p>
        </div>
    </div>
</li><li class=" "><p   
>Load the card set so that keys protected by the card set could be generated:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/opt/nfast/bin/preload</code><code class="plain"> -c ejbca pause</code></div>
<div class="line"><code class="plain">Loading cardsets:</code></div>
<div class="line"><code class="plain">ejbca on modules 1</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Loading `ejbca':</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #3 (`EJBCA card 3'</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase supplied - reading card</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #3 (`EJBCA card 3'</code><code class="plain">): already </code><code class="functions">read</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: empty</code></div>
<div class="line"><code class="plain"> Module 1 slot 0: `ejbca</code><code class="string">' #2 (`EJBCA card 2'</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> Module 1 slot 0:- passphrase supplied - reading card</code></div>
<div class="line"><code class="plain">Card reading complete.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Loading complete; now pausing </code></div>
</div>
    </div>
</li></ol><p   
><strong class=" ">Step 2. Setup the environment</strong><br/>Login as the user that is running the application server. This user must be a member of the nfast group. The following environment variables should be set for this user:</p>
<ul class=" "><li class=" "><p   
>JAVA_HOME (/usr/local/jdk1.6.0_16 or similar)</p>
</li><li class=" "><p   
>APPSRV_HOME (/home/jboss/jboss-5.1.0.GA or similar)</p>
</li><li class=" "><p   
>EJBCA_HOME (/home/jboss/ejbca or similar)</p>
</li><li class=" "><p   
>NFAST_HOME (/opt/nfast)</p>
</li></ul><p   
><strong class=" ">Step 3. Create PKCS#11 keys that should be used on the nShield card</strong></p>
<ol class=" "><li class=" "><p   
>Start a new window and login as the same user (jboss user).</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>An <strong class=" ">ECC</strong> key could not be used with preload (at least not the curve secp160r1). Such a key is generated OK and could be used as long as the current preload is running. But if all preload processes are stopped and then if then preload is restarted the key could not be used. This means that ECC could only be used with a 1/n OCS.</p>
        </div>
    </div>
</li><li class=" "><p   
>Now 3 keys protected by the key set <strong class=" ">ejbca</strong> are created like this:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 4096 defaultRoot i1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 4096 defaultRoot i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry default.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 2048 cryptRoot i1</code></div>
<div class="line"><code class="plain">Loaded pkcs11 uc17cfc7c330e613af5709789ff823a476177e233c-d165e440baa8dc9963780c682836ba17513e8cbf key (RSAPrivate) on modules 1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 2048 cryptRoot i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry crypt.</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $EJBCA_HOME</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 1024 </code><code class="functions">test</code><code class="plain"> i1</code></div>
<div class="line"><code class="plain">Loaded pkcs11 uc17cfc7c330e613af5709789ff823a476177e233c-27cfdae84bf4298f2dde83cd00980a81bcf095bf key (RSAPrivate) on modules 1</code></div>
<div class="line"><code class="plain">Executing ejbcaClientToolBox.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so 1024 </code><code class="functions">test</code><code class="plain"> i1</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-NFastJava] Password: </code></div>
<div class="line"><code class="plain">Creating certificate with entry </code><code class="functions">test</code><code class="plain">. </code></div>
</div>
    </div>
</li></ol><p   
><strong class=" ">Step 4. Start EJBCA with nShield HSM</strong><br/>To start EJBCA, preload must be running with the required key stores loaded. In this example this was done in step 2. Preload is now used to start jboss:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c ejbca $APPSRV_HOME</code><code class="plain">/bin/run</code><code class="plain">.sh </code></div>
</div>
    </div>
<p   
><strong class=" ">Step 5. Create a new CA in the web GUI of EJBCA</strong><br/>Choose PKCS#11 as <strong class=" ">CA Token Type</strong>.</p>
<p   
>Properties are defined according to the <a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyaWNfUEtDU18xMV9wcm92aWRlcg">Generic PKCS#11 provider </a>section above.</p>
<p   
>All preloaded operator card sets (OCSs) has its own slot. It is not possible to predict the slot ID. But the index of the slot in the slot list is predictable. <strong class=" ">slotListIndex</strong> must therefore be used. If only one OCS is preloaded this index is always 1.</p>
<p   
>If several CAs are sharing the same OCS (and hence slot) each key (identified by a key label) may only be used for one CA but the test key. Same test key could be used for all CAs.</p>
<p   
>Example with previous generated keys where signRoot is used for CAs signing, and defaultRoot is used for everything else (encryption):</p>
<p   
>When preload is used no authentication code is needed to activate a CA. You could give any value for the authentication code when activating. The <strong class=" ">pin</strong> property could be used in the configuration to automatically activate a CA. The value of this property could be anything.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">defaultKey defaultRoot</code></div>
<div class="line"><code class="plain">testKey </code><code class="functions">test</code></div>
<div class="line"><code class="plain">keyEncryptKey cryptRoot</code></div>
<div class="line"><code class="plain">hardTokenEncrypt cryptRoot</code></div>
<div class="line"><code class="plain">pin dummy</code></div>
<div class="line"><code class="plain">slotLabelType SLOT_INDEX</code></div>
<div class="line"><code class="plain">slotLabelValue 1</code></div>
<div class="line"><code class="plain">sharedLibrary </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so </code></div>
</div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVVzaW5nbW9kdWxlcHJvdGVjdGVka2V5cw">
        <h2 class="heading "><span>Using module protected keys</span></h2>
<p   
>Module protected keys do not need an operator card set. Hence no PIN code is needed to active such a key. A CA could be configured to use a keystore with module protected keys.</p>
<p   
>When using PKCS#11 slot 0 is used to indicate module protection. The only other thing except using slot 0 you have to do is to use a configuration file when creating the key. The file could look like this:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">name=NFastJava</code></div>
<div class="line"><code class="plain">library=/opt/nfast/toolkits/pkcs11/libcknfast.so</code></div>
<div class="line"><code class="plain">slotListIndex=0</code></div>
<div class="line"><code class="plain">attributes(*,CKO_PUBLIC_KEY,*) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = false</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">attributes(*,CKO_PRIVATE_KEY,*) = {</code></div>
<div class="line"><code class="plain">  CKA_TOKEN = true</code></div>
<div class="line"><code class="plain">  CKA_PRIVATE = false</code></div>
<div class="line"><code class="plain">  CKA_SIGN = true</code></div>
<div class="line"><code class="plain">  CKA_DECRYPT = true</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">disabledMechanisms = {</code></div>
<div class="line"><code class="plain">  CKM_SHA1_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA256_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA384_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_SHA512_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD2_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_MD5_RSA_PKCS</code></div>
<div class="line"><code class="plain">  CKM_DSA_SHA1</code></div>
<div class="line"><code class="plain">  CKM_ECDSA_SHA1</code></div>
<div class="line"><code class="plain">} </code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLU5vdHVzaW5ncHJlbG9hZA">
        <h2 class="heading "><span>Not using preload</span></h2>
<p   
>If a 1/N card set is used, then preload don't have to be used (but it can be used). If preload is not used, then jboss could be made to start automatically at boot time.</p>
<p   
>For PKCS#11 simply do not use the preload command. The authentication code is now needed when activating the CA.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVVzaW5nbW9yZXRoYW5vbmVPQ1M">
        <h2 class="heading "><span>Using more than one OCS</span></h2>
<p   
>It is also possible to use more than one OCS. This is needed when you want different CAs protected by different OCSs.</p>
<p   
>The key to get this working is to set the environment variable CKNFAST_LOADSHARING=1. This environment variable is also implicitly set when running with preload.</p>
<p   
>To get a list of all available slots do:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ CKNFAST_LOADSHARING=1 ~nfast</code><code class="plain">/bin/ckinfo</code></div>
<div class="line"><code class="plain">PKCS</code><code class="comments">#11 library CK_INFO</code></div>
<div class="line"><code class="plain">       interface version 2.01</code></div>
<div class="line"><code class="plain">                   flags 0</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">      libraryDescription </code><code class="string">"nCipher PKCS#11 1.58.48         "</code></div>
<div class="line"><code class="plain">  implementation version 1.58</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[0] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"                                                                "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 5</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_TOKEN_PRESENT</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[0] CK_TOKEN_INFO</code></div>
<div class="line"><code class="plain">                   label </code><code class="string">"loadshared accelerator          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   model </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">            serialNumber </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">                   flags 201</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_RNG</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_DUAL_CRYPTO_OPERATIONS</code></div>
<div class="line"><code class="plain">       ulMaxSessionCount 1024</code></div>
<div class="line"><code class="plain">     ulMaxRwSessionCount 1024</code></div>
<div class="line"><code class="plain">             ulMaxPinLen 18446744073709551615</code></div>
<div class="line"><code class="plain">             ulMinPinLen 0</code></div>
<div class="line"><code class="plain">     ulTotalPublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">      ulFreePublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">    ulTotalPrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">     ulFreePrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"><code class="plain">                 utcTime </code><code class="string">"                "</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[1] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"1of2_0                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[1] Token not present</code></div>
<div class="line"><code class="plain">slots[2] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"2of3_0                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[2] Token not present</code></div>
<div class="line"><code class="plain">slots[3] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"ejbca                                                           "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[3] Token not present</code></div>
<div class="line"><code class="plain">slots[4] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"2of3_1                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 6</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[4] Token not present</code></div>
<div class="line"><code class="plain">slots[5] CK_SLOT_INFO</code></div>
<div class="line"><code class="plain">         slotDescription </code><code class="string">"1of2_1                                                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   flags 7</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_TOKEN_PRESENT</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_REMOVABLE_DEVICE</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_HW_SLOT</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><code class="plain">slots[5] CK_TOKEN_INFO</code></div>
<div class="line"><code class="plain">                   label </code><code class="string">"1of2_1                          "</code></div>
<div class="line"><code class="plain">          manufacturerID </code><code class="string">"nCipher Corp. Ltd               "</code></div>
<div class="line"><code class="plain">                   model </code><code class="string">"                "</code></div>
<div class="line"><code class="plain">            serialNumber </code><code class="string">"ee6071c52a77370c"</code></div>
<div class="line"><code class="plain">                   flags 20D</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_RNG</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_LOGIN_REQUIRED</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_USER_PIN_INITIALIZED</code></div>
<div class="line"><code class="plain">                   flags &amp; CKF_DUAL_CRYPTO_OPERATIONS</code></div>
<div class="line"><code class="plain">       ulMaxSessionCount 1024</code></div>
<div class="line"><code class="plain">     ulMaxRwSessionCount 1024</code></div>
<div class="line"><code class="plain">             ulMaxPinLen 18446744073709551615</code></div>
<div class="line"><code class="plain">             ulMinPinLen 0</code></div>
<div class="line"><code class="plain">     ulTotalPublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">      ulFreePublicMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">    ulTotalPrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">     ulFreePrivateMemory CK_UNAVAILABLE_INFORMATION</code></div>
<div class="line"><code class="plain">        hardware version 0.00</code></div>
<div class="line"><code class="plain">        firmware version 0.00</code></div>
<div class="line"><code class="plain">                 utcTime </code><code class="string">"                "</code><code class="plain"> </code></div>
</div>
    </div>
<p   
>You then got to identify your OCSs with the slot index. The <strong class=" ">label</strong> in the list gives the name you gave to your OCS when creating it. Then you get the slot list index from the <strong class=" ">x</strong> in <strong class=" ">slot[x]</strong>. Use this for <strong class=" ">slotListIndex</strong> in the CA properties.</p>
<p   
>When using a 1/n OCS one card of the OCS must be inserted when activating a CA. If the OCS is persistent then the card could be removed and you could then activate another CA by inserting its OCS.</p>
<p   
>To make the OCS persistent use the <strong class=" ">-p</strong> argument at <strong class=" ">createocs</strong> time, if this is not the case as soon as the card is removed then the cardset will unload itself.</p>
<p   
>When using k/n OCS where k&gt;1 you got to load all OCSs to be used with preload and then start the application server also with preload. Example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c 2of3_0 pause</code></div>
<div class="line"><code class="plain">-- follow instruction to insert cards and enter pins. --</code></div>
<div class="line"><code class="plain">-- </code><code class="keyword">then</code><code class="plain"> press ctr-z --</code></div>
<div class="line"><code class="plain">$ </code><code class="functions">bg</code><code class="plain"> </code></div>
<div class="line"><code class="plain">$ ~nfast</code><code class="plain">/bin/preload</code><code class="plain"> -c 2of3_1 </code><code class="functions">exit</code></div>
<div class="line"><code class="plain">-- follow instruction to insert cards and enter pins. -- </code></div>
</div>
    </div>
<p   
>When the application server then is started with preload, CAs defined for slot list index 2 and 4 could be activated. When activating a CA when running preload no PIN has to be given. Also when the application server is started with preload then only CAs of preloaded slots could be activated (not preloaded 1/n slots could not be used).</p>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfbG9hZF9iYWxhbmNpbmduQ2lwaGVybG9hZGJhbGFuY2luZw">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLW5DaXBoZXJfbG9hZF9iYWxhbmNpbmc" class="confluence-anchor-link"></span><span>nCipher load balancing</span></h1>
<p   
>If you want to use the Loadsharing with multiple modules, be it PCI cards of NetHSM's then you must ensure you have a 1/N OCS and the N quorum to be able to have enough cards to be inserted in every HSM you want to load balance the key at server/CA start up when logging in.<br/>Same security world got to be loaded in all modules participating.<br/>After setting up the first netHSM, do the following on the second:</p>
<ul class=" "><li class=" "><p   
>Use the panel of the second netHSM to configure the rfs</p>
</li><li class=" "><p   
>Use the panel of the second netHSM to load the security world</p>
</li><li class=" "><p   
>Use the panel of the second netHSM to configure clients</p>
</li><li class=" "><p   
>on each client run: /opt/nfast/bin/nethsmenroll</p>
</li></ul><p   
>With load balancing you need to have CKNFAST_LOADSHARING=1. Preload implicitly sets CKNFAST_LOADSHARING.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>If preload is used fail-over to the other HSM if one of the HSMs is broken is not working.</p>
        </div>
    </div>
<p   
>Example of starting jboss:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ejbca@host:</code><code class="plain">/usr/local/ejbca</code><code class="plain">&gt; CKNFAST_LOADSHARING=1 ..</code><code class="plain">/jboss/bin/run</code><code class="plain">.sh</code></div>
</div>
    </div>
<p   
>When activating a CA you need a smart card from the OCS of the corresponding slot inserted in both HSMs. The OCS got to be 1/n since preload can not be used.<br/>Sample catoken.properties for generating the initial ManagementCA on the netHSM.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">defaultKey defaultKey</code></div>
<div class="line"><code class="plain">certSignKey defaultSign</code></div>
<div class="line"><code class="plain">crlSignKey defaultSign</code></div>
<div class="line"><code class="plain">testKey testKey</code></div>
<div class="line"><code class="plain">sharedLibrary </code><code class="plain">/opt/nfast/toolkits/pkcs11/libcknfast</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slotLabelType=SLOT_INDEX</code></div>
<div class="line"><code class="plain">slotLabelValue 1</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFFUF9LZXlwZXJBRVBLZXlwZXI">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFFUF9LZXlwZXI" class="confluence-anchor-link"></span><span>AEP Keyper</span></h1>
<p   
>The document xxxxxxKeyperInstallation.pdf (xxxxxx is six digits) in the KeyPer UserGuides describes how the HSM is installed, the details start in section 3.5 (Configuring the Keyper HSM for the first time). As default there is only one slot - 0. The document xxxxxxKeyperP11.pdf describes the PKCS#11 interface in details.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFSWF9Db1NpZ25BUlhDb1NpZ24">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFSWF9Db1NpZ24" class="confluence-anchor-link"></span><span>ARX CoSign</span></h1>
<p   
>This HSM only works on Windows. The installation is done with an installer and the setup with a GUI.<br/>All generated keys will be on slot 1. The PIN code used when activating the keys could be anything since the authentication is made when login on to the user that runs EJBCA. The shared library is called C:\windows\system32\sadaptor.dll</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUHJvdGVjY2lvQnVsbFRydXN0d2F5UHJvdGVjY2lv">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUHJvdGVjY2lv" class="confluence-anchor-link"></span><span>Bull Trustway Proteccio</span></h1>
<p   
>The <strong class=" ">Installation and User's Guide</strong> describes how the HSM is installed and how how PKCS#11 tokens are created and how a backup of a token is done. But it might be helpful to mention some additional things:</p>
<ol class=" "><li class=" "><p   
>A virtual HSM correspond to a PKCS#11 token.</p>
</li><li class=" "><p   
>The number of the virtual HSM corresponds to the PKCS#11 slot ID of the token.</p>
</li><li class=" "><p   
>The PKCS#11 user PIN is the <strong class=" ">PKCS#11 application authentication</strong> in the <strong class=" ">Personalizing a virtual HSM</strong> step.</p>
</li><li class=" "><p   
>If <strong class=" ">CIK startup mode</strong> is selected for the virtual HSM personalization you must start the HSM manually before EJBCA can use it.</p>
</li><li class=" "><p   
>Make sure that backup-restore work before taken the HSM in production since the first versions did not backup the certificate of a key which is needed by the java wrapper.</p>
</li></ol>    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUENJX0NyeXB0b19DYXJkQnVsbFRydXN0d2F5UENJQ3J5cHRvQ2FyZA">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUENJX0NyeXB0b19DYXJk" class="confluence-anchor-link"></span><span>Bull Trustway PCI Crypto Card</span></h1>
<p   
>This is an old HSM. New installations will probably use <a   href="#src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJ1bGxfVHJ1c3R3YXlfUHJvdGVjY2lv">Proteccio</a>.</p>
<p   
>Do the installation of the card according to Install_and_Use_cc2000.pdf. When the card is <strong class=" ">installed</strong> it is ready to use with EJBCA. Only one slot (slot index 0) is available. The slot is not protected by any PIN so an undefined <strong class=" ">pin</strong> (empty) property may be used in the configuration.</p>
<p   
>When using PKCS11HSMKeyTool and starting EJBCA, libcc2000_tok.so and libgpkcs11cc2000.so must be in the library path. Examples:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">lars@maud:~</code><code class="plain">/work/test/ca</code><code class="plain">$ </code><code class="functions">ls</code><code class="plain"> -al ../..</code><code class="plain">/bullInstall/linux</code></div>
<div class="line"><code class="plain">total 412</code></div>
<div class="line"><code class="plain">dr-xr-xr-x 4 lars lars 4096 28 nov 14.28 .</code></div>
<div class="line"><code class="plain">drwxr-xr-x 4 lars lars 4096 20 apr 21.05 ..</code></div>
<div class="line"><code class="plain">dr-xr-xr-x 6 lars lars 4096 20 apr 21.38 CardAdmin_java</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 35804 28 nov 14.15 cc2000_lx24.tgz</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 74955 28 nov 14.15 cc2000_src.tgz</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 14 28 nov 14.15 cc2000S_release</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 633 28 nov 14.15 desinstall</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 171 28 nov 14.15 gpkcs11cc2000.rc</code></div>
<div class="line"><code class="plain">dr-xr-xr-x 2 lars lars 4096 28 nov 14.28 include</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 7209 28 nov 14.15 </code><code class="functions">install</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 101788 28 nov 14.15 libcc2000_tok.so</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 146820 28 nov 14.15 libgpkcs11cc2000.so</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 3843 28 nov 14.15 LisezMoi.txt</code></div>
<div class="line"><code class="plain">-r-xr-xr-x 1 lars lars 3410 28 nov 14.15 ReadMe.txt</code></div>
<div class="line"><code class="plain">lars@maud:~</code><code class="plain">/work/test/ca</code><code class="plain">$ LD_LIBRARY_PATH=../..</code><code class="plain">/bullInstall/linux</code><code class="plain"> ../..</code><code class="plain">/java/jboss/bin/run</code><code class="plain">.sh </code></div>
</div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ LD_LIBRARY_PATH=~</code><code class="plain">/work/bullInstall/linux</code><code class="plain"> $EJBCA</code><code class="plain">/dist/clientToolBox/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate ../..</code><code class="plain">/bullInstall/linux/libgpkcs11cc2000</code><code class="plain">.so 2048 defaultkey i0</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfTHVuYVNhZmVOZXRMdW5h">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfTHVuYQ" class="confluence-anchor-link"></span><span>SafeNet Luna</span></h1>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUluc3RhbGxfSFdfYW5kX1NXSW5zdGFsbEhXYW5kU1c">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUluc3RhbGxfSFdfYW5kX1NX" class="confluence-anchor-link"></span><span>Install HW and SW</span></h2>
<p   
>Consult the SafeNet documentation regarding installation of HW and SW.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbmZpZ3VyYXRpb24">
        <h2 class="heading "><span>Configuration</span></h2>
<p   
>Do all steps (1-7 in the section) in &quot;A - Configuration (Setup Appliance after Installing)&quot; of in the html document &quot;Luna SA Online Help &ndash; Document # 800274-xxx&quot; that should be found on your installation CD. Some notes about our test setup:</p>
<p   
><strong class=" ">Step 3:</strong> You may do nothing here. But note that changing many of the policies will reset the HSM. This means that you can't change any of these policies later on.</p>
<p   
><strong class=" ">Step 4:</strong> Note that a new partition could be added at any time. Each partition will be represented as a PKCS#11 slot. Make sure to write the Record Partition Client Password (TP) in a text file. In the example the password is btqx-EFGH-3456-7/K9 for the first created partition (slot 1). The TP will later be used as PIN for the slot.</p>
<p   
><strong class=" ">Step 5:</strong> A good idea is to allow partitions (p11 slots) to be &quot;activated&quot;. If a partition is not activated you got to insert the black key in the PED and give PIN each time a resource in the HSM is used by the client. So in most cases you want to be able to activate a partition: lunash:&gt;partition changePolicy -partition partition1 -policy 22 -value 1</p>
<p   
><strong class=" ">Step 6:</strong> You don't have to be in the '/usr/LunaSA/bin' directory as the documentation says. We think it is preferable to be in a directory owned by yourself so you don't have to use sudo. Example of running in your own directory:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/usr/lunasa/bin/ctp</code><code class="plain"> admin@lunasa.int.primekey.com:server.pem .</code></div>
</div>
    </div>
<p   
>Example of occasions when sudo must be used is registration of server and adding client certificates (root owned files and directories are used and updated):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="functions">sudo</code><code class="plain"> </code><code class="plain">/usr/lunasa/bin/vtl</code><code class="plain"> addServer -n lunasa.int.primekey.com -c server.pem</code></div>
<div class="line"><code class="plain">$ </code><code class="functions">sudo</code><code class="plain"> </code><code class="plain">/usr/lunasa/bin/vtl</code><code class="plain"> createCert -n milton</code></div>
</div>
    </div>
<p   
><strong class=" ">Step 7:</strong> Each partition assigned to a client will be represented by a PKCS#11 slot for this client. It seems that each new added partition will be put last in the slot list and the number of a slot will be slot list index plus 1 (list index starting with 0 and slot number starting with 1). To get the partition slot mapping on the client do:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ </code><code class="plain">/usr/lunasa/bin/vtl</code><code class="plain"> verify</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">The following Luna SA Slots</code><code class="plain">/Partitions</code><code class="plain"> were found: </code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Slot    Serial </code><code class="comments">#        Label</code></div>
<div class="line"><code class="plain">====    ========        =====</code></div>
<div class="line"><code class="plain"> 1      950784001       partition1</code></div>
<div class="line"><code class="plain"> 2      950784002       partition2</code></div>
</div>
    </div>
<p   
>Now the client may use these slots with EJBCA and its tools.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFjdGl2YXRpbmdfc2xvdHNBY3RpdmF0aW5nc2xvdHM">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUFjdGl2YXRpbmdfc2xvdHM" class="confluence-anchor-link"></span><span>Activating slots</span></h2>
<p   
>Before a partition (slot) could be used by a client it must be activated. This is described in 'B - Administration &amp; Maintenance &gt; Activating and AutoActivating Partitions'. The partition policy required do the activation must have been set (see step 5 above). Example to activate a partition:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">lunash:&gt;hsm login</code></div>
<div class="line"><code class="plain">lunash:&gt;partition activate -partition partition1 -password btqx-EFGH-3456-7</code><code class="plain">/K9</code></div>
</div>
    </div>
<p   
>The password is from the configuration step 4. See above.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlX2tleXNfb25fYV9zbG90R2VuZXJhdGVrZXlzb25hc2xvdA">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlX2tleXNfb25fYV9zbG90" class="confluence-anchor-link"></span><span>Generate keys on a slot</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ .</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/usr/lunasa/lib/libCryptoki2_64</code><code class="plain">.so 2048 rsa2048_1 1</code></div>
<div class="line"><code class="plain">0    [main] INFO  org.ejbca.util.keystore.KeyTools  - Using SUN PKCS11 provider: sun.security.pkcs11.SunPKCS11</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-Luna] Password: </code></div>
<div class="line"><code class="plain">Created certificate with entry rsa2048_1.</code></div>
<div class="line"><code class="plain">$ .</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/usr/lunasa/lib/libCryptoki2_64</code><code class="plain">.so secp160r1 secp160r1_1 1</code></div>
<div class="line"><code class="plain">0    [main] INFO  org.ejbca.util.keystore.KeyTools  - Using SUN PKCS11 provider: sun.security.pkcs11.SunPKCS11</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-Luna] Password: </code></div>
<div class="line"><code class="plain">Created certificate with entry secp160r1_1.</code></div>
</div>
    </div>
<p   
>The password btqx-EFGH-3456-7/K9 (see above) is used.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUxpc3RfYW5kX3Rlc3RfYWxsX2tleXNfdGhhdF9jb3VsZF9iZV91c2VMaXN0YW5kdGVzdGFsbGtleXN0aGF0Y291bGRiZXVzZWRieUVKQkNB">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUxpc3RfYW5kX3Rlc3RfYWxsX2tleXNfdGhhdF9jb3VsZF9iZV91c2U" class="confluence-anchor-link"></span><span>List and test all keys that could be used by EJBCA</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ .</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool </code><code class="functions">test</code><code class="plain"> </code><code class="plain">/usr/lunasa/lib/libCryptoki2_64</code><code class="plain">.so 1</code></div>
<div class="line"><code class="plain">Test of keystore with ID 1.</code></div>
<div class="line"><code class="plain">0    [main] INFO  org.ejbca.util.keystore.KeyTools  - Using SUN PKCS11 provider: sun.security.pkcs11.SunPKCS11</code></div>
<div class="line"><code class="plain">PKCS11 Token [SunPKCS11-libCryptoki2_64.so-slot2] Password: </code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Testing of key: rsa2048_1</code></div>
<div class="line"><code class="plain">SunJCE version 1.7SunPKCS11-libCryptoki2_64.so-slot2 version 1.7; modulus length: 2048; byte length 245. The docoded byte string is equal to the original!</code></div>
<div class="line"><code class="plain">Signature </code><code class="functions">test</code><code class="plain"> of key rsa2048_1: signature length 256; first byte 28; verifying </code><code class="functions">true</code></div>
<div class="line"><code class="plain">Key statistics. </code></div>
<div class="line"><code class="plain">Signings per second: 369; Decryptions per second: 135</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">Testing of key: secp160r1_1</code></div>
<div class="line"><code class="plain">Signature </code><code class="functions">test</code><code class="plain"> of key secp160r1_1: signature length 48; first byte 30; verifying </code><code class="functions">true</code></div>
<div class="line"><code class="plain">Key statistics. </code></div>
<div class="line"><code class="plain">Signings per second: 68 No crypto available </code><code class="keyword">for</code><code class="plain"> this key. </code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhbXBsZV9IYXJkX1Rva2VuX1Byb3BlcnRpZXNTYW1wbGVIYXJkVG9rZW5Qcm9wZXJ0aWVz">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhbXBsZV9IYXJkX1Rva2VuX1Byb3BlcnRpZXM" class="confluence-anchor-link"></span><span>Sample Hard Token Properties</span></h2>
<p   
>This is a sample configuration of the Hard Token Properties for PKCS#11 token when creating a new CA.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">sharedLibrary=</code><code class="plain">/usr/lunasa/lib/libCryptoki2_64</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slotLabelType=SLOT_NUMBER</code></div>
<div class="line"><code class="plain">slotLabelValue=1</code></div>
<div class="line"><code class="plain">certSignKey=myECCKey</code></div>
<div class="line"><code class="plain">crlSignKey=myECCKey</code></div>
<div class="line"><code class="plain">defaultKey=default</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNvbWVfdXNlZnVsX0x1bmFfY29tbWFuZHNTb21ldXNlZnVsTHVuYWNvbW1hbmRz">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNvbWVfdXNlZnVsX0x1bmFfY29tbWFuZHM" class="confluence-anchor-link"></span><span>Some useful Luna commands</span></h2>
<p   
>Here are some useful native Luna cmu commands.</p>
<p   
>List objects and their handles:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/cmu</code><code class="plain"> list -display=index,handle,class,keyType,label</code></div>
</div>
    </div>
<p   
>If you have created keys with native commands, or imported keys, there is probably no certificate object as required by Java PKCS#11 provider. Create a self-signed certificate referencing the private handle:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/cmu</code><code class="plain"> selfSign -privatehandle=87 -CN=</code><code class="string">"caSign00001"</code><code class="plain"> -startDate=20020101</code></div>
<div class="line"><code class="plain">-endDate=20451231 -serialNum=0133337f</code></div>
</div>
    </div>
<p   
>Notice that they will have to replace 87 with the handle of the private key they found when running the list command.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfUHJvdGVjdFNlcnZlclNhZmVOZXRQcm90ZWN0U2VydmVy">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNhZmVOZXRfUHJvdGVjdFNlcnZlcg" class="confluence-anchor-link"></span><span>SafeNet ProtectServer</span></h1>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLWluc3RhbGxfU1dJbnN0YWxsU1c">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLWluc3RhbGxfU1c" class="confluence-anchor-link"></span><span>Install SW</span></h2>
<p   
>Install the software according to the installation instructions for the ProtectServer. Below are sample commands for installing the SDK rpm on an Ubuntu system, which means first converting it to a deb.<br/>Using the SDK you can use the SDK as a good emulator for testing and development. If you are installing with a real ProtectServer you should install the Runtime instead of the SDK. When using the SDK you may use /opt/ETcpsdk/lib/linux-x86_64 instead of /opt/PTK/lib</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">fakeroot alien -c $CDROM</code><code class="plain">/Linux64/ptkc_sdk/ETcpsdk-3</code><code class="plain">.32.00-1.x86_64.rpm</code></div>
<div class="line"><code class="functions">sudo</code><code class="plain"> dpkg -i .</code><code class="plain">/etcpsdk_3</code><code class="plain">.32.00-2_amd64.deb</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNldF9wYXNzd29yZHNfZm9yX2FkbWluX1NPX29jaF9hZG1pbl91c2VldHBhc3N3b3Jkc2ZvcmFkbWluU09vY2hhZG1pbnVzZXI">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNldF9wYXNzd29yZHNfZm9yX2FkbWluX1NPX29jaF9hZG1pbl91c2U" class="confluence-anchor-link"></span><span>et passwords for admin SO och admin user</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">LD_LIBRARY_PATH=/opt/PTK/lib /opt/PTK/bin/ctconf</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLWNyZWF0ZV8xMF9zbG90c2NyZWF0ZTEwc2xvdHM">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLWNyZWF0ZV8xMF9zbG90cw" class="confluence-anchor-link"></span><span>create 10 slots</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">LD_LIBRARY_PATH=</code><code class="plain">/opt/PTK/lib</code><code class="plain"> </code><code class="plain">/opt/PTK/bin/ctconf</code><code class="plain"> -c10</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNldF9ub19wdWJsaWNfY3J5cHRvU2V0bm9wdWJsaWNjcnlwdG8">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNldF9ub19wdWJsaWNfY3J5cHRv" class="confluence-anchor-link"></span><span>Set no public crypto</span></h2>
<p   
>See <strong class=" ">Programming in FIPS mode</strong> in the Protect Toolkit-C Programmers Manual for information about this flag.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">LD_LIBRARY_PATH=</code><code class="plain">/opt/PTK/lib</code><code class="plain"> </code><code class="plain">/opt/PTK/bin/ctconf</code><code class="plain"> -fc</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUluaXRpYWxpemVfc2xvdF81Ll9TZXRzX1NPX2FuZF91c2VyX3Bhc3NJbml0aWFsaXplc2xvdDUuU2V0c1NPYW5kdXNlcnBhc3N3b3Jk">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUluaXRpYWxpemVfc2xvdF81Ll9TZXRzX1NPX2FuZF91c2VyX3Bhc3M" class="confluence-anchor-link"></span><span>Initialize slot 5. Sets SO and user password</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">LD_LIBRARY_PATH=/opt/PTK/lib /opt/PTK/bin/ctkmu t -s5 -lroot</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlX2tleXNfb25fc2xvdF81R2VuZXJhdGVrZXlzb25zbG90NQ">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRlX2tleXNfb25fc2xvdF81" class="confluence-anchor-link"></span><span>Generate keys on slot 5</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so 2048 defaultSign 5</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so 2048 default 5</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate </code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so 512 </code><code class="functions">test</code><code class="plain"> 5</code></div>
</div>
    </div>
<p   
>If JBoss was started you have to restart JBoss before the keys becomes available in EJBCA.</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbnRlbnRzX29mX0NBX1Rva2VuX1Byb3BlcnRpZXNDb250ZW50c29mQ0FUb2tlblByb3BlcnRpZXM">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUNvbnRlbnRzX29mX0NBX1Rva2VuX1Byb3BlcnRpZXM" class="confluence-anchor-link"></span><span>Contents of CA Token Properties</span></h2>
<p   
>When you create the CA in EJBCA you can now use the simple CA token properties below.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">certSignKey defaultSign</code></div>
<div class="line"><code class="plain">crlSignKey defaultSign</code></div>
<div class="line"><code class="plain">defaultKey default</code></div>
<div class="line"><code class="plain">testKey </code><code class="functions">test</code></div>
<div class="line"><code class="plain">sharedLibrary=</code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so</code></div>
<div class="line"><code class="plain">slotLabelType=SLOT_NUMBER</code></div>
<div class="line"><code class="plain">slotLabelValue=5</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVRlc3RfYW5kX2xpc3Rfa2V5c19vbl9zbG90XzVUZXN0YW5kbGlzdGtleXNvbnNsb3Q1">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVRlc3RfYW5kX2xpc3Rfa2V5c19vbl9zbG90XzU" class="confluence-anchor-link"></span><span>Test and list keys on slot 5</span></h2>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool </code><code class="functions">test</code><code class="plain"> </code><code class="plain">/opt/PTK/lib/libcryptoki</code><code class="plain">.so 5</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">Testing of key: </code><code class="functions">test</code></div>
<div class="line"><code class="plain">SunJCE version 1.7SunPKCS11-libcryptoki.so-slot3 version 1.7; modulus length: 2048; byte length 53. The docoded byte string is equal to the original!</code></div>
<div class="line"><code class="plain">SunPKCS11-libcryptoki.so-slot3 RSA private key, 512 bits (</code><code class="functions">id</code><code class="plain"> 4, token object, sensitive, extractable)</code></div>
<div class="line"><code class="plain">Signature </code><code class="functions">test</code><code class="plain"> of key test1: signature length 64; first byte 3d; verifying </code><code class="functions">true</code></div>
<div class="line"><code class="plain">Signings per second: 257</code></div>
<div class="line"><code class="plain">Decryptions per second: 260</code></div>
</div>
    </div>
<p   
>The attributes are listed as <strong class=" ">token object, sensitive, extractable</strong>, and here is important that is says <strong class=" ">sensitive</strong> (extractable only means that the key can be backed up securely using SafeNet tools).</p>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJhY2t1cF9hbmRfUmVzdG9yZUJhY2t1cGFuZHJlc3RvcmU">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUJhY2t1cF9hbmRfUmVzdG9yZQ" class="confluence-anchor-link"></span><span>Backup and restore</span></h2>
<p   
>When you have tested that all keys are working you should back them up. Read about how this is done in the ProtectServer documentation. Then clear the slot that you have just backed up:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ctkmu -s &lt;slot nr&gt; t</code></div>
</div>
    </div>
<p   
>Then restore the backup according to the ProtectServer documentation and run the clientToolBox test as above. Now when you now that the keys of the slot could be restored from the backup medium you should set the attributes of them so that they could not be extracted from the HSM by any means. Unfortunate this could not be done with the ctkmu CLI tool since the private key got no label. Use the GUI <strong class=" ">kmu</strong> instead. For each key do:</p>
<ol class=" "><li class=" "><p   
>Select the token and login to it.</p>
</li><li class=" "><p   
>Double click on the private key that you want to protect.</p>
</li><li class=" "><p   
>Uncheck the <strong class=" ">Exportable</strong> box and press <strong class=" ">OK</strong></p>
</li><li class=" "><p   
>Verify that the <strong class=" ">Exportable</strong> and the <strong class=" ">Extractable</strong> boxes are unchecked and can't be changed</p>
</li><li class=" "><p   
>Verify that the <strong class=" ">Private</strong> and the <strong class=" ">Sensitive</strong> boxes are checked and can't be changed</p>
</li></ol><p   
>Now it should be impossible to do any backup of the key. If you got a key ceremony protocol it could be a good idea to note that keys were made <strong class=" ">unexportable</strong>. Also note that the <strong class=" ">Exportable</strong> attribute has to be unchecked each time the backup is restored.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>The emulator has an annoying feature (only emulator not real HSM). Each key of same length that are generated is the same, because the seed for the random number generator is static. This means that a slot may only have one key. If a second key is generated for a slot the certificate object for the first key is deleted before writing the certificate object for the new key. This is done since the Sun p11 wrapper provider does not allow two keys that are equal to be present in a keystore. To fix this you should set the environment variable ET_PTKC_SW_AUTOSEEDRNG=true.</p>
        </div>
    </div>
    </div>
    <div class="section section-2" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRpbmdfa2V5c191c2luZ19Qcm90ZWN0U2VydmVyX3Rvb2xHZW5lcmF0aW5na2V5c3VzaW5nUHJvdGVjdFNlcnZlcnRvb2xz">
        <h2 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUdlbmVyYXRpbmdfa2V5c191c2luZ19Qcm90ZWN0U2VydmVyX3Rvb2w" class="confluence-anchor-link"></span><span>Generating keys using ProtectServer tools</span></h2>
<p   
>You can also generate keys, and the needed self-signed certificate, using the SafeNet tools delivered with the HSM. This is for example suitable when you want to generate ECC keys with curves not supported by JDK (although you may still have to patch the JDK in order to use them anyhow).</p>
<p   
>For example, the below commands generate an ECC key with curve P-256 on slot 1, storing it on the HSM with alias <strong class=" ">foo</strong>, assigning a self-signed certificate to it and finally listing the object of slot 1.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">cd</code><code class="plain"> </code><code class="plain">/opt/ETCprt/bin/linux-x86-64</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ctkmu</code><code class="plain"> c -tec -nfoo -aPSVXxTRD -s1 -CP-256</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ctcert</code><code class="plain"> c -s1 -lfoo</code></div>
<div class="line"><code class="plain">.</code><code class="plain">/ctkmu</code><code class="plain"> l -s1</code></div>
</div>
    </div>
<p   
>Or you can wrap it all up in a single command...</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">./ctcert c -k -lfoo -tec -s1 -CP-256 -d30y</code></div>
</div>
    </div>
<p   
>If JBoss was started you have to restart JBoss before the keys becomes available in EJBCA.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNtYXJ0Q2FyZC1IU01TbWFydENhcmQtSFNN">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNtYXJ0Q2FyZC1IU00" class="confluence-anchor-link"></span><span>SmartCard-HSM</span></h1>
<p   
>SmartCard-HSM is a lightweight hardware security module in a Smart Card, MicroSD or USB form factor providing a remotely manageable secure key store to protect your RSA and ECC keys.</p>
<ul class=" "><li class=" "><p   
><a  class="external-link" href="http://www.smartcard-hsm.com/2014/09/05/Accessing_your_SmartCard-HSM_from_EJBCA.html">Accessing your SmartCard-HSM from EJBCA</a></p>
</li><li class=" "><p   
><a  class="external-link" href="http://www.smartcard-hsm.com/2015/10/10/Shared_Control_over_Key_Usage.html">Shared control over key usage</a></p>
</li></ul>    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNvZnRIU01Tb2Z0SFNN">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVNvZnRIU00" class="confluence-anchor-link"></span><span>SoftHSM </span></h1>
<p   
>SoftHSM2 works very well with EJBCA, and after initializing a slot you can use it by creating a new Crypto Token in the Admin GUI.</p>
<p   
>The <strong class=" ">user PIN</strong> is what you will use to activate the token in EJBCA.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="functions">sudo</code><code class="plain"> apt-get </code><code class="functions">install</code><code class="plain"> softhsm2</code></div>
</div>
    </div>
<p   
>To use it as a normal user, make /var/lib/softhsm/tokens available to your normal user (for writing in order to create keys), and /etc/softhsm/* readable by the user.</p>
<p   
>After setting privileges, you can use softhsm as normal user.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">softhsm2-util --init-token --</code><code class="functions">free</code><code class="plain"> --label myslo</code></div>
</div>
    </div>
<p   
>The Ubuntu package for SoftHSM2 is not always initializing properly (depending on the Ubuntu version you are running) so you may have to create missing directories etc. If you get an <i class=" ">ERROR: Could not initialize the library </i>when running the above there is a directory missing, and a token not initialized.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">sudo mkdir /var/lib/softhsm/tokens</code></div>
<div class="line"><code class="plain">sudo chmod a+rwx /var/lib/softhsm</code></div>
<div class="line"><code class="plain">sudo chmod a+rwx /var/lib/softhsm/tokens</code></div>
<div class="line"><code class="plain">sudo chmod a+rx /etc/softhsm</code></div>
<div class="line"><code class="plain">sudo chmod a+r /etc/softhsm/*</code></div>
<div class="line"><code class="plain">softhsm2-util --init-token --free --label myslot</code></div>
</div>
    </div>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>The above commands give write privileges to all users in the system and you may wish to tune that to your security policy.</p>
        </div>
    </div>
<p   
>Now you can initialize additional slots. Note that if you provide the <strong class=" ">--slot</strong> parameter to SoftHSM2 it will most likely not become the slotnumber you specify.</p>
<p   
>To list the slots, use the following command:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">softhsm2-util --show-slots</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVBLQ1MxMVNweQ">
        <h1 class="heading "><span>PKCS11 Spy</span></h1>
<p   
>You can debug PKCS11 sessions and all calls made, using OpenSC's P11Spy. As of EJBCA 6.8.0, P11Spy is by default included in the known P11 implementation in con/web.properties.</p>
<p   
>Stop JBoss, install P11Spy, and set the environment variables used in the JBoss terminal:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">apt-get install opensc-pkcs11</code></div>
<div class="line"><code class="plain">export PKCS11SPY=/usr/local/lib/softhsm/libsofthsm2.so</code></div>
<div class="line"><code class="plain">export PKCS11SPY_OUTPUT=logfile.log</code></div>
</div>
    </div>
<p   
>Then start JBoss and create a new PKCS11 Crypto Token using the PKCS11Spy <strong class=" ">PKCS#11 Library</strong>.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVN1cHBvcnRmb3JuZXdIU01zU3VwcG9ydF9mb3JfbmV3X0hTTXM">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVN1cHBvcnRfZm9yX25ld19IU01z" class="confluence-anchor-link"></span><span>Support for new HSMs </span></h1>
<p   
>EJBCA uses PKCS#11 so in theory can support any HSMs that provide a decent PKCS#11 implementation. If the HSM is peculiar you may have to provide specific attribute parameters as descibed for an 'attributesFile' above.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVVzaW5nX1NIQTI1NldpdGhSU0FhbmRNR0YxXyhSU0FTU0EtUFNTKVVzaW5nU0hBMjU2V2l0aFJTQWFuZE1HRjEoUlNBU1NBLVBTUyk">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLVVzaW5nX1NIQTI1NldpdGhSU0FhbmRNR0YxXyhSU0FTU0EtUFNTKQ" class="confluence-anchor-link"></span><span>Using SHA256WithRSAandMGF1 (RSASSA-PSS)</span></h1>
<p   
>Out of the box in Java PKCS#11 RSASSA-PSS is not supported. The software in EJBCA supports it, but the Java PKCS#11 provider does not.</p>
<p   
>At the time of writing, Oracle Java does not have support for SHA256WithRSAandMGF1 (also known as RSASSA-PSS) in the PKCS#11 provider. PrimeKey has made a patch which is waiting for approval in the OpenJDK. You can get a compiled patch together with an installation script for Debian-based operating systems from <a  class="external-link" href="https://www.primekey.com/">PrimeKey</a>.</p>
<p   
>This issue is registered in the EJBCA issue tracker as <a  class="external-link" href="http://jira.primekey.se/browse/ECA-2014">ECA-2014</a>.</p>
<p   
>The patch should work on all HSMs that have support for SHA256WithRSAandMGF1.</p>
<p   
>With the patch applied you can create CAs using HSMs with the SHA256WithRSAandMGF1 (and SHA384 and SHA512) algorithm.</p>
    </div>
    <div class="section section-1" id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUV4dGVuZGluZ19TdW5fUEtDUyMxMV90b19zZXRfQ0tBX01PRElGSUFFeHRlbmRpbmdTdW5QS0NTIzExdG9zZXRDS0FfTU9ESUZJQUJMRT1mYWxzZQ">
        <h1 class="heading "><span id="src-22380948_safe-id-aWQtLkhhcmR3YXJlU2VjdXJpdHlNb2R1bGVzKEhTTSl2Ni4xNS4wLUV4dGVuZGluZ19TdW5fUEtDUyMxMV90b19zZXRfQ0tBX01PRElGSUE" class="confluence-anchor-link"></span><span>Extending Sun PKCS#11 to set CKA_MODIFIABLE=false</span></h1>
<p   
>In order to change the CKA_MODIFIABLE attribute of a private key to FALSE directly after it has been generated the Sun PKCS#11 implementation must be extended. This extension must be done by adding classes to <strong class=" ">Installed Extensions</strong> classpath. See <a  class="external-link" href="https://docs.oracle.com/javase/tutorial/ext/basics/install.html">https://docs.oracle.com/javase/tutorial/ext/basics/install.html</a></p>
<p   
>This is achieved by putting the '$EJBCA_HOME/dist/ext/cesecore-p11.jar' in one of the directories that is defined by the 'java.ext.dirs' system property. You can put the jar in '$JAVA_HOME/jre/lib/ext'. You may also change the property to include the directory of the jar. Here is an example:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">JAVA_OPTS=</code><code class="string">"-Djava.ext.dirs=/usr/lib/jvm/java-7-openjdk-amd64/jre/lib/ext:$EJBCA_HOME/dist/ext"</code><code class="plain"> $JBOSS_HOME/bin/standalone.sh</code></div>
</div>
    </div>
<p   
>Ensure to keep '$JAVA_HOME/jre/lib/ext' in the classpath.</p>
<p   
>To enable the feature in EJBCA, set 'pkcs11.makeKeyUnmodifiableAfterGeneration=true' in $EJBCA_HOME/conf/cesecore.properties.</p>
<p   
>If you use '$EJBCA_HOME/dist/ejbcaClientToolBox.sh' you do not have to set the java.ext.dirs setting as the configuration is performed by the script.</p>
<p   
>Everything will work without this jar in the classpath, but if it is not in classpath, the CKA_MODIFIABLE will be TRUE for every key that is generated and a warning written to the log.</p>
<p   
>The reason to set CKA_MODIFIABLE to FALSE is that it should not be possible to set CKA_DERIVE to TRUE. If CKA_DERIVE is true it might be possible to extract the private key from some HSMs (CVE-2015-5464), although most vendors have now patched this by not allowing weak key derivation schemes.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>The ability to set CKA_MODIFIABLE=true is HSM vendor dependent and using the above method to change CKA_MODIFIABLE to false may not give the desired behaviour and thorough testing is advised.</p>
        </div>
    </div>
<p   
>Certain HSMs (for example SoftHSM2) refuses to set CKA_MODIFIABLE to FALSE (the PKCS#11 standard says that this behavior is OK).</p>
<p   
>In summary, the configuration requires careful testing. Tests can be performed using the clientToolBox tool with a generate-test cycle:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$EJBCA_HOME</code><code class="plain">/dist/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool generate (to generate a new key)</code></div>
<div class="line"><code class="plain">$EJBCA_HOME</code><code class="plain">/dist/ejbcaClientToolBox</code><code class="plain">.sh PKCS11HSMKeyTool </code><code class="functions">test</code><code class="plain"> (to </code><code class="functions">test</code><code class="plain">, </code><code class="keyword">in</code><code class="plain"> a new PKCS</code><code class="comments">#11 session if it is usable)</code></div>
</div>
    </div>
<p   
>If you also generate keys using the Admin GUI, this should also be tested, together with restarting JBoss between generation and usage.</p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Database_Integration.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Database Integration</span>
        </a>
                <a href="Unbound_Key_Control.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Unbound Key Control</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
