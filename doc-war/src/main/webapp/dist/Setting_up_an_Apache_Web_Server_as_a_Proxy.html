<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Setting up an Apache Web Server as a Proxy - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=16225536"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                     <li><a href="EJBCA_Guides.html">EJBCA Guides</a></li>
                                                            </ul>
</div>            <h1 id="src-16225536"> <span>Setting up an Apache Web Server as a Proxy</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>This section covers how to use an Apache Web Server Proxy in front of EJBCA. The resulting server will:</p>
<ul class=" "><li class=" "><p   
>Display EJBCA public web at https://ca-server.company.local/</p>
</li><li class=" "><p   
>Redirect all HTTP-requests to HTTPS, except for OCSP and CRL.</p>
</li><li class=" "><p   
>Require a client SSL certificate when accessing https://ca-server.company.local/adminweb/</p>
</li><li class=" "><p   
>Be able to loadbalance requests</p>
</li><li class=" "><p   
>Still answer to requests on https://ca-server.company.local/ejbca/*</p>
</li></ul><p   
>This example was created on Ubuntu 64-bit Server 7.10 using the Apache Web Server 2.2 package but should be easy to adapt to any system able to run Apache.</p>
<p   
>To support OCSP GET requests through the proxy in recent version of Apache (2.4), you may need to activate <code class=" ">mod_lbmethod_byrequests</code>. You may also need to use the <code class=" ">nocanon</code> directory to ProxyPass in order to correctly-forward encoded slash characters (/).</p>
<p   
>To set up an Apache Web Server as a Proxy in front of EJBCA, start by installing EJBCA as normal. If you intend to have the CA on the same machine as the proxy, you should modify $EJBCA_HOME/conf/web.properties to only listen to localhost:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">httpsserver.bindaddress.pubhttp=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain">httpsserver.bindaddress.pubhttps=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain">httpsserver.bindaddress.privhttps=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
</div>
    </div>
<p   
>Install the Apache Web Server and enable the required modules:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$sudo su</code></div>
<div class="line"><code class="plain"> #apt-get install apache2</code></div>
<div class="line"><code class="plain"> #cd /etc/apache2/mods-enabled/</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/proxy.load proxy.load</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/proxy_http.load proxy_http.load</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/proxy_ajp.load proxy_ajp.load</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/proxy_balancer.load proxy_balancer.load</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/rewrite.load rewrite.load</code></div>
<div class="line"><code class="plain"> #ln -s ../mods-available/ssl.load ssl.load</code></div>
</div>
    </div>
<p   
>Generate the SSL-certificate for Apache. Note that the SSL-certificate should be issued by the same CA that issued the Tomcat SSL certificate (ManagementCA in the default configuration). To generate the SSL-certificate for Apache using the EJBCA CLI, run the following:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ cd $EJBCA_HOME</code></div>
<div class="line"><code class="plain"> $ bin/ejbca.sh ra addendentity apache-ssl foo123 </code></div>
<div class="line"><code class="string">"CN=ca-server.company.local,O=EJBCA Sample,C=SE"</code><code class="plain"> </code><code class="string">""</code><code class="plain"> ManagementCA </code><code class="string">""</code><code class="plain"> </code><code class="value">1</code><code class="plain"> </code></div>
<div class="line"><code class="plain">PEM SERVER</code></div>
<div class="line"><code class="plain"> $ bin/ejbca.sh ra setclearpwd apache-ssl foo123</code></div>
<div class="line"><code class="plain"> $ bin/ejbca.sh batch</code></div>
<div class="line"><code class="plain"> $ ls p12/pem/ca-server.company.local*</code></div>
<div class="line"><code class="plain"> p12/pem/ca-server.company.local-CA.pem p12/pem/ca-server.company.local-Key.pem p12/pem/ca-server.company.local.pem</code></div>
</div>
    </div>
<p   
>Configure the default virtual host-file /etc/apache2/sites-enabled/000-default, according to the follwoing.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Note that this configuration with SSLVerifyClient inside a Location directive is not safe with the discovered vulnerability in SSL/TLS discovered in 2009-11-15 (CVE-2009-3555). You should run updated versions of Apache and Java, or only use SSLVerifyClient and SSLCipherSuite on whole virtualhosts. You can create the same effect as below by using a separate subdomain for EJBCA administration (i.e. admin.ca.youdomain.com).</p>
        </div>
    </div>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">NameVirtualHost *:</code><code class="value">80</code></div>
<div class="line"><code class="plain">&lt;VirtualHost *:</code><code class="value">80</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">        DocumentRoot /var/www/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Proxy requests to EJBCA instances (only one on local machine configured)</code></div>
<div class="line"><code class="plain">        &lt;Proxy balancer:</code><code class="comments">//mycluster-kerb&gt;</code></div>
<div class="line"><code class="plain">                BalancerMember ajp:</code><code class="comments">//localhost:8009/ejbca/</code></div>
<div class="line"><code class="plain">        &lt;/Proxy&gt;</code></div>
<div class="line"><code class="plain">        ProxyPass / balancer:</code><code class="comments">//mycluster-kerb/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        RewriteEngine   On</code></div>
<div class="line"><code class="plain">        # Redirect all but the CRL Distribution Point, OCSP and Helthcheck to HTTPS</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST} !(/publicweb/webdist/certdist.*cmd=crl|/publicweb/status/)</code></div>
<div class="line"><code class="plain">        RewriteRule     ^(.*)$ https:</code><code class="comments">//%{SERVER_NAME}$1 [L,R]</code></div>
<div class="line"><code class="plain">        # Treat reqeusts to / and /ejbca/ as the same. Required by EJBCA's Admin Web.</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST}  /ejbca/</code></div>
<div class="line"><code class="plain">        RewriteRule     ^/ejbca/(.*)$ /$</code><code class="value">1</code><code class="plain"> [PT]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure log</code></div>
<div class="line"><code class="plain">        LogLevel warn</code></div>
<div class="line"><code class="plain">        ErrorLog /var/log/apache2/error.log</code></div>
<div class="line"><code class="plain">        CustomLog /var/log/apache2/access.log combined</code></div>
<div class="line"><code class="plain">&lt;/VirtualHost&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">NameVirtualHost *:</code><code class="value">443</code></div>
<div class="line"><code class="plain">&lt;VirtualHost *:</code><code class="value">443</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">        DocumentRoot /var/www/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        RewriteEngine   On</code></div>
<div class="line"><code class="plain">        # Treat reqeusts to / and /ejbca/ as the same. Required by EJBCA's Admin Web.</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST}  /ejbca/</code></div>
<div class="line"><code class="plain">        RewriteRule     ^/ejbca/(.*)$ /$</code><code class="value">1</code><code class="plain"> [PT]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure secure SSL </code><code class="keyword">for</code><code class="plain"> </code><code class="keyword">this</code><code class="plain"> server using SSL certificate generated by EJBCA</code></div>
<div class="line"><code class="plain">        SSLEngine on</code></div>
<div class="line"><code class="plain">        SSLCipherSuite HIGH</code></div>
<div class="line"><code class="plain">        SSLProtocol all -SSLv2</code></div>
<div class="line"><code class="plain">        SSLCertificateFile /home/jboss/ejbca/p12/pem/ca-server.company.local.pem</code></div>
<div class="line"><code class="plain">        SSLCertificateKeyFile /home/jboss/ejbca/p12/pem/ca-server.company.local-Key.pem</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Require Client SSL certificate  </code><code class="keyword">for</code><code class="plain"> the Admin GUI</code></div>
<div class="line"><code class="plain">        &lt;Location /adminweb&gt;</code></div>
<div class="line"><code class="plain">                SSLVerifyClient require</code></div>
<div class="line"><code class="plain">                SSLVerifyDepth </code><code class="value">1</code></div>
<div class="line"><code class="plain">                SSLCACertificateFile /home/jboss/ejbca/p12/pem/ca-server.company.local-CA.pem</code></div>
<div class="line"><code class="plain">        &lt;/Location&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Proxy requests to EJBCA instances (only one on local machine configured)</code></div>
<div class="line"><code class="plain">        &lt;Proxy balancer:</code><code class="comments">//mycluster-kerb&gt;</code></div>
<div class="line"><code class="plain">                BalancerMember ajp:</code><code class="comments">//localhost:8009/ejbca/</code></div>
<div class="line"><code class="plain">        &lt;/Proxy&gt;</code></div>
<div class="line"><code class="plain">        ProxyPass / balancer:</code><code class="comments">//mycluster-kerb/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure log</code></div>
<div class="line"><code class="plain">        LogLevel warn</code></div>
<div class="line"><code class="plain">        ErrorLog /var/log/apache2/error.log</code></div>
<div class="line"><code class="plain">        CustomLog /var/log/apache2/access.log combined</code></div>
<div class="line"><code class="plain">&lt;/VirtualHost&gt;</code></div>
</div>
    </div>
<p   
>Reload the apache configuration and verify that only port 80, 443 and other desired services (e.g. a ssh-daemon) are listening on all or external interfaces:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$sudo /etc/init.d/apache2 reload</code></div>
<div class="line"><code class="plain">$sudo netstat -nap | grep LISTEN | grep -v </code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain">tcp </code><code class="value">0</code><code class="plain"> </code><code class="value">0</code><code class="plain"> </code><code class="value">0.0</code><code class="plain">.</code><code class="value">0.0</code><code class="plain">:</code><code class="value">80</code><code class="plain"> </code><code class="value">0.0</code><code class="plain">.</code><code class="value">0.0</code><code class="plain">:* LISTEN </code><code class="value">7612</code><code class="plain">/apache2 </code></div>
<div class="line"><code class="plain">tcp </code><code class="value">0</code><code class="plain"> </code><code class="value">0</code><code class="plain"> </code><code class="value">0.0</code><code class="plain">.</code><code class="value">0.0</code><code class="plain">:</code><code class="value">443</code><code class="plain"> </code><code class="value">0.0</code><code class="plain">.</code><code class="value">0.0</code><code class="plain">:* LISTEN </code><code class="value">7612</code><code class="plain">/apache2 </code></div>
<div class="line"><code class="plain">tcp6 </code><code class="value">0</code><code class="plain"> </code><code class="value">0</code><code class="plain"> :::</code><code class="value">22</code><code class="plain"> :::* LISTEN </code><code class="value">3746</code><code class="plain">/sshd</code></div>
</div>
    </div>
<p   
>It is recommended to use a firewall as an extra layer of security (e.g. drop malformed packages and prevent future services from being exploited).</p>
    <div class="section section-1" id="src-16225536_SettingupanApacheWebServerasaProxy-URLConfiguration">
        <h1 class="heading "><span>URL Configuration</span></h1>
<p   
>The following sample configuration allows rendering nice URLs for OCSP, to for example point your OCSP service locator to http://ocsp.company.com/ instead of http://ocsp.company.com:8080/ejbca/publicweb/status/ocsp (some information omitted for brevity):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;VirtualHost ocsp.company.com:</code><code class="value">80</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain"> &lt;Proxy *&gt;</code></div>
<div class="line"><code class="plain"> Order deny,allow</code></div>
<div class="line"><code class="plain"> Allow from all</code></div>
<div class="line"><code class="plain"> &lt;/Proxy&gt;</code></div>
<div class="line"><code class="plain"> ProxyPass / http:</code><code class="comments">//127.0.0.1:8080/ejbca/publicweb/status/ocsp</code></div>
<div class="line"><code class="plain"> ProxyPassReverse / http:</code><code class="comments">//127.0.0.1:8080/ejbca/publicweb/status/ocsp</code></div>
<div class="line"><code class="plain"> &lt;/VirtualHost&gt; </code></div>
</div>
    </div>
<p   
>This also applies for CRL distribution points.</p>
<p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Configure_EJBCA_with_OpenSSO.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Configure EJBCA with OpenSSO</span>
        </a>
                <a href="Setting_up_an_Apache_Web_Server_with_mod_jk.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Setting up an Apache Web Server with mod_jk</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
