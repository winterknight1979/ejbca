<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Unid FNR - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=23859502"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Concept_Guide.html">EJBCA Concept Guide</a></li>
                                                                                                         <li class="shortcut"><a href="Protocols.html">Protocols</a></li>
                                                                                                         <li class="shortcut"><a href="OCSP.html">OCSP</a></li>
                                                                                     <li><a href="Extensions.html">Extensions</a></li>
                                                            </ul>
</div>            <h1 id="src-23859502"> <span>Unid FNR</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>Unid is a method used in Norway to map a personal number, Fnr, to another number, Unid. The Unid is used in certificates instead of the real Fnr to not reveal the Fnr to observers. Authorized clients can make special OCSP request, with a special extension, to translate the Unid back to the real Fnr.</p>
<ul class=" "><li class=" "><p   
>EJBCA can generate UNID's automatically when you use the CMP protocol. See <strong class=" ">Custom Handling of Certificate Request</strong> in <a   href="CMP.html">CMP</a>.</p>
</li><li class=" "><p   
>EJBCA OCSP can answer OCSP Unid requests, sending back the Fnr to authorized clients. See <a   href="#src-23859502_id-.UnidFNRv6.15.0-UnidCMPConfiguration">Unid CMP Configuration</a>.</p>
</li><li class=" "><p   
>EJBCA OCSP has a Unid client implementation, see <a   href="#src-23859502_id-.UnidFNRv6.15.0-Fnr-UnidClient">Fnr-Unid Client</a>.</p>
</li></ul>    <div class="section section-1" id="src-23859502_id-.UnidFNRv6.15.0-Fnr-UnidClient">
        <h1 class="heading "><span>Fnr-Unid Client</span></h1>
<p   
>For the Unid Lookup part, use https with a client certificate with the OCSP client. If you use https with a client certificate and the OCSP responder is set up to answer Lookup requests, the OCSP client will return the Fnr. The Fnr will be returned if the certificate contains a Unid in the SN component of the SubjectDN, and the Unid has a valid mapping to an Fnr in the OCSP responders Fnr-Unid mapping database.</p>
<p   
>If the returned Fnr is null, there are several possible issues:</p>
<ol class=" "><li class=" "><p   
>The client was not authorized to request an Fnr.</p>
</li><li class=" "><p   
>There was no Unid Fnr mapping available.</p>
</li><li class=" "><p   
>There was no Unid in the certificate (serialNumber DN component).</p>
</li></ol>    </div>
    <div class="section section-1" id="src-23859502_safe-id-aWQtLlVuaWRGTlJ2Ni4xNS4wLVNldHRpbmd1cHRoZVVuaWQtRm5yT0NTUEV4dGVuc2lvbmludGhlT0NTUC9WQVNlcnZlcg">
        <h1 class="heading "><span>Setting up the Unid-Fnr OCSP Extension in the OCSP/VA Server</span></h1>
<p   
>The following describes how to set up handling of Unid extensions using the external OCSP responder and should be read in combination with the section <a   href="OCSP_Management.html">OCSP Management</a>.</p>
    <div class="section section-2" id="src-23859502_id-.UnidFNRv6.15.0-ConfiguringtheUnidlookupserver">
        <h2 class="heading "><span>Configuring the Unid lookup server</span></h2>
<p   
>The OCSP responder comes with an extension for looking up Unid-Fnr mappings.</p>
<p   
>To enable the Unid extension, configure the following options for the appropriate OCSP Key Binding:</p>
<ul class=" "><li class=" "><p   
>Edit the OCSP Key Binding.</p>
</li><li class=" "><p   
>Under <strong class=" ">OCSP Extensions</strong>, select <strong class=" ">Unid Fnr</strong>.</p>
</li><li class=" "><p   
>Click <strong class=" ">Add</strong> and save the key binding.</p>
</li></ul>    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>To make Unid extension available in EJBCA, the property <strong class=" ">unidfnr.enabled</strong> must be set to <strong class=" ">true</strong> in the <strong class=" ">ocsp.properties</strong> before deploying EJBCA.</p>
        </div>
    </div>
<p   
>The following configuration is available for the Unid extension. For information on all available OCSP options, refer to the <tt class=" ">ocsp.properties.sample</tt>.</p>
    <div  class="tablewrap">
        <table class="wrapped confluenceTable">
                    <colgroup>
                                    <col  width="116"/>
                                    <col  width="2348"/>
                            </colgroup>
        <thead class=" "></thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unid Datasource</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Should be set in the JBoss CLI, using the following command (assuming MySQL with MariaDB driver is used):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">Wildfly</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Wildfly" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">data-source add --name=unidds --jta=</code><code class="keyword">false</code><code class="plain"> --driver-name=</code><code class="string">"mariadb-java-client.jar"</code><code class="plain"> --connection-url=</code><code class="string">"jdbc:mysql://127.0.0.1:3306/unid"</code><code class="plain"> --jndi-name=</code><code class="string">"java:/UnidDS"</code><code class="plain"> --use-ccm=</code><code class="keyword">true</code><code class="plain"> --driver-</code><code class="keyword">class</code><code class="plain">=</code><code class="string">"org.mariadb.jdbc.Driver"</code><code class="plain"> --user-name=</code><code class="string">"uniduser"</code><code class="plain"> --password=</code><code class="string">"unidpass"</code><code class="plain"> --validate-on-match=</code><code class="keyword">true</code><code class="plain"> --background-validation=</code><code class="keyword">false</code><code class="plain"> --prepared-statements-cache-size=</code><code class="value">50</code><code class="plain"> --share-prepared-statements=</code><code class="keyword">true</code><code class="plain"> --min-pool-size=</code><code class="value">5</code><code class="plain"> --max-pool-size=</code><code class="value">150</code><code class="plain"> --pool-prefill=</code><code class="keyword">true</code><code class="plain"> --transaction-isolation=TRANSACTION_READ_COMMITTED --check-valid-connection-sql=</code><code class="string">"select 1"</code></div>
</div>
    </div>
<p   
></p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">JBoss</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="JBoss" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">data-source add --name=unidds --jta=</code><code class="keyword">false</code><code class="plain"> --driver-name=</code><code class="string">"org.mariadb.jdbc.Driver"</code><code class="plain"> --connection-url=</code><code class="string">"jdbc:mysql://127.0.0.1:3306/unid"</code><code class="plain"> --jndi-name=</code><code class="string">"java:/UnidDS"</code><code class="plain"> --use-ccm=</code><code class="keyword">true</code><code class="plain"> --driver-</code><code class="keyword">class</code><code class="plain">=</code><code class="string">"org.mariadb.jdbc.Driver"</code><code class="plain"> --user-name=</code><code class="string">"uniduser"</code><code class="plain"> --password=</code><code class="string">"unidpass"</code><code class="plain"> --validate-on-match=</code><code class="keyword">true</code><code class="plain"> --background-validation=</code><code class="keyword">false</code><code class="plain"> --prepared-statements-cache-size=</code><code class="value">50</code><code class="plain"> --share-prepared-statements=</code><code class="keyword">true</code><code class="plain"> --min-pool-size=</code><code class="value">5</code><code class="plain"> --max-pool-size=</code><code class="value">150</code><code class="plain"> --pool-prefill=</code><code class="keyword">true</code><code class="plain"> --transaction-isolation=TRANSACTION_READ_COMMITTED --check-valid-connection-sql=</code><code class="string">"select 1"</code></div>
</div>
    </div>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trusted Certificates</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>All clients to be allowed to lookup Unid-Fnr mapping must be issued a client certificate. The issuer of the client certificates must be the same as the issuer of the server certificate for TLS communication with the OCSP server (see below). Use the following parameters (where differing from default) when issuing keystores to the clients:</p>
<ul class=" "><li class=" "><p   
>PKCS#12 files</p>
</li><li class=" "><p   
>Extended key usage <strong class=" ">TLS client</strong></p>
</li></ul><p   
>When a certificate has been issued for a lookup client, it must be added in <strong class=" ">Trusted Certificates</strong> for the OCSP Key Binding. Each added certificate (Serial number hex) must match its issuing CA under the <strong class=" ">Certificate Authority</strong> column.</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
    </div>
    <div class="section section-2" id="src-23859502_id-.UnidFNRv6.15.0-ConfiguringTLSontheUnidLookupServer">
        <h2 class="heading "><span>Configuring TLS on the Unid Lookup Server</span></h2>
<p   
>This does not apply if you are running the OCSP server integrated with EJBCA, as TLS then is setup by EJBCA.</p>
<p   
>On a stand-alone OCSP server, you need to configure TLS with client authentication, requiring a JKS keystore for the key and certificate for the server. Use these parameters (where differing from default) when issuing keystores to the TLS servers:</p>
<ul class=" "><li class=" "><p   
>JKS files</p>
</li><li class=" "><p   
>Key usage: Digital Signature, Key Encipherment</p>
</li><li class=" "><p   
>Extended key usage: <strong class=" ">TLS server</strong></p>
</li></ul><p   
>The Common Name (CN) for a TLS server should be the same as the machine's fully qualified DNS name used to call the server. For example <tt class=" ">CN=ocsp.primekey.com</tt>. For the other DN components, you can choose freely.</p>
<p   
>Once the JKS keystore is issued, you can configure TLS on the OCSP server in the same way as on the EJBCA server. It is configured in the file <tt class=" ">JBOSS_HOME/server/default/deploy/jbossweb.sar/server.xml</tt> on the CA server. The Connectors for port 8442 and 8443 is the TLS configuration. The keystoreFile, keystorePass, truststoreFile and truststorePass are important to get right.</p>
<p   
>Place the keystore for the TLS server in the file <tt class=" ">p12/tomcat.jks</tt> on the external OCSP responder to allow it to be deployed correctly when using <tt class=" ">ant ocsp-deploy</tt>, and you will not have to change the <tt class=" ">server.xml</tt> file which is over-written by <tt class=" ">ant ocsp-deploy</tt>.</p>
    </div>
    <div class="section section-2" id="src-23859502_id-.UnidFNRv6.15.0-SecurityoftheLookupServer">
        <h2 class="heading "><span>Security of the Lookup Server</span></h2>
<p   
>The lookup server always checks that each client is using TLS with client authentication, that the certificate is valid and is one of the certificates placed in the directory pointed to by <tt class=" ">ocsp.unidtrustdir</tt>.</p>
<p   
>Note that if these conditions are not met, no Fnr is returned.</p>
    </div>
    </div>
    <div class="section section-1" id="src-23859502_id-.UnidFNRv6.15.0-UnidCMPConfigurationUnidCMPConfiguration">
        <h1 class="heading "><span id="src-23859502_id-.UnidFNRv6.15.0-UnidCMPConfiguration" class="confluence-anchor-link"></span><span>Unid CMP Configuration </span></h1>
<p   
>You can configure EJBCA to generate Unids when an RA is using the CMP protocol. The generated Unids are stored in a mapping database that can be read by the OCSP responder.</p>
<p   
>The following requirements apply:</p>
<ul class=" "><li class=" "><p   
>The database table is assumed to be identical to that of the OCSP UNID/FNR implementation (often the same database).</p>
</li><li class=" "><p   
>The certificate request is assumed to be performed with CMP.</p>
</li><li class=" "><p   
>The UNID feature is activated as described in the <strong class=" ">Custom Handling of Certificate Request</strong> section in <a   href="CMP.html">CMP</a>.</p>
</li><li class=" "><p   
>A Unid datasource called java:/UnidDS is configured in the application server. Note that this must be a 'no-tx-datasource', just like the OCSP publisher datasource. For information on how to create this manually, see <a   href="OCSP_Management.html">OCSP Management</a>.</p>
</li><li class=" "><p   
>A Unid database must be created, see above for details on the Unid database.</p>
</li></ul><p   
>Detailed operation:</p>
<ul class=" "><li class=" "><p   
>A CMP Certificate Request is performed with KeyId holding a Certificate Profile with name &quot;pppp-pppp-...&quot;</p>
</li><li class=" "><p   
>The Certificate Request contains a DN serialNumber attribute holding the ll-digit FNR + 5-digt LRA according to the following: <tt class=" ">Subject DN: CN=Alexander Rybak, serialNumber=fffffffffff-lllll, C=NO</tt></p>
</li><li class=" "><p   
>Now EJBCA creates a random 6-character alphanumeric string &quot;rrrrrr&quot; and rewrites the Subject DN so that the resulting certificate will be like:<br/><tt class=" ">Subject DN: CN=Alexander Rybak, serialNumber=pppp-pppp-lllllrrrrrr, C=NO</tt></p>
</li><li class=" "><p   
>In the database, the FNR is set to &quot;fffffffffff&quot; and UNID to &quot;pppp-pppp-lllllrrrrrr&quot;. UNID is a primary key in the DB to guarantee that it is unique.</p>
</li></ul><p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="CertificateHash.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>CertificateHash</span>
        </a>
                <a href="SCEP.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>SCEP</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
