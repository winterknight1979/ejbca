<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Part 3: Configuring the Microsoft Autoenrollment Servlet - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=11573605"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Guides.html">EJBCA Guides</a></li>
                                                                                     <li><a href="Certificate_Autoenrollment.html">Certificate Autoenrollment</a></li>
                                                            </ul>
</div>            <h1 id="src-11573605"> <span>Part 3: Configuring the Microsoft Autoenrollment Servlet</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>This section will cover:</p>
<ul class=" "><li class=" "><p   
>Installing the Auto Enrollment servlet</p>
</li><li class=" "><p   
>Updating the servlet configuration</p>
</li><li class=" "><p   
>Testing Auto Enrollment with EJBCA</p>
</li></ul><p   
>In the examples below, the domain used is primekey.com, the domain realm is PRIMEKEY.COM, the EJBCA server hostname is ejbcaserver.primekey.com, and the Tomcat server hostname is tomcatserver.primekey.com. This guide assumes the path to Tomcat server is /opt/tomcat.</p>
<p   
>The text highlighted in red should be replaced with names in your environment.</p>
    <div class="section section-1" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fOXp0dDIzaHZ0cmczMS5JbnN0YWxsdGhlQXV0b2Vucm9sbG1lbnRTZXJ2bGV0b25Ub21jYXRTZXJ2ZXI">
        <h1 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fOXp0dDIzaHZ0cmcz" class="confluence-anchor-link"></span><span>1. Install the Autoenrollment Servlet on Tomcat Server</span></h1>
<ol class=" "><li class=" "><p   
>Download the Auto Enrollment Servlet war file</p>
</li><li class=" "><p   
>With Tomcat running, deploy the war file to the Tomcat webapps directory (/opt/tomcat/webapps)</p>
</li><li class=" "><p   
>A new directory will appear named <i class=" ">autoenroll</i></p>
</li></ol>    </div>
    <div class="section section-1" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fN3M5cjVkNmFsbTd3Mi5Db25maWd1cmV0aGVBdXRvZW5yb2xsbWVudFNlcnZsZXRvblRvbWNhdFNlcnZlcg">
        <h1 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fN3M5cjVkNmFsbTd3" class="confluence-anchor-link"></span><span>2. Configure the Autoenrollment Servlet on Tomcat Server</span></h1>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC0yLjFLZXJiZXJvc2F1dGhlbnRpY2F0aW9u">
        <h2 class="heading "><span>2.1 Kerberos authentication</span></h2>
<p   
>Spnego is a mechanism to extend Kerberos authentication to HTTP servers such as Tomcat. Users authenticate to the Tomcat servlet using Windows Integrated Authentication (Kerberos) the same way they would authenticate to an internal Windows resource. When the Kerberos authentication protocol is used, the identity of the user, including the sAMAccountName is also passed to the Tomcat servlet as part of the Kerberos ticket.</p>
    <div class="section section-3" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fc3FsN3VhYmRlZ3JqMi4xLjFDcmVhdGluZ3RoZWxvZ2luLmNvbmZmaWxl">
        <h3 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fc3FsN3VhYmRlZ3Jq" class="confluence-anchor-link"></span><span>2.1.1 Creating the login.conf file</span></h3>
<ol class=" "><li class=" "><p   
>Create a file named <i class=" ">login.conf</i> in your Tomcat directory (/opt/tomcat).</p>
</li></ol><p   
>Edit <i class=" ">login.conf</i> and insert the following content:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">spnego-client {</code></div>
<div class="line"><code class="plain">  com.sun.security.auth.module.Krb5LoginModule required;</code></div>
<div class="line"><code class="plain">};</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">spnego-server {</code></div>
<div class="line"><code class="plain">  com.sun.security.auth.module.Krb5LoginModule required</code></div>
<div class="line"><code class="plain">  storeKey=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">  isInitiator=</code><code class="keyword">false</code><code class="plain">;</code></div>
<div class="line"><code class="plain">};</code></div>
</div>
    </div>
    </div>
    <div class="section section-3" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fZzBmaHBoaWUyeXR0Mi4xLjJDcmVhdGluZ3RoZWtyYjUuY29uZmZpbGU">
        <h3 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fZzBmaHBoaWUyeXR0" class="confluence-anchor-link"></span><span>2.1.2 Creating the krb5.conf file</span></h3>
<ol class=" "><li class=" "><p   
>Create a file named krb5.conf in your Tomcat directory (/opt/tomcat).</p>
</li></ol><p   
>Edit krb5.conf and insert the following content, ensure to update references to your own domain:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[libdefaults]</code></div>
<div class="line"><code class="plain">  default_realm = PRIMEKEY.COM</code></div>
<div class="line"><code class="plain">  default_tkt_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc</code></div>
<div class="line"><code class="plain">  default_tgs_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc</code></div>
<div class="line"><code class="plain">  permitted_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[realms]</code></div>
<div class="line"><code class="plain">  PRIMEKEY.COM = {</code></div>
<div class="line"><code class="plain">  kdc = PRIMEKEY.COM</code></div>
<div class="line"><code class="plain">  default_domain = PRIMEKEY.COM</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[domain_realm]</code></div>
<div class="line"><code class="plain">.primekey.com = PRIMEKEY.COM</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fYnUzcGZvdDB6dm55Mi4yRWRpdGluZ3RoZXNlcnZlci54bWxmaWxl">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fYnUzcGZvdDB6dm55" class="confluence-anchor-link"></span><span>2.2 Editing the server.xml file</span></h2>
<ol class=" "><li class=" "><p   
>Copy the tomcat_server.jks keystore and aewsclient.jks file downloaded earlier to /opt/tomcat</p>
</li><li class=" "><p   
>Edit /opt/tomcat/conf/server.xml</p>
<ol class=" "><li class=" "><p   
>Add the following section, to enable SSL, below the already commented 8443 section. Update the SSL server certificate and the password entries with your own:</p>
</li></ol></li></ol>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;Connector port=</code><code class="string">"8443"</code><code class="plain"> protocol=</code><code class="string">"HTTP/1.1"</code><code class="plain"> SSLEnabled=</code><code class="string">"true"</code><code class="plain"> </code></div>
<div class="line"><code class="plain"> maxThreads=</code><code class="string">"150"</code><code class="plain"> scheme=</code><code class="string">"https"</code><code class="plain"> secure=</code><code class="string">"true"</code><code class="plain"> </code></div>
<div class="line"><code class="plain"> clientAuth=</code><code class="string">"false"</code><code class="plain"> sslProtocol=</code><code class="string">"TLS"</code><code class="plain"> </code></div>
<div class="line"><code class="plain"> keystoreFile=</code><code class="string">"/opt/tomcat/tomcat_server.jks"</code><code class="plain"> </code></div>
<div class="line"><code class="plain"> keystorePass=</code><code class="string">"&lt;PASSWORD&gt;"</code><code class="plain"> </code></div>
<div class="line"><code class="plain"> /&gt;</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fNnVnODhmaHQxajNrMi4zRWRpdGluZ3RoZWF1dG9lbnJvbGxfY29uZmlnX2RpcmVjdG9yeS5wcm9wZXJ0aWVzZmlsZQ">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fNnVnODhmaHQxajNr" class="confluence-anchor-link"></span><span>2.3 Editing the autoenroll_config_directory.properties file</span></h2>
<ol class=" "><li class=" "><p   
>Navigate to /opt/tomcat/webapps/autoenroll/WEB-INF/</p>
</li><li class=" "><p   
>Update the autoenroll_config_directory.properties file with the path where the config files will be stored.</p>
</li><li class=" "><p   
>Create the auto enroll config directory (e.g. /opt/tomcat/autoenroll_conf)</p>
</li><li class=" "><p   
>Move msaes.properties, MSEnrollmentServlet.properties, MSTemplateToSettings.properties, template_file_mapping.properties, and the Template_Mappings directory to /opt/tomcat/autoenroll_conf</p>
</li></ol><p   
>web.xml and autoenroll_config_directory.properties should be backed up in case of a redeployment because these files will be overwritten.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain"># Specify the path to config directory</code></div>
<div class="line"><code class="plain"># e.g. Config_Directory=/path/to/directory/</code></div>
<div class="line"><code class="plain"># You may remark </code><code class="keyword">this</code><code class="plain"> line </code><code class="keyword">if</code><code class="plain"> all config files are to stay in WEB-INF directory </code></div>
<div class="line"><code class="plain">Config_Directory=/opt/tomcat/autoenroll_conf</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fbzRtOTlrNWlqZnU5Mi40RWRpdGluZ3RoZXdlYi54bWxmaWxl">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fbzRtOTlrNWlqZnU5" class="confluence-anchor-link"></span><span>2.4 Editing the web.xml file</span></h2>
<ol class=" "><li class=" "><p   
>Edit web.xml</p>
<ol class=" "><li class=" "><p   
>Update the spnego.preauth.username and spnego.preauth.password values with your service account (    <span style="color: #ff0000;">
servlet-service    </span>
) credentials.</p>
</li><li class=" "><p   
>Update the spnego.krb5.conf path to ${catalina.home}/krb5.conf</p>
</li><li class=" "><p   
>Update the spnego.login.conf path to ${catalina.home}/login.conf</p>
</li></ol></li><li class=" "><p   
>If not done so yet, create the Active Directory Bind account (    <span style="color: #ff0000;">
autoenrollmentbind    </span>
) with privileges to read Active Directory objects (add the account to the Cert Publishers group if certificate publishing to Active Directory is needed)</p>
</li><li class=" "><p   
>Navigate to /opt/tomcat/autoenroll_conf</p>
</li><li class=" "><p   
>Edit msaes.properties</p>
</li></ol><p   
>Enter the login information for the Active Directory Bind account</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain"># This file is used to specify the connection details </code><code class="keyword">for</code><code class="plain"> Active Directory:</code></div>
<div class="line"><code class="plain"># set up your bind Certificate Publisher account here </code></div>
<div class="line"><code class="plain"># Set to </code><code class="keyword">true</code><code class="plain"> </code><code class="keyword">if</code><code class="plain"> the connection should use SSL. This setting is currently unsupported and will have no effect. </code></div>
<div class="line"><code class="plain">#usessl=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain"># Provide the port number </code><code class="keyword">for</code><code class="plain"> the Active Directory connection. </code></div>
<div class="line"><code class="plain">#port=</code><code class="value">389</code></div>
<div class="line"><code class="plain"># Provide login </code><code class="keyword">for</code><code class="plain"> a user with access to read objects in Active Directory.</code></div>
<div class="line"><code class="plain"># It can be in the form of a fully distinguished name or user principal name.</code></div>
<div class="line"><code class="plain"># This user should also be in the Cert Publishers group in order to publish certificates.</code></div>
<div class="line"><code class="plain">logindn=CN=autoenrollmentbind,CN=Users,DC=Company,DC=com </code></div>
<div class="line"><code class="plain">#Provide the password </code><code class="keyword">for</code><code class="plain"> the logindn user </code></div>
<div class="line"><code class="plain">loginpassword=&lt;PASSWORD&gt;|</code></div>
</div>
    </div>
<p   
></p>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fajI5enJ2Y3podW1kMi41RWRpdGluZ3RoZU1TRW5yb2xsbWVudFNlcnZsZXQucHJvcGVydGllc2ZpbGU">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fajI5enJ2Y3podW1k" class="confluence-anchor-link"></span><span>2.5 Editing the MSEnrollmentServlet.properties file</span></h2>
<ol class=" "><li class=" "><p   
>Edit MSEnrollmentServlet.properties</p>
</li></ol><p   
>Update the location of the keystore with permissions to access Web Services API, Web Services URL, and the name of the CA for Auto Enrollment.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">EJBCA_KeyStorePassword=&lt;PASSWORD&gt;</code></div>
<div class="line"><code class="plain">EJBCA_TrustedKeyStore=/opt/tomcat/aewsclient.jks</code></div>
<div class="line"><code class="plain">EJBCA_KeyStore=/opt/tomcat/aewsclient.jks</code></div>
<div class="line"><code class="plain">EJBCA_TrustedKeyStorePassword=&lt;PASSWORD&gt;</code></div>
<div class="line"><code class="plain">EJBCA_WebServiceUrl=https:</code><code class="comments">//ejbcaserver.primekey.com:8443/ejbca/ejbcaws/ejbcaws?wsdl</code></div>
<div class="line"><code class="plain">EJBCA_CAName=Issuing CA</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fYmM0dG94N2R5Y2Z2Mi42RWRpdGluZ3RoZU1TVGVtcGxhdGVUb1NldHRpbmdzLnByb3BlcnRpZXNmaWxl">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fYmM0dG94N2R5Y2Z2" class="confluence-anchor-link"></span><span>2.6 Editing the MSTemplateToSettings.properties file</span></h2>
<ol class=" "><li class=" "><p   
>Edit MSTemplateToSettings.properties.</p>
<ol class=" "><li class=" "><p   
>Update/add your Microsoft certificate template OID in the MSTemplateToSettings.properties file and set the EJBCA Certificate Profile and End Entity Profile that should map to the OID. Below is an example of a User Template settings. Update other attributes as desired.</p>
</li></ol></li></ol>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">#User </code></div>
<div class="line"><code class="plain">id1.used=</code><code class="keyword">true</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.oid=</code><code class="value">1.3</code><code class="plain">.</code><code class="value">6.1</code><code class="plain">.</code><code class="value">4.1</code><code class="plain">.</code><code class="value">311.21</code><code class="plain">.</code><code class="value">8.9377535</code><code class="plain">.</code><code class="value">8819452.10569393</code><code class="plain">.</code><code class="value">8297822.7357582</code><code class="plain">.</code><code class="value">214.8450877</code><code class="plain">.</code><code class="value">6015317</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.certprofile=User_Certificate_Profile </code></div>
<div class="line"><code class="plain">id1.eeprofile=User_End_Entity_Profile </code></div>
<div class="line"><code class="plain">id1.subject_name_format=common_name </code></div>
<div class="line"><code class="plain">id1.include_email_in_subjectdn=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_email_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_dns_name_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_upn_in_san=</code><code class="keyword">true</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_spn_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_netbios_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_domain_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.include_objectguid_in_san=</code><code class="keyword">false</code><code class="plain"> </code></div>
<div class="line"><code class="plain">id1.additional_subjectdn_attributes= </code></div>
<div class="line"><code class="plain">id1.publish_to_active_directory=</code><code class="keyword">false</code></div>
</div>
    </div>
<p   
></p>
<p   
>This is one example showing how the Template Settings can be configurable. This example was for a typical Users enrollment. In the WEB-INF directory in the package you can look at the MSTemplateToSettings.properties file where there are 5 examples.</p>
<p   
>In these 5 examples, you will see they all have separate Certificate Profiles and End Entity Profiles. The key usages are configured in EJBCA Certificate Profiles. These values in the Certificate Profile will be used when creating the certificate and are not taken from Microsoft AD.</p>
<p   
>The typical template currently for Domain Controllers is Kerberos Authentication. In the id3 example in WEB-INF, all the settings you need to match the Microsoft template are pre-selected as true. All you need to do is to make sure your EJBCA Certificate Profile, KerberosAuthenticationAE in this example, match the key usages and extended key usages as what you'll find in the Microsoft template.</p>
<p   
>You can create multiple <i class=" ">Users</i>-auto enrollment profiles. For example, if you wanted one for Client Authentication and another one for EFS, you could do something like the following (just make sure you set the proper key usages in the certificate profiles):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">#User Client Authentication</code></div>
<div class="line"><code class="plain">id1.used=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">id1.oid=</code><code class="value">1.3</code><code class="plain">.</code><code class="value">6.1</code><code class="plain">.</code><code class="value">4.1</code><code class="plain">.</code><code class="value">311.21</code><code class="plain">.</code><code class="value">8.8363460</code><code class="plain">.</code><code class="value">647874.2770861</code><code class="plain">.</code><code class="value">12891986.167474</code><code class="plain">.</code><code class="value">23.5536586</code><code class="plain">.</code><code class="value">16651511</code></div>
<div class="line"><code class="plain">id1.certprofile=UserClientAuth</code></div>
<div class="line"><code class="plain">id1.eeprofile= UserClientAuthEEProfile</code></div>
<div class="line"><code class="plain">id1.subject_name_format=common_name</code></div>
<div class="line"><code class="plain">id1.include_email_in_subjectdn=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_email_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_dns_name_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_upn_in_san=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">id1.include_spn_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_netbios_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_domain_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.include_objectguid_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id1.additional_subjectdn_attributes=</code></div>
<div class="line"><code class="plain">id1.publish_to_active_directory=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">#User EFS</code></div>
<div class="line"><code class="plain">id2.used=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">id2.oid=</code><code class="value">1.3</code><code class="plain">.</code><code class="value">6.1</code><code class="plain">.</code><code class="value">4.1</code><code class="plain">.</code><code class="value">311.21</code><code class="plain">.</code><code class="value">8.8363460</code><code class="plain">.</code><code class="value">647874.2770861</code><code class="plain">.</code><code class="value">12891986.167474</code><code class="plain">.</code><code class="value">23.180725</code><code class="plain">.</code><code class="value">6239834</code></div>
<div class="line"><code class="plain">id2.certprofile=UserEFS</code></div>
<div class="line"><code class="plain">id2.eeprofile= UserEFSEEProfile</code></div>
<div class="line"><code class="plain">id2.subject_name_format=common_name</code></div>
<div class="line"><code class="plain">id2.include_email_in_subjectdn=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_email_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_dns_name_in_san= </code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_upn_in_san= </code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_spn_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_netbios_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_domain_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.include_objectguid_in_san=</code><code class="keyword">false</code></div>
<div class="line"><code class="plain">id2.additional_subjectdn_attributes=</code></div>
<div class="line"><code class="plain">id2.publish_to_active_directory=</code><code class="keyword">false</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fdHZrc2drejhhNnIzMi43RWRpdGluZ3RoZWxvZzRqLnByb3BlcnRpZXNmaWxl">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fdHZrc2drejhhNnIz" class="confluence-anchor-link"></span><span>2.7 Editing the log4j.properties file</span></h2>
<ol class=" "><li class=" "><p   
>Copy the log4j.properties file to /opt/tomcat/lib directory</p>
</li><li class=" "><p   
>Edit the log4j.properties file</p>
</li></ol><p   
>This file contains settings for the behavior of logging. You may change the logging level (INFO, DEBUG, TRACE, etc.).</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">log4j.rootLogger = INFO, file</code></div>
<div class="line"><code class="plain"># Define all the appenders</code></div>
<div class="line"><code class="plain">log4j.appender.file = org.apache.log4j.DailyRollingFileAppender </code></div>
<div class="line"><code class="plain">log4j.appender.file.File = ${catalina.base}/logs/msae.log </code></div>
<div class="line"><code class="plain">log4j.appender.file.Append = </code><code class="keyword">true</code><code class="plain"> </code></div>
<div class="line"><code class="plain">log4j.appender.file.Encoding = UTF-</code><code class="value">8</code></div>
<div class="line"><code class="plain"># Roll-over the log once per day </code></div>
<div class="line"><code class="plain">log4j.appender.file.DatePattern = </code><code class="string">'.'</code><code class="plain">yyyy-MM-dd</code></div>
<div class="line"><code class="plain">log4j.appender.file.layout = org.apache.log4j.PatternLayout </code></div>
<div class="line"><code class="plain">log4j.appender.file.layout.ConversionPattern = %d %-5p - %m%n</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fNmRoc3Bvbzh0anhmMi44UmVzdGFydFRvbWNhdA">
        <h2 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fNmRoc3Bvbzh0anhm" class="confluence-anchor-link"></span><span>2.8 Restart Tomcat</span></h2>
<ol class=" "><li class=" "><p   
>Restart Tomcat service to reload the configuration.</p>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fMTgyeW93Zzdpbm9sMy5UZXN0QXV0b0Vucm9sbG1lbnR3aXRoRUpCQ0E">
        <h1 class="heading "><span id="src-11573605_safe-id-aWQtLlBhcnQzOkNvbmZpZ3VyaW5ndGhlTWljcm9zb2Z0QXV0b2Vucm9sbG1lbnRTZXJ2bGV0djYuMTAuMC1fMTgyeW93Zzdpbm9s" class="confluence-anchor-link"></span><span>3. Test Auto Enrollment with EJBCA</span></h1>
<ol class=" "><li class=" "><p   
>For any user who has logged in prior, you may need to delete the cached policy information in the local user account directory.</p>
<ol class=" "><li class=" "><p   
>The location of the cached user policy is: C:\Users\&lt;username&gt;\AppData\Local\Microsoft\Windows\X509Enrollment</p>
</li><li class=" "><p   
>The location of the cached machine policy is: C:\ProgramData\Microsoft\Windows\X509Enrollment</p>
</li></ol></li><li class=" "><p   
>To test auto enrollment for users, you simply have to log in to any Windows PC on the domain.</p>
</li><li class=" "><p   
>To test auto enrollment for computers, you can reboot the machine on the domain.</p>
</li><li class=" "><p   
>Verify the user certificate was generated by opening certmgr.msc (Current User/ Personal/ Certificates).</p>
<ol class=" "><li class=" "><p   
>Ensure the user certificate in the personal store is generated by EJBCA.</p>
</li></ol></li><li class=" "><p   
>Verify the computer certificate was generated by opening mmc.exe and adding the Certificates snap-in. (Local Computer/ Personal/ Certificates - will need Admin privileges to check the Local computer certificate store).</p>
<ol class=" "><li class=" "><p   
>Ensure the computer certificate in the personal store is generated by EJBCA</p>
</li></ol></li></ol><p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Part_2__Microsoft_Certification_Authority_and_Group_Policies.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Part 2: Microsoft Certification Authority and Group Policies</span>
        </a>
                <a href="Appendix.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Appendix</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
