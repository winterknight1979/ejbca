<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CMP - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=22381531"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Concept_Guide.html">EJBCA Concept Guide</a></li>
                                                                                     <li><a href="Protocols.html">Protocols</a></li>
                                                            </ul>
</div>            <h1 id="src-22381531"> <span>CMP</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>The Certificate Management Protocol (CMP) is an Internet protocol used for obtaining X.509 digital certificates in a public key infrastructure (PKI). It is described in <a  class="external-link" href="https://www.ietf.org/rfc/rfc4210.txt">RFC4210</a> and is one of two protocols to use the Certificate Request Message Format (CRMF), described in <a  class="external-link" href="https://www.ietf.org/rfc/rfc4211.txt">RFC4211</a>. This section covers the following:</p>
<p   
></p>
<ul class="toc-indentation "><li class=" "><p   
><a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ01QYW5kM0dQUC80Ry9MVEVDb25maWd1cmF0aW9uR3VpZGVDTVBfYW5kXzNHUFBfNEdfTFRFX2NvbmZpZ3VyYXRpb25fZ3VpZGU">CMP and 3GPP/4G/LTE Configuration Guide</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPAliasConfiguration">CMP Alias Configuration</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-Configuration">Configuration</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPoverHTTPCMP_over_http">CMP over HTTP</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPoverTCPCMP_over_TCP">CMP over TCP</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPMessageAuthenticationCMP_Message_Authentication">CMP Message Authentication</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPResponseMessageCMP_Response_Message">CMP Response Message</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-ClientModeforCMPClient_mode_for_CMP">Client Mode for CMP</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-RAModeforCMPRA_mode_for_CMP">RA Mode for CMP</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtS2V5VXBkYXRlUmVxdWVzdChrdXIpS2V5X1VwZGF0ZV9SZXF1ZXN0">Key Update Request (kur)</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-ProofofPossessionProof_of_possession">Proof of Possession</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-ServerGeneratedKeysServer_Generated_Keys">Server Generated Keys</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CertificateValidityCertificate_validity">Certificate Validity</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CertificateKeyUsageCertificate_Key_Usage">Certificate Key Usage</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtSW50ZXJvcGVyYWJpbGl0eS9UZXN0ZWRMaWJyYXJpZXNhbmREZXZpY2VzSW50ZXJvcGVyYWJpbGl0eQ">Interoperability / Tested Libraries and Devices</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-SampleCMPworkflowSample_CMP_workflow">Sample CMP workflow</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CustomhandlingofcertificaterequestCustom_handling_of_certificate_request">Custom handling of certificate request</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPErrorMessagesCMP_Error_Messages">CMP Error Messages</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ01QUHJveHlDTVBfUHJveHlfKEVKQkNBX0VudGVycHJpc2Vfb25seSk">CMP Proxy</a></p>
</li><li class=" "><p   
><a   href="#src-22381531_id-.CMPv6.15.0-CMPProxyErrorMessagesCMP_Proxy_Error_Messages">CMP Proxy Error Messages</a></p>
</li></ul><p   
>EJBCA supports the following messages of the complex CMP protocol (<a  class="external-link" href="https://www.ietf.org/rfc/rfc4210.txt">RFC4210</a>):</p>
<ul class=" "><li class=" "><p   
>Initialization request (ir)</p>
</li><li class=" "><p   
>Certification request (cr)</p>
</li><li class=" "><p   
>Certification confirm (certConf)</p>
</li><li class=" "><p   
>Revocation request (rr)</p>
</li><li class=" "><p   
>NestedMessageContent (nested)</p>
</li><li class=" "><p   
>Key Update Request (kur)</p>
</li></ul><p   
>Certificate requests use the CRMF (<a  class="external-link" href="https://www.ietf.org/rfc/rfc4211.txt">RFC4211</a>).</p>
<p   
>EJBCA can work in the following modes with CMP:</p>
<ul class=" "><li class=" "><p   
><strong class=" ">Client mode</strong>: Default. Client mode works like any other enrollment in EJBCA. When a request comes in, EJBCA verifies the request (see <a   href="#src-22381531_id-.CMPv6.15.0-CMP_Message_Authentication">CMP Message Authentication</a>) and issues a certificate to a user that has been previously registered in EJBCA.</p>
</li><li class=" "><p   
><strong class=" ">RA mode</strong>: Used when the CMP client acts as an RA to EJBCA (the RA sends a certificate request to EJBCA). No user is pre-registered in EJBCA, but when authenticated RA CMP messages arrive, a user is created in EJBCA and a certificate is issued.</p>
</li></ul><p   
>In RA mode, EJBCA supports several CAs and profiles based on the use of configuration alias specified in the URL used (see <a   href="#src-22381531_id-.CMPv6.15.0-CMP_over_http">CMP over HTTP</a>).</p>
    <div class="section section-1" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ01QYW5kM0dQUC80Ry9MVEVDb25maWd1cmF0aW9uR3VpZGVDTVBfYW5kXzNHUFBfNEdfTFRFX2NvbmZpZ3VyYXRpb25fZ3VpZGU">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_and_3GPP_4G_LTE_configuration_guide" class="confluence-anchor-link"></span><span>CMP and 3GPP/4G/LTE Configuration Guide </span></h1>
<p   
>PrimeKey has created a detailed CMP configuration guide, with details how to configure EJBCA for 3GPP/4G/LTE networks using CMP. The guide is available together with a support subscription from PrimeKey. For more information, refer to <a  class="external-link" href="http://www.primekey.com">www.primekey.com</a>.</p>
<p   
>The following displays an example cmpforopenssl command to test Vendor CA authentication with a three level Vendor CA PKI:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">.</code><code class="plain">/cmpclient</code><code class="plain"> --server 127.0.0.1 --port 8080 --path ejbca</code><code class="plain">/publicweb/cmp/vendor</code><code class="plain"> --srvcert 3GPPCA.cacert.pem --ir --subject </code><code class="string">"C=SE,O=Test,CN=Network Element 32"</code><code class="plain"> --clcert nevcert.pem --newclcert nev-</code><code class="functions">op</code><code class="plain">-crt.der --newkey nev-</code><code class="functions">op</code><code class="plain">-key.pem --key nevkey.pem --extracert casubnevcert.pem</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPAliasConfiguration">
        <h1 class="heading "><span>CMP Alias Configuration</span></h1>
<ul class=" "><li class=" "><p   
>CMP Operational Mode: Client mode</p>
</li><li class=" "><p   
>CMP Authentication Module: EndEntityCertificate</p>
</li><li class=" "><p   
>Extract Username Component: CN</p>
</li><li class=" "><p   
>Use Vendor Certificate Mode: Use and add CANevRoot as Vendor CA</p>
</li></ul>    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-Configuration">
        <h1 class="heading "><span>Configuration</span></h1>
<p   
>Configuring CMP is done in the Admin GUI, under <strong class=" ">CMP Configuration</strong>. To be able to edit the CMP configuration, you require <strong class=" ">edit_systemconfiguration</strong> access.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPoverHTTPCMP_over_http">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_over_http" class="confluence-anchor-link"></span><span>CMP over HTTP </span></h1>
<p   
>By default, EJBCA supports CMP over the http transport protocol. The URL for the CMP servlet is: http://127.0.0.1:8080/ejbca/publicweb/cmp/ALIAS.</p>
<p   
>ALIAS is a configuration alias specifying the set of CMP configurations to be used when handling a request sent through this specific URL. ALIAS can be any alphanumeric string and you can specify as many aliases as you need in the Admin GUI.</p>
<p   
>Example:<code class=" "> http://127.0.0.1:8080/ejbca/publicweb/cmp/cmpalias</code></p>
<p   
>Any CMP request sent through this URL will use the CMP configurations associated with the alias <strong class=" ">cmpalias</strong>.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPoverTCPCMP_over_TCP">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_over_TCP" class="confluence-anchor-link"></span><span>CMP over TCP </span></h1>
<p   
>You can enable a CMP TCP service by changing the option <strong class=" ">cmp.tcp.enabled</strong> in the conf/cmptcp.properties file. Ensure to copy the conf/cmptcp.properties.sample to conf/cmptcp.properties first. When re-deploying EJBCA, a TCP listener is started on the default port for CMP over TCP. You must run the application server as root to use the default port, since it is a low port (&lt;1024). Refer to the documentation in conf/cmp.properties for information about configuration options for TCP. We recommend using a non standard port &gt; 1024.</p>
<p   
>CMP requests sent over TCP will be using CMP configurations associated with the configuration alias <strong class=" ">tcp</strong>. Note that a CMP configuration alias with the name <strong class=" ">tcp</strong> does not exist per default. It has to be created (and/or altered) using the Admin GUI before any CMP request arrives through TCP.</p>
<p   
>EJBCA will cease to support CMP over TCP, and it is strongly recommended to use CMP over HTTP instead.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPMessageAuthenticationCMP_Message_Authentication">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_Message_Authentication" class="confluence-anchor-link"></span><span>CMP Message Authentication </span></h1>
<p   
>EJBCA supports four modules for message authentication, configured in the Admin GUI under <strong class=" ">CMP Configuration</strong>.</p>
<p   
>The supported modules are either password extractors or PKIMessage verifiers:</p>
    <div  class="tablewrap">
        <table class="relative-table wrapped confluenceTable">
                    <colgroup>
                                    <col  width="17%"/>
                                    <col  width="82%"/>
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Module</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Description</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="2">
    <p   
>Password extractors (client mode only)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>RegTokenPwd</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Extracts the password from the CMP request through the means of a regToken control (id-regCtrl-regToken) in the CRMF message. The regToken is a UTF8String containing the user password as registered in EJBCA. This module requires no parameters.</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>DnPartPwd</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Extracts the password from the subjectDN of the user the request concerns. As a parameter, the DN part that contains the password should be specified. For example, if the subjectDN is &quot;CN=name,C=se,UID=PASSWORD&quot;, the parameters should be set to &quot;UID&quot;.</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="2">
    <p   
>PKIMessage verifiers</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HMAC</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>This module uses a shared secret to authenticate the CMP message:</p>
<ul class=" "><li class=" "><p   
>In RA mode, the shared secret is set as a parameter to this module. If no parameter is specified, EJBCA uses the shared secret specified in the CA under <strong class=" ">CMP RA Authentication Secret</strong>.</p>
</li><li class=" "><p   
>In client mode, the pre-registered end entity will be looked up in the database, and if there was a clear text password there, this password will be used to authenticate the message. If there is no clear text password associated with that end entity, the authentication will fail.</p>
</li></ul>            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>EndEntityCertificate</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>When the EndEntityCertificate module is used, the request sender should attach his certificate in the extraCert field in the PKIMessage and then sign the message with his private key.</p>
<ul class=" "><li class=" "><p   
>In client mode, a user may only send a CMP request regarding his/her own certificate. EJBCA will then check if the certificate in extraCert does exist in its database and verifies that it belongs to the sender before verifying the signature. No parameters should be specified for this module in client mode.</p>
</li><li class=" "><p   
>In RA mode, as a parameter, this module expects the name of the CA that has issued the certificate in the extraCert field. If a parameter is specified, EJBCA checks if the certificate in extraCert does exist in the database, that it was issued by the right CA (the CA specified as a parameter), and that it belongs to a registered administrator in EJBCA with the right authorizations to perform the operations required in the request. If no parameter is specified, none of the mentioned checks will be performed. However, EJBCA will expect the CMP request to have been previously authenticated by other ways, for example, by sending the request inside a signed NestedMessageContent.</p>
</li></ul>            </td>
        </tr>
</tbody>        </table>
            </div>
<p   
>You can specify more than one module in the Admin GUI <strong class=" ">CMP Configuration</strong> by separating the modules with a semicolon &quot;;&quot;. If specifying multiple modules, the first module is used for authentication testing. If the first module fails, the second module is used for authentication testing, and so on until a successful authentication is done or all alternatives fail.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPResponseMessageCMP_Response_Message">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_Response_Message" class="confluence-anchor-link"></span><span>CMP Response Message</span></h1>
<p   
>When a CMP request is successful, EJBCA returns a protected CMP response message. The protection type of the response message can also be configured in the Admin GUI under <strong class=" ">CMP Configuration</strong>. EJBCA supports the following types of response message protection: <a   href="#src-22381531_id-.CMPv6.15.0-pbe">pbe</a> and <a   href="#src-22381531_id-.CMPv6.15.0-signature">signature</a><strong class=" ">.</strong></p>
<p   
>If a CMP request fails, EJBCA returns an unprotected, unencrypted CMP error message.</p>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-pbepbe">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-pbe" class="confluence-anchor-link"></span><span> pbe</span></h2>
<p   
>This type of protection of the response message can be used only when the request was authenticated using HMAC authentication module. The parameters used for the <strong class=" ">pbe</strong> protection are based on the parameters used in the received HMAC authentication.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-signaturesignature">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-signature" class="confluence-anchor-link"></span><span> signature</span></h2>
<p   
>The CA used to handle the CMP request signs the CMP response message using the same protection algorithm specified in the CMP request. If a conflict occurs between the protection algorithm in the request and the CA's signature algorithm, the CA's key algorithm will be used in combination with a digest algorithm based on the protection algorithm in the CMP request. If a conflict occurs even on the digest algorithm level, a default digest algorithm will be used. For example, if the CMP request uses the protection algorithm ECDSA with SHA1 and the CA's signature algorithm is RSA with SHA256, the CMP response will be signed using RSA with SHA1.</p>
<p   
>The<strong class=" "> signature</strong> type of response protection can be used regardless of what authentication module was used to authenticate the CMP request.</p>
<p   
>CMP messages are signed using the CAs signature key. Verification of the signed CMP messages hence typically assumes that overly strict enforcement of Key Usage in CA certificate is not in place (similar to allow signing of OCSP responses under the CRLSign Key Usage).</p>
    <div  class="confbox admonition admonition-info">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p  class="p1" 
>The CA certificates returned with the CMP response message can be configured in the CMP configuration. For a list of CMP error codes, see <a   href="#src-22381531_id-.CMPv6.15.0-CMPErrorMessages">CMP Error Messages</a>.</p>
        </div>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-CMPResponseAdditionalCACertificatesCMP_Response_Additional_CA_Certificates">
        <h2 class="heading p1"><span id="src-22381531_id-.CMPv6.15.0-CMP_Response_Additional_CA_Certificates" class="confluence-anchor-link"></span><span>CMP Response Additional CA Certificates </span></h2>
<p  class="p1" 
>Additional CA certificates available in EJBCA can be added to the CMP response message (CertRepMessage.caPubs). Independent from the additional CA certificates configured, the signing CA certificate is returned at index 0 every time.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-PKIMessageResponseAdditionalCACertificatesPKI_Message_Response_Additional_CA_Certificates">
        <h2 class="heading p1"><span id="src-22381531_id-.CMPv6.15.0-PKI_Message_Response_Additional_CA_Certificates" class="confluence-anchor-link"></span><span>PKI Message Response Additional CA Certificates </span></h2>
<p  class="p1" 
>Additional CA certificates available in EJBCA can be added to the CMP response wrapping PKI message (PKIMessage.extraCerts). Independent from the additional CA certificates configured, the response message signing CA certificate chain is included from index 0 every time.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-ClientModeforCMPClient_mode_for_CMP">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Client_mode_for_CMP" class="confluence-anchor-link"></span><span>Client Mode for CMP </span></h1>
<p   
>Client mode is used when the CMP client will act as an End Entity to EJBCA. This means that the End Entity must be pre-registered in EJBCA and that the client request is authenticated with this pre-registered end entity before a certificate is issued. This is the same authentication model as for regular enrollment, i.e. browser enrollment, using a username/password combination.</p>
<ul class=" "><li class=" "><p   
>The users DN is deducted from the request according to rules configured.</p>
</li><li class=" "><p   
>The username in EJBCA must be pre-registered.</p>
</li><li class=" "><p   
>The password for the user in EJBCA must be passed in the request (one-time password).</p>
</li><li class=" "><p   
>If the Certificate Profile allows it, keyUsage, validity and extensions are also taken from the CertTemplate in the request message.</p>
</li><li class=" "><p   
>Signature POPO is used.</p>
</li></ul><p   
>After the user has been authenticated in EJBCA, a certificate is generated as usual and sent back to the client.</p>
<p   
>To use client mode, no particular configuration is needed, since this is the default mode.</p>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-User_look-upUserlook-up">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-User_look-up" class="confluence-anchor-link"></span><span>User look-up</span></h2>
<p   
>Initialization and certification requests uses the CRMF request message (RFC4211).</p>
<p   
>Users can be looked up from the request in different ways, as configured in the Admin GUI under <strong class=" ">CMP Configuration</strong>. By default the subject DN from the certTemplate in the request is used to look up the used in EJBCA. You can also configure EJBCA to use the CN or the UID from the subject DN as the username in EJBCA.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-VendorCAAuthenticationVendor_CA_Authentication">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Vendor_CA_Authentication" class="confluence-anchor-link"></span><span>Vendor CA Authentication </span></h2>
<p   
></p>
<p   
><span class="status blue " >ENTERPRISE</span>
 This is an EJBCA Enterprise feature.</p>
<p   
>If the end entity has a Vendor certificate with which it should identify itself for initial enrollment, as specified in 3GPP for example, it can also do that. In this case the CA issuing the end entity certificate is not the same as the Vendor CA. The vendor CA must be imported in EJBCA as an External CA (<strong class=" ">Admin GUI&gt;Import CA certificate</strong>). This is described in detail in the integration guide for 3GPP available with EJBCA Enterprise.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-RAModeforCMPRA_mode_for_CMP">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-RA_mode_for_CMP" class="confluence-anchor-link"></span><span>RA Mode for CMP </span></h1>
<p   
>RA mode is used when the CMP client will act as an RA to EJBCA. When the RA sends a certificate request to EJBCA, no user needs to be pre-registered in EJBCA. When EJBCA receives the request, the message will be authenticated. After it has been authenticated, a user is created, and a certificate is issued.</p>
<ul class=" "><li class=" "><p   
>The users DN is taken from the CertTemplate in the request message send from the RA (i.e. the DN requested by the RA).</p>
</li><li class=" "><p   
>The username in EJBCA is generated according to the options configured.</p>
</li><li class=" "><p   
>The password for the user in EJBCA is random.</p>
</li><li class=" "><p   
>If the Certificate Profile allows it, keyUsage, validity and extensions are also taken from the CertTemplate in the request message.</p>
</li><li class=" "><p   
>raVerify POPO is used.</p>
</li><li class=" "><p   
>Messages are authenticated using one of the configured authentication modules.</p>
</li></ul><p   
>After the user has been created in EJBCA, a certificate is generated as usual and sent back to the RA, who will distribute it to the end-user.</p>
<p   
>If the same username is constructed (for example UID) as an already existing user, the existing user will be modified with new values for profile etc, and a new certificate will be issued for that user.</p>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-KeyID">
        <h2 class="heading "><span>KeyID</span></h2>
<p   
>Instead of specifying an RA End Entity Profile, RA Certificate Profile, and/or RA CA Name explicitly when creating a CMP alias, you can choose the <strong class=" ">KeyID</strong> option. When this option is selected, the value of the <strong class=" ">senderKID</strong> field in the CMP request is used instead of the corresponding entry in the CMP alias (which is set to KeyID). The client sending the CMP request must ensure the correctness of the CMP request, for example. that the CA and Certificate Profile is authorized by the End Entity profile.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>Note that KeyID is only visible when the number of available options is at least two.</p>
        </div>
    </div>
<p   
>KeyID is useful when you want to issue different types of certificates using a single CMP alias. The EJBCA cmpclient tool allows you to set KeyID explicitly using the <code class=" ">--keyid</code> argument.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-MultiprotectionSupportMultiprotection_Support">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Multiprotection_Support" class="confluence-anchor-link"></span><span>Multiprotection Support </span></h2>
<p   
>In RA mode, it is also possible to send a CMP request with multiple signatures. EJBCA implements this feature following the specifications in RFC4210. In cases where an end entity sends a protected PKI message to an RA, the RA forwards that message to a CA, attaching its own signature for protection. This is accomplished by nesting the entire message sent by the end entity within a new PKI message.</p>
<p   
>Sample code for a signature protected NestedMessageContent message:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">String subjectDN = </code><code class="string">"CN=bogusSubjectNested"</code><code class="plain">;</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] nonce = </code><code class="string">"sendernonce"</code><code class="plain">.getBytes();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] transid = </code><code class="string">"trandis"</code><code class="plain">.getBytes();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIMessage crmfMsg = createCrmfReq();</code></div>
<div class="line"><code class="comments">//Signing crmfMsg</code></div>
<div class="line"><code class="plain">KeyPair eeKeys = getAdminKeys();</code></div>
<div class="line"><code class="plain">Certificate adminCert = getAdminCertificate();</code></div>
<div class="line"><code class="plain">ByteArrayInputStream    bIn = </code><code class="keyword">new</code><code class="plain"> ByteArrayInputStream(adminCert.getEncoded());</code></div>
<div class="line"><code class="plain">ASN1InputStream         dIn = </code><code class="keyword">new</code><code class="plain"> ASN1InputStream(bIn);</code></div>
<div class="line"><code class="plain">ASN1Sequence extraAdminCertSeq = (ASN1Sequence)dIn.readObject();</code></div>
<div class="line"><code class="plain">X509CertificateStructure extraCert = </code><code class="keyword">new</code><code class="plain"> X509CertificateStructure(ASN1Sequence.getInstance(extraAdminCertSeq));</code></div>
<div class="line"><code class="plain">crmfMsg.addExtraCert(extraCert);</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">final</code><code class="plain"> Signature sig = Signature.getInstance(PKCSObjectIdentifiers.sha256WithRSAEncryption.getId(), BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">sig.initSign(eekeys.getPrivate());</code></div>
<div class="line"><code class="plain">sig.update(crmfMsg.getProtectedBytes());</code></div>
<div class="line"><code class="keyword">byte</code><code class="plain">[] eeSignature = sig.sign();</code></div>
<div class="line"><code class="plain">crmfMsg.setProtection(</code><code class="keyword">new</code><code class="plain"> DERBitString(eeSignature));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIHeader myPKIHeader = </code><code class="keyword">new</code><code class="plain"> PKIHeader(</code><code class="keyword">new</code><code class="plain"> DERInteger(</code><code class="value">2</code><code class="plain">), </code><code class="keyword">new</code><code class="plain"> GeneralName(</code><code class="keyword">new</code><code class="plain"> X509Name(subjectDN)), </code><code class="keyword">new</code><code class="plain"> GeneralName(</code><code class="keyword">new</code><code class="plain"> X509Name(((X509Certificate)cacert).getSubjectDN().getName())));</code></div>
<div class="line"><code class="plain">myPKIHeader.setMessageTime(</code><code class="keyword">new</code><code class="plain"> DERGeneralizedTime(</code><code class="keyword">new</code><code class="plain"> Date()));</code></div>
<div class="line"><code class="comments">// senderNonce</code></div>
<div class="line"><code class="plain">myPKIHeader.setSenderNonce(</code><code class="keyword">new</code><code class="plain"> DEROctetString(nonce));</code></div>
<div class="line"><code class="comments">// TransactionId</code></div>
<div class="line"><code class="plain">myPKIHeader.setTransactionID(</code><code class="keyword">new</code><code class="plain"> DEROctetString(transid));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">PKIBody myPKIBody = </code><code class="keyword">new</code><code class="plain"> PKIBody(crmfMsg, </code><code class="value">20</code><code class="plain">); </code><code class="comments">// NestedMessageContent</code></div>
<div class="line"><code class="plain">PKIMessage myPKIMessage = </code><code class="keyword">new</code><code class="plain"> PKIMessage(myPKIHeader, myPKIBody);</code></div>
<div class="line"><code class="comments">//Signing myPKIMessage</code></div>
<div class="line"><code class="plain">KeyPair raKeys = getRAKeys();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> Signature sig = Signature.getInstance(PKCSObjectIdentifiers.sha256WithRSAEncryption.getId(), BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">sig.initSign(rakeys.getPrivate());</code></div>
<div class="line"><code class="plain">sig.update(myPKIMessage.getProtectedBytes());</code></div>
<div class="line"><code class="keyword">byte</code><code class="plain">[] eeSignature = sig.sign();</code></div>
<div class="line"><code class="plain">myPKIMessage.setProtection(</code><code class="keyword">new</code><code class="plain"> DERBitString(eeSignature));</code></div>
<div class="line"> </div>
<div class="line"><code class="keyword">final</code><code class="plain"> ByteArrayOutputStream bao = </code><code class="keyword">new</code><code class="plain"> ByteArrayOutputStream();</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> DEROutputStream out = </code><code class="keyword">new</code><code class="plain"> DEROutputStream(bao);</code></div>
<div class="line"><code class="plain">out.writeObject(myPKIMessage);</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] ba = bao.toByteArray();</code></div>
<div class="line"><code class="comments">// Send request and receive response</code></div>
<div class="line"><code class="keyword">final</code><code class="plain"> </code><code class="keyword">byte</code><code class="plain">[] resp = sendCmpHttp(ba, </code><code class="value">200</code><code class="plain">);</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-Sample_configSampleConfig">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Sample_config" class="confluence-anchor-link"></span><span>Sample Config</span></h2>
<p   
>A sample configuration of EJBCA to allow an RA to request certificates for users. The RA uses password based mac (pbe) protection of CMP messages with password 'password'. Users will be created using UID from the request DN and with a prefix, so the resulting username will be: cmp&lt;UsersUID&gt;. End entity profiles names CMP_ENTITY and CMP_CERT is created in EJBCA allowing the request DN.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Operational Mode : RA Mode</code></div>
<div class="line"><code class="plain">Allow RA Verify Proof-of-Possession : check</code></div>
<div class="line"><code class="plain">CMP Response Protection : pbe</code></div>
<div class="line"><code class="plain">CMP Authentication Module : HMAC</code></div>
<div class="line"><code class="plain">CMP Authentication Parameters : password</code></div>
<div class="line"><code class="plain">RA Name Generation Scheme : DN</code></div>
<div class="line"><code class="plain">RA Name Generation Parameters : UID</code></div>
<div class="line"><code class="plain">RA Name Generation Prefix : cmp</code></div>
<div class="line"><code class="plain">RA End Entity Profile : CMP_ENTITY</code></div>
<div class="line"><code class="plain">RA Certificate Profile : CMP_CERT</code></div>
<div class="line"><code class="plain">RA CA Name : ManagementCA</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-Using_one_authentication_secret_per_CAUsingoneauthenticationsecretperCA">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Using_one_authentication_secret_per_CA" class="confluence-anchor-link"></span><span>Using one authentication secret per CA</span></h2>
<p   
>Edit each CAs that should be used for CMP certificate issuance and enter new CMP RA Authentication Secret. There should be no parameter specified for the HMAC authentication module, otherwise, this parameter will override the CA specific configuration.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtS2V5VXBkYXRlUmVxdWVzdChrdXIpS2V5X1VwZGF0ZV9SZXF1ZXN0">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Key_Update_Request" class="confluence-anchor-link"></span><span>Key Update Request (kur) </span></h1>
<p   
>Also known as the Certificate Update request. When a key pair is due to expire, the relevant end entity may request a key update. The CMP request is signed, and the sender attaches their certificate in the extraCert field in the CMP message.</p>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-In_Client_ModeInClientMode">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-In_Client_Mode" class="confluence-anchor-link"></span><span>In Client Mode</span></h2>
<p   
>In client mode, the only end entity that is allowed to send a KeyUpdate request is the end entity that owns the certificate to be renewed. This end entity should be the one signing the request and attaching its &quot;old&quot; certificate (that has not been expired yet) to the CMP message. The CA will only look into the certificate in extraCert to find which certificate is to be updated.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-In_RA_ModeInRAMode">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-In_RA_Mode" class="confluence-anchor-link"></span><span>In RA Mode</span></h2>
<p   
>In RA mode, an administrator is allowed to send a KeyUpdate request on behalf of an end entity. The adminstrator should be the one signing the request and attaching his own certificate to the CMP message. Either only the subjectDN or both the subjectDN and the issuerDN of the certificate to be updated are specified in the CertificateTemplate field in the CMP message.</p>
<p   
>In order for this request to succeed, the administrator sending the update request has to be authorized to perform this operation. Also, EndEntityCertificate authentication module would have to be set among the configured authentication modules.</p>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-ProofofPossessionProof_of_possession">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Proof_of_possession" class="confluence-anchor-link"></span><span>Proof of Possession </span></h1>
<p   
>Proof of Possession (POP) is another part where CMP has numerous of options. The following POPs in the CRMF are supported by EJBCA:</p>
<ul class=" "><li class=" "><p   
>raVerify: If <strong class=" ">Allow RA Verify Proof-of-Possession</strong> is selected, EJBCA will support the raVerify POP and in that case not do any verification of POP. By default false, because the standard does not recommend this option.</p>
</li><li class=" "><p   
>signature: here the PublicKey is in the CertTemplate and the signature is calculated over the CertReqMsg.certReq (the standard procedure when the CertTemplate contains the subject and publicKey values).</p>
</li><li class=" "><p   
>signature with POPOSigningKeyInput: here the PublicKey and subject DN is in POPOSigningKeyInput, possibly just copied from the CertTemplate. The signature is calculated over the POPOSigningKeyInput (if the values are also in the CertTemplate they must be identical).</p>
</li></ul><p   
>Currently these are the POPOs supported by EJBCA, so if you do not use raVerify or signature your request will fail because POPO is not verified.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-ServerGeneratedKeysServer_Generated_Keys">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Server_Generated_Keys" class="confluence-anchor-link"></span><span>Server Generated Keys </span></h1>
<p   
>CMP allows clients to request server generated keys, using one of the following in the CRMF certificate request:</p>
<ul class=" "><li class=" "><p   
>Leaving out the (optional) request public key in the CRMF request.</p>
</li><li class=" "><p   
>Adding a subjectPublicKeyInfo containing an AlgorithmIdentifier followed by a zero-length BIT STRING for the subjectPublicKey (RFC4210 Appendix D.4).</p>
</li></ul><p   
>These options enable a large number of choices and taking into consideration that the server wants to restrict what type of keys the clients can request and certify, there are a number of rather strict rules and business logic used by EJBCA. The following list highlights these choices.</p>
<p   
>Note that the following only applies if server generated keys are enabled in the CMP alias configuration. Use of server generated keys are by default disabled, and the default behavior is thus that all request for server generated keys are denied.</p>
<ul class=" "><li class=" "><p   
>If the request does not contain a request public key, key generation options are taken from the certificate profile that will be used to issue the certificate:</p>
<ul class=" "><li class=" "><p   
>The certificate profile must contain only one allowed key algorithm and one allowed key specification, for example <strong class=" ">RSA 1024</strong> or <strong class=" ">ECDSA secp256r1</strong>.</p>
</li><li class=" "><p   
>If there is not a single distinct choice, the request will be denied, and an error returned to the client.</p>
</li></ul></li><li class=" "><p   
>If the certificate profile contains a subjectPublicKeyInfo with the RSA algorithmId (rsaEncryption = 1.2.840.113549.1.1.1) the certificate profile must contain a single choice of key sizes allowed.</p>
<ul class=" "><li class=" "><p   
>If there is not a single distinct choice, the request will be denied</p>
</li></ul></li><li class=" "><p   
>If the certificate profile contains a subjectPublicKeyInfo with the ECDSA algorithmId (id_ecPublicKey = 1.2.840.10045.2.1), the subjectPublicKeyInfo must contain parameters where two choices are allowed:</p>
<ul class=" "><li class=" "><p   
>implicitlyCA: The certificate profile must contain a single choice of curves allowed, otherwise the request will be denied.</p>
</li><li class=" "><p   
>namedCurve: With the OID of a supported named curve, which is among the allowed curves in the certificate profile.</p>
</li></ul></li></ul><p   
>These rules allow the CA administrator to control what server generated keys the CA will generate and return to the client, and can be summarized as:</p>
<ul class=" "><li class=" "><p   
>A distinct choice of a single key algorithm and key size/curve, defined in the certificate profile.</p>
</li><li class=" "><p   
>A choice of a single RSA key size and a set of EC curves, defined in the certificate profile and selected by the client in the request.</p>
</li></ul><p   
>Currently, RSA and EC keys are supported.</p>
    <div  class="confbox admonition admonition-note">
                            <span class="admonition-icon confluence-information-macro-icon"></span>
                <div class="admonition-body">
<p   
>In order to support server generated, the client <strong class=" ">must</strong> include a id_regCtrl_protocolEncrKey in the request, containing a public key that the server will use to encrypt the private key returned in the response.</p>
        </div>
    </div>
<p   
>Server generated keys are returned in the CertifiedKeyPair.privateKey field in the response, as defined in the RFC4210 sections 5.3.4 and D.4. The EncryptedValue will contain the private key, encrypted using AES256 with a random symmetric key, in turn wrapped using the public key in id_regCtrl_protocolEncrKey (RFC4211 Appendix B have more details on the EncryptedValue).</p>
<p   
>Code example in Java for requesting server generated keys can be found in the test method CrmfRequestTest.test12ServerGeneratedKeys().</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CertificateValidityCertificate_validity">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Certificate_validity" class="confluence-anchor-link"></span><span>Certificate Validity </span></h1>
<p   
>Generally, the validity period of issued certificates is controlled by the certificate profile. If you enable <strong class=" ">Allow validity override</strong> in the certificate profile, and the CMP initialization- or certification request contains a validity time in the CRMF request template, this validity period will be used.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CertificateKeyUsageCertificate_Key_Usage">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Certificate_Key_Usage" class="confluence-anchor-link"></span><span>Certificate Key Usage </span></h1>
<p   
>Generally, the key usage extension of issued certificates are controlled by the certificate profile. If you enable <strong class=" ">Allow Key Usage Override</strong> in the certificate profile, and the CMP initialization- or certification request contains a key usage in the CRMF request template, this key usage will be used.</p>
    </div>
    <div class="section section-1" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtSW50ZXJvcGVyYWJpbGl0eS9UZXN0ZWRMaWJyYXJpZXNhbmREZXZpY2VzSW50ZXJvcGVyYWJpbGl0eQ">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Interoperability" class="confluence-anchor-link"></span><span>Interoperability / Tested Libraries and Devices </span></h1>
    <div class="section section-2" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtRUpCQ0FjbXBjbGllbnRFSkJDQV9jbXBjbGllbnRfKEVudGVycHJpc2Vfb25seSk">
        <h2 class="heading "><span id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtRUpCQ0FfY21wY2xpZW50XyhFbnRlcnByaXNlX29ubHkp" class="confluence-anchor-link"></span><span>EJBCA cmpclient </span></h2>
<p   
></p>
<p   
><span class="status blue " >ENTERPRISE</span>
 This is an EJBCA Enterprise feature.</p>
<p   
>EJBCA Enterprise includes a java command line client for CMP, used to request, renew and revoke certificates.</p>
<p   
>To build and run the cmpclient client, use the following:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ant cmpclient</code></div>
<div class="line"><code class="plain">cd dist/cmpclient</code></div>
<div class="line"><code class="plain">java -jar cmpclient.jar</code></div>
<div class="line"><code class="plain">java -jar cmpclient.jar crmf --help</code></div>
</div>
    </div>
<p   
>An example workflow when you have one CMP alias in RA mode (raalias), using password based authentication of the RA, and another CMP alias (clientupdate) in client mode allowing updates using certificate authentication.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">java -jar cmpclient.jar crmf --dn "CN=tomas" --url </code><code class="comments">http://192.168.122.230:8080/cmpProxy/raalias</code><code class="plain"> --authparam password --reqnewkeyspec RSA2048</code></div>
<div class="line"><code class="plain">openssl pkcs12 -export -inkey dest/tomas-key.pem -in /dest/tomas.pem -certfile ManagementCA.cacert.pem -name tomas -out dest/tomas.p12</code></div>
<div class="line"><code class="plain">java -jar cmpclient.jar update --dn "CN=tomas" --url </code><code class="comments">http://192.168.122.230:8080/cmpProxy/clientupdate</code><code class="plain"> --keystore dest/tomas.p12 --keystorepwd foo123 --extraCertsFriendlyName tomas --includepopo --reqnewkeyspec RSA2048</code></div>
<div class="line"><code class="plain">openssl x509 -in dest/tomas.pem -text</code></div>
<div class="line"><code class="plain">java -jar cmpclient.jar revoke --issuer "CN=ManagementCA,O=EJBCA Sample,C=SE" --serno 17b9a7b8ce44b3fa --url </code><code class="comments">http://192.168.122.230:8080/cmpProxy/raalias</code><code class="plain"> --authparam password</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-AET_BlueXAETBlueX">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-AET_BlueX" class="confluence-anchor-link"></span><span>AET BlueX</span></h2>
<p   
>CMP has been tested with BlueX from <a  class="external-link" href="http://www.aeteurope.nl/">AET Europe</a>. From EJBCA's point of view BlueX functions as an RA with the same configuration options as for jCert.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-AventraAventra">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Aventra" class="confluence-anchor-link"></span><span>Aventra</span></h2>
<p   
>CMP has been tested with <a  class="external-link" href="http://aventra.fi/English">Aventra</a> card management system. Same configuration as above.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-BouncyCastleBouncyCastle">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-BouncyCastle" class="confluence-anchor-link"></span><span>BouncyCastle</span></h2>
<p   
>CMP has been tested with <a  class="external-link" href="http://www.bouncycastle.org">BouncyCastle</a> CMP classes, available in BC 1.46 or later. Both client and RA mode should work.</p>
    <div class="page-break"></div><p   
>Sample code for a HMAC protected (RA mode) certificate request (initial) message:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">// Just preparations</code></div>
<div class="line"><code class="plain">final BigInteger certReqId = BigInteger.valueOf(1);</code></div>
<div class="line"><code class="plain">final byte[] senderNonce = "12345".getBytes();</code></div>
<div class="line"><code class="plain">final byte[] transactionId = "23456".getBytes();</code></div>
<div class="line"><code class="plain">KeyPairGenerator kpi = KeyPairGenerator.getInstance("RSA");</code></div>
<div class="line"><code class="plain">kpi.initialize(1024);</code></div>
<div class="line"><code class="plain">KeyPair keyPair = kpi.generateKeyPair();</code></div>
<div class="line"><code class="plain">// Now on to the CMP </code></div>
<div class="line"><code class="plain">CertificateRequestMessageBuilder msgbuilder = new CertificateRequestMessageBuilder(certReqId);</code></div>
<div class="line"><code class="plain">X500Name issuerDN = new X500Name("CN=ManagementCA");</code></div>
<div class="line"><code class="plain">X500Name subjectDN = new X500Name("CN=user");</code></div>
<div class="line"><code class="plain">msgbuilder.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setSubject(subjectDN);</code></div>
<div class="line"><code class="plain">final byte[]                  bytes = keyPair.getPublic().getEncoded();</code></div>
<div class="line"><code class="plain">final ByteArrayInputStream    bIn = new ByteArrayInputStream(bytes);</code></div>
<div class="line"><code class="plain">final ASN1InputStream         dIn = new ASN1InputStream(bIn);</code></div>
<div class="line"><code class="plain">final SubjectPublicKeyInfo keyInfo = new SubjectPublicKeyInfo((ASN1Sequence)dIn.readObject());</code></div>
<div class="line"><code class="plain">dIn.close();</code></div>
<div class="line"><code class="plain">msgbuilder.setPublicKey(keyInfo);</code></div>
<div class="line"><code class="plain">GeneralName sender = new GeneralName(subjectDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setAuthInfoSender(sender);</code></div>
<div class="line"><code class="plain">// RAVerified POP</code></div>
<div class="line"><code class="plain">msgbuilder.setProofOfPossessionRaVerified();</code></div>
<div class="line"><code class="plain">CertificateRequestMessage msg = msgbuilder.build();</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.crmf.CertReqMessages msgs = new org.bouncycastle.asn1.crmf.CertReqMessages(msg.toASN1Structure());</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.cmp.PKIBody pkibody = new org.bouncycastle.asn1.cmp.PKIBody(org.bouncycastle.asn1.cmp.PKIBody.TYPE_INIT_REQ, msgs);</code></div>
<div class="line"><code class="plain">// Message protection and final message</code></div>
<div class="line"><code class="plain">GeneralName recipient = new GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = new ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(new Date());</code></div>
<div class="line"><code class="plain">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="plain">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="plain">// Key Id used (required) by the recipient to do a lot of stuff</code></div>
<div class="line"><code class="plain">pbuilder.setSenderKID("KeyID".getBytes());</code></div>
<div class="line"><code class="plain">pbuilder.setBody(pkibody);</code></div>
<div class="line"><code class="plain">JcePKMACValuesCalculator jcePkmacCalc = new JcePKMACValuesCalculator();</code></div>
<div class="line"><code class="plain">final AlgorithmIdentifier digAlg = new AlgorithmIdentifier(new ASN1ObjectIdentifier("1.3.14.3.2.26")); // SHA1</code></div>
<div class="line"><code class="plain">final AlgorithmIdentifier macAlg = new AlgorithmIdentifier(new ASN1ObjectIdentifier("1.2.840.113549.2.7")); // HMAC/SHA1</code></div>
<div class="line"><code class="plain">jcePkmacCalc.setup(digAlg, macAlg);</code></div>
<div class="line"><code class="plain">PKMACBuilder macbuilder = new PKMACBuilder(jcePkmacCalc);</code></div>
<div class="line"><code class="plain">MacCalculator macCalculator = macbuilder.build("password".toCharArray());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(macCalculator);</code></div>
</div>
    </div>
<p   
>Sample code for a HMAC protected (RA mode) revocation request message:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">// Just preparations</code></div>
<div class="line"><code class="plain">final byte[] senderNonce = "12345".getBytes();</code></div>
<div class="line"><code class="plain">final byte[] transactionId = "23456".getBytes();</code></div>
<div class="line"><code class="plain">BigInteger serNo = new BigInteger("aabbccdd");</code></div>
<div class="line"><code class="plain">X500Name issuerDN = new X500Name("CN=ManagementCA");</code></div>
<div class="line"><code class="plain">X500Name userDN = new X500Name("CN=user");</code></div>
<div class="line"><code class="plain">// Cert template too tell which cert we want to revoke</code></div>
<div class="line"><code class="plain">CertTemplateBuilder myCertTemplate = new CertTemplateBuilder();</code></div>
<div class="line"><code class="plain">myCertTemplate.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">myCertTemplate.setSubject(userDN);</code></div>
<div class="line"><code class="plain">myCertTemplate.setSerialNumber(new ASN1Integer(serNo));</code></div>
<div class="line"><code class="plain">// Extension telling revocation reason</code></div>
<div class="line"><code class="plain">ExtensionsGenerator extgen = new ExtensionsGenerator();</code></div>
<div class="line"><code class="plain">CRLReason crlReason = CRLReason.lookup(CRLReason.cessationOfOperation);</code></div>
<div class="line"><code class="plain">extgen.addExtension(Extension.reasonCode, false, crlReason);        </code></div>
<div class="line"><code class="plain">Extensions exts = extgen.generate();</code></div>
<div class="line"><code class="plain">ASN1EncodableVector v = new ASN1EncodableVector();</code></div>
<div class="line"><code class="plain">v.add(myCertTemplate.build());</code></div>
<div class="line"><code class="plain">v.add(exts);</code></div>
<div class="line"><code class="plain">ASN1Sequence seq = new DERSequence(v);</code></div>
<div class="line"><code class="plain">RevDetails myRevDetails = RevDetails.getInstance(seq);</code></div>
<div class="line"><code class="plain">RevReqContent myRevReqContent = new RevReqContent(myRevDetails);</code></div>
<div class="line"><code class="plain">PKIBody myPKIBody = new PKIBody(PKIBody.TYPE_REVOCATION_REQ, myRevReqContent); // revocation request</code></div>
<div class="line"><code class="plain">// Message protection and final message</code></div>
<div class="line"><code class="plain">GeneralName sender = new GeneralName(userDN);</code></div>
<div class="line"><code class="plain">GeneralName recipient = new GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = new ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(new Date());</code></div>
<div class="line"><code class="plain">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="plain">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="plain">// Key Id used (required) by the recipient to do a lot of stuff</code></div>
<div class="line"><code class="plain">pbuilder.setSenderKID("KeyId".getBytes());</code></div>
<div class="line"><code class="plain">pbuilder.setBody(myPKIBody);</code></div>
<div class="line"><code class="plain">JcePKMACValuesCalculator jcePkmacCalc = new JcePKMACValuesCalculator();</code></div>
<div class="line"><code class="plain">final AlgorithmIdentifier digAlg = new AlgorithmIdentifier(new ASN1ObjectIdentifier("1.3.14.3.2.26")); // SHA1</code></div>
<div class="line"><code class="plain">final AlgorithmIdentifier macAlg = new AlgorithmIdentifier(new ASN1ObjectIdentifier("1.2.840.113549.2.7")); // HMAC/SHA1</code></div>
<div class="line"><code class="plain">jcePkmacCalc.setup(digAlg, macAlg);</code></div>
<div class="line"><code class="plain">PKMACBuilder macbuilder = new PKMACBuilder(jcePkmacCalc);</code></div>
<div class="line"><code class="plain">MacCalculator macCalculator = macbuilder.build("password".toCharArray());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(macCalculator);</code></div>
</div>
    </div>
<p   
>Sample code for a signature protected (Client mode) message:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CertificateRequestMessageBuilder msgbuilder = new CertificateRequestMessageBuilder(BigInteger.valueOf(certReqId));</code></div>
<div class="line"><code class="plain">X509NameEntryConverter dnconverter = new X509DefaultEntryConverter();</code></div>
<div class="line"><code class="plain">X500Name issuerDN = X500Name.getInstance(new X509Name("CN=ManagementCA").toASN1Object());</code></div>
<div class="line"><code class="plain">X500Name subjectDN = X500Name.getInstance(new X509Name("CN=user", dnconverter).toASN1Object());</code></div>
<div class="line"><code class="plain">msgbuilder.setIssuer(issuerDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setSubject(subjectDN);</code></div>
<div class="line"><code class="plain">final byte[]                  bytes = keyPair.getPublic().getEncoded();</code></div>
<div class="line"><code class="plain">final ByteArrayInputStream    bIn = new ByteArrayInputStream(bytes);</code></div>
<div class="line"><code class="plain">final ASN1InputStream         dIn = new ASN1InputStream(bIn);</code></div>
<div class="line"><code class="plain">final SubjectPublicKeyInfo keyInfo = new SubjectPublicKeyInfo((ASN1Sequence)dIn.readObject());</code></div>
<div class="line"><code class="plain">msgbuilder.setPublicKey(keyInfo);</code></div>
<div class="line"><code class="plain">GeneralName sender = new GeneralName(subjectDN);</code></div>
<div class="line"><code class="plain">msgbuilder.setAuthInfoSender(sender);</code></div>
<div class="line"><code class="plain">Control control = new RegTokenControl("foo123");</code></div>
<div class="line"><code class="plain">msgbuilder.addControl(control);</code></div>
<div class="line"><code class="plain">Provider prov = Security.getProvider(BouncyCastleProvider.PROVIDER_NAME);</code></div>
<div class="line"><code class="plain">ContentSigner popsigner = new JcaContentSignerBuilder("SHA1withRSA").setProvider(prov).build(keyPair.getPrivate());</code></div>
<div class="line"><code class="plain">msgbuilder.setProofOfPossessionSigningKeySigner(popsigner);</code></div>
<div class="line"><code class="plain">CertificateRequestMessage msg = msgbuilder.build();</code></div>
<div class="line"><code class="plain">GeneralName recipient = new GeneralName(issuerDN);</code></div>
<div class="line"><code class="plain">ProtectedPKIMessageBuilder pbuilder = new ProtectedPKIMessageBuilder(sender, recipient);</code></div>
<div class="line"><code class="plain">pbuilder.setMessageTime(new Date());</code></div>
<div class="line"><code class="plain">// senderNonce</code></div>
<div class="line"><code class="plain">pbuilder.setSenderNonce(senderNonce);</code></div>
<div class="line"><code class="plain">// TransactionId</code></div>
<div class="line"><code class="plain">pbuilder.setTransactionID(transactionId);</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.crmf.CertReqMessages msgs = new org.bouncycastle.asn1.crmf.CertReqMessages(msg.toASN1Structure());</code></div>
<div class="line"><code class="plain">org.bouncycastle.asn1.cmp.PKIBody pkibody = new org.bouncycastle.asn1.cmp.PKIBody(org.bouncycastle.asn1.cmp.PKIBody.TYPE_INIT_REQ, msgs);</code></div>
<div class="line"><code class="plain">pbuilder.setBody(pkibody);</code></div>
<div class="line"><code class="plain">ContentSigner msgsigner = new JcaContentSignerBuilder("SHA1withRSA").setProvider(prov).build(keyPair.getPrivate());</code></div>
<div class="line"><code class="plain">ProtectedPKIMessage message = pbuilder.build(msgsigner);</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-CMPforOpenSSLCMP_for_OpenSSL">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_for_OpenSSL" class="confluence-anchor-link"></span><span>CMP for OpenSSL </span></h2>
<p   
>CMP has been tested with cmpforopenssl. Cmpforopenssl is submitted for inclusion in OpenSSL and the code is available on GitHub on <a  class="external-link" href="https://github.com/mpeylo/cmpossl">https://github.com/mpeylo/cmpossl</a>. For documentation for the command, refer to <a  class="external-link" href="https://github.com/mpeylo/cmpossl/blob/cmp/doc/man1/cmp.pod">https://github.com/mpeylo/cmpossl/blob/cmp/doc/man1/cmp.pod</a> and for a Quick Start guide, tested with EJBCA, refer to <a  class="external-link" href="https://github.com/mpeylo/cmpossl/wiki/Quick-Start">https://github.com/mpeylo/cmpossl/wiki/Quick-Start</a>.</p>
<p   
>The old client tool in cmpforopenssl was called <strong class=" ">cmpclient,</strong> while the new one is in the <strong class=" ">openssl</strong> command itself. Only the new one is documented here. It works with EJBCA CMP in both RA mode and client mode.</p>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-RAMode">
        <h3 class="heading "><span>RA Mode</span></h3>
<p   
>Cmpforopenssl works with EJBCA in RA mode with the following EJBCA configuration, using for example alias &quot;opensslra&quot; (unmentioned configurations = default):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Operational Mode : RA Mode</code></div>
<div class="line"><code class="plain">CMP Response Protection : pbe</code></div>
<div class="line"><code class="plain">CMP Authentication Module : HMAC</code></div>
<div class="line"><code class="plain">CMP Authentication Parameters : password</code></div>
</div>
    </div>
<p   
>You can then use cmpforopenssl (as an RA):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">./openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/opensslra -srvcert ManagementCA.cacert.pem -ref NewUser -secret password -certout clcert1.pem -newkey key1.pem -keyfmt PEM -certfmt PEM -subject "/CN=NewUser/O=My Organization/C=SE"</code></div>
</div>
    </div>
<p   
>This requests a certificate, defining the subject DN that will be used. The CA used to sign the certificate is specified in the EJBCA cmp configuration, and can be taken from the keyid. EJBCA authenticated the request using the HMAC protection with the password, and accepts any request upon correct authentication.</p>
<p   
><strong class=" ">RA Mode, Server Generated Keys</strong></p>
<p   
>You can request server generated keys by omitting the public key in the certificate request, using the same request as an ir, but without public key. Note however that the cmpclient cannot be used since no cmpclient parameters support omitting the public key. For example Java code, refer to the test class CrmfRequestTest.test12ServerGeneratedKeys().</p>
    </div>
    <div class="section section-3" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ2xpZW50TW9kZSxITUFDUGFzc3dvcmRBdXRoZW50aWNhdGlvbg">
        <h3 class="heading "><span>Client Mode, HMAC Password Authentication</span></h3>
<p   
>Cmpforopenssl works with with EJBCA in client mode, with HMAC password authentication, using the following EJBCA configuration with for example the alias &quot;opensslclient&quot; (unmentioned configurations = default):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Authentication Module : HMAC</code></div>
<div class="line"><code class="plain">CMP Authentication Parameters : password</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
</div>
    </div>
<p   
>You can now add a new user in EJBCA:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin/ejbca.sh ra addendentity user1 --password password "CN=user1,O=My Organization,C=SE" ManagementCA 1 USERGENERATED</code></div>
<div class="line"><code class="plain">bin/ejbca.sh ra setclearpwd user1 password</code></div>
<div class="line"><code class="plain">bin/ejbca.sh ra setendentitystatus user1 10</code></div>
</div>
    </div>
<p   
>You can then use cmpforopenssl (as a client):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">./openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/opensslclient -srvcert ManagementCA.cacert.pem -ref user1 -secret password -certout clcert1.pem -newkey key1.pem -keyfmt PEM -certfmt PEM -subject "/CN=user1/O=My Organization/C=SE"</code></div>
</div>
    </div>
<p   
>This requests a certificate, and the requested subject DN must match the registered subject DN. EJBCA authenticates the request using the HMAC protection with the password of the registered user. See the CMP documentation above for more advanced configuration.</p>
    </div>
    <div class="section section-3" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ2xpZW50TW9kZSxDbGllbnRDZXJ0aWZpY2F0ZUF1dGhlbnRpY2F0aW9u">
        <h3 class="heading "><span>Client Mode, Client Certificate Authentication</span></h3>
<p   
>Cmpforopenssl works with with EJBCA in client mode, with certificate authentication, using the following EJBCA configuration with alias tex. &quot;openssleec&quot; (unmentioned configurations = default):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Authentication Module : EndEntityCertificate</code></div>
<div class="line"><code class="plain">CMP Authentication Parameters : ManagementCA (use the CA that issues your client authentication certificate)</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
</div>
    </div>
<p   
>You can now issue a certificate using certificate authentication in EJBCA (the end entity needs a certificate before so we re-use user1 from above):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin/ejbca.sh ra setclearpwd user1 password</code></div>
<div class="line"><code class="plain">bin/ejbca.sh ra setendentitystatus user1 10</code></div>
</div>
    </div>
<p   
>You can then use cmpforopenssl (as a client):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">./openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/openssleec -srvcert ManagementCA.cacert.pem -cert clcert.pem -key key.pem -certout clcert1.pem -newkey key1.pem -keyfmt PEM -certfmt PEM -subject "/CN=user1/O=My Organization/C=SE"</code></div>
</div>
    </div>
<p   
>This requests a certificate, and the requested subject DN must match the registered subject DN. EJBCA authenticates the request using the signature protection with the certificate of the registered user. See the CMP documentation above for more advanced configuration.</p>
<p   
>You can also use a 'cr' instead of an 'ir';</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin/ejbca.sh ra setendentitystatus user1 10</code></div>
<div class="line"><code class="plain">./openssl cmp -cmd cr -server localhost:8080 -path ejbca/publicweb/cmp/openssleec -srvcert ManagementCA.cacert.pem -cert clcert.pem -key key.pem -certout clcert1.pem -newkey key1.pem -keyfmt PEM -certfmt PEM -subject "/CN=user1/O=My Organization/C=SE"</code></div>
</div>
    </div>
    </div>
    <div class="section section-3" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ2xpZW50TW9kZSxWZW5kb3JDZXJ0aWZpY2F0ZUF1dGhlbnRpY2F0aW9u">
        <h3 class="heading "><span>Client Mode, Vendor Certificate Authentication </span></h3>
<p   
></p>
<p   
><span class="status blue " >ENTERPRISE</span>
 This is an EJBCA Enterprise feature.</p>
<p   
>If the end entity has a Vendor certificate with which it should identify itself for initial enrollment, as specified in 3GPP for example, it can also do that. In this case the CA issuing the end entity certificate is not the same as the Vendor CA. The vendor CA must be imported in EJBCA as an External CA (<strong class=" ">Admin GUI&gt;Import CA certificate</strong>). To enable vendor certificate authentication, add the following to the CMP configuration with alias tex. &quot;3gpp&quot; for client certificate authentication:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Use Vendor Certificate Mode : checked</code></div>
<div class="line"><code class="plain">Vendor CA : 3GPP-CA</code></div>
</div>
    </div>
<p   
>With this configuration you can now request an initial certificate with the following command:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">./openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/3gpp -srvcert ManagementCA.cacert.pem -cert devicecert.pem -key devicekey.pem -certout clcert1.pem -newkey key1.pem -keyfmt PEM -certfmt PEM -subject "/CN=device/O=My Organization/C=SE"</code></div>
</div>
    </div>
<p   
>In this configuration 'devicecert.pem' and 'devicekey.pem' are the device's private key and the certificate issued by the Vendor CA (3GPP-CA). ManagementCA.cacert.pem is the CA certificate of the CA in EJBCA issuing the new certificate for the device.<br/>It is possible to specify more than one vendor CA. The vendor CA names should, in this case, be separated by ';'.</p>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-Cryptlib">
        <h2 class="heading "><span>Cryptlib</span></h2>
<p   
>CMP has been tested with <a  class="external-link" href="http://www.cryptlib.com/">CryptLib</a>. An old test program for running CryptLib against EJBCA can be downloaded from <a  class="external-link" href="https://download.primekey.com/ejbca/tests/ejbcaCryptLibTest.zip">download.primekey.com</a>.</p>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-HuaweiPico3GPP">
        <h2 class="heading "><span>Huawei Pico 3GPP</span></h2>
<p   
>The Huawei Pico cell is confirmed to successfully receive operator certificates using CMPv2.</p>
<p   
>In order to authenticate the Pico cell for initial enrollment the Huawei Vendor CA must be imported in EJBCA. Go to Certificate Authorities in the Admin GUI and import Huawei Equipment Root CA as External Certificate Authority by clicking <strong class=" ">Import CA Certificate</strong>.</p>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-CMPAliasSettings">
        <h3 class="heading "><span>CMP Alias Settings</span></h3>
<ul class=" "><li class=" "><p   
>CMP Operational Mode - Client</p>
</li><li class=" "><p   
>CMP Authentication Module - EndEntityCertificate only</p>
</li><li class=" "><p   
>Extract Username Component - CN</p>
</li><li class=" "><p   
>Vendor Certificate Mode - Use</p>
</li><li class=" "><p   
>List Of Vendor CAs - Huawei Equipment Root CA</p>
</li><li class=" "><p   
>CMP Response Protection - Signature</p>
</li><li class=" "><p   
>CMP Response Additional CA certificates - Leave blank</p>
</li><li class=" "><p   
>PKI Message Response Additional CA certificates - Leave blank</p>
</li><li class=" "><p   
>Certificate Confirmation Default CA - Use whatever CA is configure in the End Entity</p>
</li><li class=" "><p   
>Automatic Key Update - Checked</p>
</li><li class=" "><p   
>Certificate renewal with same keys - Checked</p>
</li><li class=" "><p   
>Allow Server Generated Keys - Unchecked</p>
</li><li class=" "><p   
>Nested Message Trusted Certificates Path - Leave blank</p>
</li></ul>    </div>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-EndEntityProfileSettings">
        <h3 class="heading "><span>End Entity Profile Settings</span></h3>
<ul class=" "><li class=" "><p   
>Batch Generation - Use</p>
</li><li class=" "><p   
>Subject DN Attributes, CN - Required</p>
</li><li class=" "><p   
>Default and Available Certificate Profiles - Set to your CMP Certificate profile</p>
</li><li class=" "><p   
>Default and Available CAs - Set to the Issuing CA that you have set in CMP Certificate Confirmation Default CA</p>
</li><li class=" "><p   
>Default Token - User Generated</p>
</li></ul>    </div>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-CertificateProfileSettings">
        <h3 class="heading "><span>Certificate Profile Settings</span></h3>
<ul class=" "><li class=" "><p   
>Available CAs - Set to the Issuing CA that you have set in CMP Certificate Confirmation Default CA</p>
</li></ul>    </div>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-Apacheconfiguration">
        <h3 class="heading "><span>Apache configuration</span></h3>
<p   
>Certain Pico devices do not allow for a URL to a CMP host. If this is the case, we recommend running apache in front of the EJBCA JBoss/WildFly application server. You can add in this configuration to an Apache to have it redirect to the EJBCA CMP URL.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Listen </code><code class="value">8080</code></div>
<div class="line"><code class="plain">&lt;VirtualHost *:</code><code class="value">8080</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">    DocumentRoot /var/www/html/</code></div>
<div class="line"><code class="plain">    # Disallow any HTTP method that is not HEAD, GET or POST</code></div>
<div class="line"><code class="plain">    RewriteEngine On</code></div>
<div class="line"><code class="plain">    RewriteCond %{REQUEST_METHOD} !^(HEAD|GET|POST)$ [NC]</code></div>
<div class="line"><code class="plain">    RewriteRule .* - [F,L]</code></div>
<div class="line"><code class="plain">    #Since we are adding an additional port we can redirect all traffic to the CMP alias</code></div>
<div class="line"><code class="plain">    ProxyPass </code><code class="string">"/"</code><code class="plain">      </code><code class="string">"ajp://localhost/ejbca/publicweb/cmp/3gpp"</code><code class="plain"> keepalive=On ping=500ms retry=</code><code class="value">1</code><code class="plain"> timeout=</code><code class="value">300</code></div>
<div class="line"><code class="plain">    ProxyPassReverse </code><code class="string">"/"</code><code class="plain"> </code><code class="string">"ajp://localhost/ejbca/publicweb/cmp/3gpp"</code></div>
<div class="line"><code class="plain">&lt;/VirtualHost&gt;</code></div>
</div>
    </div>
<p   
></p>
    </div>
    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-RSAjCertRSA_jCert">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-RSA_jCert" class="confluence-anchor-link"></span><span>RSA jCert </span></h2>
<p   
>CMP has been tested using RSA jCert toolkit for initialization requests. To run this as an RA you should configure CMP with:</p>
<ul class=" "><li class=" "><p   
>CMP Operational Mode : RA Mode</p>
</li><li class=" "><p   
>Allow RA Verify Proof-of-Possession : check</p>
</li><li class=" "><p   
>CMP Response Protection : pbe</p>
</li><li class=" "><p   
>CMP Authentication Module : HMAC</p>
</li><li class=" "><p   
>CMP Authentication Parameters : your shared password</p>
</li><li class=" "><p   
>and other configurations you want for your RA.</p>
</li></ul>    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-SampleCMPworkflowSample_CMP_workflow">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Sample_CMP_workflow" class="confluence-anchor-link"></span><span>Sample CMP workflow </span></h1>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-EnrollingDevicewithHMACpassword">
        <h2 class="heading "><span>Enrolling Device with HMAC password</span></h2>
<p   
>A typical PKI work-flow using CMP involves enrolling a device with a certificate and then having the device automatically renew the certificate when it is about to expire.</p>
<ol class=" "><li class=" "><p   
>Generate a key pair</p>
</li><li class=" "><p   
>Initial enrollment of client certificate using a one-time enrollment code</p>
</li><li class=" "><p   
>Generate a new key pair</p>
</li><li class=" "><p   
>Renew with a new certificate for the new key pair, authenticated using the old key pair and certificate</p>
</li></ol><p   
>The above steps can be simulated in reality using the <i class=" ">openssl</i> and <i class=" ">cmpforopenssl</i> client, but also using the <a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtI0VKQkNBX2NtcGNsaWVudF8oRW50ZXJwcmlzZV9vbmx5KQ">EJBCA cmpclient</a>.</p>
<p   
>This works with a default cmpalias (named cmp) configured with parameters:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Authentication Module : HMAC</code></div>
<div class="line"><code class="plain">CMP Authentication Parameters : password</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
</div>
    </div>
<p   
></p>
<ol class=" "><li class=" "><p   
>Generate a key pair:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/cl_key.pem 2048 </code></div>
</div>
    </div>
</li><li class=" "><p   
>Initial enrollment:<br/>Before initial enrollment you add a new End Entity in EJBCA, in this example with user name cmptest and subject DN 'CN=cmptest', and enrollment code 'CMP-pwd'.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl cmp -cmd ir \</code></div>
<div class="line"><code class="plain">           -server ejbca-server:8080 \</code></div>
<div class="line"><code class="plain">           -path ejbca/publicweb/cmp \</code></div>
<div class="line"><code class="plain">           -srvcert certs/3GPPCA.pem \</code></div>
<div class="line"><code class="plain">           -user cmptest \</code></div>
<div class="line"><code class="plain">           -pass CMP-pwd \</code></div>
<div class="line"><code class="plain">           -newkey certs/cl_key.pem \</code></div>
<div class="line"><code class="plain">           -certout certs/cl_cert.pem \</code></div>
<div class="line"><code class="plain">           -subject "/CN=cmptest" </code></div>
</div>
    </div>
</li><li class=" "><p   
>Generate a new key pair:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/cl_new_key.pem 2048</code></div>
</div>
    </div>
</li><li class=" "><p   
>Renew with a new certificate:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl cmp -cmd kur \</code></div>
<div class="line"><code class="plain">           -server ejbca-server:8080 \</code></div>
<div class="line"><code class="plain">           -path ejbca/publicweb/cmp \</code></div>
<div class="line"><code class="plain">           -srvcert certs/3GPPCA.pem \</code></div>
<div class="line"><code class="plain">           -key certs/cl_key.pem \</code></div>
<div class="line"><code class="plain">           -cert certs/cl_cert.pem \</code></div>
<div class="line"><code class="plain">           -newkey certs/cl_new_key.pem \</code></div>
<div class="line"><code class="plain">           -certout certs/cl_new_cert.pem </code></div>
</div>
    </div>
</li></ol>    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-EnrollingDevicewithVendorCertificate">
        <h2 class="heading "><span>Enrolling Device with Vendor Certificate</span></h2>
<p   
>A PKI work-flow as specified in the 3GPP standard uses CMP to enroll a device, authenticating the initial request using a Vendor certificate added to the device at manufacturing. After initial enrollment the device can automatically renew the certificate when it is about to expire.</p>
<ol class=" "><li class=" "><p   
>The is a Vendor Root CA and a Vendor Sub CA that issues a Vendor Certificate to the device, with which is comes pre-provisioned from the factory.</p>
</li><li class=" "><p   
>The Vendor Root CA is trusted for initial enrollment, for devices pre-registered in EJBCA with parts of the DN (usually device serial number).</p>
</li><li class=" "><p   
>We want to generate two certificates for the device, one for IPSEC and one for TLS, and thus the Vendor Certificate is used for multiple authentications to different end entities.</p>
</li><li class=" "><p   
>Generate two new key pairs on the device</p>
</li><li class=" "><p   
>Initial enrollment of an IPSEC Certificate for the new key on the device uses certificate authentication with the Vendor Certificate on the device.</p>
</li><li class=" "><p   
>Initial enrollment of a TLS Certificate for the new key on the device uses certificate authentication with the Vendor Certificate on the device.</p>
</li><li class=" "><p   
>Generate two new key pairs on the device</p>
</li><li class=" "><p   
>Renew the IPSEC certificate for the new key pair, authenticated using the old key pair and certificate</p>
</li><li class=" "><p   
>Renew thl TLS certificate for the new key pair, authenticated using the old key pair and certificate</p>
</li></ol><p   
>The above steps can be simulated in reality using the <i class=" ">cmpforopenssl</i> client, but also using the <a   href="#src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtRUpCQ0FfY21wY2xpZW50XyhFbnRlcnByaXNlX29ubHkp">EJBCA cmpclient</a>.</p>
<p   
>This works with two cmpaliases configured with parameters:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CMP Alias: aliasIPSEC</code></div>
<div class="line"><code class="plain">CMP Operational Mode: Client</code></div>
<div class="line"><code class="plain">CMP Authentication Module : EndEntityCertificate</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
<div class="line"><code class="plain">RA Name Generation Postfix : _IPSEC</code></div>
<div class="line"><code class="plain">Vendor Certificate Mode: Use</code></div>
<div class="line"><code class="plain">List Of Vendor CAs: Add Vendor Root CA (imported as External CA in EJBCA)</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">CMP Alias: aliasTLS</code></div>
<div class="line"><code class="plain">CMP Operational Mode: Client</code></div>
<div class="line"><code class="plain">CMP Authentication Module : EndEntityCertificate</code></div>
<div class="line"><code class="plain">Extract Username Component : CN</code></div>
<div class="line"><code class="plain">RA Name Generation Postfix : _TLS</code></div>
<div class="line"><code class="plain">Vendor Certificate Mode: Use</code></div>
<div class="line"><code class="plain">List Of Vendor CAs: Add Vendor Root CA (imported as External CA in EJBCA</code></div>
</div>
    </div>
<p   
>The Vendor Certificate is issued (suggested as a keystore with the private key) from Vendor Sub CA the with subjectDN: CN=1234.primekey.com,O=PrimeKey,C=SE</p>
<ol class=" "><li class=" "><p   
>Generate key pairs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/ipsec_key.pem 2048 </code></div>
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/tls_key.pem 2048 </code></div>
</div>
    </div>
</li><li class=" "><p   
>Initial enrollment:<br/>Before initial enrollment you add two new End Entities in EJBCA, in this example with user name 1234.primekey.com_IPSEC and 1234.primekey.com_TLS with subject DN 'CN=ipsec1234' resp. 'CN=hostname1234'.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/aliasIPSEC \</code></div>
<div class="line"><code class="plain">	-cert VendorCert.pem -key VendorKey.pem -certout ipsec_cert.pem -newkey ipsec_key.pem \</code></div>
<div class="line"><code class="plain">	-subject "/CN=ipsec1234" -extracerts VendorExtraCerts.pem -trusted IPSECROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicitconfirm </code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ openssl cmp -cmd ir -server localhost:8080 -path ejbca/publicweb/cmp/aliasTLS \</code></div>
<div class="line"><code class="plain">	-cert VendorCert.pem -key VendorKey.pem -certout tls_cert.pem -newkey tls_key.pem \</code></div>
<div class="line"><code class="plain">	-subject "/CN=hostname1234" -extracerts VendorExtraCerts.pem -trusted TLSROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicitconfirm </code></div>
</div>
    </div>
</li><li class=" "><p   
>Generate new key pairs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/ipsec_new_key.pem 2048</code></div>
<div class="line"><code class="plain">$ ./openssl genrsa -out certs/tls_new_key.pem 2048</code></div>
</div>
    </div>
</li><li class=" "><p   
>Renew with new certificates:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$ openssl cmp -cmd kur -server localhost:8080 -path ejbca/publicweb/cmp/aliasIPSEC \</code></div>
<div class="line"><code class="plain">	-cert ipsec_cert.pem -key ipsec_key.pem -certout ipsec_new_cert.pem -newkey ipsec_new_key.pem \</code></div>
<div class="line"><code class="plain">	-subject "/CN=ipsec1234" -extracerts IPSECCAcerts.pem -trusted IPSECROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicitconfirm</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">$ openssl cmp -cmd kur -server localhost:8080 -path ejbca/publicweb/cmp/aliasTLS \</code></div>
<div class="line"><code class="plain">	-cert tls_cert.pem -key tls_key.pem -certout tls_new_cert.pem -newkey tls_new_key.pem \</code></div>
<div class="line"><code class="plain">	-subject "/CN=hostname1234" -extracerts TLSCAcerts.pem -trusted TLSROOTRSA.cacert.pem \</code></div>
<div class="line"><code class="plain">	-implicitconfir</code></div>
</div>
    </div>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CustomhandlingofcertificaterequestCustom_handling_of_certificate_request">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Custom_handling_of_certificate_request" class="confluence-anchor-link"></span><span>Custom handling of certificate request </span></h1>
<p   
>A custom plug-in class can be added to handle a certificate request. The class implementing this plug-in must implement the org.ejbca.core.protocol.ExtendedUserDataHandler interface.</p>
<p   
>The implementation uses information from the certificate profile or name, and the request itself to manipulate the request before it is processed the normal way. This is done when the processRequestMessage is called (refer to the source code of the interface). The used certificate profile name is passed as <strong class=" ">otherData</strong>.</p>
<p   
>To enable the plug-in, go to <strong class=" ">Admin GUI&gt;CMP Configuration</strong> and set <strong class=" ">Certificate Request Handler Class </strong>to the name of the plug-in. You can then add additional properties to be used in the implementation.<strong class=" "></strong></p>
<p   
>EJBCA includes an implementation that writes to the unid-fnr DB (see <a  class="external-link" href="https://www.ejbca.org/docs/unid.html">www.ejbca.org/docs/unid</a>). To activate this plug-in, specify the following configuration:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Certificate Request Handler Class : org.ejbca.core.protocol.unid.UnidFnrHandler</code></div>
<div class="line"><code class="plain">Unid Data Source : java:/UnidDS</code></div>
</div>
    </div>
<p   
>Note that you have to set this using the CLI (as it is not possible in the Admin GUI), according to the following:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin/ejbca.sh config cmp updatealias --alias cmpalias --key certreqhandler.class --value org.ejbca.core.protocol.unid.UnidFnrHandler</code></div>
<div class="line"><code class="plain">bin/ejbca.sh config cmp updatealias --alias cmpalias --key uniddatasource --value java:/UnidDS</code></div>
</div>
    </div>
<p   
>Additionally, the Unid mapping database needs to be created. For more information, refer to <a  class="external-link" href="https://www.ejbca.org/docs/unid.html">www.ejbca.org/docs/unid</a>.</p>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPErrorMessagesCMP_Error_Messages">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_Error_Messages" class="confluence-anchor-link"></span><span>CMP Error Messages </span></h1>
<p   
>If issues occur during CMP processing, different CMP error messages or HTTP error codes are returned depending on issue type and when it is encountered.</p>
<p   
>The following lists examples of CMP error codes:</p>
    <div  class="tablewrap">
        <table class="wrapped confluenceTable">
                    <colgroup>
                                    <col />
                                    <col />
                                    <col />
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Description</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Type</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Code</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>The received request did not contain a DER object.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HTTP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>400 Bad Request</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>The DER object contained in request could not be parsed to a CMP message.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Signature verification on a nested message failed.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Received CMP message was of an unknown type</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a request with a URL that does not match an existing CMP alias</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HTTP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>404 Not Found</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP RA message with a signing certificate which was revoked or expired.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP RA message that could not be authenticated.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_MESSAGE_CHECK (1)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to revoke a certificate that was already revoked</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Signed CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>CERT_REVOKED (10)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to revoke a certificate whose revocation is is waiting for approval</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to revoke a certificate from a nonexistant CA.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to revoke a non existing certificate</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Signed CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_CERTIFICATE_ID (4)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to revoke a certificate, but serial number or issuer were missing from request.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Signed CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_CERTIFICATE_ID (4)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Revocation reason could not be parsed from CMP message</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>INCORRECT_DATA (7)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Trying to issue or request a certificate from a non existing CA</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>WRONG_AUTHORITY (6)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP request with bad POP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_POP (9)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP client mode enrollment request with invalid certificate extensions specified.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP client mode enrollment request with invalid enrollment code.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>NOT_AUTHORIZED (23)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Attempting a key update request without the end entity authentication module configured.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A key update request without could not be authenticated/verified.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A key update request was submitted without a subject DN</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A key update request for an end entity which wasn't found in the database.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_MESSAGE_CHECK (1)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A key update request was submitted using the same keypair.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_MESSAGE_CHECK (1)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Any other failures that may have occurred during key renewal.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_MESSAGE_CHECK (1)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a CMP client mode enrollment request with wrong user/enrollment code</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>NOT_AUTHORIZED (23)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A request for server generated keys when this is not enabled in CMP alias</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A request for server generated keys when the certificate profile does not exist</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A request for server generated keys when the key algorithm, key size (RSA) or curve (ECDSA) is not allowed</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>A request for server generated keys with invalid or unsupported key parameters</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Other internal errors</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Various</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
    </div>
    <div class="section section-1" id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ01QUHJveHlDTVBfUHJveHlfKEVKQkNBX0VudGVycHJpc2Vfb25seSk">
        <h1 class="heading "><span id="src-22381531_safe-id-aWQtLkNNUHY2LjE1LjAtQ01QX1Byb3h5XyhFSkJDQV9FbnRlcnByaXNlX29ubHkp" class="confluence-anchor-link"></span><span>CMP Proxy </span></h1>
<p   
></p>
<p   
><span class="status blue " >ENTERPRISE</span>
 This is an EJBCA Enterprise feature.</p>
<p   
>In some installations it may be desirable to terminate the client connection in a DMZ before connecting further to the CA. In this case the client never has a direct network connection to the CA machine. In such a scenario you can use the CMP proxy module. Clients use the CMP proxy, as it would otherwise use EJBCA. The proxy in turn connects to EJBCA gets the answer and forwards it back to the client.</p>
<p   
>The proxy is a stand alone module that runs on another machine than the CA itself.</p>
<p   
>See EJBCA_HOME/modules/cmpProxy/resources/README for information how to build and use the proxy.</p>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-BackendsBackends">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-Backends" class="confluence-anchor-link"></span><span>Backends </span></h2>
<p   
>The CMP Proxy can use different connection backends to the CA. The most usable are:</p>
<ul class=" "><li class=" "><p   
>Direct HTTP connection: The CMP proxy creates a new HTTP connection to the CA, and return the response to the client, through the client connection, after receiving the response from the CA.</p>
</li><li class=" "><p   
><a   href="External_RA_using_Database_Polling.html">External RA connection</a>: The CMP proxy creates an external RA msg in an external RA database, which the CA polls. When the CA stores a return message in the external RA database, this is picked up by the CMP proxy and returned to the client.</p>
</li></ul>    </div>
    <div class="section section-2" id="src-22381531_id-.CMPv6.15.0-CMPProxyMessageValidationCMP_Proxy_Message_Validation">
        <h2 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_Proxy_Message_Validation" class="confluence-anchor-link"></span><span>CMP Proxy Message Validation </span></h2>
<p   
>The CMP proxy have options for verifying CMP message protection in the proxy, before passing the message to the CA. Password based MAC and Signature protection can be verifies. These validations can be activated in _cmpProxy.properties{_}. CMP message headers only allow one form of protection per message, so activating both modes will allow messages to use either form. Rejected messages will never pass the CMP Proxy, but will rejected in the same form as if they had been rejected from the CA.</p>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-PasswordbasedMAC">
        <h3 class="heading "><span>Password based MAC</span></h3>
<p   
>Password based MAC verification can be activated by setting the following value to true in cmpProxy.properties:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">mp.backend.hmacPasswordValidationRequired=true</code></div>
</div>
    </div>
<p   
>In addition to this, KeyId/password pairs need to be defined, where they KeyID is the name of the CA and the password is the CMP RA Authentication Secret for that CA.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">cmp.backend.hmacPassword.keylist=[ca1:foo][ca2:bar]</code></div>
</div>
    </div>
    </div>
    <div class="section section-3" id="src-22381531_id-.CMPv6.15.0-Signature">
        <h3 class="heading "><span>Signature</span></h3>
<p   
>This form can be activated by setting the following value:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">cmp.backend.signatureRequired=true</code></div>
</div>
    </div>
<p   
>In addition to this, the following value needs to be defined:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">cmp.backend.issuerchainpath</code></div>
</div>
    </div>
<p   
>This value can either be set to a single PEM file or to a directory containing multiple PEM files, representing one or more valid issuers of signing certificates.</p>
    </div>
    </div>
    </div>
    <div class="section section-1" id="src-22381531_id-.CMPv6.15.0-CMPProxyErrorMessagesCMP_Proxy_Error_Messages">
        <h1 class="heading "><span id="src-22381531_id-.CMPv6.15.0-CMP_Proxy_Error_Messages" class="confluence-anchor-link"></span><span>CMP Proxy Error Messages </span></h1>
<p   
>The CMP Proxy will return error messages, partly as a result of problems inherent to the proxy in itself, and partly due to evaluating CMP requests directly on the proxy before passing them on. The messages listed here are those returned by the proxy independently of the CA, as listed in the <a   href="#src-22381531_id-.CMPv6.15.0-CMP_Error_Messages">CMP Error Messages</a> section.</p>
    <div  class="tablewrap">
        <table class="wrapped confluenceTable">
                    <colgroup>
                                    <col />
                                    <col />
                                    <col />
                            </colgroup>
        <thead class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Description</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Type</p>
            </td>
                <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Error Code</p>
            </td>
        </tr>
</thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>The received request did not contain a DER object.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Submitting a request with a URL that does not match an existing CMP alias</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HTTP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>404 Not Found</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Sending a response over TCP failed.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HTTP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>500 Internal Server Error</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Signature/HMAC protection was required in configuration, but no protection was present.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>HMAC/Signature verification failed.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Message signature was required, but no signing certificate was supplied.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Message signature was required, but revocation check could not be performed.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>SYSTEM_UNAVAILABLE (24)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Message signature was required, if a cache failure occurred during revocation check.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>SYSTEM_UNAVAILABLE (24)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Message signature was required, but no certificate chains defined on proxy</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>SYSTEM_UNAVAILABLE (24)</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Message signature was required, but signer certificate was revoked.</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>Unsigned CMP</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>BAD_REQUEST (2)</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Certificate_Management_REST_Interface.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Certificate Management REST Interface</span>
        </a>
                <a href="EST.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>EST</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
