<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Script based Autoenrollment for Windows clients with EJBCA - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=16225540"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                     <li><a href="EJBCA_Guides.html">EJBCA Guides</a></li>
                                                            </ul>
</div>            <h1 id="src-16225540"> <span>Script based Autoenrollment for Windows clients with EJBCA</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>Script based Autoenrollment is a legacy way of doing autoenrollment and is kept for legacy reasons. Native autoenrollment (above) provides a more seamless experience.</p>
<p   
>This section will show you how to set up automatic certificate enroll of machines and users in an Windows environment with EJBCA.</p>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-Introduction">
        <h1 class="heading "><span>Introduction</span></h1>
<ul class=" "><li class=" "><p   
>Use mod_auth_kerb on a Apache2 web server proxy to validate the requesters identity using Kerberos.</p>
</li><li class=" "><p   
>A login VBS-Script creates a certificate request that is sent to the proxy using IE-components.</p>
</li><li class=" "><p   
>A Servlet protected by the proxy receives the requests and creates a new cert.</p>
</li><li class=" "><p   
>The new certificate will use information from the request (UPN and CertificateTemplate) and read.</p>
</li><li class=" "><p   
>information from active directory (CN,DC etc).</p>
</li><li class=" "><p   
>Autoenrollment should be configurable in the Admin GUI.</p>
</li></ul>    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-CurrentStatusandKnownIssues">
        <h1 class="heading "><span>Current Status and Known Issues</span></h1>
    <div class="section section-2" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-CurrentStatus">
        <h2 class="heading "><span>Current Status</span></h2>
<ul class=" "><li class=" "><p   
>Machine enroll on Domain Controller: WORKING</p>
</li><li class=" "><p   
>DomainController enroll on Domain Controller: WORKING</p>
</li><li class=" "><p   
>User enroll (Administrator) on Domain Controller: <strong class=" ">NOT WORKING</strong> (Does not trusts ca-server as Intranet, despite GP)</p>
</li><li class=" "><p   
>Machine enroll on other WS2K3 client: WORKING (not checked in a while)</p>
</li><li class=" "><p   
>User enroll (Administrator) on other WS2K3 client: <strong class=" ">NOT WORKING</strong> (Does not trusts ca-server as Intranet, despite GP, also complains about untrusted VBS if ran manually)</p>
</li><li class=" "><p   
>Machine enroll on WinXP client: WORKING</p>
</li><li class=" "><p   
>User enroll (Administrator) on WinXP client: WORKING</p>
</li></ul>    </div>
    <div class="section section-2" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-KnownIssues">
        <h2 class="heading "><span>Known Issues</span></h2>
<ul class=" "><li class=" "><p   
><strong class=" ">SECURITY:</strong> The Servlet should verify that e.g. only Users can request User certificates, DCs only DC certs etc.. and other permissions if possible.</p>
</li><li class=" "><p   
>The enroll scripts always fetches new certificates. They should use the command=status first to see if a new cert is needed.</p>
</li><li class=" "><p   
>AdminWeb cannot verify admin certificates if non-&quot;/ejbca/&quot; path is used in URL.</p>
</li><li class=" "><p   
>Autoenroll Servlet doesn't get X-Remote-User if &quot;/ejbca/&quot; path is used in URL.</p>
</li><li class=" "><p   
>Order of Subject DNs is wrong compared with MS certs..</p>
</li><li class=" "><p   
>SSL connection to AD has not been tested.</p>
</li><li class=" "><p   
>Certificates don't have the CertificateTemplate attrib yet.. looks nicer in Certificate MMC snapin..</p>
</li><li class=" "><p   
>JavaScript &quot;onchange&quot; behaves strangely in IE6. Only activated when the table is clicked, not the checkbox..</p>
</li><li class=" "><p   
>Creation of EEPs is inefficient due to attempted removal of EEP before each new request.. (Debug-code)</p>
</li></ul>    </div>
    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-MachinesandSoftware">
        <h1 class="heading "><span>Machines and Software</span></h1>
<p   
>Domain Controller: dc1.company.local</p>
<ul class=" "><li class=" "><p   
>Windows Server 2003 EE patched to SP2</p>
</li><li class=" "><p   
>Active Directory</p>
</li><li class=" "><p   
>DNS Server</p>
</li></ul><p   
>CA Server: ca-server.company.local</p>
<ul class=" "><li class=" "><p   
>Ubuntu 64 Server 7.10</p>
</li><li class=" "><p   
>Apache2 with modules</p>
</li><li class=" "><p   
>Kerberos 5</p>
</li><li class=" "><p   
>Java 1.6u4</p>
</li><li class=" "><p   
>JBoss 4.2.2.GA</p>
</li><li class=" "><p   
>EJBCA 3.6 Alpha</p>
</li><li class=" "><p   
>Apache Ant 1.7.0</p>
</li></ul><p   
>Desktop client: client-01.company.local</p>
<ul class=" "><li class=" "><p   
>Windows XP Pro SP1 patched to SP2</p>
</li></ul>    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-InstallEJBCA">
        <h1 class="heading "><span>Install EJBCA</span></h1>
<p   
>Configure EJBCA not to respond to external web-requests by editing $EJBCA_HOME/conf/web.properties</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain"> httpsserver.bindaddress.pubhttp=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain"> httpsserver.bindaddress.pubhttps=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain"> httpsserver.bindaddress.privhttps=</code><code class="value">127.0</code><code class="plain">.</code><code class="value">0.1</code></div>
<div class="line"><code class="plain"> ...</code></div>
</div>
    </div>
<p   
>After installation, go to EJBCA Admin GUI -&gt; System Configuration and configure the autoenrollment settings.</p>
    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-SettingupKerberosAuthenticationandApache">
        <h1 class="heading "><span>Setting up Kerberos Authentication and Apache</span></h1>
<p   
>This could probably be done on a Windows server as well, since Apache and Kerberos is supposed to work on that platform too:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$sudo su</code></div>
<div class="line"><code class="plain">#apt-get update</code></div>
<div class="line"><code class="plain">#apt-get install krb5-user apache2 libapache2-mod-auth-kerb</code></div>
<div class="line"><code class="plain"> ** Skip kerberos config.. we will configure </code><code class="keyword">this</code><code class="plain"> later **</code></div>
<div class="line"><code class="plain">#cd /etc/apache2/mods-enabled/</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/proxy.load proxy.load</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/proxy_ajp.load proxy_ajp.load</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/proxy_balancer.load proxy_balancer.load</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/rewrite.load rewrite.load</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/ssl.load ssl.load</code></div>
<div class="line"><code class="plain">#ln -s ../mods-available/headers.load headers.load</code></div>
</div>
    </div>
<p   
>Edit /etc/krb5.conf where dc1.company.local is the DNS-name of the Domain Controller and COMPANY.LOCAL is our domain.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">[libdefaults]</code></div>
<div class="line"><code class="plain">default_realm = COMPANY.LOCAL</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[realms]</code></div>
<div class="line"><code class="plain">COMPANY.LOCAL = {</code></div>
<div class="line"><code class="plain">    kdc = dc1.company.local:</code><code class="value">88</code></div>
<div class="line"><code class="plain">    admin_server = dc1.company.local:</code><code class="value">88</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[domain_realm]</code></div>
<div class="line"><code class="plain">    .company.local = COMPANY.LOCAL</code></div>
<div class="line"><code class="plain">    company.local = COMPANY.LOCAL</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[logging]</code></div>
<div class="line"><code class="keyword">default</code><code class="plain"> = FILE:/var/log/apache2/krb5.log</code></div>
</div>
    </div>
<p   
>Edit /etc/network/interfaces and set a static IP address:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">#iface eth0 inet dhcp</code></div>
<div class="line"><code class="plain">iface eth0 inet </code><code class="keyword">static</code></div>
<div class="line"><code class="plain">    address </code><code class="value">192.168</code><code class="plain">.</code><code class="value">0.102</code><code class="plain">	# Address of </code><code class="keyword">this</code><code class="plain"> machine</code></div>
<div class="line"><code class="plain">    netmask </code><code class="value">255.255</code><code class="plain">.</code><code class="value">255.0</code></div>
<div class="line"><code class="plain">    gateway </code><code class="value">192.168</code><code class="plain">.</code><code class="value">0.101</code><code class="plain">	# In our local network </code><code class="keyword">this</code><code class="plain"> is the Domain Controller</code></div>
</div>
    </div>
<p   
>Use the DC as DNS server in /etc/resolv.conf:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">search localdomain</code></div>
<div class="line"><code class="plain">nameserver </code><code class="value">192.168</code><code class="plain">.</code><code class="value">0.101</code></div>
</div>
    </div>
<p   
>and restart networking (sudo /etc/init.d/networking restart).</p>
<p   
>Add &quot;ntdpdate dc1.company.local&quot; to /etc/rc.local or a cron job to make sure the ca-server is syncronized with the Domain Controller.</p>
<p   
>Create the SSL certificates for the Apache proxy using the same CA as our EJBCA installation and the same subject DN.</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$cd $EJBCA_HOME</code></div>
<div class="line"><code class="plain">$bin/ejbca.sh ra addendentity apache-ssl foo123 </code><code class="string">"CN=ca-server.company.local,O=EJBCA Sample,C=SE"</code><code class="plain"> </code><code class="string">""</code><code class="plain"> ManagementCA </code><code class="string">""</code><code class="plain"> </code><code class="value">1</code><code class="plain"> PEM SERVER</code></div>
<div class="line"><code class="plain">$bin/ejbca.sh ra setclearpwd apache-ssl foo123</code></div>
<div class="line"><code class="plain">$bin/ejbca.sh batch</code></div>
<div class="line"><code class="plain">$ls p12/pem/ca-server.company.local*</code></div>
<div class="line"><code class="plain">p12/pem/ca-server.company.local-CA.pem  p12/pem/ca-server.company.local-Key.pem  p12/pem/ca-server.company.local.pem</code></div>
</div>
    </div>
<p   
>Edit /etc/apache2/sites-enabled/000-default to display an apache proxy front for EJBCA:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">NameVirtualHost *:</code><code class="value">80</code></div>
<div class="line"><code class="plain">&lt;VirtualHost *:</code><code class="value">80</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">        DocumentRoot /var/www/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Proxy requests to EJBCA instances (only one on local machine configured)</code></div>
<div class="line"><code class="plain">        &lt;Proxy balancer:</code><code class="comments">//mycluster-kerb&gt;</code></div>
<div class="line"><code class="plain">                BalancerMember ajp:</code><code class="comments">//localhost:8009/ejbca/</code></div>
<div class="line"><code class="plain">        &lt;/Proxy&gt;</code></div>
<div class="line"><code class="plain">        ProxyPass / balancer:</code><code class="comments">//mycluster-kerb/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        RewriteEngine   On</code></div>
<div class="line"><code class="plain">        # Redirect all but the CRL Distribution Point, OCSP and Helthcheck to HTTPS</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST} !(/publicweb/webdist/certdist.*cmd=crl|/publicweb/status/)</code></div>
<div class="line"><code class="plain">        RewriteRule     ^(.*)$ https:</code><code class="comments">//%{SERVER_NAME}$1 [L,R]</code></div>
<div class="line"><code class="plain">        # Treat reqeusts to / and /ejbca/ as the same. Required by EJBCA's Admin Web.</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST}  /ejbca/</code></div>
<div class="line"><code class="plain">        RewriteRule     ^/ejbca/(.*)$ /$</code><code class="value">1</code><code class="plain"> [PT]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure log</code></div>
<div class="line"><code class="plain">        LogLevel warn</code></div>
<div class="line"><code class="plain">        ErrorLog /var/log/apache2/error.log</code></div>
<div class="line"><code class="plain">        CustomLog /var/log/apache2/access.log combined</code></div>
<div class="line"><code class="plain">&lt;/VirtualHost&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">NameVirtualHost *:</code><code class="value">443</code></div>
<div class="line"><code class="plain">&lt;VirtualHost *:</code><code class="value">443</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">        DocumentRoot /var/www/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        RewriteEngine   On</code></div>
<div class="line"><code class="plain">        # Treat reqeusts to / and /ejbca/ as the same. Required by EJBCA's Admin Web.</code></div>
<div class="line"><code class="plain">        RewriteCond     %{THE_REQUEST}  /ejbca/</code></div>
<div class="line"><code class="plain">        RewriteRule     ^/ejbca/(.*)$ /$</code><code class="value">1</code><code class="plain"> [PT]</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure secure SSL </code><code class="keyword">for</code><code class="plain"> </code><code class="keyword">this</code><code class="plain"> server using SSL certificate generated by EJBCA</code></div>
<div class="line"><code class="plain">        SSLEngine on</code></div>
<div class="line"><code class="plain">        SSLCipherSuite HIGH</code></div>
<div class="line"><code class="plain">        SSLProtocol all -SSLv2</code></div>
<div class="line"><code class="plain">        SSLCertificateFile /home/jboss/ejbca/p12/pem/ca-server.company.local.pem</code></div>
<div class="line"><code class="plain">        SSLCertificateKeyFile /home/jboss/ejbca/p12/pem/ca-server.company.local-Key.pem</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Require Client SSL certificate </code><code class="keyword">for</code><code class="plain"> the Admin GUI</code></div>
<div class="line"><code class="plain">        &lt;Location /adminweb&gt;</code></div>
<div class="line"><code class="plain">                SSLVerifyClient require</code></div>
<div class="line"><code class="plain">                SSLVerifyDepth </code><code class="value">1</code></div>
<div class="line"><code class="plain">                SSLCACertificateFile /home/jboss/ejbca/p12/pem/ca-server.company.local-CA.pem</code></div>
<div class="line"><code class="plain">        &lt;/Location&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Require Kerberos authentication </code><code class="keyword">for</code><code class="plain"> the Autoenroll Servlet</code></div>
<div class="line"><code class="plain">        &lt;Location /autoenroll&gt;</code></div>
<div class="line"><code class="plain">                AuthType Kerberos</code></div>
<div class="line"><code class="plain">                Krb5Keytab /etc/apache2/http.keytab</code></div>
<div class="line"><code class="plain">                KrbAuthRealms COMPANY.LOCAL</code></div>
<div class="line"><code class="plain">                KrbServiceName HTTP</code></div>
<div class="line"><code class="plain">                KrbMethodNegotiate on</code></div>
<div class="line"><code class="plain">                KrbMethodK5Passwd off</code></div>
<div class="line"><code class="plain">                Require valid-user</code></div>
<div class="line"><code class="plain">        &lt;/Location&gt;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Forward the UPN as variable X-Remote-User</code></div>
<div class="line"><code class="plain">        RewriteCond %{IS_SUBREQ} ^</code><code class="keyword">false</code><code class="plain">$</code></div>
<div class="line"><code class="plain">        RewriteCond %{LA-U:REMOTE_USER} (.+)</code></div>
<div class="line"><code class="plain">        RewriteRule .* - [E=RU:%</code><code class="value">1</code><code class="plain">]</code></div>
<div class="line"><code class="plain">        RequestHeader set X-Remote-User %{RU}e</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Proxy requests to EJBCA instances (only one on local machine configured)</code></div>
<div class="line"><code class="plain">        &lt;Proxy balancer:</code><code class="comments">//mycluster-kerb&gt;</code></div>
<div class="line"><code class="plain">                BalancerMember ajp:</code><code class="comments">//localhost:8009/ejbca/</code></div>
<div class="line"><code class="plain">        &lt;/Proxy&gt;</code></div>
<div class="line"><code class="plain">        ProxyPass / balancer:</code><code class="comments">//mycluster-kerb/</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">        # Configure log</code></div>
<div class="line"><code class="plain">        LogLevel warn</code></div>
<div class="line"><code class="plain">        ErrorLog /var/log/apache2/error.log</code></div>
<div class="line"><code class="plain">        CustomLog /var/log/apache2/access.log combined</code></div>
<div class="line"><code class="plain">&lt;/VirtualHost&gt;</code></div>
</div>
    </div>
<p   
>Restart apache with &quot;sudo /etc/init.d/apache2 restart&quot;</p>
<p   
>Install Windows support tools on the Domain Controller (found in %WIN2k3CD%\SUPPORT\TOOLS\SUPTOOLS.msi) to get ktpass.exe. Create a new user &quot;ca-server@company.local&quot; and a strong password e.g not FooBar123 used here. Create a keytab-file &quot;http.keytab&quot; on the Domain Controller:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ktpass.exe -princ HTTP/ca-server.company.local</code><code class="color1">@COMPANY</code><code class="plain">.LOCAL -mapuser ca-server -crypto DES-CBC-MD5 -ptype KRB5_NT_PRINCIPAL -mapop set +desonly -pass FooBar123 -out http.keytab</code></div>
<div class="line"><code class="plain"> ...</code></div>
<div class="line"><code class="plain"> keysize </code><code class="value">55</code><code class="plain"> HTTP/ca-server.company.local</code><code class="color1">@COMPANY</code><code class="plain">.LOCAL ptype </code><code class="value">1</code><code class="plain"> (KRB5_NT_PRINCIPAL) vno </code><code class="value">3</code><code class="plain"> etype</code></div>
<div class="line"><code class="plain"> </code><code class="value">0x3</code><code class="plain"> (DES-CBC-MD5) keylength </code><code class="value">8</code><code class="plain"> (</code><code class="value">0x64614c9d256bcd6d</code><code class="plain">)</code></div>
<div class="line"><code class="plain"> ...</code></div>
</div>
    </div>
<p   
>And move the file to ca-server.company.local:/etc/apache2/http.keytab change permissions to be readable only by the apache-process:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$chown root:root /etc/apace2/http.keytab</code></div>
</div>
    </div>
<p   
>Verify that the keytab is correct:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$kinit Administrator</code></div>
<div class="line"><code class="plain">$kvno HTTP/ca-server.company.local</code></div>
<div class="line"><code class="plain">$klist -e</code></div>
<div class="line"><code class="plain">** Output here should match the one from ktpass.exe **</code></div>
</div>
    </div>
<p   
>Verify that the keytab can be used:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">$kdestroy</code></div>
<div class="line"><code class="plain">$sudo kinit -k -t /etc/apache2/http.keytab HTTP/ca-server.company.local</code></div>
<div class="line"><code class="plain">$sudo klist</code></div>
<div class="line"><code class="plain">(You should have received a ticket here </code><code class="keyword">if</code><code class="plain"> everything is working.)</code></div>
<div class="line"><code class="plain">$sudo kdestroy</code></div>
</div>
    </div>
<p   
>Add ca-server.company.local (192.168.1.2) to your Domain Controllers DNS server as a &quot;Host (A)&quot; record.</p>
    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-SetupEnrollmentScriptstoRunAutomatically">
        <h1 class="heading "><span>Set up Enrollment Scripts to Run Automatically</span></h1>
<p   
>Create a Shared directory on the Domain Controller, C:\Shared with read and exec rights by Everyone:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">copy %SYSTEMROOT%\system32\certreq.exe C:\Shared\Autoenroll\</code></div>
<div class="line"><code class="plain">copy %SYSTEMROOT%\system32\certcli.dll C:\Shared\Autoenroll\</code></div>
<div class="line"><code class="plain">copy %SYSTEMROOT%\system32\certadm.dll C:\Shared\Autoenroll\</code></div>
<div class="line"><code class="plain">(copy %SYSTEMROOT%\system32\certutil.exe C:\Shared\Autoenroll\ This is used by EnrollDomainController and is already available at all DCs.)</code></div>
</div>
    </div>
<p   
>Edit or create C:\Shared\Autoenroll\autoenroll.conf</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain"># This is a primitive config file that does not allow spaces</code></div>
<div class="line"> </div>
<div class="line"><code class="plain"># The request URL is built from the following properties</code></div>
<div class="line"><code class="plain"># https:</code><code class="comments">//[requestpath]?request=...</code></div>
<div class="line"><code class="plain"># </code></div>
<div class="line"> </div>
<div class="line"><code class="plain"># Standard SSL-port and using URL rewrite from /ejbca/* to /*</code></div>
<div class="line"><code class="plain">requestpath=ca-server.company.local/autoenroll</code></div>
<div class="line"> </div>
<div class="line"><code class="plain"># Non-standard SSL-port and not using URL rewrite</code></div>
<div class="line"><code class="plain">#requestpath=ca-server.company.local:</code><code class="value">4443</code><code class="plain">/ejbca/autoenroll</code></div>
<div class="line"> </div>
<div class="line"><code class="plain"># Debug setting, use only </code><code class="keyword">for</code><code class="plain"> manual testing</code></div>
<div class="line"><code class="plain">#debug=</code><code class="keyword">true</code></div>
<div class="line"><code class="plain">debug=</code><code class="keyword">false</code></div>
</div>
    </div>
<p   
>Edit or create C:\Shared\Autoenroll\RequestAndInstall.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Set oArgs = WScript.Arguments </code></div>
<div class="line"><code class="plain">	</code><code class="keyword">if</code><code class="plain"> oArgs.Count &lt; </code><code class="value">1</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">		WScript.Echo </code><code class="string">"Usage: thisscript.vbs fullpathnameofrequest.inf"</code></div>
<div class="line"><code class="plain">		WScript.Quit </code><code class="value">1</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">else</code><code class="plain"> </code></div>
<div class="line"><code class="plain">		sRequestInfo = Trim(oArgs(</code><code class="value">0</code><code class="plain">))</code></div>
<div class="line"><code class="plain">	end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	sRequest = WS.ExpandEnvironmentStrings(</code><code class="string">"%TEMP%"</code><code class="plain">) &amp; </code><code class="string">"\autoenrolled.req"</code></div>
<div class="line"><code class="plain">	sResult = WS.ExpandEnvironmentStrings(</code><code class="string">"%TEMP%"</code><code class="plain">) &amp; </code><code class="string">"\autoenrolled.p7b"</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set oFilesystem = CreateObject(</code><code class="string">"Scripting.FileSystemObject"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	On Error Resume Next	' Ignore </code><code class="keyword">if</code><code class="plain"> we </code><code class="keyword">try</code><code class="plain"> to delete a file that does not exist</code></div>
<div class="line"><code class="plain">	oFilesystem.DeleteFile(sRequest)</code></div>
<div class="line"><code class="plain">	Err.Clear</code></div>
<div class="line"><code class="plain">	On Error GoTo </code><code class="value">0</code></div>
<div class="line"><code class="plain">	sSharedDir = oFilesystem.GetParentFolderName(WScript.ScriptFullName) &amp; "\"</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set iFile = oFilesystem.OpenTextFile(sSharedDir &amp; </code><code class="string">"autoenroll.conf"</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	Do While iFile.AtEndOfStream &lt;&gt; True </code></div>
<div class="line"><code class="plain">	    sLine = iFile.Readline</code></div>
<div class="line"><code class="plain">	    If InStr(Left(sLine,</code><code class="value">1</code><code class="plain">), </code><code class="string">"#"</code><code class="plain">) = </code><code class="value">0</code><code class="plain"> then</code></div>
<div class="line"><code class="plain">	        If InStr(sLine, </code><code class="string">"requestpath="</code><code class="plain">) &lt;&gt; </code><code class="value">0</code><code class="plain"> then</code></div>
<div class="line"><code class="plain">		    	sRequestPath = Trim(Right(sLine, Len(sLine)-Len(</code><code class="string">"requestpath="</code><code class="plain">)))</code></div>
<div class="line"><code class="plain">	        end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	        If InStr(sLine, </code><code class="string">"debug="</code><code class="plain">) &lt;&gt; </code><code class="value">0</code><code class="plain"> then</code></div>
<div class="line"><code class="plain">		    	sDebug = Trim(Right(sLine, Len(sLine)-Len(</code><code class="string">"debug="</code><code class="plain">)))</code></div>
<div class="line"><code class="plain">	        end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	    End </code><code class="keyword">if</code></div>
<div class="line"><code class="plain">	Loop </code></div>
<div class="line"><code class="plain">	iFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	WS.Run sSharedDir &amp; </code><code class="string">"certreq.exe -f -new "</code><code class="plain"> &amp; sRequestInfo &amp; </code><code class="string">" "</code><code class="plain"> &amp; sRequest, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	sRequestData = </code><code class="string">""</code></div>
<div class="line"><code class="plain">	Set objFile = oFilesystem.OpenTextFile(sRequest, </code><code class="value">1</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	Do Until objFile.AtEndOfStream</code></div>
<div class="line"><code class="plain">		sRequestData = sRequestData &amp; objFile.ReadLine</code></div>
<div class="line"><code class="plain">	Loop</code></div>
<div class="line"><code class="plain">	objFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	set oIE = CreateObject(</code><code class="string">"InternetExplorer.Application"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	oIE.navigate2(</code><code class="string">"https://"</code><code class="plain"> &amp; sRequestPath &amp; </code><code class="string">"?debug="</code><code class="plain"> &amp; sDebug &amp; </code><code class="string">"&amp;request="</code><code class="plain"> &amp; sRequestData)</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	If sDebug = </code><code class="string">"true"</code><code class="plain"> Then</code></div>
<div class="line"><code class="plain">		oIE.visible = </code><code class="keyword">true</code></div>
<div class="line"><code class="plain">	End If</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	'Wait max </code><code class="value">30</code><code class="plain"> seconds</code></div>
<div class="line"><code class="plain">	wscript.sleep </code><code class="value">1000</code></div>
<div class="line"><code class="plain">	counter = </code><code class="value">0</code></div>
<div class="line"><code class="plain">	While oIE.Busy = </code><code class="keyword">true</code><code class="plain"> And counter &lt; </code><code class="value">30</code></div>
<div class="line"><code class="plain">		counter = counter + </code><code class="value">1</code></div>
<div class="line"><code class="plain">		wscript.sleep </code><code class="value">1000</code></div>
<div class="line"><code class="plain">	Wend</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	sResultData = oIE.Document.Body.innerHTML</code></div>
<div class="line"><code class="plain">	sResultData = Mid(sResultData, </code><code class="value">6</code><code class="plain">, Len(sResultData)-</code><code class="value">11</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set oFile = oFilesystem.CreateTextFile(sResult, True)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine sResultData</code></div>
<div class="line"><code class="plain">	oFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	on error resume next ' in </code><code class="keyword">case</code><code class="plain"> the Task Manager is used to close IE.</code></div>
<div class="line"><code class="plain">	If sDebug &lt;&gt; </code><code class="string">"true"</code><code class="plain"> Then</code></div>
<div class="line"><code class="plain">		oIE.quit ' Close the window</code></div>
<div class="line"><code class="plain">		WS.Run sSharedDir &amp; </code><code class="string">"certreq.exe -accept "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; sResult &amp; Chr(</code><code class="value">34</code><code class="plain">), </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	End If</code></div>
</div>
    </div>
<p   
>Edit or create C:\Shared\Autoenroll\EnrollDomainController.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">This Script is based on the script found at http:</code><code class="comments">//www.microsoft.com/technet/prodtechnol/windowsserver2003/technologies/security/advcert.mspx#EURAE</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	iRole = GetLastDomainRole()</code></div>
<div class="line"><code class="plain">	If iRole &lt;&gt; </code><code class="value">4</code><code class="plain"> And iRole &lt;&gt; </code><code class="value">5</code><code class="plain"> Then</code></div>
<div class="line"><code class="plain">		WScript.Echo </code><code class="string">"This script should only run on a Domain Controller."</code></div>
<div class="line"><code class="plain">		WScript.Quit </code><code class="value">1</code></div>
<div class="line"><code class="plain">	End If</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set objDC = GetObject(</code><code class="string">"LDAP://"</code><code class="plain"> &amp; CreateObject(</code><code class="string">"ADSystemInfo"</code><code class="plain">).ComputerName) </code></div>
<div class="line"><code class="plain">	sGUID = objDC.GUID </code></div>
<div class="line"><code class="plain">	sDNShostname = objDC.DNShostname </code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set oFilesystem = CreateObject(</code><code class="string">"Scripting.FileSystemObject"</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	sTempfilePrefix = WS.ExpandEnvironmentStrings(</code><code class="string">"%TEMP%"</code><code class="plain">) &amp; </code><code class="string">"\autoenrolled"</code></div>
<div class="line"><code class="plain">	sRequestInfo = sTempFilePrefix &amp; </code><code class="string">".inf"</code></div>
<div class="line"><code class="plain">	sSharedDir = oFilesystem.GetParentFolderName(WScript.ScriptFullName) &amp; "\"</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	'Create b64 encoded extension</code></div>
<div class="line"><code class="plain">	Dim aASNsubstring(</code><code class="value">2</code><code class="plain">, </code><code class="value">5</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	Const HEX_DATA_LENGTH = </code><code class="value">1</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Const ASCIIDATA = </code><code class="value">2</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Const HEXDATA = </code><code class="value">3</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Const HEX_BLOB_LENGTH = </code><code class="value">4</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Const HEX_TYPE = </code><code class="value">5</code></div>
<div class="line"><code class="plain">	' Encode DNS</code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">0</code><code class="plain">, ASCIIDATA) = sDNShostname </code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">0</code><code class="plain">, HEX_TYPE) = </code><code class="string">"82"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	For i = </code><code class="value">1</code><code class="plain"> to Len(aASNsubstring(</code><code class="value">0</code><code class="plain">, ASCIIDATA)) </code></div>
<div class="line"><code class="plain">	    aASNsubstring(</code><code class="value">0</code><code class="plain">, HEXDATA) = aASNsubstring(</code><code class="value">0</code><code class="plain">, HEXDATA) &amp; Hex(Asc(Mid(aASNsubstring(</code><code class="value">0</code><code class="plain">, ASCIIDATA), i, </code><code class="value">1</code><code class="plain">))) </code></div>
<div class="line"><code class="plain">	Next </code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">0</code><code class="plain">, HEX_DATA_LENGTH) = ComputeASN1 (Len(aASNsubstring(</code><code class="value">0</code><code class="plain">, HEXDATA)) / </code><code class="value">2</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	sASN = aASNsubstring(</code><code class="value">0</code><code class="plain">, HEX_TYPE) &amp; aASNsubstring(</code><code class="value">0</code><code class="plain">, HEX_DATA_LENGTH) &amp; aASNsubstring(</code><code class="value">0</code><code class="plain">, HEXDATA) </code></div>
<div class="line"><code class="plain">	' Encode GUID</code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">1</code><code class="plain">, HEXDATA) = sGUID </code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">1</code><code class="plain">, HEX_TYPE) = </code><code class="string">"A0"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	aASNsubstring(</code><code class="value">1</code><code class="plain">, HEX_DATA_LENGTH) = ComputeASN1 (Len(aASNsubstring(</code><code class="value">1</code><code class="plain">, HEXDATA)) / </code><code class="value">2</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	sASN = sASN &amp; </code><code class="string">"A01F06092B0601040182371901"</code><code class="plain"> &amp; aASNsubstring(</code><code class="value">1</code><code class="plain">, HEX_TYPE) &amp; </code><code class="string">"120410"</code><code class="plain"> &amp; aASNsubstring(</code><code class="value">1</code><code class="plain">, HEXDATA) </code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set oFile = oFilesystem.CreateTextFile(sTempfilePrefix &amp; </code><code class="string">".asn"</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"30"</code><code class="plain"> &amp; ComputeASN1 (Len(sASN) / </code><code class="value">2</code><code class="plain">) &amp; sASN </code></div>
<div class="line"><code class="plain">	oFile.Close </code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"certutil -f -decodehex "</code><code class="plain"> &amp; sTempfilePrefix &amp; </code><code class="string">".asn "</code><code class="plain"> &amp; sTempfilePrefix &amp; </code><code class="string">".bin"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True </code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"certutil -f -encode "</code><code class="plain"> &amp; sTempfilePrefix &amp; </code><code class="string">".bin "</code><code class="plain"> &amp; sTempfilePrefix &amp; </code><code class="string">".b64"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True </code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	Set iFile = oFilesystem.OpenTextFile(sTempfilePrefix &amp; </code><code class="string">".b64"</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	Set oFile = oFilesystem.CreateTextFile(sRequestInfo, True)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[Version]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Signature= "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"$Windows NT$"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[NewRequest]"</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Subject = "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"CN=IgnoredValue"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"KeySpec = 1"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"KeyLength = 2048"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Exportable = TRUE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"MachineKeySet = TRUE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"SMIME = FALSE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"PrivateKeyArchive = FALSE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"UserProtected = FALSE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"UseExistingKeySet = FALSE"</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"ProviderName = "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"Microsoft RSA SChannel Cryptographic Provider"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"ProviderType = 12"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"RequestType = PKCS10"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"KeyUsage = 0xa0"</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[EnhancedKeyUsageExtension]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"OID=1.3.6.1.5.5.7.3.1"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"OID=1.3.6.1.5.5.7.3.2"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[Extensions]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	iLine = </code><code class="value">0</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Do While iFile.AtEndOfStream &lt;&gt; True </code></div>
<div class="line"><code class="plain">	    sLine = iFile.Readline </code></div>
<div class="line"><code class="plain">	    If sLine = </code><code class="string">"-----END CERTIFICATE-----"</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">	        Exit Do </code></div>
<div class="line"><code class="plain">	    end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	    </code><code class="keyword">if</code><code class="plain"> sLine &lt;&gt; </code><code class="string">"-----BEGIN CERTIFICATE-----"</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">	        </code><code class="keyword">if</code><code class="plain"> iLine = </code><code class="value">0</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">	            oFile.WriteLine </code><code class="string">"2.5.29.17="</code><code class="plain"> &amp; sLine </code></div>
<div class="line"><code class="plain">	        </code><code class="keyword">else</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	            oFile.WriteLine </code><code class="string">"_continue_="</code><code class="plain"> &amp; sLine </code></div>
<div class="line"><code class="plain">	        end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	        iLine = iLine + </code><code class="value">1</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	    end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	Loop </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Critical=2.5.29.17"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[RequestAttributes]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"CertificateTemplate = DomainController"</code></div>
<div class="line"><code class="plain">	oFile.Close</code></div>
<div class="line"><code class="plain">	iFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	WS.Run sSharedDir &amp; </code><code class="string">"RequestAndInstall.vbs "</code><code class="plain"> &amp; sRequestInfo, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	' Sub</code></div>
<div class="line"><code class="plain">	Function ComputeASN1 (iStrLen) </code></div>
<div class="line"><code class="plain">	    If Len(Hex(iStrLen)) Mod </code><code class="value">2</code><code class="plain"> = </code><code class="value">0</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">	        sLength = Hex(iStrLen) </code></div>
<div class="line"><code class="plain">	    </code><code class="keyword">else</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	        sLength = </code><code class="string">"0"</code><code class="plain"> &amp; Hex(iStrLen) </code></div>
<div class="line"><code class="plain">	    end </code><code class="keyword">if</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	    </code><code class="keyword">if</code><code class="plain"> iStrLen &gt; </code><code class="value">127</code><code class="plain"> then </code></div>
<div class="line"><code class="plain">	        ComputeASN1 = Hex (</code><code class="value">128</code><code class="plain"> + (Len(sLength) / </code><code class="value">2</code><code class="plain">)) &amp; sLength </code></div>
<div class="line"><code class="plain">	    </code><code class="keyword">else</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	        ComputeASN1 = sLength </code></div>
<div class="line"><code class="plain">	    End If </code></div>
<div class="line"><code class="plain">	End Function</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	'Return the domain role number where:</code></div>
<div class="line"><code class="plain">	'-</code><code class="value">1</code><code class="plain"> Error</code></div>
<div class="line"><code class="plain">	'</code><code class="value">0</code><code class="plain"> Standalone Workstation</code></div>
<div class="line"><code class="plain">	'</code><code class="value">1</code><code class="plain"> Member Workstation</code></div>
<div class="line"><code class="plain">	'</code><code class="value">2</code><code class="plain"> Standalone Server</code></div>
<div class="line"><code class="plain">	'</code><code class="value">3</code><code class="plain"> Member Server</code></div>
<div class="line"><code class="plain">	'</code><code class="value">4</code><code class="plain"> Backup Domain Controller</code></div>
<div class="line"><code class="plain">	'</code><code class="value">5</code><code class="plain"> Primary Domain Controller </code></div>
<div class="line"><code class="plain">	Function GetLastDomainRole () </code></div>
<div class="line"><code class="plain">	    On Error Resume Next</code></div>
<div class="line"><code class="plain">	    strComputer = </code><code class="string">"."</code></div>
<div class="line"><code class="plain">	    Set objWMIService = GetObject(</code><code class="string">"winmgmts:\\"</code><code class="plain"> &amp; strComputer &amp; </code><code class="string">"\root\cimv2"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	    Set colItems = objWMIService.ExecQuery(</code><code class="string">"Select DomainRole from Win32_ComputerSystem"</code><code class="plain">,,</code><code class="value">48</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	    For Each objItem in colItems</code></div>
<div class="line"><code class="plain">	        iReturn = objItem.DomainRole</code></div>
<div class="line"><code class="plain">	    Next</code></div>
<div class="line"><code class="plain">	    On Error Goto </code><code class="value">0</code></div>
<div class="line"><code class="plain">	    GetLastDomainRole = iReturn</code></div>
<div class="line"><code class="plain">	End Function</code></div>
</div>
    </div>
<p   
>Edit or create C:\Shared\Autoenroll\EnrollMachine.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	Set oFilesystem = CreateObject(</code><code class="string">"Scripting.FileSystemObject"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	sRequestInfo = WS.ExpandEnvironmentStrings(</code><code class="string">"%TEMP%"</code><code class="plain">) &amp; </code><code class="string">"\autoenrolled.inf"</code></div>
<div class="line"><code class="plain">	Set oFile = oFilesystem.CreateTextFile(sRequestInfo, True)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[Version]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Signature= "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"$Windows NT$"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[NewRequest]"</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Subject = "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"CN=IgnoredValue"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"KeyLength = 2048"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"MachineKeySet = TRUE"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"RequestType = PKCS10"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[RequestAttributes]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"CertificateTemplate = Machine"</code></div>
<div class="line"><code class="plain">	oFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	sSharedDir = oFilesystem.GetParentFolderName(WScript.ScriptFullName) &amp; "\"</code></div>
<div class="line"><code class="plain">	WS.Run sSharedDir &amp; </code><code class="string">"RequestAndInstall.vbs "</code><code class="plain"> &amp; sRequestInfo, </code><code class="value">0</code><code class="plain">, True</code></div>
</div>
    </div>
<p   
>Edit or create C:\Shared\Autoenroll\EnrollUser.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	Set oFilesystem = CreateObject(</code><code class="string">"Scripting.FileSystemObject"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	sRequestInfo = WS.ExpandEnvironmentStrings(</code><code class="string">"%TEMP%"</code><code class="plain">) &amp; </code><code class="string">"\autoenrolled.inf"</code></div>
<div class="line"><code class="plain">	Set oFile = oFilesystem.CreateTextFile(sRequestInfo, True)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[Version]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Signature= "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"$Windows NT$"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[NewRequest]"</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"Subject = "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"CN=IgnoredValue"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"KeyLength = 2048"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"RequestType = PKCS10"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">""</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"[RequestAttributes]"</code><code class="plain"> </code></div>
<div class="line"><code class="plain">	oFile.WriteLine </code><code class="string">"CertificateTemplate = User"</code></div>
<div class="line"><code class="plain">	oFile.Close</code></div>
<div class="line"><code class="plain">	</code></div>
<div class="line"><code class="plain">	sSharedDir = oFilesystem.GetParentFolderName(WScript.ScriptFullName) &amp; "\"</code></div>
<div class="line"><code class="plain">	WS.Run sSharedDir &amp; </code><code class="string">"RequestAndInstall.vbs "</code><code class="plain"> &amp; sRequestInfo, </code><code class="value">0</code><code class="plain">, True</code></div>
</div>
    </div>
<p   
>Verify that all the file in Shared\Autoenroll directory has read end exec right for Everyone.</p>
<p   
>Install Certificate Templates by adding the corresponding Snap-in i the MMC console.</p>
<ul class=" "><li class=" "><p   
>Install the root CA-certificate(s) in the NTAuthStore, so windows can verify all cerificates produced by EJBCA. Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; Computer Configuration -&gt; Windows Settings -&gt; Security Settings -&gt; Public Key Policies -&gt; Trusted Root Certificate Authorities -&gt; Import -&gt; import the root ca certificate and run &quot;gpupdate /force&quot; on machines that are used for testing. (You can fetch the CA certificate using the EJCBA CLI with &quot;$EJBCA_HOME/bin/ejbca.sh ca getcacert ManagementCA ~/ManagementCA.crt -der&quot;.)</p>
</li><li class=" "><p   
>Add Startup Scripts in Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; Computer Configuration -&gt; Windows Settings -&gt; Scripts -&gt; Startup -&gt; Add the machine-related scripts from the shared directory.</p>
</li><li class=" "><p   
>Add Login Scripts in Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; User Configuration -&gt; Windows Settings -&gt; Scripts -&gt; Logon -&gt; Add the user-related scripts from the shared directory.</p>
</li><li class=" "><p   
>Add the ca-server and shared directory to the Intranet Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; Computer Configuration | User Configuration (do both!!) -&gt; Administrative Templates -&gt; Windows Components -&gt; Internet Explorer -&gt; Internet Control Page -&gt; Security Page -&gt; Site to Zone assignement list -&gt; Enabled and added &quot;<a  class="external-link" href="https://ca-server.company.local">https://ca-server.company.local</a>&quot; to zone &quot;1&quot;, &quot;\\Dc1\Shared&quot; to zone &quot;1&quot;</p>
</li><li class=" "><p   
>Configure clients to synchronize time using NTP: Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; Computer Configuration -&gt; Administrative Templates -&gt; System -&gt; Windows Time Service -&gt; Time Providers -&gt; Configure Windows NTP Client (Add &quot;dc1.company.local&quot; as an NTP server.) and Enable Windows NTP Client.</p>
</li><li class=" "><p   
>Use &quot;gpupdate /force&quot; on clients before running tests.</p>
</li></ul>    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-Debugging">
        <h1 class="heading "><span>Debugging </span></h1>
<p   
>You can enable debug by setting *debug=true* in autoenroll.conf to see the response from the Servlet. Test the machine-cert-retreival script by starting a Console as &quot;LocalSystem&quot;. C:\Shared\Autoenroll\ConsoleAsLocalSystem.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">	Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe delete lsc"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe create lsc binpath= "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"cmd /K start"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">" type= own type= interact"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe start lsc"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
</div>
    </div>
<p   
>Test the machine-cert-retreival script by starting a Console as &quot;LocalSystem&quot;. C:\Shared\ConsoleAsLocalSystem.vbs:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">	Set WS = CreateObject(</code><code class="string">"WScript.Shell"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe delete lsc"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe create lsc binpath= "</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">"cmd /K start"</code><code class="plain"> &amp; Chr(</code><code class="value">34</code><code class="plain">) &amp; </code><code class="string">" type= own type= interact"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
<div class="line"><code class="plain">	WS.Run </code><code class="string">"sc.exe start lsc"</code><code class="plain">, </code><code class="value">0</code><code class="plain">, True</code></div>
</div>
    </div>
<p   
>Adding a custom Administrative template can be done as in this example if needed: Start Menu -&gt; Administration -&gt; Users and Computer -&gt; Right click the domain name -&gt; Properties -&gt; Group Policy -&gt; Edit Default Domain Policy -&gt; Computer Configuration -&gt; Administrative Templates -&gt; Add/Remove Templates -&gt; Add Autoenroll.adm</p>
<p   
>This is just a sample, but shows how a custom GP can be configured.. (<strong class=" ">Use the intructions above instead of this template.</strong> The example Administrative Template &quot;Autoenroll Related&quot; can be used to force ca-server.company.local into the Intranet zone or add a NTP syncronizing policy. C:\Shared\Autoenroll\Autoenroll.adm:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">CLASS MACHINE</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">CATEGORY </code><code class="string">"Autoenroll Related"</code></div>
<div class="line"><code class="plain">    CATEGORY </code><code class="string">"NTP Synch for clients with AD"</code></div>
<div class="line"><code class="plain">     POLICY </code><code class="string">"Enable NTP synch"</code></div>
<div class="line"><code class="plain">      SUPPORTED </code><code class="string">"This is a hack to get WinXP clients working"</code></div>
<div class="line"><code class="plain">      EXPLAIN </code><code class="string">".."</code></div>
<div class="line"><code class="plain">      KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\TimeProviders"</code></div>
<div class="line"><code class="plain">      VALUENAME </code><code class="string">"NtpServer"</code></div>
<div class="line"><code class="plain">      VALUEON NUMERIC </code><code class="value">1</code></div>
<div class="line"><code class="plain">      VALUEOFF NUMERIC </code><code class="value">0</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">       ACTIONLISTON</code></div>
<div class="line"><code class="plain">        KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\Parameters"</code></div>
<div class="line"><code class="plain">        VALUENAME </code><code class="string">"Type"</code></div>
<div class="line"><code class="plain">        VALUE </code><code class="string">"NTP"</code></div>
<div class="line"><code class="plain">       </code></div>
<div class="line"><code class="plain">        KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\Config"</code></div>
<div class="line"><code class="plain">        VALUENAME </code><code class="string">"AnnounceFlags"</code></div>
<div class="line"><code class="plain">        VALUE NUMERIC </code><code class="value">5</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\Config"</code></div>
<div class="line"><code class="plain">        VALUENAME </code><code class="string">"MaxPosPhaseCorrection"</code></div>
<div class="line"><code class="plain">        VALUE NUMERIC </code><code class="value">1099511627775</code></div>
<div class="line"><code class="plain">        </code></div>
<div class="line"><code class="plain">        KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\Config"</code></div>
<div class="line"><code class="plain">        VALUENAME </code><code class="string">"MaxNegPhaseCorrection"</code></div>
<div class="line"><code class="plain">        VALUE NUMERIC </code><code class="value">1099511627775</code></div>
<div class="line"><code class="plain">       END ACTIONLISTON</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">      PART </code><code class="string">"NTP Servers in the form ntp.server1.com,0x1 ntp.server2.com,0x1 ntp.server3.com,0x1"</code><code class="plain"> EDITTEXT</code></div>
<div class="line"><code class="plain">       KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\Parameters"</code></div>
<div class="line"><code class="plain">       VALUENAME </code><code class="string">"NtpServer"</code></div>
<div class="line"><code class="plain">       MAXLEN </code><code class="value">4096</code></div>
<div class="line"><code class="plain">      END PART</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">      PART </code><code class="string">"Poll interval in seconds"</code><code class="plain"> NUMERIC</code></div>
<div class="line"><code class="plain">        KEYNAME </code><code class="string">"Software\Policies\Microsoft\W32Time\TimeProviders\NtpClient"</code></div>
<div class="line"><code class="plain">        VALUENAME </code><code class="string">"SpecialPollInterval"</code></div>
<div class="line"><code class="plain">        DEFAULT </code><code class="value">900</code></div>
<div class="line"><code class="plain">      END PART</code></div>
<div class="line"><code class="plain">     END POLICY</code></div>
<div class="line"><code class="plain">    END CATEGORY</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    CATEGORY </code><code class="string">"Required trust"</code></div>
<div class="line"><code class="plain">     POLICY </code><code class="string">"Trust ca-server.company.local"</code></div>
<div class="line"><code class="plain">      SUPPORTED </code><code class="string">"Might need IE6 for this to work.."</code></div>
<div class="line"><code class="plain">      EXPLAIN </code><code class="string">"This adds the ca-server.company.local to the list of intranet-sites.."</code></div>
<div class="line"><code class="plain">      KEYNAME </code><code class="string">"Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\company.local\ca-server"</code></div>
<div class="line"><code class="plain">      VALUENAME </code><code class="string">"https"</code></div>
<div class="line"><code class="plain">      VALUEON NUMERIC </code><code class="value">1</code></div>
<div class="line"><code class="plain">      VALUEOFF NUMERIC </code><code class="value">0</code><code class="plain">     </code></div>
<div class="line"><code class="plain">     END POLICY</code></div>
<div class="line"><code class="plain">    END CATEGORY</code></div>
<div class="line"><code class="plain">END CATEGORY </code></div>
<div class="line"> </div>
<div class="line"><code class="plain">CLASS USER</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">CATEGORY </code><code class="string">"Autoenroll Related"</code></div>
<div class="line"><code class="plain">    CATEGORY </code><code class="string">"Required trust"</code></div>
<div class="line"><code class="plain">     POLICY </code><code class="string">"Trust ca-server.company.local"</code></div>
<div class="line"><code class="plain">      SUPPORTED </code><code class="string">"Might need IE6 for this to work.."</code></div>
<div class="line"><code class="plain">      EXPLAIN </code><code class="string">"This adds the ca-server.company.local to the list of intranet-sites.."</code></div>
<div class="line"><code class="plain">      KEYNAME </code><code class="string">"Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\company.local\ca-server"</code></div>
<div class="line"><code class="plain">      VALUENAME </code><code class="string">"https"</code></div>
<div class="line"><code class="plain">      VALUEON NUMERIC </code><code class="value">1</code></div>
<div class="line"><code class="plain">      VALUEOFF NUMERIC </code><code class="value">0</code><code class="plain">     </code></div>
<div class="line"><code class="plain">     END POLICY</code></div>
<div class="line"><code class="plain">    END CATEGORY</code></div>
<div class="line"><code class="plain">END CATEGORY</code></div>
</div>
    </div>
<p   
>Useful reg-for VMwares with runaway clocks if GP mod didn't work or you want to modify a single client:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">Windows Registry Editor Version </code><code class="value">5.00</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Config]</code></div>
<div class="line"><code class="string">"AnnounceFlags"</code><code class="plain">=dword:</code><code class="value">00000005</code></div>
<div class="line"><code class="string">"MaxPosPhaseCorrection"</code><code class="plain">=dword:ffffffff</code></div>
<div class="line"><code class="string">"MaxNegPhaseCorrection"</code><code class="plain">=dword:ffffffff</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Parameters]</code></div>
<div class="line"><code class="string">"Type"</code><code class="plain">=</code><code class="string">"NTP"</code></div>
<div class="line"><code class="string">"NtpServer"</code><code class="plain">=</code><code class="string">"dc1.company.local,0x1"</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Parameters\NtpServer]</code></div>
<div class="line"><code class="string">"NtpServer"</code><code class="plain">=</code><code class="string">"dc1.company.local,0x1"</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient]</code></div>
<div class="line"><code class="string">"SpecialPollInterval"</code><code class="plain">=dword:</code><code class="value">00000030</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer]</code></div>
<div class="line"><code class="string">"Enabled"</code><code class="plain">=dword:</code><code class="value">00000001</code></div>
</div>
    </div>
    </div>
    <div class="section section-1" id="src-16225540_ScriptbasedAutoenrollmentforWindowsclientswithEJBCA-References">
        <h1 class="heading "><span>References</span></h1>
<ul class=" "><li class=" "><p   
>Kerberos authentication on Apache2, <a  class="external-link" href="http://www.grolmsnet.de/kerbtut/">http://www.grolmsnet.de/kerbtut/</a></p>
</li><li class=" "><p   
>MS Certificate requests, <a  class="external-link" href="http://technet2.microsoft.com/WindowsServer/en/library/008acdeb-0650-4063-a9a2-1258b3229d4f1033.mspx">http://technet2.microsoft.com/WindowsServer/en/library/008acdeb-0650-4063-a9a2-1258b3229d4f1033.mspx</a></p>
</li><li class=" "><p   
>Requirements for Domain Controller Certificates from a Third-Party CA, <a  class="external-link" href="http://support.microsoft.com/kb/291010">http://support.microsoft.com/kb/291010</a></p>
</li></ul><p   
>Other auto enroll references:</p>
<ul class=" "><li class=" "><p   
>ICertPassage remote protocol, <a  class="external-link" href="http://msdn.microsoft.com/en-us/library/cc233162.aspx">http://msdn.microsoft.com/en-us/library/cc233162.aspx</a></p>
</li><li class=" "><p   
>Windows Client Certificate Enrollment Protocol, <a  class="external-link" href="http://msdn.microsoft.com/en-us/library/cc249820.aspx">http://msdn.microsoft.com/en-us/library/cc249820.aspx</a></p>
</li></ul><p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Appendix.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Appendix</span>
        </a>
                <a href="Ciphermail_Email_Gateway_and_EJBCA_Integration.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Ciphermail Email Gateway and EJBCA Integration</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
