<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Key Recovery - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=16224685"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Operations.html">EJBCA Operations</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_User_Guide.html">EJBCA User Guide</a></li>
                                                                                     <li><a href="CA_Operations_Guide.html">CA Operations Guide</a></li>
                                                            </ul>
</div>            <h1 id="src-16224685"> <span>Key Recovery</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>Key Recovery can be used to re-use or restore a users private key. Key recovery means that <i class=" ">server generated</i> keys (and the certificate) of a user is stored, encrypted, in the CAs database. The purpose of this is to be able to recover an encryption key if the user looses the key. Without possibility of key recovery encrypted data will be lost forever if the encryption key is lost. Key recovery should only be used for encryption keys and not authentication or signature keys, where this need for recovery does not exist.</p>
<p   
>To enable key recovery using the Admin GUI:</p>
<ol class=" "><li class=" "><p   
>Set <strong class=" ">Enable Key Recovery</strong> in <strong class=" ">System Configuration</strong>.</p>
</li><li class=" "><p   
>Create a new End Entity Profile and select <strong class=" ">use</strong> for <strong class=" ">Key Recoverable.</strong></p>
</li><li class=" "><p   
>Add users with this End Entity Profile. Use a keystore type other than <strong class=" ">User Generated</strong>, for example P12, and select <strong class=" ">Key Recoverable</strong>.</p>
</li><li class=" "><p   
>Enroll the user with <strong class=" ">Create keystore</strong> in Public Web. A private and public key pair is now generated by the CA, encrypted and stored in CA database (KeyRecoveryData table).</p>
</li></ol><p   
>Note that key recovery <strong class=" ">cannot</strong> be used with 'user generated' keys since the CA does not have access to the private key in this case, and can thus not store it.</p>
    <div class="section section-1" id="src-16224685_id-.KeyRecoveryv6.12.0-GeneratenewCertificate">
        <h1 class="heading "><span>Generate new Certificate</span></h1>
<p   
>The following is an example of a sequence of commands used to generate a new certificate for a user using the same key pair, if the key and certificate was generated key recoverable as described above:</p>
<ul class=" "><li class=" "><p   
>Mark the generated certificate for keyrecovery:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin</code><code class="plain">/ejbca</code><code class="plain">.sh ra keyrecovernewest &lt;username&gt;</code></div>
</div>
    </div>
<ul class=" "><li class=" "><p   
>Set clear text password for Batch session to use:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin</code><code class="plain">/ejbca</code><code class="plain">.sh ra setclearpwd &lt;username&gt; &lt;userpass&gt;</code></div>
</div>
    </div>
<ul class=" "><li class=" "><p   
>Reissue the certificate:</p>
</li></ul>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">bin</code><code class="plain">/ejbca</code><code class="plain">.sh batch &lt;username&gt;</code></div>
</div>
    </div>
<p   
>You can also generate a new certificate using the Admin GUI and Public Web or the RA GUI in your browser.</p>
<p   
>Using the Admin GUI and Public Web:</p>
<ul class=" "><li class=" "><p   
>Admin GUI &gt; List/Edit End Entities &gt; View_Certificates for user &gt; Recover Key and click <strong class=" ">Close.</strong></p>
</li><li class=" "><p   
>Admin GUI &gt; List/Edit End Entities &gt; Edit_End_Entity for user &gt; Enter new password for user and <strong class=" ">Save</strong> (user status should now be 'Key Recovery')</p>
</li><li class=" "><p   
>Public Web &gt; Create Keystore &gt; Enter username and password &gt;Fetch the keystore.</p>
</li></ul><p   
>Using the RA GUI:</p>
<ul class=" "><li class=" "><p   
>RA GUI &gt; Search &gt; Certificates &gt; View (for a specific certificate).</p>
</li><li class=" "><p   
>RA GUI &gt; Recover Key &gt;Enter new enrollment code &gt; Confirm request.</p>
</li><li class=" "><p   
>RA GUI &gt; Enroll &gt; Use Username &gt; Enter username and password &gt; Fetch P12 / JKS / PEM.</p>
</li><li class=" "><p   
>Optionally, Enroll &gt; Request ID can be used if the operation requires approval.</p>
</li></ul>    </div>
    <div class="section section-1" id="src-16224685_id-.KeyRecoveryv6.12.0-LocalKeyGeneration">
        <h1 class="heading "><span>Local Key Generation</span></h1>
<p   
>In systems with distributed RA's, using key recovery, it might be desired to store the key pairs used for recovery in a database belonging to another instance than the CA. With local key generation, the keys are stored in the RA's database and are encrypted with a crypto token (e.g. from a HSM) in the RA, so the key material is inaccessible to the operators of the CA (provided that they are restricted from logging in to the RA). The certificates and end-entities, however, remain stored in the CA and can be managed (e.g. revoked) from there.</p>
<p   
>In order to activate local key generation, the steps below are to be followed (this is performed on the RA which should keep the key recovery data):</p>
<ul class=" "><li class=" "><p   
>Under System Configuration, set <strong class=" ">Enable Key Recovery</strong> and <strong class=" ">Force Local Key Generation</strong>.</p>
</li><li class=" "><p   
>Select the crypto token to be used for encryption of the key pairs (key recovery data).</p>
</li><li class=" "><p   
>Select the desired key for encryption.</p>
</li></ul><p   
>Recovery data entries belonging to certificates enrolled before local key generation was enabled will remain in their initial database. Enabling local key generation doesn't change the way key recovery is performed by an administrator, nor the work flow of approvals, or <a   href="Access_Rules.html">access rules</a> required. Keep in mind that the role handling the peer connector requires (at least) access to the same set of rules as the administrator of the external RA (for example to perform a key recovery).</p>
    </div>
    <div class="section section-1" id="src-16224685_id-.KeyRecoveryv6.12.0-Technical_detailsTechnicalDetails">
        <h1 class="heading "><span id="src-16224685_id-.KeyRecoveryv6.12.0-Technical_details" class="confluence-anchor-link"></span><span>Technical Details</span></h1>
<p   
>The operation <tt class=" ">bin/ejbca.sh ra keyrecovernewest</tt>, the <strong class=" ">recover key option</strong> in the Admin GUI, and the keyRecoverNewest in the WS API all <strong class=" ">marks</strong> the user/certificate for key recovery. This means that the next time you make a call to generate a keystore (p12/jks/pem) for the user the CA will get the private key, held encrypted in the recovery database, and the existing user certificate or a new certificate, and create a keystore for the user with this old key pair. The actual recovery would then happen when you make a call to i.e. pkcs12Req in the WS API, or if keystore type is P12, JKS or PEM in the Admin GUI.</p>
<p   
>The keys are stored in the database in the table KeyRecoveryData. The data is stored encrypted in a CMS message, as a serialized Java KeyPair. The certificate is not stored in KeyRecoveryData, but only in CertificateData. The encryption key used for the CMS message encryption is the issuing CAs 'keyEncryptKey', and can thus be a key on the HSM. The actual CMS data encryption is performed with AES256_CBC, using a random generated AES key (for this specific CM message). The AES key is wrapped using the RSA key in <strong class=" ">keyEncryptKey</strong>. This is fully according to the best practices, open, stable, CMS standard.</p>
<p   
>There are additional columns in the KeyRecoveryData table enabling change of the <strong class=" ">keyEncryptKey</strong> of the issuing CA. The columns cryptoTokenId and keyAlias gives an exact pointer to the Crypto Token, and specific key, used to encrypt the data. When decrypting data this specific key, with this alias, on the CAs Crypto Token, is first tried, and only if that fails the CAs 'keyEncryptKey' is tried. In addition, the public Key Id (as also exists in CertificateData) of the public key used to encrypt the data is stored in the column publicKeyId. This means that even if keys changed it is possible to identify the exact public key used to decrypt the data.</p>
<p   
>Similarly the column serialNumber column of the table KeyRecoveryData matches the column serialNumber in the table CertificateData.</p>
<p   
></p>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Importing_Certificates.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Importing Certificates</span>
        </a>
                <a href="Managing_CAs.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Managing CAs</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
