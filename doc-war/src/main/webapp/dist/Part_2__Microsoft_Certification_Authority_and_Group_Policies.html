<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Part 2: Microsoft Certification Authority and Group Policies - EJBCA - Documentation Space</title>

    
            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="85921598">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">EJBCADS</span>
                    <img class="space-logo" src="EJBCADS.png" />
                </h1>
                <a href="EJBCA_6.15.2.6_Documentation.html" class="ht-space-link">
                    <h2>EJBCA - Documentation Space</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=37748848"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="EJBCA_6.15.2.6_Documentation.html">EJBCA - Documentation Space</a></li>
                                                                                                             <li><a href="" onclick="$('.shortcut').each(function(){$(this).removeClass('shortcut')}); $(this).parent().addClass('shortcut'); return false;">...</a> </li>
                                        <li class="shortcut"><a href="EJBCA_Documentation.html">EJBCA Documentation</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Integration.html">EJBCA Integration</a></li>
                                                                                                         <li class="shortcut"><a href="EJBCA_Guides.html">EJBCA Guides</a></li>
                                                                                     <li><a href="Certificate_Autoenrollment.html">Certificate Autoenrollment</a></li>
                                                            </ul>
</div>            <h1 id="src-37748848"> <span>Part 2: Microsoft Certification Authority and Group Policies</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
>This section will cover:</p>
<ul class=" "><li class=" "><p   
>Active Directory Certificate services installation and configuration</p>
</li><li class=" "><p   
>Microsoft Templates configuration</p>
</li><li class=" "><p   
>IIS configuration</p>
</li><li class=" "><p   
>Group Policies for auto enrollment</p>
</li><li class=" "><p   
>Testing native auto enrollment</p>
</li></ul><p   
>In the examples below, the domain used is primekey.com (PRIMEKEY), the Certificate Services hostname is csserver.primekey.com, and the Tomcat server hostname is tomcatserver.primekey.com. The text highlighted in red should be replaced with names in your environment.</p>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdGh4eG00YmE1M2YxMS5JbnN0YWxsQWN0aXZlRGlyZWN0b3J5Q2VydGlmaWNhdGVTZXJ2aWNlcw">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdGh4eG00YmE1M2Yx" class="confluence-anchor-link"></span><span>1. Install Active Directory Certificate Services</span></h1>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYW1sNzExaWlvendnMS4xSW5zdGFsbGluZ0FjdGl2ZURpcmVjdG9yeUNlcnRpZmljYXRlU2VydmljZXM">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYW1sNzExaWlvendn" class="confluence-anchor-link"></span><span>1.1 Installing Active Directory Certificate Services</span></h2>
<ol class=" "><li class=" "><p   
>Open Server Manager</p>
</li><li class=" "><p   
>Click Add roles and features.</p>
</li><li class=" "><p   
>Click Next, then select Role-based or feature-based installation.</p>
</li><li class=" "><p   
>Select &quot;Select a server from the server pool&quot; and click the Certificate Services server</p>
</li><li class=" "><p   
>Select Active Directory Certificate Services.</p>
</li><li class=" "><p   
>A popup will appear, click Add Features to add the Certification Authority Management Tools.</p>
</li><li class=" "><p   
>Proceed until reaching the Roles Services page for Active Directory Certificate Services.</p>
</li><li class=" "><p   
>Select 'Certification Authority' and 'Certification Authority Web Enrollment'.</p>
</li><li class=" "><p   
>A popup will appear, click Add Features to add IIS and its corresponding features.</p>
</li><li class=" "><p   
>Proceed until the Confirmation page and click Install.</p>
</li><li class=" "><p   
>When installation is completed proceed to configure Active Directory Certificate Services.</p>
</li></ol>    </div>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdWdtaGM5bWtleXpzMS4yQ29uZmlndXJpbmdBY3RpdmVEaXJlY3RvcnlDZXJ0aWZpY2F0ZVNlcnZpY2Vz">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdWdtaGM5bWtleXpz" class="confluence-anchor-link"></span><span>1.2 Configuring Active Directory Certificate Services</span></h2>
<ol class=" "><li class=" "><p   
>A credentials window will pop up. Enter an account that belongs to the Domain/Enterprise Admin group. Click Next.</p>
</li><li class=" "><p   
>Click Certification Authority and Certification Authority Web Enrollment to configure</p>
</li><li class=" "><p   
>Select Enterprise CA.</p>
<ol class=" "><li class=" "><p   
>Select Root CA.</p>
</li></ol></li><li class=" "><p   
>Create a new private key.</p>
</li><li class=" "><p   
>Select the Cryptography to SHA256.</p>
</li><li class=" "><p   
>Select the bit length to 4096 bits.</p>
</li><li class=" "><p   
>Enter a common name for the CA such as     <span style="color: #ff0000;">
MSCA-Proxy    </span>
.</p>
</li><li class=" "><p   
>Set the validity period 25 years.</p>
</li><li class=" "><p   
>Configure the location for the certificate database and certificate database log.</p>
</li><li class=" "><p   
>Click Configure.</p>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fNnBjMTV2bWEwcTB5Mi5Db25maWd1cmVBY3RpdmVEaXJlY3RvcnlDZXJ0aWZpY2F0ZUVucm9sbG1lbnRQb2xpY3lTZXJ2aWNlc29udGhlQ2VydGlmaWNhdGVTZXJ2aWNlc1NlcnZlcg">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fNnBjMTV2bWEwcTB5" class="confluence-anchor-link"></span><span>2. Configure Active Directory Certificate Enrollment Policy Services on the Certificate Services Server</span></h1>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYXZzN245anRiYTdjMi4xUHJlcGFyZXNlcnZpY2VhY2NvdW50">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYXZzN245anRiYTdj" class="confluence-anchor-link"></span><span>2.1 Prepare service account</span></h2>
<ol class=" "><li class=" "><p   
>If not done so yet, create the service account (    <span style="color: #ff0000;">
ces-service    </span>
) for Certificate Enrollment Services and the service account (    <span style="color: #ff0000;">
servlet-service    </span>
) for Tomcat servlet</p>
</li><li class=" "><p   
>Open the Local Users and Group manager (lusrmgr.msc)</p>
</li><li class=" "><p   
>Add the     <span style="color: #ff0000;">
ces-service    </span>
 account to the Local IIS_IUSRS group.</p>
</li><li class=" "><p   
>Open command prompt with elevated permissions.</p>
</li><li class=" "><p   
>Set service principal name for the service account by running these commands (ensure to replace the server FQDN and account name with your own configuration):</p>
</li></ol>    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">setspn -s HTTP/csserver.primekey.com ces-service </code></div>
<div class="line"><code class="plain">setspn -s HTTP/tomcatserver.primekey.com servlet-service</code></div>
</div>
    </div>
    </div>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fbWZycnA3cWNlcWthMi4ySW5zdGFsbEFjdGl2ZURpcmVjdG9yeUNlcnRpZmljYXRlU2VydmljZXM">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fbWZycnA3cWNlcWth" class="confluence-anchor-link"></span><span>2.2 Install Active Directory Certificate Services</span></h2>
<ol class=" "><li class=" "><p   
>Open Server Manager.</p>
</li><li class=" "><p   
>Under the Active Directory Certificate Services section, click Manage and click Add Roles and Features.</p>
</li><li class=" "><p   
>Expand Active Directory Certificate Services, and select Certificate Enrollment Web Service and Certificate Enrollment Policy Web Service.</p>
</li><li class=" "><p   
>After the roles have been installed, configure Active Directory services on the destination server.</p>
</li><li class=" "><p   
>A credentials window will pop up. Enter an account that belongs to the Domain/Enterprise Admin group. Click Next.</p>
</li><li class=" "><p   
>Check the Certificate Enrollment Web Service and Certificate Enrollment Policy Web Service boxes. Click Next.</p>
</li><li class=" "><p   
>Select the CA Name. Click the Select button to browse for your Microsoft CA. Select the Microsoft CA that will be issuing the certificates using certificate enrollment web service.</p>
</li><li class=" "><p   
>For authentication type for CES, select Windows Integrated Authentication.</p>
</li><li class=" "><p   
>For account for Certificate Enrollment Web Service, specify a service account.</p>
</li><li class=" "><p   
>For authentication type for CEP, select Windows Integrated Authentication.</p>
</li><li class=" "><p   
>Enter credentials for the service account (    <span style="color: #ff0000;">
ces-service    </span>
).</p>
</li><li class=" "><p   
>Choose and assign a certificate for SSL later.</p>
</li><li class=" "><p   
>Click Next.</p>
</li><li class=" "><p   
>Review the confirmation page and click Configure.</p>
</li><li class=" "><p   
>When installation completes, click Close.</p>
</li></ol>    </div>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fcjF3N3d0czU0ZXJ4Mi4zSXNzdWVhc2VydmVyY2VydGlmaWNhdGV0b3RoZUNTU2VydmVy">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fcjF3N3d0czU0ZXJ4" class="confluence-anchor-link"></span><span>2.3 Issue a server certificate to the CS Server</span></h2>
<ol class=" "><li class=" "><p   
>Open Microsoft Management Console (mmc.exe)</p>
</li><li class=" "><p   
>Add the Certificates snap-in.</p>
</li><li class=" "><p   
>Choose Computer account and select Local Computer.</p>
</li><li class=" "><p   
>Select Personal</p>
</li><li class=" "><p   
>Right-click &gt; All Tasks &gt; Request new certificate.</p>
</li><li class=" "><p   
>Select Active Directory Enrollment Policy.</p>
</li><li class=" "><p   
>Select Computer and Enroll.</p>
</li></ol>    </div>
    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feDZrbDc0MThwMWNtMy5Db25maWd1cmVDZXJ0aWZpY2F0ZVRlbXBsYXRlcw">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feDZrbDc0MThwMWNt" class="confluence-anchor-link"></span><span>3. Configure Certificate Templates</span></h1>
<ol class=" "><li class=" "><p   
>Open the Certificate Authority manager</p>
</li><li class=" "><p   
>Expand the selection for your CA.</p>
</li><li class=" "><p   
>Right click Certificate Templates and click Manage.</p>
</li><li class=" "><p   
>Right click Computer and select Duplicate Template.</p>
<ol class=" "><li class=" "><p   
>Under Compatibility Settings for the Certification Authority select Windows Server 2003 and Certificate recipient select Windows XP/Server 2003.</p>
</li><li class=" "><p   
>Click the General Tab and change the Template Name to Computer_Auto_Enrollment</p>
</li><li class=" "><p   
>Click the Security tab, and give &quot;Domain Computers&quot; permissions to Enroll and Autoenroll.</p>
</li><li class=" "><p   
>Select the Subject Name tab and change the Subject name format to be DNS Name.</p>
</li><li class=" "><p   
>Check DNS Name</p>
</li><li class=" "><p   
>Under the request handling tab uncheck &quot;Allow private key to be exported&quot;</p>
</li><li class=" "><p   
>Click &quot;OK&quot; to go back to the template list.</p>
</li></ol></li><li class=" "><p   
>Right click User and select Duplicate Template.</p>
<ol class=" "><li class=" "><p   
>Under Compatibility Settings for the Certification Authority select Windows Server 2003 and Certificate recipient select Windows XP/Server 2003.</p>
</li><li class=" "><p   
>Change the Template Name to User_Auto_Enrollment</p>
</li><li class=" "><p   
>Select the Security tab, and give &quot;Domain Users&quot; permissions to Autoenroll.</p>
</li><li class=" "><p   
>Select the Subject name format to &quot;Common Name&quot;</p>
</li><li class=" "><p   
>Uncheck &quot;Include email name in subject name&quot;</p>
</li><li class=" "><p   
>Uncheck &quot;Email&quot; in the subject alternative name.</p>
</li><li class=" "><p   
>Check &quot;User principal name (UPN)&quot;</p>
</li><li class=" "><p   
>Under the request handling tab uncheck &quot;Allow private key to be exported&quot;</p>
</li><li class=" "><p   
>Click &quot;OK&quot; to go back to the template list.</p>
</li></ol></li><li class=" "><p   
>Return to the Certificate Authority manager.</p>
<ol class=" "><li class=" "><p   
>Right click Certificate Templates.</p>
</li><li class=" "><p   
>Select New &gt; Certificate Template to Issue.</p>
</li><li class=" "><p   
>Select User_Auto_Enrollment and Computer_Auto_Enrollment.</p>
</li><li class=" "><p   
>Click &quot;OK&quot;.</p>
</li></ol></li><li class=" "><p   
>Delete all templates in the Certificate Templates section except the templates created during the cloning process.</p>
</li><li class=" "><p   
>Obtain the Microsoft certificate template OIDs</p>
<ol class=" "><li class=" "><p   
>Open Powershell and run &quot;<strong class=" ">Certutil -catemplates -v | select-string displayname,msPKI-Cert-Template-OID</strong>&quot; to get the Certificate Template OID.</p>
</li><li class=" "><p   
>Note the OIDs for the User_Certificate_Template Workstation_Certificate_Template. These values will be used later.</p>
</li></ol></li></ol>    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fZHNoNG50YjNnOHQwNC5Db25maWd1cmVJSVM">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fZHNoNG50YjNnOHQw" class="confluence-anchor-link"></span><span>4. Configure IIS</span></h1>
<ol class=" "><li class=" "><p   
>Open the IIS Manager.</p>
</li><li class=" "><p   
>Click your server name on the left hand side</p>
</li><li class=" "><p   
>Expand the selection for your server.</p>
</li><li class=" "><p   
>Click Application Pools.</p>
</li><li class=" "><p   
>Right click WSEnrollmentPolicyServer.</p>
</li><li class=" "><p   
>Click Advanced Settings.</p>
</li><li class=" "><p   
>Edit Identity and select a custom account and click set.</p>
</li><li class=" "><p   
>Enter the credentials for     <span style="color: #ff0000;">
PRIMEKEY    </span>
    <span style="color: #ff0000;">
\ces-service    </span>
.</p>
</li><li class=" "><p   
>Expand &quot;Sites&quot; in the Connection menu on the left hand side.</p>
</li><li class=" "><p   
>Click Default Web Site.</p>
</li><li class=" "><p   
>Click Bindings on the right hand side.</p>
</li><li class=" "><p   
>Edit the https site binding.</p>
</li><li class=" "><p   
>Select the CS Server's SSL certificate (    <span style="color: #ff0000;">
csserver.primekey.com    </span>
).</p>
</li><li class=" "><p   
>Expand the Default Web Site option on the left hand side.</p>
</li><li class=" "><p   
>Click ADPolicyProvider_CEP_Kerberos.</p>
</li><li class=" "><p   
>Open Application Settings.</p>
</li><li class=" "><p   
>Enter a FriendlyName for requesting certificates such as EJBCA_Enrollment. This is a name that clients will see only when manually requesting certificates.</p>
</li><li class=" "><p   
>Click Add</p>
</li><li class=" "><p   
>Create a new entry with name &quot;RetryIntervalMs&quot; and value &quot;300000&quot;</p>
</li><li class=" "><p   
>Restart IIS by clicking on the server name and then click Restart on the right hand side.</p>
</li></ol>    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYWl6MmNmaGU1ZXk5NS5Db25maWd1cmVHcm91cFBvbGljaWVzb25BRA">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fYWl6MmNmaGU1ZXk5" class="confluence-anchor-link"></span><span>5. Configure Group Policies on AD</span></h1>
<ol class=" "><li class=" "><p   
>Access Group Policy Management on the AD Host.</p>
</li><li class=" "><p   
>Edit the Default Domain Policy for your domain.</p>
</li><li class=" "><p   
>Expand User Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies.</p>
</li><li class=" "><p   
>Edit Certificate Services Client &ndash; Auto-Enrollment</p>
<ol class=" "><li class=" "><p   
>Change Configuration Model to Enabled</p>
</li><li class=" "><p   
>Check &quot;Update certificates that use certificate templates&quot;</p>
</li></ol></li><li class=" "><p   
>Expand Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies.</p>
</li><li class=" "><p   
>Edit Certificate Services Client &ndash; Auto-Enrollment</p>
<ol class=" "><li class=" "><p   
>Change Configuration Model to Enabled</p>
</li><li class=" "><p   
>Check &quot;Update certificates that use certificate templates&quot;</p>
</li></ol></li></ol>    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fbTExeGxqdG8yNGRlNi5UZXN0TWljcm9zb2Z0QXV0b0Vucm9sbG1lbnQ">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fbTExeGxqdG8yNGRl" class="confluence-anchor-link"></span><span>6. Test Microsoft Auto Enrollment</span></h1>
<ol class=" "><li class=" "><p   
>Log in as any domain admin to a computer connected to the domain.</p>
</li><li class=" "><p   
>Load mmc.exe and use add/remove snap in and pick certificates for both user and local computer.</p>
</li></ol><p   
><img  class="confluence-embedded-image"  src="images/download/attachments/37748848/worddav07cd6fda120371fe916140553727ca2a.png" alt="images/download/attachments/37748848/worddav07cd6fda120371fe916140553727ca2a.png" width="556" height="161" />
    </p>
<ol class=" "><li class=" "><p   
>Verify the user certificate was generated (Current User/ Personal/ Certificates).</p>
<ol class=" "><li class=" "><p   
>Ensure the user certificate in the personal store is generated by the Windows CA using the correct template that was duplicated.</p>
</li></ol></li><li class=" "><p   
>Verify the computer certificate was generated. (Local Computer/ Personal/ Certificates - will need Admin privileges to check the Local computer certificate store).</p>
<ol class=" "><li class=" "><p   
>Ensure the computer certificate in the personal store is generated by the Windows CA using the correct template that was duplicated.</p>
</li></ol></li></ol>    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdm0xaGxsYXNlemdhNy5VcGRhdGV0aGVNU0F1dG9FbnJvbGxtZW50U2VydmVyVVJM">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fdm0xaGxsYXNlemdh" class="confluence-anchor-link"></span><span>7. Update the MS Auto Enrollment Server URL</span></h1>
<ol class=" "><li class=" "><p   
>Open a command prompt on the Certificate Services Server.</p>
</li><li class=" "><p   
>Run this command to get the current URL:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">certutil -config csserver.primekey.com\MSCA-Proxy -enrollmentserverurl</code></div>
</div>
    </div>
</li><li class=" "><p   
>Remove the existing enrollment server URL:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">certutil -config csserver.primekey.com\MSCA-Proxy -enrollmentserverurl https:</code><code class="comments">//csserver.primekey.com/MSCA-Proxy_CES_Kerberos/service.svc/CES delete</code></div>
</div>
    </div>
</li><li class=" "><p   
>Add the new enrollment server URL:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">certutil -config csserver.primekey.com\MSCA-Proxy -enrollmentserverurl https:</code><code class="comments">//tomcatserver.primekey.com:8443/autoenroll/MSEnrollmentServlet Kerberos</code></div>
</div>
    </div>
</li></ol><p   
>Running the first command again should show the new URL updated:</p>
<p   
>Now that all of the changes have been made to the domain group policy and the certificate enrollment URL has been updated, time needs to be given for domain replication to occur. After this time, reboot all desktops that need to get the new profile applied. After logging in to the desktop with the new group policy it can take up to 10 minutes to get a new certificate.</p>
    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fejVnaDZ4aXp4em9zOC5VcGRhdGVHcm91cFBvbGljeWZvckNlcnRpZmljYXRlRW5yb2xsbWVudA">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1fejVnaDZ4aXp4em9z" class="confluence-anchor-link"></span><span>8. Update Group Policy for Certificate Enrollment</span></h1>
<p   
></p>
<ol class=" "><li class=" "><p   
>Access Group Policy Management on AD.</p>
</li><li class=" "><p   
>Edit the Default Domain Policy for your domain.</p>
</li><li class=" "><p   
>Expand User Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies.</p>
</li><li class=" "><p   
>Edit Certificate Services Client &ndash; Certificate Enrollment Policy.</p>
</li><li class=" "><p   
>Change Configuration Model to Enabled.</p>
</li><li class=" "><p   
>Remove the Active Directory Enrollment Policy from the Certificate Enrollment policy list.</p>
</li><li class=" "><p   
>Click Add.</p>
</li><li class=" "><p   
>Enter the policy server URI: https://    <span style="color: #ff0000;">
csserver.primekey.com    </span>
/ADPolicyProvider_CEP_Kerberos/service.svc/CEP</p>
</li><li class=" "><p   
>Click Validate.</p>
</li><li class=" "><p   
>Click Add.</p>
</li><li class=" "><p   
>Select the check mark for Default.</p>
</li><li class=" "><p   
>Click OK.</p>
</li><li class=" "><p   
>Expand Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies.</p>
</li><li class=" "><p   
>Edit Certificate Services Client &ndash; Certificate Enrollment Policy.</p>
</li><li class=" "><p   
>Change Configuration Model to Enabled.</p>
</li><li class=" "><p   
>Remove the Active Directory Enrollment Policy from the Certificate Enrollment policy list.</p>
</li><li class=" "><p   
>Click Add.</p>
</li><li class=" "><p   
>Enter the policy server URI: https://    <span style="color: #ff0000;">
csserver.primekey.com    </span>
/ADPolicyProvider_CEP_Kerberos/service.svc/CEP</p>
</li><li class=" "><p   
>Click Validate.</p>
</li><li class=" "><p   
>Click Add.</p>
</li><li class=" "><p   
>Select the check mark for Default.</p>
</li><li class=" "><p   
>Click OK.</p>
</li></ol><p   
></p>
    </div>
    <div class="section section-1" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feDg1czE3YTJxd2pnOS5JbnN0YWxsQ2VydENoYWluZnJvbUVKQkNBb250b0NsaWVudENlcnRpZmljYXRlU3RvcmVz">
        <h1 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feDg1czE3YTJxd2pn" class="confluence-anchor-link"></span><span>9. Install Cert Chain from EJBCA onto Client Certificate Stores</span></h1>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feWllc3hkdDFpenR3OS4xRmV0Y2hDQWNlcnRpZmljYXRlcw">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feWllc3hkdDFpenR3" class="confluence-anchor-link"></span><span>9.1 Fetch CA certificates</span></h2>
<p   
>On the AD Domain Services Server, go to the EJBCA Public Web located at: http://    <span style="color: #ff0000;">
ejbcaserver.primekey.com    </span>
:8080/ejbca/retrieve/ca_certs.jsp</p>
<ul class=" "><li class=" "><p   
>Download the Root, Intermediate and Issuing CA Certificates</p>
</li></ul>    </div>
    <div class="section section-2" id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feWZxcngwYW05NXI1OS4yU2V0Z3JvdXBwb2xpY2llc3RvYXV0b21hdGljYWxseXBsYWNldGhlQ0FjZXJ0aWZpY2F0ZXNpbnRvdGhlaXJyZXNwZWN0aXZlY2VydGlmaWNhdGVzdG9yZXM">
        <h2 class="heading "><span id="src-37748848_safe-id-aWQtLlBhcnQyOk1pY3Jvc29mdENlcnRpZmljYXRpb25BdXRob3JpdHlhbmRHcm91cFBvbGljaWVzdjYuMTAuMC1feWZxcngwYW05NXI1" class="confluence-anchor-link"></span><span>9.2 Set group policies to automatically place the CA certificates into their respective certificate stores</span></h2>
<ol class=" "><li class=" "><p   
>Open Group Policy Management on the AD Server</p>
</li><li class=" "><p   
>Navigate to the domain</p>
</li><li class=" "><p   
>Create a new Group Policy Object (Trusted EJBCA CA certs)</p>
</li><li class=" "><p   
>Right Click the Trusted EJBCA CA certs GPO and click Edit</p>
</li><li class=" "><p   
>Navigate to Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies &gt; Trusted Root Certification Authorities</p>
</li><li class=" "><p   
>Click the Action menu or right-click and then click Import</p>
</li><li class=" "><p   
>Follow the instructions in the Certificate Import Wizard to find and import the Root CA certificate</p>
</li><li class=" "><p   
>Navigate to Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Public Key Policies &gt; Intermediate Certification Authorities</p>
</li><li class=" "><p   
>Click the Action menu or right-click and then click Import</p>
</li><li class=" "><p   
>Follow the instructions in the Certificate Import Wizard to find and import the Intermediate CA certificate. Repeat the import process for the Issuing CA certificate</p>
</li></ol><p   
></p>
    </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="Part_1__EJBCA_Administration.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Part 1: EJBCA Administration</span>
        </a>
                <a href="Part_3__Configuring_the_Microsoft_Autoenrollment_Servlet.html" class="ht-post-nav-next">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-next" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-225.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Part 3: Configuring the Microsoft Autoenrollment Servlet</span>
        </a>
    </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

</body>
</html>
