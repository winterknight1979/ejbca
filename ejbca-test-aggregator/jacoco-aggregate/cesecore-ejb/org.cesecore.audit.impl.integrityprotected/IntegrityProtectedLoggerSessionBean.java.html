<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IntegrityProtectedLoggerSessionBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-ejb</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.audit.impl.integrityprotected</a> &gt; <span class="el_source">IntegrityProtectedLoggerSessionBean.java</span></div><h1>IntegrityProtectedLoggerSessionBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.audit.impl.integrityprotected;

import java.util.Map;
import java.util.Properties;

import javax.annotation.PostConstruct;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import org.apache.log4j.Logger;
import org.cesecore.audit.enums.EventStatus;
import org.cesecore.audit.enums.EventType;
import org.cesecore.audit.enums.ModuleType;
import org.cesecore.audit.enums.ServiceType;
import org.cesecore.audit.log.AuditRecordStorageException;
import org.cesecore.config.CesecoreConfiguration;
import org.cesecore.time.TrustedTime;
import org.cesecore.util.CryptoProviderTools;
import org.cesecore.util.QueryResultWrapper;

/**
 * An alternative implementation of the SecurityEventsLogger interface. It handles the creation of a signed log for an event.
 * 
 * This was created to evaluate the performance of using database integrity protection instead of custom code for log singing.
 * 
 * @version $Id: IntegrityProtectedLoggerSessionBean.java 24600 2016-10-31 12:01:55Z jeklund $
 */
@Stateless
@TransactionAttribute(TransactionAttributeType.REQUIRED)
<span class="nc" id="L46">public class IntegrityProtectedLoggerSessionBean implements IntegrityProtectedLoggerSessionLocal {</span>

<span class="nc" id="L48">    private static final Logger log = Logger.getLogger(IntegrityProtectedLoggerSessionBean.class);</span>

    @PersistenceContext(unitName = CesecoreConfiguration.PERSISTENCE_UNIT)
    private EntityManager entityManager;

    @PostConstruct
    public void postConstruct() {
<span class="nc" id="L55">        CryptoProviderTools.installBCProviderIfNotAvailable();</span>
<span class="nc" id="L56">    }</span>

    /**
     * Initialization of the log sequence number in combination with nodeId should be performed exactly once.
     * 
     * This callback will be invoked on the first call to NodeSequenceHolder.getNext(...) to perform this initialization.
     * 
     * In this callback implementation, the nodeId is first read from the configuration (which may default to reading
     * the current hostname from the system). This hostname is then passed to the next method to figure out what the
     * highest present sequenceNumber for this nodeId is in the database (e.g. last write before shutting down).
     */
<span class="nc" id="L67">    private final NodeSequenceHolder.OnInitCallBack sequenceHolderInitialization = new NodeSequenceHolder.OnInitCallBack() {</span>
        @Override
        public String getNodeId() {
<span class="nc" id="L70">            return CesecoreConfiguration.getNodeIdentifier();</span>
        }
        @Override
        public long getMaxSequenceNumberForNode(final String nodeId) {
            // Get the latest sequenceNumber from last run from the database..
<span class="nc" id="L75">            final Query query = entityManager.createQuery(&quot;SELECT MAX(a.sequenceNumber) FROM AuditRecordData a WHERE a.nodeId=:nodeId&quot;);</span>
<span class="nc" id="L76">            query.setParameter(&quot;nodeId&quot;, nodeId);</span>
<span class="nc" id="L77">            return QueryResultWrapper.getSingleResult(query, Long.valueOf(-1)).longValue();</span>
        }
    };

    @Override
    @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
    // Always persist audit log
    public void log(final TrustedTime trustedTime, final EventType eventType, final EventStatus eventStatus, final ModuleType module,
            final ServiceType service, final String authToken, final String customId, final String searchDetail1, final String searchDetail2,
            final Map&lt;String, Object&gt; additionalDetails, final Properties properties) throws AuditRecordStorageException {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (log.isTraceEnabled()) {</span>
<span class="nc" id="L88">            log.trace(String.format(&quot;&gt;log:%s:%s:%s:%s:%s:%s&quot;, eventType, eventStatus, module, service, authToken, additionalDetails));</span>
        }
        try {
<span class="nc" id="L91">            final Long sequenceNumber = NodeSequenceHolder.INSTANCE.getNext(sequenceHolderInitialization);</span>
            // Make sure to use the Node Identifier that this log sequence was initialized with (for example hostnames reported by the system could change)
<span class="nc" id="L93">            final String nodeId = NodeSequenceHolder.INSTANCE.getNodeId();</span>
<span class="nc" id="L94">            final Long timeStamp = Long.valueOf(trustedTime.getTime().getTime());</span>
<span class="nc" id="L95">            final AuditRecordData auditRecordData = new AuditRecordData(nodeId, sequenceNumber, timeStamp, eventType, eventStatus, authToken,</span>
                    service, module, customId, searchDetail1, searchDetail2, additionalDetails);
<span class="nc" id="L97">            entityManager.persist(auditRecordData);</span>
<span class="nc" id="L98">        } catch (Exception e) {</span>
<span class="nc" id="L99">            log.error(e.getMessage(), e);</span>
<span class="nc" id="L100">            throw new AuditRecordStorageException(e.getMessage(), e);</span>
        } finally {
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (log.isTraceEnabled()) {</span>
<span class="nc" id="L103">                log.trace(&quot;&lt;log&quot;);</span>
            }
        }
<span class="nc" id="L106">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>