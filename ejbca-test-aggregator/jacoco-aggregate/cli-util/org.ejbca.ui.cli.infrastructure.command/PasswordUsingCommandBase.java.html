<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PasswordUsingCommandBase.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cli-util</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.cli.infrastructure.command</a> &gt; <span class="el_source">PasswordUsingCommandBase.java</span></div><h1>PasswordUsingCommandBase.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.ui.cli.infrastructure.command;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.security.Principal;
import java.util.HashSet;
import java.util.Set;

import org.apache.log4j.Logger;
import org.cesecore.authentication.tokens.AuthenticationSubject;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authentication.tokens.UsernamePrincipal;
import org.cesecore.configuration.GlobalConfigurationSessionRemote;
import org.cesecore.util.EjbRemoteHelper;
import org.ejbca.config.EjbcaConfiguration;
import org.ejbca.config.GlobalConfiguration;
import org.ejbca.core.ejb.authentication.cli.CliAuthenticationProviderSessionRemote;
import org.ejbca.core.ejb.authentication.cli.CliAuthenticationToken;
import org.ejbca.core.ejb.authentication.cli.exception.CliAuthenticationFailedException;
import org.ejbca.core.ejb.ra.EndEntityManagementSessionRemote;
import org.ejbca.ui.cli.infrastructure.CliUsernameException;
import org.ejbca.ui.cli.infrastructure.parameter.Parameter;
import org.ejbca.ui.cli.infrastructure.parameter.ParameterContainer;
import org.ejbca.ui.cli.infrastructure.parameter.ParameterHandler;
import org.ejbca.ui.cli.infrastructure.parameter.enums.MandatoryMode;
import org.ejbca.ui.cli.infrastructure.parameter.enums.ParameterMode;
import org.ejbca.ui.cli.infrastructure.parameter.enums.StandaloneMode;

/**
 * @version $Id: PasswordUsingCommandBase.java 19968 2014-10-09 13:13:58Z mikekushner $
 *
 */
<span class="nc" id="L46">public abstract class PasswordUsingCommandBase extends CommandBase {</span>

<span class="nc" id="L48">    private static final Logger log = Logger.getLogger(PasswordUsingCommandBase.class);</span>

    public static final String USERNAME_KEY = &quot;-u&quot;;
    public static final String PASSWORD_PROMPT_KEY = &quot;-p&quot;;
    public static final String PASSWORD_KEY = &quot;--clipassword&quot;;

    private static final String PASSWORD_MAN_TEXT = &quot;Use the syntax &quot; + USERNAME_KEY + &quot; &lt;username&gt; &quot; + PASSWORD_KEY
            + &quot;=&lt;password&gt; to specify password explicitly or &quot; + USERNAME_KEY + &quot; &lt;username&gt; &quot; + PASSWORD_PROMPT_KEY + &quot; to prompt&quot;;

<span class="nc" id="L57">    private String password = null;</span>
<span class="nc" id="L58">    private String username = null;</span>

    {
<span class="nc" id="L61">        registerDefaultParameters();</span>
<span class="nc" id="L62">    }</span>

    /**
     * Register parameters general for all commands.
     * 
     */
    private void registerDefaultParameters() {
<span class="nc" id="L69">        this.registerParameter(new Parameter(USERNAME_KEY, &quot;CLI Username&quot;, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,</span>
                &quot;Username for the CLI user, if required.&quot;));
<span class="nc" id="L71">        this.registerParameter(new Parameter(PASSWORD_KEY, &quot;CLI Password&quot;, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,</span>
                &quot;Set the password explicitely in the command line with &quot; + PASSWORD_KEY + &quot;=&lt;password&gt;&quot;));
<span class="nc" id="L73">        this.registerParameter(new Parameter(PASSWORD_PROMPT_KEY, &quot;&quot;, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.PASSWORD,</span>
                &quot;Set this flag to be prompted for the username password&quot;));
<span class="nc" id="L75">    }</span>


    /**
     * Extracts the password and username arguments from the parameters map. 
     * 
     * @param parameters
     *            the map of parameters
     * @return A defensive copy, sans password parameters
     *            
     * @throws CliUsernameException If no username was supplied, and the default user is disabled.
     * @throws CliAuthenticationFailedException for any password related issues
     */
    private ParameterContainer stripUsernameAndPasswordFromParameters(ParameterContainer parameters) throws CliUsernameException,
            CliAuthenticationFailedException {
<span class="nc" id="L90">        GlobalConfigurationSessionRemote gcsession = EjbRemoteHelper.INSTANCE.getRemoteSession(GlobalConfigurationSessionRemote.class);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (gcsession == null) {</span>
<span class="nc" id="L92">            throw new CliAuthenticationFailedException(&quot;Can not get configuration from server. Is server started and communication working?&quot;);</span>
        }
<span class="nc" id="L94">        GlobalConfiguration configuration = (GlobalConfiguration) gcsession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>

<span class="nc" id="L96">        ParameterContainer defensiveCopy = new ParameterContainer(parameters);</span>

<span class="nc" id="L98">        username = parameters.get(USERNAME_KEY);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (username != null) {</span>
<span class="nc" id="L100">            defensiveCopy.remove(USERNAME_KEY);</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if(parameters.containsKey(PASSWORD_KEY)) {</span>
<span class="nc" id="L103">            password = parameters.get(PASSWORD_KEY);</span>
<span class="nc" id="L104">            defensiveCopy.remove(PASSWORD_KEY);</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">            if (password.startsWith(&quot;file:&quot;) &amp;&amp; (password.length() &gt; 5)) {</span>
<span class="nc" id="L106">                final String fileName = password.substring(5);</span>
                // Read the password file and just take the first line as being the password
                try {
<span class="nc" id="L109">                    BufferedReader br = new BufferedReader(new FileReader(fileName));</span>
<span class="nc" id="L110">                    password = br.readLine();</span>
<span class="nc" id="L111">                    br.close();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (password != null) {</span>
                        // Trim it, it's so easy for people to include spaces after a line, and a password should never end with a space
<span class="nc" id="L114">                        password = password.trim();</span>
                    }
<span class="nc bnc" id="L116" title="All 4 branches missed.">                    if ((password == null) || (password.length() == 0)) {</span>
<span class="nc" id="L117">                        log.error(&quot;File '&quot; + fileName + &quot;' does not contain any lines.&quot;);</span>
<span class="nc" id="L118">                        throw new CliAuthenticationFailedException(&quot;File '&quot; + fileName + &quot;' does not contain any lines.&quot;);</span>
                    }
<span class="nc" id="L120">                } catch (IOException e) {</span>
<span class="nc" id="L121">                    throw new CliAuthenticationFailedException(&quot;File '&quot; + fileName + &quot;' can not be read: &quot; + e.getMessage());</span>
<span class="nc" id="L122">                }</span>
<span class="nc" id="L123">            }</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        } else if (parameters.containsKey(PASSWORD_PROMPT_KEY)) {</span>
<span class="nc" id="L125">            password = parameters.get(PASSWORD_PROMPT_KEY);</span>
<span class="nc" id="L126">            defensiveCopy.remove(PASSWORD_PROMPT_KEY);</span>
        }
<span class="nc" id="L128">        boolean defaultUserEnabled = configuration.getEnableCommandLineInterfaceDefaultUser();</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">        if ((username == null || password == null)) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (defaultUserEnabled) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                if (username == null) {</span>
<span class="nc" id="L132">                    username = EjbcaConfiguration.getCliDefaultUser();</span>
                }
<span class="nc bnc" id="L134" title="All 2 branches missed.">                if (password == null) {</span>
<span class="nc" id="L135">                    password = EjbcaConfiguration.getCliDefaultPassword();</span>
                }
            } else {
<span class="nc" id="L138">                log.info(&quot;No CLI user was supplied, and use of the default CLI user is disabled.&quot;);</span>
<span class="nc" id="L139">                throw new CliUsernameException(&quot;No CLI user was supplied, and use of the default CLI user is disabled.&quot;);</span>
            }
<span class="nc bnc" id="L141" title="All 4 branches missed.">        } else if (username.equals(EjbcaConfiguration.getCliDefaultUser()) &amp;&amp; !defaultUserEnabled) {</span>
<span class="nc" id="L142">            log.info(&quot;CLI authentication using default user is disabled.&quot;);</span>
<span class="nc" id="L143">            log.info(PASSWORD_MAN_TEXT);</span>
<span class="nc" id="L144">            throw new CliAuthenticationFailedException(&quot;CLI authentication using default user is disabled.&quot;);</span>
        }

<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!EjbRemoteHelper.INSTANCE.getRemoteSession(EndEntityManagementSessionRemote.class).existsUser(username)) {</span>
            //We only check for username here, but it's needless to give too much info. 
<span class="nc" id="L149">            log.info(&quot;CLI authentication failed. The user '&quot; + username + &quot;' with the given password does not exist.&quot;);</span>
<span class="nc" id="L150">            throw new CliAuthenticationFailedException(&quot;Authentication failed. User &quot; + username + &quot; not exist.&quot;);</span>
        }
<span class="nc" id="L152">        return defensiveCopy;</span>
    }

    @Override
    public CommandResult execute(String... arguments) {
<span class="nc" id="L157">        GlobalConfigurationSessionRemote gcsession = EjbRemoteHelper.INSTANCE.getRemoteSession(GlobalConfigurationSessionRemote.class);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (gcsession == null) {</span>
<span class="nc" id="L159">            log.error(&quot;ERROR: Can not get configuration from server. Is server started and communication working?&quot;);</span>
<span class="nc" id="L160">            return CommandResult.CLI_FAILURE;</span>
        }
<span class="nc" id="L162">        GlobalConfiguration configuration = (GlobalConfiguration) gcsession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
        //Check if ClI is enabled
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!configuration.getEnableCommandLineInterface()) {</span>
<span class="nc" id="L165">            log.error(&quot;ERROR: Command Line Interface is disabled&quot;);</span>
<span class="nc" id="L166">            return CommandResult.CLI_FAILURE;</span>
        }
        //Check this before parsing so that user doesn't have to enter CLI password for a nonfunctional command
<span class="nc" id="L169">        boolean passwordPromt = false;</span>
<span class="nc" id="L170">        boolean passwordSet = false;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        for(String argument : arguments) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if(argument.equals(PASSWORD_PROMPT_KEY)) {</span>
<span class="nc" id="L173">                passwordPromt = true;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">            } else if(argument.startsWith(PASSWORD_KEY)) {</span>
<span class="nc" id="L175">                passwordSet = true;</span>
            }
        }
<span class="nc bnc" id="L178" title="All 4 branches missed.">        if (passwordPromt &amp;&amp; passwordSet) {</span>
            //Can't do both...
<span class="nc" id="L180">            log.error(&quot;Can't define both &quot; + PASSWORD_KEY + &quot; and specify a prompt (&quot; + PASSWORD_PROMPT_KEY + &quot;)&quot;);</span>
<span class="nc" id="L181">            return CommandResult.CLI_FAILURE;</span>
        }
        
        try {
<span class="nc" id="L185">            ParameterContainer parameters = parameterHandler.parseParameters(arguments);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if(parameters == null) {</span>
                //Parameters couldn't be parsed, but this should already be handled. 
<span class="nc" id="L188">                return CommandResult.CLI_FAILURE;</span>
            }
            
<span class="nc" id="L191">            ParameterContainer strippedParameters = stripUsernameAndPasswordFromParameters(parameters);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (getAuthenticationToken() == null) {</span>
<span class="nc" id="L193">                log.error(&quot;ERROR: username/password not found.&quot;);</span>
<span class="nc" id="L194">                log.error(PASSWORD_MAN_TEXT);</span>
<span class="nc" id="L195">                return CommandResult.AUTHORIZATION_FAILURE;</span>
            }
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (strippedParameters.containsKey(ParameterHandler.HELP_KEY)) {</span>
<span class="nc" id="L198">                printManPage();</span>
<span class="nc" id="L199">                return CommandResult.SUCCESS;</span>
            } else {
<span class="nc" id="L201">                return execute(strippedParameters);</span>
            }
<span class="nc" id="L203">        } catch (CliUsernameException e) {</span>
<span class="nc" id="L204">            log.error(&quot;ERROR: &quot; + e.getMessage());</span>
<span class="nc" id="L205">            log.error(PASSWORD_MAN_TEXT);</span>
<span class="nc" id="L206">            return CommandResult.AUTHORIZATION_FAILURE;</span>
<span class="nc" id="L207">        } catch (CliAuthenticationFailedException e) {</span>
<span class="nc" id="L208">            log.error(&quot;ERROR: &quot; + e.getMessage());</span>
<span class="nc" id="L209">            log.error(PASSWORD_MAN_TEXT);</span>
<span class="nc" id="L210">            return CommandResult.AUTHORIZATION_FAILURE;</span>
        }
    }

    /**
     * This utility method gets an authenticated CliAuthenticationToken from the
     * authentication service.
     * 
     * Worth noting in this method is that the password is not sent as a
     * credential, because this would imply sending it (or its hash) in
     * cleartext over the network. Instead, it's only sent as part of a SHA1
     * hash (as part of the CliAuthenticationToken specification). Actual check
     * of the password's validity will formally occur at the first time that the
     * authentication token is checked for authorization.
     * 
     * Note also that the CliAuthenticationToken may only be used for a single
     * call via remote. I.e once it's passed through the network once, it's
     * invalid for further use.
     * 
     * 
     * @return a single use CliAuthenticationToken.
     */
    protected AuthenticationToken getAuthenticationToken() {
<span class="nc" id="L233">        Set&lt;Principal&gt; principals = new HashSet&lt;Principal&gt;();</span>
<span class="nc" id="L234">        principals.add(new UsernamePrincipal(username));</span>

<span class="nc" id="L236">        AuthenticationSubject subject = new AuthenticationSubject(principals, null);</span>

<span class="nc" id="L238">        CliAuthenticationToken authenticationToken = (CliAuthenticationToken) EjbRemoteHelper.INSTANCE.getRemoteSession(</span>
<span class="nc" id="L239">                CliAuthenticationProviderSessionRemote.class).authenticate(subject);       </span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (authenticationToken == null) {</span>
<span class="nc" id="L241">            return null;</span>
        } else {
            // Set hashed value anew in order to send back
<span class="nc" id="L244">            authenticationToken.setSha1HashFromCleartextPassword(password);</span>
<span class="nc" id="L245">            return authenticationToken;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>