<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>NoConflictCertificateData.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-entity</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate</a> &gt; <span class="el_source">NoConflictCertificateData.java</span></div><h1>NoConflictCertificateData.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate;

import java.io.Serializable;
import javax.persistence.ColumnResult;
import javax.persistence.Entity;
import javax.persistence.PostLoad;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.SqlResultSetMapping;
import javax.persistence.SqlResultSetMappings;
import javax.persistence.Table;
import javax.persistence.Transient;
import org.apache.log4j.Logger;
import org.cesecore.dbprotection.ProtectionStringBuilder;
import org.cesecore.util.CertTools;
import org.cesecore.util.StringTools;

/**
 * Representation of a revoked throw-away certificate and related information.
 *
 * @version $Id: NoConflictCertificateData.java 28264 2018-04-09 15:56:54Z tarmo
 *     $
 */
@Entity
@Table(name = &quot;NoConflictCertificateData&quot;)
@SqlResultSetMappings(
    value = {
      @SqlResultSetMapping(
          name = &quot;RevokedNoConflictCertInfoSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;serialNumber&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;NoConflictCertificateInfoSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;issuerDN&quot;),
            @ColumnResult(name = &quot;subjectDN&quot;),
            @ColumnResult(name = &quot;cAFingerprint&quot;),
            @ColumnResult(name = &quot;status&quot;),
            @ColumnResult(name = &quot;type&quot;),
            @ColumnResult(name = &quot;serialNumber&quot;),
            @ColumnResult(name = &quot;notBefore&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;),
            @ColumnResult(name = &quot;username&quot;),
            @ColumnResult(name = &quot;tag&quot;),
            @ColumnResult(name = &quot;certificateProfileId&quot;),
            @ColumnResult(name = &quot;endEntityProfileId&quot;),
            @ColumnResult(name = &quot;updateTime&quot;),
            @ColumnResult(name = &quot;subjectKeyId&quot;),
            @ColumnResult(name = &quot;subjectAltName&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;NoConflictCertificateInfoSubset2&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;subjectDN&quot;),
            @ColumnResult(name = &quot;cAFingerprint&quot;),
            @ColumnResult(name = &quot;status&quot;),
            @ColumnResult(name = &quot;type&quot;),
            @ColumnResult(name = &quot;notBefore&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;),
            @ColumnResult(name = &quot;username&quot;),
            @ColumnResult(name = &quot;tag&quot;),
            @ColumnResult(name = &quot;certificateProfileId&quot;),
            @ColumnResult(name = &quot;endEntityProfileId&quot;),
            @ColumnResult(name = &quot;updateTime&quot;),
            @ColumnResult(name = &quot;subjectKeyId&quot;),
            @ColumnResult(name = &quot;subjectAltName&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;NoConflictCertificateFingerprintUsernameSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;username&quot;)
          })
    })
public class NoConflictCertificateData extends BaseCertificateData
    implements Serializable {

  private static final long serialVersionUID = 1L;

  /**
   * Logger. */
<span class="fc" id="L104">  private static final Logger LOG =</span>
<span class="fc" id="L105">      Logger.getLogger(NoConflictCertificateData.class);</span>

  /** Param. */
  private String id;
  /** Param. */
  private String issuerDN;
  /** Param. */
  private String subjectDN;
  /** Param. */
<span class="nc" id="L114">  private String subjectAltName = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L116">  private String fingerprint = &quot;&quot;;</span>
  /** Param. */
  private String cAFingerprint;
  /** Param. */
<span class="nc" id="L120">  private int status = 0;</span>
  /** Param. */
<span class="nc" id="L122">  private int type = 0;</span>
  /** Param. */
  private String serialNumber;
  /** Param. */
<span class="nc" id="L126">  private Long notBefore = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L128">  private long expireDate = 0;</span>
  /** Param. */
<span class="nc" id="L130">  private long revocationDate = 0;</span>
  /** Param. */
<span class="nc" id="L132">  private int revocationReason = 0;</span>
  /** Param. */
  private String base64Cert;
  /** Param. */
  private String username;
  /** Param. */
  private String tag;
  /** Param. */
  private Integer certificateProfileId;
  /** Param. */
<span class="nc" id="L142">  private Integer endEntityProfileId = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L144">  private long updateTime = 0;</span>
  /** Param. */
  private String subjectKeyId;
  /** Param. */
<span class="nc" id="L148">  private int rowVersion = 0;</span>
  /** Param. */
  private String rowProtection;

  /**
   * Copy Constructor.
   *
   * @param copy rtiginal
   */
<span class="nc" id="L157">  public NoConflictCertificateData(final NoConflictCertificateData copy) {</span>
<span class="nc" id="L158">    setId(copy.getId());</span>
<span class="nc" id="L159">    setBase64Cert(copy.getBase64Cert());</span>
<span class="nc" id="L160">    setFingerprint(copy.getFingerprint());</span>
<span class="nc" id="L161">    setSubjectDN(copy.getSubjectDN());</span>
<span class="nc" id="L162">    setIssuerDN(copy.getIssuerDN());</span>
<span class="nc" id="L163">    setSubjectAltName(copy.getSubjectAltName());</span>
<span class="nc" id="L164">    setSerialNumber(copy.getSerialNumber());</span>
<span class="nc" id="L165">    setUsername(copy.getUsername());</span>
<span class="nc" id="L166">    setStatus(copy.getStatus());</span>
<span class="nc" id="L167">    setType(copy.getType());</span>
<span class="nc" id="L168">    setCaFingerprint(copy.getCaFingerprint());</span>
<span class="nc" id="L169">    setNotBefore(copy.getNotBefore());</span>
<span class="nc" id="L170">    setExpireDate(copy.getExpireDate());</span>
<span class="nc" id="L171">    setRevocationDate(copy.getRevocationDate());</span>
<span class="nc" id="L172">    setRevocationReason(copy.getRevocationReason());</span>
<span class="nc" id="L173">    setUpdateTime(copy.getUpdateTime());</span>
<span class="nc" id="L174">    setCertificateProfileId(copy.getCertificateProfileId());</span>
<span class="nc" id="L175">    setEndEntityProfileId(copy.getEndEntityProfileId());</span>
<span class="nc" id="L176">    setSubjectKeyId(copy.getSubjectKeyId());</span>
<span class="nc" id="L177">    setTag(copy.getTag());</span>
<span class="nc" id="L178">    setRowVersion(copy.getRowVersion());</span>
<span class="nc" id="L179">    setRowProtection(copy.getRowProtection());</span>
<span class="nc" id="L180">  }</span>

  /** Null constructor. */
<span class="nc" id="L183">  public NoConflictCertificateData() { }</span>

  /**
   * Generated GUID for the table entry.
   *
   * @return id
   */
  public String getId() {
<span class="nc" id="L191">    return id;</span>
  }

  /**
   * Generated GUID for the table entry.
   *
   * @param anId ID
   */
  public void setId(final String anId) {
<span class="nc" id="L200">    this.id = anId;</span>
<span class="nc" id="L201">  }</span>

  @Override
  public String getFingerprint() {
<span class="nc" id="L205">    return fingerprint;</span>
  }

  @Override
  public void setFingerprint(final String aFingerprint) {
<span class="nc" id="L210">    this.fingerprint = aFingerprint;</span>
<span class="nc" id="L211">  }</span>

  @Override
  public String getIssuerDN() {
<span class="nc" id="L215">    return issuerDN;</span>
  }

  @Override
  public void setIssuerDN(final String anIssuerDN) {
<span class="nc" id="L220">    this.issuerDN = anIssuerDN;</span>
<span class="nc" id="L221">  }</span>

  @Override
  public String getSubjectDN() {
<span class="nc" id="L225">    return subjectDN;</span>
  }

  /**
   * Use setSubject instead.
   *
   * @param aSubjectDN subject dn
   * @see #setSubject(String)
   */
  public void setSubjectDN(final String aSubjectDN) {
<span class="nc" id="L235">    this.subjectDN = aSubjectDN;</span>
<span class="nc" id="L236">  }</span>

  /**
   * @return Subject Alternative Name from the certificate if it was saved at
   *     the time of issuance.
   */
  @Transient
  public String getSubjectAltNameNeverNull() {
<span class="nc" id="L244">    final String asubjectAltName = getSubjectAltName();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">    return asubjectAltName == null ? &quot;&quot; : asubjectAltName;</span>
  }

  @Override
  public String getSubjectAltName() {
<span class="nc" id="L250">    return subjectAltName;</span>
  }

  /**
   * @param aSubjectAltName name
   */
  public void setSubjectAltName(final String aSubjectAltName) {
<span class="nc" id="L257">    this.subjectAltName = aSubjectAltName;</span>
<span class="nc" id="L258">  }</span>

  @Override
  public String getCaFingerprint() {
<span class="nc" id="L262">    return cAFingerprint;</span>
  }

  @Override
  public void setCaFingerprint(final String aCAFingerprint) {
<span class="nc" id="L267">    this.cAFingerprint = aCAFingerprint;</span>
<span class="nc" id="L268">  }</span>

  @Override
  public int getStatus() {
<span class="nc" id="L272">    return status;</span>
  }

  @Override
  public void setStatus(final int aStatus) {
<span class="nc" id="L277">    this.status = aStatus;</span>
<span class="nc" id="L278">  }</span>

  @Override
  public int getType() {
<span class="nc" id="L282">    return type;</span>
  }

  @Override
  public void setType(final int aType) {
<span class="nc" id="L287">    this.type = aType;</span>
<span class="nc" id="L288">  }</span>

  @Override
  public String getSerialNumber() {
<span class="nc" id="L292">    return serialNumber;</span>
  }

  @Override
  public void setSerialNumber(final String aSerialNumber) {
<span class="nc" id="L297">    this.serialNumber = aSerialNumber;</span>
<span class="nc" id="L298">  }</span>

  @Override
  public Long getNotBefore() {
<span class="nc" id="L302">    return notBefore;</span>
  }

  /**
   * @param aNotBefore start
   */
  public void setNotBefore(final Long aNotBefore) {
<span class="nc" id="L309">    this.notBefore = aNotBefore;</span>
<span class="nc" id="L310">  }</span>

  @Override
  public long getExpireDate() {
<span class="nc" id="L314">    return expireDate;</span>
  }

  @Override
  public void setExpireDate(final long anExpireDate) {
<span class="nc" id="L319">    this.expireDate = anExpireDate;</span>
<span class="nc" id="L320">  }</span>

  @Override
  public long getRevocationDate() {
<span class="nc" id="L324">    return revocationDate;</span>
  }

  @Override
  public void setRevocationDate(final long aRevocationDate) {
<span class="nc" id="L329">    this.revocationDate = aRevocationDate;</span>
<span class="nc" id="L330">  }</span>

  @Override
  public int getRevocationReason() {
<span class="nc" id="L334">    return revocationReason;</span>
  }

  @Override
  public void setRevocationReason(final int aRevocationReason) {
<span class="nc" id="L339">    this.revocationReason = aRevocationReason;</span>
<span class="nc" id="L340">  }</span>

  @Override
  public String getBase64Cert() {
<span class="nc" id="L344">    return this.getZzzBase64Cert();</span>
  }

  /**
   * The certificate itself.
   *
   * @param aBase64Cert base64 encoded certificate
   */
  public void setBase64Cert(final String aBase64Cert) {
<span class="nc" id="L353">    this.setZzzBase64Cert(aBase64Cert);</span>
<span class="nc" id="L354">  }</span>

  /**
   * Horrible work-around due to the fact that Oracle needs to have (LONG and)
   * CLOB values last in order to avoid ORA-24816.
   *
   * &lt;p&gt;Since Hibernate sorts columns by the property names, naming this
   * Z-something will apparently ensure that this column is used last.
   *
   * @return string
   * @deprecated Use {@link #getBase64Cert()} instead
   */
  @Deprecated
  public String getZzzBase64Cert() {
<span class="nc" id="L368">    return base64Cert;</span>
  }

  /**
   * @param zzzBase64Cert string
   * @deprecated Use {@link #setBase64Cert(String)} instead
   */
  @Deprecated
  public void setZzzBase64Cert(final String zzzBase64Cert) {
<span class="nc" id="L377">    this.base64Cert = zzzBase64Cert;</span>
<span class="nc" id="L378">  }</span>

  @Override
  public String getUsername() {
<span class="nc" id="L382">    return username;</span>
  }

  @Override
  public void setUsername(final String aUsername) {
<span class="nc" id="L387">    this.username = StringTools.stripUsername(aUsername);</span>
<span class="nc" id="L388">  }</span>

  @Override
  public String getTag() {
<span class="nc" id="L392">    return tag;</span>
  }

  /**
   * tag in database. This field was added for the 3.9.0 release, but is not
   * used yet.
   *
   * @param aTag tag
   */
  public void setTag(final String aTag) {
<span class="nc" id="L402">    this.tag = aTag;</span>
<span class="nc" id="L403">  }</span>

  @Override
  public Integer getCertificateProfileId() {
<span class="nc" id="L407">    return certificateProfileId;</span>
  }

  @Override
  public void setCertificateProfileId(final Integer aCertificateProfileId) {
<span class="nc" id="L412">    this.certificateProfileId = aCertificateProfileId;</span>
<span class="nc" id="L413">  }</span>

  @Override
  public Long getUpdateTime() {
<span class="nc" id="L417">    return updateTime;</span>
  }

  // Hibernate + Oracle ignores nullable=false so we can expect null-objects as
  // input after upgrade. TODO: Verify if still true!
  @Override
  public void setUpdateTime(final Long anUpdateTime) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">    this.updateTime = (anUpdateTime == null ? this.updateTime : anUpdateTime);</span>
<span class="nc" id="L425">  }</span>

  @Override
  public String getSubjectKeyId() {
<span class="nc" id="L429">    return subjectKeyId;</span>
  }

  /**
   * The ID of the public key of the certificate.
   *
   * @param aSubjectKeyId ID
   */
  public void setSubjectKeyId(final String aSubjectKeyId) {
<span class="nc" id="L438">    this.subjectKeyId = aSubjectKeyId;</span>
<span class="nc" id="L439">  }</span>

  @Override
  public int getRowVersion() {
<span class="nc" id="L443">    return rowVersion;</span>
  }

  /**
   * @param aRowVersion version
   */
  public void setRowVersion(final int aRowVersion) {
<span class="nc" id="L450">    this.rowVersion = aRowVersion;</span>
<span class="nc" id="L451">  }</span>

  @Override
  public String getRowProtection() {
<span class="nc" id="L455">    return this.getZzzRowProtection();</span>
  }

  @Override
  public void setRowProtection(final String aRowProtection) {
<span class="nc" id="L460">    this.setZzzRowProtection(aRowProtection);</span>
<span class="nc" id="L461">  }</span>

  /**
   * Horrible work-around due to the fact that Oracle needs to have (LONG and)
   * CLOB values last in order to avoid ORA-24816.
   *
   * &lt;p&gt;Since Hibernate sorts columns by the property names, naming this
   * Z-something will apparently ensure that this column is used last.
   *
   * @return String
   * @deprecated Use {@link #getRowProtection()} instead
   */
  @Deprecated
  public String getZzzRowProtection() {
<span class="nc" id="L475">    return rowProtection;</span>
  }
  /**
   * @param zzzRowProtection String
   * @deprecated Use {@link #setRowProtection(String)} instead
   */
  @Deprecated
  public void setZzzRowProtection(final String zzzRowProtection) {
<span class="nc" id="L483">    this.rowProtection = zzzRowProtection;</span>
<span class="nc" id="L484">  }</span>

  @Override
  public void setIssuer(final String dn) {
<span class="nc" id="L488">    setIssuerDN(CertTools.stringToBCDNString(dn));</span>
<span class="nc" id="L489">  }</span>

  @Override
  public void setSubject(final String dn) {
<span class="nc" id="L493">    setSubjectDN(CertTools.stringToBCDNString(dn));</span>
<span class="nc" id="L494">  }</span>

  @Override
  public void setEndEntityProfileId(final Integer anEndEntityProfileId) {
<span class="nc" id="L498">    this.endEntityProfileId = anEndEntityProfileId;</span>
<span class="nc" id="L499">  }</span>

  @Override
  public Integer getEndEntityProfileId() {
<span class="nc" id="L503">    return endEntityProfileId;</span>
  }

  // Comparators

  @Override
  public boolean equals(final Object obj) {
<span class="nc bnc" id="L510" title="All 2 branches missed.">    if (!(obj instanceof NoConflictCertificateData)) {</span>
<span class="nc" id="L511">      return false;</span>
    }
<span class="nc" id="L513">    return equals((NoConflictCertificateData) obj, true);</span>
  }

  /**
   * @param certificateData data
   * @param mode mode
   * @param strictStatus status
   * @return bool
   */
  public boolean equals(
      final NoConflictCertificateData certificateData,
      final boolean mode,
      final boolean strictStatus) {
<span class="nc bnc" id="L526" title="All 2 branches missed.">    if (mode) {</span>
<span class="nc" id="L527">      return equalsNonSensitive(certificateData, strictStatus);</span>
    }
<span class="nc" id="L529">    return equals(certificateData, strictStatus);</span>
  }

  private boolean equals(
      final NoConflictCertificateData certificateData,
      final boolean strictStatus) {
<span class="nc bnc" id="L535" title="All 2 branches missed.">    if (!equalsNonSensitive(certificateData, strictStatus)) {</span>
<span class="nc" id="L536">      return false;</span>
    }
<span class="nc bnc" id="L538" title="All 4 branches missed.">    if (this.base64Cert == null &amp;&amp; certificateData.base64Cert == null) {</span>
<span class="nc" id="L539">      return true; // test before shows that fingerprint is equal and then both</span>
                   // objects must refer to same row in Base64CertData
    }
<span class="nc bnc" id="L542" title="All 4 branches missed.">    if (this.base64Cert == null || certificateData.base64Cert == null) {</span>
<span class="nc" id="L543">      return false; // one is null and the other not null</span>
    }
<span class="nc bnc" id="L545" title="All 2 branches missed.">    if (!this.base64Cert.equals(certificateData.base64Cert)) {</span>
<span class="nc" id="L546">      return false;</span>
    }
<span class="nc" id="L548">    return true;</span>
  }

  private boolean equalsNonSensitive(
      final NoConflictCertificateData certificateData,
      final boolean strictStatus) {

<span class="nc bnc" id="L555" title="All 2 branches missed.">    if (!id.equals(certificateData.id)) {</span>
<span class="nc" id="L556">      return false;</span>
    }
<span class="nc bnc" id="L558" title="All 2 branches missed.">    if (!issuerDN.equals(certificateData.issuerDN)) {</span>
<span class="nc" id="L559">      return false;</span>
    }
<span class="nc bnc" id="L561" title="All 2 branches missed.">    if (!subjectDN.equals(certificateData.subjectDN)) {</span>
<span class="nc" id="L562">      return false;</span>
    }
<span class="nc bnc" id="L564" title="All 2 branches missed.">    if (!fingerprint.equals(certificateData.fingerprint)) {</span>
<span class="nc" id="L565">      return false;</span>
    }
<span class="nc bnc" id="L567" title="All 2 branches missed.">    if (!cAFingerprint.equals(certificateData.cAFingerprint)) {</span>
<span class="nc" id="L568">      return false;</span>
    }
<span class="nc bnc" id="L570" title="All 2 branches missed.">    if (!equalsStatus(certificateData, strictStatus)) {</span>
<span class="nc" id="L571">      return false;</span>
    }
<span class="nc bnc" id="L573" title="All 2 branches missed.">    if (type != certificateData.type) {</span>
<span class="nc" id="L574">      return false;</span>
    }
<span class="nc bnc" id="L576" title="All 2 branches missed.">    if (!serialNumber.equals(certificateData.serialNumber)) {</span>
<span class="nc" id="L577">      return false;</span>
    }
<span class="nc bnc" id="L579" title="All 2 branches missed.">    if (notBefore == null) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">      if (certificateData.notBefore != null) {</span>
<span class="nc" id="L581">        return false;</span>
      }
    } else {
<span class="nc bnc" id="L584" title="All 2 branches missed.">      if (!notBefore.equals(certificateData.notBefore)) {</span>
<span class="nc" id="L585">        return false;</span>
      }
    }
<span class="nc bnc" id="L588" title="All 2 branches missed.">    if (expireDate != certificateData.expireDate) {</span>
<span class="nc" id="L589">      return false;</span>
    }
<span class="nc bnc" id="L591" title="All 2 branches missed.">    if (revocationDate != certificateData.revocationDate) {</span>
<span class="nc" id="L592">      return false;</span>
    }
<span class="nc bnc" id="L594" title="All 2 branches missed.">    if (revocationReason != certificateData.revocationReason) {</span>
<span class="nc" id="L595">      return false;</span>
    }
<span class="nc bnc" id="L597" title="All 2 branches missed.">    if (!username.equals(certificateData.username)) {</span>
<span class="nc" id="L598">      return false;</span>
    }
<span class="nc bnc" id="L600" title="All 4 branches missed.">    if (tag == null &amp;&amp; certificateData.tag != null) {</span>
<span class="nc" id="L601">      return false;</span>
    }
<span class="nc bnc" id="L603" title="All 4 branches missed.">    if (tag != null &amp;&amp; !tag.equals(certificateData.tag)) {</span>
<span class="nc" id="L604">      return false;</span>
    }
<span class="nc bnc" id="L606" title="All 4 branches missed.">    if (certificateProfileId == null</span>
        &amp;&amp; certificateData.certificateProfileId != null) {
<span class="nc" id="L608">      return false;</span>
    }
<span class="nc bnc" id="L610" title="All 2 branches missed.">    if (certificateProfileId != null</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">        &amp;&amp; !certificateProfileId.equals(certificateData.certificateProfileId)) {</span>
<span class="nc" id="L612">      return false;</span>
    }
<span class="nc bnc" id="L614" title="All 2 branches missed.">    if (endEntityProfileId == null) {</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">      if (certificateData.endEntityProfileId != null) {</span>
<span class="nc" id="L616">        return false;</span>
      }
    } else {
<span class="nc bnc" id="L619" title="All 2 branches missed.">      if (!endEntityProfileId.equals(certificateData.endEntityProfileId)) {</span>
<span class="nc" id="L620">        return false;</span>
      }
    }
<span class="nc bnc" id="L623" title="All 2 branches missed.">    if (updateTime != certificateData.updateTime) {</span>
<span class="nc" id="L624">      return false;</span>
    }
<span class="nc bnc" id="L626" title="All 2 branches missed.">    if (subjectAltName == null) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">      if (certificateData.subjectAltName != null) {</span>
<span class="nc" id="L628">        return false;</span>
      }
    } else {
<span class="nc bnc" id="L631" title="All 2 branches missed.">      if (!subjectAltName.equals(certificateData.subjectAltName)) {</span>
<span class="nc" id="L632">        return false;</span>
      }
    }
<span class="nc" id="L635">    return true;</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L640">    return fingerprint.hashCode() * 11;</span>
  }

  /**
   * @param certificateData Data
   * @param inclusionMode Mode
   */
  public void updateWith(
      final NoConflictCertificateData certificateData,
      final boolean inclusionMode) {
<span class="nc" id="L650">    issuerDN = certificateData.issuerDN;</span>
<span class="nc" id="L651">    subjectDN = certificateData.subjectDN;</span>
<span class="nc" id="L652">    fingerprint = certificateData.fingerprint;</span>
<span class="nc" id="L653">    cAFingerprint = certificateData.cAFingerprint;</span>
<span class="nc" id="L654">    status = certificateData.status;</span>
<span class="nc" id="L655">    type = certificateData.type;</span>
<span class="nc" id="L656">    serialNumber = certificateData.serialNumber;</span>
<span class="nc" id="L657">    expireDate = certificateData.expireDate;</span>
<span class="nc" id="L658">    revocationDate = certificateData.revocationDate;</span>
<span class="nc" id="L659">    revocationReason = certificateData.revocationReason;</span>
<span class="nc" id="L660">    setUsername(certificateData.username);</span>
<span class="nc" id="L661">    tag = certificateData.tag;</span>
<span class="nc" id="L662">    certificateProfileId = certificateData.certificateProfileId;</span>
<span class="nc" id="L663">    updateTime = certificateData.updateTime;</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">    base64Cert = inclusionMode ? null : certificateData.base64Cert;</span>
<span class="nc" id="L665">    id = certificateData.id;</span>
<span class="nc" id="L666">  }</span>

  //
  // Start Database integrity protection methods
  //

  @Transient
  @Override
  protected String getProtectString(final int version) {
<span class="nc" id="L675">    final int cap = 3000;</span>
<span class="nc" id="L676">    final ProtectionStringBuilder build = new ProtectionStringBuilder(cap);</span>
    // What is important to protect here is the data that we define, id, name
    // and certificate profile data
    // rowVersion is automatically updated by JPA, so it's not important, it is
    // only used for optimistic locking
<span class="nc" id="L681">    build.append(getFingerprint()).append(getIssuerDN());</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">    if (version &gt;= 3) {</span>
      // From version 3 for EJBCA 6.7 we always use empty String here to allow
      // future migration between databases when this value is unset
<span class="nc" id="L685">      build.append(getSubjectDnNeverNull());</span>
    } else {
<span class="nc" id="L687">      build.append(getSubjectDN());</span>
    }
<span class="nc" id="L689">    build</span>
<span class="nc" id="L690">        .append(getCaFingerprint())</span>
<span class="nc" id="L691">        .append(getStatus())</span>
<span class="nc" id="L692">        .append(getType())</span>
<span class="nc" id="L693">        .append(getSerialNumber())</span>
<span class="nc" id="L694">        .append(getExpireDate())</span>
<span class="nc" id="L695">        .append(getRevocationDate())</span>
<span class="nc" id="L696">        .append(getRevocationReason())</span>
<span class="nc" id="L697">        .append(getBase64Cert())</span>
<span class="nc" id="L698">        .append(getUsername())</span>
<span class="nc" id="L699">        .append(getTag())</span>
<span class="nc" id="L700">        .append(getCertificateProfileId())</span>
<span class="nc" id="L701">        .append(getUpdateTime())</span>
<span class="nc" id="L702">        .append(getSubjectKeyId());</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">    if (version &gt;= 2) {</span>
      // In version 2 for EJBCA 6.6 the following columns where added
<span class="nc" id="L705">      build.append(String.valueOf(getNotBefore()));</span>
<span class="nc" id="L706">      build.append(String.valueOf(getEndEntityProfileId()));</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">      if (version &gt;= 3) {</span>
        // From version 3 for EJBCA 6.7 we always use empty String here to allow
        // future migration between databases when this value is unset
<span class="nc" id="L710">        build.append(getSubjectAltNameNeverNull());</span>
      } else {
<span class="nc" id="L712">        build.append(String.valueOf(getSubjectAltName()));</span>
      }
    }
<span class="nc bnc" id="L715" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
      // Some profiling
<span class="nc bnc" id="L717" title="All 2 branches missed.">      if (build.length() &gt; cap) {</span>
<span class="nc" id="L718">        LOG.debug(</span>
<span class="nc" id="L719">            &quot;CertificateData.getProtectString gives size: &quot; + build.length());</span>
      }
    }
<span class="nc" id="L722">    return build.toString();</span>
  }

  @Transient
  @Override
  protected int getProtectVersion() {
<span class="nc" id="L728">    final int version = 3;</span>
<span class="nc" id="L729">    return version;</span>
  }

  @PrePersist
  @PreUpdate
  @Override
  protected void protectData() {
<span class="nc" id="L736">    super.protectData();</span>
<span class="nc" id="L737">  }</span>

  @PostLoad
  @Override
  protected void verifyData() {
<span class="nc" id="L742">    super.verifyData();</span>
<span class="nc" id="L743">  }</span>

  @Override
  @Transient
  protected String getRowId() {
<span class="nc" id="L748">    return getFingerprint();</span>
  }

  //
  // End Database integrity protection methods
  //
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>