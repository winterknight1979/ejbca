<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>X509ResponseMessage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-ejb-interface</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate.request</a> &gt; <span class="el_source">X509ResponseMessage.java</span></div><h1>X509ResponseMessage.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate.request;

import java.security.PrivateKey;
import java.security.cert.CRL;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.util.Collection;
import java.util.List;
import org.apache.log4j.Logger;
import org.cesecore.certificates.certificate.Base64CertData;
import org.cesecore.certificates.certificate.CertificateData;
import org.cesecore.util.CertTools;

/**
 * A response message consisting of a single X509 or CVC Certificate. Name is
 * nowadays slightly misleading since the class can care any type of
 * &quot;Certificate&quot;, for example a CV certificate.
 *
 * @version $Id: X509ResponseMessage.java 28201 2018-02-07 08:33:29Z
 *     andresjakobs $
 */
<span class="nc" id="L35">public class X509ResponseMessage implements CertificateResponseMessage {</span>
  /**
   * Determines if a de-serialized file is compatible with this class.
   *
   * &lt;p&gt;Maintainers must change this value if and only if the new version of
   * this class is not compatible with old versions. See Sun docs for &lt;a
   * href=http://java.sun.com/products/jdk/1.1/docs/guide
   * /serialization/spec/version.doc.html&gt; details. &lt;/a&gt;
   */
  static final long serialVersionUID = -2157072605987735913L;

  /** Logger. */
<span class="fc" id="L47">  private static Logger log = Logger.getLogger(X509ResponseMessage.class);</span>

  /** Certificate to be in response message. */
<span class="nc" id="L50">  private byte[] certbytes = null;</span>

  /** status for the response. */
<span class="nc" id="L53">  private ResponseStatus status = ResponseStatus.SUCCESS;</span>

  /** Possible fail information in the response. Defaults to null. */
<span class="nc" id="L56">  private FailInfo failInfo = null;</span>

  /**
   * Possible clear text error information in the response. Defaults to null.
   */
<span class="nc" id="L61">  private String failText = null;</span>
  /** Cert. */
  private transient Certificate certificate;
  /** Data. */
  private transient CertificateData certificateData;
  /** Data. */
  private transient Base64CertData base64CertData;

  @Override
  public CertificateData getCertificateData() {
<span class="nc" id="L71">    return certificateData;</span>
  }

  @Override
  public void setCertificateData(final CertificateData theCertificateData) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">    if (theCertificateData != null) {</span>
<span class="nc" id="L77">      this.certificateData = new CertificateData(theCertificateData);</span>
    } else {
<span class="nc" id="L79">      this.certificateData = null;</span>
    }
<span class="nc" id="L81">  }</span>

  @Override
  public Base64CertData getBase64CertData() {
<span class="nc" id="L85">    return base64CertData;</span>
  }

  @Override
  public void setBase64CertData(final Base64CertData theBase64CertData) {
<span class="nc bnc" id="L90" title="All 2 branches missed.">    if (theBase64CertData != null) {</span>
<span class="nc" id="L91">      this.base64CertData = new Base64CertData(theBase64CertData);</span>
    } else {
<span class="nc" id="L93">      this.base64CertData = null;</span>
    }
<span class="nc" id="L95">  }</span>

  /**
   * Sets the complete certificate in the response message.
   *
   * @param aCertificate certificate in the response message.
   */
  @Override
  public void setCertificate(final Certificate aCertificate) {
<span class="nc" id="L104">    this.certificate = aCertificate;</span>
    try {
<span class="nc" id="L106">      this.certbytes = aCertificate.getEncoded();</span>
<span class="nc" id="L107">    } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L108">      throw new Error(</span>
          &quot;Could not encode certificate. This should not happen&quot;, e);
<span class="nc" id="L110">    }</span>
<span class="nc" id="L111">  }</span>

  @Override
  public void setCrl(final CRL crl) {
    // This message type does not contain a CRL
<span class="nc" id="L116">  }</span>

  @Override
  public void setIncludeCACert(final boolean incCACert) {
    // Do nothing, not applicable
<span class="nc" id="L121">  }</span>

  @Override
<span class="nc" id="L124">  public void setCACert(final Certificate cACert) { }</span>

  @Override
  public Certificate getCertificate() {
    // Deserialize certificate using BC if this entire object has been
    // serialized
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (certificate == null) {</span>
      try {
<span class="nc" id="L132">        certificate =</span>
<span class="nc" id="L133">            CertTools.getCertfromByteArray(certbytes, Certificate.class);</span>
<span class="nc" id="L134">      } catch (CertificateException e) {</span>
<span class="nc" id="L135">        throw new Error(</span>
            &quot;Response was created without containing valid certificate. This&quot;
                + &quot; should not happen&quot;,
            e);
<span class="nc" id="L139">      }</span>
    }
<span class="nc" id="L141">    return certificate;</span>
  }

  @Override
  public byte[] getResponseMessage() throws CertificateEncodingException {
<span class="nc" id="L146">    return certbytes;</span>
  }

  /**
   * Sets the status of the response message.
   *
   * @param theStatus status of the response.
   */
  @Override
  public void setStatus(final ResponseStatus theStatus) {
<span class="nc" id="L156">    this.status = theStatus;</span>
<span class="nc" id="L157">  }</span>

  /**
   * Gets the status of the response message.
   *
   * @return status status of the response.
   */
  @Override
  public ResponseStatus getStatus() {
<span class="nc" id="L166">    return status;</span>
  }

  /**
   * Sets info about reason for failure.
   *
   * @param theFailInfo reason for failure.
   */
  @Override
  public void setFailInfo(final FailInfo theFailInfo) {
<span class="nc" id="L176">    this.failInfo = theFailInfo;</span>
<span class="nc" id="L177">  }</span>

  /**
   * Gets info about reason for failure.
   *
   * @return failInfo reason for failure.
   */
  @Override
  public FailInfo getFailInfo() {
<span class="nc" id="L186">    return failInfo;</span>
  }

  @Override
  public void setFailText(final String theFailText) {
<span class="nc" id="L191">    this.failText = theFailText;</span>
<span class="nc" id="L192">  }</span>

  @Override
  public String getFailText() {
<span class="nc" id="L196">    return failText;</span>
  }

  /**
   * Create encrypts and creates signatures as needed to produce a complete
   * response message. If needed setSignKeyInfo must be called before this
   * method. After this is called the response message can be retrieved with
   * getResponseMessage();
   *
   * @return True if signature/encryption was successful, false if it failed,
   *     request should not be sent back i failed.
   * @see #setSignKeyInfo
   */
  @Override
  public boolean create() {

<span class="nc bnc" id="L212" title="All 2 branches missed.">    if (status.equals(ResponseStatus.SUCCESS)) {</span>
<span class="nc" id="L213">      log.debug(&quot;Creating a STATUS_OK message.&quot;);</span>
    } else {
<span class="nc bnc" id="L215" title="All 2 branches missed.">      if (status.equals(ResponseStatus.FAILURE)) {</span>
<span class="nc" id="L216">        log.debug(</span>
            &quot;Creating a STATUS_FAILED message (or throwing an exception).&quot;);
<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (failInfo.equals(FailInfo.WRONG_AUTHORITY)) {</span>
<span class="nc" id="L219">          return false;</span>
        }
<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (failInfo.equals(FailInfo.INCORRECT_DATA)) {</span>
<span class="nc" id="L222">          return false;</span>
        }
      } else {
<span class="nc" id="L225">        log.debug(&quot;Creating a STATUS_PENDING message.&quot;);</span>
      }
    }
<span class="nc" id="L228">    return true;</span>
  }

  /**
   * indicates if this message needs recipients public and private key to sign.
   * If this returns true, setSignKeyInfo() should be called.
   *
   * @return True if public and private key is needed.
   */
  @Override
  public boolean requireSignKeyInfo() {
<span class="nc" id="L239">    return false;</span>
  }

  @Override
  public void setSignKeyInfo(
      final Collection&lt;Certificate&gt; certs,
      final PrivateKey key,
<span class="nc" id="L246">      final String provider) { }</span>

  @Override
<span class="nc" id="L249">  public void setSenderNonce(final String senderNonce) { }</span>

  @Override
<span class="nc" id="L252">  public void setRecipientNonce(final String recipientNonce) { }</span>

  @Override
<span class="nc" id="L255">  public void setTransactionId(final String transactionId) { }</span>

  @Override
<span class="nc" id="L258">  public void setRecipientKeyInfo(final byte[] recipientKeyInfo) { }</span>

  @Override
<span class="nc" id="L261">  public void setPreferredDigestAlg(final String digest) { }</span>

  @Override
<span class="nc" id="L264">  public void setRequestType(final int reqtype) { }</span>

  @Override
<span class="nc" id="L267">  public void setRequestId(final int reqid) { }</span>

  @Override
<span class="nc" id="L270">  public void setProtectionParamsFromRequest(final RequestMessage reqMsg) { }</span>

  @Override
  public void addAdditionalCaCertificates(
      final List&lt;Certificate&gt; certificates) {
    // NOOP. Only for CMP.
<span class="nc" id="L276">  }</span>

  @Override
  public void addAdditionalResponseExtraCertsCertificates(
      final List&lt;Certificate&gt; certificates) {
    // NOOP. Only for CMP.
<span class="nc" id="L282">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>