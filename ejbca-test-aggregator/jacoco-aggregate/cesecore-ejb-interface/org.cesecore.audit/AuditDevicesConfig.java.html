<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AuditDevicesConfig.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-ejb-interface</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.audit</a> &gt; <span class="el_source">AuditDevicesConfig.java</span></div><h1>AuditDevicesConfig.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.audit;

import java.io.File;
import java.io.IOException;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.concurrent.locks.ReentrantLock;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.commons.configuration.Configuration;
import org.apache.commons.lang.time.FastDateFormat;
import org.apache.log4j.Logger;
import org.cesecore.audit.audit.AuditExporter;
import org.cesecore.audit.impl.AuditExporterDummy;
import org.cesecore.config.ConfigurationHolder;
import org.cesecore.util.ValidityDate;

/**
 * Parses configuration related to the log devices.
 *
 * &lt;p&gt;Custom properties for each device is reformatted. E.g.
 * &quot;securityeventsaudit.deviceproperty.1.key1.key2=value&quot; is available to the
 * log device implementation 1 as &quot;key1.key2=value&quot;
 *
 * @version $Id: AuditDevicesConfig.java 17625 2013-09-20 07:12:06Z netmackan $
 */
public final class AuditDevicesConfig {

    private AuditDevicesConfig() { }
    /** Logger. */
<span class="nc" id="L48">  private static final Logger LOG = Logger.getLogger(AuditDevicesConfig.class);</span>
  /** Thread lock. */
<span class="nc" id="L50">  private static final ReentrantLock LOCK = new ReentrantLock(false);</span>
  /** Loggers. */
<span class="nc" id="L52">  private static Map&lt;String, AuditLogDevice&gt; loggers = null;</span>
  /** Exporters. */
<span class="nc" id="L54">  private static final Map&lt;String, Class&lt;? extends AuditExporter&gt;&gt; EXPORTERS =</span>
      new HashMap&lt;String, Class&lt;? extends AuditExporter&gt;&gt;();
  /** Props. */
<span class="nc" id="L57">  private static final Map&lt;String, Properties&gt; DEVICE_PROPERTIES =</span>
      new HashMap&lt;String, Properties&gt;();

  private static Map&lt;String, AuditLogDevice&gt; getLoggers() {
<span class="nc" id="L61">    setup();</span>
<span class="nc" id="L62">    return loggers;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  private static void setup() {
    try {
<span class="nc" id="L68">      LOCK.lock();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      if (loggers == null) {</span>
<span class="nc" id="L70">        loggers = new HashMap&lt;String, AuditLogDevice&gt;();</span>
<span class="nc" id="L71">        final Configuration conf = ConfigurationHolder.instance();</span>
<span class="nc" id="L72">        final String deviceClassRoot = &quot;securityeventsaudit.implementation.&quot;;</span>
<span class="nc" id="L73">        final String exporterClassRoot = &quot;securityeventsaudit.exporter.&quot;;</span>
        // Extract custom properties configured for any device, to avoid lookup
        // for each device later on..
        // Default devices should not require configuring of 'deviceproperty' in
        // defaultvalues.properties,
        // since the below Iterator does not read from default values.
<span class="nc" id="L79">        final String deviceProperty =</span>
            &quot;securityeventsaudit\\.deviceproperty\\.(\\d+)\\.(.+)&quot;;
<span class="nc" id="L81">        final Map&lt;Integer, Properties&gt; allDeviceProperties =</span>
            new HashMap&lt;Integer, Properties&gt;();
<span class="nc" id="L83">        final Iterator&lt;String&gt; iterator = conf.getKeys();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L85">          final String currentKey = iterator.next();</span>
<span class="nc" id="L86">          Pattern pattern = Pattern.compile(deviceProperty);</span>
<span class="nc" id="L87">          Matcher matcher = pattern.matcher(currentKey);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">          if (matcher.matches()) {</span>
<span class="nc" id="L89">            final Integer deviceConfId = Integer.parseInt(matcher.group(1));</span>
<span class="nc" id="L90">            Properties thedeviceProperties =</span>
<span class="nc" id="L91">                    allDeviceProperties.get(deviceConfId);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (thedeviceProperties == null) {</span>
<span class="nc" id="L93">              thedeviceProperties = new Properties();</span>
            }
<span class="nc" id="L95">            final String devicePropertyName = matcher.group(2);</span>
<span class="nc" id="L96">            final String devicePropertyValue = conf.getString(currentKey);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L98">              LOG.debug(</span>
                  &quot;deviceConfId=&quot;
<span class="nc" id="L100">                      + deviceConfId.toString()</span>
                      + &quot; &quot;
                      + devicePropertyName
                      + &quot;=&quot;
                      + devicePropertyValue);
            }
<span class="nc" id="L106">            thedeviceProperties.put(devicePropertyName, devicePropertyValue);</span>
<span class="nc" id="L107">            allDeviceProperties.put(deviceConfId, thedeviceProperties);</span>
          }
<span class="nc" id="L109">        }</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (int i = 0; i &lt; 255; i++) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">          if (!checkNoDuplicateProperties(deviceClassRoot + i)) {</span>
<span class="nc" id="L112">            continue;</span>
          }
<span class="nc" id="L114">          final String deviceClass =</span>
<span class="nc" id="L115">              ConfigurationHolder.getString(deviceClassRoot + i);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">          if ((deviceClass != null)</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">              &amp;&amp; (!&quot;null&quot;.equalsIgnoreCase(deviceClass))) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L119">              LOG.debug(</span>
                  &quot;Trying to register audit device using implementation: &quot;
                      + deviceClass);
            }
            try {
              // Instantiate device
<span class="nc" id="L125">              final Class&lt;AuditLogDevice&gt; implClass =</span>
<span class="nc" id="L126">                  (Class&lt;AuditLogDevice&gt;) Class.forName(deviceClass);</span>
<span class="nc" id="L127">              final AuditLogDevice auditLogDevice =</span>
<span class="nc" id="L128">                  implClass.getConstructor().newInstance();</span>
<span class="nc" id="L129">              final String name = implClass.getSimpleName();</span>
<span class="nc" id="L130">              loggers.put(name, auditLogDevice);</span>
<span class="nc" id="L131">              LOG.info(</span>
                  &quot;Registered audit device using implementation: &quot;
                      + deviceClass);
              // Store custom properties for this device, so they are searchable
              // by name
<span class="nc bnc" id="L136" title="All 2 branches missed.">              if (!allDeviceProperties.containsKey(Integer.valueOf(i))) {</span>
<span class="nc" id="L137">                allDeviceProperties.put(Integer.valueOf(i), new Properties());</span>
              }
<span class="nc" id="L139">              DEVICE_PROPERTIES.put(</span>
<span class="nc" id="L140">                  name, allDeviceProperties.get(Integer.valueOf(i)));</span>
              // Setup an exporter for this device
<span class="nc" id="L142">              final String exporterClassName =</span>
<span class="nc" id="L143">                  ConfigurationHolder.getString(exporterClassRoot + i);</span>
<span class="nc" id="L144">              Class&lt;? extends AuditExporter&gt; exporterClass =</span>
                  AuditExporterDummy.class;
<span class="nc bnc" id="L146" title="All 2 branches missed.">              if (exporterClassName != null) {</span>
                try {
<span class="nc" id="L148">                  exporterClass =</span>
                      (Class&lt;? extends AuditExporter&gt;)
<span class="nc" id="L150">                          Class.forName(exporterClassName);</span>
<span class="nc" id="L151">                } catch (Exception e) {</span>
                  // ClassCastException, ClassNotFoundException
<span class="nc" id="L153">                  LOG.error(</span>
                      &quot;Could not configure exporter for audit device &quot;
                          + name
                          + &quot; using implementation: &quot;
                          + exporterClass,
                      e);
<span class="nc" id="L159">                }</span>
              }
<span class="nc" id="L161">              LOG.info(</span>
                  &quot;Configured exporter &quot;
<span class="nc" id="L163">                      + exporterClass.getSimpleName()</span>
                      + &quot; for device &quot;
                      + name);
<span class="nc" id="L166">              EXPORTERS.put(name, exporterClass);</span>
<span class="nc" id="L167">            } catch (Exception e) {</span>
              // ClassCastException, ClassNotFoundException,
              // InstantiationException, IllegalAccessException
<span class="nc" id="L170">              LOG.error(</span>
                  &quot;Could not creating audit device using implementation: &quot;
                      + deviceClass,
                  e);
<span class="nc" id="L174">            }</span>
          }
        }
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (loggers.isEmpty()) {</span>
<span class="nc" id="L178">          LOG.warn(&quot;No security event audit devices has been configured.&quot;);</span>
        }
      }
    } finally {
<span class="nc" id="L182">      LOCK.unlock();</span>
    }
<span class="nc" id="L184">  }</span>

  /**
   * Checks that there are no duplicate properties in the configuration.
   *
   * @param name Propertiy name
   * @return boolean
   */
  private static boolean checkNoDuplicateProperties(final String name) {
<span class="nc" id="L193">    final String[] arr = ConfigurationHolder.instance().getStringArray(name);</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">    if (arr != null &amp;&amp; arr.length &gt; 1) {</span>
<span class="nc" id="L195">      LOG.error(</span>
          &quot;Duplicate property definitions of \&quot;&quot;
              + name
              + &quot;\&quot;. All defintions (&quot;
              + arr.length
              + &quot; occurrences) of this property will be ignored.&quot;);
<span class="nc" id="L201">      return false;</span>
    }
<span class="nc" id="L203">    return true;</span>
  }

  /**
   * @return the ids of all devices that support querying as a serilizable
   *     (Hash)Set.
   */
  public static Set&lt;String&gt; getQuerySupportingDeviceIds() {
<span class="nc" id="L211">    final Set&lt;String&gt; set = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">    for (final String id : getLoggers().keySet()) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">      if (loggers.get(id).isSupportingQueries()) {</span>
<span class="nc" id="L214">        set.add(id);</span>
      }
<span class="nc" id="L216">    }</span>
<span class="nc" id="L217">    return set;</span>
  }

  /** @return the ids of all devices as a serilizable (Hash)Set. */
  public static Set&lt;String&gt; getAllDeviceIds() {
<span class="nc" id="L222">    return new HashSet&lt;String&gt;(getLoggers().keySet());</span>
  }

  /**
   * @param ejbs Beans
   * @param id ID
   * @return Device
   */
  public static AuditLogDevice getDevice(
      final Map&lt;Class&lt;?&gt;, ?&gt; ejbs, final String id) {
<span class="nc" id="L232">    final AuditLogDevice auditLogDevice = getLoggers().get(id);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">    if (auditLogDevice != null) {</span>
<span class="nc" id="L234">      auditLogDevice.setEjbs(ejbs);</span>
    }
<span class="nc" id="L236">    return auditLogDevice;</span>
  }

  /**
   * @param id ID
   * @return Exporter class
   */
  public static Class&lt;? extends AuditExporter&gt; getExporter(final String id) {
<span class="nc" id="L244">    setup();</span>
<span class="nc" id="L245">    return EXPORTERS.get(id);</span>
  }

  /**
   * @param id ID
   * @return Props
   */
  public static Properties getProperties(final String id) {
<span class="nc" id="L253">    setup();</span>
<span class="nc" id="L254">    return DEVICE_PROPERTIES.get(id);</span>
  }

  /** Format. */
  private static final String EXPORTFILE_DATE_FORMAT = &quot;yyyy-MM-dd-HHmmss&quot;;

  /**
   * @param properties Properties
   * @param exportDate Date exported
   * @return the file name of the current export.
   * @throws IOException if IO fails
   */
  public static File getExportFile(
      final Properties properties, final Date exportDate) throws IOException {
<span class="nc" id="L268">    final String p =</span>
<span class="nc" id="L269">        properties.getProperty(</span>
<span class="nc" id="L270">            &quot;export.dir&quot;, System.getProperty(&quot;java.io.tmpdir&quot;));</span>
<span class="nc" id="L271">    final File dir = new File(p);</span>
<span class="nc" id="L272">    final String file =</span>
        &quot;cesecore-&quot;
<span class="nc" id="L274">            + FastDateFormat.getInstance(</span>
                    EXPORTFILE_DATE_FORMAT, ValidityDate.TIMEZONE_UTC)
<span class="nc" id="L276">                .format(exportDate)</span>
            + &quot;.log&quot;;
<span class="nc" id="L278">    File ret = new File(dir, file);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L280">      LOG.debug(&quot;Export file: &quot; + p + file);</span>
<span class="nc" id="L281">      LOG.debug(&quot;Export file canonical: &quot; + ret.getCanonicalPath());</span>
    }
<span class="nc" id="L283">    return ret;</span>
  }

  /** Size. */
  private static final int FETCHSIZE = 1000;

  /**
   * Parameter to specify the number of logs to be fetched in each validation
   * round trip.
   *
   * @param properties Properties
   * @return log size
   */
  public static int getAuditLogValidationFetchSize(
      final Properties properties) {
<span class="nc" id="L298">    return getInt(properties, &quot;validate.fetchsize&quot;, FETCHSIZE);</span>
  }

  /**
   * Parameter to specify the number of logs to be fetched in each export round
   * trip.
   *
   * @param properties properties
   * @return log size
   */
  public static int getAuditLogExportFetchSize(final Properties properties) {
<span class="nc" id="L309">    return getInt(properties, &quot;export.fetchsize&quot;, FETCHSIZE);</span>
  }

  private static int getInt(
      final Properties properties, final String key, final int defaultValue) {
<span class="nc" id="L314">    int ret = defaultValue;</span>
    try {
<span class="nc" id="L316">      ret = Integer.valueOf(properties.getProperty(key, String.valueOf(ret)));</span>
<span class="nc" id="L317">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L318">      LOG.error(</span>
          &quot;Invalid value in &quot;
              + key
              + &quot;, must be decimal number. Using default &quot;
              + defaultValue
              + &quot;. Message: &quot;
<span class="nc" id="L324">              + e.getMessage());</span>
<span class="nc" id="L325">    }</span>
<span class="nc" id="L326">    return ret;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>