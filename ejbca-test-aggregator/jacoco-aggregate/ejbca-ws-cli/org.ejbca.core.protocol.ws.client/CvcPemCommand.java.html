<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CvcPemCommand.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-ws-cli</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.protocol.ws.client</a> &gt; <span class="el_source">CvcPemCommand.java</span></div><h1>CvcPemCommand.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.protocol.ws.client;

import java.io.FileOutputStream;
import java.io.IOException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.util.Collection;

import org.cesecore.certificates.certificate.request.RequestMessageUtils;
import org.cesecore.util.Base64;
import org.cesecore.util.CertTools;
import org.cesecore.util.CryptoProviderTools;
import org.cesecore.util.FileTools;
import org.ejbca.cvc.CVCAuthenticatedRequest;
import org.ejbca.cvc.CVCObject;
import org.ejbca.cvc.CVCertificate;
import org.ejbca.cvc.CardVerifiableCertificate;
import org.ejbca.cvc.CertificateParser;
import org.ejbca.cvc.exception.CvcException;
import org.ejbca.ui.cli.ErrorAdminCommandException;
import org.ejbca.ui.cli.IAdminCommand;
import org.ejbca.ui.cli.IllegalAdminCommandException;


/**
 * Converts a CV Certificate or certificate request to/from binary and PEM
 *
 * @version $Id: CvcPemCommand.java 22553 2016-01-11 13:06:46Z mikekushner $
 */
public class CvcPemCommand extends EJBCAWSRABaseCommand implements IAdminCommand{


	/**
	 * @param args command line arguments
	 */
	public CvcPemCommand(String[] args) {
<span class="nc" id="L50">		super(args);</span>
<span class="nc" id="L51">	}</span>

	/**
	 * Runs the command
	 *
	 * @throws IllegalAdminCommandException Error in command args
	 * @throws ErrorAdminCommandException Error running command
	 */
	public void execute() throws IllegalAdminCommandException, ErrorAdminCommandException {

		try {   
<span class="nc bnc" id="L62" title="All 4 branches missed.">			if(args.length &lt; 4 || args.length &gt; 6){</span>
<span class="nc" id="L63">				usage();</span>
<span class="nc" id="L64">				System.exit(-1); // NOPMD, this is not a JEE app</span>
			}
<span class="nc" id="L66">			CryptoProviderTools.installBCProvider();</span>
<span class="nc" id="L67">			String inform = args[1];</span>
<span class="nc" id="L68">			String infile = args[2];</span>
<span class="nc" id="L69">			String outform = args[3];</span>
<span class="nc" id="L70">			String outfile = args[4];</span>
<span class="nc" id="L71">			System.out.println(inform+infile+outform+outfile);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">			if (inform.equals(outform)) {</span>
<span class="nc" id="L73">				getPrintStream().println(&quot;No point in converting to the same format, exiting.&quot;);</span>
<span class="nc" id="L74">				return;</span>
			}
<span class="nc" id="L76">			getPrintStream().println(&quot;converting CV Certificate (&quot;+inform+&quot;): &quot;+infile+&quot; to &quot;+outform);</span>
			// Read file to a buffer and use the toString functions in the cvc-lib
<span class="nc" id="L78">			CVCObject parsedObject = getCVCObject(infile);</span>
<span class="nc" id="L79">			byte[] bytes = null;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">			if (parsedObject instanceof CVCAuthenticatedRequest) {</span>
<span class="nc" id="L81">				CVCAuthenticatedRequest authreq = (CVCAuthenticatedRequest)parsedObject;</span>
<span class="nc" id="L82">				bytes = authreq.getDEREncoded();</span>
<span class="nc" id="L83">			} else {</span>
<span class="nc" id="L84">				CVCertificate cert1 = (CVCertificate)parsedObject;</span>
<span class="nc" id="L85">				CardVerifiableCertificate cvcert = new CardVerifiableCertificate(cert1);</span>
<span class="nc" id="L86">				bytes = cvcert.getEncoded();</span>
			}
<span class="nc bnc" id="L88" title="All 2 branches missed.">			if (&quot;pem&quot;.equalsIgnoreCase(outform)) {</span>
<span class="nc" id="L89">				byte[] b64 = Base64.encode(bytes);</span>
<span class="nc" id="L90">				FileOutputStream fos = new FileOutputStream(outfile);</span>
<span class="nc" id="L91">				String begin = CertTools.BEGIN_CERTIFICATE;</span>
<span class="nc" id="L92">				String end = CertTools.END_CERTIFICATE;</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">				if (args.length &gt; 5 &amp;&amp; args[5].equals(&quot;-req&quot;)) {					</span>
<span class="nc" id="L94">					begin = CertTools.BEGIN_CERTIFICATE_REQUEST;</span>
<span class="nc" id="L95">					end = CertTools.END_CERTIFICATE_REQUEST;</span>
				}
<span class="nc" id="L97">				fos.write((begin+&quot;\n&quot;).getBytes());</span>
<span class="nc" id="L98">				fos.write(b64);</span>
<span class="nc" id="L99">				fos.write((&quot;\n&quot;+end+&quot;\n&quot;).getBytes());</span>
<span class="nc" id="L100">				fos.close();</span>
<span class="nc" id="L101">			} else {</span>
<span class="nc" id="L102">				FileOutputStream fos = new FileOutputStream(outfile);</span>
<span class="nc" id="L103">				fos.write(bytes);</span>
<span class="nc" id="L104">				fos.close();				</span>
			}
<span class="nc" id="L106">			getPrintStream().println(&quot;Wrote output file &quot;+outfile);</span>
<span class="nc" id="L107">		} catch (Exception e) {</span>
<span class="nc" id="L108">			throw new ErrorAdminCommandException(e);</span>
<span class="nc" id="L109">		}</span>
<span class="nc" id="L110">	}</span>

	protected static CVCObject getCVCObject(String filename) throws IOException, CvcException, CertificateException {
<span class="nc" id="L113">		CVCObject ret = null;</span>
		try {
<span class="nc" id="L115">			byte[] cvcdata = FileTools.readFiletoBuffer(filename);				</span>
<span class="nc" id="L116">			ret = CertificateParser.parseCVCObject(cvcdata);</span>
<span class="nc" id="L117">		} catch (Exception e) {</span>
			try {
				// this was not parseable, try to see it it was a PEM certificate
<span class="nc" id="L120">				Collection&lt;Certificate&gt; col = CertTools.getCertsFromPEM(filename, Certificate.class);</span>
<span class="nc" id="L121">				Certificate cert = (Certificate)col.iterator().next();</span>
<span class="nc" id="L122">	        	ret = CertificateParser.parseCVCObject(cert.getEncoded());			</span>
<span class="nc" id="L123">			} catch (Exception ie) {</span>
				// this was not a PEM cert, try to see it it was a PEM certificate req
<span class="nc" id="L125">				byte[] cvcdata = FileTools.readFiletoBuffer(filename);				</span>
<span class="nc" id="L126">				byte[] req = RequestMessageUtils.getRequestBytes(cvcdata);</span>
<span class="nc" id="L127">				ret = CertificateParser.parseCVCObject(req);</span>
<span class="nc" id="L128">			}</span>
<span class="nc" id="L129">		}</span>
<span class="nc" id="L130">		return ret;</span>
	}

	protected void usage() {
<span class="nc" id="L134">		getPrintStream().println(&quot;Command used to convert between binary and PEM formats.&quot;);</span>
<span class="nc" id="L135">		getPrintStream().println(&quot;Usage : cvcpem &lt;inform bin/pem&gt; &lt;in filename&gt; &lt;outform bin/pem&gt; &lt;out filename&gt; [-req]\n\n&quot;);</span>
<span class="nc" id="L136">		getPrintStream().println(&quot;If adding the optional parameter -req the PEM output/input is a certificate request as opposed to a certificate.&quot;);</span>
<span class="nc" id="L137">	}</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>