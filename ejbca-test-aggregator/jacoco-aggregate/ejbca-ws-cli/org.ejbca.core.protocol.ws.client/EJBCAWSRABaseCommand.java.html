<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EJBCAWSRABaseCommand.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-ws-cli</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.protocol.ws.client</a> &gt; <span class="el_source">EJBCAWSRABaseCommand.java</span></div><h1>EJBCAWSRABaseCommand.java</h1><pre class="source lang-java linenums">package org.ejbca.core.protocol.ws.client;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintStream;
import java.net.URL;
import java.security.AuthProvider;
import java.security.NoSuchAlgorithmException;
import java.security.Provider;
import java.security.Security;
import java.util.Properties;

import javax.net.ssl.KeyManagerFactory;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.PasswordCallback;
import javax.security.auth.callback.UnsupportedCallbackException;
import javax.xml.namespace.QName;

import org.cesecore.keys.token.p11.P11Slot;
import org.cesecore.keys.token.p11.P11SlotUser;
import org.cesecore.keys.token.p11.Pkcs11SlotLabelType;
import org.cesecore.util.CryptoProviderTools;
import org.cesecore.util.provider.TLSProvider;
import org.ejbca.core.protocol.ws.client.gen.EjbcaWS;
import org.ejbca.core.protocol.ws.client.gen.EjbcaWSService;
import org.ejbca.core.protocol.ws.client.gen.RevokeStatus;

/**
 * Base class inherited by all EJBCA RA WS cli commands.
 * Checks the property file and creates a webservice connection.
 *  
 * $Id: EJBCAWSRABaseCommand.java 30502 2018-11-14 13:44:43Z anatom $
 */

public abstract class EJBCAWSRABaseCommand implements P11SlotUser {
    
    final protected String[] args;
<span class="fc" id="L41">    private org.ejbca.core.protocol.ws.client.gen.EjbcaWS ejbcaraws = null;</span>
    final private URL webServiceURL;
    final private Exception exception;
    
    
<span class="fc" id="L46">    protected static final String[] REASON_TEXTS ={&quot;NOT REVOKED&quot;,</span>
    	&quot;REV_UNSPECIFIED&quot;,			&quot;REV_KEYCOMPROMISE&quot;,	&quot;REV_CACOMPROMISE&quot;,
        &quot;REV_AFFILIATIONCHANGED&quot;,	&quot;REV_SUPERSEDED&quot;,		&quot;REV_CESSATIONOFOPERATION&quot;,
        &quot;REV_CERTIFICATEHOLD&quot;,		&quot;REV_REMOVEFROMCRL&quot;,	&quot;REV_PRIVILEGEWITHDRAWN&quot;,
        &quot;REV_AACOMPROMISE&quot;};
    
<span class="fc" id="L52">    public static final int NOT_REVOKED = RevokeStatus.NOT_REVOKED;</span>
<span class="fc" id="L53">    public static final int REVOKATION_REASON_UNSPECIFIED = RevokeStatus.REVOKATION_REASON_UNSPECIFIED;</span>
<span class="fc" id="L54">    public static final int REVOKATION_REASON_KEYCOMPROMISE = RevokeStatus.REVOKATION_REASON_KEYCOMPROMISE;</span>
<span class="fc" id="L55">    public static final int REVOKATION_REASON_CACOMPROMISE = RevokeStatus.REVOKATION_REASON_CACOMPROMISE;</span>
<span class="fc" id="L56">    public static final int REVOKATION_REASON_AFFILIATIONCHANGED = RevokeStatus.REVOKATION_REASON_AFFILIATIONCHANGED;</span>
<span class="fc" id="L57">    public static final int REVOKATION_REASON_SUPERSEDED = RevokeStatus.REVOKATION_REASON_SUPERSEDED;</span>
<span class="fc" id="L58">    public static final int REVOKATION_REASON_CESSATIONOFOPERATION = RevokeStatus.REVOKATION_REASON_CESSATIONOFOPERATION;</span>
<span class="fc" id="L59">    public static final int REVOKATION_REASON_CERTIFICATEHOLD = RevokeStatus.REVOKATION_REASON_CERTIFICATEHOLD;</span>
<span class="fc" id="L60">    public static final int REVOKATION_REASON_REMOVEFROMCRL = RevokeStatus.REVOKATION_REASON_REMOVEFROMCRL;</span>
<span class="fc" id="L61">    public static final int REVOKATION_REASON_PRIVILEGESWITHDRAWN = RevokeStatus.REVOKATION_REASON_PRIVILEGESWITHDRAWN;</span>
<span class="fc" id="L62">    public static final int REVOKATION_REASON_AACOMPROMISE = RevokeStatus.REVOKATION_REASON_AACOMPROMISE;</span>
    
<span class="fc" id="L64">    protected static final int[] REASON_VALUES = {NOT_REVOKED,REVOKATION_REASON_UNSPECIFIED, </span>
         REVOKATION_REASON_KEYCOMPROMISE, REVOKATION_REASON_CACOMPROMISE,
         REVOKATION_REASON_AFFILIATIONCHANGED, REVOKATION_REASON_SUPERSEDED,
         REVOKATION_REASON_CESSATIONOFOPERATION, REVOKATION_REASON_CERTIFICATEHOLD,
         REVOKATION_REASON_REMOVEFROMCRL, REVOKATION_REASON_PRIVILEGESWITHDRAWN,
         REVOKATION_REASON_AACOMPROMISE};
    
<span class="fc" id="L71">    EJBCAWSRABaseCommand(String[] args) {</span>
<span class="fc" id="L72">        this.args = args;</span>
<span class="fc" id="L73">        final Properties props = new Properties();</span>
<span class="fc" id="L74">        URL tmpURL = null;</span>
<span class="fc" id="L75">        Exception tmpException = null;</span>
        try {
            try {
<span class="nc" id="L78">                props.load(new FileInputStream(&quot;ejbcawsracli.properties&quot;));</span>
<span class="fc" id="L79">            } catch (FileNotFoundException e) {</span>
                // Try in parent directory
<span class="nc" id="L81">                props.load(new FileInputStream(&quot;../ejbcawsracli.properties&quot;));</span>
<span class="nc" id="L82">            }</span>
<span class="nc" id="L83">            CryptoProviderTools.installBCProvider();</span>
<span class="nc" id="L84">            final String sharedLibraryPath = props.getProperty(&quot;ejbcawsracli.p11.sharedlibrary&quot;);</span>
<span class="nc" id="L85">            final String trustStorePath = props.getProperty(&quot;ejbcawsracli.truststore.path&quot;);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if ( trustStorePath!=null  ) {</span>
<span class="nc" id="L87">                checkIfFileExists(trustStorePath);</span>
<span class="nc" id="L88">                System.setProperty(&quot;javax.net.ssl.trustStore&quot;, trustStorePath);</span>
            }
            final String password; {
<span class="nc" id="L91">                final String tmpPassword = props.getProperty(&quot;ejbcawsracli.keystore.password&quot;);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if ( tmpPassword==null ) {            	</span>
<span class="nc" id="L93">                    System.out.print(&quot;Enter keystore password: &quot;);</span>
<span class="nc" id="L94">                    password = new String(System.console().readPassword());</span>
                }else{
<span class="nc" id="L96">                    password = tmpPassword;</span>
                }
            }
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if ( sharedLibraryPath!=null ) {</span>
<span class="nc" id="L100">                checkIfFileExists(sharedLibraryPath);</span>
<span class="nc" id="L101">                final String sSlot =  props.getProperty(&quot;ejbcawsracli.p11.slot&quot;);</span>
<span class="nc" id="L102">                final Pkcs11SlotLabelType type = Pkcs11SlotLabelType.getFromKey(props.getProperty(&quot;ejbcawsracli.p11.slotlabeltype&quot;));</span>
<span class="nc" id="L103">                final P11Slot slot = P11Slot.getInstance(sSlot, sharedLibraryPath, type, null, this, 0, true);// no CA set ID to 0 to indicate just one user</span>
<span class="nc" id="L104">                final AuthProvider provider = (AuthProvider) slot.getProvider();</span>
<span class="nc" id="L105">                final String providerName = provider.getName();</span>
<span class="nc" id="L106">                final PasswordHandler handler = new PasswordHandler(password);</span>
<span class="nc" id="L107">                provider.login(null, handler);</span>
<span class="nc" id="L108">                handler.clean();</span>
<span class="nc" id="L109">                System.setProperty(&quot;javax.net.ssl.keyStoreType&quot;, &quot;pkcs11&quot;);</span>
<span class="nc" id="L110">                System.setProperty(&quot;javax.net.ssl.keyStoreProvider&quot;, providerName);</span>
<span class="nc" id="L111">                System.setProperty(&quot;javax.net.ssl.keyStore&quot;, &quot;NONE&quot;);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if ( trustStorePath==null ) {</span>
<span class="nc" id="L113">                    final Provider tlsProvider = new TLSProvider();</span>
<span class="nc" id="L114">                    Security.addProvider(tlsProvider);</span>
<span class="nc" id="L115">                    Security.setProperty(&quot;ssl.TrustManagerFactory.algorithm&quot;, &quot;AcceptAll&quot;);</span>
                }
<span class="nc" id="L117">            } else {</span>
<span class="nc" id="L118">                final String keyStorePath = props.getProperty(&quot;ejbcawsracli.keystore.path&quot;, &quot;keystore.jks&quot;);</span>
<span class="nc" id="L119">                checkIfFileExists(keyStorePath);</span>
<span class="nc" id="L120">                System.setProperty(&quot;javax.net.ssl.keyStore&quot;, keyStorePath);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                if (keyStorePath.endsWith(&quot;.p12&quot;)) {</span>
<span class="nc" id="L122">                	System.setProperty(&quot;javax.net.ssl.keyStoreType&quot;, &quot;pkcs12&quot;);</span>
                }
<span class="nc bnc" id="L124" title="All 2 branches missed.">                if ( trustStorePath==null  ) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                    if (keyStorePath.endsWith(&quot;.p12&quot;)) {</span>
<span class="nc" id="L126">                        final Provider tlsProvider = new TLSProvider();</span>
<span class="nc" id="L127">                        Security.addProvider(tlsProvider);</span>
<span class="nc" id="L128">                        Security.setProperty(&quot;ssl.TrustManagerFactory.algorithm&quot;, &quot;AcceptAll&quot;);</span>
<span class="nc" id="L129">                    } else {</span>
<span class="nc" id="L130">                        System.setProperty(&quot;javax.net.ssl.trustStore&quot;, keyStorePath);</span>
                    }
                }
<span class="nc" id="L133">                System.setProperty(&quot;javax.net.ssl.keyStorePassword&quot;, password);</span>
            }
<span class="nc" id="L135">            tmpURL = new URL(props.getProperty(&quot;ejbcawsracli.url&quot;, &quot;https://localhost:8443/ejbca/ejbcaws/ejbcaws&quot;) + &quot;?wsdl&quot;);</span>
            try {
<span class="nc" id="L137">                KeyManagerFactory.getInstance(&quot;NewSunX509&quot;);</span>
                //getPrintStream().println(&quot;Using NewSunX509 KeyManagerFactory.&quot;);
<span class="nc" id="L139">                Security.setProperty(&quot;ssl.KeyManagerFactory.algorithm&quot;, &quot;NewSunX509&quot;);</span>
<span class="nc" id="L140">            } catch (NoSuchAlgorithmException e) {</span>
                // Using IBM Java
<span class="nc" id="L142">                getPrintStream().println(&quot;Using default KeyManagerFactory, NewSunX509 is not available.&quot;);                </span>
<span class="nc" id="L143">            }</span>
<span class="fc" id="L144">        } catch( Exception e ) {</span>
<span class="fc" id="L145">            tmpException = e;</span>
<span class="nc" id="L146">        }</span>
<span class="fc" id="L147">        this.exception = tmpException;</span>
<span class="fc" id="L148">        this.webServiceURL = tmpURL;</span>
<span class="fc" id="L149">    }</span>
    private class PasswordHandler implements CallbackHandler {
        private char password[];
<span class="nc" id="L152">        PasswordHandler(String _password) {</span>
<span class="nc" id="L153">            this.password = _password.toCharArray();</span>
<span class="nc" id="L154">        }</span>
        /* (non-Javadoc)
         * @see javax.security.auth.callback.CallbackHandler#handle(javax.security.auth.callback.Callback[])
         */
        public void handle(Callback[] callbacks) throws IOException, UnsupportedCallbackException {
<span class="nc bnc" id="L159" title="All 2 branches missed.">            for ( int i=0; i&lt;callbacks.length; i++) {</span>
                try {
<span class="nc" id="L161">                    ((PasswordCallback)callbacks[i]).setPassword(this.password);</span>
<span class="nc" id="L162">                } catch( Throwable t ) {</span>
<span class="nc" id="L163">                    System.out.println(&quot;callback class: &quot;+callbacks[i].getClass().getCanonicalName());</span>
<span class="nc" id="L164">                }</span>
            }
<span class="nc" id="L166">        }</span>
        void clean() {
<span class="nc" id="L168">            this.password = null;</span>
<span class="nc" id="L169">        }</span>
    }
    private void checkIfFileExists(String fileName) throws Exception {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        if ( fileName.equals(&quot;NONE&quot;) ) {</span>
<span class="nc" id="L173">            return;</span>
        }
<span class="nc" id="L175">        final File f = new File(fileName);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (!f.exists()) {</span>
<span class="nc" id="L177">            throw new Exception(&quot;File '&quot;+fileName+&quot;' does not exist&quot;);</span>
        }
<span class="nc" id="L179">    }</span>
    /**
     * Method creating a connection to the webservice
     * using the information stored in the property files.
     * If a connection already is established this connection will be used
     * @return WS
     * @throws Exception Fail
     */
    protected EjbcaWS getEjbcaRAWS() throws Exception{
<span class="nc" id="L188">        return getEjbcaRAWS(false);</span>
    }
    /**
     * Method creating a connection to the webservice
     * using the information stored in the property files.
     * A new connection will be created for each call.
     * @return WS
     * @throws Exception Fail
     */
    protected EjbcaWS getEjbcaRAWSFNewReference() throws  Exception {
<span class="nc" id="L198">        return getEjbcaRAWS(true);</span>
    }
    private EjbcaWS getEjbcaRAWS(boolean bForceNewReference) throws Exception {       
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if ( this.exception!=null ) {</span>
<span class="nc" id="L202">            throw this.exception;</span>
        }
<span class="nc bnc" id="L204" title="All 4 branches missed.">        if(this.ejbcaraws==null || bForceNewReference){</span>
<span class="nc" id="L205">            final QName qname = new QName(&quot;http://ws.protocol.core.ejbca.org/&quot;, &quot;EjbcaWSService&quot;);</span>
<span class="nc" id="L206">            final EjbcaWSService service = new EjbcaWSService(this.webServiceURL,qname);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if ( bForceNewReference ) {</span>
<span class="nc" id="L208">                return service.getEjbcaWSPort();</span>
            }
<span class="nc" id="L210">            this.ejbcaraws = service.getEjbcaWSPort();</span>
        }
<span class="nc" id="L212">        return this.ejbcaraws;</span>
    }

    protected PrintStream getPrintStream(){
<span class="nc" id="L216">        return System.out;</span>
    }
    
    protected int getRevokeReason(String reason) throws Exception{
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        for(int i=0;i&lt;REASON_TEXTS.length;i++){</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">           if(REASON_TEXTS[i].equalsIgnoreCase(reason)){</span>
<span class="fc" id="L222">               return REASON_VALUES[i];</span>
           }
        }        
<span class="nc" id="L225">        getPrintStream().println(&quot;Error : Unsupported reason &quot; + reason);</span>
<span class="nc" id="L226">        usage();</span>
<span class="nc" id="L227">        System.exit(-1); // NOPMD, this is not a JEE app</span>
<span class="nc" id="L228">        return 0;</span>
    }
    
    protected String getRevokeReason(int reason) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        for(int i=0;i&lt;REASON_VALUES.length;i++){</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">               if(REASON_VALUES[i]==reason){</span>
<span class="nc" id="L234">                   return REASON_TEXTS[i];</span>
               }
            }        
<span class="nc" id="L237">        getPrintStream().println(&quot;Error : Unsupported reason &quot; + reason);</span>
<span class="nc" id="L238">        usage();</span>
<span class="nc" id="L239">        System.exit(-1); // NOPMD, this is not a JEE app</span>
<span class="nc" id="L240">        return null;        </span>
    }
    
    /**
     * Print usage information.
     */
    protected abstract void usage();

    @Override
    public void deactivate() {
<span class="nc" id="L250">    }</span>
    @Override
    public boolean isActive() {
<span class="nc" id="L253">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>