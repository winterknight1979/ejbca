<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AcmeConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-common</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.config</a> &gt; <span class="el_source">AcmeConfiguration.java</span></div><h1>AcmeConfiguration.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA - Proprietary Modules: Enterprise Certificate Authority        *
 *                                                                       *
 *  Copyright (c), PrimeKey Solutions AB. All rights reserved.           *
 *  The use of the Proprietary Modules are subject to specific           *
 *  commercial license terms.                                            *
 *                                                                       *
 *************************************************************************/
package org.ejbca.config;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.internal.UpgradeableDataHashMap;
import org.ejbca.core.protocol.dnssec.DnsSecDefaults;

/**
 * Configuration used by specifying the configurationId as part of the request URL path.
 *
 * @version $Id: AcmeConfiguration.java 29902 2018-09-26 11:32:56Z samuellb $
 */
public class AcmeConfiguration extends UpgradeableDataHashMap implements Serializable {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L29">    private String configurationId = null;</span>
<span class="nc" id="L30">    private List&lt;String&gt; caaIdentities = new ArrayList&lt;String&gt;();</span>

    private static final String KEY_REQUIRE_EXTERNAL_ACCOUNT_BINDING = &quot;requireExternalAccountBinding&quot;;
    private static final String KEY_PRE_AUTHORIZATION_ALLOWED = &quot;preAuthorizationAllowed&quot;;
    private static final String KEY_END_ENTITY_PROFILE_ID = &quot;endEntityProfileId&quot;;
    private static final String KEY_VALIDATION_HTTP_CALLBACK_URL_TEMPLATE = &quot;valiationHttpCallbackUrlTemplate&quot;;
   // private static final String KEY_TERMS_OF_SERVICE_VERSION = &quot;termsOfServiceVersion&quot;;
    private static final String KEY_TERMS_OF_SERVICE_URL = &quot;termsOfServiceUrl&quot;;
    private static final String KEY_WEB_SITE_URL = &quot;webSiteUrl&quot;;
    private static final String KEY_ORDER_VALIDITY = &quot;orderValidity&quot;;
    private static final String KEY_PRE_AUTHORIZATION_VALIDITY = &quot;preAuthorizationValidity&quot;;
    private static final String KEY_WILDCARD_CERTIFICATE_ISSUANCE_ALLOWED = &quot;wildcardCertificateIssuanceAllowed&quot;;
    private static final String KEY_DNS_RESOLVER = &quot;dnsResolver&quot;;
    private static final String KEY_DNSSEC_TRUST_ANCHOR = &quot;dnssecTrustAnchor&quot;;
    private static final String KEY_DNS_PORT = &quot;dnsPort&quot;;
    private static final String KEY_USE_DNSSEC_VALIDATION = &quot;useDnssecValidation&quot;;
    private static final String KEY_TERMS_OF_SERVICE_REQUIRE_NEW_APPROVAL = &quot;termsOfServiceRequireNewApproval&quot;;
    private static final String DNS_RESOLVER_DEFAULT = &quot;8.8.8.8&quot;;
    private static final int DNS_SERVER_PORT_DEFAULT = 53;


    private static final int DEFAULT_END_ENTITY_PROFILE_ID = EndEntityConstants.NO_END_ENTITY_PROFILE;
    private static final boolean DEFAULT_REQUIRE_EXTERNAL_ACCOUNT_BINDING = false;
    private static final boolean DEFAULT_PRE_AUTHORIZATION_ALLOWED = false;
    private static final boolean DEFAULT_REQUIRE_NEW_APPROVAL = true;
    private static final boolean DEFAULT__WILDCARD_CERTIFICATE_ISSUANCE_ALLOWED = false;
    private static final String DEFAULT_TERMS_OF_SERVICE_URL = &quot;https://example.com/acme/terms&quot;;
    private static final String DEFAULT_WEBSITE_URL = &quot;https://www.example.com/&quot;;
    private static final boolean DEFAULT_USE_DNSSEC_VALIDATION = true;


<span class="nc" id="L61">    public AcmeConfiguration() {}</span>

<span class="nc" id="L63">    public AcmeConfiguration(final Object upgradeableDataHashMapData) {</span>
<span class="nc" id="L64">        super.loadData(upgradeableDataHashMapData);</span>
<span class="nc" id="L65">    }</span>

    @Override
    public float getLatestVersion() {
<span class="nc" id="L69">        return 0;</span>
    }

    @Override
<span class="nc" id="L73">    public void upgrade() {}</span>

    /** @return the configuration ID as used in the request URL path */
<span class="nc" id="L76">    public String getConfigurationId() { return configurationId; }</span>
<span class="nc" id="L77">    public void setConfigurationId(final String configurationId) { this.configurationId = configurationId; }</span>

    /**
     * https://tools.ietf.org/html/draft-ietf-acme-acme-12#section-7.3.5
     *
     * NOTE: Don't expose this as client configuration yet. The current implementation has the code for validation
     *       using a dummy HMAC, but will strip this info anyway from the actual account.
     *
     * @return true if an the server should enforce external account bindings.
     */
    public boolean isRequireExternalAccountBinding() {
<span class="nc" id="L88">        return Boolean.valueOf((String)super.data.get(KEY_REQUIRE_EXTERNAL_ACCOUNT_BINDING));</span>
    }
    public void setRequireExternalAccountBinding(final boolean requireExternalAccountBinding) {
<span class="nc" id="L91">        super.data.put(KEY_REQUIRE_EXTERNAL_ACCOUNT_BINDING, String.valueOf(requireExternalAccountBinding));</span>
<span class="nc" id="L92">    }</span>

    /**
     * https://tools.ietf.org/html/draft-ietf-acme-acme-12#section-7.4.1
     * &quot;If a CA wishes to allow pre-authorization within ACME, it can offer a &quot;new authorization&quot; resource in its
     * directory by adding the field &quot;newAuthz&quot; with a URL for the new authorization resource.&quot;
     * @return boolean
     */
    public boolean isPreAuthorizationAllowed() {
<span class="nc" id="L101">        return Boolean.valueOf((String)super.data.get(KEY_PRE_AUTHORIZATION_ALLOWED));</span>
    }
    public void setPreAuthorizationAllowed(final boolean preAuthorizationAllowed) {
<span class="nc" id="L104">        super.data.put(KEY_PRE_AUTHORIZATION_ALLOWED, String.valueOf(preAuthorizationAllowed));</span>
<span class="nc" id="L105">    }</span>

    /** @return the End Entity Profile ID whos default Certificate Profile and CA will be used for issuing */
    public int getEndEntityProfileId() {
<span class="nc" id="L109">        final Integer endEntityProfileId = (Integer) super.data.get(KEY_END_ENTITY_PROFILE_ID);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        return endEntityProfileId==null ? EndEntityConstants.NO_END_ENTITY_PROFILE : endEntityProfileId.intValue();</span>
    }
    public void setEndEntityProfileId(final int endEntityProfileId) {
<span class="nc" id="L113">        super.data.put(KEY_END_ENTITY_PROFILE_ID, Integer.valueOf(endEntityProfileId));</span>
<span class="nc" id="L114">    }</span>

    /** @return the pattern we will use for &quot;http-01&quot; challenge validation. Defaults to example from RFC draft 06. */
    public String getValidationHttpCallBackUrlTemplate() {
<span class="nc" id="L118">        final String urlTemplate = (String) super.data.get(KEY_VALIDATION_HTTP_CALLBACK_URL_TEMPLATE);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        return urlTemplate==null ? &quot;http://{identifer}:80/.well-known/acme-challenge/{token}&quot; : urlTemplate;</span>
    }
    public void setValidationHttpCallBackUrlTemplate(final String urlTemplate) {
<span class="nc" id="L122">        super.data.put(KEY_VALIDATION_HTTP_CALLBACK_URL_TEMPLATE, urlTemplate);</span>
<span class="nc" id="L123">    }</span>

    /** @return an URL of where the current Terms Of Services can be located. */
    public String getTermsOfServiceUrl() {
<span class="nc" id="L127">        return (String) super.data.get(KEY_TERMS_OF_SERVICE_URL);</span>
    }
    
    public void setTermsOfServiceUrl(final String termsOfServiceUrl) {
<span class="nc" id="L131">        super.data.put(KEY_TERMS_OF_SERVICE_URL, termsOfServiceUrl);</span>
<span class="nc" id="L132">    }</span>
    
    /** @return the web site URL presented in the directory meta data */
    public String getWebSiteUrl() {
<span class="nc" id="L136">        return (String) super.data.get(KEY_WEB_SITE_URL);</span>
    }
    public void setWebSiteUrl(final String webSiteUrl) {
<span class="nc" id="L139">        super.data.put(KEY_WEB_SITE_URL, webSiteUrl);</span>
<span class="nc" id="L140">    }</span>

    public List&lt;String&gt; getCaaIdentities() {
<span class="nc" id="L143">        return caaIdentities;</span>
    }

    public void setCaaIdentities(final List&lt;String&gt; caaIdentities) {
<span class="nc" id="L147">        this.caaIdentities = caaIdentities;</span>
<span class="nc" id="L148">    }</span>

    /** @return how long a new order will be valid for in milliseconds */
    public long getOrderValidity() {
<span class="nc" id="L152">        final Long orderValidity = (Long) super.data.get(KEY_ORDER_VALIDITY);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        return orderValidity==null ? 3600000L : orderValidity.intValue();</span>
    }
    public void setOrderValidity(final int orderValidity) {
<span class="nc" id="L156">        super.data.put(KEY_ORDER_VALIDITY, Long.valueOf(orderValidity));</span>
<span class="nc" id="L157">    }</span>

    /** @return how long a new pre-authorizations will be valid for in milliseconds */
    public long getPreAuthorizationValidity() {
<span class="nc" id="L161">        final Long preAuthorizationValidity = (Long) super.data.get(KEY_PRE_AUTHORIZATION_VALIDITY);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        return preAuthorizationValidity==null ? 24*3600000L : preAuthorizationValidity.intValue();</span>
    }
    public void setPreAuthorizationValidity(final int preAuthorizationValidity) {
<span class="nc" id="L165">        super.data.put(KEY_PRE_AUTHORIZATION_VALIDITY, Long.valueOf(preAuthorizationValidity));</span>
<span class="nc" id="L166">    }</span>

    /** @return the number of required challenges that needs to be fulfilled in order to grant authorization for an identifier */
    public int getValidChallengesPerAuthorization() {
<span class="nc" id="L170">        return 1;</span>
    }

    public boolean isWildcardCertificateIssuanceAllowed() {
<span class="nc" id="L174">        return Boolean.valueOf((String) super.data.get(KEY_WILDCARD_CERTIFICATE_ISSUANCE_ALLOWED));</span>
    }

    public void setWildcardCertificateIssuanceAllowed(final boolean wildcardCertificateIssuanceAllowed) {
<span class="nc" id="L178">        super.data.put(KEY_WILDCARD_CERTIFICATE_ISSUANCE_ALLOWED, String.valueOf(wildcardCertificateIssuanceAllowed));</span>
<span class="nc" id="L179">    }</span>

    public String getDnssecTrustAnchor() {
<span class="nc" id="L182">        return (String) super.data.get(KEY_DNSSEC_TRUST_ANCHOR);</span>
    }

    public void setDnssecTrustAnchor(String dnssecTrustAnchor) {
<span class="nc" id="L186">        super.data.put(KEY_DNSSEC_TRUST_ANCHOR, String.valueOf(dnssecTrustAnchor));</span>
<span class="nc" id="L187">    }</span>

    public String getDnsResolver() {
<span class="nc" id="L190">        return (String) super.data.get(KEY_DNS_RESOLVER);</span>
    }

    public void setDnsResolver(String dnsResolver) {
<span class="nc" id="L194">        super.data.put(KEY_DNS_RESOLVER, String.valueOf(dnsResolver));</span>
<span class="nc" id="L195">    }</span>
    
    public int getDnsPort() {
<span class="nc" id="L198">        final Integer dnsPort = (Integer) super.data.get(KEY_DNS_PORT);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        return dnsPort != null ? dnsPort : DNS_SERVER_PORT_DEFAULT;</span>
    }
    
    public void setDnsPort(final int dnsPort) {
<span class="nc" id="L203">        super.data.put(KEY_DNS_PORT, dnsPort);</span>
<span class="nc" id="L204">    }</span>
    
    public boolean isTermsOfServiceRequireNewApproval() {
<span class="nc" id="L207">        return Boolean.valueOf((String) super.data.get(KEY_TERMS_OF_SERVICE_REQUIRE_NEW_APPROVAL));</span>
    }
    
    public void setTermsOfServiceRequireNewApproval(boolean termsOfServiceRequireNewApproval) {
<span class="nc" id="L211">        super.data.put(KEY_TERMS_OF_SERVICE_REQUIRE_NEW_APPROVAL, String.valueOf(termsOfServiceRequireNewApproval));</span>
<span class="nc" id="L212">    }</span>
    
    
    public boolean isUseDnsSecValidation() {
<span class="nc" id="L216">        return Boolean.valueOf((String) super.data.get(KEY_USE_DNSSEC_VALIDATION));</span>
    }
    
    public void setUseDnsSecValidation(final boolean useDnsSecValidation) {
<span class="nc" id="L220">        super.data.put(KEY_USE_DNSSEC_VALIDATION, String.valueOf(useDnsSecValidation));</span>
<span class="nc" id="L221">    }</span>

    /** Initializes a new acme configuration with default values. 
     * @param alias Alias*/
    public void initialize(String alias) {
<span class="nc" id="L226">        alias += &quot;.&quot;;</span>
<span class="nc" id="L227">        setEndEntityProfileId(DEFAULT_END_ENTITY_PROFILE_ID);</span>
<span class="nc" id="L228">        setRequireExternalAccountBinding(DEFAULT_REQUIRE_EXTERNAL_ACCOUNT_BINDING);</span>
<span class="nc" id="L229">        setPreAuthorizationAllowed(DEFAULT_PRE_AUTHORIZATION_ALLOWED);</span>
<span class="nc" id="L230">        setTermsOfServiceUrl(DEFAULT_TERMS_OF_SERVICE_URL);</span>
<span class="nc" id="L231">        setTermsOfServiceRequireNewApproval(DEFAULT_REQUIRE_NEW_APPROVAL);</span>
<span class="nc" id="L232">        setWildcardCertificateIssuanceAllowed(DEFAULT__WILDCARD_CERTIFICATE_ISSUANCE_ALLOWED);</span>
<span class="nc" id="L233">        setWebSiteUrl(DEFAULT_WEBSITE_URL);</span>
<span class="nc" id="L234">        setDnsResolver(DNS_RESOLVER_DEFAULT);</span>
<span class="nc" id="L235">        setDnssecTrustAnchor(DnsSecDefaults.IANA_ROOT_ANCHORS_DEFAULT);</span>
<span class="nc" id="L236">        setDnsPort(DNS_SERVER_PORT_DEFAULT);</span>
<span class="nc" id="L237">        setUseDnsSecValidation(DEFAULT_USE_DNSSEC_VALIDATION);</span>
<span class="nc" id="L238">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>