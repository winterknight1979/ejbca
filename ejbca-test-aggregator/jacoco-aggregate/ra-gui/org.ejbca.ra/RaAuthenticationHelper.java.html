<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RaAuthenticationHelper.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ra-gui</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ra</a> &gt; <span class="el_source">RaAuthenticationHelper.java</span></div><h1>RaAuthenticationHelper.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.ra;

import java.io.Serializable;
import java.nio.charset.StandardCharsets;
import java.security.cert.X509Certificate;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.util.encoders.Hex;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.util.CertTools;
import org.ejbca.core.ejb.authentication.web.WebAuthenticationProviderSessionLocal;

/**
 * Web session authentication helper.
 * 
 * @version $Id: RaAuthenticationHelper.java 29180 2018-06-08 18:56:00Z bastianf $
 */
public class RaAuthenticationHelper implements Serializable {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L39">    private static final Logger log = Logger.getLogger(RaAuthenticationHelper.class);</span>
    private static final String HTTP_HEADER_SET_COOKIE = &quot;Set-Cookie&quot;;
    private static final String HTTP_HEADER_X_POWERED_BY = &quot;X-Powered-By&quot;;

    private final WebAuthenticationProviderSessionLocal webAuthenticationProviderSession;
<span class="nc" id="L44">    private AuthenticationToken authenticationToken = null;</span>
<span class="nc" id="L45">    private String authenticationTokenTlsSessionId = null;</span>
<span class="nc" id="L46">    private String x509AuthenticationTokenFingerprint = null;</span>

<span class="nc" id="L48">    public RaAuthenticationHelper(final WebAuthenticationProviderSessionLocal webAuthenticationProviderSession) {</span>
<span class="nc" id="L49">        this.webAuthenticationProviderSession = webAuthenticationProviderSession;</span>
<span class="nc" id="L50">    }</span>

    /** @param httpServletRequest req
     * @param httpServletResponse resp
     * @return the X509CertificateAuthenticationToken if the client has provided a certificate or a PublicAccessAuthenticationToken otherwise. */
    public AuthenticationToken getAuthenticationToken(final HttpServletRequest httpServletRequest, final HttpServletResponse httpServletResponse) {
<span class="nc" id="L56">        final String currentTlsSessionId = getTlsSessionId(httpServletRequest);</span>
<span class="nc bnc" id="L57" title="All 4 branches missed.">        if (authenticationToken==null || !StringUtils.equals(authenticationTokenTlsSessionId, currentTlsSessionId)) {</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">            if (log.isTraceEnabled()) {</span>
<span class="nc" id="L59">                log.trace(&quot;New TLS session IDs or authenticationToken: currentClientTlsSessionID: &quot;+currentTlsSessionId+&quot;, authenticationTokenTlsSessionId: &quot;+authenticationTokenTlsSessionId);</span>
            }
            // Set the current TLS session 
<span class="nc" id="L62">            authenticationTokenTlsSessionId = currentTlsSessionId;</span>
<span class="nc" id="L63">            final X509Certificate x509Certificate = getClientX509Certificate(httpServletRequest);</span>
<span class="nc bnc" id="L64" title="All 4 branches missed.">            if (x509Certificate == null &amp;&amp; x509AuthenticationTokenFingerprint!=null) {</span>
<span class="nc" id="L65">                log.warn(&quot;Suspected session hijacking attempt from &quot; + httpServletRequest.getRemoteAddr() +</span>
                        &quot;. RA client presented no TLS certificate in HTTP session previously authenticated with client certificate.&quot;);
<span class="nc" id="L67">                authenticationToken = null;</span>
<span class="nc" id="L68">                x509AuthenticationTokenFingerprint = null;</span>
            }
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (x509Certificate != null) {</span>
<span class="nc" id="L71">                final String fingerprint = CertTools.getFingerprintAsString(x509Certificate);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">                if (log.isTraceEnabled()) {</span>
<span class="nc" id="L73">                    log.trace(&quot;currentRequestFingerprint: &quot;+fingerprint+&quot;, x509AuthenticationTokenFingerprint: &quot;+x509AuthenticationTokenFingerprint);</span>
                }
<span class="nc bnc" id="L75" title="All 2 branches missed.">                if (x509AuthenticationTokenFingerprint!=null) {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">                    if (!StringUtils.equals(fingerprint, x509AuthenticationTokenFingerprint)) {</span>
<span class="nc" id="L77">                        log.warn(&quot;Suspected session hijacking attempt from &quot; + httpServletRequest.getRemoteAddr() +</span>
                                &quot;. RA client presented a different TLS certificate in the same HTTP session.&quot; +
<span class="nc" id="L79">                                &quot; new certificate had subject '&quot; + CertTools.getSubjectDN(x509Certificate) + &quot;'.&quot;);</span>
<span class="nc" id="L80">                        authenticationToken = null;</span>
<span class="nc" id="L81">                        x509AuthenticationTokenFingerprint = null;</span>
                    }
                }
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L85">                    log.debug(&quot;RA client presented client TLS certificate with subject DN '&quot; + CertTools.getSubjectDN(x509Certificate) + &quot;'.&quot;);</span>
                }
                // No need to perform re-authentication if the client certificate was the same
<span class="nc bnc" id="L88" title="All 2 branches missed.">                if (authenticationToken==null) {</span>
<span class="nc" id="L89">                    authenticationToken = webAuthenticationProviderSession.authenticateUsingClientCertificate(x509Certificate);</span>
                }
<span class="nc bnc" id="L91" title="All 2 branches missed.">                x509AuthenticationTokenFingerprint = authenticationToken==null ? null : fingerprint;</span>
            }
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (authenticationToken == null) {</span>
                // Instead of checking httpServletRequest.isSecure() (connection deemed secure by container), we check if a TLS session is present
<span class="nc bnc" id="L95" title="All 2 branches missed.">                final boolean confidentialTransport = currentTlsSessionId!=null;</span>
<span class="nc" id="L96">                authenticationToken = webAuthenticationProviderSession.authenticateUsingNothing(httpServletRequest.getRemoteAddr(), confidentialTransport);</span>
            }
        }
<span class="nc" id="L99">        resetUnwantedHttpHeaders(httpServletRequest, httpServletResponse);</span>
<span class="nc" id="L100">        return authenticationToken;</span>
    }
    
    /** Invoke once the session is started to prevent security leak via HTTP headers related. 
     * @param httpServletRequest req
     * @param httpServletResponse resp */
    private void resetUnwantedHttpHeaders(final HttpServletRequest httpServletRequest, final HttpServletResponse httpServletResponse) {
        // Ensure that we never send the JSESSIONID over an insecure (HTTP) connection
        // By default JBoss will send the JSESSIONID cookie over HTTP with the &quot;Secure;&quot; option. Since this is sent in clear from the server to the broswer
        // it does not really help security much that it is only sent over HTTPS from client to server.
<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (!httpServletRequest.isSecure() &amp;&amp; !StringUtils.isEmpty(httpServletResponse.getHeader(HTTP_HEADER_SET_COOKIE))) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L112">                log.debug(&quot;Preventing '&quot;+HTTP_HEADER_SET_COOKIE+&quot;' HTTP header on insecure connection with value: &quot; + httpServletResponse.getHeader(HTTP_HEADER_SET_COOKIE));</span>
            }
<span class="nc" id="L114">            httpServletResponse.setHeader(HTTP_HEADER_SET_COOKIE, &quot;&quot;);</span>
        }
        // Prevent sending the the X-Powered-By header e.g. &quot;JSF/2.0&quot;
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (!StringUtils.isEmpty(httpServletResponse.getHeader(HTTP_HEADER_X_POWERED_BY))) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L119">                log.debug(&quot;Preventing '&quot;+HTTP_HEADER_X_POWERED_BY+&quot;' HTTP header with value: &quot; + httpServletResponse.getHeader(HTTP_HEADER_X_POWERED_BY));</span>
            }
<span class="nc" id="L121">            httpServletResponse.setHeader(HTTP_HEADER_X_POWERED_BY, &quot;&quot;);</span>
        }
<span class="nc" id="L123">    }</span>
    
    private X509Certificate getClientX509Certificate(final HttpServletRequest httpServletRequest) {
<span class="nc" id="L126">        final X509Certificate[] certificates = (X509Certificate[]) httpServletRequest.getAttribute(&quot;javax.servlet.request.X509Certificate&quot;);</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">        return certificates == null || certificates.length==0 ? null : certificates[0];</span>
    }
    
    private String getTlsSessionId(final HttpServletRequest httpServletRequest) {
        final String sslSessionIdServletsStandard;
<span class="nc" id="L132">        final Object sslSessionIdServletsStandardObject = httpServletRequest.getAttribute(&quot;javax.servlet.request.ssl_session_id&quot;);</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (sslSessionIdServletsStandardObject!=null &amp;&amp; sslSessionIdServletsStandardObject instanceof byte[]) {</span>
            // Wildfly 9 stores the TLS sessions as a raw byte array. Convert it to a hex String.
<span class="nc" id="L135">            sslSessionIdServletsStandard = new String(Hex.encode((byte[]) sslSessionIdServletsStandardObject), StandardCharsets.UTF_8);</span>
        } else {
<span class="nc" id="L137">            sslSessionIdServletsStandard = (String) sslSessionIdServletsStandardObject; </span>
        }
<span class="nc" id="L139">        final String sslSessionIdJBoss7 = (String)httpServletRequest.getAttribute(&quot;javax.servlet.request.ssl_session&quot;);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        return sslSessionIdJBoss7==null ? sslSessionIdServletsStandard : sslSessionIdJBoss7;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>