<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EnrollWithUsernameBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ra-gui</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ra</a> &gt; <span class="el_source">EnrollWithUsernameBean.java</span></div><h1>EnrollWithUsernameBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.ra;

import java.io.Serializable;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;

import javax.annotation.PostConstruct;
import javax.ejb.EJB;
import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.ViewScoped;
import javax.faces.component.UIComponent;
import javax.faces.context.FacesContext;
import javax.faces.validator.ValidatorException;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.pkcs.PKCS10CertificationRequest;
import org.bouncycastle.pkcs.jcajce.JcaPKCS10CertificationRequest;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.certificates.endentity.EndEntityInformation;
import org.cesecore.certificates.util.AlgorithmTools;
import org.cesecore.util.CertTools;
import org.ejbca.core.ejb.ra.NoSuchEndEntityException;
import org.ejbca.core.model.ca.AuthLoginException;
import org.ejbca.core.model.ca.AuthStatusException;
import org.ejbca.core.model.era.RaMasterApiProxyBeanLocal;

/**
 * Managed bean that backs up the enrollwithusername.xhtml page. Extends EnrollWithRequestIdBean to make use of common code
 * 
 * @version $Id: EnrollWithUsernameBean.java 26742 2017-10-05 15:34:11Z samuellb $
 * TODO: Use CDI beans
 */
@SuppressWarnings(&quot;deprecation&quot;)
@ManagedBean
@ViewScoped
<span class="nc" id="L53">public class EnrollWithUsernameBean extends EnrollWithRequestIdBean implements Serializable {</span>

    private static final long serialVersionUID = 1L;
<span class="nc" id="L56">    private static final Logger log = Logger.getLogger(EnrollWithUsernameBean.class);</span>

<span class="nc" id="L58">    public static String PARAM_USERNAME = &quot;username&quot;;</span>
<span class="nc" id="L59">    public static String PARAM_ENROLLMENT_CODE = &quot;enrollmentcode&quot;;</span>

    @EJB
    private RaMasterApiProxyBeanLocal raMasterApiProxyBean;

    @ManagedProperty(value = &quot;#{raAuthenticationBean}&quot;)
    private RaAuthenticationBean raAuthenticationBean;

    public void setRaAuthenticationBean(final RaAuthenticationBean raAuthenticationBean) {
<span class="nc" id="L68">        this.raAuthenticationBean = raAuthenticationBean;</span>
<span class="nc" id="L69">    }</span>

    private String username;
    private String enrollmentCode;
    // Since enrollmentCode of the EnrollWithRequestIdBean is managed through JSF, and it won't let me set a password field
    // through GET param, we need this temporary var in order to be able to pass enrollment code in the URL
    private String paramEnrollmentCode;
    // Cache for certificate profile
    private CertificateProfile certificateProfile;

    @PostConstruct
    protected void postConstruct() {
<span class="nc" id="L81">        final HttpServletRequest httpServletRequest = (HttpServletRequest)FacesContext.getCurrentInstance().getExternalContext().getRequest();</span>
<span class="nc" id="L82">        username = httpServletRequest.getParameter(EnrollWithUsernameBean.PARAM_USERNAME);</span>
<span class="nc" id="L83">        paramEnrollmentCode = httpServletRequest.getParameter(EnrollWithUsernameBean.PARAM_ENROLLMENT_CODE);</span>
<span class="nc" id="L84">        super.setRaAuthenticationBean(raAuthenticationBean);</span>
<span class="nc" id="L85">        super.postConstruct();</span>
<span class="nc" id="L86">    }</span>

    /** Disable the username field if we have passwed username as a parameter in the URL (i.e. &amp;amp;username=tomas).
     * User friendly as the user can not accidentally change the pre defined username 
     * @return bool */
    public boolean isUsernameDisabled() {
<span class="nc" id="L92">        final HttpServletRequest httpServletRequest = (HttpServletRequest)FacesContext.getCurrentInstance().getExternalContext().getRequest();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        return httpServletRequest.getParameter(EnrollWithUsernameBean.PARAM_USERNAME) != null;</span>
    }
    
    @Override
    public void reset() {
<span class="nc" id="L98">        this.certificateProfile = null;</span>
<span class="nc" id="L99">        enrollmentCode = null;        </span>
<span class="nc" id="L100">        super.reset();</span>
<span class="nc" id="L101">    }</span>
    
    /**
     * Check the status end entity and the enrollment code validity
     */
    public void checkUsernameEnrollmentCode() {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (StringUtils.isNotEmpty(username)) {</span>
<span class="nc" id="L108">            final EndEntityInformation endEntityInformation = raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), username);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (endEntityInformation == null) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L111">                    log.debug(&quot;Could not find  End Entity for the username='&quot; + username + &quot;'&quot;);</span>
                }
<span class="nc" id="L113">                raLocaleBean.addMessageError(&quot;enrollwithusername_user_not_found_or_wrongstatus_or_invalid_enrollmentcode&quot;, username);</span>
<span class="nc" id="L114">                return;</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            } else if(endEntityInformation.getStatus() == EndEntityConstants.STATUS_GENERATED){</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L117">                    log.debug(&quot;End Entity status not NEW for the username='&quot; + username + &quot;', &quot;+endEntityInformation.getStatus());</span>
                }
<span class="nc" id="L119">                raLocaleBean.addMessageError(&quot;enrollwithusername_user_not_found_or_wrongstatus_or_invalid_enrollmentcode&quot;, username);</span>
<span class="nc" id="L120">                return;</span>
            }
            final String password;
            // Code for handling the case where we put enrollment code as a URL GET parameter, as well as when we enter it manually in the form
<span class="nc bnc" id="L124" title="All 4 branches missed.">            if (StringUtils.isEmpty(getEnrollmentCode()) &amp;&amp; StringUtils.isNotEmpty(paramEnrollmentCode)) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L126">                    log.debug(&quot;Password for user '&quot;+username+&quot;' was provided as parameter, using this.&quot;);</span>
                }
<span class="nc" id="L128">                password = paramEnrollmentCode;</span>
            } else {
<span class="nc" id="L130">                password = getEnrollmentCode();</span>
            }
            try {
<span class="nc" id="L133">                raMasterApiProxyBean.checkUserStatus(raAuthenticationBean.getAuthenticationToken(), username, password);</span>
<span class="nc" id="L134">            } catch (NoSuchEndEntityException | AuthStatusException | AuthLoginException e) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L136">                    log.debug(&quot;End Entity status failed status check for username='&quot; + username + &quot;', &quot;+e.getMessage());</span>
                }
<span class="nc" id="L138">                raLocaleBean.addMessageError(&quot;enrollwithusername_user_not_found_or_wrongstatus_or_invalid_enrollmentcode&quot;, username);</span>
<span class="nc" id="L139">                return;</span>
<span class="nc" id="L140">            }</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">            if (StringUtils.isEmpty(getEnrollmentCode()) &amp;&amp; StringUtils.isNotEmpty(paramEnrollmentCode)) {</span>
<span class="nc" id="L142">                endEntityInformation.setPassword(paramEnrollmentCode);</span>
            } else {
<span class="nc" id="L144">                endEntityInformation.setPassword(getEnrollmentCode());</span>
            }
<span class="nc" id="L146">            setEndEntityInformation(endEntityInformation);</span>
        }
<span class="nc" id="L148">    }</span>

    @Override
    public boolean isFinalizeEnrollmentRendered() {
<span class="nc" id="L152">        final EndEntityInformation endEntityInformation = getEndEntityInformation();</span>
<span class="nc bnc" id="L153" title="All 6 branches missed.">        return (endEntityInformation != null &amp;&amp; (endEntityInformation.getStatus() == EndEntityConstants.STATUS_NEW || endEntityInformation.getStatus() == EndEntityConstants.STATUS_KEYRECOVERY));</span>
    }

    public boolean isParamEnrollmentCodeEmpty() {
<span class="nc" id="L157">        return StringUtils.isEmpty(paramEnrollmentCode);</span>
    }

    private String certificateRequest;
    
    /** @return true if the the CSR has been uploaded */
    public boolean isUploadCsrDoneRendered() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        return getSelectedAlgorithm() != null;</span>
    }
    
    /** @return the current certificateRequest if available */
    public String getCertificateRequest() {
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (StringUtils.isEmpty(certificateRequest)) {</span>
            // Multi-line place holders are not allowed according to https://www.w3.org/TR/html5/forms.html#the-placeholder-attribute
<span class="nc" id="L171">            certificateRequest = raLocaleBean.getMessage(&quot;enroll_upload_csr_placeholder&quot;);</span>
        }
<span class="nc" id="L173">        return certificateRequest;</span>
    }

    /** @param certificateRequest the certificateRequest to set */
    public void setCertificateRequest(final String certificateRequest) {
<span class="nc" id="L178">        this.certificateRequest = certificateRequest;</span>
<span class="nc" id="L179">    }</span>
    
    /** Backing method for upload CSR button (used for uploading pasted CSR) populating fields is handled by AJAX */
    public void uploadCsr() {
<span class="nc" id="L183">    }</span>

    /** Validate an uploaded CSR and store the extracted key algorithm and CSR for later use. */
    @Override
    public final void validateCsr(FacesContext context, UIComponent component, Object value) throws ValidatorException {
<span class="nc" id="L188">        setSelectedAlgorithm(null);</span>
<span class="nc" id="L189">        final String valueStr = value.toString();</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">        if (valueStr != null &amp;&amp; valueStr.length() &gt; EnrollMakeNewRequestBean.MAX_CSR_LENGTH) {</span>
<span class="nc" id="L191">            log.info(&quot;CSR uploaded was too large: &quot;+valueStr.length());</span>
<span class="nc" id="L192">            throw new ValidatorException(new FacesMessage(raLocaleBean.getMessage(&quot;enroll_invalid_certificate_request&quot;)));            </span>
        }
<span class="nc" id="L194">        PKCS10CertificationRequest pkcs10CertificateRequest = CertTools.getCertificateRequestFromPem(valueStr);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (pkcs10CertificateRequest == null) {</span>
<span class="nc" id="L196">            throw new ValidatorException(new FacesMessage(raLocaleBean.getMessage(&quot;enroll_invalid_certificate_request&quot;)));</span>
        }
        
        //Get public key algorithm from CSR and check if it's allowed in certificate profile
<span class="nc" id="L200">        final JcaPKCS10CertificationRequest jcaPKCS10CertificationRequest = new JcaPKCS10CertificationRequest(pkcs10CertificateRequest);</span>
        try {
<span class="nc" id="L202">            final String keySpecification = AlgorithmTools.getKeySpecification(jcaPKCS10CertificationRequest.getPublicKey());</span>
<span class="nc" id="L203">            final String keyAlgorithm = AlgorithmTools.getKeyAlgorithm(jcaPKCS10CertificationRequest.getPublicKey());</span>
            // If we have an End Entity, use this to verify that the algorithm and keyspec are allowed
<span class="nc" id="L205">            final CertificateProfile certificateProfile = getCertificateProfile();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (certificateProfile != null) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                if (!certificateProfile.isKeyTypeAllowed(keyAlgorithm, keySpecification)) {</span>
<span class="nc" id="L208">                    throw new ValidatorException(new FacesMessage(raLocaleBean.getMessage(&quot;enroll_key_algorithm_is_not_available&quot;, keyAlgorithm + &quot;_&quot; + keySpecification)));</span>
                }
            } else {
<span class="nc bnc" id="L211" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L212">                    log.debug(&quot;Ignoring algorithm validation on CSR because we can not find a Certificate Profile for user: &quot;+username);</span>
                }
            }
<span class="nc" id="L215">            setSelectedAlgorithm(keyAlgorithm + &quot; &quot; + keySpecification);</span>
            // For yet unknown reasons, the setter is never when invoked during AJAX request
<span class="nc" id="L217">            certificateRequest = value.toString();</span>
<span class="nc" id="L218">        } catch (InvalidKeyException | NoSuchAlgorithmException e) {</span>
<span class="nc" id="L219">            throw new ValidatorException(new FacesMessage(raLocaleBean.getMessage(&quot;enroll_unknown_key_algorithm&quot;)));</span>
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">    }</span>

    private CertificateProfile getCertificateProfile() {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (this.certificateProfile == null) {            </span>
<span class="nc" id="L225">            EndEntityInformation ei = getEndEntityInformation();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (ei != null) {</span>
<span class="nc" id="L227">                this.certificateProfile = raMasterApiProxyBean.getCertificateProfile(ei.getCertificateProfileId());</span>
            }
        }
<span class="nc" id="L230">        return this.certificateProfile;</span>
    }

    //-----------------------------------------------------------------
    //Getters/setters
    
    /** @return the username */
    public String getUsername() {
<span class="nc" id="L238">        return username;</span>
    }

    /** @param username the username to set */
    public void setUsername(String username) {
<span class="nc" id="L243">        this.username = username;</span>
<span class="nc" id="L244">    }</span>

    /** @return the enrollment code */
    public String getEnrollmentCode() {
<span class="nc" id="L248">        return enrollmentCode;</span>
    }

    /** @param enrollmentCode the enrollment code to set */
    public void setEnrollmentCode(String enrollmentCode) {
<span class="nc" id="L253">        this.enrollmentCode = enrollmentCode;</span>
<span class="nc" id="L254">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>