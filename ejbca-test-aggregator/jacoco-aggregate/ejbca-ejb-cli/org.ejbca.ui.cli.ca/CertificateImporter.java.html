<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CertificateImporter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-ejb-cli</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.cli.ca</a> &gt; <span class="el_source">CertificateImporter.java</span></div><h1>CertificateImporter.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.ui.cli.ca;

import java.io.File;
import java.io.IOException;
import java.security.GeneralSecurityException;
import java.security.cert.Certificate;
import java.security.cert.CertificateParsingException;
import java.security.cert.X509Certificate;
import java.util.Date;
import java.util.concurrent.Callable;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.cesecore.certificates.certificate.CertificateStoreSessionRemote;
import org.cesecore.certificates.crl.RevocationReasons;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.certificates.endentity.EndEntityInformation;
import org.cesecore.certificates.endentity.EndEntityType;
import org.cesecore.certificates.endentity.EndEntityTypes;
import org.cesecore.util.CertTools;
import org.cesecore.util.EJBTools;
import org.cesecore.util.EjbRemoteHelper;
import org.cesecore.util.FileTools;
import org.cesecore.util.StringTools;
import org.ejbca.core.ejb.ra.EndEntityAccessSessionRemote;
import org.ejbca.core.ejb.ra.EndEntityManagementSessionRemote;
import org.ejbca.core.model.SecConst;
import org.ejbca.core.model.ra.raadmin.EndEntityProfileValidationException;

/**
 * Class implementing logic for importing a certificate from file.
 * @version $Id$
 */
<span class="nc" id="L50">class CertificateImporter implements Callable&lt;CertificateImporter.Result&gt; {</span>
<span class="nc" id="L51">    private static final Logger log = Logger.getLogger(CertificateImporter.class);</span>
    // Map Username -&gt; Certificate containing the usernames of end entities currently being
    // processed. If two certificates, belonging to the same end entity, are being imported at the
    // same time, one of these imports will fail with IMPORT_IN_PROGRESS to avoid transaction rollback.
    // TODO Implement this to allow CN or DN to be used as end entity username
    //private static final ConcurrentHashMap&lt;String, File&gt; usernamesBeingProcessed = new ConcurrentHashMap&lt;&gt;();

    private File file;
    private boolean resumeOnError;
    private int status;
    private int endEntityProfileId;
    private int certificateProfileId;
    private Date revocationTime;
    private RevocationReasons revocationReason;
    private String issuer;
    private String usernameFilter;
    private X509Certificate caCertificate;
    private AuthenticationToken authenticationToken;
    private CAInfo caInfo;

<span class="nc" id="L71">    public enum Result {</span>
<span class="nc" id="L72">        REDUNDANT,</span>
<span class="nc" id="L73">        CA_MISMATCH,</span>
<span class="nc" id="L74">        READ_ERROR,</span>
<span class="nc" id="L75">        CONSTRAINT_VIOLATION,</span>
<span class="nc" id="L76">        GENERAL_IMPORT_ERROR,</span>
<span class="nc" id="L77">        IMPORT_OK,</span>
    }

    public CertificateImporter setFileToImport(final File file) {
<span class="nc" id="L81">        this.file = file;</span>
<span class="nc" id="L82">        return this;</span>
    }

    public CertificateImporter setResumeOnError(final boolean resumeOnError) {
<span class="nc" id="L86">        this.resumeOnError = resumeOnError;</span>
<span class="nc" id="L87">        return this;</span>
    }

    public CertificateImporter setStatus(final int status) {
<span class="nc" id="L91">        this.status = status;</span>
<span class="nc" id="L92">        return this;</span>
    }

    public CertificateImporter setCertificateProfileId(final int certificateProfileId) {
<span class="nc" id="L96">        this.certificateProfileId = certificateProfileId;</span>
<span class="nc" id="L97">        return this;</span>
    }

    public CertificateImporter setEndEntityProfileId(final int endEntityProfileId) {
<span class="nc" id="L101">        this.endEntityProfileId = endEntityProfileId;</span>
<span class="nc" id="L102">        return this;</span>
    }

    public CertificateImporter setRevocationTime(final Date revocationTime) {
<span class="nc" id="L106">        this.revocationTime = revocationTime;</span>
<span class="nc" id="L107">        return this;</span>
    }

    public CertificateImporter setRevocationReason(final RevocationReasons revocationReason) {
<span class="nc" id="L111">        this.revocationReason = revocationReason;</span>
<span class="nc" id="L112">        return this;</span>
    }

    public CertificateImporter setIssuer(final String issuer) {
<span class="nc" id="L116">        this.issuer = issuer;</span>
<span class="nc" id="L117">        return this;</span>
    }

    public CertificateImporter setUsernameFilter(final String usernameFilter) {
<span class="nc" id="L121">        this.usernameFilter = usernameFilter;</span>
<span class="nc" id="L122">        return this;</span>
    }

    public CertificateImporter setCaCertificate(final X509Certificate caCertificate) {
<span class="nc" id="L126">        this.caCertificate = caCertificate;</span>
<span class="nc" id="L127">        return this;</span>
    }

    public CertificateImporter setAuthenticationToken(final AuthenticationToken authenticationToken) {
<span class="nc" id="L131">        this.authenticationToken = authenticationToken;</span>
<span class="nc" id="L132">        return this;</span>
    }

    public CertificateImporter setCaInfo(final CAInfo caInfo) {
<span class="nc" id="L136">        this.caInfo = caInfo;</span>
<span class="nc" id="L137">        return this;</span>
    }

    private Certificate loadCertificateFromFile(final String filename) throws IOException, CertificateParsingException {
<span class="nc" id="L141">        final byte[] bytes = FileTools.getBytesFromPEM(FileTools.readFiletoBuffer(filename), &quot;-----BEGIN CERTIFICATE-----&quot;,</span>
                &quot;-----END CERTIFICATE-----&quot;);
<span class="nc" id="L143">        return CertTools.getCertfromByteArray(bytes, Certificate.class);</span>
    }

    private String getEndEntityUsername(final String filename, final Certificate certificate, final String usernameFilter) {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (StringUtils.equalsIgnoreCase(usernameFilter, &quot;DN&quot;)) {</span>
            // Use the DN if requested, but fall-back to filename if DN is empty.
<span class="nc" id="L149">            final String dn = CertTools.getSubjectDN(certificate);</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">            if (dn == null || dn.length() == 0) {</span>
<span class="nc" id="L151">                log.warn(&quot;WARN: Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate)</span>
                        + &quot;' lacks DN, filename used instead, file: &quot; + filename);
<span class="nc" id="L153">                return filename;</span>
            } else {
<span class="nc" id="L155">                return dn;</span>
            }
<span class="nc bnc" id="L157" title="All 2 branches missed.">        } else if (StringUtils.equalsIgnoreCase(usernameFilter, &quot;CN&quot;)) {</span>
            // Use CN if requested, but fallback to DN if it's empty, or if DN is empty as well, fall back to filename.
<span class="nc" id="L159">            final String dn = CertTools.getSubjectDN(certificate);</span>
<span class="nc" id="L160">            final String cn = CertTools.getPartFromDN(dn, &quot;CN&quot;);</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">            if (cn == null || cn.length() == 0) {</span>
<span class="nc bnc" id="L162" title="All 4 branches missed.">                if (dn == null || dn.length() == 0) {</span>
<span class="nc" id="L163">                    log.warn(&quot;WARN: Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate)</span>
                            + &quot;' lacks both CN and DN, filename used instead, file: &quot; + filename);
<span class="nc" id="L165">                    return filename;</span>
                } else {
<span class="nc" id="L167">                    log.warn(&quot;WARN: Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate)</span>
                            + &quot;' lacks CN, DN used instead, file: &quot; + filename);
<span class="nc" id="L169">                    return dn;</span>
                }
            } else {
<span class="nc" id="L172">                return cn;</span>
            }
        } else {
            // Use the filename as username by default since it's something that's always present.
<span class="nc" id="L176">            return filename;</span>
        }
    }

    private boolean certificateAlreadyExists(final String fingerprint) {
<span class="nc" id="L181">        final CertificateStoreSessionRemote certificateStoreSession = EjbRemoteHelper.INSTANCE.getRemoteSession(CertificateStoreSessionRemote.class);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        return certificateStoreSession.findCertificateByFingerprintRemote(fingerprint) != null;</span>
    }

    private boolean certificateIsSignedByCa(final X509Certificate certificate, final X509Certificate caCertificate) {
        try {
<span class="nc" id="L187">            certificate.verify(caCertificate.getPublicKey());</span>
<span class="nc" id="L188">            return true;</span>
<span class="nc" id="L189">        } catch (GeneralSecurityException e) {</span>
<span class="nc" id="L190">            return false;</span>
        }
    }

    private EndEntityInformation getOrCreateUserdata(final EndEntityManagementSessionRemote endEntityManagementSession, final Certificate certificate,
            final String username) throws Exception {
<span class="nc" id="L196">        EndEntityInformation userdata = EjbRemoteHelper.INSTANCE.getRemoteSession(EndEntityAccessSessionRemote.class).findUser(authenticationToken,</span>
                username);
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if (userdata != null) {</span>
            // Return the existing user
<span class="nc" id="L200">            return userdata;</span>
        } else {
            // Add a &quot;user&quot; to map this certificate to
<span class="nc" id="L203">            final String subjectAltName = CertTools.getSubjectAlternativeName(certificate);</span>
<span class="nc" id="L204">            final String email = CertTools.getEMailAddress(certificate);</span>
<span class="nc" id="L205">            userdata = new EndEntityInformation(username, CertTools.getSubjectDN(certificate), caInfo.getCAId(), subjectAltName, email,</span>
                    EndEntityConstants.STATUS_GENERATED, new EndEntityType(EndEntityTypes.ENDUSER), endEntityProfileId, certificateProfileId, null,
                    null, SecConst.TOKEN_SOFT_BROWSERGEN, SecConst.NO_HARDTOKENISSUER, null);
<span class="nc" id="L208">            userdata.setPassword(&quot;foo123&quot;);</span>
<span class="nc" id="L209">            endEntityManagementSession.addUser(authenticationToken, userdata, false);</span>
<span class="nc" id="L210">            log.info(&quot;User '&quot; + username + &quot;' has been added.&quot;);</span>
<span class="nc" id="L211">            return userdata;</span>
        }
    }

    @Override
    public CertificateImporter.Result call() throws Exception {
        try {
            // TODO Support for CVC certificates?
<span class="nc" id="L219">            final X509Certificate certificate = (X509Certificate) loadCertificateFromFile(file.getCanonicalPath());</span>
<span class="nc" id="L220">            final String fingerprint = CertTools.getFingerprintAsString(certificate);</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (certificateAlreadyExists(fingerprint)) {</span>
<span class="nc" id="L223">                log.info(&quot;SKIP: Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate) + &quot;' is already present, file: &quot;</span>
<span class="nc" id="L224">                        + file.getName());</span>
<span class="nc" id="L225">                return Result.REDUNDANT;</span>
            }

            // Strip the username of dangerous characters before using it.
<span class="nc" id="L229">            final String username = StringTools.stripUsername(getEndEntityUsername(file.getName(), certificate, usernameFilter));</span>
<span class="nc" id="L230">            final Date now = new Date();</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (CertTools.getNotAfter(certificate).compareTo(now) &lt; 0) {</span>
                // Certificate has expired, but we are obviously keeping it for archival purposes
<span class="nc" id="L234">                status = CertificateConstants.CERT_ARCHIVED;</span>
            }

<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (!caCertificate.getSubjectX500Principal().equals(certificate.getIssuerX500Principal())) {</span>
<span class="nc" id="L238">                log.error(&quot;ERROR: The certificates issuer subject DN does not match with the specified CA's subject DN, file: &quot; + file.getName());</span>
<span class="nc" id="L239">                return Result.CA_MISMATCH;</span>
            }

<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (!certificateIsSignedByCa(certificate, caCertificate)) {</span>
<span class="nc" id="L243">                log.error(&quot;ERROR: The certificate's signature does not validate against the specified CA, file: &quot; + file.getName());</span>
<span class="nc" id="L244">                return Result.CA_MISMATCH;</span>
            }

<span class="nc" id="L247">            log.debug(&quot;Loading/updating user &quot; + username);</span>
<span class="nc" id="L248">            final EndEntityManagementSessionRemote endEntityManagementSession = EjbRemoteHelper.INSTANCE</span>
<span class="nc" id="L249">                    .getRemoteSession(EndEntityManagementSessionRemote.class);</span>
<span class="nc" id="L250">            final EndEntityInformation userdata = getOrCreateUserdata(endEntityManagementSession, certificate, username);</span>

            // addUser always adds the user with STATUS_NEW (even if we specified otherwise)
            // We always override the userdata with the info from the certificate even if the user existed.
<span class="nc" id="L254">            userdata.setStatus(EndEntityConstants.STATUS_GENERATED);</span>
<span class="nc" id="L255">            endEntityManagementSession.changeUser(authenticationToken, userdata, false);</span>
<span class="nc" id="L256">            log.info(&quot;User '&quot; + username + &quot;' has been updated.&quot;);</span>

            // Finally import the certificate and revoke it if necessary
<span class="nc" id="L259">            CertificateStoreSessionRemote certificateStoreSession = EjbRemoteHelper.INSTANCE.getRemoteSession(CertificateStoreSessionRemote.class);</span>
<span class="nc" id="L260">            certificateStoreSession.storeCertificateRemote(authenticationToken, EJBTools.wrap(certificate), username,</span>
<span class="nc" id="L261">                    CertTools.getFingerprintAsString(caCertificate), CertificateConstants.CERT_ACTIVE, CertificateConstants.CERTTYPE_ENDENTITY,</span>
<span class="nc" id="L262">                    certificateProfileId, endEntityProfileId, null, now.getTime());</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (status == CertificateConstants.CERT_REVOKED) {</span>
<span class="nc" id="L265">                endEntityManagementSession.revokeCert(authenticationToken, certificate.getSerialNumber(), revocationTime, issuer,</span>
<span class="nc" id="L266">                        revocationReason.getDatabaseValue(), false);</span>
<span class="nc" id="L267">                log.info(&quot;Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate) + &quot;' has been revoked.&quot;);</span>
            }

<span class="nc" id="L270">            log.info(&quot;Certificate with serial '&quot; + CertTools.getSerialNumberAsString(certificate) + &quot;' has been added.&quot;);</span>

<span class="nc" id="L272">            return Result.IMPORT_OK;</span>
<span class="nc" id="L273">        } catch (IOException | CertificateParsingException e) {</span>
<span class="nc" id="L274">            log.error(&quot;ERROR: A problem was encountered while reading the certificate, file: &quot; + file.getName());</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (!resumeOnError) {</span>
<span class="nc" id="L276">                throw e;</span>
            } else {
<span class="nc" id="L278">                log.error(e.getMessage());</span>
<span class="nc" id="L279">                return Result.READ_ERROR;</span>
            }
<span class="nc" id="L281">        } catch (EndEntityProfileValidationException e) {</span>
<span class="nc" id="L282">            log.error(&quot;ERROR: End entity profile constraints were violated by the certificate, file: &quot; + file.getName());</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if (!resumeOnError) {</span>
<span class="nc" id="L284">                throw e;</span>
            } else {
<span class="nc" id="L286">                log.error(e.getMessage());</span>
<span class="nc" id="L287">                return Result.CONSTRAINT_VIOLATION;</span>
            }
<span class="nc" id="L289">        } catch (Exception e) {</span>
<span class="nc" id="L290">            log.error(&quot;ERROR: Unclassified general import error has occurred, file: &quot; + file.getName() + System.lineSeparator() + &quot;  &quot;</span>
<span class="nc" id="L291">                    + e.getMessage());</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (!resumeOnError) {</span>
<span class="nc" id="L293">                throw e;</span>
            } else {
<span class="nc" id="L295">                return Result.GENERAL_IMPORT_ERROR;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>