<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CertificateFinderBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">publicweb-gui</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.web.pub.retrieve</a> &gt; <span class="el_source">CertificateFinderBean.java</span></div><h1>CertificateFinderBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.ui.web.pub.retrieve;

import java.io.UnsupportedEncodingException;
import java.math.BigInteger;
import java.net.URLEncoder;
import java.security.cert.Certificate;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.util.encoders.DecoderException;
import org.bouncycastle.util.encoders.Hex;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.ca.CaSessionLocal;
import org.cesecore.certificates.certificate.CertificateDataWrapper;
import org.cesecore.certificates.certificate.CertificateStatus;
import org.cesecore.certificates.certificate.CertificateStoreSessionLocal;
import org.cesecore.certificates.crl.RevokedCertInfo;
import org.cesecore.util.CertTools;
import org.ejbca.config.WebConfiguration;
import org.ejbca.core.ejb.ca.sign.SignSession;
import org.ejbca.core.model.util.EjbLocalHelper;
import org.ejbca.ui.web.CertificateView;

/**
 * This bean performs a number of certificate searches for the public web.
 *
 * To make it easy to use from JSTL pages, most methods take no arguments.
 * The arguments are supplied as member variables instead. &lt;br&gt;
 *
 * @version $Id: CertificateFinderBean.java 28543 2018-03-23 06:52:44Z jekaterina_b_helmes $
 */
public class CertificateFinderBean {

<span class="nc" id="L51">	private static final Logger log = Logger.getLogger(CertificateFinderBean.class);</span>

<span class="nc" id="L53">	private EjbLocalHelper ejb = new EjbLocalHelper();</span>
<span class="nc" id="L54">	private SignSession mSignSession = ejb.getSignSession();</span>
<span class="nc" id="L55">	private CaSessionLocal caSession = ejb.getCaSession();</span>
<span class="nc" id="L56">	private CertificateStoreSessionLocal mStoreSession = ejb.getCertificateStoreSession();</span>

	/** This member is used by the JSP pages to indicate which CA they are interested in.
	 * It is used by getCAInfo().
	 */
	private int mCurrentCA;

    // Used to store the result of lookupCertificateInfo
    private String issuerDN;
    private String subjectDN;
    private String serialNumber;
    private String fingerprint;

	/**
	 * Empty default constructor.
	 * NOTE: Call initialize() after creating this object.
	 */
<span class="nc" id="L73">	public CertificateFinderBean() { }</span>

	public Collection&lt;Integer&gt; getAvailableCAs() {
<span class="nc bnc" id="L76" title="All 2 branches missed.">	    if(log.isTraceEnabled()) {</span>
<span class="nc" id="L77">		log.trace(&quot;&gt;getAvailableCAs()&quot;);</span>
	    }
<span class="nc" id="L79">		return  caSession.getAllCaIds();</span>
	}

	public int getCurrentCA() {
<span class="nc" id="L83">		return mCurrentCA;</span>
	}

	public boolean existsDeltaCrlForCurrentCA() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">	    return ejb.getCrlStoreSession().getLastCRLInfo(getCAInfo().getSubjectDN(), true) != null;</span>
	}

	public void setCurrentCA(Integer currentCA) {
<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L92">			log.trace(&quot;&gt;setCurrentCA(&quot; + currentCA + &quot;)&quot;);</span>
		}
<span class="nc" id="L94">		mCurrentCA = currentCA;</span>
<span class="nc" id="L95">	}</span>

	public CAInfo getCAInfo() {
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L99">			log.trace(&quot;&gt;getCAInfo() currentCA = &quot; + mCurrentCA);</span>
		}
<span class="nc" id="L101">		CAInfo cainfo = caSession.getCAInfoInternal(mCurrentCA);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		if(cainfo == null) {</span>
<span class="nc" id="L103">		    log.info(&quot;CA does not exist : &quot;+mCurrentCA);</span>
		}
<span class="nc" id="L105">		return cainfo;</span>
	}

	public Collection&lt;CertificateGuiInfo&gt; getCACertificateChain() {
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L110">			log.trace(&quot;&gt;getCACertificateChain() currentCA = &quot; + mCurrentCA);</span>
		}
		// Make a collection of CertificateGuiInfo instead of the real certificate
<span class="nc" id="L113">		ArrayList&lt;CertificateGuiInfo&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L114">        Collection&lt;Certificate&gt; certs = mSignSession.getCertificateChain(mCurrentCA);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (Certificate cert : certs) {</span>
<span class="nc" id="L116">            ret.add(new CertificateGuiInfo(cert));</span>
<span class="nc" id="L117">        }</span>

<span class="nc" id="L119">		return ret;</span>
	}

    public Collection&lt;CertificateGuiInfo&gt; getCACertificateChainReversed() {
<span class="nc" id="L123">        Collection&lt;CertificateGuiInfo&gt; ret = getCACertificateChain();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (ret != null) {</span>
<span class="nc" id="L125">            Collections.reverse((ArrayList&lt;CertificateGuiInfo&gt;) ret);</span>
        }
<span class="nc" id="L127">        return ret;</span>
    }

	public String getCADN() {
<span class="nc" id="L131">		String ret = &quot;Unauthorized&quot;;</span>
<span class="nc" id="L132">			final Collection&lt;Certificate&gt; certs = this.mSignSession.getCertificateChain(this.mCurrentCA);</span>
<span class="nc bnc" id="L133" title="All 4 branches missed.">			if ( certs==null || certs.isEmpty() ) {</span>
<span class="nc" id="L134">				return &quot;&quot;;</span>
			}
<span class="nc" id="L136">			final Certificate cert = certs.iterator().next();</span>
<span class="nc" id="L137">			ret = CertTools.getSubjectDN(cert);</span>

<span class="nc" id="L139">		return ret;</span>
	}



	/**
	 * Get revocation info for a certificate.
	 * This method fills in the supplied RevokedCertInfo object with data about a certificate.
	 * Since Java uses &quot;call by reference&quot; this works fine, but we can't create our own object because
	 * the caller doesn't read the reference when unwinding the stack after this method returns.
	 *
	 * @param issuerDN DN of the certificate's issuer
	 * @param serialNumber The serial number of the certificate
	 * @param result An allocated object. Data about the certificate is entered in the result object by this method.
	 *        If no info can be found (e.g., if the certificate does not exist), the revocationDate and
	 *        userCertificate fields of result are set to null.
	 */
	public void lookupRevokedInfo(String issuerDN, String serialNumber, RevokedCertInfo result) {
<span class="nc" id="L157">		serialNumber = (&quot;0000000000000000&quot; + serialNumber).substring(serialNumber.length());	// Pad with zeroes up to 16 chars</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L159">			log.trace(&quot;&gt;lookupRevokedInfo(&quot; + issuerDN + &quot;, &quot; + serialNumber + &quot;, &quot; + result + &quot;)&quot;);</span>
		}
<span class="nc bnc" id="L161" title="All 2 branches missed.">		if (result == null) {</span>
<span class="nc" id="L162">			return; // There's nothing we can do here.</span>
		}
		try {
<span class="nc" id="L165">			BigInteger serialBignum = new BigInteger(Hex.decode(StringUtils.trimToEmpty(serialNumber)));</span>
<span class="nc" id="L166">			CertificateStatus info = mStoreSession.getStatus(StringUtils.trimToEmpty(issuerDN), serialBignum);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if (info.equals(CertificateStatus.NOT_AVAILABLE)) {</span>
<span class="nc" id="L168">				result.setRevocationDate(null);</span>
<span class="nc" id="L169">				result.setUserCertificate(null);</span>
			} else {
<span class="nc" id="L171">				result.setReason(info.getRevocationReason());</span>
<span class="nc" id="L172">				result.setRevocationDate(info.getRevocationDate());</span>
<span class="nc" id="L173">				result.setUserCertificate(serialBignum);</span>
			}
<span class="nc" id="L175">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L176">            log.info(&quot;Invalid serial number entered (NumberFormatException): &quot;+serialNumber+&quot;: &quot;+e.getMessage());</span>
<span class="nc" id="L177">		} catch (StringIndexOutOfBoundsException e) {</span>
<span class="nc" id="L178">			log.info(&quot;Invalid serial number entered (StringIndexOutOfBoundsException): &quot;+serialNumber+&quot;: &quot;+e.getMessage());</span>
<span class="nc" id="L179">		} catch (DecoderException e) {</span>
<span class="nc" id="L180">            log.info(&quot;Invalid serial number entered (DecoderException): &quot;+serialNumber+&quot;: &quot;+e.getMessage());</span>
<span class="nc" id="L181">		}</span>
<span class="nc" id="L182">	}</span>

	/**
	 * Uses the store session to look up all certificates for a subject.
	 * The parameter &lt;code&gt;result&lt;/code&gt; is updated so that it contains
	 * the certificates as CertificateView objects.
	 * @param subject The DN of the subject
	 * @param result a Collection (not null) that will be filled by CertificateView objects
	 */
	public void lookupCertificatesBySubject(String subject, Collection&lt;CertificateView&gt; result) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (log.isTraceEnabled()) {</span>
<span class="nc" id="L193">			log.trace(&quot;&gt;lookupCertificatesBySubject(&quot; + subject + &quot;, &quot; + result + &quot;)&quot;);</span>
		}
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (result == null) {</span>
<span class="nc" id="L196">			return; // There's nothing we can do here.</span>
		}
<span class="nc" id="L198">		result.clear();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">		if (subject == null) {</span>
<span class="nc" id="L200">			return; // We can't lookup any certificates, so return with an empty result.</span>
		}
<span class="nc" id="L202">		final List&lt;CertificateDataWrapper&gt; cdws = mStoreSession.getCertificateDatasBySubject(subject);</span>
<span class="nc" id="L203">		Collections.sort(cdws);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">		for (final CertificateDataWrapper cdw : cdws) {</span>
            // TODO: CertificateView is located in web.admin package, but this is web.pub package...
<span class="nc" id="L206">            result.add(new CertificateView(cdw));</span>
<span class="nc" id="L207">		}</span>
<span class="nc" id="L208">	}</span>

	/**
	 * Looks up a certificate information by issuer and serial number.
	 * The information can be accessed by getter methods in this class.
	 * @param issuer issuer
	 * @param serno SN
	 * @see #getIssuerDN()
	 * @see #getSubjectDN()
	 * @see #getSerialNumber()
	 */
    public void lookupCertificateInfo(String issuer, String serno) {
<span class="nc" id="L220">        BigInteger sernoBigInt = CertTools.getSerialNumberFromString(serno);</span>
<span class="nc" id="L221">        Certificate cert = mStoreSession.findCertificateByIssuerAndSerno(issuer, sernoBigInt);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (cert != null) {</span>
<span class="nc" id="L223">            this.issuerDN = CertTools.getIssuerDN(cert);</span>
<span class="nc" id="L224">            this.subjectDN = CertTools.getSubjectDN(cert);</span>
<span class="nc" id="L225">            this.serialNumber = CertTools.getSerialNumberAsString(cert);</span>
<span class="nc" id="L226">            this.fingerprint = CertTools.getFingerprintAsString(cert);</span>
        }
<span class="nc" id="L228">    }</span>

    /**
     * @return the Issuer DN string of the current certificate.
     * @see #lookupCertificateInfo(String, String)
     */
    public String getIssuerDN() {
<span class="nc" id="L235">        return issuerDN;</span>
    }

    /**
     * @return the Subject DN string of the current certificate.
     * @see #lookupCertificateInfo(String, String)
     */
    public String getSubjectDN() {
<span class="nc" id="L243">        return subjectDN;</span>
    }

	/**
	 * @return the Subject DN string of the current certificate in unescaped RDN format
	 */
	public final String getSubjectDnUnescapedRdnValue() {
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (StringUtils.isNotEmpty(subjectDN)) {</span>
<span class="nc" id="L251">			return org.ietf.ldap.LDAPDN.unescapeRDN(subjectDN);</span>
		} else {
<span class="nc" id="L253">			return subjectDN;</span>
		}
	}

    /**
     * @return the Subject DN string of the current certificate URL-encoded using the current configured character set
     * @see #lookupCertificateInfo(String, String)
     */
    public String getSubjectDNEncoded() {
<span class="nc" id="L262">        return getHttpParamAsUrlEncoded(subjectDN);</span>
    }

    /**
     * @return the serial number hex string of the current certificate.
     * @see #lookupCertificateInfo(String, String)
     */
    public String getSerialNumber() {
<span class="nc" id="L270">        return serialNumber;</span>
    }

    /**
     * @return the fingerprint string of the current certificate.
     * @see #lookupCertificateInfo(String, String)
     */
    public String getFingerprint() {
<span class="nc" id="L278">        return fingerprint;</span>
    }

    /** @param param param
     * @return the param as it's URL encoded counterpart, taking the configured encoding into account. */
    private String getHttpParamAsUrlEncoded(final String param) {
<span class="nc" id="L284">        final String encoding = WebConfiguration.getWebContentEncoding();</span>
        try {
<span class="nc" id="L286">            return URLEncoder.encode(param, encoding);</span>
<span class="nc" id="L287">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L288">            throw new IllegalStateException(&quot;The property 'web.contentencoding' is set to &quot; + encoding + &quot;, but this encoding is not available on this system.&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>