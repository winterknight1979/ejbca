<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CertReqServlet.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-test-aggregator</a> &gt; <a href="../index.html" class="el_bundle">publicweb-gui</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.ui.web.pub</a> &gt; <span class="el_source">CertReqServlet.java</span></div><h1>CertReqServlet.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.ui.web.pub;

import java.io.IOException;

import javax.ejb.EJB;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.log4j.Logger;
import org.cesecore.certificates.ca.CaSessionLocal;
import org.cesecore.certificates.certificate.CertificateStoreSessionLocal;
import org.cesecore.certificates.certificateprofile.CertificateProfileSessionLocal;
import org.cesecore.configuration.GlobalConfigurationSessionLocal;
import org.cesecore.util.CryptoProviderTools;
import org.ejbca.core.ejb.ca.auth.EndEntityAuthenticationSessionLocal;
import org.ejbca.core.ejb.ca.sign.SignSessionLocal;
import org.ejbca.core.ejb.ra.EndEntityAccessSessionLocal;
import org.ejbca.core.ejb.ra.EndEntityManagementSessionLocal;
import org.ejbca.core.ejb.ra.KeyStoreCreateSessionLocal;
import org.ejbca.core.ejb.ra.raadmin.EndEntityProfileSessionLocal;
import org.ejbca.core.model.InternalEjbcaResources;

/**
 * Servlet used to install a private key with a corresponding certificate in a browser. A new
 * certificate is installed in the browser in following steps:&lt;br&gt;
 * 1. The key pair is generated by the browser. &lt;br&gt;
 * 2. The public part is sent to the servlet in a POST together with user info (&quot;pkcs10|keygen&quot;,
 * &quot;inst&quot;, &quot;user&quot;, &quot;password&quot;). For internet explorer the public key is sent as a PKCS10
 * certificate request. &lt;br&gt;
 * 3. The new certificate is created by calling the RSASignSession session bean. &lt;br&gt;
 * 4. A page containing the new certificate and a script that installs it is returned to the
 * browser. &lt;br&gt;
 * 
 * &lt;p&gt;
 * 
 * &lt;p&gt;
 * The following initiation parameters are needed by this servlet: &lt;br&gt;
 * &quot;responseTemplate&quot; file that defines the response to the user (IE). It should have one line
 * with the text &quot;cert =&quot;. This line is replaced with the new certificate. &quot;keyStorePass&quot;.
 * Password needed to load the key-store. If this parameter is none existing it is assumed that no
 * password is needed. The path could be absolute or relative.&lt;br&gt;
 * &lt;/p&gt;
 *
 * @version $Id: CertReqServlet.java 25830 2017-05-10 13:36:45Z mikekushner $
 */
<span class="nc" id="L62">public class CertReqServlet extends HttpServlet {</span>

	private static final long serialVersionUID = 1L;
<span class="nc" id="L65">	private static final Logger log = Logger.getLogger(CertReqServlet.class);</span>
<span class="nc" id="L66">    private static final InternalEjbcaResources intres = InternalEjbcaResources.getInstance();</span>

    // This injection has been verified on JBoss
	@EJB
	private EndEntityAuthenticationSessionLocal authenticationSession;
	@EJB
	private CaSessionLocal caSession;
	@EJB
	private CertificateProfileSessionLocal certificateProfileSession;
	@EJB
	private CertificateStoreSessionLocal certificateStoreSession;
	@EJB
	private EndEntityAccessSessionLocal endEntityAccessSession;
	@EJB
	private EndEntityProfileSessionLocal endEntityProfileSession;
	@EJB
	private KeyStoreCreateSessionLocal keyStoreCreateSession;
	@EJB
	private SignSessionLocal signSession;
	@EJB
	private EndEntityManagementSessionLocal endEntityManagementSession;
	@EJB
	private GlobalConfigurationSessionLocal globalConfigurationSession;

    /**
     * Servlet init
     * 
     * @param config
     *            servlet configuration
     * 
     * @throws ServletException
     *             on error
     */
    public void init(ServletConfig config) throws ServletException {
<span class="nc" id="L100">        super.init(config);</span>
        // Install BouncyCastle provider
<span class="nc" id="L102">        CryptoProviderTools.installBCProvider();</span>
<span class="nc" id="L103">    }</span>

    /**
     * Handles HTTP POST
     * 
     * @param request
     *            servlet request
     * @param response
     *            servlet response
     * 
     * @throws IOException
     *             input/output error
     * @throws ServletException
     *             on error
     */
    public void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
<span class="nc" id="L119">        new RequestInstance(getServletContext(), getServletConfig(), endEntityAccessSession, caSession,</span>
                certificateProfileSession, endEntityProfileSession, keyStoreCreateSession, signSession, endEntityManagementSession,
<span class="nc" id="L121">                globalConfigurationSession).doPost(request, response);</span>
<span class="nc" id="L122">    }</span>

    /**
     * Handles HTTP GET
     * 
     * @param request
     *            servlet request
     * @param response
     *            servlet response
     * 
     * @throws IOException
     *             input/output error
     * @throws ServletException
     *             on error
     */
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
<span class="nc" id="L138">        log.trace(&quot;&gt;doGet()&quot;);</span>
<span class="nc" id="L139">        response.setHeader(&quot;Allow&quot;, &quot;POST&quot;);</span>

<span class="nc" id="L141">        ServletDebug debug = new ServletDebug(request, response);</span>
<span class="nc" id="L142">        String iMsg = intres.getLocalizedMessage(&quot;certreq.postonly&quot;);</span>
<span class="nc" id="L143">        debug.print(iMsg);</span>
<span class="nc" id="L144">        debug.printDebugInfo();</span>
<span class="nc" id="L145">        log.trace(&quot;&lt;doGet()&quot;);</span>
<span class="nc" id="L146">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>