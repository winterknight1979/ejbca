<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>EndEntityCertificateAuthenticationModule.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-ejb</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.protocol.cmp.authentication</a> &gt; <span class="el_source">EndEntityCertificateAuthenticationModule.java</span></div><h1>EndEntityCertificateAuthenticationModule.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.ejbca.core.protocol.cmp.authentication;

import java.lang.reflect.InvocationTargetException;
import java.security.InvalidAlgorithmParameterException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.Signature;
import java.security.SignatureException;
import java.security.cert.CertPath;
import java.security.cert.CertPathValidator;
import java.security.cert.CertPathValidatorException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.security.cert.CertificateExpiredException;
import java.security.cert.CertificateFactory;
import java.security.cert.CertificateNotYetValidException;
import java.security.cert.PKIXCertPathValidatorResult;
import java.security.cert.PKIXParameters;
import java.security.cert.TrustAnchor;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.DEROctetString;
import org.bouncycastle.asn1.cmp.CMPCertificate;
import org.bouncycastle.asn1.cmp.PKIMessage;
import org.bouncycastle.asn1.cmp.RevDetails;
import org.bouncycastle.asn1.cmp.RevReqContent;
import org.bouncycastle.asn1.crmf.CertReqMessages;
import org.bouncycastle.asn1.crmf.CertReqMsg;
import org.bouncycastle.asn1.crmf.CertTemplate;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.cert.X509CertificateHolder;
import org.bouncycastle.cert.jcajce.JcaX509CertificateConverter;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.cesecore.authentication.tokens.AuthenticationSubject;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authorization.AuthorizationDeniedException;
import org.cesecore.authorization.AuthorizationSession;
import org.cesecore.authorization.control.StandardRules;
import org.cesecore.certificates.ca.CADoesntExistsException;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.ca.CaSession;
import org.cesecore.certificates.ca.IllegalNameException;
import org.cesecore.certificates.certificate.CertificateConstants;
import org.cesecore.certificates.certificate.CertificateInfo;
import org.cesecore.certificates.certificate.CertificateStoreSession;
import org.cesecore.certificates.certificate.exception.CertificateSerialNumberException;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.certificates.certificateprofile.CertificateProfileSession;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.certificates.endentity.EndEntityInformation;
import org.cesecore.util.CertTools;
import org.cesecore.util.ValidityDate;
import org.ejbca.config.CmpConfiguration;
import org.ejbca.core.ejb.authentication.web.WebAuthenticationProviderSessionLocal;
import org.ejbca.core.ejb.ra.EndEntityAccessSession;
import org.ejbca.core.ejb.ra.EndEntityManagementSession;
import org.ejbca.core.ejb.ra.NoSuchEndEntityException;
import org.ejbca.core.ejb.ra.raadmin.EndEntityProfileSession;
import org.ejbca.core.model.approval.ApprovalException;
import org.ejbca.core.model.approval.WaitingForApprovalException;
import org.ejbca.core.model.authorization.AccessRulesConstants;
import org.ejbca.core.model.ra.CustomFieldException;
import org.ejbca.core.model.ra.raadmin.EndEntityProfile;
import org.ejbca.core.model.ra.raadmin.EndEntityProfileNotFoundException;
import org.ejbca.core.model.ra.raadmin.EndEntityProfileValidationException;
import org.ejbca.core.protocol.cmp.CmpMessageHelper;
import org.ejbca.core.protocol.cmp.CmpPKIBodyConstants;
import org.ejbca.util.passgen.IPasswordGenerator;
import org.ejbca.util.passgen.PasswordGeneratorFactory;

/**
 * Check the authentication of the PKIMessage by verifying the signature of the administrator who sent the message
 *
 * @version $Id: EndEntityCertificateAuthenticationModule.java 30979 2019-01-03 16:25:25Z samuellb $
 *
 */
public class EndEntityCertificateAuthenticationModule implements ICMPAuthenticationModule {

<span class="nc" id="L103">    private static final Logger log = Logger.getLogger(EndEntityCertificateAuthenticationModule.class);</span>

    private String authenticationparameter;
    private String password;
    private String errorMessage;
    private Certificate extraCert;
    private String confAlias;
    private CmpConfiguration cmpConfiguration;
    private boolean authenticated;

    private AuthenticationToken admin;
    private CaSession caSession;
    private CertificateStoreSession certSession;
    private AuthorizationSession authSession;
    private EndEntityProfileSession eeProfileSession;
    private CertificateProfileSession certProfileSession;
    private EndEntityAccessSession eeAccessSession;
    private WebAuthenticationProviderSessionLocal authenticationProviderSession;
    private EndEntityManagementSession eeManagementSession;

    /** Definition of the optional Vendor mode implementation */
    private static final String implClassName = &quot;org.ejbca.core.protocol.cmp.authentication.CmpVendorModeImpl&quot;;
    /** Cache class so we don't have to do Class.forName for every entity object created */
<span class="nc" id="L126">    private static volatile Class&lt;?&gt; implClass = null;</span>
    /** Optimization variable so we don't have to check for existence of implClass for every construction of an object */
<span class="nc" id="L128">    private static volatile boolean implExists = true;</span>

    private CmpVendorMode impl;

    public EndEntityCertificateAuthenticationModule( final AuthenticationToken admin, String authparam, String confAlias,
            CmpConfiguration cmpConfig, boolean authenticated,
            final CaSession caSession, final CertificateStoreSession certSession, final AuthorizationSession authSession,
            final EndEntityProfileSession eeprofSession, final CertificateProfileSession cprofSession, final EndEntityAccessSession eeaccessSession,
<span class="nc" id="L136">            final WebAuthenticationProviderSessionLocal authProvSession, final EndEntityManagementSession endEntityManagementSession) {</span>
<span class="nc" id="L137">        authenticationparameter = authparam;</span>
<span class="nc" id="L138">        password = null;</span>
<span class="nc" id="L139">        errorMessage = null;</span>
<span class="nc" id="L140">        extraCert = null;</span>
<span class="nc" id="L141">        this.confAlias = confAlias;</span>
<span class="nc" id="L142">        this.cmpConfiguration = cmpConfig;</span>
<span class="nc" id="L143">        this.authenticated = authenticated;</span>

<span class="nc" id="L145">        this.admin = admin;</span>
<span class="nc" id="L146">        this.caSession = caSession;</span>
<span class="nc" id="L147">        this.certSession = certSession;</span>
<span class="nc" id="L148">        this.authSession = authSession;</span>
<span class="nc" id="L149">        this.eeProfileSession = eeprofSession;</span>
<span class="nc" id="L150">        this.certProfileSession = cprofSession;</span>
<span class="nc" id="L151">        eeAccessSession = eeaccessSession;</span>
<span class="nc" id="L152">        authenticationProviderSession = authProvSession;</span>
<span class="nc" id="L153">        eeManagementSession = endEntityManagementSession;</span>

<span class="nc" id="L155">        createVendorModeImpl();</span>
<span class="nc" id="L156">    }</span>

    /** Creates the implementation for CMP vendor mode, if it exists. If it does not exist, uses a CmpVendorModeNoop implementation that
     * return false on the question of CMP Vendor mode is used.
     */
    private void createVendorModeImpl() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (implExists) {</span>
            try {
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (implClass == null) {</span>
                    // We only end up here once, if the class does not exist, we will never end up here again (ClassNotFoundException)
                    // and if the class exists we will never end up here again (it will not be null)
<span class="nc" id="L167">                    implClass = Class.forName(implClassName);</span>
<span class="nc" id="L168">                    log.debug(&quot;CmpVendorModeImpl is available, and used, in this version of EJBCA.&quot;);</span>
                }
<span class="nc" id="L170">                impl = (CmpVendorMode)implClass.getConstructor().newInstance();</span>
<span class="nc" id="L171">                impl.setCaSession(caSession);</span>
<span class="nc" id="L172">                impl.setCmpConfiguration(cmpConfiguration);</span>
<span class="nc" id="L173">            } catch (ClassNotFoundException | NoSuchMethodException e) {</span>
                // We only end up here once, if the class does not exist, we will never end up here again
<span class="nc" id="L175">                implExists = false;</span>
<span class="nc" id="L176">                log.info(&quot;CMP Vendor mode is not available in the version of EJBCA.&quot;);</span>
<span class="nc" id="L177">                impl = new CmpVendorModeNoopImpl();</span>
<span class="nc" id="L178">            } catch (InstantiationException | InvocationTargetException e) {</span>
<span class="nc" id="L179">                log.error(&quot;Error intitilizing CmpVendorMode: &quot;, e);</span>
<span class="nc" id="L180">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L181">                log.error(&quot;Error intitilizing CmpVendorMode: &quot;, e);</span>
<span class="nc" id="L182">            }</span>
        } else {
<span class="nc" id="L184">            impl = new CmpVendorModeNoopImpl();</span>
        }
<span class="nc" id="L186">    }</span>


    @Override
    public String getName() {
<span class="nc" id="L191">        return CmpConfiguration.AUTHMODULE_ENDENTITY_CERTIFICATE;</span>
    }

    @Override
    public String getAuthenticationString() {
<span class="nc" id="L196">        return this.password;</span>
    }

    @Override
    public String getErrorMessage() {
<span class="nc" id="L201">        return this.errorMessage;</span>
    }

    /**
     * Get the certificate that was attached to the CMP request in it's extraCert filed.
     *
     * @return The certificate that was attached to the CMP request in it's extraCert filed
     */
    public Certificate getExtraCert() {
<span class="nc" id="L210">        return extraCert;</span>
    }

    /**
     * Get the end entity certificate that was attached to the CMP request in it's extreCert filed.
     * If the extraCerts field contains multiple certificates, these are ordered in a CertPath and the leaf certificate is returned.
     * @param msg Message
     *
     * @return The end entity certificate that was attached to the CMP request in it's extraCert field, or null, as an ordered certificate path with leaf certificate in first position
     */
    private List&lt;X509Certificate&gt; getExtraCerts(final PKIMessage msg) {
<span class="nc" id="L221">        final CMPCertificate[] extraCerts = msg.getExtraCerts();</span>
<span class="nc bnc" id="L222" title="All 4 branches missed.">        if ((extraCerts == null) || (extraCerts.length == 0)) {</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L224">                log.debug(&quot;There are no certificates in the extraCert field in the PKIMessage&quot;);</span>
            }
<span class="nc" id="L226">            return null;</span>
        } else {
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L229">                log.debug(extraCerts.length+ &quot; certificate(s) found in the extraCert field in the CMP message&quot;);</span>
            }
        }

        try {
            //Read the extraCerts. Convert to an array of normal X509Certificates so we can later use a regular CertPath validator
<span class="nc" id="L235">            List&lt;X509Certificate&gt; certlist = new ArrayList&lt;X509Certificate&gt;();</span>
            // Create CertPath
<span class="nc" id="L237">            final JcaX509CertificateConverter jcaX509CertificateConverter = new JcaX509CertificateConverter();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">            for (int i = 0; i &lt; extraCerts.length; i++) {</span>
<span class="nc" id="L239">                certlist.add(jcaX509CertificateConverter.getCertificate(new X509CertificateHolder(extraCerts[i].getX509v3PKCert())));</span>
            }
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (!certlist.isEmpty()) {</span>
<span class="nc" id="L242">                List&lt;X509Certificate&gt; orderedCerts = CertTools.orderX509CertificateChain(certlist);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L244">                    log.debug(&quot;Obtaining &quot; +certlist.size()+ &quot; certificate(s) from extraCert field was done successfully.&quot;);</span>
                }
<span class="nc bnc" id="L246" title="All 2 branches missed.">                if (log.isTraceEnabled()) {</span>
<span class="nc" id="L247">                    log.trace(&quot;extraCerts obtained: &quot;+orderedCerts);</span>
                }
<span class="nc" id="L249">                return orderedCerts;</span>
            } else {
<span class="nc bnc" id="L251" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L252">                    log.debug(&quot;Obtaining the certificate from extraCert field failed, the result was null.&quot;);</span>
                }
            }
<span class="nc" id="L255">        } catch (CertificateException e) {</span>
            // We only log debug to prevent DOS attacks (log spamming) by sending invalid messages
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L258">                log.debug(e.getLocalizedMessage(), e);</span>
            }
<span class="nc" id="L260">        } catch (CertPathValidatorException e) {</span>
            // We only log debug to prevent DOS attacks (log spamming) by sending invalid messages
<span class="nc bnc" id="L262" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L263">                log.debug(&quot;extraCerts does not contain a valid certificate path: &quot;+e.getMessage());</span>
            }
<span class="nc" id="L265">        }</span>
<span class="nc" id="L266">        return null;</span>
    }

    @Override
    /*
     * Verifies the signature of 'msg'. msg should be signed and the signer's certificate should be
     * attached in msg in the extraCert field.
     *
     * When successful, the authentication string is set.
     */
    public boolean verifyOrExtract(final PKIMessage msg, final String username) {

        //Check that msg is signed
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if(msg.getProtection() == null) {</span>
<span class="nc" id="L280">            this.errorMessage = &quot;PKI Message is not authenticated properly. No PKI protection is found.&quot;;</span>
<span class="nc" id="L281">            return false;</span>
        }

        // Read the extraCert and store it in a local variable
<span class="nc" id="L285">        List&lt;X509Certificate&gt; extraCertPath = getExtraCerts(msg);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        extraCert = (extraCertPath != null ? extraCertPath.get(0) : null);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if(extraCert == null) {</span>
<span class="nc" id="L288">            this.errorMessage = &quot;Error while reading the certificate in the extraCert field&quot;;</span>
<span class="nc" id="L289">            return false;</span>
        }

        // A CMP KeyUpdateRequest is always regarding an end entity that already exists. If that end entity
        // does not exist, no point in looking further
<span class="nc" id="L294">        EndEntityInformation endentity = null;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if(msg.getBody().getType() == CmpPKIBodyConstants.KEYUPDATEREQUEST) {</span>
            try {
<span class="nc" id="L297">                endentity = getEndEntityFromKeyUpdateRequest(msg);</span>
<span class="nc" id="L298">            } catch (AuthorizationDeniedException e1) {</span>
                // note: this should not happen since at this point, this is an AlwaysAllowed token
<span class="nc" id="L300">                this.errorMessage = &quot;Administrator &quot; + admin.toString() + &quot; is not authorized to retrieve end entity&quot;;</span>
<span class="nc" id="L301">                return false;</span>
<span class="nc" id="L302">            }</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if(endentity == null) {</span>
<span class="nc" id="L304">                this.errorMessage = &quot;Error. Received a CMP KeyUpdateRequest for a non-existing end entity&quot;;</span>
<span class="nc" id="L305">                return false;</span>
            }
        }

<span class="nc" id="L309">        boolean vendormode = impl.isVendorCertificateMode(msg.getBody().getType(), this.confAlias);</span>
<span class="nc" id="L310">        boolean omitVerifications = cmpConfiguration.getOmitVerificationsInEEC(confAlias);</span>
<span class="nc" id="L311">        boolean ramode = cmpConfiguration.getRAMode(confAlias);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L313">            log.debug(&quot;CMP is operating in RA mode: &quot; + this.cmpConfiguration.getRAMode(this.confAlias));</span>
<span class="nc" id="L314">            log.debug(&quot;CMP is operating in Vendor mode: &quot; + vendormode);</span>
<span class="nc" id="L315">            log.debug(&quot;CMP message already been authenticated: &quot; + authenticated);</span>
<span class="nc" id="L316">            log.debug(&quot;Omitting some verifications: &quot; + omitVerifications);</span>
<span class="nc" id="L317">            log.debug(&quot;CMP message (claimed to be) signed by (cert from extraCerts): SubjectDN '&quot; + CertTools.getSubjectDN(extraCert)+&quot;' IssuerDN '&quot;+CertTools.getIssuerDN(extraCert) +&quot;'&quot;);</span>
        }

        //----------------------------------------------------------------------------------------
        // Perform the different checks depending on the configuration and previous authentication
        //----------------------------------------------------------------------------------------

        // Not allowed combinations.
<span class="nc bnc" id="L325" title="All 4 branches missed.">        if(ramode &amp;&amp; vendormode) {</span>
<span class="nc" id="L326">            this.errorMessage = &quot;Vendor mode and RA mode cannot be combined&quot;;</span>
<span class="nc" id="L327">            return false;</span>
        }
<span class="nc bnc" id="L329" title="All 6 branches missed.">        if(omitVerifications &amp;&amp; (!ramode || !authenticated)) {</span>
<span class="nc" id="L330">            this.errorMessage = &quot;Omitting some verifications can only be accepted in RA mode and when the &quot; +</span>
                                 &quot;CMP request has already been authenticated, for example, through the use of NestedMessageContent&quot;;
<span class="nc" id="L332">            return false;</span>
        }

        // Accepted combinations
<span class="nc bnc" id="L336" title="All 6 branches missed.">        if(omitVerifications &amp;&amp; ramode &amp;&amp; authenticated) {</span>
            // Do nothing here
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L339">                log.debug(&quot;Skipping some verification of the extraCert certificate in RA mode and an already authenticated CMP message, tex. through NestedMessageContent&quot;);</span>
            }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        } else if(ramode) {</span>

            // Get the CA to use for the authentication
<span class="nc" id="L344">            CAInfo cainfo = getCAInfoByName(authenticationparameter);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if(cainfo == null) {</span>
<span class="nc" id="L346">                return false;</span>
            }

            // Check that extraCert is in the Database
<span class="nc" id="L350">            CertificateInfo certinfo = certSession.getCertificateInfo(CertTools.getFingerprintAsString(extraCert));</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if(certinfo == null) {</span>
<span class="nc" id="L352">                this.errorMessage = &quot;The certificate attached to the PKIMessage in the extraCert field could not be found in the database.&quot;;</span>
<span class="nc" id="L353">                return false;</span>
            }

            // More extraCert verifications
<span class="nc bnc" id="L357" title="All 4 branches missed.">            if(!isExtraCertValidAndIssuedByCA(extraCertPath, cainfo) || !isExtraCertActive(certinfo)) {</span>
<span class="nc" id="L358">                return false;</span>
            } else {
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L361">                    log.debug(&quot;Certificate in extraCerts field is issued by &quot; + cainfo.getName() + &quot;, is valid and active&quot;);</span>
                }
            }

            // Check that extraCert belong to an admin with sufficient access rights
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if(!isAuthorizedAdmin(certinfo, msg, endentity)){</span>
<span class="nc" id="L367">                this.errorMessage = &quot;'&quot; + CertTools.getSubjectDN(extraCert) + &quot;' is not an authorized administrator.&quot;;</span>
<span class="nc" id="L368">                return false;</span>
            }

<span class="nc bnc" id="L371" title="All 2 branches missed.">        } else if(!ramode) { // client mode</span>

<span class="nc" id="L373">            String extraCertUsername = null;</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if(vendormode) {</span>

                // Check that extraCert is issued  by a configured VendorCA
<span class="nc" id="L377">                final CAInfo cainfo = impl.isExtraCertIssuedByVendorCA(admin, this.confAlias, extraCertPath);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">                if (cainfo == null) {</span>
<span class="nc" id="L379">                    this.errorMessage = &quot;The certificate in extraCert field is not issued by any of the configured Vendor CAs: &quot; + cmpConfiguration.getVendorCA(confAlias);</span>
<span class="nc" id="L380">                    return false;</span>
                }

                // Extract the username from extraCert to use for  further authentication
<span class="nc" id="L384">                String subjectDN = CertTools.getSubjectDN(extraCert);</span>
<span class="nc" id="L385">                extraCertUsername = CertTools.getPartFromDN(subjectDN, this.cmpConfiguration.getExtractUsernameComponent(this.confAlias));</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L387">                    log.debug(&quot;Username (&quot;+extraCertUsername+&quot;) was extracted from the '&quot; + this.cmpConfiguration.getExtractUsernameComponent(this.confAlias) + &quot;' part of the subjectDN of the certificate in the 'extraCerts' field.&quot;);</span>
                }

                // More extraCert verifications
<span class="nc bnc" id="L391" title="All 2 branches missed.">                if (!isExtraCertValidAndIssuedByCA(extraCertPath, cainfo)) {</span>
<span class="nc" id="L392">                    return false;</span>
                }
<span class="nc" id="L394">            } else {</span>

                // Get the CA to use for the authentication
<span class="nc" id="L397">                CAInfo cainfo = getCAInfoByIssuer(CertTools.getIssuerDN(extraCert));</span>
                // Check that extraCert is in the Database
<span class="nc" id="L399">                CertificateInfo certinfo = certSession.getCertificateInfo(CertTools.getFingerprintAsString(extraCert));</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                if(certinfo == null) {</span>
<span class="nc" id="L401">                    this.errorMessage = &quot;The certificate attached to the PKIMessage in the extraCert field could not be found in the database.&quot;;</span>
<span class="nc" id="L402">                    return false;</span>
                }

                // More extraCert verifications
<span class="nc bnc" id="L406" title="All 4 branches missed.">                if(!isExtraCertValidAndIssuedByCA(extraCertPath, cainfo) || !isExtraCertActive(certinfo)) {</span>
<span class="nc" id="L407">                    return false;</span>
                }

                // Extract the username from extraCert to use for  further authentication
<span class="nc" id="L411">                extraCertUsername = certinfo.getUsername();</span>
            }

            // Check if this certificate belongs to the user
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if ( (username != null) &amp;&amp; (extraCertUsername != null) ) {</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                if (cmpConfiguration.getVendorMode(this.confAlias)) {</span>
<span class="nc" id="L417">                    String fix = cmpConfiguration.getRANameGenPrefix(this.confAlias);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                    if (StringUtils.isNotBlank(fix)) {</span>
<span class="nc" id="L419">                        log.info(&quot;Preceded RA name prefix '&quot; + fix + &quot;' to username '&quot; + username + &quot;' in CMP vendor mode.&quot;);</span>
<span class="nc" id="L420">                        extraCertUsername = fix + extraCertUsername;</span>
                    }
<span class="nc" id="L422">                    fix = cmpConfiguration.getRANameGenPostfix(this.confAlias);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">                    if (StringUtils.isNotBlank( cmpConfiguration.getRANameGenPostfix(this.confAlias))) {</span>
<span class="nc" id="L424">                        log.info(&quot;Attached RA name postfix '&quot; + fix + &quot;' to username '&quot; + username + &quot;' in CMP vendor mode.&quot;);</span>
<span class="nc" id="L425">                        extraCertUsername += fix;</span>
                    }
                }
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (!StringUtils.equals(username, extraCertUsername)) {</span>
<span class="nc" id="L429">                    this.errorMessage = &quot;The End Entity certificate attached to the PKIMessage in the extraCert field does not belong to user '&quot;+username+&quot;'&quot;;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">                    if(log.isDebugEnabled()) {</span>
                        // Use a different debug message, as not to reveal too much information
<span class="nc" id="L432">                        log.debug(this.errorMessage + &quot;, but to user '&quot;+extraCertUsername+&quot;'&quot;);</span>
                    }
<span class="nc" id="L434">                    return false;</span>
                }

                //set the password of the request to this user's password so it can later be used when issuing the certificate
<span class="nc bnc" id="L438" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L439">                    log.debug(&quot;The End Entity certificate attached to the PKIMessage in the extraCert field belongs to user '&quot;+username+&quot;'.&quot;);</span>
<span class="nc" id="L440">                    log.debug(&quot;Extracting and setting password for user '&quot;+username+&quot;'.&quot;);</span>
                }
                try {
<span class="nc" id="L443">                    EndEntityInformation user = eeAccessSession.findUser(admin, username);</span>
<span class="nc" id="L444">                    password = user.getPassword();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                    if(password == null) {</span>
<span class="nc" id="L446">                        password = genRandomPwd();</span>
<span class="nc" id="L447">                        user.setPassword(password);</span>
<span class="nc" id="L448">                        eeManagementSession.changeUser(admin, user, false);</span>
                    }
<span class="nc" id="L450">                } catch (AuthorizationDeniedException | IllegalNameException | CADoesntExistsException | EndEntityProfileValidationException</span>
                        | WaitingForApprovalException | CertificateSerialNumberException | ApprovalException | NoSuchEndEntityException | CustomFieldException e) {
<span class="nc bnc" id="L452" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L453">                        log.debug(e.getLocalizedMessage());</span>
                    }
<span class="nc" id="L455">                    this.errorMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L456">                    return false;</span>
<span class="nc" id="L457">                }</span>
            } else {
<span class="nc bnc" id="L459" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L460">                    log.debug(&quot;Certificate does not belong to user. Username='&quot;+username+&quot;', extraCert username='&quot;+extraCertUsername+&quot;'.&quot;);</span>
                }

            }
        }

        //-------------------------------------------------------------
        //Begin the signature verification process.
        //Verify the signature of msg using the public key of extraCert
        //-------------------------------------------------------------
        try {
<span class="nc" id="L471">            final Signature sig = Signature.getInstance(msg.getHeader().getProtectionAlg().getAlgorithm().getId(), BouncyCastleProvider.PROVIDER_NAME);</span>
<span class="nc" id="L472">            sig.initVerify(extraCert.getPublicKey());</span>
<span class="nc" id="L473">            sig.update(CmpMessageHelper.getProtectedBytes(msg));</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">            if (sig.verify(msg.getProtection().getBytes())) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                if (password == null) {</span>
                    // If not set earlier
<span class="nc" id="L477">                    password = genRandomPwd();</span>
                }
            } else {
<span class="nc" id="L480">                this.errorMessage = &quot;Failed to verify the signature in the PKIMessage&quot;;</span>
<span class="nc" id="L481">                return false;</span>
            }
<span class="nc" id="L483">        } catch (InvalidKeyException e) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L485">                log.debug(e.getLocalizedMessage());</span>
            }
<span class="nc" id="L487">            this.errorMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L488">            return false;</span>
<span class="nc" id="L489">        } catch (NoSuchAlgorithmException e) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L491">                log.debug(e.getLocalizedMessage());</span>
            }
<span class="nc" id="L493">            this.errorMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L494">            return false;</span>
<span class="nc" id="L495">        } catch (NoSuchProviderException e) {</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L497">                log.debug(e.getLocalizedMessage());</span>
            }
<span class="nc" id="L499">            this.errorMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L500">            return false;</span>
<span class="nc" id="L501">        } catch (SignatureException e) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L503">                log.debug(e.getLocalizedMessage());</span>
            }
<span class="nc" id="L505">            this.errorMessage = e.getLocalizedMessage();</span>
<span class="nc" id="L506">            return false;</span>
<span class="nc" id="L507">        }</span>

<span class="nc bnc" id="L509" title="All 2 branches missed.">        return this.password != null;</span>
    }

    /**
     * Generated a random password of 16 digits.
     *
     * @return a randomly generated password
     */
    private String genRandomPwd() {
<span class="nc" id="L518">        final IPasswordGenerator pwdgen = PasswordGeneratorFactory.getInstance(PasswordGeneratorFactory.PASSWORDTYPE_ALLPRINTABLE);</span>
<span class="nc" id="L519">        return pwdgen.getNewPassword(12, 12);</span>
    }

    private EndEntityInformation getEndEntityFromKeyUpdateRequest(final PKIMessage pkimessage) throws AuthorizationDeniedException {
<span class="nc" id="L523">        String subjectDN=&quot;&quot;, issuerDN=&quot;&quot;;</span>

<span class="nc bnc" id="L525" title="All 2 branches missed.">        if(cmpConfiguration.getRAMode(confAlias)) {</span>
<span class="nc" id="L526">            CertReqMessages kur = (CertReqMessages) pkimessage.getBody().getContent();</span>
            CertReqMsg certmsg;
            try {
<span class="nc" id="L529">                certmsg = kur.toCertReqMsgArray()[0];</span>
<span class="nc" id="L530">            } catch(Exception e) {</span>
<span class="nc" id="L531">                log.debug(&quot;Could not parse the KeyUpdate request. Trying to parse it as novosec generated message.&quot;);</span>
<span class="nc" id="L532">                certmsg = CmpMessageHelper.getNovosecCertReqMsg(kur);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                if(certmsg == null) {</span>
<span class="nc" id="L534">                    log.info(&quot;Error. Failed to parse CMP message novosec generated message. &quot; + e.getLocalizedMessage());</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    if(log.isDebugEnabled()) {</span>
<span class="nc" id="L536">                        log.debug(e);</span>
                    }
<span class="nc" id="L538">                    return null;</span>
                } else {
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    if(log.isDebugEnabled()) {</span>
<span class="nc" id="L541">                        log.debug(&quot;Succeeded in parsing the novosec generated request.&quot;);</span>
                    }
                }
<span class="nc" id="L544">            }</span>

<span class="nc" id="L546">            X500Name dn = certmsg.getCertReq().getCertTemplate().getSubject();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">            if(dn != null) {</span>
<span class="nc" id="L548">                subjectDN = dn.toString();</span>
            }
<span class="nc" id="L550">            dn = certmsg.getCertReq().getCertTemplate().getIssuer();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">            if(dn != null) {</span>
<span class="nc" id="L552">                issuerDN = dn.toString();</span>
            }
<span class="nc" id="L554">        } else {</span>
<span class="nc" id="L555">            subjectDN = CertTools.getSubjectDN(extraCert);</span>
<span class="nc" id="L556">            issuerDN = CertTools.getIssuerDN(extraCert);</span>
        }
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if(log.isDebugEnabled()) {</span>
<span class="nc" id="L559">            log.debug(&quot;Received a CMP KeyUpdateRequest for an endentity with SubjectDN '&quot; + subjectDN + &quot;' and issuerDN '&quot; + issuerDN + &quot;'&quot;);</span>
        }

<span class="nc" id="L562">        EndEntityInformation userdata = null;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">        if(StringUtils.isEmpty(issuerDN)) {</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L565">                log.debug(&quot;The CMP KeyUpdateRequest did not specify an issuer&quot;);</span>
            }
<span class="nc" id="L567">            List&lt;EndEntityInformation&gt; userdataList = eeAccessSession.findUserBySubjectDN(admin, subjectDN);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">            if (userdataList.size() &gt; 0) {</span>
<span class="nc" id="L569">                userdata = userdataList.get(0);</span>
            }
<span class="nc bnc" id="L571" title="All 2 branches missed.">            if (userdataList.size() &gt; 1) {</span>
<span class="nc" id="L572">                log.warn(&quot;Multiple end entities with subject DN &quot; + subjectDN + &quot; were found. This may lead to unexpected behavior.&quot;);</span>
            }
<span class="nc" id="L574">        } else {</span>
<span class="nc" id="L575">            List&lt;EndEntityInformation&gt; userdataList = eeAccessSession.findUserBySubjectAndIssuerDN(admin, subjectDN, issuerDN);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">            if (userdataList.size() &gt; 0) {</span>
<span class="nc" id="L577">                userdata = userdataList.get(0);</span>
            }
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if (userdataList.size() &gt; 1) {</span>
<span class="nc" id="L580">                log.warn(&quot;Multiple end entities with subject DN &quot; + subjectDN + &quot; and issuer DN&quot; + issuerDN</span>
                        + &quot; were found. This may lead to unexpected behavior.&quot;);
            }
        }

<span class="nc" id="L585">        return userdata;</span>
    }

    /**
     * Checks if cert belongs to an administrator who is authorized to process the request.
     *
     * @param certInfo Info
     * @param msg Message
     * @param endentity Only used when the message received is a KeyUpdateRequest in RA mode. The administrator is authorized to handle a KeyUpdateRequest in RA mode if
     *                  it is authorized to the EndEntityProfile, CertificateProfile and the CA specified in this end entity.
     * @return true if the administrator is authorized to process the request and false otherwise.
     */
    private boolean isAuthorizedAdmin(final CertificateInfo certInfo, final PKIMessage msg, final EndEntityInformation endentity) {

<span class="nc" id="L599">        X509Certificate x509cert = (X509Certificate) extraCert;</span>
<span class="nc" id="L600">        Set&lt;X509Certificate&gt; credentials = new HashSet&lt;X509Certificate&gt;();</span>
<span class="nc" id="L601">        credentials.add(x509cert);</span>

<span class="nc" id="L603">        AuthenticationSubject subject = new AuthenticationSubject(null, credentials);</span>
<span class="nc" id="L604">        AuthenticationToken reqAuthToken = authenticationProviderSession.authenticate(subject);</span>

<span class="nc" id="L606">        final int tagnr = msg.getBody().getType();</span>
<span class="nc bnc" id="L607" title="All 4 branches missed.">        if( (tagnr == CmpPKIBodyConstants.CERTIFICATAIONREQUEST) || (tagnr == CmpPKIBodyConstants.INITIALIZATIONREQUEST) ) {</span>

            final int eeprofid;
            final String eepname;
            try {
<span class="nc" id="L612">                final String configuredId = this.cmpConfiguration.getRAEEProfile(this.confAlias);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                if (StringUtils.equals(CmpConfiguration.PROFILE_USE_KEYID, configuredId)) {</span>
<span class="nc" id="L614">                    eepname = CmpMessageHelper.getStringFromOctets(msg.getHeader().getSenderKID());</span>
<span class="nc" id="L615">                    eeprofid = eeProfileSession.getEndEntityProfileId(eepname);</span>
                } else {
<span class="nc" id="L617">                    eeprofid = Integer.parseInt(configuredId);</span>
<span class="nc" id="L618">                    eepname = eeProfileSession.getEndEntityProfileName(eeprofid);</span>
                }
<span class="nc bnc" id="L620" title="All 2 branches missed.">                if(eepname == null) {</span>
<span class="nc" id="L621">                    log.error(&quot;End Entity Profile with ID &quot; + configuredId + &quot; was not found&quot;);</span>
<span class="nc" id="L622">                    return false;</span>
                }
<span class="nc" id="L624">            } catch(NumberFormatException e) {</span>
<span class="nc" id="L625">                log.error(&quot;End Entity Profile ID &quot; + this.cmpConfiguration.getRAEEProfile(this.confAlias) +</span>
                        &quot; in CMP alias &quot; + this.confAlias + &quot; was not an integer&quot;);
<span class="nc" id="L627">                return false;</span>
<span class="nc" id="L628">            } catch (EndEntityProfileNotFoundException e) {</span>
<span class="nc" id="L629">                log.error(&quot;End Entity Profile Name specified in the senderKID field could not be mapped to an end entity profile ID: &quot;</span>
<span class="nc" id="L630">                        + e.getMessage());</span>
<span class="nc" id="L631">                return false;</span>
<span class="nc" id="L632">            }</span>


<span class="nc bnc" id="L635" title="All 2 branches missed.">            if (!authorizedToEndEntityProfile(reqAuthToken, eeprofid, AccessRulesConstants.CREATE_END_ENTITY)) {</span>
<span class="nc" id="L636">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was not authorized to create end entities with EndEntityProfile &quot; + eepname);</span>
<span class="nc" id="L637">                return false;</span>
            } else {
<span class="nc bnc" id="L639" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L640">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to create end entities with EndEntityProfile &quot; + eepname);</span>
                }
            }

<span class="nc bnc" id="L644" title="All 2 branches missed.">            if(!authorizedToEndEntityProfile(reqAuthToken, eeprofid, AccessRulesConstants.EDIT_END_ENTITY)) {</span>
<span class="nc" id="L645">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was not authorized to edit end entities with EndEntityProfile &quot; + eepname);</span>
<span class="nc" id="L646">                return false;</span>
            } else {
<span class="nc bnc" id="L648" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L649">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to edit end entities with EndEntityProfile &quot; + eepname);</span>
                }
            }

<span class="nc bnc" id="L653" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, AccessRulesConstants.REGULAR_CREATECERTIFICATE)) {</span>
<span class="nc" id="L654">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is not authorized to create certificates.&quot;);</span>
<span class="nc" id="L655">                return false;</span>
            } else {
<span class="nc bnc" id="L657" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L658">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to create certificates&quot;);</span>
                }
            }

<span class="nc" id="L662">            final EndEntityProfile eep = eeProfileSession.getEndEntityProfile(eeprofid);</span>
<span class="nc" id="L663">            final int caid = getRaCaId((DEROctetString) msg.getHeader().getSenderKID(), eep);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, StandardRules.CAACCESS.resource() + caid)) {</span>
<span class="nc" id="L665">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; not authorized to resource &quot; + StandardRules.CAACCESS.resource() + caid);</span>
<span class="nc" id="L666">                return false;</span>
            } else {
<span class="nc bnc" id="L668" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L669">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is authorized to access CA with ID &quot; + caid);</span>
                }
            }

<span class="nc" id="L673">            CertificateProfile cp = getCertificateProfileFromCrmf(eep, (DEROctetString) msg.getHeader().getSenderKID());</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">            if(!isCertificateProfileAuthorizedToCA(cp, caid)) {</span>
<span class="nc" id="L675">                log.info(&quot;CertificateProfile is not authorized to CA with ID: &quot; + caid);</span>
<span class="nc" id="L676">                return false;</span>
            }


<span class="nc bnc" id="L680" title="All 2 branches missed.">        } else if( tagnr == CmpPKIBodyConstants.KEYUPDATEREQUEST ) {</span>
            // Because we do not edit the end entity when we receive a KeyUpdateRequest (the only editing we do is reset the end entity status),
            // the CertificateProfile and CA that will be used to issue the new certificate will be the ones already set in the end entity
            // regardless of the content of the request or the configuration of the CMP alias.
        	// It is, however, possible to edit the profiles and CA in the end entity (we just do not do that when receiving a CMPKeyUpdateRequest),
        	// So if we change the implementation in CrmfKeyUpdateHandler.java, this check should be updated accordingly

<span class="nc" id="L687">            final int eeprofid = endentity.getEndEntityProfileId();</span>
<span class="nc" id="L688">            final String eepname = eeProfileSession.getEndEntityProfileName(eeprofid);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">            if(eepname == null) {</span>
<span class="nc" id="L690">                log.error(&quot;End Entity Profile with ID &quot; + eeprofid + &quot; was not found&quot;);</span>
<span class="nc" id="L691">                return false;</span>
            }

<span class="nc bnc" id="L694" title="All 2 branches missed.">            if(!authorizedToEndEntityProfile(reqAuthToken, eeprofid, AccessRulesConstants.EDIT_END_ENTITY)) {</span>
<span class="nc" id="L695">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was not authorized to edit end entities with EndEntityProfile &quot; + eepname);</span>
<span class="nc" id="L696">                return false;</span>
            } else {
<span class="nc bnc" id="L698" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L699">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to edit end entities with EndEntityProfile &quot; + eepname);</span>
                }
            }

<span class="nc bnc" id="L703" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, AccessRulesConstants.REGULAR_CREATECERTIFICATE)) {</span>
<span class="nc" id="L704">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is not authorized to create certificates.&quot;);</span>
<span class="nc" id="L705">                return false;</span>
            } else {
<span class="nc bnc" id="L707" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L708">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is authorized to create certificates&quot;);</span>
                }
            }

<span class="nc" id="L712">            final int caid = endentity.getCAId();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, StandardRules.CAACCESS.resource() + caid)) {</span>
<span class="nc" id="L714">                log.info(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; not authorized to resource &quot; + StandardRules.CAACCESS.resource() + caid);</span>
<span class="nc" id="L715">                return false;</span>
            } else {
<span class="nc bnc" id="L717" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L718">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is authorized to access CA with ID &quot; + caid);</span>
                }
            }

<span class="nc bnc" id="L722" title="All 2 branches missed.">            if(!isCertificateProfileAuthorizedToCA(certProfileSession.getCertificateProfile(endentity.getCertificateProfileId()), caid)) {</span>
<span class="nc" id="L723">                log.info(&quot;CertificateProfile &quot; + certProfileSession.getCertificateProfileName(endentity.getCertificateProfileId()) + &quot; is not authorized to CA with ID: &quot; + caid);</span>
<span class="nc" id="L724">                return false;</span>
            }


<span class="nc bnc" id="L728" title="All 2 branches missed.">        } else if(tagnr == CmpPKIBodyConstants.REVOCATIONREQUEST) {</span>
<span class="nc" id="L729">            final String issuerdn = getIssuerDNFromRevRequest((RevReqContent) msg.getBody().getContent());</span>
<span class="nc" id="L730">            final int caid = CertTools.stringToBCDNString(issuerdn).hashCode();</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, StandardRules.CAACCESS.resource() + caid)) {</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L733">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; NOT authorized to revoke certificates issues by &quot; + issuerdn);</span>
                }
<span class="nc" id="L735">                return false;</span>
            } else {
<span class="nc bnc" id="L737" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L738">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is authorized to revoke certificates issued by &quot; + issuerdn);</span>
                }
            }

<span class="nc bnc" id="L742" title="All 2 branches missed.">            if(!authSession.isAuthorizedNoLogging(reqAuthToken, AccessRulesConstants.REGULAR_REVOKEENDENTITY)) {</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L744">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; is not authorized to revoke End Entities&quot;);</span>
                }
<span class="nc" id="L746">                return false;</span>
            } else {
<span class="nc bnc" id="L748" title="All 2 branches missed.">                if(log.isDebugEnabled()) {</span>
<span class="nc" id="L749">                    log.debug(&quot;Administrator &quot; + reqAuthToken.toString() + &quot; was authorized to revoke end entities&quot;);</span>
                }
            }

        }
<span class="nc" id="L754">        return true;</span>
    }

    /**
     * Checks whether admin is authorized to access the EndEntityProfile with the ID profileid
     *
     * @param admin Admin
     * @param profileid ID
     * @param rights Rights
     * @return true if admin is authorized and false otherwise.
     */
    private boolean authorizedToEndEntityProfile(AuthenticationToken admin, int profileid, String rights) {
<span class="nc bnc" id="L766" title="All 2 branches missed.">        if (profileid == EndEntityConstants.EMPTY_END_ENTITY_PROFILE</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">                &amp;&amp; (rights.equals(AccessRulesConstants.CREATE_END_ENTITY) || rights.equals(AccessRulesConstants.EDIT_END_ENTITY))) {</span>

<span class="nc" id="L769">            return authSession.isAuthorizedNoLogging(admin, StandardRules.ROLE_ROOT.resource());</span>
        } else {
<span class="nc bnc" id="L771" title="All 2 branches missed.">            return authSession.isAuthorizedNoLogging(admin, AccessRulesConstants.ENDENTITYPROFILEPREFIX + profileid + rights)</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">                    &amp;&amp; authSession.isAuthorizedNoLogging(admin, AccessRulesConstants.REGULAR_RAFUNCTIONALITY + rights);</span>
        }
    }

    /**
     * Returns the IssuerDN specified in the CMP revocation request
     * @param revReq Request
     * @return the IssuerDN
     */
    private String getIssuerDNFromRevRequest(final RevReqContent revReq) {
        RevDetails rd;
        try {
<span class="nc" id="L784">            rd = revReq.toRevDetailsArray()[0];</span>
<span class="nc" id="L785">        } catch(Exception e) {</span>
<span class="nc" id="L786">            log.debug(&quot;Could not parse the revocation request. Trying to parse it as novosec generated message.&quot;);</span>
<span class="nc" id="L787">            rd = CmpMessageHelper.getNovosecRevDetails(revReq);</span>
<span class="nc" id="L788">            log.debug(&quot;Succeeded in parsing the novosec generated request.&quot;);</span>
<span class="nc" id="L789">        }</span>
<span class="nc" id="L790">        final CertTemplate ct = rd.getCertDetails();</span>
<span class="nc" id="L791">        final X500Name issuer = ct.getIssuer();</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">        if(issuer != null) {</span>
<span class="nc" id="L793">            return ct.getIssuer().toString();</span>
        }
<span class="nc" id="L795">        return &quot;&quot;;</span>
    }

    /**
     * Return the ID of the CA that is used for CMP purposes.
     * @param keyId ID
     * @param eep Profile
     * @return the ID of CA used for CMP purposes.
     */
    private int getRaCaId(final DEROctetString keyId, final EndEntityProfile eep) {

<span class="nc" id="L806">        String caname = this.cmpConfiguration.getRACAName(this.confAlias);</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (StringUtils.equals(caname, CmpConfiguration.PROFILE_DEFAULT)) {</span>
<span class="nc" id="L808">            final int caid = eep.getDefaultCA();</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L810">                log.debug(&quot;Using EndEntity profile's default CA with ID: &quot;+caid);</span>
            }
<span class="nc" id="L812">            return caid;</span>
        }

<span class="nc bnc" id="L815" title="All 4 branches missed.">        if (StringUtils.equals(caname, CmpConfiguration.PROFILE_USE_KEYID) &amp;&amp; (keyId != null)) {</span>
<span class="nc" id="L816">            caname = CmpMessageHelper.getStringFromOctets(keyId);</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L818">                log.debug(&quot;Using CA with same name as KeyId in request: &quot;+caname);</span>
            }
        }
<span class="nc" id="L821">        return getCAInfoByName(caname).getCAId();</span>
    }


    private CertificateProfile getCertificateProfileFromCrmf(final EndEntityProfile eep, final DEROctetString keyId) {
<span class="nc" id="L826">        CertificateProfile profile = null;</span>
<span class="nc" id="L827">        String cpname = this.cmpConfiguration.getRACertProfile(this.confAlias);</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (StringUtils.equals(cpname, CmpConfiguration.PROFILE_DEFAULT)) {</span>
<span class="nc" id="L829">            final int cpid = eep.getDefaultCertificateProfile();</span>
<span class="nc" id="L830">            profile = certProfileSession.getCertificateProfile(cpid);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L832">                log.debug(&quot;Using EndEntityProfile's default CertificateProfile: &quot; + cpid);</span>
            }
<span class="nc bnc" id="L834" title="All 4 branches missed.">        } else if (StringUtils.equals(cpname, CmpConfiguration.PROFILE_USE_KEYID) &amp;&amp; (keyId != null)) {</span>
<span class="nc" id="L835">            cpname = CmpMessageHelper.getStringFromOctets(keyId);</span>
<span class="nc" id="L836">            profile = certProfileSession.getCertificateProfile(cpname);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L838">                log.debug(&quot;Using CertificateProfile specified as 'KeyId': &quot; + cpname);</span>
            }
        }  else {
<span class="nc" id="L841">            profile = certProfileSession.getCertificateProfile(cpname);</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L843">               log.debug(&quot;Using CertificateProfile as specified in the CMP alias: &quot; + cpname);</span>
            }
        }
<span class="nc" id="L846">        return profile;</span>
    }

    private boolean isCertificateProfileAuthorizedToCA(final CertificateProfile profile, final int caid) {
        // Check that CAid is among available CAs
<span class="nc" id="L851">        boolean caauthorized = false;</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">        if(profile != null) {</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">            for (final Integer availablecas : profile.getAvailableCAs()) {</span>
<span class="nc" id="L854">                final int availableca = availablecas.intValue();</span>
<span class="nc bnc" id="L855" title="All 4 branches missed.">                if (availableca == caid || availableca == CertificateProfile.ANYCA) {</span>
<span class="nc" id="L856">                    caauthorized = true;</span>
<span class="nc" id="L857">                    break;</span>
                }
<span class="nc" id="L859">            }</span>
        } else {
<span class="nc" id="L861">            log.info(&quot;CMP CertificateProfile not found&quot;);</span>
        }
<span class="nc" id="L863">        return caauthorized;</span>
    }

    /** Checks that the extracerts is a valid certificate path, that verifies up to the TrustAnchor being the Root CA certificate
     * of the supplied CA.
     * @param extracerts certificates from the extraCerts field from the CMP Message
     * @param cainfo The CA we want to verify extraCerts with, can be a root CA or a sub CA, in which case the sub CA's root CA is used as trust anchor
     * @return true if extracert(s) verifies up to the trust anchor, false otherwise
     */
    private boolean isExtraCertValidAndIssuedByCA(List&lt;X509Certificate&gt; extracerts, CAInfo cainfo) {
<span class="nc bnc" id="L873" title="All 4 branches missed.">        if (extracerts == null || extracerts.isEmpty()) {</span>
<span class="nc" id="L874">            throw new IllegalArgumentException(&quot;extracerts must contain a certificate.&quot;);</span>
        }
<span class="nc" id="L876">        Certificate endentitycert = null;</span>
        try {
            // What we got in extraCerts can be different things
            // - An end entity certificate only, signed by a SubCA or a RootCA
            // -- We need to find both SubCA and RootCA here, should be in cainfo?
            // - An end entity certificate and a SubCA certificate
            // -- We need to find the RootCA certificate only, should be in cainfo?
            // - An end entity certificate a SubCA certificate and a RootCA certificate
            // -- We need to remove the CA certificates that are not part of cainfo
<span class="nc" id="L885">            ArrayList&lt;Certificate&gt; certlist = new ArrayList&lt;&gt;();</span>
            // Create CertPath
<span class="nc" id="L887">            certlist.addAll(extracerts);</span>
            // Move CA certificates into cert path, except root certificate which is the trust anchor
<span class="nc" id="L889">            X509Certificate rootcert = null;</span>
<span class="nc" id="L890">            Collection&lt;Certificate&gt; trustedCertificates = cainfo.getCertificateChain();</span>
<span class="nc" id="L891">            final Iterator&lt;Certificate&gt; itr = trustedCertificates.iterator();</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">            while (itr.hasNext()) {</span>
                // Trust anchor is last, so if this is the last element, don't add it
<span class="nc" id="L894">                Certificate crt = itr.next();</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">                if (itr.hasNext()) {</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">                    if (!certlist.contains(crt)) {</span>
<span class="nc" id="L897">                        certlist.add(crt);</span>
                    } else {
<span class="nc bnc" id="L899" title="All 2 branches missed.">                        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L900">                            log.debug(&quot;Certlist already contains certificate with subject &quot;+CertTools.getSubjectDN(crt)+&quot;, not adding to list&quot;);</span>
                        }
                    }
                } else {
<span class="nc" id="L904">                    rootcert = (X509Certificate)crt;</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L906">                        log.debug(&quot;Using certificate with subject &quot;+CertTools.getSubjectDN(crt)+&quot;, as trust anchor, removing from certlist if it is there&quot;);</span>
                    }
                    // Don't have the trust anchor in the cert path, remove doesn't do anything if rootcert doesn't exist in certlist
<span class="nc" id="L909">                    certlist.remove(rootcert);</span>
                }
<span class="nc" id="L911">            }</span>
<span class="nc" id="L912">            CertPath cp = CertificateFactory.getInstance(&quot;X.509&quot;, BouncyCastleProvider.PROVIDER_NAME).generateCertPath(certlist);</span>
            // The end entity cert is the first one in the CertPath according to javadoc
            // - &quot;By convention, X.509 CertPaths (consisting of X509Certificates), are ordered starting with the target
            //    certificate and ending with a certificate issued by the trust anchor.
            //    That is, the issuer of one certificate is the subject of the following one.&quot;
            // Note: CertPath above will most likely not sort the path, at least if there is a root cert in certlist
            // the cp will fail verification if it was not in the right order in certlist to start with
<span class="nc" id="L919">            endentitycert = cp.getCertificates().get(0);</span>
<span class="nc" id="L920">            TrustAnchor anchor = new TrustAnchor(rootcert, null);</span>
<span class="nc" id="L921">            PKIXParameters params = new PKIXParameters(Collections.singleton(anchor));</span>
<span class="nc" id="L922">            params.setRevocationEnabled(false);</span>
<span class="nc" id="L923">            CertPathValidator cpv = CertPathValidator.getInstance(&quot;PKIX&quot;, BouncyCastleProvider.PROVIDER_NAME);</span>
<span class="nc" id="L924">            PKIXCertPathValidatorResult result = (PKIXCertPathValidatorResult) cpv.validate(cp, params);</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L926">                log.debug(&quot;Certificate verify result: &quot; + result.toString());</span>
            }
            // No CertPathValidatorException thrown means it passed
<span class="nc" id="L929">            return true;</span>
<span class="nc" id="L930">        } catch (CertPathValidatorException e) {</span>
<span class="nc" id="L931">            this.errorMessage = &quot;The certificate attached to the PKIMessage in the extraCert field is not valid - &quot; + getCertPathValidatorExceptionMessage(e);</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L933">                log.debug(this.errorMessage + &quot;: SubjectDN=&quot; + CertTools.getSubjectDN(endentitycert));</span>
            }
<span class="nc" id="L935">        } catch (CertificateException e) {</span>
<span class="nc" id="L936">            log.warn(&quot;CertificateException&quot;, e);</span>
<span class="nc" id="L937">        } catch (NoSuchProviderException e) {</span>
            // Serious error, bail out
<span class="nc" id="L939">            log.error(&quot;NoSuchProviderException&quot;, e);</span>
<span class="nc" id="L940">            throw new IllegalStateException(e);</span>
<span class="nc" id="L941">        } catch (InvalidAlgorithmParameterException e) {</span>
<span class="nc" id="L942">            log.info(&quot;InvalidAlgorithmParameterException&quot;, e);</span>
<span class="nc" id="L943">        } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L944">            log.info(&quot;NoSuchAlgorithmException&quot;, e);</span>
<span class="nc" id="L945">        }</span>
<span class="nc" id="L946">        return false;</span>
    }
    
    /**
     * Returns the message from a CertPathValidatorException. For the common cases, this method is locale independent.
     * @param e Exception
     * @return Message
     */
    private String getCertPathValidatorExceptionMessage(final CertPathValidatorException e) {
<span class="nc" id="L955">        Certificate endEntityCert = null;</span>
<span class="nc bnc" id="L956" title="All 4 branches missed.">        if (e.getCertPath() != null &amp;&amp; CollectionUtils.isNotEmpty(e.getCertPath().getCertificates())) {</span>
<span class="nc" id="L957">            endEntityCert = e.getCertPath().getCertificates().get(0);</span>
        }
        // getReason returns BasicReason.UNSPECIFIED for expired or not yet valid certs, so we need to look at the cause.
<span class="nc" id="L960">        final Throwable cause = e.getCause();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">        if (cause instanceof CertificateExpiredException) {</span>
<span class="nc" id="L962">            return &quot;Certificate has expired. NotAfter: &quot; + ValidityDate.formatAsUTC(CertTools.getNotAfter(endEntityCert)) + &quot; UTC&quot;;</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">        } else if (cause instanceof CertificateNotYetValidException) {</span>
<span class="nc" id="L964">            return &quot;Certificate is not yet valid. NotBefore: &quot; + ValidityDate.formatAsUTC(CertTools.getNotBefore(endEntityCert)) + &quot; UTC&quot;;</span>
        } else {
<span class="nc" id="L966">            return e.getMessage();</span>
        }
    }

    private boolean isExtraCertActive(final CertificateInfo certinfo) {
        // CERT_NOTIFIEDABOUTEXPIRATION is also active...
<span class="nc bnc" id="L972" title="All 4 branches missed.">        if (certinfo.getStatus() != CertificateConstants.CERT_ACTIVE &amp;&amp; certinfo.getStatus() != CertificateConstants.CERT_NOTIFIEDABOUTEXPIRATION) {</span>
<span class="nc" id="L973">            this.errorMessage = &quot;The certificate attached to the PKIMessage in the extraCert field is not active.&quot;;</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L975">                log.debug(this.errorMessage + &quot; Username=&quot; + certinfo.getUsername()+&quot;, fingerprint=&quot;+certinfo.getFingerprint());</span>
            }
<span class="nc" id="L977">            return false;</span>
        }
<span class="nc bnc" id="L979" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L980">            log.debug(&quot;The certificate in extraCert is active&quot;);</span>
        }
<span class="nc" id="L982">        return true;</span>
    }

    private CAInfo getCAInfoByName(String caname) {
        try {
<span class="nc" id="L987">            return caSession.getCAInfo(admin, caname);</span>
<span class="nc" id="L988">        } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L989">            this.errorMessage = &quot;Authorization denied for CA: &quot; + caname;</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L991">                log.debug(this.errorMessage + &quot; - &quot; + e.getLocalizedMessage());</span>
            }
        }
<span class="nc" id="L994">        return null;</span>
    }

    private CAInfo getCAInfoByIssuer(String issuerDN) {
        try {
<span class="nc" id="L999">            return caSession.getCAInfo(admin, issuerDN.hashCode());</span>
<span class="nc" id="L1000">        } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L1001">            this.errorMessage = &quot;Authorization denied for CA: &quot; + issuerDN;</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">            if(log.isDebugEnabled()) {</span>
<span class="nc" id="L1003">                log.debug(this.errorMessage + &quot; - &quot; + e.getLocalizedMessage());</span>
            }
        }
<span class="nc" id="L1006">        return null;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>