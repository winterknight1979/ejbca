<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RaMasterApiProxyBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">ejbca-ejb</a> &gt; <a href="index.source.html" class="el_package">org.ejbca.core.model.era</a> &gt; <span class="el_source">RaMasterApiProxyBean.java</span></div><h1>RaMasterApiProxyBean.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *

 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.ejbca.core.model.era;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.math.BigInteger;
import java.security.InvalidAlgorithmParameterException;
import java.security.InvalidKeyException;
import java.security.KeyPair;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.SignatureException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.CertificateExpiredException;
import java.security.cert.CertificateParsingException;
import java.security.cert.X509Certificate;
import java.security.spec.InvalidKeySpecException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import javax.annotation.PostConstruct;
import javax.ejb.ConcurrencyManagement;
import javax.ejb.ConcurrencyManagementType;
import javax.ejb.DependsOn;
import javax.ejb.EJB;
import javax.ejb.Lock;
import javax.ejb.LockType;
import javax.ejb.Singleton;
import javax.ejb.Startup;
import javax.ejb.TransactionManagement;
import javax.ejb.TransactionManagementType;

import org.apache.commons.lang.ArrayUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.pkcs.PKCS10CertificationRequest;
import org.cesecore.CesecoreException;
import org.cesecore.ErrorCode;
import org.cesecore.audit.enums.EventType;
import org.cesecore.authentication.AuthenticationFailedException;
import org.cesecore.authentication.tokens.AuthenticationToken;
import org.cesecore.authorization.AuthorizationDeniedException;
import org.cesecore.authorization.access.AccessSet;
import org.cesecore.certificates.ca.ApprovalRequestType;
import org.cesecore.certificates.ca.CADoesntExistsException;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.certificates.ca.CAOfflineException;
import org.cesecore.certificates.ca.CaSessionLocal;
import org.cesecore.certificates.ca.IllegalNameException;
import org.cesecore.certificates.ca.IllegalValidityException;
import org.cesecore.certificates.ca.InvalidAlgorithmException;
import org.cesecore.certificates.ca.SignRequestException;
import org.cesecore.certificates.ca.SignRequestSignatureException;
import org.cesecore.certificates.certificate.CertificateCreateException;
import org.cesecore.certificates.certificate.CertificateDataWrapper;
import org.cesecore.certificates.certificate.CertificateRevokeException;
import org.cesecore.certificates.certificate.CertificateStatus;
import org.cesecore.certificates.certificate.CertificateWrapper;
import org.cesecore.certificates.certificate.IllegalKeyException;
import org.cesecore.certificates.certificate.certextensions.CertificateExtensionException;
import org.cesecore.certificates.certificate.exception.CertificateSerialNumberException;
import org.cesecore.certificates.certificate.exception.CustomCertificateSerialNumberException;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.certificates.certificateprofile.CertificateProfileDoesNotExistException;
import org.cesecore.certificates.certificateprofile.CertificateProfileSessionLocal;
import org.cesecore.certificates.endentity.EndEntityConstants;
import org.cesecore.certificates.endentity.EndEntityInformation;
import org.cesecore.certificates.util.AlgorithmTools;
import org.cesecore.config.RaStyleInfo;
import org.cesecore.configuration.GlobalConfigurationSessionLocal;
import org.cesecore.keys.token.CryptoTokenOfflineException;
import org.cesecore.keys.util.KeyTools;
import org.cesecore.roles.AccessRulesHelper;
import org.cesecore.roles.Role;
import org.cesecore.roles.RoleExistsException;
import org.cesecore.roles.member.RoleMember;
import org.cesecore.util.CertTools;
import org.cesecore.util.EJBTools;
import org.ejbca.config.GlobalConfiguration;
import org.ejbca.core.EjbcaException;
import org.ejbca.core.ejb.ca.publisher.PublisherQueueSessionLocal;
import org.ejbca.core.ejb.ca.publisher.PublisherSessionLocal;
import org.ejbca.core.ejb.ca.store.CertReqHistorySessionLocal;
import org.ejbca.core.ejb.dto.CertRevocationDto;
import org.ejbca.core.ejb.keyrecovery.KeyRecoverySessionLocal;
import org.ejbca.core.ejb.ra.CouldNotRemoveEndEntityException;
import org.ejbca.core.ejb.ra.EndEntityExistsException;
import org.ejbca.core.ejb.ra.NoSuchEndEntityException;
import org.ejbca.core.model.approval.AdminAlreadyApprovedRequestException;
import org.ejbca.core.model.approval.ApprovalException;
import org.ejbca.core.model.approval.ApprovalRequestExecutionException;
import org.ejbca.core.model.approval.ApprovalRequestExpiredException;
import org.ejbca.core.model.approval.SelfApprovalException;
import org.ejbca.core.model.approval.WaitingForApprovalException;
import org.ejbca.core.model.approval.profile.ApprovalProfile;
import org.ejbca.core.model.authorization.AccessRulesConstants;
import org.ejbca.core.model.ca.AuthLoginException;
import org.ejbca.core.model.ca.AuthStatusException;
import org.ejbca.core.model.ca.publisher.PublisherDoesntExistsException;
import org.ejbca.core.model.ca.publisher.PublisherException;
import org.ejbca.core.model.keyrecovery.KeyRecoveryInformation;
import org.ejbca.core.model.ra.AlreadyRevokedException;
import org.ejbca.core.model.ra.CustomFieldException;
import org.ejbca.core.model.ra.NotFoundException;
import org.ejbca.core.model.ra.RevokeBackDateNotAllowedForProfileException;
import org.ejbca.core.model.ra.raadmin.EndEntityProfile;
import org.ejbca.core.model.ra.raadmin.EndEntityProfileNotFoundException;
import org.ejbca.core.model.ra.raadmin.EndEntityProfileValidationException;
import org.ejbca.core.model.ra.raadmin.UserDoesntFullfillEndEntityProfile;
import org.ejbca.core.protocol.NoSuchAliasException;
import org.ejbca.core.protocol.acme.AcmeAccount;
import org.ejbca.core.protocol.acme.AcmeAuthorization;
import org.ejbca.core.protocol.acme.AcmeChallenge;
import org.ejbca.core.protocol.acme.AcmeOrder;
import org.ejbca.core.protocol.rest.EnrollPkcs10CertificateRequest;
import org.ejbca.core.protocol.ws.objects.UserDataVOWS;
import org.ejbca.core.protocol.ws.objects.UserMatch;
import org.ejbca.cvc.exception.ConstructionException;
import org.ejbca.cvc.exception.ParseException;
import org.ejbca.ui.web.protocol.CertificateRenewalException;
import org.ejbca.util.query.IllegalQueryException;

/**
 * Proxy implementation of the the RaMasterApi that will get the result of the most preferred API implementation
 * or a mix thereof depending of the type of call.
 *
 * @version $Id: RaMasterApiProxyBean.java 29784 2018-08-30 08:20:30Z tarmo_r_helmes $
 */
@SuppressWarnings(&quot;deprecation&quot;)
@Singleton
@Startup
@DependsOn(&quot;StartupSingletonBean&quot;)
@ConcurrencyManagement(ConcurrencyManagementType.BEAN)
@TransactionManagement(TransactionManagementType.BEAN)
@Lock(LockType.READ)
public class RaMasterApiProxyBean implements RaMasterApiProxyBeanLocal {

<span class="nc" id="L167">    private static final Logger log = Logger.getLogger(RaMasterApiProxyBean.class);</span>

    @EJB
    private RaMasterApiSessionLocal raMasterApiSession;

    /** Note: Configuration stored &lt;b&gt;locally&lt;/b&gt; on this peer. Should only be used for peer configuration, etc. */
    @EJB
    private GlobalConfigurationSessionLocal localNodeGlobalConfigurationSession;
    /** Used to store key recovery data &lt;b&gt;locally&lt;/b&gt; on this peer. Should only be used for this purpose. */
    @EJB
    private KeyRecoverySessionLocal localNodeKeyRecoverySession;

    @EJB
    private CaSessionLocal caSession;
    @EJB
    private CertificateProfileSessionLocal certificateProfileSession;
    @EJB
    private PublisherSessionLocal publisherSession;
    @EJB
    private PublisherQueueSessionLocal publisherQueueSession;
    @EJB
    private CertReqHistorySessionLocal certreqHistorySession;

<span class="nc" id="L190">    private RaMasterApi[] raMasterApis = null;</span>
<span class="nc" id="L191">    private RaMasterApi[] raMasterApisLocalFirst = null;</span>

    /** Default constructor */
<span class="nc" id="L194">    public RaMasterApiProxyBean() {</span>
<span class="nc" id="L195">    }</span>

    /** Constructor for use from JUnit tests 
     * @param raMasterApiSession Session
     * @param globalConfigurationSession Config
     * @param keyRecoverySession Recovery
     * @param raMasterApis API*/
    public RaMasterApiProxyBean(final RaMasterApiSessionLocal raMasterApiSession,
            final GlobalConfigurationSessionLocal globalConfigurationSession,
            final KeyRecoverySessionLocal keyRecoverySession,
<span class="nc" id="L205">            final RaMasterApi... raMasterApis) {</span>
<span class="nc" id="L206">        this.raMasterApis = raMasterApis;</span>
<span class="nc" id="L207">        final List&lt;RaMasterApi&gt; implementations = new ArrayList&lt;&gt;(Arrays.asList(raMasterApis));</span>
<span class="nc" id="L208">        Collections.reverse(implementations);</span>
<span class="nc" id="L209">        this.raMasterApisLocalFirst = implementations.toArray(new RaMasterApi[implementations.size()]);</span>
<span class="nc" id="L210">        this.raMasterApiSession = raMasterApiSession;</span>
<span class="nc" id="L211">        this.localNodeGlobalConfigurationSession = globalConfigurationSession;</span>
<span class="nc" id="L212">        this.localNodeKeyRecoverySession = keyRecoverySession;</span>
<span class="nc" id="L213">    }</span>

    @PostConstruct
    private void postConstruct() {
<span class="nc" id="L217">        final List&lt;RaMasterApi&gt; implementations = new ArrayList&lt;&gt;();</span>
        try {
            // Load downstream peer implementation if available in this version of EJBCA
<span class="nc" id="L220">            final Class&lt;?&gt; c = Class.forName(&quot;org.ejbca.peerconnector.ra.RaMasterApiPeerDownstreamImpl&quot;);</span>
<span class="nc" id="L221">            implementations.add((RaMasterApi) c.getConstructor().newInstance());</span>
<span class="nc" id="L222">        } catch (ClassNotFoundException | NoSuchMethodException e) {</span>
<span class="nc" id="L223">            log.debug(&quot;RaMasterApi over Peers is not available on this system.&quot;);</span>
<span class="nc" id="L224">        } catch (InstantiationException | IllegalAccessException | InvocationTargetException e) {</span>
<span class="nc" id="L225">            log.warn(&quot;Failed to instantiate RaMasterApi over Peers: &quot; + e.getMessage());</span>
<span class="nc" id="L226">        }</span>
        try {
            // Load upstream peer implementation if available in this version of EJBCA
<span class="nc" id="L229">            final Class&lt;?&gt; c = Class.forName(&quot;org.ejbca.peerconnector.ra.RaMasterApiPeerUpstreamImpl&quot;);</span>
<span class="nc" id="L230">            implementations.add((RaMasterApi) c.getConstructor().newInstance());</span>
<span class="nc" id="L231">        } catch (ClassNotFoundException | NoSuchMethodException e) {</span>
<span class="nc" id="L232">            log.debug(&quot;RaMasterApi over Peers is not available on this system.&quot;);</span>
<span class="nc" id="L233">        } catch (InstantiationException | IllegalAccessException | InvocationTargetException e) {</span>
<span class="nc" id="L234">            log.warn(&quot;Failed to instantiate RaMasterApi over Peers: &quot; + e.getMessage());</span>
<span class="nc" id="L235">        }</span>
<span class="nc" id="L236">        implementations.add(raMasterApiSession);</span>
<span class="nc" id="L237">        this.raMasterApis = implementations.toArray(new RaMasterApi[implementations.size()]);</span>
<span class="nc" id="L238">        Collections.reverse(implementations);</span>
<span class="nc" id="L239">        this.raMasterApisLocalFirst = implementations.toArray(new RaMasterApi[implementations.size()]);</span>
<span class="nc" id="L240">    }</span>

    // Use in tests only!
    @Override
    public void deferLocalForTest() {
<span class="nc" id="L245">        raMasterApisLocalFirst = (RaMasterApi[]) ArrayUtils.removeElement(raMasterApisLocalFirst, raMasterApiSession);</span>
<span class="nc" id="L246">        raMasterApisLocalFirst = (RaMasterApi[]) ArrayUtils.add(raMasterApisLocalFirst, raMasterApiSession);</span>
<span class="nc" id="L247">    }</span>

    @Override
    public boolean isBackendAvailable() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
<span class="nc" id="L253">                return true;</span>
            }
        }
<span class="nc" id="L256">        return false;</span>
    }

    @Override
    public boolean isBackendAvailable(Class&lt;? extends RaMasterApi&gt; apiType) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable()  &amp;&amp; apiType.isInstance(raMasterApi) ) {</span>
<span class="nc" id="L263">                return true;</span>
            }
        }
<span class="nc" id="L266">        return false;</span>
    }

    // Added in Master RA API version 1
    @Override
    public int getApiVersion() {
<span class="nc" id="L272">        int minApiVersion = Integer.MAX_VALUE;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L276">                    minApiVersion = Math.min(minApiVersion, raMasterApi.getApiVersion());</span>
<span class="nc" id="L277">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L279">                }</span>
            }
        }
<span class="nc bnc" id="L282" title="All 2 branches missed.">        return minApiVersion == Integer.MAX_VALUE ? 0 : minApiVersion;</span>
    }

    @Override
    public boolean isAuthorizedNoLogging(final AuthenticationToken authenticationToken, final String... resources) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc bnc" id="L290" title="All 2 branches missed.">                    if (raMasterApi.isAuthorizedNoLogging(authenticationToken, resources)) {</span>
<span class="nc" id="L291">                        return true;</span>
                    }
<span class="nc" id="L293">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L295">                }</span>
            }
        }
<span class="nc" id="L298">        return false;</span>
    }

    @Override
    public RaAuthorizationResult getAuthorization(final AuthenticationToken authenticationToken) throws AuthenticationFailedException {
<span class="nc" id="L303">        RaAuthorizationResult combinedResult = null;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L307">                    final RaAuthorizationResult raAuthorizationResult = raMasterApi.getAuthorization(authenticationToken);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                    if (combinedResult==null) {</span>
<span class="nc" id="L309">                        combinedResult = raAuthorizationResult;</span>
                    } else {
<span class="nc" id="L311">                        final HashMap&lt;String, Boolean&gt; accessRules = AccessRulesHelper.getAccessRulesUnion(combinedResult.getAccessRules(),</span>
<span class="nc" id="L312">                                raAuthorizationResult.getAccessRules());</span>
                        // Sum of update numbers is strictly growing under the assumption that all backends are still connected
<span class="nc" id="L314">                        final int combinedUpdateNumber = combinedResult.getUpdateNumber() + raAuthorizationResult.getUpdateNumber();</span>
<span class="nc" id="L315">                        combinedResult = new RaAuthorizationResult(accessRules, combinedUpdateNumber);</span>
                    }
<span class="nc" id="L317">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L319">                }</span>
            }
        }
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (combinedResult==null) {</span>
<span class="nc" id="L323">            combinedResult = new RaAuthorizationResult(null, 0);</span>
        }
<span class="nc" id="L325">        return combinedResult;</span>
    }

    @Override
    @Deprecated
    public AccessSet getUserAccessSet(final AuthenticationToken authenticationToken) throws AuthenticationFailedException {
<span class="nc" id="L331">        AccessSet merged = new AccessSet(new HashSet&lt;String&gt;());</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L335">                    AccessSet as = raMasterApi.getUserAccessSet(authenticationToken);</span>
<span class="nc" id="L336">                    merged = new AccessSet(merged, as);</span>
<span class="nc" id="L337">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L339">                }</span>
            }
        }
<span class="nc" id="L342">        return merged;</span>
    }

    @Override
    @Deprecated
    public List&lt;AccessSet&gt; getUserAccessSets(final List&lt;AuthenticationToken&gt; authenticationTokens) {
<span class="nc" id="L348">        final List&lt;AuthenticationToken&gt; tokens = new ArrayList&lt;&gt;(authenticationTokens);</span>
<span class="nc" id="L349">        final AccessSet[] merged = new AccessSet[authenticationTokens.size()];</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L353">                    final List&lt;AccessSet&gt; accessSets = raMasterApi.getUserAccessSets(tokens);</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">                    for (int i = 0; i &lt; accessSets.size(); i++) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                        if (merged[i] == null) {</span>
<span class="nc" id="L356">                            merged[i] = accessSets.get(i);</span>
                        } else {
<span class="nc" id="L358">                            merged[i] = new AccessSet(accessSets.get(i), merged[i]);</span>
                        }
                    }
<span class="nc" id="L361">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L363">                }</span>
            }
        }
<span class="nc" id="L366">        return Arrays.asList(merged);</span>
    }

    @Override
    public List&lt;CAInfo&gt; getAuthorizedCas(final AuthenticationToken authenticationToken) {
<span class="nc" id="L371">        final Map&lt;Integer, CAInfo&gt; caInfoMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc bnc" id="L375" title="All 2 branches missed.">                    for (final CAInfo caInfo : raMasterApi.getAuthorizedCas(authenticationToken)) {</span>
<span class="nc" id="L376">                        caInfoMap.put(caInfo.getCAId(), caInfo);</span>
<span class="nc" id="L377">                    }</span>
<span class="nc" id="L378">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L380">                }</span>
            }
        }
<span class="nc" id="L383">        return new ArrayList&lt;&gt;(caInfoMap.values());</span>
    }

    @Override
    public LinkedHashMap&lt;Integer, RaStyleInfo&gt; getAllCustomRaStyles(AuthenticationToken authenticationToken) throws AuthorizationDeniedException {
<span class="nc bnc" id="L388" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) { // added between v1 and v2, lacks an exact version</span>
                try {
<span class="nc" id="L391">                    LinkedHashMap&lt;Integer, RaStyleInfo&gt; raCssInfos = raMasterApi.getAllCustomRaStyles(authenticationToken);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                    if (!raCssInfos.isEmpty()) {</span>
<span class="nc" id="L393">                        return raCssInfos;</span>
                    }
<span class="nc" id="L395">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L397">                }</span>
            }
        }
<span class="nc" id="L400">        return null;</span>
    }

    @Override
    public List&lt;RaStyleInfo&gt; getAvailableCustomRaStyles(AuthenticationToken authenticationToken, int hashCodeOfCurrentList) {
<span class="nc bnc" id="L405" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L406" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) { // added between v1 and v2, lacks an exact version</span>
                try {
<span class="nc" id="L408">                    final List&lt;RaStyleInfo&gt;raStyleInfos = raMasterApi.getAvailableCustomRaStyles(authenticationToken, hashCodeOfCurrentList);</span>
<span class="nc bnc" id="L409" title="All 4 branches missed.">                    if (raStyleInfos == null || !raStyleInfos.isEmpty()) { // null means that it is unchanged</span>
<span class="nc" id="L410">                        return raStyleInfos;</span>
                    }
<span class="nc" id="L412">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L414">                }</span>
            }
        }
<span class="nc" id="L417">        return new ArrayList&lt;&gt;();</span>
    }

    @Override
    public List&lt;Role&gt; getAuthorizedRoles(final AuthenticationToken authenticationToken) {
<span class="nc" id="L422">        final Map&lt;Integer, Role&gt; roleMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L424" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc bnc" id="L426" title="All 2 branches missed.">                    for (final Role role : raMasterApi.getAuthorizedRoles(authenticationToken)) {</span>
<span class="nc" id="L427">                        roleMap.put(role.getRoleId(), role);</span>
<span class="nc" id="L428">                    }</span>
<span class="nc" id="L429">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L431">                }</span>
            }
        }
<span class="nc" id="L434">        return new ArrayList&lt;&gt;(roleMap.values());</span>
    }

    @Override
    public Role getRole(final AuthenticationToken authenticationToken, final int roleId) throws AuthorizationDeniedException {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L440" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L442">                    Role role = raMasterApi.getRole(authenticationToken, roleId);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                    if (role != null) {</span>
<span class="nc" id="L444">                        return role;</span>
                    }
<span class="nc" id="L446">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L448">                }</span>
            }
        }
<span class="nc" id="L451">        return null;</span>
    }

    @Override
    public List&lt;String&gt; getAuthorizedRoleNamespaces(final AuthenticationToken authenticationToken, final int roleId) {
<span class="nc" id="L456">        final Set&lt;String&gt; namespaceSet = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L458" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L460">                    namespaceSet.addAll(raMasterApi.getAuthorizedRoleNamespaces(authenticationToken, roleId));</span>
<span class="nc" id="L461">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L463">                }</span>
            }
        }
<span class="nc" id="L466">        return new ArrayList&lt;&gt;(namespaceSet);</span>
    }

    @Override
    public Map&lt;String,RaRoleMemberTokenTypeInfo&gt; getAvailableRoleMemberTokenTypes(final AuthenticationToken authenticationToken) {
<span class="nc" id="L471">        final HashMap&lt;String,RaRoleMemberTokenTypeInfo&gt; result = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L473" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L475">                    final Map&lt;String,RaRoleMemberTokenTypeInfo&gt; mergeWith = raMasterApi.getAvailableRoleMemberTokenTypes(authenticationToken);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                    for (final Map.Entry&lt;String,RaRoleMemberTokenTypeInfo&gt; entry : mergeWith.entrySet()) {</span>
<span class="nc" id="L477">                        final String tokenType = entry.getKey();</span>
<span class="nc" id="L478">                        final RaRoleMemberTokenTypeInfo entryInfo = entry.getValue();</span>
<span class="nc" id="L479">                        final RaRoleMemberTokenTypeInfo resultInfo = result.get(tokenType);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                        if (resultInfo == null) {</span>
<span class="nc" id="L481">                            result.put(tokenType, entryInfo);</span>
                        } else {
<span class="nc" id="L483">                            resultInfo.merge(entryInfo);</span>
                        }
<span class="nc" id="L485">                    }</span>
<span class="nc" id="L486">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L488">                }</span>
            }
        }
<span class="nc" id="L491">        return result;</span>
    }

    @Override
    public Role saveRole(final AuthenticationToken authenticationToken, final Role role) throws AuthorizationDeniedException, RoleExistsException {
<span class="nc" id="L496">        AuthorizationDeniedException authorizationDeniedException = null;</span>
        // Try to save/update on the systems until successful, starting with the remote systems first.
        // (The save operation might be unsuccessful if we're editing an existing role that belongs to another system, for instance)
<span class="nc bnc" id="L499" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
            try {
<span class="nc bnc" id="L501" title="All 4 branches missed.">                if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
<span class="nc" id="L502">                    final Role savedRole = raMasterApi.saveRole(authenticationToken, role);</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">                    if (savedRole != null) {</span>
<span class="nc" id="L504">                        return savedRole;</span>
                    }
                }
<span class="nc" id="L507">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L509">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L512">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L514">            }</span>
        }
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L517">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L519">        return null;</span>
    }

    @Override
    public boolean deleteRole(AuthenticationToken authenticationToken, int roleId) throws AuthorizationDeniedException {
<span class="nc" id="L524">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L525">        boolean result = false;</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
            try {
<span class="nc bnc" id="L528" title="All 4 branches missed.">                if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
<span class="nc" id="L529">                    result |= raMasterApi.deleteRole(authenticationToken, roleId);</span>
                }
<span class="nc" id="L531">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L533">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L536">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L538">            }</span>
        }
<span class="nc bnc" id="L540" title="All 4 branches missed.">        if (!result &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L541">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L543">        return result;</span>
    }

    @Override
    public RoleMember getRoleMember(AuthenticationToken authenticationToken, int roleMemberId) throws AuthorizationDeniedException {
<span class="nc bnc" id="L548" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L549" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L551">                    RoleMember roleMember = raMasterApi.getRoleMember(authenticationToken, roleMemberId);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                    if (roleMember != null) {</span>
<span class="nc" id="L553">                        return roleMember;</span>
                    }
<span class="nc" id="L555">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L557">                }</span>
            }
        }
<span class="nc" id="L560">        return null;</span>
    }

    @Override
    public RoleMember saveRoleMember(AuthenticationToken authenticationToken, RoleMember roleMember) throws AuthorizationDeniedException {
<span class="nc" id="L565">        AuthorizationDeniedException authorizationDeniedException = null;</span>
        // Try to save/update on the systems until successful, starting with the remote systems first.
        // (The save operation might be unsuccessful if we're editing an existing role member that belongs to another system,
        // or if we're trying to add a role member and the role it references to belongs to another system)
<span class="nc bnc" id="L569" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
            try {
<span class="nc bnc" id="L571" title="All 4 branches missed.">                if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
<span class="nc" id="L572">                    final RoleMember savedRoleMember = raMasterApi.saveRoleMember(authenticationToken, roleMember);</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">                    if (savedRoleMember != null) {</span>
<span class="nc" id="L574">                        return savedRoleMember;</span>
                    }
                }
<span class="nc" id="L577">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L579">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L582">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L584">            }</span>
        }
<span class="nc bnc" id="L586" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L587">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L589">        return null;</span>
    }

    @Override
    public boolean deleteRoleMember(AuthenticationToken authenticationToken, int roleId, int roleMemberId) throws AuthorizationDeniedException {
<span class="nc" id="L594">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L595">        boolean result = false;</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
            try {
<span class="nc bnc" id="L598" title="All 4 branches missed.">                if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
<span class="nc" id="L599">                    result |= raMasterApi.deleteRoleMember(authenticationToken, roleId, roleMemberId);</span>
                }
<span class="nc" id="L601">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L603">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L606">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L608">            }</span>
        }
<span class="nc bnc" id="L610" title="All 4 branches missed.">        if (!result &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L611">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L613">        return result;</span>
    }

    @Override
    public RaApprovalRequestInfo getApprovalRequest(AuthenticationToken authenticationToken, int id) {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L621">                    RaApprovalRequestInfo reqInfo = raMasterApi.getApprovalRequest(authenticationToken, id);</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                    if (reqInfo != null) {</span>
<span class="nc" id="L623">                        return reqInfo;</span>
                    }
<span class="nc" id="L625">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L627">                }</span>
            }
        }
<span class="nc" id="L630">        return null;</span>
    }

    @Override
    public RaApprovalRequestInfo getApprovalRequestByRequestHash(AuthenticationToken authenticationToken, int approvalId) {
<span class="nc bnc" id="L635" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L638">                    RaApprovalRequestInfo reqInfo = raMasterApi.getApprovalRequestByRequestHash(authenticationToken, approvalId);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">                    if (reqInfo != null) {</span>
<span class="nc" id="L640">                        return reqInfo;</span>
                    }
<span class="nc" id="L642">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L644">                }</span>
            }
        }
<span class="nc" id="L647">        return null;</span>
    }

    @Override
    public RaApprovalRequestInfo editApprovalRequest(AuthenticationToken authenticationToken, RaApprovalEditRequest edit)
            throws AuthorizationDeniedException {
<span class="nc bnc" id="L653" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L656">                    final RaApprovalRequestInfo newApproval = raMasterApi.editApprovalRequest(authenticationToken, edit);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">                    if (newApproval != null) {</span>
<span class="nc" id="L658">                        return newApproval;</span>
                    }
<span class="nc" id="L660">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L662">                }</span>
            }
        }
<span class="nc" id="L665">        return null;</span>
    }

    @Override
    public void extendApprovalRequest(AuthenticationToken authenticationToken, int id, long extendForMillis) throws AuthorizationDeniedException {
<span class="nc bnc" id="L670" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L673">                    raMasterApi.extendApprovalRequest(authenticationToken, id, extendForMillis);</span>
<span class="nc" id="L674">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L676">                }</span>
            }
        }
<span class="nc" id="L679">    }</span>

    @Override
    public boolean addRequestResponse(AuthenticationToken authenticationToken, RaApprovalResponseRequest requestResponse)
            throws AuthorizationDeniedException, ApprovalException, ApprovalRequestExpiredException, ApprovalRequestExecutionException,
            AdminAlreadyApprovedRequestException, SelfApprovalException, AuthenticationFailedException {
<span class="nc bnc" id="L685" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc bnc" id="L688" title="All 2 branches missed.">                    if (raMasterApi.addRequestResponse(authenticationToken, requestResponse)) {</span>
<span class="nc" id="L689">                        return true;</span>
                    }
<span class="nc" id="L691">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L693">                }</span>
            }
        }
<span class="nc" id="L696">        return false;</span>
    }

    @Override
    public RaRequestsSearchResponse searchForApprovalRequests(AuthenticationToken authenticationToken,
            RaRequestsSearchRequest raRequestsSearchRequest) {
<span class="nc" id="L702">        final RaRequestsSearchResponse searchResponse = new RaRequestsSearchResponse();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L706">                    searchResponse.merge(raMasterApi.searchForApprovalRequests(authenticationToken, raRequestsSearchRequest));</span>
<span class="nc" id="L707">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L709">                }</span>
            }
        }
<span class="nc" id="L712">        return searchResponse;</span>
    }

    @Override
    public CertificateDataWrapper searchForCertificate(final AuthenticationToken authenticationToken, final String fingerprint) {
<span class="nc" id="L717">        CertificateDataWrapper searchResponse = null;</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L721">                    searchResponse = raMasterApi.searchForCertificate(authenticationToken, fingerprint);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">                    if (searchResponse != null) {</span>
<span class="nc" id="L723">                        break;</span>
                    }
<span class="nc" id="L725">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L727">                }</span>
            }
        }
<span class="nc" id="L730">        return searchResponse;</span>
    }

    @Override
    public CertificateDataWrapper searchForCertificateByIssuerAndSerial(final AuthenticationToken authenticationToken, final String issuerDN, final String serno) {
<span class="nc" id="L735">        CertificateDataWrapper searchResponse = null;</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L739">                    searchResponse = raMasterApi.searchForCertificateByIssuerAndSerial(authenticationToken, issuerDN, serno);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    if (searchResponse != null) {</span>
<span class="nc" id="L741">                        break;</span>
                    }
<span class="nc" id="L743">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L745">                }</span>
            }
        }
<span class="nc" id="L748">        return searchResponse;</span>
    }

    @Override
    public RaCertificateSearchResponse searchForCertificates(AuthenticationToken authenticationToken,
            RaCertificateSearchRequest raCertificateSearchRequest) {
<span class="nc" id="L754">        final RaCertificateSearchResponse ret = new RaCertificateSearchResponse();</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L758">                    ret.merge(raMasterApi.searchForCertificates(authenticationToken, raCertificateSearchRequest));</span>
<span class="nc" id="L759">                } catch (UnsupportedOperationException e) {</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L761">                        log.debug(&quot;Trouble during back end invocation: &quot; + e.getMessage());</span>
                    }
                    // Just try next implementation
<span class="nc" id="L764">                } catch (RaMasterBackendUnavailableException e) {</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L766">                        log.debug(&quot;Timeout during back end invocation.&quot;, e);</span>
                    }
                    // If the back end timed out due to a too heavy search we want to allow the client to retry with more fine grained criteria
<span class="nc" id="L769">                    ret.setMightHaveMoreResults(true);</span>
<span class="nc" id="L770">                }</span>
            }
        }
<span class="nc" id="L773">        return ret;</span>
    }

    @Override
    public RaCertificateSearchResponse searchForCertificatesByUsername(
            final AuthenticationToken authenticationToken, final String username) {
<span class="nc" id="L779">        RaCertificateSearchRequest request = new RaCertificateSearchRequest();</span>
<span class="nc" id="L780">        request.setUsernameSearchString(username);</span>
<span class="nc" id="L781">        request.setUsernameSearchExact(true);</span>
<span class="nc" id="L782">        return searchForCertificates(authenticationToken, request);</span>
    }

    @Override
    public RaRoleSearchResponse searchForRoles(AuthenticationToken authenticationToken,
            RaRoleSearchRequest raRoleSearchRequest) {
<span class="nc" id="L788">        final RaRoleSearchResponse ret = new RaRoleSearchResponse();</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L790" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L792">                    ret.merge(raMasterApi.searchForRoles(authenticationToken, raRoleSearchRequest));</span>
<span class="nc" id="L793">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L795">                }</span>
            }
        }
<span class="nc" id="L798">        return ret;</span>
    }

    @Override
    public RaRoleMemberSearchResponse searchForRoleMembers(AuthenticationToken authenticationToken,
            RaRoleMemberSearchRequest raRoleMemberSearchRequest) {
<span class="nc" id="L804">        final RaRoleMemberSearchResponse ret = new RaRoleMemberSearchResponse();</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L808">                    ret.merge(raMasterApi.searchForRoleMembers(authenticationToken, raRoleMemberSearchRequest));</span>
<span class="nc" id="L809">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L811">                }</span>
            }
        }
<span class="nc" id="L814">        return ret;</span>
    }

    @Override
    public RaEndEntitySearchResponse searchForEndEntities(AuthenticationToken authenticationToken,
            RaEndEntitySearchRequest raEndEntitySearchRequest) {
<span class="nc" id="L820">        final RaEndEntitySearchResponse ret = new RaEndEntitySearchResponse();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L824">                    ret.merge(raMasterApi.searchForEndEntities(authenticationToken, raEndEntitySearchRequest));</span>
<span class="nc" id="L825">                } catch (UnsupportedOperationException e) {</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L827">                        log.debug(&quot;Trouble during back end invocation: &quot; + e.getMessage());</span>
                    }
                    // Just try next implementation
<span class="nc" id="L830">                } catch (RaMasterBackendUnavailableException e) {</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L832">                        log.debug(&quot;Timeout during back end invocation.&quot;, e);</span>
                    }
                    // If the back end timed out due to a too heavy search we want to allow the client to retry with more fine grained criteria
<span class="nc" id="L835">                    ret.setMightHaveMoreResults(true);</span>
<span class="nc" id="L836">                }</span>
            }
        }
<span class="nc" id="L839">        return ret;</span>
    }

    @Override
    public Map&lt;Integer, String&gt; getAuthorizedCertificateProfileIdsToNameMap(final AuthenticationToken authenticationToken) {
<span class="nc" id="L844">        final Map&lt;Integer, String&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L848">                    ret.putAll(raMasterApi.getAuthorizedCertificateProfileIdsToNameMap(authenticationToken));</span>
<span class="nc" id="L849">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L851">                }</span>
            }
        }
<span class="nc" id="L854">        return ret;</span>
    }

    @Override
    public Map&lt;Integer, String&gt; getAuthorizedEndEntityProfileIdsToNameMap(final AuthenticationToken authenticationToken) {
<span class="nc" id="L859">        final Map&lt;Integer, String&gt; ret = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L863">                    ret.putAll(raMasterApi.getAuthorizedEndEntityProfileIdsToNameMap(authenticationToken));</span>
<span class="nc" id="L864">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L866">                }</span>
            }
        }
<span class="nc" id="L869">        return ret;</span>
    }

    @Override
    public IdNameHashMap&lt;EndEntityProfile&gt; getAuthorizedEndEntityProfiles(final AuthenticationToken authenticationToken, final String endEntityAccessRule) {
<span class="nc" id="L874">        final IdNameHashMap&lt;EndEntityProfile&gt; ret = new IdNameHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L878">                    final IdNameHashMap&lt;EndEntityProfile&gt; result = raMasterApi.getAuthorizedEndEntityProfiles(authenticationToken, endEntityAccessRule);</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L880">                        ret.putAll(result);</span>
                    }
<span class="nc" id="L882">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L884">                }</span>
            }
        }
<span class="nc" id="L887">        return ret;</span>
    }

    @Override
    public IdNameHashMap&lt;CAInfo&gt; getAuthorizedCAInfos(AuthenticationToken authenticationToken) {
<span class="nc" id="L892">        final IdNameHashMap&lt;CAInfo&gt; ret = new IdNameHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L896">                    final IdNameHashMap&lt;CAInfo&gt; result = raMasterApi.getAuthorizedCAInfos(authenticationToken);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L898">                        ret.putAll(result);</span>
                    }
<span class="nc" id="L900">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L902">                }</span>
            }
        }
<span class="nc" id="L905">        return ret;</span>
    }

    @Override
    public IdNameHashMap&lt;CertificateProfile&gt; getAuthorizedCertificateProfiles(AuthenticationToken authenticationToken) {
<span class="nc" id="L910">        final IdNameHashMap&lt;CertificateProfile&gt; ret = new IdNameHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L914">                    final IdNameHashMap&lt;CertificateProfile&gt; result = raMasterApi.getAuthorizedCertificateProfiles(authenticationToken);</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L916">                        ret.putAll(result);</span>
                    }
<span class="nc" id="L918">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L920">                }</span>
            }
        }
<span class="nc" id="L923">        return ret;</span>
    }

    @Override
    public CertificateProfile getCertificateProfile(int id) {
<span class="nc" id="L928">        CertificateProfile ret = null;</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L930" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L932">                    ret = raMasterApi.getCertificateProfile(id);</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">                    if (ret != null) {</span>
                        // If we did get a hit, we don't need to cycle through other implementations
<span class="nc" id="L935">                        break;</span>
                    }
<span class="nc" id="L937">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L939">                }</span>
            }
        }
<span class="nc" id="L942">        return ret;</span>
    }

    @Override
    public boolean addUser(AuthenticationToken admin, EndEntityInformation endEntity, boolean clearpwd)
            throws AuthorizationDeniedException, EjbcaException, WaitingForApprovalException {
<span class="nc" id="L948">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
            try {
<span class="nc bnc" id="L951" title="All 2 branches missed.">                if (raMasterApi.isBackendAvailable()) {</span>
<span class="nc" id="L952">                    return raMasterApi.addUser(admin, endEntity, clearpwd);</span>
                }
<span class="nc" id="L954">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L956">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L959">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L961">            }</span>
        }
<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L964">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L966">        return false;</span>
    }

    @Override
    public boolean addUserFromWS(final AuthenticationToken admin, UserDataVOWS userDataVOWS, final boolean clearpwd)
            throws AuthorizationDeniedException, EndEntityProfileValidationException, EndEntityExistsException, WaitingForApprovalException,
            CADoesntExistsException, IllegalNameException, CertificateSerialNumberException, EjbcaException {
<span class="nc" id="L973">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L974">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
            try {
<span class="nc bnc" id="L977" title="All 4 branches missed.">                if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
<span class="nc" id="L978">                    return raMasterApi.addUserFromWS(admin, userDataVOWS, clearpwd);</span>
                }
<span class="nc" id="L980">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L982">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L985">            } catch (CADoesntExistsException e) {</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">                if (caDoesntExistException == null) {</span>
<span class="nc" id="L987">                    caDoesntExistException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L990">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L992">            }</span>
        }
<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L995">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L997" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L998">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1000">        return false;</span>

    }

    @Override
    public void checkSubjectDn(AuthenticationToken admin, EndEntityInformation endEntity) throws AuthorizationDeniedException, EjbcaException{
<span class="nc" id="L1006">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
            try {
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                if (raMasterApi.isBackendAvailable()) {</span>
<span class="nc" id="L1010">                    raMasterApi.checkSubjectDn(admin, endEntity);</span>
                }
<span class="nc" id="L1012">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1014">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L1017">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L1019">            }</span>
        }
<span class="nc bnc" id="L1021" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1022">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L1024">    }</span>

    @Override
    public void deleteUser(final AuthenticationToken authenticationToken, final String username) throws AuthorizationDeniedException {
<span class="nc" id="L1028">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
            try {
<span class="nc bnc" id="L1031" title="All 2 branches missed.">                if (raMasterApi.isBackendAvailable()) {</span>
<span class="nc" id="L1032">                    raMasterApi.deleteUser(authenticationToken, username);</span>
                }
<span class="nc" id="L1034">            } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1036">                    authorizationDeniedException = e;</span>
                }
                // Just try next implementation
<span class="nc" id="L1039">            } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                // Just try next implementation
<span class="nc" id="L1041">            }</span>
        }
<span class="nc bnc" id="L1043" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1044">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L1046">    }</span>

    @Override
    public EndEntityInformation searchUser(AuthenticationToken authenticationToken, String username) {
<span class="nc bnc" id="L1050" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L1053">                    final EndEntityInformation result = raMasterApi.searchUser(authenticationToken, username);</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L1055">                        return result;</span>
                    }
<span class="nc" id="L1057">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1059">                }</span>
            }
        }
<span class="nc" id="L1062">        return null;</span>
    }

    @Override
    public void checkUserStatus(AuthenticationToken authenticationToken, String username, String password)
            throws NoSuchEndEntityException, AuthStatusException, AuthLoginException {
<span class="nc" id="L1068">        NoSuchEndEntityException noSuchEndEntityException = null;</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1070" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L1072">                    raMasterApi.checkUserStatus(authenticationToken, username, password);</span>
<span class="nc" id="L1073">                    return;</span>
<span class="nc" id="L1074">                } catch (NoSuchEndEntityException e) {</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                    if (noSuchEndEntityException != null) {</span>
<span class="nc" id="L1076">                        noSuchEndEntityException = e;</span>
                    }
<span class="nc" id="L1078">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1080">                }</span>
            }
        }
<span class="nc bnc" id="L1083" title="All 2 branches missed.">        if (noSuchEndEntityException != null) {</span>
<span class="nc" id="L1084">            throw noSuchEndEntityException;</span>
        }
<span class="nc" id="L1086">    }</span>

    @Override
    public void finishUserAfterLocalKeyRecovery(final AuthenticationToken authenticationToken, final String username, final String password) throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L1090">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L1091">        EjbcaException userNotFoundException = null;</span>

<span class="nc bnc" id="L1093" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1094" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) { // added between v1 and v2, lacks an exact version</span>
                try {
<span class="nc" id="L1096">                    raMasterApi.finishUserAfterLocalKeyRecovery(authenticationToken, username, password);</span>
<span class="nc" id="L1097">                    return;</span>
<span class="nc" id="L1098">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1100">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1103">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1105">                } catch (EjbcaException e) {</span>
                    // If the user is not found (e.g. during key recovery), try next implementation
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                    if (!ErrorCode.USER_NOT_FOUND.equals(e.getErrorCode())) {</span>
<span class="nc" id="L1108">                        throw e;</span>
                    }
<span class="nc bnc" id="L1110" title="All 2 branches missed.">                    if (userNotFoundException != null) {</span>
<span class="nc" id="L1111">                        userNotFoundException = e;</span>
                    }
<span class="nc" id="L1113">                }</span>
            }
        }
<span class="nc bnc" id="L1116" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1117">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        if (userNotFoundException != null) {</span>
<span class="nc" id="L1120">            throw userNotFoundException;</span>
        }
<span class="nc" id="L1122">    }</span>

    private X509Certificate requestCertForEndEntity(final AuthenticationToken authenticationToken, final EndEntityInformation endEntity, final String password, final KeyPair kp)
            throws AuthorizationDeniedException, EjbcaException {
        try {
<span class="nc" id="L1127">            final X500Name x509dn = CertTools.stringToBcX500Name(endEntity.getDN());</span>
<span class="nc" id="L1128">            final String sigAlg = AlgorithmTools.getSignatureAlgorithms(kp.getPublic()).get(0);</span>
<span class="nc" id="L1129">            final PKCS10CertificationRequest pkcs10req = CertTools.genPKCS10CertificationRequest(sigAlg, x509dn, kp.getPublic(), null, kp.getPrivate(), BouncyCastleProvider.PROVIDER_NAME);</span>
<span class="nc" id="L1130">            final byte[] csr = pkcs10req.getEncoded();</span>
<span class="nc" id="L1131">            endEntity.getExtendedInformation().setCertificateRequest(csr); // not persisted, only sent over peer connection</span>
<span class="nc" id="L1132">            endEntity.setPassword(password); // not persisted</span>
            // Request certificate
<span class="nc" id="L1134">            final byte[] certBytes = createCertificate(authenticationToken, endEntity);</span>
<span class="nc" id="L1135">            return CertTools.getCertfromByteArray(certBytes, X509Certificate.class);</span>
<span class="nc" id="L1136">        } catch (IOException | OperatorCreationException | CertificateParsingException e) {</span>
<span class="nc" id="L1137">            throw new IllegalStateException(e);</span>
        }
    }

    // This method is somewhat special, because it should not be sent/forwarded upstream depending on a configuration setting
    @Override
    public byte[] generateKeyStore(AuthenticationToken authenticationToken, EndEntityInformation endEntity)
            throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L1145">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L1146">        EjbcaException userNotFoundException = null;</span>

<span class="nc" id="L1148">        final String username = endEntity.getUsername();</span>
<span class="nc" id="L1149">        final EndEntityInformation storedEndEntity = searchUser(authenticationToken, username);</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">        if (storedEndEntity == null) {</span>
<span class="nc" id="L1151">            throw new EjbcaException(ErrorCode.USER_NOT_FOUND, &quot;User does not exist: &quot; + username);</span>
        }
<span class="nc" id="L1153">        GlobalConfiguration globalConfig = (GlobalConfiguration) localNodeGlobalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
<span class="nc bnc" id="L1154" title="All 6 branches missed.">        if (storedEndEntity.getKeyRecoverable() &amp;&amp; globalConfig.getEnableKeyRecovery() &amp;&amp; globalConfig.getLocalKeyRecovery()) {</span>
            // &quot;Force local key recovery&quot; enabled. The certificate is issued on the CA, but the key pair is generated and stored locally.
<span class="nc" id="L1156">            final IdNameHashMap&lt;CAInfo&gt; caInfos = getAuthorizedCAInfos(authenticationToken);</span>
<span class="nc" id="L1157">            final CAInfo caInfo = caInfos.getValue(storedEndEntity.getCAId());</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">            if (caInfo == null) {</span>
<span class="nc" id="L1159">                throw new AuthorizationDeniedException(&quot;Not authorized to CA with ID &quot; + storedEndEntity.getCAId() + &quot;, or it does not exist.&quot;);</span>
            }
<span class="nc" id="L1161">            final Certificate[] cachain = caInfo.getCertificateChain().toArray(new Certificate[0]);</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">            if (!isAuthorizedNoLogging(authenticationToken, AccessRulesConstants.REGULAR_KEYRECOVERY)) {</span>
<span class="nc" id="L1163">                throw new AuthorizationDeniedException(&quot;Not authorized to recover keys&quot;);</span>
            }
<span class="nc" id="L1165">            final EndEntityProfile endEntityProfile = getAuthorizedEndEntityProfiles(authenticationToken, AccessRulesConstants.REGULAR_KEYRECOVERY).getValue(storedEndEntity.getEndEntityProfileId());</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">            if (endEntityProfile == null) {</span>
<span class="nc" id="L1167">                throw new AuthorizationDeniedException(&quot;Not authorized to End Entity Profile with ID &quot; + storedEndEntity.getEndEntityProfileId() + &quot;, or it does not exist.&quot;);</span>
            }

<span class="nc" id="L1170">            final Integer cryptoTokenId = globalConfig.getLocalKeyRecoveryCryptoTokenId();</span>
<span class="nc" id="L1171">            final String keyAlias = globalConfig.getLocalKeyRecoveryKeyAlias();</span>
            final X509Certificate cert;
            final KeyPair kp;
            try {
<span class="nc bnc" id="L1175" title="All 2 branches missed.">                if (storedEndEntity.getStatus() != EndEntityConstants.STATUS_KEYRECOVERY) {</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1177">                        log.debug(&quot;Creating locally stored key pair for end entity '&quot; + username + &quot;'&quot;);</span>
                    }
                    // Create new key pair and CSR
<span class="nc" id="L1180">                    final String keyalg = storedEndEntity.getExtendedInformation().getKeyStoreAlgorithmType();</span>
<span class="nc" id="L1181">                    final String keyspec = storedEndEntity.getExtendedInformation().getKeyStoreAlgorithmSubType();</span>
<span class="nc" id="L1182">                    kp = KeyTools.genKeys(keyspec, keyalg);</span>
                    // requestCertForEndEntity verifies the password and performs the finishUser operation
<span class="nc" id="L1184">                    cert = requestCertForEndEntity(authenticationToken, storedEndEntity, endEntity.getPassword(), kp);</span>
                    // Store key pair
<span class="nc bnc" id="L1186" title="All 4 branches missed.">                    if (cryptoTokenId == null || keyAlias == null) {</span>
<span class="nc" id="L1187">                        log.warn(&quot;No key has been configured for local key recovery. Please select a crypto token and key alias in System Configuration!&quot;);</span>
<span class="nc" id="L1188">                        throw new EjbcaException(ErrorCode.INTERNAL_ERROR);</span>
                    }
<span class="nc bnc" id="L1190" title="All 2 branches missed.">                    if (!localNodeKeyRecoverySession.addKeyRecoveryDataInternal(authenticationToken, EJBTools.wrap(cert), username, EJBTools.wrap(kp), cryptoTokenId, keyAlias)) {</span>
                        // Should never happen. An exception stack trace is error-logged in addKeyRecoveryData
<span class="nc" id="L1192">                        throw new EjbcaException(ErrorCode.INTERNAL_ERROR);</span>
                    }
<span class="nc" id="L1194">                } else {</span>
                    // Recover existing key pair
<span class="nc bnc" id="L1196" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1197">                        log.debug(&quot;Recovering locally stored key pair for end entity '&quot; + username + &quot;'&quot;);</span>
                    }
<span class="nc" id="L1199">                    final KeyRecoveryInformation kri = localNodeKeyRecoverySession.recoverKeysInternal(authenticationToken, username, cryptoTokenId, keyAlias);</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">                    if (kri == null) {</span>
                        // This should not happen when the user has its status set to KEYRECOVERY
<span class="nc" id="L1202">                        final String message = &quot;Could not find key recovery data for end entity '&quot; + username + &quot;'&quot;;</span>
<span class="nc" id="L1203">                        log.debug(message);</span>
<span class="nc" id="L1204">                        throw new EjbcaException(ErrorCode.INTERNAL_ERROR, message);</span>
                    }
<span class="nc" id="L1206">                    kp = kri.getKeyPair();</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">                    if (endEntityProfile.getReUseKeyRecoveredCertificate()) {</span>
<span class="nc" id="L1208">                        final CertificateDataWrapper cdw = searchForCertificateByIssuerAndSerial(authenticationToken, kri.getIssuerDN(), kri.getCertificateSN().toString(16));</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">                        if (cdw == null) {</span>
<span class="nc" id="L1210">                            final String msg = &quot;Key recovery data exists for user '&quot; + username + &quot;', but certificate does not: &quot; + kri.getCertificateSN().toString(16);</span>
<span class="nc" id="L1211">                            log.info(msg);</span>
<span class="nc" id="L1212">                            throw new EjbcaException(ErrorCode.INTERNAL_ERROR, msg);</span>
                        }
<span class="nc" id="L1214">                        cert = (X509Certificate) cdw.getCertificate();</span>
                        // Verify password and finish user
<span class="nc" id="L1216">                        finishUserAfterLocalKeyRecovery(authenticationToken, username, endEntity.getPassword());</span>
<span class="nc" id="L1217">                    } else {</span>
                        // requestCertForEndEntity verifies the password and performs the finishUser operation
<span class="nc" id="L1219">                        cert = requestCertForEndEntity(authenticationToken, storedEndEntity, endEntity.getPassword(), kp);</span>
                    }
<span class="nc" id="L1221">                    localNodeKeyRecoverySession.unmarkUser(authenticationToken, username);</span>
                }
                // Build keystore
                final KeyStore ks;
<span class="nc" id="L1225">                String alias = CertTools.getPartFromDN(CertTools.getSubjectDN(cert), &quot;CN&quot;);</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">                if (alias == null) {</span>
<span class="nc" id="L1227">                    alias = username;</span>
                }
<span class="nc bnc" id="L1229" title="All 2 branches missed.">                if (storedEndEntity.getTokenType() == EndEntityConstants.TOKEN_SOFT_JKS) {</span>
<span class="nc" id="L1230">                    ks = KeyTools.createJKS(alias, kp.getPrivate(), endEntity.getPassword(), cert, cachain);</span>
                } else {
<span class="nc" id="L1232">                    ks = KeyTools.createP12(alias, kp.getPrivate(), cert, cachain);</span>
                }
<span class="nc" id="L1234">                try (final ByteArrayOutputStream baos = new ByteArrayOutputStream()) {</span>
<span class="nc" id="L1235">                    ks.store(baos, endEntity.getPassword().toCharArray());</span>
<span class="nc" id="L1236">                    return baos.toByteArray();</span>
                }
<span class="nc" id="L1238">            } catch (KeyStoreException | CertificateException | NoSuchAlgorithmException | InvalidKeySpecException |</span>
                    InvalidAlgorithmParameterException | IOException e) {
<span class="nc" id="L1240">                throw new IllegalStateException(e);</span>
            }
        } else {
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1244">                log.debug(&quot;Requesting key store for end entity '&quot; + username + &quot;'. Remote peer systems will be queried first&quot;);</span>
            }
        }

<span class="nc bnc" id="L1248" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L1251">                    return raMasterApi.generateKeyStore(authenticationToken, endEntity);</span>
<span class="nc" id="L1252">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1254">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1257">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1259">                } catch (EjbcaException e) {</span>
                    // If the user is not found (e.g. during key recovery), try next implementation
<span class="nc bnc" id="L1261" title="All 2 branches missed.">                    if (!ErrorCode.USER_NOT_FOUND.equals(e.getErrorCode())) {</span>
<span class="nc" id="L1262">                        throw e;</span>
                    }
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                    if (userNotFoundException != null) {</span>
<span class="nc" id="L1265">                        userNotFoundException = e;</span>
                    }
<span class="nc" id="L1267">                }</span>
            }
        }
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1271">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L1273" title="All 2 branches missed.">        if (userNotFoundException != null) {</span>
<span class="nc" id="L1274">            throw userNotFoundException;</span>
        }
<span class="nc" id="L1276">        return null;</span>
    }

    @Override
    public byte[] createCertificate(AuthenticationToken authenticationToken, EndEntityInformation endEntity)
            throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L1282">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L1283">        EjbcaException ejbcaException = null;</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L1287">                    return raMasterApi.createCertificate(authenticationToken, endEntity);</span>
<span class="nc" id="L1288">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1289" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1290">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1293">                } catch (EjbcaException e) {</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                    if (!(e.getCause() instanceof NoSuchEndEntityException)) {</span>
<span class="nc" id="L1295">                        throw e; // rethrow everything else</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">                    } else if (ejbcaException != null) {</span>
<span class="nc" id="L1297">                        ejbcaException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1300">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1302">                }</span>
            }
        }
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1306">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L1308" title="All 2 branches missed.">        if (ejbcaException != null) {</span>
<span class="nc" id="L1309">            throw ejbcaException;</span>
        }
<span class="nc" id="L1311">        return null;</span>
    }

    @Override
    public byte[] createCertificateWS(final AuthenticationToken authenticationToken, final UserDataVOWS userdata, final String requestData, final int requestType,
            final String hardTokenSN, final String responseType) throws AuthorizationDeniedException, ApprovalException, EjbcaException,
            EndEntityProfileValidationException {
<span class="nc" id="L1318">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L1319">        EjbcaException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">        	if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1322">        	    log.debug(&quot;raMasterApi calling createCertificateWS: &quot;+raMasterApi.getApiVersion()+&quot;, &quot;+raMasterApi.isBackendAvailable()+&quot;, &quot;+raMasterApi.getClass());</span>
        	}
<span class="nc bnc" id="L1324" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L1326">                    return raMasterApi.createCertificateWS(authenticationToken, userdata, requestData, requestType, hardTokenSN, responseType);</span>
<span class="nc" id="L1327">                } catch (EjbcaException e) {</span>
                    // Only catch &quot;CA doesn't exist&quot; case here
<span class="nc bnc" id="L1329" title="All 4 branches missed.">                    if (e.getErrorCode() != null &amp;&amp; !ErrorCode.CA_NOT_EXISTS.getInternalErrorCode().equals(e.getErrorCode().getInternalErrorCode())) {</span>
<span class="nc" id="L1330">                        throw e;</span>
                    }
<span class="nc bnc" id="L1332" title="All 2 branches missed.">                    if (caDoesntExistException == null) {</span>
<span class="nc" id="L1333">                        caDoesntExistException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1336">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1338">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1341">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1343">                }</span>
            }
        }
<span class="nc bnc" id="L1346" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1347">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L1349" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1350">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1352">        return null;</span>
    }

    @Override
    public byte[] createCertificateRest(final AuthenticationToken authenticationToken, EnrollPkcs10CertificateRequest enrollcertificateRequest)
            throws CertificateProfileDoesNotExistException, CADoesntExistsException, AuthorizationDeniedException, EndEntityProfileNotFoundException,
            EjbcaException, EndEntityProfileValidationException {
<span class="nc" id="L1359">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1361" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1363">                    log.debug(&quot;raMasterApi calling createCertificateRest: &quot;+raMasterApi.getApiVersion()+&quot;, &quot;+raMasterApi.isBackendAvailable()+&quot;, &quot;+raMasterApi.getClass());</span>
                }
                try {
<span class="nc" id="L1366">                    return raMasterApi.createCertificateRest(authenticationToken, enrollcertificateRequest);</span>
<span class="nc" id="L1367">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L1368">                    caDoesntExistException = e;</span>
<span class="nc" id="L1369">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1371">                }</span>
            }
        }
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1375">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1377">        return null;</span>
    }

    @Override
    public void keyRecoverWS(AuthenticationToken authenticationToken, String username, String certSNinHex, String issuerDN) throws EjbcaException, AuthorizationDeniedException,
                                WaitingForApprovalException, ApprovalException, CADoesntExistsException {
        // Handle local key recovery (Key recovery data is stored locally)
<span class="nc" id="L1384">        GlobalConfiguration globalConfig = (GlobalConfiguration) localNodeGlobalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
<span class="nc bnc" id="L1385" title="All 4 branches missed.">        if (globalConfig.getEnableKeyRecovery() &amp;&amp; globalConfig.getLocalKeyRecovery()) {</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">            if (searchUser(authenticationToken, username) == null) {</span>
<span class="nc" id="L1387">                throw new NotFoundException(&quot;User with username '&quot; + username + &quot;' was not found&quot;);</span>
            }
            // Search for the certificate on all implementations
<span class="nc" id="L1390">            CertificateDataWrapper cdw = searchForCertificateByIssuerAndSerial(authenticationToken, issuerDN, certSNinHex);</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">            if (cdw == null) {</span>
<span class="nc" id="L1392">                throw new NotFoundException(&quot;Certificate for user: '&quot; + username + &quot;' with serialNr: '&quot; + certSNinHex + &quot;' issued by: '&quot; + issuerDN + &quot;' was not found&quot;);</span>
            }
<span class="nc" id="L1394">            final boolean localRecoveryPossible = keyRecoveryPossible(authenticationToken, cdw.getCertificate(), username);</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">            if (!localRecoveryPossible) {</span>
<span class="nc" id="L1396">                throw new EjbcaException(ErrorCode.KEY_RECOVERY_NOT_AVAILABLE);</span>
            }
            try {
                // Attempts recovery on all implementations
<span class="nc" id="L1400">                markForRecovery(authenticationToken, username, null, cdw, true);</span>
<span class="nc" id="L1401">            } catch (NoSuchEndEntityException e) {</span>
                // To not mess with the WS API
<span class="nc" id="L1403">                throw new NotFoundException(e.getMessage());</span>
<span class="nc" id="L1404">            } catch (EndEntityProfileValidationException e) {</span>
                // To not mess with the WS API
<span class="nc" id="L1406">                throw new EjbcaException(ErrorCode.USER_DOESNT_FULFILL_END_ENTITY_PROFILE);</span>
<span class="nc" id="L1407">            }</span>
            // We are done. Don't try other implementations
<span class="nc" id="L1409">            return;</span>
        }

        // Default case
<span class="nc" id="L1413">        EjbcaException ejbcaException = null;</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1415" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) { // added between v1 and v2, lacks an exact version</span>
                try {
<span class="nc" id="L1417">                    raMasterApi.keyRecoverWS(authenticationToken, username, certSNinHex, issuerDN);</span>
                    // If no exceptions were thrown, recovery is complete
<span class="nc" id="L1419">                    return;</span>
<span class="nc" id="L1420">                } catch (EjbcaException e) {</span>
                    // Save the exception and continue with next implementation
<span class="nc" id="L1422">                    ejbcaException = e;</span>
<span class="nc" id="L1423">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1425">                }</span>
            }
        }
        // Unsuccessful on all implementations. Inform WS.
<span class="nc bnc" id="L1429" title="All 2 branches missed.">        if (ejbcaException != null) {</span>
<span class="nc" id="L1430">            throw ejbcaException;</span>
        }
<span class="nc" id="L1432">    }</span>

    @Override
    public byte[] keyRecoverEnrollWS(AuthenticationToken authenticationToken, String username, String certSNinHex, String issuerDN, String password, String hardTokenSN)
            throws AuthorizationDeniedException, ApprovalException, CADoesntExistsException, EjbcaException, WaitingForApprovalException {
<span class="nc" id="L1437">        AuthorizationDeniedException authorizationDeniedException = null;</span>

<span class="nc bnc" id="L1439" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1440" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 3) {</span>
                try {
<span class="nc" id="L1442">                    byte[] ret = raMasterApi.keyRecoverEnrollWS(authenticationToken, username, certSNinHex, issuerDN, password, hardTokenSN);</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">                    if (ret != null) {</span>
<span class="nc" id="L1444">                        return ret;</span>
                    }
<span class="nc" id="L1446">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
                        // Throw if all implementations fail
<span class="nc" id="L1449">                        authorizationDeniedException = e;</span>
                    }
<span class="nc" id="L1451">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1453">                }</span>
            }
        }
<span class="nc bnc" id="L1456" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1457">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L1459">        return null;</span>
    }

    @Override
    public List&lt;CertificateWrapper&gt; getLastCertChain(final AuthenticationToken authenticationToken, final String username) throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L1464">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L1465" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1466" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L1468">                     final List&lt;CertificateWrapper&gt; chain = raMasterApi.getLastCertChain(authenticationToken, username);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">                     if (!chain.isEmpty()) {</span>
<span class="nc" id="L1470">                         return chain;</span>
                     }
                     // Otherwise, try next implementation
<span class="nc" id="L1473">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1475">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1478">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1480">                }</span>
            }
        }
<span class="nc bnc" id="L1483" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1484">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L1486">        return new ArrayList&lt;&gt;();</span>
    }

    @Override
    public boolean changeCertificateStatus(final AuthenticationToken authenticationToken, final String fingerprint, final int newStatus,
            final int newRevocationReason) throws ApprovalException, WaitingForApprovalException {
<span class="nc" id="L1492">        boolean ret = false;</span>
        // Try remote first, since the certificate might be present in the RA database but the admin might not authorized to revoke it there
<span class="nc bnc" id="L1494" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L1497">                    ret = raMasterApi.changeCertificateStatus(authenticationToken, fingerprint, newStatus, newRevocationReason);</span>
<span class="nc bnc" id="L1498" title="All 2 branches missed.">                    if (ret) {</span>
<span class="nc" id="L1499">                        break;</span>
                    }
<span class="nc" id="L1501">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1503">                }</span>
            }
        }
<span class="nc" id="L1506">        return ret;</span>
    }

    @Override
    public void revokeCert(AuthenticationToken admin, BigInteger certserno, Date revocationdate, String issuerdn, int reason, boolean checkDate)
            throws AuthorizationDeniedException, NoSuchEndEntityException, ApprovalException, WaitingForApprovalException,
            RevokeBackDateNotAllowedForProfileException, AlreadyRevokedException, CADoesntExistsException {
        // Try remote first, since the certificate might be present in the RA database but the admin might not authorized to revoke it there
<span class="nc" id="L1514">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1516" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 3) {</span>
                try {
<span class="nc" id="L1518">                    raMasterApi.revokeCert(admin, certserno, revocationdate, issuerdn, reason, checkDate);</span>
                    // if it completed successfully, break
<span class="nc" id="L1520">                    break;</span>
<span class="nc" id="L1521">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L1522">                    caDoesntExistException = e;</span>
<span class="nc" id="L1523">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1525">                }</span>
            }
        }
<span class="nc bnc" id="L1528" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1529">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1531">    }</span>

    @Override
    public void revokeCertWithMetadata(AuthenticationToken admin, CertRevocationDto certRevocationDto)
            throws AuthorizationDeniedException, NoSuchEndEntityException, ApprovalException, WaitingForApprovalException,
            RevokeBackDateNotAllowedForProfileException, AlreadyRevokedException, CADoesntExistsException, IllegalArgumentException, CertificateProfileDoesNotExistException {
        // Try remote first, since the certificate might be present in the RA database but the admin might not authorized to revoke it there
<span class="nc" id="L1538">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1540" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 3) { // added between v3 and v4, lacks an exact version</span>
                try {
<span class="nc" id="L1542">                    raMasterApi.revokeCertWithMetadata(admin, certRevocationDto);</span>
                    // if it completed successfully, break
<span class="nc" id="L1544">                    break;</span>
<span class="nc" id="L1545">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L1546">                    caDoesntExistException = e;</span>
<span class="nc" id="L1547">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1549">                }</span>
            }
        }
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1553">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1555">    }</span>

    @Override
    public void revokeUser(final AuthenticationToken authenticationToken, final String username, final int reason, final boolean deleteUser) throws AuthorizationDeniedException, CADoesntExistsException,
        ApprovalException, WaitingForApprovalException, AlreadyRevokedException, NoSuchEndEntityException, CouldNotRemoveEndEntityException, EjbcaException {
        // Try over all instances.
<span class="nc" id="L1561">        boolean revoked = false;</span>
<span class="nc" id="L1562">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc" id="L1563">        NoSuchEndEntityException noSuchEndEntityException = null;</span>
<span class="nc" id="L1564">        ApprovalException approvalException = null;</span>
<span class="nc" id="L1565">        WaitingForApprovalException waitingForApprovalException = null;</span>
<span class="nc" id="L1566">        AlreadyRevokedException alreadyRevokedException = null;</span>
<span class="nc" id="L1567">        CouldNotRemoveEndEntityException couldNotRemoveEndEntityException = null;</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1569" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L1571">                    raMasterApi.revokeUser(authenticationToken, username, reason, deleteUser);</span>
<span class="nc" id="L1572">                    revoked = true;</span>
<span class="nc" id="L1573">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation.
<span class="nc" id="L1575">                } catch (CADoesntExistsException e) {</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1577">                        log.debug(&quot;CA for proxied request on CA could not be found: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1579" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L1580">                        caDoesntExistsException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L1583">                } catch (NoSuchEndEntityException e) {</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1585">                        log.debug( &quot;End entity for proxied request on CA could not be found: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1587" title="All 2 branches missed.">                    if (noSuchEndEntityException == null) {</span>
<span class="nc" id="L1588">                        noSuchEndEntityException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L1591">                } catch (ApprovalException e) {</span>
<span class="nc bnc" id="L1592" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1593">                        log.debug( &quot;End entity for proxied request on CA is in approval process: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1595" title="All 2 branches missed.">                    if (approvalException == null) {</span>
<span class="nc" id="L1596">                        approvalException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L1599">                } catch (WaitingForApprovalException e) {</span>
<span class="nc bnc" id="L1600" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1601">                        log.debug( &quot;End entity for proxied request on CA is in approval process: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1603" title="All 2 branches missed.">                    if (waitingForApprovalException == null) {</span>
<span class="nc" id="L1604">                        waitingForApprovalException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L1607">                } catch (AlreadyRevokedException e) {</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1609">                        log.debug( &quot;End entity for proxied request on CA is revoked already: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1611" title="All 2 branches missed.">                    if (alreadyRevokedException == null) {</span>
<span class="nc" id="L1612">                        alreadyRevokedException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L1615">                } catch (CouldNotRemoveEndEntityException e) {</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1617">                        log.debug( &quot;End entity for proxied request on CA could not be removed: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L1619" title="All 2 branches missed.">                	if (couldNotRemoveEndEntityException == null) {</span>
<span class="nc" id="L1620">                        couldNotRemoveEndEntityException = e;</span>
                    }
                	// Just try next implementation.
<span class="nc" id="L1623">                }</span>
            }
        }
<span class="nc bnc" id="L1626" title="All 2 branches missed.">        if (!revoked) {</span>
<span class="nc bnc" id="L1627" title="All 2 branches missed.">            if (caDoesntExistsException != null) {</span>
<span class="nc" id="L1628">                throw caDoesntExistsException;</span>
            }
<span class="nc bnc" id="L1630" title="All 2 branches missed.">            if (approvalException != null) {</span>
<span class="nc" id="L1631">                throw approvalException;</span>
            }
<span class="nc bnc" id="L1633" title="All 2 branches missed.">            if (waitingForApprovalException != null) {</span>
<span class="nc" id="L1634">                throw waitingForApprovalException;</span>
            }
<span class="nc bnc" id="L1636" title="All 2 branches missed.">            if (alreadyRevokedException != null) {</span>
<span class="nc" id="L1637">                throw alreadyRevokedException;</span>
            }
<span class="nc bnc" id="L1639" title="All 2 branches missed.">            if (couldNotRemoveEndEntityException != null) {</span>
<span class="nc" id="L1640">                throw couldNotRemoveEndEntityException;</span>
            }
<span class="nc bnc" id="L1642" title="All 2 branches missed.">            if (noSuchEndEntityException != null) {</span>
<span class="nc" id="L1643">                throw noSuchEndEntityException;</span>
            }
        }
<span class="nc" id="L1646">    }</span>

    @Override
    public CertificateStatus getCertificateStatus(AuthenticationToken authenticationToken, String issuerDN, BigInteger serno) throws CADoesntExistsException, AuthorizationDeniedException{
<span class="nc" id="L1650">        CertificateStatus ret = null;</span>
        // Try remote first, since the certificate might be present in the RA database but the admin might not authorized to revoke it there
<span class="nc bnc" id="L1652" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1653" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 3) {</span>
                try {
<span class="nc" id="L1655">                    ret = raMasterApi.getCertificateStatus(authenticationToken, issuerDN, serno);</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">                    if (ret != null) {</span>
<span class="nc" id="L1657">                        break;</span>
                    }
<span class="nc" id="L1659">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1661">                }</span>
            }
        }
<span class="nc bnc" id="L1664" title="All 2 branches missed.">        if (ret == null) {</span>
            // This method should never return null according to the contract (javadoc)
<span class="nc" id="L1666">            return CertificateStatus.NOT_AVAILABLE;</span>
        }
<span class="nc" id="L1668">        return ret;</span>
    }

    @Override
    public boolean markForRecovery(AuthenticationToken authenticationToken, String username, String newPassword, CertificateWrapper cert, boolean localKeyGeneration) throws ApprovalException, CADoesntExistsException,
                                    AuthorizationDeniedException, WaitingForApprovalException, NoSuchEndEntityException, EndEntityProfileValidationException {
<span class="nc" id="L1674">        boolean ret = false;</span>
<span class="nc" id="L1675">        final GlobalConfiguration globalConfig = (GlobalConfiguration) localNodeGlobalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
<span class="nc bnc" id="L1676" title="All 4 branches missed.">        final boolean localKeyRecoveryThisNode = globalConfig.getEnableKeyRecovery() &amp;&amp; globalConfig.getLocalKeyRecovery();</span>
<span class="nc bnc" id="L1677" title="All 2 branches missed.">        if (localKeyRecoveryThisNode) {</span>
<span class="nc" id="L1678">            localKeyGeneration = true;</span>
        }

<span class="nc bnc" id="L1681" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1682" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L1684">                    ret = raMasterApi.markForRecovery(authenticationToken, username, newPassword, cert, localKeyGeneration);</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">                    if (ret) {</span>
<span class="nc" id="L1686">                        break;</span>
                    }
<span class="nc" id="L1688">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1690">                } catch (WaitingForApprovalException e) {</span>
                    // If approval is required, the approving instance won't be able to set the flag in this database, so we set it anyway
                    // Enrollment won't be possible until UserData status is set to KeyRecovery by the requesting instance (at approval).
<span class="nc bnc" id="L1693" title="All 2 branches missed.">                    if (localKeyRecoveryThisNode) {</span>
<span class="nc" id="L1694">                        localNodeKeyRecoverySession.markAsRecoverableInternal(authenticationToken, cert, username);</span>
                    }
<span class="nc" id="L1696">                    throw e;</span>
<span class="nc" id="L1697">                }</span>
            }
        }

        // If local key generation is enabled, we have to do this locally
<span class="nc bnc" id="L1702" title="All 4 branches missed.">        if (ret &amp;&amp; localKeyRecoveryThisNode) {</span>
<span class="nc" id="L1703">            localNodeKeyRecoverySession.unmarkUser(authenticationToken, username);</span>
<span class="nc" id="L1704">            ret = localNodeKeyRecoverySession.markAsRecoverableInternal(authenticationToken, cert, username);</span>
        }
<span class="nc" id="L1706">        return ret;</span>
    }

    @Override
    public boolean editUser(AuthenticationToken authenticationToken, EndEntityInformation endEntityInformation)
            throws AuthorizationDeniedException, EndEntityProfileValidationException,
            WaitingForApprovalException, CADoesntExistsException, ApprovalException,
            CertificateSerialNumberException, IllegalNameException, NoSuchEndEntityException, CustomFieldException {
<span class="nc bnc" id="L1714" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1715" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 2) {</span>
                try {
<span class="nc bnc" id="L1717" title="All 2 branches missed.">                    if (raMasterApi.editUser(authenticationToken, endEntityInformation)) {</span>
                        // Successfully edited the user
<span class="nc" id="L1719">                        return true;</span>
                    }
<span class="nc" id="L1721">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1723">                }</span>
            }
        }
        // Editing was unsuccessful
<span class="nc" id="L1727">        return false;</span>
    }

    @Override
    public boolean editUserWs(AuthenticationToken authenticationToken, UserDataVOWS userDataVOWS)
            throws AuthorizationDeniedException, EndEntityProfileValidationException, WaitingForApprovalException, CADoesntExistsException,
            CertificateSerialNumberException, IllegalNameException, NoSuchEndEntityException, EjbcaException {
<span class="nc" id="L1734">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1736" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc bnc" id="L1738" title="All 2 branches missed.">                    if (raMasterApi.editUserWs(authenticationToken, userDataVOWS)) {</span>
                        // Successfully edited the user
<span class="nc" id="L1740">                        return true;</span>
                    }
<span class="nc" id="L1742">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L1743">                    caDoesntExistException = e;</span>
<span class="nc" id="L1744">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1746">                }</span>
            }
        }
        // Editing was unsuccessful
<span class="nc bnc" id="L1750" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1751">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L1753">        return false;</span>
    }

    @Override
    public boolean keyRecoveryPossible(AuthenticationToken authenticationToken, Certificate cert, String username) {
        // Special case where local key generation is enabled
<span class="nc" id="L1759">        GlobalConfiguration globalConfig = (GlobalConfiguration) localNodeGlobalConfigurationSession.getCachedConfiguration(GlobalConfiguration.GLOBAL_CONFIGURATION_ID);</span>
<span class="nc bnc" id="L1760" title="All 4 branches missed.">        if (globalConfig.getEnableKeyRecovery() &amp;&amp; globalConfig.getLocalKeyRecovery()) {</span>
<span class="nc" id="L1761">            EndEntityInformation storedEndEntity = searchUser(authenticationToken, username);</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">            if (storedEndEntity != null) {</span>
<span class="nc" id="L1763">                boolean authorized = false;</span>
<span class="nc" id="L1764">                authorized = isAuthorizedNoLogging(authenticationToken, AccessRulesConstants.REGULAR_KEYRECOVERY,</span>
<span class="nc" id="L1765">                        AccessRulesConstants.ENDENTITYPROFILEPREFIX + Integer.toString(storedEndEntity.getEndEntityProfileId()) + AccessRulesConstants.KEYRECOVERY_RIGHTS,</span>
                        AccessRulesConstants.REGULAR_RAFUNCTIONALITY + AccessRulesConstants.KEYRECOVERY_RIGHTS);
<span class="nc bnc" id="L1767" title="All 6 branches missed.">                return authorized &amp;&amp; storedEndEntity.getStatus() != EndEntityConstants.STATUS_KEYRECOVERY &amp;&amp; localNodeKeyRecoverySession.existsKeys(EJBTools.wrap(cert));</span>
            }
<span class="nc" id="L1769">            return false;</span>
        }

        // Default case (everything we need should be available in one instance database)
<span class="nc" id="L1773">        boolean ret = false;</span>
<span class="nc bnc" id="L1774" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L1775" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 1) {</span>
                try {
<span class="nc" id="L1777">                    ret = raMasterApi.keyRecoveryPossible(authenticationToken, cert, username);</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">                    if (ret) {</span>
<span class="nc" id="L1779">                        break;</span>
                    }
<span class="nc" id="L1781">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1783">                }</span>
            }
        }
<span class="nc" id="L1786">        return ret;</span>
    }

    @Override
    public ApprovalProfile getApprovalProfileForAction(final AuthenticationToken authenticationToken, final ApprovalRequestType action, final int caId, final int certificateProfileId) throws AuthorizationDeniedException {
<span class="nc" id="L1791">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">            if (raMasterApi.isBackendAvailable()) {</span>
                try {
<span class="nc" id="L1795">                    return raMasterApi.getApprovalProfileForAction(authenticationToken, action, caId, certificateProfileId);</span>
<span class="nc" id="L1796">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L1798">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1801">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1803">                }</span>
            }
        }
<span class="nc bnc" id="L1806" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L1807">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L1809">        return null;</span>
    }

    @Override
    public byte[] scepDispatch(final AuthenticationToken authenticationToken, final String operation, final String message, final String scepConfigurationAlias) throws CertificateEncodingException,
            CADoesntExistsException, NoSuchEndEntityException, CustomCertificateSerialNumberException, CryptoTokenOfflineException, IllegalKeyException,
            SignRequestException, SignRequestSignatureException, AuthStatusException, AuthLoginException, IllegalNameException, CertificateCreateException, CertificateRevokeException,
            CertificateSerialNumberException, IllegalValidityException, CAOfflineException, InvalidAlgorithmException, SignatureException, CertificateException,
            CertificateExtensionException, CertificateRenewalException, NoSuchAliasException, AuthorizationDeniedException {
<span class="nc" id="L1818">        NoSuchAliasException caughtException = null;</span>

<span class="nc bnc" id="L1820" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1821" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 3) {</span>
                try {
                    byte[] response;
                    try {
<span class="nc" id="L1825">                        response = raMasterApi.scepDispatch(authenticationToken, operation, message, scepConfigurationAlias);</span>
<span class="nc" id="L1826">                        return response;</span>
                        // Try all implementations before failing on this exception
<span class="nc" id="L1828">                    } catch (NoSuchAliasException e) {</span>
<span class="nc" id="L1829">                        caughtException = e;</span>
                    }
<span class="nc" id="L1831">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1833">                }</span>
            }
        }

<span class="nc bnc" id="L1837" title="All 2 branches missed.">        if (caughtException != null) {</span>
<span class="nc" id="L1838">            throw caughtException;</span>
        } else {
<span class="nc" id="L1840">            return null;</span>
        }
    }

    @Override
    public byte[] cmpDispatch(final AuthenticationToken authenticationToken, final byte[] pkiMessageBytes, final String cmpConfigurationAlias) throws NoSuchAliasException {
<span class="nc" id="L1846">        NoSuchAliasException caughtException = null;</span>

<span class="nc bnc" id="L1848" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1849" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion()&gt;=1) {</span>
                try {
                    byte[] result;
                    try {
<span class="nc" id="L1853">                        result = raMasterApi.cmpDispatch(authenticationToken, pkiMessageBytes, cmpConfigurationAlias);</span>
<span class="nc" id="L1854">                        return result;</span>
<span class="nc" id="L1855">                    } catch (NoSuchAliasException e) {</span>
                        //We might not have an alias in the current RaMasterApi, so let's try another. Let's store the exception in case we need it
                        //later though.
<span class="nc" id="L1858">                        caughtException = e;</span>
                    }
<span class="nc" id="L1860">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1862">                }</span>
            }
        }
        // either throw an exception or return null
<span class="nc bnc" id="L1866" title="All 2 branches missed.">        if (caughtException != null) {</span>
<span class="nc" id="L1867">            throw caughtException;</span>
        } else {
<span class="nc" id="L1869">            return null;</span>
        }
    }

    @Override
    public byte[] estDispatch(final String operation, final String alias, final X509Certificate cert, final String username, final String password,
            final byte[] requestBody) throws NoSuchAliasException,
            CADoesntExistsException, CertificateCreateException, CertificateRenewalException, AuthenticationFailedException  {
<span class="nc" id="L1877">        NoSuchAliasException caughtNoAliasException = null;</span>
<span class="nc" id="L1878">        AuthenticationFailedException caughtAuthFailedException = null;</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1880" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 2) { // EST in version 2 and later</span>
                try {
                    try {
<span class="nc" id="L1883">                        return raMasterApi.estDispatch(operation, alias, cert, username, password, requestBody);</span>
<span class="nc" id="L1884">                    } catch (NoSuchAliasException e) {</span>
                        //We might not have an alias in the current RaMasterApi, so let's try another. Let's store the exception in case we need it
                        //later though.
<span class="nc" id="L1887">                        caughtNoAliasException = e;</span>
<span class="nc" id="L1888">                    } catch (AuthenticationFailedException e) {</span>
                        // This will occur when WWW_AUTHENTICATE header (authentication method) is sent back to client. We don't want to
                        // interrupt this 'negotiation' unless all implementations fail (i.e. due to invalid authentication details).
<span class="nc" id="L1891">                        caughtAuthFailedException = e;</span>
<span class="nc" id="L1892">                    }</span>
<span class="nc" id="L1893">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1895">                }</span>
            }
        }

        // either throw an exception or return null
<span class="nc bnc" id="L1900" title="All 2 branches missed.">        if (caughtNoAliasException != null) {</span>
<span class="nc" id="L1901">            throw caughtNoAliasException;</span>
<span class="nc bnc" id="L1902" title="All 2 branches missed.">        } else if(caughtAuthFailedException != null){</span>
<span class="nc" id="L1903">            throw caughtAuthFailedException;</span>
        } else {
        	// No suitable RaMasterAPIs were found?
<span class="nc" id="L1906">        	log.info(&quot;No suitable RA Master APIs were found among the ones we have: &quot; + raMasterApis.length);</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">        	if (log.isDebugEnabled()) {</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">        	    for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc" id="L1909">        	        log.info(&quot;isBackendAvailable: &quot;+raMasterApi.isBackendAvailable() + &quot;, apiVersion=&quot;+raMasterApi.getApiVersion()+&quot;, class: &quot;+raMasterApi.getClass().getName());</span>
        	    }
        	}
<span class="nc" id="L1912">            return null;</span>
        }
    }

    @Override
    public List&lt;UserDataVOWS&gt; findUserWS(AuthenticationToken authenticationToken, UserMatch usermatch, int maxNumberOfRows) throws
            AuthorizationDeniedException, IllegalQueryException, EjbcaException, EndEntityProfileNotFoundException {
<span class="nc" id="L1919">        final List&lt;UserDataVOWS&gt; mergedResult = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1920">        EndEntityProfileNotFoundException eeProfileNotFoundException = null;</span>
<span class="nc" id="L1921">        boolean oneSucceeded = false;</span>
<span class="nc bnc" id="L1922" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1923" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable()  &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L1925">                    List&lt;UserDataVOWS&gt; result = raMasterApi.findUserWS(authenticationToken, usermatch, maxNumberOfRows - mergedResult.size());</span>
<span class="nc bnc" id="L1926" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L1927">                        mergedResult.addAll(result);</span>
                    }
<span class="nc bnc" id="L1929" title="All 2 branches missed.">                    if (mergedResult.size() &gt;= maxNumberOfRows) {</span>
<span class="nc" id="L1930">                        return mergedResult;</span>
                    }
<span class="nc" id="L1932">                    oneSucceeded = true; // ignore exceptions if the search operation succeeds on one node (could still be an empty result)</span>
<span class="nc" id="L1933">                } catch (EndEntityProfileNotFoundException e) {</span>
<span class="nc bnc" id="L1934" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1935">                        log.debug(&quot;End entity profile not found on this peer. &quot; + e.getMessage());</span>
                    }
<span class="nc" id="L1937">                    eeProfileNotFoundException = e;</span>
<span class="nc" id="L1938">                } catch (UnsupportedOperationException e) {</span>
<span class="nc bnc" id="L1939" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1940">                        log.debug(&quot;Trouble during back end invocation: &quot; + e.getMessage());</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1943">                } catch (RaMasterBackendUnavailableException e) {</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1945">                        log.debug(&quot;Timeout during back end invocation.&quot;, e);</span>
                    }
<span class="nc" id="L1947">                }</span>
            }
        }
<span class="nc bnc" id="L1950" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; eeProfileNotFoundException != null) {</span>
<span class="nc" id="L1951">            throw eeProfileNotFoundException;</span>
        }
<span class="nc" id="L1953">        return mergedResult;</span>
    }

    @Override
    public int getPublisherQueueLength(AuthenticationToken authenticationToken, String name) throws AuthorizationDeniedException, PublisherDoesntExistsException {
<span class="nc" id="L1958">        PublisherDoesntExistsException publisherDoesntExistsException = null;</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1960" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable()  &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L1962">                    return raMasterApi.getPublisherQueueLength(authenticationToken, name);</span>
<span class="nc" id="L1963">                } catch (PublisherDoesntExistsException e) {</span>
<span class="nc" id="L1964">                    publisherDoesntExistsException = e;</span>
<span class="nc" id="L1965">                } catch (UnsupportedOperationException e) {</span>
<span class="nc bnc" id="L1966" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1967">                        log.debug(&quot;Trouble during back end invocation: &quot; + e.getMessage());</span>
                    }
                    // Just try next implementation
<span class="nc" id="L1970">                } catch (RaMasterBackendUnavailableException e) {</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L1972">                        log.debug(&quot;Timeout during back end invocation.&quot;, e);</span>
                    }
<span class="nc" id="L1974">                }</span>
            }
        }
<span class="nc bnc" id="L1977" title="All 2 branches missed.">        if (publisherDoesntExistsException != null) {</span>
<span class="nc" id="L1978">            throw publisherDoesntExistsException;</span>
        }
<span class="nc" id="L1980">        throw new PublisherDoesntExistsException(&quot;No peer systems are available&quot;);</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; getCertificateChain(final AuthenticationToken authenticationToken, int caid) throws AuthorizationDeniedException, CADoesntExistsException {
<span class="nc" id="L1985">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L1986" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L1987" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L1989">                    return raMasterApi.getCertificateChain(authenticationToken, caid);</span>
<span class="nc" id="L1990">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L1991">                    caDoesntExistException = e;</span>
<span class="nc" id="L1992">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L1994">                }</span>
            }
        }
<span class="nc bnc" id="L1997" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L1998">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L2000">        return null;</span>
    }

    @Override
    public int getCountOfCertificatesByExpirationTime(final AuthenticationToken authenticationToken, long days) throws AuthorizationDeniedException {
<span class="nc" id="L2005">        int result = 0;</span>
<span class="nc bnc" id="L2006" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L2007" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2009">                    result += raMasterApi.getCountOfCertificatesByExpirationTime(authenticationToken, days);</span>
<span class="nc" id="L2010">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2012">                }</span>
            }
        }
<span class="nc" id="L2015">        return result;</span>
    }

    @Override
    public void customLog(final AuthenticationToken authenticationToken, final String type, final String caName, final String username, final String certificateSn,
    		final String msg, final EventType event) throws AuthorizationDeniedException, CADoesntExistsException {
<span class="nc" id="L2021">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2022">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2023" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2024" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2026">                    raMasterApi.customLog(authenticationToken, type, caName, username, certificateSn, msg, event);</span>
<span class="nc" id="L2027">                    return;</span>
<span class="nc" id="L2028">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2030">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2032">                        log.debug(&quot;Authorization to write custom log entry for proxied request on CA was denied: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2034" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2035">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2038">                } catch (CADoesntExistsException e) {</span>
<span class="nc bnc" id="L2039" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2040">                        log.debug(&quot;CA to write custom log entry for proxied request on CA could not be found: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2042" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L2043">                        caDoesntExistsException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2046">                }</span>
            }
        }
<span class="nc bnc" id="L2049" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2050">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2052" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2053">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2055">    }</span>

    @Override
    public Collection&lt;CertificateWrapper&gt; getCertificatesByUsername(final AuthenticationToken authenticationToken, final String username, final boolean onlyValid, final long now)
            throws AuthorizationDeniedException, CertificateEncodingException {
<span class="nc" id="L2060">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2061">        CertificateEncodingException certificateEncodingException = null;</span>
<span class="nc" id="L2062">        final Map&lt;String, CertificateWrapper&gt; result = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L2063">        final List&lt;CertificateWrapper&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2064">        boolean oneSucceeded = false;</span>
<span class="nc bnc" id="L2065" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2066" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2068">                    final Collection&lt;CertificateWrapper&gt; certificates = raMasterApi.getCertificatesByUsername(authenticationToken, username, onlyValid, now);</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">                    for (CertificateWrapper certificate : certificates) {</span>
<span class="nc" id="L2070">                        result.put(CertTools.getFingerprintAsString(certificate.getCertificate()), certificate);</span>
<span class="nc" id="L2071">                    }</span>
<span class="nc" id="L2072">                    oneSucceeded = true;</span>
<span class="nc" id="L2073">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2075">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2077">                        log.debug( &quot;Authorization to get certificates by username for proxied request on CA was denied: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2079" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2080">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2083">                } catch (CertificateEncodingException e) {</span>
<span class="nc bnc" id="L2084" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2085">                        log.debug(&quot;Certificate found by username for proxied request on CA could not be encoded: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2087" title="All 2 branches missed.">                    if (certificateEncodingException == null) {</span>
<span class="nc" id="L2088">                        certificateEncodingException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2091">                }</span>
            }
        }
<span class="nc bnc" id="L2094" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L2095">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2097" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; certificateEncodingException != null) {</span>
<span class="nc" id="L2098">            throw certificateEncodingException;</span>
        }
<span class="nc" id="L2100">        ret.addAll(result.values());</span>
<span class="nc" id="L2101">        return ret;</span>
    }

    @Override
    public Map&lt;String, Integer&gt; getAvailableCertificateProfiles(final AuthenticationToken authenticationToken, final int entityProfileId)
            throws AuthorizationDeniedException, EndEntityProfileNotFoundException{
        // Try over all instances.
<span class="nc" id="L2108">        final Map&lt;String, Integer&gt; result = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L2109">        EndEntityProfileNotFoundException ejbcaException = null;</span>
<span class="nc bnc" id="L2110" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2111" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2113">                    result.putAll(raMasterApi.getAvailableCertificateProfiles(authenticationToken, entityProfileId));</span>
<span class="nc" id="L2114">                    return result;</span>
<span class="nc" id="L2115">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2117">                } catch (EndEntityProfileNotFoundException e) {</span>
<span class="nc" id="L2118">                    log.debug(&quot;End entity profiles for proxied request on CA could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2119" title="All 2 branches missed.">                    if (ejbcaException == null) {</span>
<span class="nc" id="L2120">                        ejbcaException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2123">                }</span>
            }
        }
<span class="nc bnc" id="L2126" title="All 2 branches missed.">        if (ejbcaException != null) {</span>
<span class="nc" id="L2127">            throw ejbcaException;</span>
        }
<span class="nc" id="L2129">        return result;</span>
    }

    @Override
    public Map&lt;String, Integer&gt; getAvailableCasInProfile(final AuthenticationToken authenticationToken, final int entityProfileId)
            throws AuthorizationDeniedException, EndEntityProfileNotFoundException {
<span class="nc" id="L2135">        EndEntityProfileNotFoundException endEntityProfileNotFoundException = null;</span>
<span class="nc bnc" id="L2136" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2137" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2139">                    return raMasterApi.getAvailableCasInProfile(authenticationToken, entityProfileId);</span>
<span class="nc" id="L2140">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2142">                } catch (EndEntityProfileNotFoundException e) {</span>
<span class="nc" id="L2143">                    log.debug(&quot;CAs associated with end entity profile &quot; + entityProfileId + &quot; for proxied request on CA could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">                    if (endEntityProfileNotFoundException == null) {</span>
<span class="nc" id="L2145">                        endEntityProfileNotFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2148">                }</span>
            }
        }
<span class="nc bnc" id="L2151" title="All 2 branches missed.">        if (endEntityProfileNotFoundException != null) {</span>
<span class="nc" id="L2152">        	throw endEntityProfileNotFoundException;</span>
        }
<span class="nc" id="L2154">        return new TreeMap&lt;&gt;();</span>
    }

    @Override
    public CertificateWrapper getCertificate(final AuthenticationToken authenticationToken, final String certSNinHex, final String issuerDN)
            throws AuthorizationDeniedException, CADoesntExistsException, EjbcaException {
<span class="nc" id="L2160">        CertificateWrapper result = null;</span>
<span class="nc" id="L2161">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2162">        EjbcaException ejbcaException = null;</span>
<span class="nc" id="L2163">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2164" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2165" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2167">                    result = raMasterApi.getCertificate(authenticationToken, certSNinHex, issuerDN);</span>
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L2169">                    	return result;</span>
                    }
<span class="nc" id="L2171">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2173">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2174">                    log.debug(&quot;Authorization denied for proxied request on CA: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2176">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2179">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2180">                    log.debug(&quot;CA for proxied request on CA could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L2182">                        caDoesntExistsException = e;</span>
                    }
                    // Just try next implementation.
<span class="nc" id="L2185">                } catch (EjbcaException e) {</span>
<span class="nc" id="L2186">                    log.debug(&quot;Server side exception for proxied request on CA thrown: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2187" title="All 2 branches missed.">                    if (ejbcaException == null) {</span>
<span class="nc" id="L2188">                        ejbcaException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2191">                }</span>
            }
        }
<span class="nc bnc" id="L2194" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2195">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2197" title="All 2 branches missed.">        if (ejbcaException != null) {</span>
<span class="nc" id="L2198">            throw ejbcaException;</span>
        }
<span class="nc bnc" id="L2200" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2201">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2203">        return result;</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; getCertificatesByExpirationTime(final AuthenticationToken authenticationToken, final long days,
            final int maxNumberOfResults, final int offset) throws AuthorizationDeniedException {
<span class="nc" id="L2209">        final Map&lt;String, CertificateWrapper&gt; result = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L2210">        final List&lt;CertificateWrapper&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2211">        int resultCount = 0;</span>
<span class="nc" id="L2212">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2213">        boolean oneSucceeded = false;</span>
<span class="nc bnc" id="L2214" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2215" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2217">                    resultCount += raMasterApi.getCountOfCertificatesByExpirationTime(authenticationToken, days);</span>
<span class="nc bnc" id="L2218" title="All 4 branches missed.">                    if (resultCount &gt; offset &amp;&amp; result.size() &lt; maxNumberOfResults) {</span>
                        int nodeOffset;
<span class="nc bnc" id="L2220" title="All 2 branches missed.">                        if (result.size() &gt; 0) {</span>
<span class="nc" id="L2221">                            nodeOffset = 0;</span>
                        } else {
<span class="nc bnc" id="L2223" title="All 2 branches missed.">                            nodeOffset = offset &gt; resultCount ? (offset - resultCount) : offset;</span>
                        }
<span class="nc" id="L2225">                        final Collection&lt;CertificateWrapper&gt; certificates = raMasterApi.getCertificatesByExpirationTime(authenticationToken, days, (maxNumberOfResults - result.size()), nodeOffset);</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">                        for (CertificateWrapper certificate : certificates) {</span>
<span class="nc bnc" id="L2227" title="All 2 branches missed.">                            if (result.size() &lt; maxNumberOfResults) {</span>
<span class="nc" id="L2228">                                result.put(CertTools.getFingerprintAsString(certificate.getCertificate()), certificate);</span>
                            }
<span class="nc" id="L2230">                        }</span>
                    }
<span class="nc" id="L2232">                    oneSucceeded = true;</span>
<span class="nc" id="L2233">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2234">                    log.debug(&quot;Authorization was denied in getCertificatesByExpirationTime&quot;, e);</span>
<span class="nc" id="L2235">                    authorizationDeniedException = e;</span>
<span class="nc" id="L2236">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2238">                }</span>
            }
        }
<span class="nc bnc" id="L2241" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L2242">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L2244">        ret.addAll(result.values());</span>
<span class="nc" id="L2245">        return ret;</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; getCertificatesByExpirationTimeAndType(AuthenticationToken authenticationToken, long days, int certificateType, int maxNumberOfResults)
            throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L2251">        final Map&lt;String, CertificateWrapper&gt; result = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L2252">        final List&lt;CertificateWrapper&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2253">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2254">        boolean oneSucceeded = false;</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2256" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2258">                    final Collection&lt;CertificateWrapper&gt; certificates = raMasterApi.getCertificatesByExpirationTimeAndType(authenticationToken, days, certificateType, maxNumberOfResults);</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">                    for (CertificateWrapper certificate : certificates) {</span>
<span class="nc" id="L2260">                        result.put(CertTools.getFingerprintAsString(certificate.getCertificate()), certificate);</span>
<span class="nc" id="L2261">                    }</span>
<span class="nc" id="L2262">                    oneSucceeded = true;</span>
<span class="nc" id="L2263">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2264">                    log.debug(&quot;Authorization was denied in getCertificatesByExpirationTime&quot;, e);</span>
<span class="nc" id="L2265">                    authorizationDeniedException = e;</span>
<span class="nc" id="L2266">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2268">                }</span>
            }
        }
<span class="nc bnc" id="L2271" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L2272">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L2274">        ret.addAll(result.values());</span>
<span class="nc" id="L2275">        return ret;</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; getCertificatesByExpirationTimeAndIssuer(AuthenticationToken authenticationToken, long days, String issuerDN, int maxNumberOfResults)
            throws AuthorizationDeniedException, EjbcaException {
<span class="nc" id="L2281">        final Map&lt;String, CertificateWrapper&gt; result = new TreeMap&lt;&gt;();</span>
<span class="nc" id="L2282">        final List&lt;CertificateWrapper&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2283">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2284">        boolean oneSucceeded = false;</span>
<span class="nc bnc" id="L2285" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2286" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2288">                    final Collection&lt;CertificateWrapper&gt; certificates = raMasterApi.getCertificatesByExpirationTimeAndIssuer(authenticationToken, days, issuerDN, maxNumberOfResults);</span>
<span class="nc bnc" id="L2289" title="All 2 branches missed.">                    for (CertificateWrapper certificate : certificates) {</span>
<span class="nc" id="L2290">                        result.put(CertTools.getFingerprintAsString(certificate.getCertificate()), certificate);</span>
<span class="nc" id="L2291">                    }</span>
<span class="nc" id="L2292">                    oneSucceeded = true;</span>
<span class="nc" id="L2293">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2294">                    log.debug(&quot;Authorization was denied in getCertificatesByExpirationTime&quot;, e);</span>
<span class="nc" id="L2295">                    authorizationDeniedException = e;</span>
<span class="nc" id="L2296">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2298">                }</span>
            }
        }
<span class="nc bnc" id="L2301" title="All 4 branches missed.">        if (!oneSucceeded &amp;&amp; authorizationDeniedException != null) {</span>
<span class="nc" id="L2302">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L2304">        ret.addAll(result.values());</span>
<span class="nc" id="L2305">        return ret;</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; getLastCaChain(final AuthenticationToken authenticationToken, final String caName)
            throws AuthorizationDeniedException, CADoesntExistsException {
<span class="nc" id="L2311">        final List&lt;CertificateWrapper&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2312">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2313">        CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc bnc" id="L2314" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
            // Try locally since on RA local CAs are visible only for superadmin role (may be a bug!).
<span class="nc bnc" id="L2316" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2318">                    return raMasterApi.getLastCaChain(authenticationToken, caName);</span>
<span class="nc" id="L2319">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L2320" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2321">                        log.debug(&quot;Authorization was denied to access CA with name &quot; + caName + &quot;: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2323" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2324">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2327">                } catch (CADoesntExistsException e) {</span>
<span class="nc bnc" id="L2328" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2329">                        log.debug(&quot;CA with name &quot; + caName + &quot; for proxied request on CA could not be found: &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2331" title="All 2 branches missed.">                    if (caDoesntExistException == null) {</span>
<span class="nc" id="L2332">                        caDoesntExistException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2335">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2337">                }</span>
            }
        }
<span class="nc bnc" id="L2340" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2341">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2343" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L2344">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L2346">        return result;</span>
    }

    @Override
    public byte[] processCertificateRequest(final AuthenticationToken authenticationToken, final String username, final String password, final String req, final int reqType,
            final String hardTokenSN, final String responseType) throws AuthorizationDeniedException, EjbcaException, CesecoreException,
            CADoesntExistsException, CertificateExtensionException, InvalidKeyException, SignatureException, InvalidKeySpecException,
            NoSuchAlgorithmException, NoSuchProviderException, CertificateException, IOException, ParseException, ConstructionException,
            NoSuchFieldException, AuthStatusException, AuthLoginException {
<span class="nc" id="L2355">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2356">        NotFoundException notFoundException = null;</span>
<span class="nc" id="L2357">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2358" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2359" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2361">                    return raMasterApi.processCertificateRequest(authenticationToken, username, password, req, reqType, hardTokenSN, responseType);</span>
<span class="nc" id="L2362">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2364">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2365">                    log.info(&quot;Authorization was denied to process certificate request for proxied request: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2366" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2367">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2370">                } catch (NotFoundException e) {</span>
<span class="nc" id="L2371">                    log.info(&quot;User with name '&quot; + username + &quot;' for proxied request could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2372" title="All 2 branches missed.">                    if (notFoundException == null) {</span>
<span class="nc" id="L2373">                        notFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2376">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2377">                    log.info(&quot;CA for proxied request could not be found:&quot; + e.getMessage());</span>
<span class="nc bnc" id="L2378" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L2379">                        caDoesntExistsException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2382">                } catch(ParseException | ConstructionException | NoSuchFieldException e) {</span>
<span class="nc" id="L2383">                	log.info(&quot;CV certificate request for proxied request could not processed:&quot; + e.getMessage());</span>
<span class="nc" id="L2384">                    throw new EjbcaException(ErrorCode.INTERNAL_ERROR, e.getMessage());</span>
<span class="nc" id="L2385">                }</span>
            }
        }
<span class="nc bnc" id="L2388" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2389">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2391" title="All 2 branches missed.">        if (notFoundException != null) {</span>
<span class="nc" id="L2392">            throw notFoundException;</span>
        }
<span class="nc bnc" id="L2394" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2395">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2397">        return null;</span>
    }

    @Override
    public byte[] getLatestCrl(final AuthenticationToken authenticationToken, final String caName, final boolean deltaCRL)
            throws AuthorizationDeniedException, CADoesntExistsException {
<span class="nc" id="L2403">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc" id="L2404">        byte[] result = null;</span>
<span class="nc bnc" id="L2405" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2406" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
                    // If there is a CA, there should be an initial CRL as well, assuming its not about an external CA.
<span class="nc" id="L2409">                    result = raMasterApi.getLatestCrl(authenticationToken, caName, deltaCRL);</span>
<span class="nc bnc" id="L2410" title="All 2 branches missed.">                    if (result != null) {</span>
<span class="nc" id="L2411">                        return result;</span>
                    }
<span class="nc" id="L2413">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2415">                } catch (CADoesntExistsException e) {</span>
<span class="nc bnc" id="L2416" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2417">                        log.debug(&quot;CA with name &quot; + caName + &quot; for proxied request on CA could not be found. &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2419" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L2420">                        caDoesntExistsException = e;</span>
                    }
<span class="nc" id="L2422">                }</span>
            }
        }
<span class="nc bnc" id="L2425" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2426">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2428">        return null;</span>
    }

    @Override
    public byte[] getLatestCrlByIssuerDn(AuthenticationToken authenticationToken, String issuerDn, boolean deltaCRL) throws AuthorizationDeniedException, EjbcaException, CADoesntExistsException {
<span class="nc" id="L2433">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2434" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L2435" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2437">                    return raMasterApi.getLatestCrlByIssuerDn(authenticationToken, issuerDn, deltaCRL);</span>
<span class="nc" id="L2438">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2439">                    caDoesntExistsException = e;</span>
<span class="nc" id="L2440">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2442">                }</span>
            }
        }
<span class="nc bnc" id="L2445" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2446">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2448">        return null;</span>
    }

    @Override
    public Integer getRemainingNumberOfApprovals(final AuthenticationToken authenticationToken, final int requestId)
            throws AuthorizationDeniedException, ApprovalException, ApprovalRequestExpiredException {
<span class="nc" id="L2454">        ApprovalException approvalException = null;</span>
<span class="nc" id="L2455">        ApprovalRequestExpiredException approvalRequestExpiredException = null;</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2457" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2459">                    return raMasterApi.getRemainingNumberOfApprovals(authenticationToken, requestId);</span>
<span class="nc" id="L2460">                } catch (ApprovalException e) {</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">                    if (approvalException == null) {</span>
<span class="nc" id="L2462">                        approvalException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2465">                } catch (ApprovalRequestExpiredException e) {</span>
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                    if (approvalRequestExpiredException == null) {</span>
<span class="nc" id="L2467">                        approvalRequestExpiredException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2470">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2472">                }</span>
            }
        }
<span class="nc bnc" id="L2475" title="All 2 branches missed.">        if (approvalException != null) {</span>
<span class="nc" id="L2476">            throw approvalException;</span>
        }
<span class="nc bnc" id="L2478" title="All 2 branches missed.">        if (approvalRequestExpiredException != null) {</span>
<span class="nc" id="L2479">            throw approvalRequestExpiredException;</span>
        }
<span class="nc" id="L2481">        return null;</span>
    }

    @Override
    public Integer isApproved(final AuthenticationToken authenticationToken, final int approvalId)
            throws AuthorizationDeniedException, ApprovalException, ApprovalRequestExpiredException {
<span class="nc" id="L2487">        ApprovalException approvalException = null;</span>
<span class="nc" id="L2488">        ApprovalRequestExpiredException approvalRequestExpiredException = null;</span>
<span class="nc bnc" id="L2489" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2490" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2492">                    return raMasterApi.isApproved(authenticationToken, approvalId);</span>
<span class="nc" id="L2493">                } catch (ApprovalException e) {</span>
<span class="nc bnc" id="L2494" title="All 2 branches missed.">                    if (approvalException == null) {</span>
<span class="nc" id="L2495">                        approvalException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2498">                } catch (ApprovalRequestExpiredException e) {</span>
<span class="nc bnc" id="L2499" title="All 2 branches missed.">                    if (approvalRequestExpiredException == null) {</span>
<span class="nc" id="L2500">                        approvalRequestExpiredException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2503">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2505">                }</span>
            }
        }
<span class="nc bnc" id="L2508" title="All 2 branches missed.">        if (approvalException != null) {</span>
<span class="nc" id="L2509">            throw approvalException;</span>
        }
<span class="nc bnc" id="L2511" title="All 2 branches missed.">        if (approvalRequestExpiredException != null) {</span>
<span class="nc" id="L2512">            throw approvalRequestExpiredException;</span>
        }
<span class="nc" id="L2514">        return null;</span>
    }

    @Override
    public boolean isAuthorized(final AuthenticationToken authenticationToken, final String... resource) {
<span class="nc bnc" id="L2519" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2520" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2522">                    return raMasterApi.isAuthorized(authenticationToken, resource);</span>
<span class="nc" id="L2523">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2528">        return false; // If all requests have failed, authorization fails as well.</span>
    }

    @Override
    public void republishCertificate(AuthenticationToken authenticationToken, String serialNumberInHex, String issuerDN)
            throws AuthorizationDeniedException, CADoesntExistsException, PublisherException, EjbcaException {
<span class="nc" id="L2534">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2535" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2536" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2538">                    raMasterApi.republishCertificate(authenticationToken, serialNumberInHex, issuerDN);</span>
<span class="nc" id="L2539">                    break;</span>
<span class="nc" id="L2540">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2541">                    caDoesntExistsException = e;</span>
<span class="nc" id="L2542">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2544">                }</span>
            }
        }
<span class="nc bnc" id="L2547" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2548">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2550">    }</span>

    @Override
    public byte[] generateOrKeyRecoverToken(final AuthenticationToken authenticationToken, final String username, final String password, final String hardTokenSN, final String keySpecification,
            final String keyAlgorithm) throws AuthorizationDeniedException, CADoesntExistsException, NotFoundException, EjbcaException {
<span class="nc" id="L2555">    	AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2556">    	CADoesntExistsException caDoesntExistException = null;</span>
<span class="nc" id="L2557">    	NotFoundException notFoundException = null;</span>
<span class="nc bnc" id="L2558" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2559" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2561">                    return raMasterApi.generateOrKeyRecoverToken(authenticationToken, username, password, hardTokenSN, keySpecification, keyAlgorithm);</span>
<span class="nc" id="L2562">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2564">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2565">                    log.info(&quot;Authorization was denied to access CA for proxied request: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2566" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2567">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2570">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2571">                    log.debug(&quot;CA for proxied request could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">                    if (caDoesntExistException == null) {</span>
<span class="nc" id="L2573">                    	caDoesntExistException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2576">                } catch (NotFoundException e) {</span>
<span class="nc" id="L2577">                    log.debug(&quot;End entity with name &quot; + username + &quot; for proxied request could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2578" title="All 2 branches missed.">                    if (notFoundException == null) {</span>
<span class="nc" id="L2579">                    	notFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2582">                }</span>
            }
        }
<span class="nc bnc" id="L2585" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2586">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2588" title="All 2 branches missed.">        if (notFoundException != null) {</span>
<span class="nc" id="L2589">            throw notFoundException;</span>
        }
<span class="nc bnc" id="L2591" title="All 2 branches missed.">        if (caDoesntExistException != null) {</span>
<span class="nc" id="L2592">            throw caDoesntExistException;</span>
        }
<span class="nc" id="L2594">        return null;</span>
    }

    @Override
    public byte[] getEndEntityProfileAsXml(final AuthenticationToken authenticationToken, final int profileId)
            throws AuthorizationDeniedException, EndEntityProfileNotFoundException{
<span class="nc" id="L2600">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2601">        EndEntityProfileNotFoundException endEntityProfileNotFoundException = null;</span>
<span class="nc bnc" id="L2602" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2603" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2605">                    return raMasterApi.getEndEntityProfileAsXml(authenticationToken, profileId);</span>
<span class="nc" id="L2606">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2608">                } catch (AuthorizationDeniedException  e) {</span>
<span class="nc bnc" id="L2609" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2610">                        log.debug(&quot;Authorization was denied to access the End Entity Profile with ID &quot; + profileId + &quot; for proxied request on CA. &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2612" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2613">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2616">                }  catch (EndEntityProfileNotFoundException  e) {</span>
<span class="nc bnc" id="L2617" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2618">                        log.debug(&quot;End Entity Profile with ID &quot; + profileId +  &quot; could not be found for proxied request on CA. &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2620" title="All 2 branches missed.">                    if (endEntityProfileNotFoundException == null) {</span>
<span class="nc" id="L2621">                        endEntityProfileNotFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2624">                }</span>
            }
        }
<span class="nc bnc" id="L2627" title="All 2 branches missed.">        if (endEntityProfileNotFoundException != null) {</span>
<span class="nc" id="L2628">            throw endEntityProfileNotFoundException;</span>
        }
<span class="nc bnc" id="L2630" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2631">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L2633">        return null;</span>
    }

    @Override
    public byte[] getCertificateProfileAsXml(final AuthenticationToken authenticationToken, final int profileId)
            throws AuthorizationDeniedException, CertificateProfileDoesNotExistException{
<span class="nc" id="L2639">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2640">        CertificateProfileDoesNotExistException certificateProfileNotFoundException = null;</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2642" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2644">                    return raMasterApi.getCertificateProfileAsXml(authenticationToken, profileId);</span>
<span class="nc" id="L2645">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2647">                } catch (AuthorizationDeniedException  e) {</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2649">                        log.debug(&quot;Authorization was denied to access the End Entity Profile with ID &quot; + profileId + &quot; for proxied request on CA. &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2651" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2652">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2655">                }  catch (CertificateProfileDoesNotExistException  e) {</span>
<span class="nc bnc" id="L2656" title="All 2 branches missed.">                    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L2657">                        log.debug(&quot;End Entity Profile with ID &quot; + profileId +  &quot; could not be found for proxied request on CA. &quot; + e.getMessage());</span>
                    }
<span class="nc bnc" id="L2659" title="All 2 branches missed.">                    if (certificateProfileNotFoundException == null) {</span>
<span class="nc" id="L2660">                        certificateProfileNotFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2663">                }</span>
            }
        }
<span class="nc bnc" id="L2666" title="All 2 branches missed.">        if (certificateProfileNotFoundException != null) {</span>
<span class="nc" id="L2667">            throw certificateProfileNotFoundException;</span>
        }
<span class="nc bnc" id="L2669" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2670">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L2672">        return null;</span>
    }

    @Override
    public Collection&lt;CertificateWrapper&gt; processCardVerifiableCertificateRequest(final AuthenticationToken authenticationToken, final String username, final String password, final String cvcreq)
            throws AuthorizationDeniedException, CADoesntExistsException, UserDoesntFullfillEndEntityProfile, NotFoundException,
            ApprovalException, EjbcaException, WaitingForApprovalException, SignRequestException, CertificateExpiredException, CesecoreException {
<span class="nc" id="L2679">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc" id="L2680">        NotFoundException notFoundException = null;</span>
<span class="nc" id="L2681">        CADoesntExistsException caDoesntExistsException = null;</span>
<span class="nc bnc" id="L2682" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2683" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2685">                    return raMasterApi.processCardVerifiableCertificateRequest(authenticationToken, username, password, cvcreq);</span>
<span class="nc" id="L2686">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2688">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc" id="L2689">                    log.info(&quot;Authorization was denied to process certificate request for proxied request: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2690" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L2691">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2694">                } catch (NotFoundException e) {</span>
<span class="nc" id="L2695">                    log.info(&quot;User with name &quot; + username + &quot; for proxied request could not be found: &quot; + e.getMessage());</span>
<span class="nc bnc" id="L2696" title="All 2 branches missed.">                    if (notFoundException == null) {</span>
<span class="nc" id="L2697">                        notFoundException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2700">                } catch (CADoesntExistsException e) {</span>
<span class="nc" id="L2701">                    log.info(&quot;CA for for poxied request cold not be found:&quot; + e.getMessage());</span>
<span class="nc bnc" id="L2702" title="All 2 branches missed.">                    if (caDoesntExistsException == null) {</span>
<span class="nc" id="L2703">                        caDoesntExistsException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L2706">                }</span>
            }
        }
<span class="nc bnc" id="L2709" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L2710">            throw authorizationDeniedException;</span>
        }
<span class="nc bnc" id="L2712" title="All 2 branches missed.">        if (notFoundException != null) {</span>
<span class="nc" id="L2713">            throw notFoundException;</span>
        }
<span class="nc bnc" id="L2715" title="All 2 branches missed.">        if (caDoesntExistsException != null) {</span>
<span class="nc" id="L2716">            throw caDoesntExistsException;</span>
        }
<span class="nc" id="L2718">        return null;</span>
    }

    @Override
    public AcmeAccount getAcmeAccountById(String accountId) {
<span class="nc bnc" id="L2723" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2724" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2726">                    return raMasterApi.getAcmeAccountById(accountId);</span>
<span class="nc" id="L2727">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2732">        return null;</span>
    }

    @Override
    public AcmeAccount getAcmeAccountByPublicKeyStorageId(final String publicKeyStorageId) {
<span class="nc bnc" id="L2737" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2738" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2740">                    return raMasterApi.getAcmeAccountByPublicKeyStorageId(publicKeyStorageId);</span>
<span class="nc" id="L2741">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2746">        return null;</span>
    }

    @Override
    public String persistAcmeAccount(final AcmeAccount acmeAccount) {
<span class="nc bnc" id="L2751" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2752" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2754">                    return raMasterApi.persistAcmeAccount(acmeAccount);</span>
<span class="nc" id="L2755">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2760">        return null;</span>
    }
    
    @Override
    public AcmeOrder getAcmeOrderById(String orderId) {
<span class="nc bnc" id="L2765" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2766" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2768">                    return raMasterApi.getAcmeOrderById(orderId);</span>
<span class="nc" id="L2769">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2774">        return null;</span>
    }

    @Override
    public AcmeAuthorization getAcmeAuthorizationById(String authorizationId) {
<span class="nc bnc" id="L2779" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2780" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2782">                    return raMasterApi.getAcmeAuthorizationById(authorizationId);</span>
<span class="nc" id="L2783">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2788">        return null;</span>
    }

    @Override
    public List&lt;AcmeAuthorization&gt; getAcmeAuthorizationsByOrderId(String orderId) {
<span class="nc bnc" id="L2793" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2794" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2796">                    return raMasterApi.getAcmeAuthorizationsByOrderId(orderId);</span>
<span class="nc" id="L2797">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2802">        return null;</span>
    }

    @Override
    public List&lt;AcmeAuthorization&gt; getAcmeAuthorizationsByAccountId(String accountId) {
<span class="nc bnc" id="L2807" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2808" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2810">                    return raMasterApi.getAcmeAuthorizationsByAccountId(accountId);</span>
<span class="nc" id="L2811">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2816">        return null;</span>
    }

    @Override
    public Set&lt;AcmeOrder&gt; getAcmeOrdersByAccountId(final String accountId) {
<span class="nc bnc" id="L2821" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2822" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2824">                    return raMasterApi.getAcmeOrdersByAccountId(accountId);</span>
<span class="nc" id="L2825">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2830">        return null;</span>
    }
    
    @Override
    public Set&lt;AcmeOrder&gt; getFinalizedAcmeOrdersByFingerprint(final String fingerprint) {
<span class="nc bnc" id="L2835" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2836" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2838">                    return raMasterApi.getFinalizedAcmeOrdersByFingerprint(fingerprint);</span>
<span class="nc" id="L2839">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2844">        return null;</span>
    }    
    
    @Override
    public String persistAcmeOrder(final AcmeOrder acmeOrder) {
<span class="nc bnc" id="L2849" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2850" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2852">                    return raMasterApi.persistAcmeOrder(acmeOrder);</span>
<span class="nc" id="L2853">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2858">        return null;</span>
    }

    @Override
    public List&lt;String&gt; persistAcmeOrders(final List&lt;AcmeOrder&gt; acmeOrders) {
<span class="nc bnc" id="L2863" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2864" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2866">                    return raMasterApi.persistAcmeOrders(acmeOrders);</span>
<span class="nc" id="L2867">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2872">        return null;</span>
    }
    
    @Override
    public void removeAcmeOrder(final String orderId) {
<span class="nc bnc" id="L2877" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2878" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2880">                    raMasterApi.removeAcmeOrder(orderId);</span>
<span class="nc" id="L2881">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2883">                }</span>
            }
        }
<span class="nc" id="L2886">    }</span>
    
    @Override
    public void removeAcmeOrders(final List&lt;String&gt; orderIds) {
<span class="nc bnc" id="L2890" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2891" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2893">                    raMasterApi.removeAcmeOrders(orderIds);</span>
<span class="nc" id="L2894">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2896">                }</span>
            }
        }
<span class="nc" id="L2899">    }</span>
    
    @Override
    public String persistAcmeAuthorization(AcmeAuthorization acmeAuthorization) {
<span class="nc bnc" id="L2903" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2904" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2906">                    return raMasterApi.persistAcmeAuthorization(acmeAuthorization);</span>
<span class="nc" id="L2907">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2912">        return null;</span>
    }

    @Override
    public void persistAcmeAuthorizationList(List&lt;AcmeAuthorization&gt; acmeAuthorizations) {
<span class="nc bnc" id="L2917" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2918" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2920">                    raMasterApi.persistAcmeAuthorizationList(acmeAuthorizations);</span>
<span class="nc" id="L2921">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2923">                }</span>
            }
        }
<span class="nc" id="L2926">    }</span>

    @Override
    public AcmeChallenge getAcmeChallengeById(String challengeId) {
<span class="nc bnc" id="L2930" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2931" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2933">                    return raMasterApi.getAcmeChallengeById(challengeId);</span>
<span class="nc" id="L2934">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2939">        return null;</span>
    }

    @Override
    public List&lt;AcmeChallenge&gt; getAcmeChallengesByAuthorizationId(String authorizationId) {
<span class="nc bnc" id="L2944" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2945" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2947">                    return raMasterApi.getAcmeChallengesByAuthorizationId(authorizationId);</span>
<span class="nc" id="L2948">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2953">        return null;</span>
    }

    @Override
    public String persistAcmeChallenge(AcmeChallenge acmeChallenge) {
<span class="nc bnc" id="L2958" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2959" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2961">                    return raMasterApi.persistAcmeChallenge(acmeChallenge);</span>
<span class="nc" id="L2962">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
                }
            }
        }
<span class="nc" id="L2967">        return null;</span>
    }

    @Override
    public void persistAcmeChallengeList(List&lt;AcmeChallenge&gt; acmeChallenges) {
<span class="nc bnc" id="L2972" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApisLocalFirst) {</span>
<span class="nc bnc" id="L2973" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 5) {</span>
                try {
<span class="nc" id="L2975">                    raMasterApi.persistAcmeChallengeList(acmeChallenges);</span>
<span class="nc" id="L2976">                }  catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L2978">                }</span>
            }
        }
<span class="nc" id="L2981">    }</span>

    @Override
    public HashSet&lt;String&gt; getCaaIdentities(AuthenticationToken authenticationToken, int caId)
            throws AuthorizationDeniedException, CADoesntExistsException {
<span class="nc bnc" id="L2986" title="All 2 branches missed.">        for (RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L2987" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L2989">                    return raMasterApi.getCaaIdentities(authenticationToken, caId);</span>
<span class="nc" id="L2990">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                }
            }
        }
<span class="nc" id="L2994">        log.warn(&quot;All &quot; + raMasterApis.length + &quot; upstream peers are unavailable. Returning an empty set of CAA identities.&quot;);</span>
<span class="nc" id="L2995">        return new HashSet&lt;String&gt;();</span>
    }

    @Override
    public byte[] addUserAndGenerateKeyStore(AuthenticationToken authenticationToken, EndEntityInformation endEntity, boolean clearpwd) throws AuthorizationDeniedException, EjbcaException, WaitingForApprovalException {
<span class="nc" id="L3000">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L3001" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L3002" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L3004">                    return raMasterApi.addUserAndGenerateKeyStore(authenticationToken, endEntity, clearpwd);</span>
<span class="nc" id="L3005">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L3006" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L3007">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L3010">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L3012">                }</span>
            }
        }
<span class="nc bnc" id="L3015" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L3016">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L3018">        return null;</span>
    }

    @Override
    public byte[] addUserAndCreateCertificate(AuthenticationToken authenticationToken, EndEntityInformation endEntity, boolean clearpwd) throws AuthorizationDeniedException, EjbcaException, WaitingForApprovalException {
<span class="nc" id="L3023">        AuthorizationDeniedException authorizationDeniedException = null;</span>
<span class="nc bnc" id="L3024" title="All 2 branches missed.">        for (final RaMasterApi raMasterApi : raMasterApis) {</span>
<span class="nc bnc" id="L3025" title="All 4 branches missed.">            if (raMasterApi.isBackendAvailable() &amp;&amp; raMasterApi.getApiVersion() &gt;= 4) {</span>
                try {
<span class="nc" id="L3027">                    return raMasterApi.addUserAndCreateCertificate(authenticationToken, endEntity, clearpwd);</span>
<span class="nc" id="L3028">                } catch (AuthorizationDeniedException e) {</span>
<span class="nc bnc" id="L3029" title="All 2 branches missed.">                    if (authorizationDeniedException == null) {</span>
<span class="nc" id="L3030">                        authorizationDeniedException = e;</span>
                    }
                    // Just try next implementation
<span class="nc" id="L3033">                } catch (UnsupportedOperationException | RaMasterBackendUnavailableException e) {</span>
                    // Just try next implementation
<span class="nc" id="L3035">                }</span>
            }
        }
<span class="nc bnc" id="L3038" title="All 2 branches missed.">        if (authorizationDeniedException != null) {</span>
<span class="nc" id="L3039">            throw authorizationDeniedException;</span>
        }
<span class="nc" id="L3041">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>