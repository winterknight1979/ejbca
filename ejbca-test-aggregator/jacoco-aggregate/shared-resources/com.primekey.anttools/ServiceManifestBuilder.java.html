<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServiceManifestBuilder.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">shared-resources</a> &gt; <a href="index.source.html" class="el_package">com.primekey.anttools</a> &gt; <span class="el_source">ServiceManifestBuilder.java</span></div><h1>ServiceManifestBuilder.java</h1><pre class="source lang-java linenums">//
// Decompiled by Procyon v0.5.36
//

package com.primekey.anttools;

import java.util.ArrayList;
import java.util.List;
import java.io.PrintWriter;
import java.lang.reflect.Modifier;
import java.io.IOException;
import java.io.File;

public final class ServiceManifestBuilder {

    private ServiceManifestBuilder() {
    }

    /**
     * Entry point.
     *
     * @param args arguments
     */

    public static void main(final String[] args) {
<span class="nc" id="L26">        final int errorCode = mainInternal(args);</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">        if (errorCode != 0) {</span>
<span class="nc" id="L28">            System.exit(errorCode);</span>
        }
<span class="nc" id="L30">    }</span>

    static int mainInternal(final String[] args) {
<span class="nc bnc" id="L33" title="All 4 branches missed.">        if (args.length &lt; 2 || args.length &gt; 3) {</span>
<span class="nc" id="L34">            final StringBuffer out = new StringBuffer();</span>
<span class="nc" id="L35">            out.append(&quot;DESCRIPTION:\n&quot;);</span>
<span class="nc" id="L36">            out.append(&quot;     This command line tool inserts service manifest &quot;</span>
                + &quot;files into a given directory.\n&quot;);
<span class="nc" id="L38">            out.append(&quot;     It uses the following two arguments &quot;</span>
                + &quot;(without flags):\n&quot;);
<span class="nc" id="L40">            out.append(&quot;     (1) Path to a directory\n&quot;);</span>
<span class="nc" id="L41">            out.append(&quot;     (2) A semicolon separated list of interfaces\n&quot;);</span>
<span class="nc" id="L42">            out.append(&quot;     (3) (OPTIONAL) Temporary working directory, only &quot;</span>
                + &quot;applicable (but not required) when writing to jar. &quot;
                + &quot;Will use system default if left blank.\n&quot;);
<span class="nc" id="L45">            out.append(&quot;\n&quot;);</span>
<span class="nc" id="L46">            out.append(&quot;EXAMPLES:\n&quot;);</span>
<span class="nc" id="L47">            out.append(&quot;     /usr/ejbca/modules/ejbca-ejb-cli/build/ &quot;</span>
                    + &quot;com.foo.bar.InterfaceAlpha;com.bar.foo.InterfaceBeta &quot;
                    + &quot;/var/tmp/ \n&quot;);
<span class="nc" id="L50">            out.append(&quot;\n&quot;);</span>
<span class="nc" id="L51">            out.append(&quot;WARNING: Adding a service manifest to a JAR with a &quot;</span>
                + &quot;file manifest is unstable at the moment.&quot;);
<span class="nc" id="L53">            System.err.println(out.toString());</span>
<span class="nc" id="L54">            return 1;</span>
        }
<span class="nc" id="L56">        final File archive = new File(args[0]);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (!archive.exists()) {</span>
<span class="nc" id="L58">            System.err.println(archive + &quot; does not exist on the system.&quot;);</span>
<span class="nc" id="L59">            return 1;</span>
        }
<span class="nc bnc" id="L61" title="All 4 branches missed.">        if (archive.isFile() &amp;&amp; !archive.getName().endsWith(&quot;.jar&quot;)) {</span>
<span class="nc" id="L62">            System.err.println(archive + &quot; does not appear to be a .jar file.&quot;);</span>
<span class="nc" id="L63">            return 1;</span>
        }
        /*
         * We shouldn't need to hack the classpath because Maven automatically
         * adds the
         * output directory
         */
<span class="nc" id="L70">        final String[] classNames = args[1].split(&quot;;&quot;);</span>
<span class="nc" id="L71">        final Class&lt;?&gt;[] classes = new Class[classNames.length];</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        for (int i = 0; i &lt; classNames.length; ++i) {</span>
            try {
<span class="nc" id="L74">                classes[i] = Class.forName(classNames[i]);</span>
<span class="nc" id="L75">            } catch (ClassNotFoundException e2) {</span>
<span class="nc" id="L76">                System.err.println(&quot;Class &quot; + classNames[i]</span>
                    + &quot; not found on classpath, cannot continue.&quot;);
<span class="nc" id="L78">                return 1;</span>
<span class="nc" id="L79">            }</span>
        }
        try {
<span class="nc" id="L82">            buildServiceManifestToLocation(archive, classes);</span>
<span class="nc" id="L83">        } catch (IOException e) {</span>
<span class="nc" id="L84">            System.err.println(&quot;Disk related error occured while building &quot;</span>
                + &quot;manifest, see following stacktrace&quot;);
<span class="nc" id="L86">            e.printStackTrace();</span>
<span class="nc" id="L87">            return 1;</span>
<span class="nc" id="L88">        }</span>
<span class="nc" id="L89">        return 0;</span>
    }

    /**
     * Delete the file.
     * @param file File
     */
    public static void delete(final File file) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (file.isDirectory()) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            for (final File subFile : file.listFiles()) {</span>
<span class="nc" id="L99">                delete(subFile);</span>
            }
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!file.delete()) {</span>
<span class="nc" id="L103">            System.err.println(&quot;Could not delete directory &quot;</span>
<span class="nc" id="L104">                + file.getAbsolutePath());</span>
        }
<span class="nc" id="L106">    }</span>

    /**
     * Create a temporary directory.
     * @return Path to temp directory
     * @throws IOException If creation fails
     */
    public static File createTempDirectory() throws IOException {
<span class="nc" id="L114">        return createTempDirectory(null);</span>
    }

    /**
     * Create temp directory in specified location.
     * @param location Location
     * @return Path
     * @throws IOException If creation fails
     */
    public static File createTempDirectory(final File location)
        throws IOException {
<span class="nc" id="L125">        final File temp = File.createTempFile(&quot;tmp&quot;,</span>
<span class="nc" id="L126">            Long.toString(System.nanoTime()), location);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (!temp.delete()) {</span>
<span class="nc" id="L128">            throw new IOException(&quot;Could not delete temp file: &quot;</span>
<span class="nc" id="L129">                + temp.getAbsolutePath());</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (!temp.mkdir()) {</span>
<span class="nc" id="L132">            throw new IOException(&quot;Could not create temp directory: &quot;</span>
<span class="nc" id="L133">                + temp.getAbsolutePath());</span>
        }
<span class="nc" id="L135">        return temp;</span>
    }

    /**
     * Build the service manifest.
     * @param location Output file
     * @param interfaceClasses Classes to document
     * @throws IOException On fail
     */
    public static void buildServiceManifestToLocation(final File location,
        final Class&lt;?&gt;... interfaceClasses)
            throws IOException {
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!location.isDirectory()) {</span>
<span class="nc" id="L148">            throw new IOException(&quot;File &quot; + location + &quot; was not a directory.&quot;);</span>
        }
<span class="nc bnc" id="L150" title="All 4 branches missed.">        if (!location.canWrite() &amp;&amp; !location.canRead()) {</span>
<span class="nc" id="L151">            throw new IOException(&quot;Could not read/write to directory &quot;</span>
                + location);
        }
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (final Class&lt;?&gt; interfaceClass : interfaceClasses) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (!interfaceClass.isInterface()</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                    &amp;&amp; !Modifier.isAbstract(interfaceClass.getModifiers())) {</span>
<span class="nc" id="L157">                throw new IllegalArgumentException(</span>
<span class="nc" id="L158">                        &quot;Class &quot; + interfaceClass.getName()</span>
                            + &quot; was not an interface or an asbtract class.&quot;);
            }
<span class="nc" id="L161">            final List&lt;Class&lt;?&gt;&gt; implementingClasses</span>
<span class="nc" id="L162">                = getImplementingClasses(location, location, interfaceClass);</span>
<span class="nc" id="L163">            System.out</span>
<span class="nc" id="L164">                    .println(&quot;Added &quot; + implementingClasses.size()</span>
<span class="nc" id="L165">                        + &quot; implementations of &quot; + interfaceClass.getName());</span>
<span class="nc" id="L166">            final File metaInf = new File(location, &quot;META-INF&quot;);</span>
<span class="nc bnc" id="L167" title="All 4 branches missed.">            if (!metaInf.exists() &amp;&amp; !metaInf.mkdir()) {</span>
<span class="nc" id="L168">                throw new IOException(&quot;Could not create directory &quot; + metaInf);</span>
            }
<span class="nc" id="L170">            final File servicesDirectory = new File(metaInf, &quot;services&quot;);</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">            if (!servicesDirectory.exists() &amp;&amp; !servicesDirectory.mkdirs()) {</span>
<span class="nc" id="L172">                throw new IOException(&quot;Could not create directory &quot;</span>
                    + servicesDirectory);
            }
<span class="nc" id="L175">            final File manifestFile</span>
<span class="nc" id="L176">                = new File(servicesDirectory, interfaceClass.getName());</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">            if (!manifestFile.exists() &amp;&amp; !manifestFile.createNewFile()) {</span>
<span class="nc" id="L178">                throw new IOException(&quot;Could not create manifest file.&quot;);</span>
            }
<span class="nc" id="L180">            final PrintWriter printWriter = new PrintWriter(manifestFile);</span>
            try {
<span class="nc bnc" id="L182" title="All 2 branches missed.">                for (final Class&lt;?&gt; implementingClass : implementingClasses) {</span>
<span class="nc" id="L183">                    printWriter.println(implementingClass.getName());</span>
<span class="nc" id="L184">                }</span>
            } finally {
<span class="nc" id="L186">                printWriter.flush();</span>
<span class="nc" id="L187">                printWriter.close();</span>
            }
        }
<span class="nc" id="L190">    }</span>

    private static List&lt;Class&lt;?&gt;&gt; getImplementingClasses(
            final File baseLocation,
            final File location,
            final Class&lt;?&gt; interfaceClass) {
<span class="nc" id="L196">        final List&lt;Class&lt;?&gt;&gt; result = new ArrayList&lt;Class&lt;?&gt;&gt;();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (location.isDirectory()) {</span>
<span class="nc" id="L198">            final int baseLocationAbsolutePathLength</span>
<span class="nc" id="L199">                = baseLocation.getAbsolutePath().length()</span>
<span class="nc" id="L200">                    + File.separator.length();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            for (final File file : location.listFiles()) {</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                if (file.isDirectory()) {</span>
<span class="nc" id="L203">                    result.addAll(getImplementingClasses(</span>
                        baseLocation, file, interfaceClass));
                } else {
<span class="nc" id="L206">                    final String absolutePath = file.getAbsolutePath();</span>
<span class="nc" id="L207">                    final int indexOfExtension = absolutePath.indexOf(&quot;.class&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                    if (indexOfExtension != -1</span>
<span class="nc" id="L209">                        &amp;&amp; indexOfExtension == absolutePath.length()</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                            - &quot;.class&quot;.length()) {</span>
<span class="nc" id="L211">                        final String className = absolutePath</span>
<span class="nc" id="L212">                                .substring(baseLocationAbsolutePathLength,</span>
                                    indexOfExtension)
<span class="nc" id="L214">                                .replace(File.separatorChar, '.');</span>
                        try {
<span class="nc" id="L216">                            final Class&lt;?&gt; candidate = Class.forName(</span>
                                className,
                                false,
<span class="nc" id="L219">                                ServiceManifestBuilder.class.getClassLoader());</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                            if (interfaceClass.isAssignableFrom(candidate)</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                                    &amp;&amp; !Modifier.isAbstract(</span>
<span class="nc" id="L222">                                            candidate.getModifiers())</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                                    &amp;&amp; !candidate.isInterface()) {</span>
<span class="nc" id="L224">                                result.add(candidate);</span>
                            }
<span class="nc" id="L226">                        } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L227">                            throw new IllegalArgumentException(</span>
                                    &quot;Class of name &quot;
                                    + className
                                    + &quot; was not found, even though a class file&quot;
                                    + &quot; of that name was found in &quot;
<span class="nc" id="L232">                                    + baseLocation.getAbsolutePath(), e);</span>
<span class="nc" id="L233">                        }</span>
                    }
                }
            }
        }
<span class="nc" id="L238">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>