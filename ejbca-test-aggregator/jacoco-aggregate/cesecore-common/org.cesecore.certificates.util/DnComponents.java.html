<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DnComponents.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.util</a> &gt; <span class="el_source">DnComponents.java</span></div><h1>DnComponents.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  EJBCA Community: The OpenSource Certificate Authority                *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.cesecore.certificates.util;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Locale;
import java.util.Set;
import java.util.TreeSet;
import org.apache.commons.lang.ArrayUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.ASN1ObjectIdentifier;
import org.cesecore.util.CeSecoreNameStyle;

/**
 * Class holding information and utilities for handling different DN components,
 * CN, O etc
 *
 * &lt;p&gt;This is a very complex class with lots of maps and stuff. It is because it
 * is a first step of refactoring the DN/AltName/DirAttr handling. This
 * previously consisted of lots of different arrays spread out all over the
 * place, now it's gathered here in order to be able to get a view of it. The
 * underlying implementations have not changed much though, in order to still
 * have things working, therefore there are lots of different maps and arrays,
 * with seemingly similar contents.
 *
 * @version $Id: DnComponents.java 27374 2017-12-01 12:37:30Z anatom $
 */
public final class DnComponents {

    private DnComponents() { }

    /** Logger. */
<span class="fc" id="L51">  private static Logger log = Logger.getLogger(DnComponents.class);</span>

  /** This class should be instantiated immediately. */
<span class="fc" id="L54">  private static DnComponents obj = new DnComponents();</span>

  /**
   * BC X500Name contains some lookup tables that could maybe be used here.
   *
   * &lt;p&gt;This map is used in CertTools so sort and order DN strings so they all
   * look the same in the database.
   */
<span class="fc" id="L62">  private static HashMap&lt;String, ASN1ObjectIdentifier&gt; oids =</span>
      new HashMap&lt;String, ASN1ObjectIdentifier&gt;();
  // Default values
  static {
<span class="fc" id="L66">    oids.put(&quot;c&quot;, CeSecoreNameStyle.C);</span>
<span class="fc" id="L67">    oids.put(&quot;dc&quot;, CeSecoreNameStyle.DC);</span>
<span class="fc" id="L68">    oids.put(&quot;st&quot;, CeSecoreNameStyle.ST);</span>
<span class="fc" id="L69">    oids.put(&quot;l&quot;, CeSecoreNameStyle.L);</span>
<span class="fc" id="L70">    oids.put(&quot;o&quot;, CeSecoreNameStyle.O);</span>
<span class="fc" id="L71">    oids.put(&quot;ou&quot;, CeSecoreNameStyle.OU);</span>
<span class="fc" id="L72">    oids.put(&quot;t&quot;, CeSecoreNameStyle.T);</span>
<span class="fc" id="L73">    oids.put(&quot;surname&quot;, CeSecoreNameStyle.SURNAME);</span>
<span class="fc" id="L74">    oids.put(&quot;initials&quot;, CeSecoreNameStyle.INITIALS);</span>
<span class="fc" id="L75">    oids.put(&quot;givenname&quot;, CeSecoreNameStyle.GIVENNAME);</span>
<span class="fc" id="L76">    oids.put(&quot;gn&quot;, CeSecoreNameStyle.GIVENNAME);</span>
<span class="fc" id="L77">    oids.put(&quot;sn&quot;, CeSecoreNameStyle.SN);</span>
<span class="fc" id="L78">    oids.put(&quot;serialnumber&quot;, CeSecoreNameStyle.SERIALNUMBER);</span>
<span class="fc" id="L79">    oids.put(&quot;cn&quot;, CeSecoreNameStyle.CN);</span>
<span class="fc" id="L80">    oids.put(&quot;uid&quot;, CeSecoreNameStyle.UID);</span>
<span class="fc" id="L81">    oids.put(&quot;dn&quot;, CeSecoreNameStyle.DN_QUALIFIER);</span>
<span class="fc" id="L82">    oids.put(&quot;emailaddress&quot;, CeSecoreNameStyle.EmailAddress);</span>
<span class="fc" id="L83">    oids.put(&quot;e&quot;, CeSecoreNameStyle.EmailAddress);</span>
<span class="fc" id="L84">    oids.put(&quot;email&quot;, CeSecoreNameStyle.EmailAddress);</span>
<span class="fc" id="L85">    oids.put(</span>
        &quot;unstructuredname&quot;,
        CeSecoreNameStyle.UnstructuredName); // unstructuredName
<span class="fc" id="L88">    oids.put(</span>
        &quot;unstructuredaddress&quot;,
        CeSecoreNameStyle.UnstructuredAddress); // unstructuredAddress
<span class="fc" id="L91">    oids.put(&quot;postalcode&quot;, CeSecoreNameStyle.POSTAL_CODE);</span>
<span class="fc" id="L92">    oids.put(&quot;businesscategory&quot;, CeSecoreNameStyle.BUSINESS_CATEGORY);</span>
<span class="fc" id="L93">    oids.put(&quot;postaladdress&quot;, CeSecoreNameStyle.POSTAL_ADDRESS);</span>
<span class="fc" id="L94">    oids.put(&quot;telephonenumber&quot;, CeSecoreNameStyle.TELEPHONE_NUMBER);</span>
<span class="fc" id="L95">    oids.put(&quot;pseudonym&quot;, CeSecoreNameStyle.PSEUDONYM);</span>
<span class="fc" id="L96">    oids.put(&quot;street&quot;, CeSecoreNameStyle.STREET);</span>
<span class="fc" id="L97">    oids.put(&quot;name&quot;, CeSecoreNameStyle.NAME);</span>
<span class="fc" id="L98">    oids.put(&quot;description&quot;, CeSecoreNameStyle.DESCRIPTION);</span>
<span class="fc" id="L99">    oids.put(&quot;jurisdictionlocality&quot;, CeSecoreNameStyle.JURISDICTION_LOCALITY);</span>
<span class="fc" id="L100">    oids.put(&quot;jurisdictionstate&quot;, CeSecoreNameStyle.JURISDICTION_STATE);</span>
<span class="fc" id="L101">    oids.put(&quot;jurisdictioncountry&quot;, CeSecoreNameStyle.JURISDICTION_COUNTRY);</span>
<span class="fc" id="L102">    oids.put(</span>
        &quot;organizationidentifier&quot;, CeSecoreNameStyle.ORGANIZATION_IDENTIFIER);
  }
  /**
   * Default values used when constructing DN strings that are put in the
   * database.
   */
<span class="fc" id="L109">  private static String[] dNObjectsForward = {</span>
    &quot;description&quot;,
    &quot;jurisdictioncountry&quot;,
    &quot;jurisdictionstate&quot;,
    &quot;jurisdictionlocality&quot;,
    &quot;street&quot;,
    &quot;pseudonym&quot;,
    &quot;telephonenumber&quot;,
    &quot;postaladdress&quot;,
    &quot;businesscategory&quot;,
    &quot;postalcode&quot;,
    &quot;unstructuredaddress&quot;,
    &quot;unstructuredname&quot;,
    &quot;emailaddress&quot;,
    &quot;e&quot;,
    &quot;email&quot;,
    &quot;dn&quot;,
    &quot;uid&quot;,
    &quot;cn&quot;,
    &quot;name&quot;,
    &quot;sn&quot;,
    &quot;serialnumber&quot;,
    &quot;gn&quot;,
    &quot;givenname&quot;,
    &quot;initials&quot;,
    &quot;surname&quot;,
    &quot;t&quot;,
    &quot;ou&quot;,
    &quot;organizationidentifier&quot;,
    &quot;o&quot;,
    &quot;l&quot;,
    &quot;st&quot;,
    &quot;dc&quot;,
    &quot;c&quot;
  };
  /** Default values. */
<span class="fc" id="L145">  private static String[] dNObjectsReverse = null;</span>

  /*
   * These maps and constants are used in the admin-GUI and in End Entity
   * profiles
   */

  /*
   * These constants can be used when referring to standard,
   * build in components.
   */
  // DN components
  /** Email. */
  public static final String DNEMAILADDRESS = &quot;EMAILADDRESS&quot;;

  /** Qual.*/
  public static final String DNQUALIFIER = &quot;DNQUALIFIER&quot;;
  /** UID. */
  public static final String UID = &quot;UID&quot;;
  /** CN. */
  public static final String COMMONNAME = &quot;COMMONNAME&quot;;
  /** SN. */
  public static final String DNSERIALNUMBER = &quot;SERIALNUMBER&quot;;
  /** Given. */
  public static final String GIVENNAME = &quot;GIVENNAME&quot;;
  /** Given. */
  public static final String INITIALS = &quot;INITIALS&quot;;
  /** Surname. */
  public static final String SURNAME = &quot;SURNAME&quot;;
  /** Title. */
  public static final String TITLE = &quot;TITLE&quot;;
  /** Unit. */
  public static final String ORGANIZATIONALUNIT = &quot;ORGANIZATIONALUNIT&quot;;
  /** Org. */
  public static final String ORGANIZATION = &quot;ORGANIZATION&quot;;
  /** Locality. */
  public static final String LOCALITY = &quot;LOCALITY&quot;;
  /** State. */
  public static final String STATEORPROVINCE = &quot;STATEORPROVINCE&quot;;
  /** Domain. */
  public static final String DOMAINCOMPONENT = &quot;DOMAINCOMPONENT&quot;;
  /** Country. */
  public static final String COUNTRY = &quot;COUNTRY&quot;;
  /** Address. */
  public static final String UNSTRUCTUREDADDRESS = &quot;UNSTRUCTUREDADDRESS&quot;;
  /** Name. */
  public static final String UNSTRUCTUREDNAME = &quot;UNSTRUCTUREDNAME&quot;;
  /** Postcode. */
  public static final String POSTALCODE = &quot;POSTALCODE&quot;;
  /** Category. */
  public static final String BUSINESSCATEGORY = &quot;BUSINESSCATEGORY&quot;;
  /** Address. */
  public static final String POSTALADDRESS = &quot;POSTALADDRESS&quot;;
  /** Tel. */
  public static final String TELEPHONENUMBER = &quot;TELEPHONENUMBER&quot;;
  /** Pseud. */
  public static final String PSEUDONYM = &quot;PSEUDONYM&quot;;
  /** Address. */
  public static final String STREETADDRESS = &quot;STREETADDRESS&quot;;
  /** Name. */
  public static final String NAME = &quot;NAME&quot;;
  /** Desc. */
  public static final String DESCRIPTION = &quot;DESCRIPTION&quot;;
  /** Locality. */
  public static final String JURISDICTIONLOCALITY = &quot;JURISDICTIONLOCALITY&quot;;
  /** State. */
  public static final String JURISDICTIONSTATE = &quot;JURISDICTIONSTATE&quot;;
  /** Country. */
  public static final String JURISDICTIONCOUNTRY = &quot;JURISDICTIONCOUNTRY&quot;;
  /** Org. */
  public static final String ORGANIZATIONIDENTIFIER = &quot;ORGANIZATIONIDENTIFIER&quot;;

  // AltNames
  /** Email. */
  public static final String RFC822NAME = &quot;RFC822NAME&quot;;
  /** DNS. */
  public static final String DNSNAME = &quot;DNSNAME&quot;;
  /** IP. */
  public static final String IPADDRESS = &quot;IPADDRESS&quot;;
  /** URI. */
  public static final String UNIFORMRESOURCEID = &quot;UNIFORMRESOURCEID&quot;;
  /** Dir. */
  public static final String DIRECTORYNAME = &quot;DIRECTORYNAME&quot;;
  /** UPN. */
  public static final String UPN = &quot;UPN&quot;;
  /** XMPP. */
  public static final String XMPPADDR = &quot;XMPPADDR&quot;;
  /** Server. */
  public static final String SRVNAME = &quot;SRVNAME&quot;;
  /** FASCN. */
  public static final String FASCN = &quot;FASCN&quot;;
  /** GUID. */
  public static final String GUID = &quot;GUID&quot;;
  /** Kerberos. */
  public static final String KRB5PRINCIPAL = &quot;KRB5PRINCIPAL&quot;;
  /** ID. */
  public static final String PERMANENTIDENTIFIER = &quot;PERMANENTIDENTIFIER&quot;;
  /** Method. */
  public static final String SUBJECTIDENTIFICATIONMETHOD =
      &quot;SUBJECTIDENTIFICATIONMETHOD&quot;;
  // Below are altNames that are not implemented yet
  /** Name. */
  public static final String OTHERNAME = &quot;OTHERNAME&quot;;
  /** X400. */
  public static final String X400ADDRESS = &quot;X400ADDRESS&quot;;
  /** Name. */
  public static final String EDIPARTYNAME = &quot;EDIPARTYNAME&quot;;
  /// RegisteredID is a standard (rfc5280 otherName that we implement)
  /** ID. */
  public static final String REGISTEREDID = &quot;REGISTEREDID&quot;;

  // Subject directory attributes
  /** DOB. */
  public static final String DATEOFBIRTH = &quot;DATEOFBIRTH&quot;;
  /** POB. */
  public static final String PLACEOFBIRTH = &quot;PLACEOFBIRTH&quot;;
  /** Gender. */
  public static final String GENDER = &quot;GENDER&quot;;
  /** Location. */
  public static final String COUNTRYOFCITIZENSHIP = &quot;COUNTRYOFCITIZENSHIP&quot;;
  /** Location. */
  public static final String COUNTRYOFRESIDENCE = &quot;COUNTRYOFRESIDENCE&quot;;

  /** Names. */
<span class="fc" id="L269">  private static HashMap&lt;String, Integer&gt; dnNameToIdMap = new HashMap&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L271">  private static HashMap&lt;String, Integer&gt; altNameToIdMap = new HashMap&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L273">  private static HashMap&lt;String, Integer&gt; dirAttrToIdMap = new HashMap&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L275">  private static HashMap&lt;String, Integer&gt; profileNameIdMap = new HashMap&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L277">  private static HashMap&lt;Integer, String&gt; dnIdToProfileNameMap =</span>
      new HashMap&lt;&gt;();
  /** Profiles. */
<span class="fc" id="L280">  private static HashMap&lt;Integer, Integer&gt; dnIdToProfileIdMap = new HashMap&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L282">  private static HashMap&lt;Integer, Integer&gt; profileIdToDnIdMap = new HashMap&lt;&gt;();</span>
  /** Errors. */
<span class="fc" id="L284">  private static HashMap&lt;Integer, String&gt; dnErrorTextMap = new HashMap&lt;&gt;();</span>
  /** Languages. */
<span class="fc" id="L286">  private static HashMap&lt;String, String&gt; profileNameLanguageMap =</span>
      new HashMap&lt;&gt;();
  /** Profiles. */
<span class="fc" id="L289">  private static HashMap&lt;Integer, String&gt; profileIdLanguageMap =</span>
      new HashMap&lt;&gt;();
  /** Errors. */
<span class="fc" id="L292">  private static HashMap&lt;Integer, String&gt; dnIdErrorMap = new HashMap&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L294">  private static HashMap&lt;Integer, String&gt; dnIdToExtractorFieldMap =</span>
      new HashMap&lt;&gt;();
  /** Names. */
<span class="fc" id="L297">  private static HashMap&lt;Integer, String&gt; altNameIdToExtractorFieldMap =</span>
      new HashMap&lt;&gt;();
  /** Attrs. */
<span class="fc" id="L300">  private static HashMap&lt;Integer, String&gt; dirAttrIdToExtractorFieldMap =</span>
      new HashMap&lt;&gt;();
  /** Fields. */
<span class="fc" id="L303">  private static ArrayList&lt;String&gt; dnProfileFields = new ArrayList&lt;&gt;();</span>
  /** Profile fields. */
<span class="fc" id="L305">  private static final TreeSet&lt;String&gt; DN_PROFILE_FIELDS_SET = new TreeSet&lt;&gt;();</span>
  /** Languages. */
<span class="fc" id="L307">  private static ArrayList&lt;String&gt; dnLanguageTexts = new ArrayList&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L309">  private static ArrayList&lt;Integer&gt; dnDnIds = new ArrayList&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L311">  private static ArrayList&lt;String&gt; altNameFields = new ArrayList&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L313">  private static final TreeSet&lt;String&gt; ALT_NAME_FIELDS_SET = new TreeSet&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L315">  private static ArrayList&lt;String&gt; altNameLanguageTexts = new ArrayList&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L317">  private static ArrayList&lt;Integer&gt; altNameDnIds = new ArrayList&lt;&gt;();</span>
  /** Fields. */
<span class="fc" id="L319">  private static ArrayList&lt;String&gt; dirAttrFields = new ArrayList&lt;&gt;();</span>
  /** Fields.  */
<span class="fc" id="L321">  private static final TreeSet&lt;String&gt; DIR_ATTR_FIELDS_SET = new TreeSet&lt;&gt;();</span>
  /** Languages. */
<span class="fc" id="L323">  private static ArrayList&lt;String&gt; dirAttrLanguageTexts = new ArrayList&lt;&gt;();</span>
  /** IDs. */
<span class="fc" id="L325">  private static ArrayList&lt;Integer&gt; dirAttrDnIds = new ArrayList&lt;&gt;();</span>
  /** Fields. */
<span class="fc" id="L327">  private static ArrayList&lt;String&gt; dnExtractorFields = new ArrayList&lt;&gt;();</span>
  /** Names. */
<span class="fc" id="L329">  private static ArrayList&lt;String&gt; altNameExtractorFields = new ArrayList&lt;&gt;();</span>
  /** Attrs. */
<span class="fc" id="L331">  private static ArrayList&lt;String&gt; dirAttrExtractorFields = new ArrayList&lt;&gt;();</span>

  // Load values from a properties file, if it exists
  static {
<span class="fc" id="L335">    DnComponents.load();</span>
<span class="fc" id="L336">  }</span>

  /**
   * @param dnName name
   * @return id
   */
  public static Integer getDnIdFromDnName(final String dnName) {
<span class="fc" id="L343">    return dnNameToIdMap.get(dnName.toUpperCase(Locale.ROOT));</span>
  }

  /**
   * @param altName name
   * @return id
   */
  public static Integer getDnIdFromAltName(final String altName) {
<span class="fc" id="L351">    return altNameToIdMap.get(altName.toUpperCase(Locale.ROOT));</span>
  }

  /**
   * @param dirAttr attr
   * @return id
   */
  public static Integer getDnIdFromDirAttr(final String dirAttr) {
<span class="fc" id="L359">    return dirAttrToIdMap.get(dirAttr.toUpperCase(Locale.ROOT));</span>
  }
  /**
   * @param o OID
   * @return ASN1
   */
  public static ASN1ObjectIdentifier getOid(final String o) {
<span class="fc" id="L366">    return oids.get(o.toLowerCase(Locale.ROOT));</span>
  }
  /**
   * @return list
   */
  public static ArrayList&lt;String&gt; getDnProfileFields() {
<span class="fc" id="L372">    return dnProfileFields;</span>
  }
  /**
   * @param field field
   * @return bool
   */
  public static boolean isDnProfileField(final String field) {
<span class="fc" id="L379">    return DN_PROFILE_FIELDS_SET.contains(field);</span>
  }
  /**
   * @return list
   */
  public static ArrayList&lt;String&gt; getDnLanguageTexts() {
<span class="nc" id="L385">    return dnLanguageTexts;</span>
  }
  /**
   * @return list
   */
  public static ArrayList&lt;String&gt; getAltNameFields() {
<span class="fc" id="L391">    return altNameFields;</span>
  }

  /**
   * @param field field
   * @return bool
   */
  public static boolean isAltNameField(final String field) {
<span class="fc" id="L399">    return ALT_NAME_FIELDS_SET.contains(field);</span>
  }

  /**
   * @return list
   */
  public static ArrayList&lt;String&gt; getAltNameLanguageTexts() {
<span class="nc" id="L406">    return altNameLanguageTexts;</span>
  }

 /**
  * @return list
  */
  public static ArrayList&lt;String&gt; getDirAttrFields() {
<span class="fc" id="L413">    return dirAttrFields;</span>
  }

  /**
   * @param field field
   * @return bool
   */
  public static boolean isDirAttrField(final String field) {
<span class="fc" id="L421">    return DIR_ATTR_FIELDS_SET.contains(field);</span>
  }

  /** Used by DNFieldExtractor and EntityProfile, don't USE.
 * @return List
   * */
  public static ArrayList&lt;Integer&gt; getDirAttrDnIds() {
<span class="fc" id="L428">    return dirAttrDnIds;</span>
  }


  /**
   * Used by DNFieldExtractor and EntityProfile, don't USE.
   * @return list
   */
  public static ArrayList&lt;Integer&gt; getAltNameDnIds() {
<span class="fc" id="L437">    return altNameDnIds;</span>
  }


  /** Used by DNFieldExtractor and EntityProfile, don't USE.
   * @return list
   */
  public static ArrayList&lt;Integer&gt; getDnDnIds() {
<span class="fc" id="L445">    return dnDnIds;</span>
  }

  // Used only by DNFieldExtractor, don't USE
  protected static ArrayList&lt;String&gt; getDnExtractorFields() {
<span class="nc" id="L450">    return dnExtractorFields;</span>
  }

  protected static String getDnExtractorFieldFromDnId(final int field) {
<span class="fc" id="L454">    String val = (String) dnIdToExtractorFieldMap.get(Integer.valueOf(field));</span>
<span class="fc" id="L455">    return val;</span>
  }

  // Used only by DNFieldExtractor, don't USE
  protected static ArrayList&lt;String&gt; getAltNameExtractorFields() {
<span class="nc" id="L460">    return altNameExtractorFields;</span>
  }

  protected static String getAltNameExtractorFieldFromDnId(final int field) {
<span class="fc" id="L464">    String val =</span>
<span class="fc" id="L465">        (String) altNameIdToExtractorFieldMap.get(Integer.valueOf(field));</span>
<span class="fc" id="L466">    return val;</span>
  }

  // Used only by DNFieldExtractor, don't USE
  protected static ArrayList&lt;String&gt; getDirAttrExtractorFields() {
<span class="nc" id="L471">    return dirAttrExtractorFields;</span>
  }

  protected static String getDirAttrExtractorFieldFromDnId(final int field) {
<span class="fc" id="L475">    String val =</span>
<span class="fc" id="L476">        (String) dirAttrIdToExtractorFieldMap.get(Integer.valueOf(field));</span>
<span class="fc" id="L477">    return val;</span>
  }

  /**
   * @param dnid DN
   * @return Name
   */
  public static String dnIdToProfileName(final int dnid) {
<span class="fc" id="L485">    String val = (String) dnIdToProfileNameMap.get(Integer.valueOf(dnid));</span>
<span class="fc" id="L486">    return val;</span>
  }

  /**
   * @param dnid DN
   * @return ID
   */
  public static int dnIdToProfileId(final int dnid) {
<span class="fc" id="L494">    Integer val = (Integer) dnIdToProfileIdMap.get(Integer.valueOf(dnid));</span>
<span class="fc" id="L495">    return val.intValue();</span>
  }

  /**
   * Method to get a language error constant for the admin-GUI from a profile
   * name.
   *
   * @param name name
   * @return language
   */
  public static String getLanguageConstantFromProfileName(final String name) {
<span class="nc" id="L506">    String ret = (String) profileNameLanguageMap.get(name);</span>
<span class="nc" id="L507">    return ret;</span>
  }

  /**
   * Method to get a language error constant for
   * the admin-GUI from a profile id.
   *
   * @param id ID
   * @return language
   */
  public static String getLanguageConstantFromProfileId(final int id) {
<span class="nc" id="L518">    String ret = (String) profileIdLanguageMap.get(Integer.valueOf(id));</span>
<span class="nc" id="L519">    return ret;</span>
  }

  /**
   * Method to get a clear text error msg for the admin-GUI from a dn id.
   *
   * @param id ID
   * @return error text
   */
  public static String getErrTextFromDnId(final int id) {
<span class="fc" id="L529">    String ret = (String) dnIdErrorMap.get(Integer.valueOf(id));</span>
<span class="fc" id="L530">    return ret;</span>
  }

  /**
   * This method is only used to initialize EndEntityProfile, because of legacy
   * baggage. Should be refactored sometime! Please don't use this whatever you
   * do!
   *
   * @return map
   */
  public static HashMap&lt;String, Integer&gt; getProfilenameIdMap() {
<span class="fc" id="L541">    return profileNameIdMap;</span>
  }

  /**
   * A function that takes an fieldId pointing to a corresponding id in UserView
   * and DnFieldExctractor. For example :
   * profileFieldIdToUserFieldIdMapper(EndEntityProfile.COMMONNAME) returns
   * DnFieldExctractor.COMMONNAME.
   *
   * &lt;p&gt;Should only be used with subjectDN, Subject Alternative Names and
   * subject directory attribute fields.
   *
   * @param profileid ID
   * @return DN ID
   */
  public static int profileIdToDnId(final int profileid) {
<span class="fc" id="L557">    Integer val = (Integer) profileIdToDnIdMap.get(Integer.valueOf(profileid));</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">    if (val == null) {</span>
<span class="nc" id="L559">      log.error(&quot;No dn id mapping from profile id &quot; + profileid);</span>
      // We allow it to fail here
    }
<span class="fc" id="L562">    return val.intValue();</span>
  }

  /**
   * Returns the dnObjects (forward or reverse). ldaporder = true is the default
   * order in EJBCA.
   *
   * @param ldaporder boolean
   * @return objects
   */
  public static String[] getDnObjects(final boolean ldaporder) {
<span class="fc bfc" id="L573" title="All 2 branches covered.">    if (ldaporder) {</span>
<span class="fc" id="L574">      return dNObjectsForward;</span>
    }
<span class="fc" id="L576">    return getDnObjectsReverse();</span>
  }

  /**
   * Returns the reversed dnObjects. Protected to allow testing
   *
   * @return objects
   */
  protected static String[] getDnObjectsReverse() {
    // Create and reverse the order if it has not been initialized already
<span class="fc bfc" id="L586" title="All 2 branches covered.">    if (dNObjectsReverse == null) {</span>
      // this cast is not needed in java 5, but is needed for java 1.4
<span class="fc" id="L588">      dNObjectsReverse = (String[]) dNObjectsForward.clone();</span>
<span class="fc" id="L589">      ArrayUtils.reverse(dNObjectsReverse);</span>
    }
<span class="fc" id="L591">    return dNObjectsReverse;</span>
  }

  private static void load() {
<span class="fc" id="L595">    loadOrdering();</span>
<span class="fc" id="L596">    loadMappings();</span>
<span class="fc" id="L597">  }</span>

  /**
   * Load DN ordering used in CertTools.stringToBCDNString etc. Loads from file
   * placed in src/dncomponents.properties
   *
   * &lt;p&gt;A line is:
   * DNName;DNid;ProfileName;ProfileId,ErrorString,LanguageConstant
   */
  private static void loadMappings() {
<span class="fc" id="L607">    loadProfileMappingsFromFile(&quot;/profilemappings.properties&quot;);</span>
<span class="fc" id="L608">    loadProfileMappingsFromFile(&quot;/profilemappings_enterprise.properties&quot;);</span>
<span class="fc" id="L609">  }</span>

  /**
   * @return bool
   */
  public static boolean enterpriseMappingsExist() {
<span class="fc" id="L615">    return obj.getClass()</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">            .getResourceAsStream(&quot;/profilemappings_enterprise.properties&quot;)</span>
        != null;
  }

  /**
   * Reads properties from a properties file. Fails nicely if file wasn't found.
   *
   * @param propertiesFile File
   */
  private static void loadProfileMappingsFromFile(
          final String propertiesFile) {
    // Read the file to an array of lines
    String line;

<span class="fc" id="L630">    BufferedReader in = null;</span>
<span class="fc" id="L631">    InputStreamReader inf = null;</span>
    try {
<span class="fc" id="L633">      InputStream is = obj.getClass().getResourceAsStream(propertiesFile);</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">      if (is != null) {</span>
<span class="fc" id="L635">        inf = new InputStreamReader(is);</span>
<span class="fc" id="L636">        in = new BufferedReader(inf);</span>
<span class="pc bpc" id="L637" title="1 of 2 branches missed.">        if (!in.ready()) {</span>
<span class="nc" id="L638">          throw new IOException(&quot;Couldn't read &quot; + propertiesFile);</span>
        }
<span class="fc" id="L640">        String[] splits = null;</span>
<span class="fc" id="L641">        int lines = 0;</span>
<span class="fc" id="L642">        ArrayList&lt;Integer&gt; dnids = new ArrayList&lt;Integer&gt;();</span>
<span class="fc" id="L643">        ArrayList&lt;Integer&gt; profileids = new ArrayList&lt;Integer&gt;();</span>
<span class="fc bfc" id="L644" title="All 2 branches covered.">        while ((line = in.readLine()) != null) {</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">          if (!line.startsWith(&quot;#&quot;)) { // # is a comment line</span>
<span class="fc" id="L646">            splits = StringUtils.split(line, ';');</span>
<span class="pc bpc" id="L647" title="1 of 4 branches missed.">            if ((splits != null) &amp;&amp; (splits.length &gt; 5)) {</span>
<span class="fc" id="L648">              String type = splits[0];</span>
<span class="fc" id="L649">              String dnname = splits[1];</span>
<span class="fc" id="L650">              Integer dnid = Integer.valueOf(splits[2]);</span>
<span class="fc" id="L651">              String profilename = splits[3];</span>
<span class="fc" id="L652">              Integer profileid = Integer.valueOf(splits[4]);</span>
<span class="fc" id="L653">              String errstr = splits[5];</span>
<span class="fc" id="L654">              String langstr = splits[6];</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">              if (dnids.contains(dnid)) {</span>
<span class="nc" id="L656">                log.error(</span>
                    &quot;Duplicated DN Id &quot; + dnid + &quot; detected in mapping file.&quot;);
              } else {
<span class="fc" id="L659">                dnids.add(dnid);</span>
              }
<span class="pc bpc" id="L661" title="1 of 2 branches missed.">              if (profileids.contains(profileid)) {</span>
<span class="nc" id="L662">                log.error(</span>
                    &quot;Duplicated Profile Id &quot;
                        + profileid
                        + &quot; detected in mapping file.&quot;);
              } else {
<span class="fc" id="L667">                profileids.add(profileid);</span>
              }
              // Fill maps
<span class="fc" id="L670">              profileNameIdMap.put(profilename, profileid);</span>
<span class="fc" id="L671">              dnIdToProfileNameMap.put(dnid, profilename);</span>
<span class="fc" id="L672">              dnIdToProfileIdMap.put(dnid, profileid);</span>
<span class="fc" id="L673">              dnIdErrorMap.put(dnid, errstr);</span>
<span class="fc" id="L674">              profileIdToDnIdMap.put(profileid, dnid);</span>
<span class="fc" id="L675">              dnErrorTextMap.put(dnid, errstr);</span>
<span class="fc" id="L676">              profileNameLanguageMap.put(profilename, langstr);</span>
<span class="fc" id="L677">              profileIdLanguageMap.put(profileid, langstr);</span>
<span class="fc bfc" id="L678" title="All 2 branches covered.">              if (type.equals(&quot;DN&quot;)) {</span>
<span class="fc" id="L679">                dnNameToIdMap.put(dnname, dnid);</span>
<span class="fc" id="L680">                dnProfileFields.add(profilename);</span>
<span class="fc" id="L681">                DN_PROFILE_FIELDS_SET.add(profilename);</span>
<span class="fc" id="L682">                dnLanguageTexts.add(langstr);</span>
<span class="fc" id="L683">                dnDnIds.add(dnid);</span>
<span class="fc" id="L684">                dnExtractorFields.add(dnname + &quot;=&quot;);</span>
<span class="fc" id="L685">                dnIdToExtractorFieldMap.put(dnid, dnname + &quot;=&quot;);</span>
              }
<span class="fc bfc" id="L687" title="All 2 branches covered.">              if (type.equals(&quot;ALTNAME&quot;)) {</span>
<span class="fc" id="L688">                altNameToIdMap.put(dnname, dnid);</span>
<span class="fc" id="L689">                altNameFields.add(dnname);</span>
<span class="fc" id="L690">                ALT_NAME_FIELDS_SET.add(dnname);</span>
<span class="fc" id="L691">                altNameLanguageTexts.add(langstr);</span>
<span class="fc" id="L692">                altNameDnIds.add(dnid);</span>
<span class="fc" id="L693">                altNameExtractorFields.add(dnname + &quot;=&quot;);</span>
<span class="fc" id="L694">                altNameIdToExtractorFieldMap.put(dnid, dnname + &quot;=&quot;);</span>
              }
<span class="fc bfc" id="L696" title="All 2 branches covered.">              if (type.equals(&quot;DIRATTR&quot;)) {</span>
<span class="fc" id="L697">                dirAttrToIdMap.put(dnname, dnid);</span>
<span class="fc" id="L698">                dirAttrFields.add(dnname);</span>
<span class="fc" id="L699">                DIR_ATTR_FIELDS_SET.add(dnname);</span>
<span class="fc" id="L700">                dirAttrLanguageTexts.add(langstr);</span>
<span class="fc" id="L701">                dirAttrDnIds.add(dnid);</span>
<span class="fc" id="L702">                dirAttrExtractorFields.add(dnname + &quot;=&quot;);</span>
<span class="fc" id="L703">                dirAttrIdToExtractorFieldMap.put(dnid, dnname + &quot;=&quot;);</span>
              }
<span class="fc" id="L705">              lines++;</span>
<span class="fc" id="L706">            }</span>
          }
        }
<span class="fc" id="L709">        in.close();</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L711">          log.debug(&quot;Read profile maps with &quot; + lines + &quot; lines.&quot;);</span>
        }
<span class="fc" id="L713">      } else {</span>
<span class="pc bpc" id="L714" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L715">          log.debug(&quot;Properties file &quot; + propertiesFile + &quot; was not found.&quot;);</span>
        }
      }
<span class="nc" id="L718">    } catch (IOException e) {</span>
<span class="nc" id="L719">      log.error(&quot;Can not load profile mappings: &quot;, e);</span>
    } finally {
      try {
<span class="fc bfc" id="L722" title="All 2 branches covered.">        if (inf != null) {</span>
<span class="fc" id="L723">          inf.close();</span>
        }
<span class="fc bfc" id="L725" title="All 2 branches covered.">        if (in != null) {</span>
<span class="fc" id="L726">          in.close();</span>
        }
<span class="nc" id="L728">      } catch (IOException e) {</span>
<span class="fc" id="L729">      }</span>
    }
<span class="fc" id="L731">  }</span>

  /**
   * Load DN ordering used in CertTools.stringToBCDNString etc. Loads from file
   * placed in src/dncomponents.properties
   */
  private static void loadOrdering() {
    // Read the file to an array of lines
    String line;
<span class="fc" id="L740">    LinkedHashMap&lt;String, ASN1ObjectIdentifier&gt; map =</span>
        new LinkedHashMap&lt;String, ASN1ObjectIdentifier&gt;();
<span class="fc" id="L742">    BufferedReader in = null;</span>
<span class="fc" id="L743">    InputStreamReader inf = null;</span>
    try {
<span class="fc" id="L745">      InputStream is =</span>
<span class="fc" id="L746">          obj.getClass().getResourceAsStream(&quot;/dncomponents.properties&quot;);</span>
      // log.info(&quot;is is: &quot; + is);
<span class="pc bpc" id="L748" title="1 of 2 branches missed.">      if (is != null) {</span>
<span class="nc" id="L749">        inf = new InputStreamReader(is);</span>
        // inf = new FileReader(&quot;c:\\foo.properties&quot;);
<span class="nc" id="L751">        in = new BufferedReader(inf);</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">        if (!in.ready()) {</span>
<span class="nc" id="L753">          throw new IOException();</span>
        }
<span class="nc" id="L755">        String[] splits = null;</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">        while ((line = in.readLine()) != null) {</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">          if (!line.startsWith(&quot;#&quot;)) { // # is a comment line</span>
<span class="nc" id="L758">            splits = StringUtils.split(line, '=');</span>
<span class="nc bnc" id="L759" title="All 4 branches missed.">            if ((splits != null) &amp;&amp; (splits.length &gt; 1)) {</span>
<span class="nc" id="L760">              String name = splits[0].toLowerCase(Locale.ROOT);</span>
<span class="nc" id="L761">              ASN1ObjectIdentifier oid = new ASN1ObjectIdentifier(splits[1]);</span>
<span class="nc" id="L762">              map.put(name, oid);</span>
<span class="nc" id="L763">            }</span>
          }
        }
<span class="nc" id="L766">        in.close();</span>
        // Now we have read it in, transfer it to the main oid map
<span class="nc" id="L768">        log.info(&quot;Using DN components from properties file&quot;);</span>
<span class="nc" id="L769">        oids.clear();</span>
<span class="nc" id="L770">        oids.putAll(map);</span>
<span class="nc" id="L771">        Set&lt;String&gt; keys = map.keySet();</span>
        // Set the maps to the desired ordering
<span class="nc" id="L773">        dNObjectsForward = (String[]) keys.toArray(new String[keys.size()]);</span>
<span class="nc" id="L774">      } else {</span>
<span class="fc" id="L775">        log.debug(&quot;Using default values for DN components&quot;);</span>
      }
<span class="nc" id="L777">    } catch (IOException e) {</span>
<span class="nc" id="L778">      log.debug(&quot;Using default values for DN components&quot;);</span>
    } finally {
      try {
<span class="pc bpc" id="L781" title="1 of 2 branches missed.">        if (inf != null) {</span>
<span class="nc" id="L782">          inf.close();</span>
        }
<span class="pc bpc" id="L784" title="1 of 2 branches missed.">        if (in != null) {</span>
<span class="nc" id="L785">          in.close();</span>
        }
<span class="nc" id="L787">      } catch (IOException e) {</span>
<span class="fc" id="L788">      }</span>
    }
<span class="fc" id="L790">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>