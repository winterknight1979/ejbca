<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>OcspSigningCache.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.ocsp.cache</a> &gt; <span class="el_source">OcspSigningCache.java</span></div><h1>OcspSigningCache.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.ocsp.cache;

import java.math.BigInteger;
import java.security.cert.CertificateEncodingException;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.locks.ReentrantLock;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.nist.NISTObjectIdentifiers;
import org.bouncycastle.asn1.oiw.OIWObjectIdentifiers;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.cert.ocsp.CertificateID;
import org.bouncycastle.cert.ocsp.OCSPException;
import org.bouncycastle.cert.ocsp.jcajce.JcaCertificateID;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.operator.bc.BcDigestCalculatorProvider;
import org.cesecore.certificates.ocsp.exception.OcspFailureException;
import org.cesecore.util.CertTools;

/**
 * Hold information needed to create OCSP responses without database lookups.
 *
 * @version $Id: OcspSigningCache.java 28643 2018-04-06 08:53:57Z samuellb $
 */
<span class="nc" id="L42">public enum OcspSigningCache {</span>
    /** Singleton instance. */
<span class="nc" id="L44">  INSTANCE;</span>

    /** Cache. */
<span class="nc" id="L47">  private Map&lt;Integer, OcspSigningCacheEntry&gt; cache =</span>
      new HashMap&lt;Integer, OcspSigningCacheEntry&gt;();
  /** Staging. */
<span class="nc" id="L50">  private Map&lt;Integer, OcspSigningCacheEntry&gt; staging =</span>
      new HashMap&lt;Integer, OcspSigningCacheEntry&gt;();
  /** Default. */
<span class="nc" id="L53">  private OcspSigningCacheEntry defaultResponderCacheEntry = null;</span>
  /** Lock. */
<span class="nc" id="L55">  private final ReentrantLock lock = new ReentrantLock(false);</span>
  /** Logger. */
<span class="nc" id="L57">  private static final Logger LOG = Logger.getLogger(OcspSigningCache.class);</span>
  /** Flag to detect and log non-existence of a default responder once. */
<span class="nc" id="L59">  private boolean logDefaultHasRunOnce = false;</span>

  /**
   * @param certID ID
   * @return Entry
   */
  public OcspSigningCacheEntry getEntry(final CertificateID certID) {
<span class="nc" id="L66">    return cache.get(getCacheIdFromCertificateID(certID));</span>
  }

  /**
   * @return the entry corresponding to the default responder, or null if it
   *     wasn't found.
   */
  public OcspSigningCacheEntry getDefaultEntry() {
<span class="nc" id="L74">    return defaultResponderCacheEntry;</span>
  }

  /**
   * WARNING: This method potentially exports references to CAs private keys!
   *
   * @return entries
   */
  public Collection&lt;OcspSigningCacheEntry&gt; getEntries() {
<span class="nc" id="L83">    return cache.values();</span>
  }

  /** Start. */
  public void stagingStart() {
<span class="nc" id="L88">    lock.lock();</span>
<span class="nc" id="L89">    staging = new HashMap&lt;Integer, OcspSigningCacheEntry&gt;();</span>
<span class="nc" id="L90">  }</span>

  /**
   * @param ocspSigningCacheEntry Entry
   */
  public void stagingAdd(final OcspSigningCacheEntry ocspSigningCacheEntry) {
<span class="nc" id="L96">    List&lt;CertificateID&gt; certIDs = ocspSigningCacheEntry.getCertificateID();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    for (CertificateID certID : certIDs) {</span>
<span class="nc" id="L98">      staging.put(getCacheIdFromCertificateID(certID), ocspSigningCacheEntry);</span>
<span class="nc" id="L99">    }</span>
<span class="nc" id="L100">  }</span>

  /**
   * @param defaultResponderSubjectDn DN
   */
  public void stagingCommit(final String defaultResponderSubjectDn) {
<span class="nc" id="L106">    OcspSigningCacheEntry lDefaultResponderCacheEntry = null;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    for (final OcspSigningCacheEntry entry : staging.values()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">      if (entry.getOcspSigningCertificate() != null) {</span>
<span class="nc" id="L109">        final X509Certificate signingCertificate =</span>
<span class="nc" id="L110">            entry.getOcspSigningCertificate();</span>
<span class="nc" id="L111">        if (CertTools.getIssuerDN(signingCertificate)</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            .equals(defaultResponderSubjectDn)) {</span>
<span class="nc" id="L113">          lDefaultResponderCacheEntry = entry;</span>
<span class="nc" id="L114">          break;</span>
        }
<span class="nc bnc" id="L116" title="All 2 branches missed.">      } else if (entry.getCaCertificateChain() != null</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">          &amp;&amp; !entry.getCaCertificateChain().isEmpty()) {</span>
<span class="nc" id="L118">        final X509Certificate signingCertificate =</span>
<span class="nc" id="L119">            entry.getCaCertificateChain().get(0);</span>
<span class="nc" id="L120">        if (CertTools.getSubjectDN(signingCertificate)</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            .equals(defaultResponderSubjectDn)) {</span>
<span class="nc" id="L122">          lDefaultResponderCacheEntry = entry;</span>
<span class="nc" id="L123">          break;</span>
        }
      }
<span class="nc" id="L126">    }</span>
    // Lastly, walk through the list of entries and replace all placeholders
    // with the default responder
<span class="nc" id="L129">    Map&lt;Integer, OcspSigningCacheEntry&gt; modifiedEntries =</span>
        new HashMap&lt;Integer, OcspSigningCacheEntry&gt;();
<span class="nc" id="L131">    List&lt;Integer&gt; removedEntries = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">    for (Integer key : staging.keySet()) {</span>
<span class="nc" id="L133">      OcspSigningCacheEntry entry = staging.get(key);</span>
      // If entry has been created without a private key, replace it with the
      // default responder.
<span class="nc bnc" id="L136" title="All 2 branches missed.">      if (entry.isPlaceholder()) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (lDefaultResponderCacheEntry != null) {</span>
<span class="nc" id="L138">          entry =</span>
              new OcspSigningCacheEntry(
<span class="nc" id="L140">                  entry.getIssuerCaCertificate(),</span>
<span class="nc" id="L141">                  entry.getIssuerCaCertificateStatus(),</span>
<span class="nc" id="L142">                  lDefaultResponderCacheEntry.getCaCertificateChain(),</span>
<span class="nc" id="L143">                  lDefaultResponderCacheEntry.getOcspSigningCertificate(),</span>
<span class="nc" id="L144">                  lDefaultResponderCacheEntry.getPrivateKey(),</span>
<span class="nc" id="L145">                  lDefaultResponderCacheEntry.getSignatureProviderName(),</span>
<span class="nc" id="L146">                  lDefaultResponderCacheEntry.getOcspKeyBinding(),</span>
<span class="nc" id="L147">                  lDefaultResponderCacheEntry.getResponderIdType());</span>
<span class="nc" id="L148">          modifiedEntries.put(key, entry);</span>
        } else {
          // If no default responder is defined, remove placeholder.
<span class="nc" id="L151">          removedEntries.add(key);</span>
        }
      }
<span class="nc" id="L154">    }</span>
<span class="nc" id="L155">    staging.putAll(modifiedEntries);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">    for (Integer removedKey : removedEntries) {</span>
<span class="nc" id="L157">      staging.remove(removedKey);</span>
<span class="nc" id="L158">    }</span>
<span class="nc" id="L159">    logDefaultResponderChanges(</span>
        this.defaultResponderCacheEntry,
        lDefaultResponderCacheEntry,
        defaultResponderSubjectDn);
<span class="nc" id="L163">    cache = staging;</span>
<span class="nc" id="L164">    this.defaultResponderCacheEntry = lDefaultResponderCacheEntry;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L166">      LOG.debug(&quot;Committing the following to OCSP cache:&quot;);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">      for (final Integer key : staging.keySet()) {</span>
<span class="nc" id="L168">        final OcspSigningCacheEntry entry = staging.get(key);</span>
<span class="nc" id="L169">        LOG.debug(</span>
            &quot; KeyBindingId: &quot;
                + key
                + &quot;, SubjectDN '&quot;
<span class="nc" id="L173">                + CertTools.getSubjectDN(entry.getFullCertificateChain().get(0))</span>
                + &quot;', IssuerDN '&quot;
<span class="nc" id="L175">                + CertTools.getIssuerDN(entry.getFullCertificateChain().get(0))</span>
                + &quot;', SerialNumber &quot;
                + entry
<span class="nc" id="L178">                    .getFullCertificateChain()</span>
<span class="nc" id="L179">                    .get(0)</span>
<span class="nc" id="L180">                    .getSerialNumber()</span>
<span class="nc" id="L181">                    .toString()</span>
                + &quot;/&quot;
                + entry
<span class="nc" id="L184">                    .getFullCertificateChain()</span>
<span class="nc" id="L185">                    .get(0)</span>
<span class="nc" id="L186">                    .getSerialNumber()</span>
<span class="nc" id="L187">                    .toString(16));</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (entry.getOcspKeyBinding() != null) {</span>
<span class="nc" id="L189">          LOG.debug(</span>
              &quot;   keyPairAlias: &quot;
<span class="nc" id="L191">                  + entry.getOcspKeyBinding().getKeyPairAlias());</span>
        }
<span class="nc" id="L193">      }</span>
    }
<span class="nc" id="L195">  }</span>

  /** Unlock. */
  public void stagingRelease() {
<span class="nc" id="L199">    lock.unlock();</span>
<span class="nc" id="L200">  }</span>

  /**
   * Log any change in default responder.
   *
   * @param currentEntry current entry
   * @param stagedEntry staged entry
   * @param defaultResponderSubjectDn boolean
   */
  private void logDefaultResponderChanges(
      final OcspSigningCacheEntry currentEntry,
      final OcspSigningCacheEntry stagedEntry,
      final String defaultResponderSubjectDn) {
<span class="nc" id="L213">    String msg = null;</span>
<span class="nc bnc" id="L214" title="All 6 branches missed.">    if (stagedEntry == null</span>
        &amp;&amp; (currentEntry != null || !logDefaultHasRunOnce)) {
      // No default responder after staging. Did we loose it or is it the first
      // time we run this check?
<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (StringUtils.isEmpty(defaultResponderSubjectDn)) {</span>
<span class="nc" id="L219">        msg = &quot;No default responder was defined.&quot;;</span>
      } else {
<span class="nc" id="L221">        msg =</span>
            &quot;The default OCSP responder with subject '&quot;
                + defaultResponderSubjectDn
                + &quot;' was not found.&quot;;
      }
<span class="nc" id="L226">      msg +=</span>
          &quot; OCSP requests for certificates issued by unknown CAs will return&quot;
              + &quot; \&quot;unauthorized\&quot; as per RFC6960, Section 2.3&quot;;
<span class="nc bnc" id="L229" title="All 4 branches missed.">    } else if (stagedEntry != null &amp;&amp; currentEntry == null) {</span>
      // We gained a default responder.
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (stagedEntry.isUsingSeparateOcspSigningCertificate()) {</span>
<span class="nc" id="L232">        msg =</span>
            &quot;Setting keybinding with ID&quot;
<span class="nc" id="L234">                + stagedEntry.getOcspKeyBinding().getId()</span>
                + &quot; and DN &quot;
                + defaultResponderSubjectDn
                + &quot; as default OCSP responder.&quot;;
      } else {
<span class="nc" id="L239">        msg =</span>
            &quot;Setting CA with DN &quot;
                + defaultResponderSubjectDn
                + &quot; as default OCSP responder.&quot;;
      }
<span class="nc bnc" id="L244" title="All 4 branches missed.">    } else if (stagedEntry != null &amp;&amp; currentEntry != null) {</span>
      // We have a default responder both before and after. Did it change in any
      // way?
<span class="nc" id="L247">      if (stagedEntry.isUsingSeparateOcspSigningCertificate()</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">              != currentEntry.isUsingSeparateOcspSigningCertificate()</span>
<span class="nc" id="L249">          || !CertTools.getSubjectDN(stagedEntry.getIssuerCaCertificate())</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">              .equals(</span>
<span class="nc" id="L251">                  CertTools.getSubjectDN(</span>
<span class="nc" id="L252">                      currentEntry.getIssuerCaCertificate()))) {</span>
        // We switched from signing with a CA to OcspKeyBindinig or vice versa,
        // or use a different default.
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (stagedEntry.isUsingSeparateOcspSigningCertificate()) {</span>
<span class="nc" id="L256">          msg =</span>
              &quot;Setting keybinding with ID&quot;
<span class="nc" id="L258">                  + stagedEntry.getOcspKeyBinding().getId()</span>
                  + &quot; and DN &quot;
                  + defaultResponderSubjectDn
                  + &quot; as default OCSP responder.&quot;;
        } else {
<span class="nc" id="L263">          msg =</span>
              &quot;Setting CA with DN &quot;
                  + defaultResponderSubjectDn
                  + &quot; as default OCSP responder.&quot;;
        }
<span class="nc bnc" id="L268" title="All 2 branches missed.">      } else if (stagedEntry.isUsingSeparateOcspSigningCertificate()) {</span>
<span class="nc" id="L269">        if (stagedEntry.getOcspKeyBinding().getId()</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">            != currentEntry.getOcspKeyBinding().getId()) {</span>
          // A different OcspKeyBinding will be used to respond to requests even
          // though the issuing CA has not changed
<span class="nc" id="L273">          msg =</span>
              &quot;Setting keybinding with ID&quot;
<span class="nc" id="L275">                  + stagedEntry.getOcspKeyBinding().getId()</span>
                  + &quot; and DN &quot;
                  + defaultResponderSubjectDn
                  + &quot; as default OCSP responder.&quot;;
        }
      }
    }
<span class="nc bnc" id="L282" title="All 2 branches missed.">    if (msg == null) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">      if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L284">        LOG.debug(&quot;No change in default responder.&quot;);</span>
      }
    } else {
<span class="nc" id="L287">      LOG.info(msg);</span>
    }
<span class="nc" id="L289">    logDefaultHasRunOnce = true;</span>
<span class="nc" id="L290">  }</span>

  /**
   * This method will add a single cache entry to the cache. It should only be
   * used to solve temporary cache inconsistencies.
   *
   * @param ocspSigningCacheEntry the entry to add
   */
  public void addSingleEntry(
          final OcspSigningCacheEntry ocspSigningCacheEntry) {
<span class="nc" id="L300">    List&lt;CertificateID&gt; certIDs = ocspSigningCacheEntry.getCertificateID();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">    for (CertificateID certID : certIDs) {</span>
<span class="nc" id="L302">      int cacheId = getCacheIdFromCertificateID(certID);</span>
<span class="nc" id="L303">      lock.lock();</span>
      try {
        // Make sure that another thread didn't add the same entry while this
        // one was waiting.
<span class="nc bnc" id="L307" title="All 2 branches missed.">        if (!cache.containsKey(cacheId)) {</span>
<span class="nc" id="L308">          cache.put(cacheId, ocspSigningCacheEntry);</span>
        }
      } finally {
<span class="nc" id="L311">        lock.unlock();</span>
      }
<span class="nc" id="L313">    }</span>
<span class="nc" id="L314">  }</span>

  /**
   * @param certID ID
   * @return a cache identifier based on the provided CertificateID.
   */
  public static int getCacheIdFromCertificateID(final CertificateID certID) {
    // Use bitwise XOR of the hashcodes for IssuerNameHash and IssuerKeyHash to
    // produce the integer.
<span class="nc" id="L323">    int result =</span>
<span class="nc" id="L324">        new BigInteger(certID.getIssuerNameHash()).hashCode()</span>
<span class="nc" id="L325">            ^ new BigInteger(certID.getIssuerKeyHash()).hashCode();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L327">      LOG.debug(</span>
          &quot;Using getIssuerNameHash &quot;
<span class="nc" id="L329">              + new BigInteger(certID.getIssuerNameHash()).toString(16)</span>
              + &quot; and getIssuerKeyHash &quot;
<span class="nc" id="L331">              + new BigInteger(certID.getIssuerKeyHash()).toString(16)</span>
              + &quot; to produce id &quot;
              + result);
    }
<span class="nc" id="L335">    return result;</span>
  }

  /**
   * @param certificate certificate
   * @return the CertificateID's based on the provided certificate
   */
  public static List&lt;CertificateID&gt; getCertificateIDFromCertificate(
      final X509Certificate certificate) {
    try {
<span class="nc bnc" id="L345" title="All 2 branches missed.">      if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L346">        LOG.trace(</span>
            &quot;Building CertificateId's from certificate with subjectDN '&quot;
<span class="nc" id="L348">                + CertTools.getSubjectDN(certificate)</span>
                + &quot;'.&quot;);
      }
<span class="nc" id="L351">      List&lt;CertificateID&gt; ret = new ArrayList&lt;CertificateID&gt;();</span>
<span class="nc" id="L352">      ret.add(</span>
          new JcaCertificateID(
              new BcDigestCalculatorProvider()
<span class="nc" id="L355">                  .get(new AlgorithmIdentifier(OIWObjectIdentifiers.idSHA1)),</span>
              certificate,
<span class="nc" id="L357">              certificate.getSerialNumber()));</span>
<span class="nc" id="L358">      ret.add(</span>
          new JcaCertificateID(
              new BcDigestCalculatorProvider()
<span class="nc" id="L361">                  .get(</span>
                      new AlgorithmIdentifier(NISTObjectIdentifiers.id_sha256)),
              certificate,
<span class="nc" id="L364">              certificate.getSerialNumber()));</span>
<span class="nc" id="L365">      return ret;</span>
<span class="nc" id="L366">    } catch (OCSPException e) {</span>
<span class="nc" id="L367">      throw new OcspFailureException(e);</span>
<span class="nc" id="L368">    } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L369">      throw new OcspFailureException(e);</span>
<span class="nc" id="L370">    } catch (OperatorCreationException e) {</span>
<span class="nc" id="L371">      throw new OcspFailureException(e);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>