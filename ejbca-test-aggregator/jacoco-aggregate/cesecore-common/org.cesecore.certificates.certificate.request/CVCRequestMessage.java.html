<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CVCRequestMessage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-test-aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate.request</a> &gt; <span class="el_source">CVCRequestMessage.java</span></div><h1>CVCRequestMessage.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/ 
package org.cesecore.certificates.certificate.request;

import java.math.BigInteger;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.SignatureException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import org.apache.log4j.Logger;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.asn1.x509.Extensions;
import org.bouncycastle.cms.CMSSignedGenerator;
import org.cesecore.util.CertTools;
import org.ejbca.cvc.CVCAuthenticatedRequest;
import org.ejbca.cvc.CVCObject;
import org.ejbca.cvc.CVCertificate;
import org.ejbca.cvc.CardVerifiableCertificate;
import org.ejbca.cvc.CertificateParser;
import org.ejbca.cvc.HolderReferenceField;
import org.ejbca.cvc.exception.ConstructionException;
import org.ejbca.cvc.exception.ParseException;


/**
 * Class to handle CVC request messages sent to the CA.
 *
 * @version $Id: CVCRequestMessage.java 28201 2018-02-07 08:33:29Z andresjakobs $
 */
public class CVCRequestMessage implements RequestMessage {
    /**
     * Determines if a de-serialized file is compatible with this class.
     *
     * Maintainers must change this value if and only if the new version
     * of this class is not compatible with old versions. See Sun docs
     * for &lt;a href=http://java.sun.com/products/jdk/1.1/docs/guide
     * /serialization/spec/version.doc.html&gt; details. &lt;/a&gt;
     *
     */
    static final long serialVersionUID = 1L;

<span class="nc" id="L60">    private static final Logger log = Logger.getLogger(CVCRequestMessage.class);</span>

    /** Raw form of the CVC message */
    protected byte[] cvcmsg;

    /** manually set password */
<span class="nc" id="L66">    protected String password = null;</span>

    /** manually set username */
<span class="nc" id="L69">    protected String username = null;</span>
    
    /** The cvc request message, not serialized. */
<span class="nc" id="L72">    protected transient CVCertificate cvcert = null;</span>

<span class="nc" id="L74">    private List&lt;Certificate&gt; additionalCaCertificates = new ArrayList&lt;Certificate&gt;();</span>
  
<span class="nc" id="L76">    private List&lt;Certificate&gt; additionalExtraCertsCertificates = new ArrayList&lt;Certificate&gt;();</span>
    
    /**
     * Constructs a new empty message handler object.
     */
<span class="nc" id="L81">    public CVCRequestMessage() {</span>
    	// No constructor
<span class="nc" id="L83">    }</span>

    /**
     * Constructs a new message handler object.
     *
     * @param msg The DER encoded request.
     */
<span class="nc" id="L90">    public CVCRequestMessage(byte[] msg) {</span>
<span class="nc" id="L91">        this.cvcmsg = msg;</span>
<span class="nc" id="L92">        init();</span>
<span class="nc" id="L93">    }</span>

    private void init() {
		try {
			CVCObject parsedObject;
<span class="nc" id="L98">			parsedObject = CertificateParser.parseCVCObject(cvcmsg);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (parsedObject instanceof CVCertificate) {</span>
<span class="nc" id="L100">				cvcert = (CVCertificate) parsedObject;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">			} else if (parsedObject instanceof CVCAuthenticatedRequest) {</span>
<span class="nc" id="L102">				CVCAuthenticatedRequest authreq = (CVCAuthenticatedRequest)parsedObject;</span>
<span class="nc" id="L103">				cvcert = authreq.getRequest();</span>
			}
<span class="nc" id="L105">		} catch (ParseException e) {</span>
<span class="nc" id="L106">            log.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L107">            throw new IllegalArgumentException(e);</span>
<span class="nc" id="L108">		} catch (ConstructionException e) {</span>
<span class="nc" id="L109">            log.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L110">            throw new IllegalArgumentException(e);</span>
<span class="nc" id="L111">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L112">            log.error(&quot;Error in init for CVC request: &quot;, e);</span>
<span class="nc" id="L113">            throw new IllegalArgumentException(e);</span>
<span class="nc" id="L114">		}</span>
<span class="nc" id="L115">    }</span>

    @Override
    public PublicKey getRequestPublicKey()
            throws InvalidKeyException, NoSuchAlgorithmException, NoSuchProviderException {
    	try {
<span class="nc bnc" id="L121" title="All 2 branches missed.">    		if (cvcert == null) {</span>
<span class="nc" id="L122">    			init();</span>
    		}
<span class="nc" id="L124">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L125">            log.error(&quot;CVC not inited!&quot;);</span>
<span class="nc" id="L126">            return null;</span>
<span class="nc" id="L127">        }</span>

        PublicKey pk;
		try {
<span class="nc" id="L131">			pk = cvcert.getCertificateBody().getPublicKey();</span>
<span class="nc" id="L132">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L133">			throw new InvalidKeyException(e);</span>
<span class="nc" id="L134">		}</span>
<span class="nc" id="L135">        return pk;</span>
    }

    /** force a password
     * @param pwd password
     */
    public void setPassword(String pwd) {
<span class="nc" id="L142">        this.password = pwd;</span>
<span class="nc" id="L143">    }</span>

    @Override
    public String getPassword() {
<span class="nc" id="L147">    	return password;</span>
    }

    /** force a username, i.e. ignore the DN/username in the request
     * @param username username
     */
    public void setUsername(String username) {
<span class="nc" id="L154">        this.username = username;</span>
<span class="nc" id="L155">    }</span>

    @Override
    public String getUsername() {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (username != null) {</span>
<span class="nc" id="L160">            return username;</span>
        }
<span class="nc" id="L162">        String subject = null;</span>
		try {
<span class="nc" id="L164">			HolderReferenceField hr = cvcert.getCertificateBody().getHolderReference();</span>
<span class="nc" id="L165">			subject = hr.getMnemonic()+hr.getCountry();</span>
<span class="nc" id="L166">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L167">			log.error(e);</span>
<span class="nc" id="L168">		}</span>
<span class="nc" id="L169">        return subject;</span>
    }

    @Override
    public String getIssuerDN() {
<span class="nc" id="L174">    	CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L175">        return CertTools.getIssuerDN(cc);</span>
    }

    /**
     * Could get the sequence (of CVC cert). For CVC certificate this does not combine well with getIssuerDN to identify
     * the CA-certificate of the CA the request is targeted for, so it always return null.
     *
     * @return null.
     */
    @Override
    public BigInteger getSerialNo() {
    	//CardVerifiableCertificate cc = getCardVerifiableCertificate()
        //return CertTools.getSerialNumber(cc);
<span class="nc" id="L188">    	return null;</span>
    }
    
    @Override
    public String getCRLIssuerDN() {
<span class="nc" id="L193">        return null;</span>
    }

    @Override
    public BigInteger getCRLSerialNo() {
<span class="nc" id="L198">        return null;</span>
    }

    @Override
    public String getRequestDN() {
<span class="nc" id="L203">    	CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L204">        return CertTools.getSubjectDN(cc);</span>
    }

    @Override
    public X500Name getRequestX500Name() {
<span class="nc" id="L209">    	String dn = getRequestDN();</span>
<span class="nc" id="L210">    	return new X500Name(dn);</span>
    }

    @Override
    public String getRequestAltNames() {
<span class="nc" id="L215">    	return null;</span>
    }

    @Override
	public Date getRequestValidityNotBefore() {
<span class="nc" id="L220">    	CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L221">        return CertTools.getNotBefore(cc);</span>
	}
	
    @Override
	public Date getRequestValidityNotAfter() {
<span class="nc" id="L226">    	CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc" id="L227">        return CertTools.getNotAfter(cc);</span>
	}
	
    @Override
	public Extensions getRequestExtensions() {
<span class="nc" id="L232">		return null;</span>
	}
	
    @Override
    public boolean verify()
    throws InvalidKeyException, NoSuchAlgorithmException, NoSuchProviderException {
<span class="nc" id="L238">        return verify(null);</span>
    }
    private boolean verify(PublicKey pubKey)
            throws InvalidKeyException, NoSuchAlgorithmException, NoSuchProviderException {
<span class="nc" id="L242">        log.trace(&quot;&gt;verify()&quot;);</span>

<span class="nc" id="L244">        boolean ret = false;</span>

        try {
<span class="nc" id="L247">        	CardVerifiableCertificate cc = getCardVerifiableCertificate();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        	if (cc != null) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (pubKey == null) {</span>
<span class="nc" id="L250">                	cc.verify(cvcert.getCertificateBody().getPublicKey());</span>
<span class="nc" id="L251">                	ret = true; // If we came here verification was successful</span>
                } else {
<span class="nc" id="L253">                    cc.verify(pubKey);</span>
<span class="nc" id="L254">                	ret = true; // If we came here verification was successful</span>
                }        		
        	}
<span class="nc" id="L257">        } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L258">            log.error(&quot;CVC error!&quot;, e);</span>
<span class="nc" id="L259">        } catch (InvalidKeyException e) {</span>
<span class="nc" id="L260">            log.error(&quot;Error in CVC-request:&quot;, e);</span>
<span class="nc" id="L261">            throw e;</span>
<span class="nc" id="L262">        } catch (CertificateException e) {</span>
<span class="nc" id="L263">            log.error(&quot;Error in CVC-signature:&quot;, e);</span>
<span class="nc" id="L264">        } catch (SignatureException e) {</span>
<span class="nc" id="L265">            log.error(&quot;Error in CVC-signature:&quot;, e);</span>
<span class="nc" id="L266">        }</span>

<span class="nc" id="L268">        log.trace(&quot;&lt;verify()&quot;);</span>

<span class="nc" id="L270">        return ret;</span>
    }

    @Override
    public boolean requireKeyInfo() {
<span class="nc" id="L275">        return false;</span>
    }

    @Override
    public void setKeyInfo(Certificate cert, PrivateKey key, String Provider) {
<span class="nc" id="L280">    }</span>

    @Override
    public int getErrorNo() {
<span class="nc" id="L284">        return 0;</span>
    }

    @Override
    public String getErrorText() {
<span class="nc" id="L289">        return &quot;&quot;;</span>
    }

    @Override
    public String getSenderNonce() {
<span class="nc" id="L294">        return null;</span>
    }

    @Override
    public String getTransactionId() {
<span class="nc" id="L299">        return null;</span>
    }

    @Override
    public byte[] getRequestKeyInfo() {
<span class="nc" id="L304">    	byte[] ret = null;</span>
    	try {
<span class="nc" id="L306">        	String seq = cvcert.getCertificateBody().getHolderReference().getSequence();</span>
<span class="nc" id="L307">        	ret = seq.getBytes();</span>
<span class="nc" id="L308">    	} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L309">            log.error(&quot;CVC error!&quot;, e);</span>
<span class="nc" id="L310">    	}</span>
<span class="nc" id="L311">        return ret;</span>
    }
    
    @Override
    public String getPreferredDigestAlg() {
    	// Not used
<span class="nc" id="L317">    	return CMSSignedGenerator.DIGEST_SHA256;</span>
    }

    @Override
    public boolean includeCACert() {
<span class="nc" id="L322">    	return false;</span>
    }

    @Override
    public int getRequestType() {
<span class="nc" id="L327">    	return 0;</span>
    }
    
    @Override
    public int getRequestId() {
<span class="nc" id="L332">    	return 0;</span>
    }
    
    @Override
    public void setResponseKeyInfo(PrivateKey key, String provider) {
        // NOOP
<span class="nc" id="L338">    }</span>
    
    @Override
    public List&lt;Certificate&gt; getAdditionalCaCertificates() {
<span class="nc" id="L342">        return additionalCaCertificates;</span>
    }

    @Override
    public void setAdditionalCaCertificates(final List&lt;Certificate&gt; certificates) {
<span class="nc" id="L347">        this.additionalCaCertificates = certificates;</span>
<span class="nc" id="L348">    }</span>
    
    @Override
    public List&lt;Certificate&gt; getAdditionalExtraCertsCertificates() {
<span class="nc" id="L352">        return additionalExtraCertsCertificates;</span>
    }

    @Override
    public void setAdditionalExtraCertsCertificates(List&lt;Certificate&gt; additionalExtraCertsCertificates) {
<span class="nc" id="L357">        this.additionalExtraCertsCertificates = additionalExtraCertsCertificates;</span>
<span class="nc" id="L358">    }</span>

    /** Specific to CVC request messages, EAC requests contains a sequence 
     * @return sequence*/
    public String getKeySequence() {
<span class="nc" id="L363">    	String ret = null;</span>
    	try {
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (cvcert.getCertificateBody().getHolderReference() != null) {</span>
<span class="nc" id="L366">				ret = cvcert.getCertificateBody().getHolderReference().getSequence();    		</span>
			}
<span class="nc" id="L368">		} catch (NoSuchFieldException e) {</span>
			// No sequence found...
<span class="nc" id="L370">		}</span>
<span class="nc" id="L371">    	return ret;</span>
    }
    
    private CardVerifiableCertificate getCardVerifiableCertificate() {
    	try {
<span class="nc bnc" id="L376" title="All 2 branches missed.">    		if (cvcert == null) {</span>
<span class="nc" id="L377">    			init();</span>
    		}
<span class="nc" id="L379">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L380">            log.error(&quot;CVC not inited!&quot;, e);</span>
<span class="nc" id="L381">            return null;</span>
<span class="nc" id="L382">        }</span>
<span class="nc" id="L383">    	CardVerifiableCertificate cc = new CardVerifiableCertificate(cvcert);</span>
<span class="nc" id="L384">    	return cc;</span>
    }
} // PKCS10RequestMessage
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>