<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RocaBrokenKey.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">ejbca-test-aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.keys.validation</a> &gt; <span class="el_source">RocaBrokenKey.java</span></div><h1>RocaBrokenKey.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright (c) 2017, CRoCS, EnigmaBridge Ltd.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Credits: ported to Java by Martin Paljak
 */
package org.cesecore.keys.validation;

/** Tests if an RSA key is generated by an Infineon chip that generates weak keys, CVE-2017-15361.
 *  https://crocs.fi.muni.cz/public/papers/rsa_ccs17, https://github.com/crocs-muni/roca, https://github.com/crocs-muni/roca/blob/master/java/BrokenKey.java
 *  Code released under the MIT license, hence OK to include here.
 *
 * @version $Id: RocaBrokenKey.java 26840 2017-10-19 06:26:00Z anatom $
 */
import java.math.BigInteger;

<span class="nc" id="L36">public class RocaBrokenKey {</span>
<span class="fc" id="L37">    private static final int[] prims = new int[]{3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101,</span>
            103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157, 163, 167};
<span class="fc" id="L39">    private static final BigInteger[] primes = new BigInteger[prims.length];</span>

    static {
<span class="fc bfc" id="L42" title="All 2 branches covered.">        for (int i = 0; i &lt; prims.length; i++) {</span>
<span class="fc" id="L43">            primes[i] = BigInteger.valueOf(prims[i]);</span>
        }
    }

<span class="fc" id="L47">    private static final BigInteger[] markers = new BigInteger[]{</span>
            new BigInteger(&quot;6&quot;),
            new BigInteger(&quot;30&quot;),
            new BigInteger(&quot;126&quot;),
            new BigInteger(&quot;1026&quot;),
            new BigInteger(&quot;5658&quot;),
            new BigInteger(&quot;107286&quot;),
            new BigInteger(&quot;199410&quot;),
            new BigInteger(&quot;8388606&quot;),
            new BigInteger(&quot;536870910&quot;),
            new BigInteger(&quot;2147483646&quot;),
            new BigInteger(&quot;67109890&quot;),
            new BigInteger(&quot;2199023255550&quot;),
            new BigInteger(&quot;8796093022206&quot;),
            new BigInteger(&quot;140737488355326&quot;),
            new BigInteger(&quot;5310023542746834&quot;),
            new BigInteger(&quot;576460752303423486&quot;),
            new BigInteger(&quot;1455791217086302986&quot;),
            new BigInteger(&quot;147573952589676412926&quot;),
            new BigInteger(&quot;20052041432995567486&quot;),
            new BigInteger(&quot;6041388139249378920330&quot;),
            new BigInteger(&quot;207530445072488465666&quot;),
            new BigInteger(&quot;9671406556917033397649406&quot;),
            new BigInteger(&quot;618970019642690137449562110&quot;),
            new BigInteger(&quot;79228162521181866724264247298&quot;),
            new BigInteger(&quot;2535301200456458802993406410750&quot;),
            new BigInteger(&quot;1760368345969468176824550810518&quot;),
            new BigInteger(&quot;50079290986288516948354744811034&quot;),
            new BigInteger(&quot;473022961816146413042658758988474&quot;),
            new BigInteger(&quot;10384593717069655257060992658440190&quot;),
            new BigInteger(&quot;144390480366845522447407333004847678774&quot;),
            new BigInteger(&quot;2722258935367507707706996859454145691646&quot;),
            new BigInteger(&quot;174224571863520493293247799005065324265470&quot;),
            new BigInteger(&quot;696898287454081973172991196020261297061886&quot;),
            new BigInteger(&quot;713623846352979940529142984724747568191373310&quot;),
            new BigInteger(&quot;1800793591454480341970779146165214289059119882&quot;),
            new BigInteger(&quot;126304807362733370595828809000324029340048915994&quot;),
            new BigInteger(&quot;11692013098647223345629478661730264157247460343806&quot;),
            new BigInteger(&quot;187072209578355573530071658587684226515959365500926&quot;)
    };

// Tomas Gustavsson: Original code from GitHub, kept for reference I just changed input to modulus directly
//    public static boolean isAffected(X509Certificate c) {
//        if (!(c.getPublicKey() instanceof RSAPublicKey))
//            return false;
//
//        BigInteger modulus = ((RSAPublicKey) c.getPublicKey()).getModulus();
//
//        for (int i = 0; i &lt; primes.length; i++) {
//            if (BigInteger.ONE.shiftLeft(modulus.remainder(primes[i]).intValue()).and(markers[i]).equals(BigInteger.ZERO)) {
//                return false;
//            }
//        }
//
//        return true;
//    }

    public static boolean isAffected(BigInteger modulus) {
<span class="fc bfc" id="L105" title="All 2 branches covered.">        for (int i = 0; i &lt; primes.length; i++) {</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (BigInteger.ONE.shiftLeft(modulus.remainder(primes[i]).intValue()).and(markers[i]).equals(BigInteger.ZERO)) {</span>
<span class="fc" id="L107">                return false;</span>
            }
        }
<span class="fc" id="L110">        return true;</span>
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>