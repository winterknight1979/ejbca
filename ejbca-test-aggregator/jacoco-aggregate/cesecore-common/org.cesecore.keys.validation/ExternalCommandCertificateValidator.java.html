<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ExternalCommandCertificateValidator.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.keys.validation</a> &gt; <span class="el_source">ExternalCommandCertificateValidator.java</span></div><h1>ExternalCommandCertificateValidator.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General                  *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.cesecore.keys.validation;

import java.io.File;
import java.io.IOException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.CertificateParsingException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections.ListUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.certificates.ca.CA;
import org.cesecore.certificates.ca.CAInfo;
import org.cesecore.profiles.Profile;
import org.cesecore.util.CertTools;
import org.cesecore.util.ExternalProcessException;
import org.cesecore.util.ExternalProcessTools;
import org.cesecore.util.ui.DynamicUiActionCallback;
import org.cesecore.util.ui.DynamicUiCallbackException;
import org.cesecore.util.ui.DynamicUiModel;
import org.cesecore.util.ui.DynamicUiProperty;

/**
 * External command certificate validator for multiple platforms.
 *
 * @version $Id: ExternalCommandCertificateValidator.java 34150 2019-12-20
 *     14:17:40Z henriks $
 */
public class ExternalCommandCertificateValidator
    extends CertificateValidatorBase {

  private static final long serialVersionUID = -135859158339811678L;

  /** Class logger. */
<span class="nc" id="L53">  private static final Logger LOG =</span>
<span class="nc" id="L54">      Logger.getLogger(ExternalCommandCertificateValidator.class);</span>

  /** API version. */
  public static final float LATEST_VERSION = 4F;

  /** The validator type. */
  private static final String TYPE_IDENTIFIER =
      &quot;EXTERNAL_CERTIFICATE_VALIDATOR&quot;;

  /** Literal for external command storage key. */
  protected static final String EXTERNAL_COMMAND = &quot;externalCommand&quot;;

  /** Literal for fail on error code storage key. */
  protected static final String FAIL_ON_ERROR_CODE = &quot;failOnErrorCode&quot;;

  /** Literal for fail on standard error storage key. */
  protected static final String FAIL_ON_STANDARD_ERROR = &quot;failOnStandardError&quot;;

  /** Literal for external log to STDOUT storage key. */
  protected static final String LOG_STANDARD_OUT = &quot;logStandardOut&quot;;

  /** Literal for external log to ERROUT storage key. */
  protected static final String LOG_ERROR_OUT = &quot;logErrorOut&quot;;

  /** Holds the test certificates uploaded by the user. */
  private List&lt;Certificate&gt; testCertificates;

  static {
<span class="nc" id="L82">    applicableCaTypes.add(CAInfo.CATYPE_X509);</span>
<span class="nc" id="L83">  }</span>

  /** Public constructor needed for deserialization. */
  public ExternalCommandCertificateValidator() {
<span class="nc" id="L87">    super();</span>
<span class="nc" id="L88">  }</span>

  /**
   * Creates a new instance.
   *
   * @param name name
   */
  public ExternalCommandCertificateValidator(final String name) {
<span class="nc" id="L96">    super(name);</span>
<span class="nc" id="L97">  }</span>

  /** Initializes uninitialized data fields. */
  @Override
  public void init() {
<span class="nc" id="L102">    super.init();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">    if (data.get(EXTERNAL_COMMAND) == null) {</span>
<span class="nc" id="L104">      setExternalCommand(StringUtils.EMPTY);</span>
    }
<span class="nc bnc" id="L106" title="All 2 branches missed.">    if (data.get(FAIL_ON_ERROR_CODE) == null) {</span>
<span class="nc" id="L107">      setFailOnErrorCode(true);</span>
    }
<span class="nc bnc" id="L109" title="All 2 branches missed.">    if (data.get(FAIL_ON_STANDARD_ERROR) == null) {</span>
<span class="nc" id="L110">      setFailOnStandardError(true);</span>
    }
<span class="nc bnc" id="L112" title="All 2 branches missed.">    if (data.get(LOG_STANDARD_OUT) == null) {</span>
<span class="nc" id="L113">      setLogStandardOut(true);</span>
    }
<span class="nc bnc" id="L115" title="All 2 branches missed.">    if (data.get(LOG_ERROR_OUT) == null) {</span>
<span class="nc" id="L116">      setLogErrorOut(true);</span>
    }
<span class="nc" id="L118">  }</span>

  @Override
  public void initDynamicUiModel() {
<span class="nc" id="L122">    uiModel = new DynamicUiModel(data);</span>
<span class="nc" id="L123">    uiModel.add(new DynamicUiProperty&lt;String&gt;(&quot;settings&quot;));</span>
<span class="nc" id="L124">    final DynamicUiProperty&lt;String&gt; cmd =</span>
        new DynamicUiProperty&lt;String&gt;(
<span class="nc" id="L126">            String.class, EXTERNAL_COMMAND, getExternalCommand());</span>
<span class="nc" id="L127">    cmd.setRequired(true);</span>
<span class="nc" id="L128">    uiModel.add(cmd);</span>
<span class="nc" id="L129">    uiModel.add(</span>
        new DynamicUiProperty&lt;Boolean&gt;(
<span class="nc" id="L131">            Boolean.class, FAIL_ON_ERROR_CODE, isFailOnErrorCode()));</span>
<span class="nc" id="L132">    uiModel.add(</span>
        new DynamicUiProperty&lt;Boolean&gt;(
<span class="nc" id="L134">            Boolean.class, FAIL_ON_STANDARD_ERROR, isFailOnStandardError()));</span>
<span class="nc" id="L135">    uiModel.add(</span>
        new DynamicUiProperty&lt;Boolean&gt;(
<span class="nc" id="L137">            Boolean.class, LOG_STANDARD_OUT, isLogStandardOut()));</span>
<span class="nc" id="L138">    uiModel.add(</span>
        new DynamicUiProperty&lt;Boolean&gt;(
<span class="nc" id="L140">            Boolean.class, LOG_ERROR_OUT, isLogErrorOut()));</span>
<span class="nc" id="L141">    uiModel.add(new DynamicUiProperty&lt;String&gt;(&quot;test&quot;));</span>
<span class="nc" id="L142">    final DynamicUiProperty&lt;byte[]&gt; testPath =</span>
        new DynamicUiProperty&lt;&gt;(byte[].class, &quot;testPath&quot;, null);
<span class="nc" id="L144">    testPath.setTransientValue(true);</span>
<span class="nc" id="L145">    uiModel.add(testPath);</span>
    // ECA-6320 Bug. MyFaces HtmlOutputText and HtmlOutputLabel throw NPE in JSF
    // life cycle -&gt; use disabled text field.
    //        final DynamicUiProperty&lt;String&gt; testOut = new
    // DynamicUiProperty&lt;String&gt;(&quot;testOut&quot;);
    //        testOut.setLabelOnly(false);
    //        testOut.setRenderingHint(DynamicUiProperty.RENDER_LABEL);
    //        uiModel.add(testOut);
<span class="nc" id="L153">    final DynamicUiProperty&lt;String&gt; testOut =</span>
        new DynamicUiProperty&lt;String&gt;(&quot;testOut&quot;);
<span class="nc" id="L155">    testOut.setLabelOnly(false);</span>
<span class="nc" id="L156">    testOut.setRenderingHint(DynamicUiProperty.RENDER_TEXTFIELD);</span>
<span class="nc" id="L157">    testOut.setDisabled(true);</span>
<span class="nc" id="L158">    final DynamicUiProperty&lt;String&gt; testButton =</span>
        new DynamicUiProperty&lt;String&gt;(
            String.class, &quot;testCommand&quot;, &quot;testCommand&quot;);
<span class="nc" id="L161">    testButton.setRenderingHint(DynamicUiProperty.RENDER_BUTTON);</span>
<span class="nc" id="L162">    testButton.setActionCallback(</span>
<span class="nc" id="L163">        new DynamicUiActionCallback() {</span>
          @Override
          @SuppressWarnings(&quot;unchecked&quot;)
          public void action(final Object parameter)
              throws DynamicUiCallbackException {
<span class="nc" id="L168">            final List&lt;String&gt; out = testCommand();</span>
<span class="nc" id="L169">            final Map&lt;Object, Object&gt; oldValues =</span>
<span class="nc" id="L170">                (Map&lt;Object, Object&gt;) data.clone();</span>
<span class="nc" id="L171">            final Map&lt;Object, Object&gt; newValues =</span>
<span class="nc" id="L172">                (Map&lt;Object, Object&gt;) data.clone();</span>
<span class="nc" id="L173">            newValues.put(</span>
                &quot;testOut&quot;,
<span class="nc" id="L175">                StringUtils.join(out, System.getProperty(&quot;line.separator&quot;)));</span>
<span class="nc" id="L176">            newValues.put(&quot;testPath&quot;, &quot;&quot;);</span>
<span class="nc" id="L177">            uiModel.firePropertyChange(oldValues, newValues);</span>
<span class="nc" id="L178">            setTestCertificates(ListUtils.EMPTY_LIST);</span>
<span class="nc" id="L179">          }</span>

          @Override
          public List&lt;String&gt; getRender() {
<span class="nc" id="L183">            return null;</span>
          }
        });
<span class="nc" id="L186">    uiModel.add(testButton);</span>
<span class="nc" id="L187">    uiModel.add(testOut);</span>
<span class="nc" id="L188">  }</span>

  @Override
  public float getLatestVersion() {
<span class="nc" id="L192">    return LATEST_VERSION;</span>
  }

  @Override
  public void upgrade() {
<span class="nc" id="L197">    super.upgrade();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (LOG.isTraceEnabled()) {</span>
<span class="nc" id="L199">      LOG.trace(&quot;&gt;upgrade: &quot; + getLatestVersion() + &quot;, &quot; + getVersion());</span>
    }
<span class="nc bnc" id="L201" title="All 2 branches missed.">    if (Float.compare(LATEST_VERSION, getVersion()) != 0) {</span>
      // New version of the class, upgrade.
<span class="nc" id="L203">      LOG.info(</span>
<span class="nc" id="L204">          INTRES.getLocalizedMessage(</span>
              &quot;validator.implementation.certificate.external&quot;,
<span class="nc" id="L206">              Float.valueOf(getVersion())));</span>
<span class="nc" id="L207">      init();</span>
    }
<span class="nc" id="L209">  }</span>

  @Override
  public List&lt;String&gt; validate(
      final CA ca,
      final Certificate certificate,
      final ExternalScriptsWhitelist externalScriptsWhitelist)
      throws ValidatorNotApplicableException, ValidationException,
          CertificateException {
<span class="nc" id="L218">    final List&lt;String&gt; messages = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L219">    LOG.debug(</span>
<span class="nc" id="L220">        &quot;Validating certificate with external command &quot; + getExternalCommand());</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L222">      LOG.debug(</span>
          &quot;Validating certificate with external command (cert):&quot; + certificate);
    }
    // Add CA certificate chain, that may be processed.
<span class="nc" id="L226">    final List&lt;Certificate&gt; certificates = new ArrayList&lt;Certificate&gt;();</span>
<span class="nc" id="L227">    certificates.add(certificate);</span>
<span class="nc" id="L228">    final String cmd = getExternalCommand();</span>
<span class="nc" id="L229">    final List&lt;String&gt; out = new ArrayList&lt;String&gt;();</span>
    // Run external scripts (is used by publishers as well, writes certificate
    // to disk!).
    try {
<span class="nc" id="L233">      out.addAll(</span>
<span class="nc" id="L234">          runExternalCommandInternal(</span>
              cmd, externalScriptsWhitelist, certificates));
<span class="nc" id="L236">    } catch (ExternalProcessException e) {</span>
<span class="nc" id="L237">      throw new ValidatorNotApplicableException(</span>
          &quot;External command could not be called, because it does not exit,&quot;
              + &quot; command can not be found, access was denied, certificate not&quot;
              + &quot; written, or another error occured: &quot;
<span class="nc" id="L241">              + e.getMessage());</span>
<span class="nc" id="L242">    }</span>
    // Validator was applicable but something bad must have happened, no exit
    // code was returned -&gt; validation failed.
<span class="nc" id="L245">    boolean broken = false;</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">    if (CollectionUtils.isNotEmpty(out)) {</span>
      try {
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (isLogStandardOut()) {</span>
<span class="nc" id="L249">          String stdOutput = null;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">          for (String str : out) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (str.startsWith(ExternalProcessTools.STDOUT_PREFIX)) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">              if (stdOutput == null) {</span>
<span class="nc" id="L253">                stdOutput = str;</span>
              } else {
<span class="nc" id="L255">                stdOutput += &quot;\n&quot; + str;</span>
              }
            }
<span class="nc" id="L258">          }</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">          if (stdOutput != null) {</span>
<span class="nc" id="L260">            LOG.info(&quot;External command logged to STDOUT: &quot; + stdOutput);</span>
          }
        }
<span class="nc" id="L263">        String errOutput = null;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (isLogErrorOut()) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">          for (String str : out) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (str.startsWith(ExternalProcessTools.ERROUT_PREFIX)) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">              if (errOutput == null) {</span>
<span class="nc" id="L268">                errOutput = str;</span>
              } else {
<span class="nc" id="L270">                errOutput += &quot;\n&quot; + str;</span>
              }
            }
<span class="nc" id="L273">          }</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">          if (errOutput != null) {</span>
<span class="nc" id="L275">            LOG.info(&quot;External command logged to ERROUT: &quot; + errOutput);</span>
          }
        }
<span class="nc" id="L278">        final int exitCode =</span>
<span class="nc" id="L279">            Integer.parseInt(</span>
<span class="nc" id="L280">                out.get(0)</span>
<span class="nc" id="L281">                    .replaceFirst(</span>
                        ExternalProcessTools.EXIT_CODE_PREFIX,
                        StringUtils.EMPTY));
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (exitCode != 0</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            &amp;&amp; isFailOnErrorCode()) { // Validation failed: -1 is command could</span>
                                      // not be found or access denied.
<span class="nc" id="L287">          messages.add(&quot;Invalid: External command exit code was &quot; + exitCode);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">          if (errOutput != null) {</span>
<span class="nc" id="L289">            messages.add(&quot;ERROUT was: &quot; + errOutput);</span>
          }
<span class="nc bnc" id="L291" title="All 2 branches missed.">        } else if (isFailOnStandardError()</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            &amp;&amp; ExternalProcessTools.containsErrout(out)) {</span>
<span class="nc" id="L293">          messages.add(</span>
              &quot;Invalid: External command logged to ERROUT. Exit code was &quot;
                  + exitCode);
<span class="nc bnc" id="L296" title="All 2 branches missed.">          if (errOutput != null) {</span>
<span class="nc" id="L297">            messages.add(&quot;ERROUT was: &quot; + errOutput);</span>
          }
        }
<span class="nc" id="L300">      } catch (Exception e2) { // In case exit code could not be parsed.</span>
<span class="nc" id="L301">        broken = true;</span>
<span class="nc" id="L302">      }</span>
    } else {
<span class="nc" id="L304">      broken = true;</span>
    }
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (broken) {</span>
<span class="nc" id="L307">      messages.add(</span>
          &quot;Invalid: External command could not be initialized: '&quot;
              + cmd
              + &quot;'. Command failed.&quot;);
    }
<span class="nc" id="L312">    return messages;</span>
  }

  @Override
  public String getLabel() {
<span class="nc" id="L317">    return INTRES.getLocalizedMessage(</span>
        &quot;validator.implementation.certificate.external&quot;);
  }

  @Override
  public String getValidatorTypeIdentifier() {
<span class="nc" id="L323">    return TYPE_IDENTIFIER;</span>
  }

  @Override
  protected Class&lt;? extends Profile&gt; getImplementationClass() {
<span class="nc" id="L328">    return ExternalCommandCertificateValidator.class;</span>
  }

  /**
   * Sets the external script path.
   *
   * @param path the path.
   */
  public void setExternalCommand(final String path) {
<span class="nc" id="L337">    data.put(EXTERNAL_COMMAND, path);</span>
<span class="nc" id="L338">  }</span>

  /**
   * Gets the external script path.
   *
   * @return the path.
   */
  public String getExternalCommand() {
<span class="nc" id="L346">    return (String) data.get(EXTERNAL_COMMAND);</span>
  }

  /**
   * Denotes if the STDOUT of the external command or script has to be logged.
   *
   * @param state true if enabled.
   */
  public void setLogStandardOut(final boolean state) {
<span class="nc" id="L355">    data.put(LOG_STANDARD_OUT, Boolean.valueOf(state));</span>
<span class="nc" id="L356">  }</span>

  /**
   * Denotes if the STDOUT of the external command or script has to be logged.
   *
   * @return true if enabled.
   */
  public boolean isLogStandardOut() {
<span class="nc" id="L364">    return ((Boolean) data.get(LOG_STANDARD_OUT)).booleanValue();</span>
  }

  /**
   * Denotes if the ERROUT of the external command or script has to be logged.
   *
   * @param state true if enabled.
   */
  public void setLogErrorOut(final boolean state) {
<span class="nc" id="L373">    data.put(LOG_ERROR_OUT, Boolean.valueOf(state));</span>
<span class="nc" id="L374">  }</span>

  /**
   * Denotes if the ERROUT of the external command or script has to be logged.
   *
   * @return true if enabled.
   */
  public boolean isLogErrorOut() {
<span class="nc" id="L382">    return ((Boolean) data.get(LOG_ERROR_OUT)).booleanValue();</span>
  }

  /**
   * Denotes if the command or script has to be considered as failed if the exit
   * code is larger than 0.
   *
   * @param state true if enabled.
   */
  public void setFailOnErrorCode(final boolean state) {
<span class="nc" id="L392">    data.put(FAIL_ON_ERROR_CODE, Boolean.valueOf(state));</span>
<span class="nc" id="L393">  }</span>

  /**
   * Denotes if the command or script has to be considered as failed if the exit
   * code is larger than 0.
   *
   * @return true if enabled.
   */
  public boolean isFailOnErrorCode() {
<span class="nc" id="L402">    return ((Boolean) data.get(FAIL_ON_ERROR_CODE)).booleanValue();</span>
  }

  /**
   * Denotes if the command or script has to be considered as failed if a log
   * was written to ERROUT.
   *
   * @param state true if enabled.
   */
  public void setFailOnStandardError(final boolean state) {
<span class="nc" id="L412">    data.put(FAIL_ON_STANDARD_ERROR, Boolean.valueOf(state));</span>
<span class="nc" id="L413">  }</span>

  /**
   * Denotes if the command or script has to be considered as failed if a log
   * was written to ERROUT.
   *
   * @return true if enabled.
   */
  public boolean isFailOnStandardError() {
<span class="nc" id="L422">    return ((Boolean) data.get(FAIL_ON_STANDARD_ERROR)).booleanValue();</span>
  }

  /**
   * Tests the external command with the uploaded test certificate.
   *
   * @return a list with size &amp;gt; 0 and the exit code in field with index 0 and
   *     STDOUT and ERROR appended subsequently.
   * @throws DynamicUiCallbackException if the external script path does not
   *     exist or accessible or the script call fails otherwise.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public List&lt;String&gt; testCommand() throws DynamicUiCallbackException {
<span class="nc" id="L435">    LOG.info(</span>
<span class="nc" id="L436">        &quot;Test external command certificate validator: &quot; + getProfileName());</span>
<span class="nc" id="L437">    final DynamicUiProperty&lt;byte[]&gt; property =</span>
<span class="nc" id="L438">        (DynamicUiProperty&lt;byte[]&gt;) uiModel.getProperties().get(&quot;testPath&quot;);</span>
<span class="nc" id="L439">    final List&lt;String&gt; out = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L440">    byte[] data = null;</span>
<span class="nc" id="L441">    String message = null;</span>
    // inner assignment here protects against hull pointer
<span class="nc bnc" id="L443" title="All 4 branches missed.">    if (property != null &amp;&amp; (data = property.getValue()) != null) {</span>
      final File file;
      try {
<span class="nc" id="L446">        file =</span>
<span class="nc" id="L447">            ExternalProcessTools.writeTemporaryFileToDisk(</span>
                data,
                &quot;validator_test_cert&quot;, /* use .tmp as file extension */
                null);
<span class="nc" id="L451">      } catch (ExternalProcessException e) {</span>
<span class="nc" id="L452">        throw new IllegalStateException(</span>
            &quot;Failed to save upload to temporary file&quot;, e);
<span class="nc" id="L454">      }</span>
      try {
<span class="nc bnc" id="L456" title="All 2 branches missed.">        if (!file.canRead()) {</span>
<span class="nc" id="L457">          message =</span>
<span class="nc" id="L458">              INTRES.getLocalizedMessage(</span>
                  &quot;validator.certificate.externalcommand.testfilenopermission&quot;,
<span class="nc" id="L460">                  file.getAbsolutePath());</span>
        }
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (message == null) {</span>
          try {
<span class="nc" id="L464">            setTestCertificates(</span>
<span class="nc" id="L465">                CertTools.getCertsFromPEM(</span>
<span class="nc" id="L466">                    file.getAbsolutePath(), Certificate.class));</span>
<span class="nc" id="L467">          } catch (IOException e) {</span>
<span class="nc" id="L468">            message =</span>
<span class="nc" id="L469">                INTRES.getLocalizedMessage(</span>
<span class="nc" id="L470">                    &quot;process.certificate.filenotfound&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L471">            LOG.warn(message, e);</span>
<span class="nc" id="L472">          } catch (CertificateParsingException e) {</span>
<span class="nc" id="L473">            message =</span>
<span class="nc" id="L474">                INTRES.getLocalizedMessage(</span>
                    &quot;process.certificate.couldnotbeparsed&quot;,
<span class="nc" id="L476">                    file.getAbsolutePath());</span>
<span class="nc" id="L477">            LOG.warn(message, e);</span>
<span class="nc" id="L478">          }</span>
        }
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (message == null) { // Run command.</span>
          try {
<span class="nc" id="L482">            out.addAll(</span>
<span class="nc" id="L483">                runExternalCommandInternal(</span>
<span class="nc" id="L484">                    getExternalCommand(),</span>
<span class="nc" id="L485">                    ExternalScriptsWhitelist.permitAll(),</span>
<span class="nc" id="L486">                    getTestCertificates()));</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L488">              LOG.debug(</span>
                  &quot;Tested certificate with external command STOUT/ERROUT:&quot;
<span class="nc" id="L490">                      + System.getProperty(&quot;line.separator&quot;)</span>
                      + out);
            }
<span class="nc" id="L493">          } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L494">            message =</span>
<span class="nc" id="L495">                INTRES.getLocalizedMessage(</span>
                    &quot;process.certificate.couldnotbeencoded&quot;,
<span class="nc" id="L497">                    file.getAbsolutePath());</span>
<span class="nc" id="L498">            LOG.info(message, e);</span>
            // 1. command not found, no permission or other exception; 2. not in
            // whitelist.
<span class="nc" id="L501">          } catch (ExternalProcessException</span>
              | ValidatorNotApplicableException e) {
<span class="nc" id="L503">            message = e.getMessage();</span>
<span class="nc" id="L504">            LOG.info(message, e);</span>
<span class="nc" id="L505">          }</span>
        }
      } finally {
        // Delete temporary file (file is written because of file upload).
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (file != null) {</span>
          try {
<span class="nc" id="L511">            file.delete();</span>
<span class="nc" id="L512">          } catch (RuntimeException e) {</span>
<span class="nc" id="L513">            LOG.trace(</span>
<span class="nc" id="L514">                &quot;Could not delete temporary file: &quot; + file.getAbsolutePath(),</span>
                e);
<span class="nc" id="L516">          }</span>
        }
      }
<span class="nc" id="L519">    } else {</span>
<span class="nc" id="L520">      message =</span>
<span class="nc" id="L521">          INTRES.getLocalizedMessage(</span>
              &quot;validator.certificate.externalcommand.testfilemissing&quot;,
<span class="nc" id="L523">              getExternalCommand());</span>
<span class="nc" id="L524">      LOG.info(message);</span>
    }
<span class="nc bnc" id="L526" title="All 2 branches missed.">    if (StringUtils.isNotBlank(message)) {</span>
<span class="nc" id="L527">      throw new DynamicUiCallbackException(message);</span>
    }
<span class="nc" id="L529">    return out;</span>
  }

  /**
   * Gets the list of test certificates uploaded by the user.
   *
   * @return the list of test certificates.
   */
  public List&lt;Certificate&gt; getTestCertificates() {
<span class="nc" id="L538">    return testCertificates;</span>
  }

  /**
   * Sets the list of test certificates uploaded by the user.
   *
   * @param aTestCertificates the list.
   */
  public void setTestCertificates(final List&lt;Certificate&gt; aTestCertificates) {
<span class="nc" id="L547">    this.testCertificates = aTestCertificates;</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L549">      LOG.debug(&quot;Test certificates uploaded: &quot; + aTestCertificates);</span>
    }
<span class="nc" id="L551">  }</span>

  /**
   * @return Platform
   */
  public String getPlatform() {
<span class="nc" id="L557">    return ExternalProcessTools.getPlatformString();</span>
  }

  /**
   * Runs the external command.
   *
   * @param externalCommand the external command.
   * @param externalScriptsWhitelist whitelist
   * @param certificates the list of certificates.
   * @return a string list holding exit code at index 0, and the STDOUT and
   *     ERROUT appended.
   * @throws CertificateEncodingException if the certificates could not be
   *     encoded.
   * @throws ExternalProcessException if the command wasn't found
   * @throws ValidatorNotApplicableException if external scripts whitelist
   *     wasn't permitted
   */
  private List&lt;String&gt; runExternalCommandInternal(
      final String externalCommand,
      final ExternalScriptsWhitelist externalScriptsWhitelist,
      final List&lt;Certificate&gt; certificates)
      throws CertificateEncodingException, ExternalProcessException,
          ValidatorNotApplicableException {
<span class="nc" id="L580">    final String cmd = extractCommand(externalCommand);</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">    if (!externalScriptsWhitelist.isPermitted(cmd)) {</span>
<span class="nc" id="L582">      throw new ValidatorNotApplicableException(</span>
<span class="nc" id="L583">          INTRES.getLocalizedMessage(&quot;process.whitelist.error.notlisted&quot;, cmd));</span>
    }
    // Test if specified script file exists and is executable (hits files and
    // symbolic links, but no aliases).
<span class="nc bnc" id="L587" title="All 2 branches missed.">    if (StringUtils.isNotBlank(cmd)) {</span>
<span class="nc" id="L588">      final File file = new File(cmd);</span>
      String message;
<span class="nc bnc" id="L590" title="All 2 branches missed.">      if (!file.exists()) {</span>
<span class="nc" id="L591">        message = INTRES.getLocalizedMessage(&quot;process.commandnotfound&quot;, cmd);</span>
<span class="nc" id="L592">        LOG.info(message);</span>
<span class="nc" id="L593">        throw new ExternalProcessException(message);</span>
      }
<span class="nc bnc" id="L595" title="All 2 branches missed.">      if (!file.canExecute()) {</span>
<span class="nc" id="L596">        message =</span>
<span class="nc" id="L597">            INTRES.getLocalizedMessage(&quot;process.commandnopermission&quot;, cmd);</span>
<span class="nc" id="L598">        LOG.info(message);</span>
<span class="nc" id="L599">        throw new ExternalProcessException(message);</span>
      }
    }
    // Extract arguments and run external script.
<span class="nc" id="L603">    final List&lt;String&gt; arguments = extractArguments(externalCommand);</span>
<span class="nc" id="L604">    final List&lt;String&gt; out = new ArrayList&lt;String&gt;();</span>
    try {
<span class="nc" id="L606">      out.addAll(</span>
<span class="nc" id="L607">          ExternalProcessTools.launchExternalCommand(</span>
              cmd,
<span class="nc" id="L609">              certificates.get(0).getEncoded(),</span>
<span class="nc" id="L610">              isFailOnErrorCode(),</span>
<span class="nc" id="L611">              isFailOnStandardError(),</span>
<span class="nc" id="L612">              isLogStandardOut(),</span>
<span class="nc" id="L613">              isLogErrorOut(),</span>
              arguments,
<span class="nc" id="L615">              ExternalCommandCertificateValidator.class.getName()));</span>
<span class="nc" id="L616">    } catch (ExternalProcessException e) {</span>
<span class="nc" id="L617">      LOG.info(</span>
          &quot;Could not call external command '&quot;
              + cmd
              + &quot;' with arguments &quot;
              + arguments
              + &quot; sucessfully: &quot;
<span class="nc" id="L623">              + e.getMessage());</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">      if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L625">        LOG.debug(&quot;Failed with exception: &quot;, e);</span>
      }
<span class="nc bnc" id="L627" title="All 2 branches missed.">      if (e.getOut() != null) {</span>
<span class="nc" id="L628">        out.addAll(e.getOut());</span>
      }
<span class="nc" id="L630">    }</span>
<span class="nc" id="L631">    return out;</span>
  }

  /**
   * Extracts the script path.
   *
   * @param ocmd the external command.
   * @return the script path (first token in command).
   */
  private String extractCommand(final String ocmd) {
<span class="nc" id="L641">    String cmd = ocmd.trim();</span>
<span class="nc" id="L642">    final int index = cmd.indexOf(&quot; &quot;);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">    if (index &gt; 0) {</span>
<span class="nc" id="L644">      cmd = cmd.substring(0, index).trim();</span>
    }
<span class="nc bnc" id="L646" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L647">      LOG.debug(&quot;Command extracted: &quot; + cmd);</span>
    }
<span class="nc" id="L649">    return cmd;</span>
  }

  /**
   * Extracts the arguments.
   *
   * @param ocmd the external command.
   * @return the list of arguments (second token to end).
   */
  private List&lt;String&gt; extractArguments(final String ocmd) {
<span class="nc" id="L659">    String cmd = ocmd.trim();</span>
<span class="nc" id="L660">    final List&lt;String&gt; arguments = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L661">    final int index = cmd.indexOf(&quot; &quot;);</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">    if (index &gt; 0) {</span>
<span class="nc" id="L663">      arguments.addAll(</span>
<span class="nc" id="L664">          Arrays.asList(</span>
<span class="nc" id="L665">              StringUtils.split(</span>
<span class="nc" id="L666">                  cmd.substring(index, cmd.length()).trim(), &quot; &quot;)));</span>
    }
<span class="nc bnc" id="L668" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L669">      LOG.debug(&quot;Arguments extracted: &quot; + arguments);</span>
    }
<span class="nc" id="L671">    return arguments;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>