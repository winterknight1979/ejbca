<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>CertificateExtensionFactory.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate.certextensions</a> &gt; <span class="el_source">CertificateExtensionFactory.java</span></div><h1>CertificateExtensionFactory.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate.certextensions;

import java.lang.reflect.InvocationTargetException;
import java.util.HashMap;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.ocsp.OCSPObjectIdentifiers;
import org.bouncycastle.asn1.x509.Extension;
import org.cesecore.certificates.certificate.certextensions.standard.AuthorityInformationAccess;
import org.cesecore.certificates.certificate.certextensions.standard.AuthorityKeyIdentifier;
import org.cesecore.certificates.certificate.certextensions.standard.BasicConstraint;
import org.cesecore.certificates.certificate.certextensions.standard.CertificatePolicies;
import org.cesecore.certificates.certificate.certextensions.standard.CrlDistributionPoints;
import org.cesecore.certificates.certificate.certextensions.standard.DocumentTypeList;
import org.cesecore.certificates.certificate.certextensions.standard.ExtendedKeyUsage;
import org.cesecore.certificates.certificate.certextensions.standard.FreshestCrl;
import org.cesecore.certificates.certificate.certextensions.standard.IssuerAltNames;
import org.cesecore.certificates.certificate.certextensions.standard.KeyUsage;
import org.cesecore.certificates.certificate.certextensions.standard.MsTemplate;
import org.cesecore.certificates.certificate.certextensions.standard.NameConstraint;
import org.cesecore.certificates.certificate.certextensions.standard.OcspNoCheck;
import org.cesecore.certificates.certificate.certextensions.standard.PrivateKeyUsagePeriod;
import org.cesecore.certificates.certificate.certextensions.standard.QcStatement;
import org.cesecore.certificates.certificate.certextensions.standard.SeisCardNumber;
import org.cesecore.certificates.certificate.certextensions.standard.StandardCertificateExtension;
import org.cesecore.certificates.certificate.certextensions.standard.SubjectAltNames;
import org.cesecore.certificates.certificate.certextensions.standard.SubjectDirectoryAttributes;
import org.cesecore.certificates.certificate.certextensions.standard.SubjectKeyIdentifier;
import org.cesecore.certificates.certificateprofile.CertificateProfile;
import org.cesecore.internal.InternalResources;
import org.cesecore.util.CertTools;

/**
 * Class parsing the modules/ejbca-common/src/certextensions.properties file and
 * maintains a set of available custom extensions to the system.
 *
 * &lt;p&gt;It is also responsible for creating the actual CertificateExtensions used
 * in certificate generation.
 *
 * &lt;p&gt;It also keep a list of standard (not custom) built in extensions.
 *
 * @version $Id: CertificateExtensionFactory.java 22142 2015-11-03 14:15:51Z
 *     mikekushner $
 */
public final class CertificateExtensionFactory {

    /** Logger. */
<span class="fc" id="L59">  private static final Logger LOG =</span>
<span class="fc" id="L60">      Logger.getLogger(CertificateExtensionFactory.class);</span>
  /** Internal resources. */
  private static final InternalResources INTRES =
<span class="fc" id="L63">      InternalResources.getInstance();</span>

  /** Singleton instance. */
<span class="fc" id="L66">  private static CertificateExtensionFactory instance = null;</span>

  /** Standard extensions. */
<span class="fc" id="L69">  private HashMap&lt;String, String&gt; standardCertificateExtensions =</span>
      new HashMap&lt;String, String&gt;();

  {
<span class="fc" id="L73">    standardCertificateExtensions.put(</span>
<span class="fc" id="L74">        Extension.basicConstraints.getId(), BasicConstraint.class.getName());</span>
<span class="fc" id="L75">    standardCertificateExtensions.put(</span>
<span class="fc" id="L76">        Extension.subjectKeyIdentifier.getId(),</span>
<span class="fc" id="L77">        SubjectKeyIdentifier.class.getName());</span>
<span class="fc" id="L78">    standardCertificateExtensions.put(</span>
<span class="fc" id="L79">        Extension.authorityKeyIdentifier.getId(),</span>
<span class="fc" id="L80">        AuthorityKeyIdentifier.class.getName());</span>
<span class="fc" id="L81">    standardCertificateExtensions.put(</span>
<span class="fc" id="L82">        Extension.keyUsage.getId(), KeyUsage.class.getName());</span>
<span class="fc" id="L83">    standardCertificateExtensions.put(</span>
<span class="fc" id="L84">        Extension.extendedKeyUsage.getId(), ExtendedKeyUsage.class.getName());</span>
<span class="fc" id="L85">    standardCertificateExtensions.put(</span>
<span class="fc" id="L86">        Extension.subjectAlternativeName.getId(),</span>
<span class="fc" id="L87">        SubjectAltNames.class.getName());</span>
<span class="fc" id="L88">    standardCertificateExtensions.put(</span>
<span class="fc" id="L89">        Extension.issuerAlternativeName.getId(),</span>
<span class="fc" id="L90">        IssuerAltNames.class.getName());</span>
<span class="fc" id="L91">    standardCertificateExtensions.put(</span>
<span class="fc" id="L92">        &quot;2.23.136.1.1.6.2&quot;, DocumentTypeList.class.getName());</span>
<span class="fc" id="L93">    standardCertificateExtensions.put(</span>
<span class="fc" id="L94">        Extension.cRLDistributionPoints.getId(),</span>
<span class="fc" id="L95">        CrlDistributionPoints.class.getName());</span>
<span class="fc" id="L96">    standardCertificateExtensions.put(</span>
<span class="fc" id="L97">        Extension.freshestCRL.getId(), FreshestCrl.class.getName());</span>
<span class="fc" id="L98">    standardCertificateExtensions.put(</span>
<span class="fc" id="L99">        Extension.certificatePolicies.getId(),</span>
<span class="fc" id="L100">        CertificatePolicies.class.getName());</span>
<span class="fc" id="L101">    standardCertificateExtensions.put(</span>
<span class="fc" id="L102">        Extension.subjectDirectoryAttributes.getId(),</span>
<span class="fc" id="L103">        SubjectDirectoryAttributes.class.getName());</span>
<span class="fc" id="L104">    standardCertificateExtensions.put(</span>
<span class="fc" id="L105">        Extension.authorityInfoAccess.getId(),</span>
<span class="fc" id="L106">        AuthorityInformationAccess.class.getName());</span>
<span class="fc" id="L107">    standardCertificateExtensions.put(</span>
<span class="fc" id="L108">        Extension.qCStatements.getId(), QcStatement.class.getName());</span>
<span class="fc" id="L109">    standardCertificateExtensions.put(</span>
<span class="fc" id="L110">        Extension.nameConstraints.getId(), NameConstraint.class.getName());</span>
<span class="fc" id="L111">    standardCertificateExtensions.put(</span>
<span class="fc" id="L112">        OCSPObjectIdentifiers.id_pkix_ocsp_nocheck.getId(),</span>
<span class="fc" id="L113">        OcspNoCheck.class.getName());</span>
<span class="fc" id="L114">    standardCertificateExtensions.put(</span>
<span class="fc" id="L115">        CertTools.OID_MSTEMPLATE, MsTemplate.class.getName());</span>
<span class="fc" id="L116">    standardCertificateExtensions.put(</span>
<span class="fc" id="L117">        SeisCardNumber.OID_CARDNUMBER, SeisCardNumber.class.getName());</span>
<span class="fc" id="L118">    standardCertificateExtensions.put(</span>
<span class="fc" id="L119">        Extension.privateKeyUsagePeriod.getId(),</span>
<span class="fc" id="L120">        PrivateKeyUsagePeriod.class.getName());</span>
  }

<span class="fc" id="L123">  private CertificateExtensionFactory() { }</span>

  /**
   * Method used to get the instance of the factory. If it is the first time the
   * method is called will the configuration file be parsed.
   *
   * @return The factory instance
   */
  public static CertificateExtensionFactory getInstance() {
<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (instance == null) {</span>
<span class="fc" id="L133">      instance = new CertificateExtensionFactory();</span>
    }

<span class="fc" id="L136">    return instance;</span>
  }

  /**
   * Method returning the instance of the standard CertificateExtension given
   * its object identifier.
   *
   * @param oid OID
   * @param certProf Profile
   * @return null if the CertificateExtension doesn't exist
   */
  public CertificateExtension getStandardCertificateExtension(
      final String oid, final CertificateProfile certProf) {
<span class="fc" id="L149">    StandardCertificateExtension ret = null;</span>
<span class="fc" id="L150">    final String classPath = (String) standardCertificateExtensions.get(oid);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">    if (classPath != null) {</span>
      try {
<span class="fc" id="L153">        final Class&lt;?&gt; implClass = Class.forName(classPath);</span>
<span class="fc" id="L154">        ret =</span>
            (StandardCertificateExtension)
<span class="fc" id="L156">                implClass.getConstructor().newInstance();</span>
<span class="fc" id="L157">        ret.init(certProf);</span>
<span class="nc" id="L158">      } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L159">        LOG.error(</span>
<span class="nc" id="L160">            INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid), e);</span>
<span class="nc" id="L161">      } catch (InstantiationException e) {</span>
<span class="nc" id="L162">        LOG.error(</span>
<span class="nc" id="L163">            INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid), e);</span>
<span class="nc" id="L164">      } catch (IllegalAccessException e) {</span>
<span class="nc" id="L165">        LOG.error(</span>
<span class="nc" id="L166">            INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid), e);</span>
<span class="nc" id="L167">      } catch (InvocationTargetException e) {</span>
<span class="nc" id="L168">        LOG.error(</span>
<span class="nc" id="L169">            INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid), e);</span>
<span class="nc" id="L170">      } catch (NoSuchMethodException e) {</span>
<span class="nc" id="L171">        LOG.error(</span>
<span class="nc" id="L172">            INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid), e);</span>
<span class="pc" id="L173">      }</span>
    }
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">    if (ret == null) {</span>
<span class="nc" id="L176">      LOG.error(INTRES.getLocalizedMessage(&quot;certext.noextensionforid&quot;, oid));</span>
    }
<span class="fc" id="L178">    return ret;</span>
  }

  /** Method used for testing to be able to reset class between tests. */
  protected static void resetExtensions() {
<span class="fc" id="L183">    instance = null;</span>
<span class="fc" id="L184">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>