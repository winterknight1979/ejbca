<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PKIXCertRevocationStatusChecker.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Unit Test Aggregator</a> &gt; <a href="../index.html" class="el_bundle">cesecore-common</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.util</a> &gt; <span class="el_source">PKIXCertRevocationStatusChecker.java</span></div><h1>PKIXCertRevocationStatusChecker.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.util;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.math.BigInteger;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.NoSuchProviderException;
import java.security.SignatureException;
import java.security.cert.CRL;
import java.security.cert.CRLException;
import java.security.cert.CertPathValidatorException;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.security.cert.PKIXCertPathChecker;
import java.security.cert.X509CRL;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashSet;
import java.util.Random;
import java.util.Set;
import org.apache.commons.io.IOUtils;
import org.apache.commons.io.output.NullOutputStream;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.bouncycastle.asn1.ASN1InputStream;
import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.DEROctetString;
import org.bouncycastle.asn1.ocsp.OCSPObjectIdentifiers;
import org.bouncycastle.asn1.x509.Extension;
import org.bouncycastle.asn1.x509.Extensions;
import org.bouncycastle.cert.X509CertificateHolder;
import org.bouncycastle.cert.ocsp.BasicOCSPResp;
import org.bouncycastle.cert.ocsp.CertificateID;
import org.bouncycastle.cert.ocsp.CertificateStatus;
import org.bouncycastle.cert.ocsp.OCSPException;
import org.bouncycastle.cert.ocsp.OCSPReq;
import org.bouncycastle.cert.ocsp.OCSPReqBuilder;
import org.bouncycastle.cert.ocsp.OCSPResp;
import org.bouncycastle.cert.ocsp.OCSPRespBuilder;
import org.bouncycastle.cert.ocsp.SingleResp;
import org.bouncycastle.cert.ocsp.jcajce.JcaCertificateID;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.operator.jcajce.JcaContentVerifierProviderBuilder;
import org.cesecore.certificates.ocsp.SHA1DigestCalculator;

/**
 * A class to check whether a certificate is revoked or not using either OCSP or
 * CRL. The revocation status will first be obtained using OCSP. If it turned
 * out that that was not possible for some reason, a CRL will be used instead.
 * If it was not possible to check the CRL for some reason, an exception will be
 * thrown.
 *
 * @version $Id: PKIXCertRevocationStatusChecker.java 24567 2016-10-25 05:36:17Z
 *     anatom $
 */
public class PKIXCertRevocationStatusChecker extends PKIXCertPathChecker {

    /** Logger. */
<span class="nc" id="L85">    private final Logger log =</span>
<span class="nc" id="L86">      Logger.getLogger(PKIXCertRevocationStatusChecker.class);</span>
    /** oCSP. */
  private final String ocspUrl;
  /** CRL. */
  private final String crlUrl;
  /** Issuer. */
  private final X509Certificate issuerCert;
  /** Certs. */
  private final Collection&lt;X509Certificate&gt; caCerts;
  /** Response. */
<span class="nc" id="L96">  private SingleResp ocspResponse = null;</span>
  /** CRL. */
<span class="nc" id="L98">  private CRL crl = null;</span>

  /**
   * With this constructor, the certificate revocation status will be checked
   * using a CRL fetched using a URL extracted from the certificate's CRL
   * Distribution Points extension.
   *
   * @param anIssuerCert The certificate of the issuer of the certificate whose
   *     revocation status is to be checked. if 'null', the issuer certificate
   *     will be looked for among the certificates specified in 'cacerts'
   * @param cacerts A collection of certificates where one of them is the
   *     certificate of the issuer of the certificate whose status is to be
   *     checked. This parameter will be used only if 'issuerCert' is null
   */
  public PKIXCertRevocationStatusChecker(
      final X509Certificate anIssuerCert,
<span class="nc" id="L114">      final Collection&lt;X509Certificate&gt; cacerts) {</span>
<span class="nc" id="L115">    this.ocspUrl = null;</span>
<span class="nc" id="L116">    this.crlUrl = null;</span>
<span class="nc" id="L117">    this.issuerCert = anIssuerCert;</span>
<span class="nc" id="L118">    this.caCerts = cacerts;</span>
<span class="nc" id="L119">  }</span>

  /**
   * @param ocspurl The URL to use when sending an OCSP request. If 'null', the
   *     OCSP URL will be extracted from the certificate's
   *     AuthorityInformationAccess extension if it exists.
   * @param crlurl The URL to fetch the CRL from. If 'null', the CRL URL will be
   *     extracted from the certificate's CRLDistributionPoints extension if
   *     exists.
   * @param anIssuerCert The certificate of the issuer of the certificate whose
   *     revocation status is to be checked. if 'null', the issuer certificate
   *     will be looked for among the certificates specified in 'cacerts'
   * @param cacerts A collection of certificates where one of them is the
   *     certificate of the issuer of the certificate whose status is to be
   *     checked. This parameter will be used only if 'issuerCert' is null
   */
  public PKIXCertRevocationStatusChecker(
      final String ocspurl,
      final String crlurl,
      final X509Certificate anIssuerCert,
<span class="nc" id="L139">      final Collection&lt;X509Certificate&gt; cacerts) {</span>
<span class="nc" id="L140">    this.ocspUrl = ocspurl;</span>
<span class="nc" id="L141">    this.crlUrl = crlurl;</span>
<span class="nc" id="L142">    this.issuerCert = anIssuerCert;</span>
<span class="nc" id="L143">    this.caCerts = cacerts;</span>
<span class="nc" id="L144">  }</span>

  @Override
<span class="nc" id="L147">  public void init(final boolean forward) throws CertPathValidatorException { }</span>

  @Override
  public boolean isForwardCheckingSupported() {
    // Not used
<span class="nc" id="L152">    return true;</span>
  }

  @Override
  public Set&lt;String&gt; getSupportedExtensions() {
<span class="nc" id="L157">    ArrayList&lt;String&gt; exts = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L158">    exts.add(Extension.cRLDistributionPoints.getId());</span>
<span class="nc" id="L159">    exts.add(Extension.authorityInfoAccess.getId());</span>
<span class="nc" id="L160">    return new HashSet&lt;String&gt;(exts);</span>
  }

  /**
   * @return The OCSP response containing the certificate status of the saught
   *     out certificate. Or 'null' if an OCSP response could not be obtained
   *     for any reason.
   */
  public SingleResp getOCSPResponse() {
<span class="nc" id="L169">    return this.ocspResponse;</span>
  }

  /**
   * @return The CRLs that were checked. Or an empty Collection if no CRLs were
   *     checked
   */
  public CRL getcrl() {
<span class="nc" id="L177">    return this.crl;</span>
  }

  /**
   * Resets the OCSP response, the checked CRLs and whether the certificate was
   * revoked in case the same instance of this class is used to check the
   * revocation status of more that one certificate.
   */
  private void clearResult() {
<span class="nc" id="L186">    this.ocspResponse = null;</span>
<span class="nc" id="L187">    this.crl = null;</span>
<span class="nc" id="L188">  }</span>

  /**
   * Checks the revocation status of 'cert'; first by sending on OCSP request.
   * If that fails for any reason, then through a CRL
   */
  @Override
  public void check(
          final Certificate cert, final Collection&lt;String&gt; unresolvedCritExts)
      throws CertPathValidatorException {

<span class="nc" id="L199">    clearResult();</span>
<span class="nc" id="L200">    Certificate cacert = getCaCert(cert);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">    if (cacert == null) {</span>
<span class="nc" id="L202">      final String msg =</span>
          &quot;No issuer CA certificate was found. An issuer CA certificate is&quot;
              + &quot; needed to create an OCSP request and to get the right CRL&quot;;
<span class="nc" id="L205">      log.info(msg);</span>
<span class="nc" id="L206">      throw new CertPathValidatorException(msg);</span>
    }

<span class="nc" id="L209">    ArrayList&lt;String&gt; ocspurls = getOcspUrls(cert);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (!ocspurls.isEmpty()) {</span>
<span class="nc" id="L211">      BigInteger certSerialnumber = CertTools.getSerialNumber(cert);</span>
<span class="nc" id="L212">      byte[] nonce = new byte[16];</span>
<span class="nc" id="L213">      final Random randomSource = new Random();</span>
<span class="nc" id="L214">      randomSource.nextBytes(nonce);</span>
<span class="nc" id="L215">      OCSPReq req = null;</span>
      try {
<span class="nc" id="L217">        req = getOcspRequest(cacert, certSerialnumber, nonce);</span>
<span class="nc" id="L218">      } catch (CertificateEncodingException | OCSPException e) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L220">          log.debug(</span>
<span class="nc" id="L221">              &quot;Failed to create OCSP request. &quot; + e.getLocalizedMessage());</span>
        }
<span class="nc" id="L223">        fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>
<span class="nc" id="L224">        return;</span>
<span class="nc" id="L225">      }</span>

<span class="nc" id="L227">      final int httpOk = 200;</span>
<span class="nc" id="L228">      SingleResp ocspResp = null;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">      for (String url : ocspurls) {</span>
<span class="nc" id="L230">        ocspResp =</span>
<span class="nc" id="L231">            getOCSPResponse(</span>
                url, req, cert, nonce, OCSPRespBuilder.SUCCESSFUL, httpOk);
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (ocspResp != null) {</span>
<span class="nc" id="L234">          log.info(&quot;Obtained OCSP response from &quot; + url);</span>
<span class="nc" id="L235">          break;</span>
        } else {
<span class="nc bnc" id="L237" title="All 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L238">            log.debug(&quot;Failed to obtain an OCSP reponse from &quot; + url);</span>
          }
        }
<span class="nc" id="L241">      }</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">      if (ocspResp == null) {</span>
<span class="nc" id="L244">        log.info(</span>
            &quot;Failed to check certificate revocation status using OCSP. Falling&quot;
                + &quot; back to check using CRL&quot;);
<span class="nc" id="L247">        fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>
      } else {
<span class="nc" id="L249">        CertificateStatus status = ocspResp.getCertStatus();</span>
<span class="nc" id="L250">        this.ocspResponse = ocspResp;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L252">          log.debug(</span>
              &quot;The certificate status is: &quot;
<span class="nc bnc" id="L254" title="All 2 branches missed.">                  + (status == null ? &quot;Good&quot; : status.toString()));</span>
        }
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (status != null) { // status==null -&gt; certificate OK</span>
<span class="nc" id="L257">          throw new CertPathValidatorException(</span>
              &quot;Certificate with serialnumber &quot;
<span class="nc" id="L259">                  + CertTools.getSerialNumberAsString(cert)</span>
                  + &quot; was revoked&quot;);
        }

<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (unresolvedCritExts != null) {</span>
<span class="nc" id="L264">          unresolvedCritExts.remove(Extension.authorityInfoAccess.getId());</span>
        }
      }

<span class="nc" id="L268">    } else {</span>
<span class="nc" id="L269">      fallBackToCrl(cert, CertTools.getSubjectDN(cacert));</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">      if (unresolvedCritExts != null) {</span>
<span class="nc" id="L272">        unresolvedCritExts.remove(Extension.cRLDistributionPoints.getId());</span>
      }
    }
<span class="nc" id="L275">  }</span>

  /**
   * Check the revocation status of 'cert' using a CRL.
   *
   * @param cert the certificate whose revocation status is to be checked
   * @param issuerDN DN
   * @throws CertPathValidatorException if invalid
   */
  private void fallBackToCrl(final Certificate cert, final String issuerDN)
      throws CertPathValidatorException {
<span class="nc" id="L286">    final ArrayList&lt;URL&gt; crlUrls = getCrlUrl(cert);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">    if (crlUrls.isEmpty()) {</span>
<span class="nc" id="L288">      final String errmsg =</span>
          &quot;Failed to verify certificate status using the fallback CRL method.&quot;
              + &quot; Could not find a CRL URL&quot;;
<span class="nc" id="L291">      log.info(errmsg);</span>
<span class="nc" id="L292">      throw new CertPathValidatorException(errmsg);</span>
    }
<span class="nc bnc" id="L294" title="All 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L295">      log.debug(&quot;Found &quot; + crlUrls.size() + &quot; CRL URLs&quot;);</span>
    }

<span class="nc" id="L298">    CRL aCrl = null;</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">    for (URL url : crlUrls) {</span>
<span class="nc" id="L300">      aCrl = getCRL(url);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">      if (aCrl != null) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (isCorrectCRL(aCrl, issuerDN)) {</span>
<span class="nc" id="L303">          final boolean isRevoked = aCrl.isRevoked(cert);</span>
<span class="nc" id="L304">          this.crl = aCrl;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">          if (isRevoked) {</span>
<span class="nc" id="L306">            throw new CertPathValidatorException(</span>
                &quot;Certificate with serialnumber &quot;
<span class="nc" id="L308">                    + CertTools.getSerialNumberAsString(cert)</span>
                    + &quot; was revoked&quot;);
          }
          break;
        }
      }
<span class="nc" id="L314">    }</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">    if (this.crl == null) {</span>
<span class="nc" id="L316">      throw new CertPathValidatorException(</span>
          &quot;Failed to verify certificate status using CRL. Could not find a CRL&quot;
              + &quot; issued by &quot;
              + issuerDN
              + &quot; reasonably lately&quot;);
    }
<span class="nc" id="L322">  }</span>

  private boolean isCorrectCRL(final CRL aCrl, final String issuerDN) {
<span class="nc bnc" id="L325" title="All 2 branches missed.">    if (!(aCrl instanceof X509CRL)) {</span>
<span class="nc" id="L326">      return false;</span>
    }

<span class="nc" id="L329">    X509CRL x509crl = (X509CRL) aCrl;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">    if (!StringUtils.equals(issuerDN, CertTools.getIssuerDN(x509crl))) {</span>
<span class="nc" id="L331">      return false;</span>
    }

<span class="nc" id="L334">    final Date now = new Date(System.currentTimeMillis());</span>
<span class="nc" id="L335">    final Date nextUpdate = x509crl.getNextUpdate();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">    if (nextUpdate != null) {</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">      if (nextUpdate.after(now)) {</span>
<span class="nc" id="L338">        return true;</span>
      }

<span class="nc bnc" id="L341" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L342">        log.debug(&quot;CRL issued by &quot; + issuerDN + &quot; is out of date&quot;);</span>
      }
<span class="nc" id="L344">      return false;</span>
    }

<span class="nc" id="L347">    final Date thisUpdate = x509crl.getThisUpdate();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">    if (thisUpdate != null) {</span>
<span class="nc" id="L349">      final GregorianCalendar gc = new GregorianCalendar();</span>
<span class="nc" id="L350">      gc.setTime(now);</span>
<span class="nc" id="L351">      gc.add(Calendar.HOUR, 1);</span>
<span class="nc" id="L352">      final Date expire = gc.getTime();</span>

<span class="nc bnc" id="L354" title="All 2 branches missed.">      if (expire.before(now)) {</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L356">          log.debug(</span>
              &quot;Could not find when CRL issued by &quot;
                  + issuerDN
                  + &quot; should be updated and this CRL is over one hour old. Not&quot;
                  + &quot; using it&quot;);
        }
<span class="nc" id="L362">        return false;</span>
      }

<span class="nc" id="L365">      log.warn(</span>
          &quot;Could not find when CRL issued by &quot;
              + issuerDN
              + &quot; should be updated, but this CRL was issued less than an hour&quot;
              + &quot; ago, so we are using it&quot;);
<span class="nc" id="L370">      return true;</span>
    }

<span class="nc bnc" id="L373" title="All 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L374">      log.debug(&quot;Could not check issuance time for CRL issued by &quot; + issuerDN);</span>
    }
<span class="nc" id="L376">    return false;</span>
  }

  private CRL getCRL(final URL url) {
<span class="nc" id="L380">    CRL aCrl = null;</span>
    try {
<span class="nc" id="L382">      final URLConnection con = url.openConnection();</span>
<span class="nc" id="L383">      final InputStream is = con.getInputStream();</span>
<span class="nc" id="L384">      final CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="nc" id="L385">      aCrl = cf.generateCRL(is);</span>
<span class="nc" id="L386">      is.close();</span>
<span class="nc" id="L387">      log.info(&quot;Downloaded CRL from &quot; + url);</span>
<span class="nc" id="L388">    } catch (IOException | CertificateException | CRLException e) {</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L390">        log.debug(</span>
            &quot;Fetching CRL from &quot;
<span class="nc" id="L392">                + url.toString()</span>
                + &quot; failed. &quot;
<span class="nc" id="L394">                + e.getLocalizedMessage());</span>
      }
<span class="nc" id="L396">    }</span>
<span class="nc" id="L397">    return aCrl;</span>
  }

  /**
   * Construct an OCSP request.
   *
   * @param cacert The certificate of the issuer of the certificate to be
   *     checked
   * @param certSerialnumber the serialnumber of the certificate to be checked
   * @param nonce random nonce to be included in the OCSP request (OCSP POST)
   * @return OCSPReq
   * @throws CertificateEncodingException if cert is corrupt
   * @throws OCSPException if OCSP fails
   */
  private OCSPReq getOcspRequest(
      final Certificate cacert,
      final BigInteger certSerialnumber,
      final byte[] nonce)
      throws CertificateEncodingException, OCSPException {
<span class="nc" id="L416">    OCSPReqBuilder gen = new OCSPReqBuilder();</span>
<span class="nc" id="L417">    gen.addRequest(</span>
        new JcaCertificateID(
<span class="nc" id="L419">            SHA1DigestCalculator.buildSha1Instance(),</span>
            (X509Certificate) cacert,
            certSerialnumber));

<span class="nc" id="L423">    Extension[] extensions = new Extension[1];</span>
<span class="nc" id="L424">    extensions[0] =</span>
        new Extension(
            OCSPObjectIdentifiers.id_pkix_ocsp_nonce,
            false,
            new DEROctetString(nonce));
<span class="nc" id="L429">    gen.setRequestExtensions(new Extensions(extensions));</span>

<span class="nc" id="L431">    return gen.build();</span>
  }

  /**
   * Sends an OCSP request, gets a response and verifies the response as much as
   * possible before returning it to the caller.
   *
   * @param ocspurl URL
   * @param ocspRequest Request
   * @param cert Certificate
   * @param nonce Nonce
   * @param expectedOcspRespCode OCSP response
   * @param expectedHttpRespCode HTTP response
   * @return The OCSP response, or null of no correct response could be
   *     obtained.
   */
  private SingleResp getOCSPResponse(
      final String ocspurl,
      final OCSPReq ocspRequest,
      final Certificate cert,
      final byte[] nonce,
      final int expectedOcspRespCode,
      final int expectedHttpRespCode) {
<span class="nc bnc" id="L454" title="All 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L455">      log.debug(</span>
          &quot;Sending OCSP request to &quot;
              + ocspurl
              + &quot; regarding certificate with SubjectDN: &quot;
<span class="nc" id="L459">              + CertTools.getSubjectDN(cert)</span>
              + &quot; - IssuerDN: &quot;
<span class="nc" id="L461">              + CertTools.getIssuerDN(cert));</span>
    }

    // ----------------------- Open connection and send the request
    // --------------//
<span class="nc" id="L466">    OCSPResp response = null;</span>
<span class="nc" id="L467">    HttpURLConnection con = null;</span>
    try {
<span class="nc" id="L469">      final URL url = new URL(ocspurl);</span>
<span class="nc" id="L470">      con = (HttpURLConnection) url.openConnection();</span>
      // we are going to do a POST
<span class="nc" id="L472">      con.setDoOutput(true);</span>
<span class="nc" id="L473">      con.setRequestMethod(&quot;POST&quot;);</span>

      // POST it
<span class="nc" id="L476">      con.setRequestProperty(&quot;Content-Type&quot;, &quot;application/ocsp-request&quot;);</span>
<span class="nc" id="L477">      OutputStream os = con.getOutputStream();</span>
<span class="nc" id="L478">      os.write(ocspRequest.getEncoded());</span>
<span class="nc" id="L479">      os.close();</span>

<span class="nc" id="L481">      final int httpRespCode = ((HttpURLConnection) con).getResponseCode();</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">      if (httpRespCode != expectedHttpRespCode) {</span>
<span class="nc" id="L483">        log.info(</span>
            &quot;HTTP response from OCSP request was &quot;
                + httpRespCode
                + &quot;. Expected &quot;
                + expectedHttpRespCode);
<span class="nc" id="L488">        handleContentOfErrorStream(con.getErrorStream());</span>
<span class="nc" id="L489">        return null; // if it is an http error code we don't need to test any</span>
                     // more
      }

<span class="nc" id="L493">      InputStream is = con.getInputStream();</span>
<span class="nc" id="L494">      response = new OCSPResp(IOUtils.toByteArray(is));</span>
<span class="nc" id="L495">      is.close();</span>

<span class="nc" id="L497">    } catch (IOException e) {</span>
<span class="nc" id="L498">      log.info(&quot;Unable to get an OCSP response. &quot; + e.getLocalizedMessage());</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">      if (con != null) {</span>
<span class="nc" id="L500">        handleContentOfErrorStream(con.getErrorStream());</span>
      }
<span class="nc" id="L502">      return null;</span>
<span class="nc" id="L503">    }</span>

    // ------------ Verify the response signature --------------//
<span class="nc" id="L506">    BasicOCSPResp brep = null;</span>
    try {
<span class="nc" id="L508">      brep = (BasicOCSPResp) response.getResponseObject();</span>

<span class="nc bnc" id="L510" title="All 4 branches missed.">      if ((expectedOcspRespCode != OCSPRespBuilder.SUCCESSFUL)</span>
          &amp;&amp; (brep != null)) {
<span class="nc" id="L512">        log.warn(</span>
            &quot;According to RFC 2560, responseBytes are not set on error, but we&quot;
                + &quot; got some.&quot;);
<span class="nc" id="L515">        return null; // it messes up testing of invalid signatures... but is</span>
                     // needed for the unsuccessful responses
      }

<span class="nc bnc" id="L519" title="All 2 branches missed.">      if (brep == null) {</span>
<span class="nc" id="L520">        log.warn(</span>
            &quot;Cannot extract OCSP response object. OCSP response status: &quot;
<span class="nc" id="L522">                + response.getStatus());</span>
<span class="nc" id="L523">        return null;</span>
      }

<span class="nc" id="L526">      X509CertificateHolder[] chain = brep.getCerts();</span>
<span class="nc" id="L527">      boolean verify =</span>
<span class="nc" id="L528">          brep.isSignatureValid(</span>
              new JcaContentVerifierProviderBuilder()
<span class="nc" id="L530">                  .setProvider(BouncyCastleProvider.PROVIDER_NAME)</span>
<span class="nc" id="L531">                  .build(chain[0]));</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">      if (!verify) {</span>
<span class="nc" id="L533">        log.warn(&quot;OCSP response signature was not valid&quot;);</span>
<span class="nc" id="L534">        return null;</span>
      }
<span class="nc" id="L536">    } catch (OCSPException</span>
        | OperatorCreationException
        | CertificateException e) {
<span class="nc bnc" id="L539" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L540">        log.debug(</span>
            &quot;Failed to obtain or verify OCSP response. &quot;
<span class="nc" id="L542">                + e.getLocalizedMessage());</span>
      }
<span class="nc" id="L544">      return null;</span>
<span class="nc" id="L545">    }</span>

    // ------------- Verify the nonce ---------------//
    byte[] noncerep;
    try {
<span class="nc" id="L550">      noncerep =</span>
<span class="nc" id="L551">          brep.getExtension(OCSPObjectIdentifiers.id_pkix_ocsp_nonce)</span>
<span class="nc" id="L552">              .getExtnValue()</span>
<span class="nc" id="L553">              .getEncoded();</span>
<span class="nc" id="L554">    } catch (IOException e) {</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L556">        log.debug(</span>
            &quot;Failed to read extension from OCSP response. &quot;
<span class="nc" id="L558">                + e.getLocalizedMessage());</span>
      }
<span class="nc" id="L560">      return null;</span>
<span class="nc" id="L561">    }</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">    if (noncerep == null) {</span>
<span class="nc" id="L563">      log.warn(</span>
          &quot;Sent an OCSP request containing a nonce, but the OCSP response does&quot;
              + &quot; not contain a nonce&quot;);
<span class="nc" id="L566">      return null;</span>
    }

    try {
<span class="nc" id="L570">      ASN1InputStream ain = new ASN1InputStream(noncerep);</span>
<span class="nc" id="L571">      ASN1OctetString oct = ASN1OctetString.getInstance(ain.readObject());</span>
<span class="nc" id="L572">      ain.close();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">      if (!Arrays.equals(nonce, oct.getOctets())) {</span>
<span class="nc" id="L574">        log.warn(</span>
            &quot;The nonce in the OCSP request and the OCSP response do not match&quot;);
<span class="nc" id="L576">        return null;</span>
      }
<span class="nc" id="L578">    } catch (IOException e) {</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L580">        log.debug(</span>
            &quot;Failed to read extension from OCSP response. &quot;
<span class="nc" id="L582">                + e.getLocalizedMessage());</span>
      }
<span class="nc" id="L584">      return null;</span>
<span class="nc" id="L585">    }</span>

    // ------------ Extract the single response and verify that it concerns a
    // cert with the right serialnumber ----//
<span class="nc" id="L589">    SingleResp[] singleResps = brep.getResponses();</span>
<span class="nc bnc" id="L590" title="All 4 branches missed.">    if ((singleResps == null) || (singleResps.length == 0)) {</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L592">        log.debug(&quot;The OCSP response object contained no responses.&quot;);</span>
      }
<span class="nc" id="L594">      return null;</span>
    }

<span class="nc" id="L597">    SingleResp singleResponse = singleResps[0];</span>
<span class="nc" id="L598">    CertificateID certId = singleResponse.getCertID();</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">    if (!certId.getSerialNumber().equals(CertTools.getSerialNumber(cert))) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L601">        log.debug(</span>
            &quot;Certificate serialnumber in response does not match certificate&quot;
                + &quot; serialnumber in request.&quot;);
      }
<span class="nc" id="L605">      return null;</span>
    }

    // ------------ Return the single response ---------------//
<span class="nc" id="L609">    return singleResponse;</span>
  }

  /**
   * Reads the content of 'httpErrorStream' and ignores it.
   *
   * @param httpErrorStream stream
   */
  private void handleContentOfErrorStream(final InputStream httpErrorStream) {
<span class="nc bnc" id="L618" title="All 2 branches missed.">    if (httpErrorStream != null) {</span>
      try {
<span class="nc" id="L620">        OutputStream os = new NullOutputStream();</span>
<span class="nc" id="L621">        IOUtils.copy(httpErrorStream, os);</span>
<span class="nc" id="L622">        httpErrorStream.close();</span>
<span class="nc" id="L623">        os.close();</span>
<span class="nc" id="L624">      } catch (IOException ex) {</span>
<span class="nc" id="L625">      }</span>
    }
<span class="nc" id="L627">  }</span>

  private ArrayList&lt;String&gt; getOcspUrls(final Certificate cert) {
<span class="nc" id="L630">    ArrayList&lt;String&gt; urls = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(this.ocspUrl)) {</span>
<span class="nc" id="L632">      urls.add(this.ocspUrl);</span>
    }

<span class="nc" id="L635">    urls.addAll(</span>
<span class="nc" id="L636">        CertTools.getAuthorityInformationAccessOcspUrls(</span>
            (X509Certificate) cert));

<span class="nc" id="L639">    return urls;</span>
  }

  private ArrayList&lt;URL&gt; getCrlUrl(final Certificate cert) {

<span class="nc" id="L644">    ArrayList&lt;URL&gt; urls = new ArrayList&lt;URL&gt;();</span>

<span class="nc bnc" id="L646" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(this.crlUrl)) {</span>
      try {
<span class="nc" id="L648">        urls.add(new URL(this.crlUrl));</span>
<span class="nc" id="L649">      } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L651">          log.debug(</span>
              &quot;Failed to parse '&quot;
                  + this.crlUrl
                  + &quot;' as a URL. &quot;
<span class="nc" id="L655">                  + e.getLocalizedMessage());</span>
        }
<span class="nc" id="L657">      }</span>
    }

<span class="nc" id="L660">    Collection&lt;URL&gt; crlUrlFromExtension =</span>
<span class="nc" id="L661">        CertTools.getCrlDistributionPoints((X509Certificate) cert);</span>
<span class="nc" id="L662">    urls.addAll(crlUrlFromExtension);</span>

<span class="nc" id="L664">    return urls;</span>
  }

  private X509Certificate getCaCert(final Certificate targetCert) {
<span class="nc bnc" id="L668" title="All 2 branches missed.">    if (this.issuerCert != null) {</span>
<span class="nc" id="L669">      return issuerCert;</span>
    }

<span class="nc bnc" id="L672" title="All 2 branches missed.">    if (this.caCerts == null) { // no CA specified</span>
<span class="nc" id="L673">      return null;</span>
    }

<span class="nc bnc" id="L676" title="All 2 branches missed.">    for (final X509Certificate cacert : this.caCerts) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">      if (isIssuerCA(targetCert, cacert)) {</span>
<span class="nc" id="L678">        return cacert;</span>
      }
<span class="nc" id="L680">    }</span>
<span class="nc" id="L681">    return null;</span>
  }

  private boolean isIssuerCA(final Certificate cert, final Certificate cacert) {
<span class="nc bnc" id="L685" title="All 2 branches missed.">    if (!StringUtils.equals(</span>
<span class="nc" id="L686">        CertTools.getIssuerDN(cert), CertTools.getSubjectDN(cacert))) {</span>
<span class="nc" id="L687">      return false;</span>
    }
    try {
<span class="nc" id="L690">      cert.verify(cacert.getPublicKey());</span>
<span class="nc" id="L691">      return true;</span>
<span class="nc" id="L692">    } catch (InvalidKeyException</span>
        | CertificateException
        | NoSuchAlgorithmException
        | NoSuchProviderException
        | SignatureException e) {
<span class="nc" id="L697">      return false;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>