<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>CaInitCommand xref</title>
<link type="text/css" rel="stylesheet" href="../../../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../../../apidocs/org/ejbca/ui/cli/ca/CaInitCommand.html">View Javadoc</a></div><pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_javadoccomment">/*************************************************************************</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_javadoccomment"> *  EJBCA Community: The OpenSource Certificate Authority                *</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_javadoccomment"> *  This software is free software; you can redistribute it and/or       *</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_javadoccomment"> *  modify it under the terms of the GNU Lesser General Public           *</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_javadoccomment"> *  License as published by the Free Software Foundation; either         *</em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_javadoccomment"> *  version 2.1 of the License, or any later version.                    *</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_javadoccomment"> *  See terms of license at gnu.org.                                     *</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_javadoccomment"> *************************************************************************/</em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  <strong class="jxr_keyword">package</strong> org.ejbca.ui.cli.ca;
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <strong class="jxr_keyword">import</strong> java.io.File;
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <strong class="jxr_keyword">import</strong> java.io.FileInputStream;
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <strong class="jxr_keyword">import</strong> java.io.FileNotFoundException;
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <strong class="jxr_keyword">import</strong> java.io.FileOutputStream;
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <strong class="jxr_keyword">import</strong> java.io.IOException;
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  <strong class="jxr_keyword">import</strong> java.security.InvalidAlgorithmParameterException;
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <strong class="jxr_keyword">import</strong> java.security.InvalidKeyException;
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertPathValidatorException;
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <strong class="jxr_keyword">import</strong> java.security.cert.Certificate;
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertificateException;
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <strong class="jxr_keyword">import</strong> java.text.SimpleDateFormat;
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <strong class="jxr_keyword">import</strong> java.util.Date;
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <strong class="jxr_keyword">import</strong> java.util.HashMap;
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <strong class="jxr_keyword">import</strong> java.util.Map;
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <strong class="jxr_keyword">import</strong> java.util.Properties;
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <strong class="jxr_keyword">import</strong> org.apache.commons.lang.StringUtils;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <strong class="jxr_keyword">import</strong> org.apache.log4j.Logger;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <strong class="jxr_keyword">import</strong> org.cesecore.authorization.AuthorizationDeniedException;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CAConstants;
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CAExistsException;
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CAInfo;
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CVCCAInfo;
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CaSessionRemote;
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.InvalidAlgorithmException;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.X509CAInfo;
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.catoken.CAToken;
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.catoken.CATokenConstants;
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.extendedservices.ExtendedCAServiceInfo;
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificate.CertificateConstants;
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificatePolicy;
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificateProfile;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificateProfileConstants;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificateProfileSessionRemote;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.AlgorithmConstants;
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.DNFieldExtractor;
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.CryptoToken;
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.CryptoTokenAuthenticationFailedException;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.CryptoTokenManagementSessionRemote;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.CryptoTokenNameInUseException;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.CryptoTokenOfflineException;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.PKCS11CryptoToken;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.SoftCryptoToken;
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.token.p11.exception.NoSuchSlotException;
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.util.KeyTools;
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.CertTools;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.CryptoProviderTools;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.EjbRemoteHelper;
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.SimpleTime;
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.StringTools;
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.ejb.ca.caadmin.CAAdminSessionRemote;
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ca.caadmin.extendedcaservices.CmsCAServiceInfo;
<a class="jxr_linenumber" name="L70" href="#L70">70</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ca.caadmin.extendedcaservices.HardTokenEncryptCAServiceInfo;
<a class="jxr_linenumber" name="L71" href="#L71">71</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ca.caadmin.extendedcaservices.KeyRecoveryCAServiceInfo;
<a class="jxr_linenumber" name="L72" href="#L72">72</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.command.CommandResult;
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.parameter.Parameter;
<a class="jxr_linenumber" name="L74" href="#L74">74</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.parameter.ParameterContainer;
<a class="jxr_linenumber" name="L75" href="#L75">75</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.parameter.enums.MandatoryMode;
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.parameter.enums.ParameterMode;
<a class="jxr_linenumber" name="L77" href="#L77">77</a>  <strong class="jxr_keyword">import</strong> org.ejbca.ui.cli.infrastructure.parameter.enums.StandaloneMode;
<a class="jxr_linenumber" name="L78" href="#L78">78</a>  
<a class="jxr_linenumber" name="L79" href="#L79">79</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  <em class="jxr_javadoccomment"> * CLI command for creating a CA and its first CRL. Publishes the CRL and CA certificate if it should.</em>
<a class="jxr_linenumber" name="L81" href="#L81">81</a>  <em class="jxr_javadoccomment"> * </em>
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  <em class="jxr_javadoccomment"> * @version $Id: CaInitCommand.java 28099 2018-01-25 12:08:32Z henriks $</em>
<a class="jxr_linenumber" name="L83" href="#L83">83</a>  <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L84" href="#L84">84</a>  enum <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> {
<a class="jxr_linenumber" name="L85" href="#L85">85</a>      X509(<span class="jxr_string">"x509"</span>), CVC(<span class="jxr_string">"cvc"</span>);
<a class="jxr_linenumber" name="L86" href="#L86">86</a>  
<a class="jxr_linenumber" name="L87" href="#L87">87</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> Map&lt;String, CaType&gt; lookupMap;
<a class="jxr_linenumber" name="L88" href="#L88">88</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> String typeName;
<a class="jxr_linenumber" name="L89" href="#L89">89</a>  
<a class="jxr_linenumber" name="L90" href="#L90">90</a>      <strong class="jxr_keyword">static</strong> {
<a class="jxr_linenumber" name="L91" href="#L91">91</a>          lookupMap = <strong class="jxr_keyword">new</strong> HashMap&lt;String, CaType&gt;();
<a class="jxr_linenumber" name="L92" href="#L92">92</a>          <strong class="jxr_keyword">for</strong> (<a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> type : CaType.values()) {
<a class="jxr_linenumber" name="L93" href="#L93">93</a>              lookupMap.put(type.getTypeName(), type);
<a class="jxr_linenumber" name="L94" href="#L94">94</a>          }
<a class="jxr_linenumber" name="L95" href="#L95">95</a>      }
<a class="jxr_linenumber" name="L96" href="#L96">96</a>  
<a class="jxr_linenumber" name="L97" href="#L97">97</a>      <strong class="jxr_keyword">private</strong> <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a>(String name) {
<a class="jxr_linenumber" name="L98" href="#L98">98</a>          <strong class="jxr_keyword">this</strong>.typeName = name;
<a class="jxr_linenumber" name="L99" href="#L99">99</a>      }
<a class="jxr_linenumber" name="L100" href="#L100">100</a> 
<a class="jxr_linenumber" name="L101" href="#L101">101</a>     <strong class="jxr_keyword">public</strong> String getTypeName() {
<a class="jxr_linenumber" name="L102" href="#L102">102</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">this</strong>.typeName;
<a class="jxr_linenumber" name="L103" href="#L103">103</a>     }
<a class="jxr_linenumber" name="L104" href="#L104">104</a> 
<a class="jxr_linenumber" name="L105" href="#L105">105</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> lookupCaType(String typeName) {
<a class="jxr_linenumber" name="L106" href="#L106">106</a>         <strong class="jxr_keyword">return</strong> lookupMap.get(typeName);
<a class="jxr_linenumber" name="L107" href="#L107">107</a>     }
<a class="jxr_linenumber" name="L108" href="#L108">108</a> 
<a class="jxr_linenumber" name="L109" href="#L109">109</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> String getTypeNames() {
<a class="jxr_linenumber" name="L110" href="#L110">110</a>         StringBuilder stringBuilder = <strong class="jxr_keyword">new</strong> StringBuilder(<span class="jxr_string">"["</span>);
<a class="jxr_linenumber" name="L111" href="#L111">111</a>         <strong class="jxr_keyword">for</strong> (<a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> type : CaType.values()) {
<a class="jxr_linenumber" name="L112" href="#L112">112</a>             stringBuilder.append(type.getTypeName());
<a class="jxr_linenumber" name="L113" href="#L113">113</a>             stringBuilder.append(<span class="jxr_string">","</span>);
<a class="jxr_linenumber" name="L114" href="#L114">114</a>         }
<a class="jxr_linenumber" name="L115" href="#L115">115</a>         stringBuilder.setCharAt(stringBuilder.length() - 1, ']');
<a class="jxr_linenumber" name="L116" href="#L116">116</a>         <strong class="jxr_keyword">return</strong> stringBuilder.toString();
<a class="jxr_linenumber" name="L117" href="#L117">117</a>     }
<a class="jxr_linenumber" name="L118" href="#L118">118</a> }
<a class="jxr_linenumber" name="L119" href="#L119">119</a> 
<a class="jxr_linenumber" name="L120" href="#L120">120</a> <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> <a name="CaInitCommand" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaInitCommand">CaInitCommand</a> <strong class="jxr_keyword">extends</strong> <a name="BaseCaAdminCommand" href="../../../../../org/ejbca/ui/cli/ca/BaseCaAdminCommand.html#BaseCaAdminCommand">BaseCaAdminCommand</a> {
<a class="jxr_linenumber" name="L121" href="#L121">121</a> 
<a class="jxr_linenumber" name="L122" href="#L122">122</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Logger log = Logger.getLogger(CaInitCommand.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L123" href="#L123">123</a> 
<a class="jxr_linenumber" name="L124" href="#L124">124</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String CA_NAME_KEY = <span class="jxr_string">"--caname"</span>;
<a class="jxr_linenumber" name="L125" href="#L125">125</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String DN_KEY = <span class="jxr_string">"--dn"</span>;
<a class="jxr_linenumber" name="L126" href="#L126">126</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String ALT_NAME_KEY = <span class="jxr_string">"--subjectaltname"</span>;
<a class="jxr_linenumber" name="L127" href="#L127">127</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String TOKEN_TYPE_KEY = <span class="jxr_string">"--tokenType"</span>;
<a class="jxr_linenumber" name="L128" href="#L128">128</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String TOKEN_PASSWORD_KEY = <span class="jxr_string">"--tokenPass"</span>;
<a class="jxr_linenumber" name="L129" href="#L129">129</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String KEY_SPEC_KEY = <span class="jxr_string">"--keyspec"</span>;
<a class="jxr_linenumber" name="L130" href="#L130">130</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String KEY_TYPE_KEY = <span class="jxr_string">"--keytype"</span>;
<a class="jxr_linenumber" name="L131" href="#L131">131</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String VALIDITY_KEY = <span class="jxr_string">"-v"</span>;
<a class="jxr_linenumber" name="L132" href="#L132">132</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String POLICY_ID_KEY = <span class="jxr_string">"--policy"</span>;
<a class="jxr_linenumber" name="L133" href="#L133">133</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SIGNING_ALGORITHM_KEY = <span class="jxr_string">"-s"</span>;
<a class="jxr_linenumber" name="L134" href="#L134">134</a> 
<a class="jxr_linenumber" name="L135" href="#L135">135</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String CA_TOKEN_PROPERTIES_KEY = <span class="jxr_string">"--tokenprop"</span>;
<a class="jxr_linenumber" name="L136" href="#L136">136</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String CERTIFICATE_PROFILE_KEY = <span class="jxr_string">"-certprofile"</span>;
<a class="jxr_linenumber" name="L137" href="#L137">137</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SUPERADMIN_CN_KEY = <span class="jxr_string">"-superadmincn"</span>;
<a class="jxr_linenumber" name="L138" href="#L138">138</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String TYPE_KEY = <span class="jxr_string">"-type"</span>;
<a class="jxr_linenumber" name="L139" href="#L139">139</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String EXPLICIT_ECC_KEY = <span class="jxr_string">"-explicitecc"</span>;
<a class="jxr_linenumber" name="L140" href="#L140">140</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String SIGNED_BY = <span class="jxr_string">"--signedby"</span>;
<a class="jxr_linenumber" name="L141" href="#L141">141</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> String EXTERNAL_CHAIN_KEY = <span class="jxr_string">"-externalcachain"</span>;
<a class="jxr_linenumber" name="L142" href="#L142">142</a> 
<a class="jxr_linenumber" name="L143" href="#L143">143</a>     {
<a class="jxr_linenumber" name="L144" href="#L144">144</a>         StringBuilder typesStringBuilder = <strong class="jxr_keyword">new</strong> StringBuilder();
<a class="jxr_linenumber" name="L145" href="#L145">145</a>         <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a>[] typeArray = CaType.values();
<a class="jxr_linenumber" name="L146" href="#L146">146</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i = 0; i &lt; typeArray.length; ++i) {
<a class="jxr_linenumber" name="L147" href="#L147">147</a>             <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> type = typeArray[i];
<a class="jxr_linenumber" name="L148" href="#L148">148</a>             typesStringBuilder.append(type.getTypeName());
<a class="jxr_linenumber" name="L149" href="#L149">149</a>             <strong class="jxr_keyword">if</strong> (i == typeArray.length - 2) {
<a class="jxr_linenumber" name="L150" href="#L150">150</a>                 typesStringBuilder.append(<span class="jxr_string">" or "</span>);
<a class="jxr_linenumber" name="L151" href="#L151">151</a>             } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (i == typeArray.length - 1) {
<a class="jxr_linenumber" name="L152" href="#L152">152</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L153" href="#L153">153</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L154" href="#L154">154</a>                 typesStringBuilder.append(<span class="jxr_string">","</span>);
<a class="jxr_linenumber" name="L155" href="#L155">155</a>             }
<a class="jxr_linenumber" name="L156" href="#L156">156</a>         }
<a class="jxr_linenumber" name="L157" href="#L157">157</a> 
<a class="jxr_linenumber" name="L158" href="#L158">158</a>         StringBuilder availableSignAlgs = <strong class="jxr_keyword">new</strong> StringBuilder();
<a class="jxr_linenumber" name="L159" href="#L159">159</a>         <strong class="jxr_keyword">for</strong> (String algorithm : AlgorithmConstants.AVAILABLE_SIGALGS) {
<a class="jxr_linenumber" name="L160" href="#L160">160</a>             availableSignAlgs.append((availableSignAlgs.length() == 0 ? <span class="jxr_string">""</span> : <span class="jxr_string">", "</span>) + algorithm);
<a class="jxr_linenumber" name="L161" href="#L161">161</a>         }
<a class="jxr_linenumber" name="L162" href="#L162">162</a> 
<a class="jxr_linenumber" name="L163" href="#L163">163</a>         <em class="jxr_comment">//Mandatory values</em>
<a class="jxr_linenumber" name="L164" href="#L164">164</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(CA_NAME_KEY, <span class="jxr_string">"CA Name"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L165" href="#L165">165</a>                 <span class="jxr_string">"Name of the CA"</span>));
<a class="jxr_linenumber" name="L166" href="#L166">166</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(DN_KEY, <span class="jxr_string">"DN"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT, <span class="jxr_string">"DN"</span>));
<a class="jxr_linenumber" name="L167" href="#L167">167</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(
<a class="jxr_linenumber" name="L168" href="#L168">168</a>                 TOKEN_TYPE_KEY,
<a class="jxr_linenumber" name="L169" href="#L169">169</a>                 <span class="jxr_string">"Token Type"</span>,
<a class="jxr_linenumber" name="L170" href="#L170">170</a>                 MandatoryMode.MANDATORY,
<a class="jxr_linenumber" name="L171" href="#L171">171</a>                 StandaloneMode.ALLOW,
<a class="jxr_linenumber" name="L172" href="#L172">172</a>                 ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L173" href="#L173">173</a>                 <span class="jxr_string">"Defines if the CA should be created with soft keys or on a HSM. Use 'soft' for software keys and 'org.cesecore.keys.token.PKCS11CryptoToken' for PKCS#11 HSMs."</span>));
<a class="jxr_linenumber" name="L174" href="#L174">174</a>         <em class="jxr_comment">//Password kept as a mandatory argument for legacy reasons</em>
<a class="jxr_linenumber" name="L175" href="#L175">175</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(
<a class="jxr_linenumber" name="L176" href="#L176">176</a>                 TOKEN_PASSWORD_KEY,
<a class="jxr_linenumber" name="L177" href="#L177">177</a>                 <span class="jxr_string">"Password"</span>,
<a class="jxr_linenumber" name="L178" href="#L178">178</a>                 MandatoryMode.MANDATORY,
<a class="jxr_linenumber" name="L179" href="#L179">179</a>                 StandaloneMode.ALLOW,
<a class="jxr_linenumber" name="L180" href="#L180">180</a>                 ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L181" href="#L181">181</a>                 <span class="jxr_string">"catokenpassword is the password for the CA token. Set to 'null' to use the default system password for Soft token CAs. Set to 'prompt' to prompt for the password on the terminal."</span>));
<a class="jxr_linenumber" name="L182" href="#L182">182</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(KEY_SPEC_KEY, <span class="jxr_string">"Key Specification"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L183" href="#L183">183</a>                 <span class="jxr_string">"Keyspec for RSA keys is size of RSA keys (1024, 2048, 4096, 8192). "</span> + <span class="jxr_string">"Keyspec for DSA keys is size of DSA keys (1024). "</span>
<a class="jxr_linenumber" name="L184" href="#L184">184</a>                         + <span class="jxr_string">"Keyspec for ECDSA keys is name of curve or 'implicitlyCA'' (see docs)."</span>));
<a class="jxr_linenumber" name="L185" href="#L185">185</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(KEY_TYPE_KEY, <span class="jxr_string">"Key Type"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L186" href="#L186">186</a>                 <span class="jxr_string">"Keytype is RSA, DSA or ECDSA."</span>));
<a class="jxr_linenumber" name="L187" href="#L187">187</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(VALIDITY_KEY, <span class="jxr_string">"Validity"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L188" href="#L188">188</a>                 <span class="jxr_string">"Validity of the CA in days."</span>));
<a class="jxr_linenumber" name="L189" href="#L189">189</a>         <em class="jxr_comment">//Policy ID keyt as mandatory parameter for legacy reasons.</em>
<a class="jxr_linenumber" name="L190" href="#L190">190</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(POLICY_ID_KEY, <span class="jxr_string">"Policy ID"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L191" href="#L191">191</a>                 <span class="jxr_string">"PolicyId can be 'null' if no Certificate Policy extension should be present, or\nobjectID as '2.5.29.32.0' or objectID and cpsurl "</span>
<a class="jxr_linenumber" name="L192" href="#L192">192</a>                         + <span class="jxr_string">"as \&quot;2.5.29.32.0 http://foo.bar.com/mycps.txt\&quot;. You can add multiple policies such as "</span>
<a class="jxr_linenumber" name="L193" href="#L193">193</a>                         + <span class="jxr_string">"\&quot;2.5.29.32.0 http://foo.bar.com/mycps.txt 1.1.1.1.1 http://foo.bar.com/111cps.txt\&quot;."</span>));
<a class="jxr_linenumber" name="L194" href="#L194">194</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(SIGNING_ALGORITHM_KEY, <span class="jxr_string">"Signing Algorithm"</span>, MandatoryMode.MANDATORY, StandaloneMode.ALLOW,
<a class="jxr_linenumber" name="L195" href="#L195">195</a>                 ParameterMode.ARGUMENT, <span class="jxr_string">"Signing Algorithm may be one of the following: "</span> + availableSignAlgs.toString()));
<a class="jxr_linenumber" name="L196" href="#L196">196</a> 
<a class="jxr_linenumber" name="L197" href="#L197">197</a>         <em class="jxr_comment">//Optional values</em>
<a class="jxr_linenumber" name="L198" href="#L198">198</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(CA_TOKEN_PROPERTIES_KEY, <span class="jxr_string">"Filename"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L199" href="#L199">199</a>                 <span class="jxr_string">"CA Token properties is a file were you define key name, password and key alias for the HSM. Same as the Hard CA Token Properties in admin gui."</span>));
<a class="jxr_linenumber" name="L200" href="#L200">200</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(CERTIFICATE_PROFILE_KEY, <span class="jxr_string">"Profile name"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID,
<a class="jxr_linenumber" name="L201" href="#L201">201</a>                 ParameterMode.ARGUMENT, <span class="jxr_string">"Makes the CA use the certificate profile 'profileName' instead of the default ROOTCA or SUBCA."</span>
<a class="jxr_linenumber" name="L202" href="#L202">202</a>                         + <span class="jxr_string">" Optional parameter that can be completely left out."</span>));
<a class="jxr_linenumber" name="L203" href="#L203">203</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(SUPERADMIN_CN_KEY, <span class="jxr_string">"Superadmin CN"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L204" href="#L204">204</a>                 <span class="jxr_string">"Adding the parameters '-superadmincn SuperAdmin' makes an initial CA use the common name SuperAdmin "</span>
<a class="jxr_linenumber" name="L205" href="#L205">205</a>                         + <span class="jxr_string">"and initializes the authorization module with an initial super administrator. "</span>
<a class="jxr_linenumber" name="L206" href="#L206">206</a>                         + <span class="jxr_string">"Note only used when creating initial CA. If parameter is not given, the authorization rules are untouched."</span>));
<a class="jxr_linenumber" name="L207" href="#L207">207</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(TYPE_KEY, <span class="jxr_string">"CA Type"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L208" href="#L208">208</a>                 <span class="jxr_string">"Type is the CA type. May be ["</span> + typesStringBuilder.toString() + <span class="jxr_string">"]. Optional parameter, defaults to x509."</span>));
<a class="jxr_linenumber" name="L209" href="#L209">209</a>         registerParameter(Parameter.createFlag(EXPLICIT_ECC_KEY, <span class="jxr_string">"Adding the switch '"</span> + EXPLICIT_ECC_KEY
<a class="jxr_linenumber" name="L210" href="#L210">210</a>                 + <span class="jxr_string">"' when using ECC keys makes the internal CryptoToken use explicit curve parameters instead of named curves. "</span>
<a class="jxr_linenumber" name="L211" href="#L211">211</a>                 + <span class="jxr_string">"Should only be used when creating a CSCA for ePassports."</span>));
<a class="jxr_linenumber" name="L212" href="#L212">212</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(SIGNED_BY, <span class="jxr_string">"CA ID"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT,
<a class="jxr_linenumber" name="L213" href="#L213">213</a>                 <span class="jxr_string">" The ID of a CA that will sign this CA. If this is omitted the new CA will be self signed (i.e. a root CA)."</span>
<a class="jxr_linenumber" name="L214" href="#L214">214</a>                         + <span class="jxr_string">"To create a CA signed by an external CA, use the keyword 'External' as &lt;CA_ID&gt;, "</span>
<a class="jxr_linenumber" name="L215" href="#L215">215</a>                         + <span class="jxr_string">"this will result in a certificate request (CSR) being saved on file, to be signed by the external CA. "</span>
<a class="jxr_linenumber" name="L216" href="#L216">216</a>                         + <span class="jxr_string">"Requires parameter '-externalcachain &lt;externalCA chain PEM file' with the full certificate chain of the external CA."</span>));
<a class="jxr_linenumber" name="L217" href="#L217">217</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(EXTERNAL_CHAIN_KEY, <span class="jxr_string">"Certificate Chain File"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID,
<a class="jxr_linenumber" name="L218" href="#L218">218</a>                 ParameterMode.ARGUMENT, <span class="jxr_string">"The certificate chain to be used if CA is to be signed by an external CA."</span>));
<a class="jxr_linenumber" name="L219" href="#L219">219</a>         registerParameter(<strong class="jxr_keyword">new</strong> Parameter(ALT_NAME_KEY, <span class="jxr_string">"Subject Alternative Name"</span>, MandatoryMode.OPTIONAL, StandaloneMode.FORBID, ParameterMode.ARGUMENT, <span class="jxr_string">"CA Subject Alternative Name"</span>));
<a class="jxr_linenumber" name="L220" href="#L220">220</a>     }
<a class="jxr_linenumber" name="L221" href="#L221">221</a> 
<a class="jxr_linenumber" name="L222" href="#L222">222</a>     @Override
<a class="jxr_linenumber" name="L223" href="#L223">223</a>     <strong class="jxr_keyword">public</strong> CommandResult execute(ParameterContainer parameters) {
<a class="jxr_linenumber" name="L224" href="#L224">224</a>         <em class="jxr_comment">// Install BC provider</em>
<a class="jxr_linenumber" name="L225" href="#L225">225</a>         CryptoProviderTools.installBCProviderIfNotAvailable();
<a class="jxr_linenumber" name="L226" href="#L226">226</a> 
<a class="jxr_linenumber" name="L227" href="#L227">227</a>         String profileName = parameters.get(CERTIFICATE_PROFILE_KEY);
<a class="jxr_linenumber" name="L228" href="#L228">228</a>         <strong class="jxr_keyword">final</strong> String superAdminCN = parameters.get(SUPERADMIN_CN_KEY);
<a class="jxr_linenumber" name="L229" href="#L229">229</a>         <em class="jxr_comment">//Default is X509</em>
<a class="jxr_linenumber" name="L230" href="#L230">230</a>         <strong class="jxr_keyword">final</strong> <a name="CaType" href="../../../../../org/ejbca/ui/cli/ca/CaInitCommand.html#CaType">CaType</a> type;
<a class="jxr_linenumber" name="L231" href="#L231">231</a>         <strong class="jxr_keyword">if</strong> (parameters.get(TYPE_KEY) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L232" href="#L232">232</a>             type = CaType.lookupCaType(parameters.get(TYPE_KEY));
<a class="jxr_linenumber" name="L233" href="#L233">233</a>             <strong class="jxr_keyword">if</strong> (type == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L234" href="#L234">234</a>                 log.error(<span class="jxr_string">"CA type of name "</span> + parameters.get(TYPE_KEY) + <span class="jxr_string">" unknown. Available types: "</span> + CaType.getTypeNames());
<a class="jxr_linenumber" name="L235" href="#L235">235</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L236" href="#L236">236</a>             }
<a class="jxr_linenumber" name="L237" href="#L237">237</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L238" href="#L238">238</a>             type = CaType.X509;
<a class="jxr_linenumber" name="L239" href="#L239">239</a>         }
<a class="jxr_linenumber" name="L240" href="#L240">240</a>         <strong class="jxr_keyword">final</strong> String explicitEcc = (parameters.get(EXPLICIT_ECC_KEY) != <strong class="jxr_keyword">null</strong> ? Boolean.TRUE.toString() : Boolean.FALSE.toString());
<a class="jxr_linenumber" name="L241" href="#L241">241</a>         <strong class="jxr_keyword">final</strong> String extcachainName = parameters.get(EXTERNAL_CHAIN_KEY);
<a class="jxr_linenumber" name="L242" href="#L242">242</a> 
<a class="jxr_linenumber" name="L243" href="#L243">243</a>         <strong class="jxr_keyword">final</strong> String caname = parameters.get(CA_NAME_KEY);
<a class="jxr_linenumber" name="L244" href="#L244">244</a>         <strong class="jxr_keyword">final</strong> String dn = CertTools.stringToBCDNString(StringTools.strip(parameters.get(DN_KEY)));
<a class="jxr_linenumber" name="L245" href="#L245">245</a>         <strong class="jxr_keyword">final</strong> String subjectAltName = parameters.get(ALT_NAME_KEY);
<a class="jxr_linenumber" name="L246" href="#L246">246</a>         <strong class="jxr_keyword">if</strong> (subjectAltName != <strong class="jxr_keyword">null</strong> &amp;&amp; !checkSubjectAltName(subjectAltName)) {
<a class="jxr_linenumber" name="L247" href="#L247">247</a>             log.error(<span class="jxr_string">"Invalid Subject Alternative Name"</span>);
<a class="jxr_linenumber" name="L248" href="#L248">248</a>             <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L249" href="#L249">249</a>         }
<a class="jxr_linenumber" name="L250" href="#L250">250</a>         <strong class="jxr_keyword">final</strong> String catokentype = parameters.get(TOKEN_TYPE_KEY);
<a class="jxr_linenumber" name="L251" href="#L251">251</a>         String catokenpassword = StringTools.passwordDecryption(parameters.get(TOKEN_PASSWORD_KEY), <span class="jxr_string">"ca.tokenpassword"</span>);
<a class="jxr_linenumber" name="L252" href="#L252">252</a>         <strong class="jxr_keyword">if</strong> (StringUtils.equals(catokenpassword, <span class="jxr_string">"prompt"</span>)) {
<a class="jxr_linenumber" name="L253" href="#L253">253</a>             getLogger().info(<span class="jxr_string">"Enter CA token password: "</span>);
<a class="jxr_linenumber" name="L254" href="#L254">254</a>             getLogger().info(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L255" href="#L255">255</a>             catokenpassword = String.valueOf(System.console().readPassword());
<a class="jxr_linenumber" name="L256" href="#L256">256</a>         }
<a class="jxr_linenumber" name="L257" href="#L257">257</a>         <strong class="jxr_keyword">final</strong> String keyspec = parameters.get(KEY_SPEC_KEY);
<a class="jxr_linenumber" name="L258" href="#L258">258</a>         <strong class="jxr_keyword">final</strong> String keytype = parameters.get(KEY_TYPE_KEY);
<a class="jxr_linenumber" name="L259" href="#L259">259</a>         <strong class="jxr_keyword">final</strong> String encodedValidity = Long.parseLong(parameters.get(VALIDITY_KEY)) + SimpleTime.TYPE_DAYS;
<a class="jxr_linenumber" name="L260" href="#L260">260</a>         String policyId = parameters.get(POLICY_ID_KEY);
<a class="jxr_linenumber" name="L261" href="#L261">261</a>         <strong class="jxr_keyword">final</strong> ArrayList&lt;CertificatePolicy&gt; policies = <strong class="jxr_keyword">new</strong> ArrayList&lt;CertificatePolicy&gt;(1);
<a class="jxr_linenumber" name="L262" href="#L262">262</a>         <strong class="jxr_keyword">if</strong> ((policyId != <strong class="jxr_keyword">null</strong>) &amp;&amp; (policyId.toLowerCase().trim().equals(<span class="jxr_string">"null"</span>))) {
<a class="jxr_linenumber" name="L263" href="#L263">263</a>             policyId = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L264" href="#L264">264</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L265" href="#L265">265</a>             String[] array = policyId.split(<span class="jxr_string">" "</span>);
<a class="jxr_linenumber" name="L266" href="#L266">266</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">int</strong> i = 0; i &lt; array.length; i += 2) {
<a class="jxr_linenumber" name="L267" href="#L267">267</a>                 String id = array[i + 0];
<a class="jxr_linenumber" name="L268" href="#L268">268</a>                 String cpsurl = <span class="jxr_string">""</span>;
<a class="jxr_linenumber" name="L269" href="#L269">269</a>                 <strong class="jxr_keyword">if</strong> (array.length &gt; i + 1) {
<a class="jxr_linenumber" name="L270" href="#L270">270</a>                     cpsurl = array[i + 1];
<a class="jxr_linenumber" name="L271" href="#L271">271</a>                 }
<a class="jxr_linenumber" name="L272" href="#L272">272</a>                 policies.add(<strong class="jxr_keyword">new</strong> CertificatePolicy(id, CertificatePolicy.ID_QT_CPS, cpsurl));
<a class="jxr_linenumber" name="L273" href="#L273">273</a>             }
<a class="jxr_linenumber" name="L274" href="#L274">274</a>         }
<a class="jxr_linenumber" name="L275" href="#L275">275</a>         String signAlg = parameters.get(SIGNING_ALGORITHM_KEY);
<a class="jxr_linenumber" name="L276" href="#L276">276</a>         Properties cryptoTokenProperties = <strong class="jxr_keyword">new</strong> Properties();
<a class="jxr_linenumber" name="L277" href="#L277">277</a>         String caTokenPropertiesFile = parameters.get(CA_TOKEN_PROPERTIES_KEY);
<a class="jxr_linenumber" name="L278" href="#L278">278</a>         <strong class="jxr_keyword">if</strong> (caTokenPropertiesFile != <strong class="jxr_keyword">null</strong> &amp;&amp; <span class="jxr_string">"soft"</span>.equals(catokentype)) {
<a class="jxr_linenumber" name="L279" href="#L279">279</a>             log.error(<span class="jxr_string">"Can't define a CAToken properties file for a soft token."</span>);
<a class="jxr_linenumber" name="L280" href="#L280">280</a>             <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L281" href="#L281">281</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (caTokenPropertiesFile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L282" href="#L282">282</a>             <strong class="jxr_keyword">if</strong> ((caTokenPropertiesFile != <strong class="jxr_keyword">null</strong>) &amp;&amp; (!caTokenPropertiesFile.equalsIgnoreCase(<span class="jxr_string">"null"</span>))) {
<a class="jxr_linenumber" name="L283" href="#L283">283</a>                 File file = <strong class="jxr_keyword">new</strong> File(caTokenPropertiesFile);
<a class="jxr_linenumber" name="L284" href="#L284">284</a>                 <strong class="jxr_keyword">if</strong> (!file.exists()) {
<a class="jxr_linenumber" name="L285" href="#L285">285</a>                     log.error(<span class="jxr_string">"CA Token propoerties file "</span> + caTokenPropertiesFile + <span class="jxr_string">" does not exist."</span>);
<a class="jxr_linenumber" name="L286" href="#L286">286</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L287" href="#L287">287</a>                 } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (file.isDirectory()) {
<a class="jxr_linenumber" name="L288" href="#L288">288</a>                     log.error(<span class="jxr_string">"CA Token propoerties file "</span> + caTokenPropertiesFile + <span class="jxr_string">" is a directory."</span>);
<a class="jxr_linenumber" name="L289" href="#L289">289</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L290" href="#L290">290</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L291" href="#L291">291</a>                     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L292" href="#L292">292</a>                         cryptoTokenProperties.load(<strong class="jxr_keyword">new</strong> FileInputStream(caTokenPropertiesFile));
<a class="jxr_linenumber" name="L293" href="#L293">293</a>                     } <strong class="jxr_keyword">catch</strong> (FileNotFoundException e) {
<a class="jxr_linenumber" name="L294" href="#L294">294</a>                         <em class="jxr_comment">//Can't happen</em>
<a class="jxr_linenumber" name="L295" href="#L295">295</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"Newly referenced file "</span> + caTokenPropertiesFile + <span class="jxr_string">" was not found."</span>, e);
<a class="jxr_linenumber" name="L296" href="#L296">296</a>                     } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L297" href="#L297">297</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"Unknown exception was caught when reading input stream"</span>, e);
<a class="jxr_linenumber" name="L298" href="#L298">298</a>                     }
<a class="jxr_linenumber" name="L299" href="#L299">299</a>                 }
<a class="jxr_linenumber" name="L300" href="#L300">300</a>             }
<a class="jxr_linenumber" name="L301" href="#L301">301</a>         }
<a class="jxr_linenumber" name="L302" href="#L302">302</a>         <strong class="jxr_keyword">int</strong> signedByCAId = CAInfo.SELFSIGNED;
<a class="jxr_linenumber" name="L303" href="#L303">303</a>         <strong class="jxr_keyword">if</strong> (parameters.get(SIGNED_BY) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L304" href="#L304">304</a>             <strong class="jxr_keyword">if</strong> (StringUtils.equalsIgnoreCase(<span class="jxr_string">"External"</span>, parameters.get(SIGNED_BY))) {
<a class="jxr_linenumber" name="L305" href="#L305">305</a>                 signedByCAId = CAInfo.SIGNEDBYEXTERNALCA;
<a class="jxr_linenumber" name="L306" href="#L306">306</a>                 <strong class="jxr_keyword">if</strong> (extcachainName == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L307" href="#L307">307</a>                     log.error(<span class="jxr_string">"Signing by external CA requires parameter "</span> + EXTERNAL_CHAIN_KEY);
<a class="jxr_linenumber" name="L308" href="#L308">308</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L309" href="#L309">309</a>                 }
<a class="jxr_linenumber" name="L310" href="#L310">310</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L311" href="#L311">311</a>                 signedByCAId = Integer.valueOf(parameters.get(SIGNED_BY));
<a class="jxr_linenumber" name="L312" href="#L312">312</a>             }
<a class="jxr_linenumber" name="L313" href="#L313">313</a>         }
<a class="jxr_linenumber" name="L314" href="#L314">314</a> 
<a class="jxr_linenumber" name="L315" href="#L315">315</a>         <em class="jxr_comment">// Check that the CA doesn't exist already</em>
<a class="jxr_linenumber" name="L316" href="#L316">316</a>         getLogger().debug(<span class="jxr_string">"Checking that CA doesn't exist: "</span> + caname);
<a class="jxr_linenumber" name="L317" href="#L317">317</a>         <strong class="jxr_keyword">if</strong> (getCAInfo(getAuthenticationToken(), caname) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L318" href="#L318">318</a>             getLogger().error(<span class="jxr_string">"Error: CA '"</span> + caname + <span class="jxr_string">"' exists already"</span>);
<a class="jxr_linenumber" name="L319" href="#L319">319</a>             <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L320" href="#L320">320</a>         }
<a class="jxr_linenumber" name="L321" href="#L321">321</a> 
<a class="jxr_linenumber" name="L322" href="#L322">322</a>         <em class="jxr_comment">// Get the profile ID from the name if we specified a certain profile name</em>
<a class="jxr_linenumber" name="L323" href="#L323">323</a>         <strong class="jxr_keyword">int</strong> certificateProfileId = CertificateProfileConstants.CERTPROFILE_FIXED_ROOTCA;
<a class="jxr_linenumber" name="L324" href="#L324">324</a>         <strong class="jxr_keyword">if</strong> (profileName == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L325" href="#L325">325</a>             <strong class="jxr_keyword">if</strong> (signedByCAId == CAInfo.SELFSIGNED) {
<a class="jxr_linenumber" name="L326" href="#L326">326</a>                 profileName = <span class="jxr_string">"ROOTCA"</span>;
<a class="jxr_linenumber" name="L327" href="#L327">327</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L328" href="#L328">328</a>                 profileName = <span class="jxr_string">"SUBCA"</span>;
<a class="jxr_linenumber" name="L329" href="#L329">329</a>                 certificateProfileId = CertificateProfileConstants.CERTPROFILE_FIXED_SUBCA;
<a class="jxr_linenumber" name="L330" href="#L330">330</a>             }
<a class="jxr_linenumber" name="L331" href="#L331">331</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L332" href="#L332">332</a>             certificateProfileId = EjbRemoteHelper.INSTANCE.getRemoteSession(CertificateProfileSessionRemote.<strong class="jxr_keyword">class</strong>).getCertificateProfileId(
<a class="jxr_linenumber" name="L333" href="#L333">333</a>                     profileName);
<a class="jxr_linenumber" name="L334" href="#L334">334</a>             <strong class="jxr_keyword">if</strong> (certificateProfileId == 0) {
<a class="jxr_linenumber" name="L335" href="#L335">335</a>                 getLogger().info(<span class="jxr_string">"Error: Certificate profile with name '"</span> + profileName + <span class="jxr_string">"' does not exist."</span>);
<a class="jxr_linenumber" name="L336" href="#L336">336</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L337" href="#L337">337</a>             }
<a class="jxr_linenumber" name="L338" href="#L338">338</a> 
<a class="jxr_linenumber" name="L339" href="#L339">339</a>             CertificateProfile certificateProfile = EjbRemoteHelper.INSTANCE.getRemoteSession(CertificateProfileSessionRemote.<strong class="jxr_keyword">class</strong>)
<a class="jxr_linenumber" name="L340" href="#L340">340</a>                     .getCertificateProfile(profileName);
<a class="jxr_linenumber" name="L341" href="#L341">341</a>             <strong class="jxr_keyword">if</strong> (certificateProfile.getType() != CertificateConstants.CERTTYPE_ROOTCA
<a class="jxr_linenumber" name="L342" href="#L342">342</a>                     &amp;&amp; certificateProfile.getType() != CertificateConstants.CERTTYPE_SUBCA) {
<a class="jxr_linenumber" name="L343" href="#L343">343</a>                 getLogger().info(<span class="jxr_string">"Error: Certificate profile "</span> + profileName + <span class="jxr_string">" is not of type ROOTCA or SUBCA."</span>);
<a class="jxr_linenumber" name="L344" href="#L344">344</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L345" href="#L345">345</a>             }
<a class="jxr_linenumber" name="L346" href="#L346">346</a>         }
<a class="jxr_linenumber" name="L347" href="#L347">347</a> 
<a class="jxr_linenumber" name="L348" href="#L348">348</a>         <strong class="jxr_keyword">if</strong> (KeyTools.isUsingExportableCryptography()) {
<a class="jxr_linenumber" name="L349" href="#L349">349</a>             getLogger().warn(<span class="jxr_string">"WARNING!"</span>);
<a class="jxr_linenumber" name="L350" href="#L350">350</a>             getLogger().warn(<span class="jxr_string">"WARNING: Using exportable strength crypto!"</span>);
<a class="jxr_linenumber" name="L351" href="#L351">351</a>             getLogger().warn(<span class="jxr_string">"WARNING!"</span>);
<a class="jxr_linenumber" name="L352" href="#L352">352</a>             getLogger().warn(
<a class="jxr_linenumber" name="L353" href="#L353">353</a>                     <span class="jxr_string">"The Unlimited Strength Crypto policy files have not been installed. EJBCA may not function correctly using exportable crypto."</span>);
<a class="jxr_linenumber" name="L354" href="#L354">354</a>             getLogger().warn(<span class="jxr_string">"Please install the Unlimited Strength Crypto policy files as documented in the Installation guide."</span>);
<a class="jxr_linenumber" name="L355" href="#L355">355</a>             getLogger().warn(<span class="jxr_string">"Sleeping 10 seconds..."</span>);
<a class="jxr_linenumber" name="L356" href="#L356">356</a>             getLogger().warn(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L357" href="#L357">357</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L358" href="#L358">358</a>                 Thread.sleep(10000);
<a class="jxr_linenumber" name="L359" href="#L359">359</a>             } <strong class="jxr_keyword">catch</strong> (InterruptedException e) {
<a class="jxr_linenumber" name="L360" href="#L360">360</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"Thread.sleep was interrupted for unknown reason."</span>, e);
<a class="jxr_linenumber" name="L361" href="#L361">361</a>             }
<a class="jxr_linenumber" name="L362" href="#L362">362</a>         }
<a class="jxr_linenumber" name="L363" href="#L363">363</a>         getLogger().info(<span class="jxr_string">"Initializing CA"</span>);
<a class="jxr_linenumber" name="L364" href="#L364">364</a> 
<a class="jxr_linenumber" name="L365" href="#L365">365</a>         getLogger().info(<span class="jxr_string">"Generating rootCA keystore:"</span>);
<a class="jxr_linenumber" name="L366" href="#L366">366</a>         getLogger().info(<span class="jxr_string">"CA Type:"</span> + type.getTypeName());
<a class="jxr_linenumber" name="L367" href="#L367">367</a>         getLogger().info(<span class="jxr_string">"CA name: "</span> + caname);
<a class="jxr_linenumber" name="L368" href="#L368">368</a>         getLogger().info(<span class="jxr_string">"SuperAdmin CN: "</span> + superAdminCN);
<a class="jxr_linenumber" name="L369" href="#L369">369</a>         getLogger().info(<span class="jxr_string">"DN: "</span> + dn);
<a class="jxr_linenumber" name="L370" href="#L370">370</a>         getLogger().info(<span class="jxr_string">"CA token type: "</span> + catokentype);
<a class="jxr_linenumber" name="L371" href="#L371">371</a>         getLogger().info(<span class="jxr_string">"CA token password: "</span> + (catokenpassword == <strong class="jxr_keyword">null</strong> ? <span class="jxr_string">"null"</span> : <span class="jxr_string">"hidden"</span>));
<a class="jxr_linenumber" name="L372" href="#L372">372</a>         getLogger().info(<span class="jxr_string">"Keytype: "</span> + keytype);
<a class="jxr_linenumber" name="L373" href="#L373">373</a>         getLogger().info(<span class="jxr_string">"Keyspec: "</span> + keyspec);
<a class="jxr_linenumber" name="L374" href="#L374">374</a>         getLogger().info(<span class="jxr_string">"Validity: "</span> + encodedValidity);
<a class="jxr_linenumber" name="L375" href="#L375">375</a>         getLogger().info(<span class="jxr_string">"Policy ID: "</span> + policyId);
<a class="jxr_linenumber" name="L376" href="#L376">376</a>         getLogger().info(<span class="jxr_string">"Signature alg: "</span> + signAlg);
<a class="jxr_linenumber" name="L377" href="#L377">377</a>         getLogger().info(<span class="jxr_string">"Certificate profile: "</span> + profileName);
<a class="jxr_linenumber" name="L378" href="#L378">378</a>         getLogger().info(<span class="jxr_string">"CA token properties: "</span> + cryptoTokenProperties.toString());
<a class="jxr_linenumber" name="L379" href="#L379">379</a>         <strong class="jxr_keyword">if</strong> (StringUtils.equalsIgnoreCase(explicitEcc, <span class="jxr_string">"true"</span>)) {
<a class="jxr_linenumber" name="L380" href="#L380">380</a>             <em class="jxr_comment">// Set if we should use explicit ECC parameters of not. On Java 6 this renders the created CA certificate not serializable</em>
<a class="jxr_linenumber" name="L381" href="#L381">381</a>             getLogger().info(<span class="jxr_string">"Explicit ECC public key parameters: "</span> + explicitEcc);
<a class="jxr_linenumber" name="L382" href="#L382">382</a>             cryptoTokenProperties.setProperty(CryptoToken.EXPLICIT_ECC_PUBLICKEY_PARAMETERS, explicitEcc);
<a class="jxr_linenumber" name="L383" href="#L383">383</a>         }
<a class="jxr_linenumber" name="L384" href="#L384">384</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L385" href="#L385">385</a>             String signedByStr = <span class="jxr_string">"Signed by: "</span>;
<a class="jxr_linenumber" name="L386" href="#L386">386</a>             <strong class="jxr_keyword">if</strong> ((signedByCAId != CAInfo.SELFSIGNED) &amp;&amp; (signedByCAId != CAInfo.SIGNEDBYEXTERNALCA)) {
<a class="jxr_linenumber" name="L387" href="#L387">387</a>                 CAInfo cainfo = EjbRemoteHelper.INSTANCE.getRemoteSession(CaSessionRemote.<strong class="jxr_keyword">class</strong>).getCAInfo(getAuthenticationToken(), signedByCAId);
<a class="jxr_linenumber" name="L388" href="#L388">388</a>                 <strong class="jxr_keyword">if</strong> (cainfo == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L389" href="#L389">389</a>                     getLogger().error(<span class="jxr_string">"CA with id "</span> + signedByCAId + <span class="jxr_string">" does not exist."</span>);
<a class="jxr_linenumber" name="L390" href="#L390">390</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L391" href="#L391">391</a>                 }
<a class="jxr_linenumber" name="L392" href="#L392">392</a>                 signedByStr += cainfo.getName();
<a class="jxr_linenumber" name="L393" href="#L393">393</a> 
<a class="jxr_linenumber" name="L394" href="#L394">394</a>             } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (signedByCAId == CAInfo.SELFSIGNED) {
<a class="jxr_linenumber" name="L395" href="#L395">395</a>                 signedByStr += <span class="jxr_string">"Self signed"</span>;
<a class="jxr_linenumber" name="L396" href="#L396">396</a>             } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (signedByCAId == CAInfo.SIGNEDBYEXTERNALCA) {
<a class="jxr_linenumber" name="L397" href="#L397">397</a>                 signedByStr += <span class="jxr_string">"External CA"</span>;
<a class="jxr_linenumber" name="L398" href="#L398">398</a>             }
<a class="jxr_linenumber" name="L399" href="#L399">399</a>             getLogger().info(signedByStr);
<a class="jxr_linenumber" name="L400" href="#L400">400</a> 
<a class="jxr_linenumber" name="L401" href="#L401">401</a>             <strong class="jxr_keyword">if</strong> (superAdminCN != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L402" href="#L402">402</a>                 initAuthorizationModule(getAuthenticationToken(), dn.hashCode(), superAdminCN);
<a class="jxr_linenumber" name="L403" href="#L403">403</a>             }
<a class="jxr_linenumber" name="L404" href="#L404">404</a>             <em class="jxr_comment">// Transform our mixed properties into CA Token properties and cryptoTokenProperties</em>
<a class="jxr_linenumber" name="L405" href="#L405">405</a>             <strong class="jxr_keyword">final</strong> Properties caTokenProperties = <strong class="jxr_keyword">new</strong> Properties();
<a class="jxr_linenumber" name="L406" href="#L406">406</a>             <strong class="jxr_keyword">final</strong> String defaultAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_DEFAULT_STRING);
<a class="jxr_linenumber" name="L407" href="#L407">407</a>             <strong class="jxr_keyword">if</strong> (defaultAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L408" href="#L408">408</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_DEFAULT_STRING, defaultAlias);
<a class="jxr_linenumber" name="L409" href="#L409">409</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_DEFAULT_STRING);
<a class="jxr_linenumber" name="L410" href="#L410">410</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L411" href="#L411">411</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_DEFAULT_STRING, CAToken.SOFTPRIVATEDECKEYALIAS);
<a class="jxr_linenumber" name="L412" href="#L412">412</a>             }
<a class="jxr_linenumber" name="L413" href="#L413">413</a>             <strong class="jxr_keyword">final</strong> String certSignAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_CERTSIGN_STRING);
<a class="jxr_linenumber" name="L414" href="#L414">414</a>             <strong class="jxr_keyword">if</strong> (certSignAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L415" href="#L415">415</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_CERTSIGN_STRING, certSignAlias);
<a class="jxr_linenumber" name="L416" href="#L416">416</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_CERTSIGN_STRING);
<a class="jxr_linenumber" name="L417" href="#L417">417</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L418" href="#L418">418</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_CERTSIGN_STRING, CAToken.SOFTPRIVATESIGNKEYALIAS);
<a class="jxr_linenumber" name="L419" href="#L419">419</a>             }
<a class="jxr_linenumber" name="L420" href="#L420">420</a>             <strong class="jxr_keyword">final</strong> String crlSignAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_CRLSIGN_STRING);
<a class="jxr_linenumber" name="L421" href="#L421">421</a>             <strong class="jxr_keyword">if</strong> (crlSignAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L422" href="#L422">422</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_CRLSIGN_STRING, crlSignAlias);
<a class="jxr_linenumber" name="L423" href="#L423">423</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_CRLSIGN_STRING);
<a class="jxr_linenumber" name="L424" href="#L424">424</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L425" href="#L425">425</a>                 <strong class="jxr_keyword">final</strong> String certSignValue = caTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_CERTSIGN_STRING);
<a class="jxr_linenumber" name="L426" href="#L426">426</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_CRLSIGN_STRING, certSignValue);
<a class="jxr_linenumber" name="L427" href="#L427">427</a>             }
<a class="jxr_linenumber" name="L428" href="#L428">428</a>             <strong class="jxr_keyword">final</strong> String hardTokenEncAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_HARDTOKENENCRYPT_STRING);
<a class="jxr_linenumber" name="L429" href="#L429">429</a>             <strong class="jxr_keyword">if</strong> (hardTokenEncAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L430" href="#L430">430</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_HARDTOKENENCRYPT_STRING, hardTokenEncAlias);
<a class="jxr_linenumber" name="L431" href="#L431">431</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_HARDTOKENENCRYPT_STRING);
<a class="jxr_linenumber" name="L432" href="#L432">432</a>             }
<a class="jxr_linenumber" name="L433" href="#L433">433</a>             <strong class="jxr_keyword">final</strong> String keyEncAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT_STRING);
<a class="jxr_linenumber" name="L434" href="#L434">434</a>             <strong class="jxr_keyword">if</strong> (keyEncAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L435" href="#L435">435</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT_STRING, keyEncAlias);
<a class="jxr_linenumber" name="L436" href="#L436">436</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT_STRING);
<a class="jxr_linenumber" name="L437" href="#L437">437</a>             }
<a class="jxr_linenumber" name="L438" href="#L438">438</a>             <strong class="jxr_keyword">final</strong> String testKeyAlias = cryptoTokenProperties.getProperty(CATokenConstants.CAKEYPURPOSE_TESTKEY_STRING);
<a class="jxr_linenumber" name="L439" href="#L439">439</a>             <strong class="jxr_keyword">if</strong> (testKeyAlias != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L440" href="#L440">440</a>                 caTokenProperties.setProperty(CATokenConstants.CAKEYPURPOSE_TESTKEY_STRING, testKeyAlias);
<a class="jxr_linenumber" name="L441" href="#L441">441</a>                 cryptoTokenProperties.remove(CATokenConstants.CAKEYPURPOSE_TESTKEY_STRING);
<a class="jxr_linenumber" name="L442" href="#L442">442</a>             }
<a class="jxr_linenumber" name="L443" href="#L443">443</a>             <em class="jxr_comment">// If authentication code is provided as "null", use the default token password for soft tokens (from cesecore.properties), and auto activation</em>
<a class="jxr_linenumber" name="L444" href="#L444">444</a>             <em class="jxr_comment">// If a user defined authentication code is provided, use this and do not enable auto activation for soft tokens</em>
<a class="jxr_linenumber" name="L445" href="#L445">445</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">char</strong>[] authenticationCode;
<a class="jxr_linenumber" name="L446" href="#L446">446</a>             <strong class="jxr_keyword">if</strong> (StringUtils.equalsIgnoreCase(catokenpassword, <span class="jxr_string">"null"</span>)) {
<a class="jxr_linenumber" name="L447" href="#L447">447</a>                 authenticationCode = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L448" href="#L448">448</a>                 <em class="jxr_comment">// auto activation is enabled by default when using the default soft token pwd, which is used by default</em>
<a class="jxr_linenumber" name="L449" href="#L449">449</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L450" href="#L450">450</a>                 authenticationCode = catokenpassword.toCharArray();
<a class="jxr_linenumber" name="L451" href="#L451">451</a>             }
<a class="jxr_linenumber" name="L452" href="#L452">452</a>             <em class="jxr_comment">// We must do this in order to not set the default password when creating a new soft CA token</em>
<a class="jxr_linenumber" name="L453" href="#L453">453</a>             <em class="jxr_comment">// A bit tricky, but thats how it is as of EJBCA 5.0.x, 2012-05.</em>
<a class="jxr_linenumber" name="L454" href="#L454">454</a>             <strong class="jxr_keyword">final</strong> String className;
<a class="jxr_linenumber" name="L455" href="#L455">455</a>             <strong class="jxr_keyword">if</strong> (StringUtils.equalsIgnoreCase(catokentype, <span class="jxr_string">"soft"</span>)) {
<a class="jxr_linenumber" name="L456" href="#L456">456</a>                 className = SoftCryptoToken.<strong class="jxr_keyword">class</strong>.getName();
<a class="jxr_linenumber" name="L457" href="#L457">457</a>                 <strong class="jxr_keyword">if</strong> (authenticationCode != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L458" href="#L458">458</a>                     getLogger().info(<span class="jxr_string">"Non default password used for soft CA token, auto activation disabled."</span>);
<a class="jxr_linenumber" name="L459" href="#L459">459</a>                     cryptoTokenProperties.setProperty(SoftCryptoToken.NODEFAULTPWD, <span class="jxr_string">"true"</span>);
<a class="jxr_linenumber" name="L460" href="#L460">460</a>                 }
<a class="jxr_linenumber" name="L461" href="#L461">461</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L462" href="#L462">462</a>                 className = PKCS11CryptoToken.<strong class="jxr_keyword">class</strong>.getName();
<a class="jxr_linenumber" name="L463" href="#L463">463</a>             }
<a class="jxr_linenumber" name="L464" href="#L464">464</a>             <em class="jxr_comment">// Create the CryptoToken</em>
<a class="jxr_linenumber" name="L465" href="#L465">465</a>             <strong class="jxr_keyword">final</strong> CryptoTokenManagementSessionRemote cryptoTokenManagementSession = EjbRemoteHelper.INSTANCE
<a class="jxr_linenumber" name="L466" href="#L466">466</a>                     .getRemoteSession(CryptoTokenManagementSessionRemote.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L467" href="#L467">467</a>             <strong class="jxr_keyword">int</strong> cryptoTokenId;
<a class="jxr_linenumber" name="L468" href="#L468">468</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L469" href="#L469">469</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L470" href="#L470">470</a>                     cryptoTokenId = cryptoTokenManagementSession.createCryptoToken(getAuthenticationToken(), caname, className,
<a class="jxr_linenumber" name="L471" href="#L471">471</a>                             cryptoTokenProperties, <strong class="jxr_keyword">null</strong>, authenticationCode);
<a class="jxr_linenumber" name="L472" href="#L472">472</a>                 } <strong class="jxr_keyword">catch</strong> (CryptoTokenNameInUseException e) {
<a class="jxr_linenumber" name="L473" href="#L473">473</a>                     <em class="jxr_comment">// If the name was already in use we simply add a timestamp to the name to make it unique</em>
<a class="jxr_linenumber" name="L474" href="#L474">474</a>                     <strong class="jxr_keyword">final</strong> String postfix = <span class="jxr_string">"_"</span> + <strong class="jxr_keyword">new</strong> SimpleDateFormat(<span class="jxr_string">"yyyyMMddHHmmss"</span>).format(<strong class="jxr_keyword">new</strong> Date());
<a class="jxr_linenumber" name="L475" href="#L475">475</a>                     <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L476" href="#L476">476</a>                         cryptoTokenId = cryptoTokenManagementSession.createCryptoToken(getAuthenticationToken(), caname + postfix, className,
<a class="jxr_linenumber" name="L477" href="#L477">477</a>                                 cryptoTokenProperties, <strong class="jxr_keyword">null</strong>, authenticationCode);
<a class="jxr_linenumber" name="L478" href="#L478">478</a>                     } <strong class="jxr_keyword">catch</strong> (CryptoTokenNameInUseException e1) {
<a class="jxr_linenumber" name="L479" href="#L479">479</a>                         <em class="jxr_comment">//Shouldn't be able to happen.</em>
<a class="jxr_linenumber" name="L480" href="#L480">480</a>                         <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"Crypto token name was in use, even though a unique name was just generated."</span>, e);
<a class="jxr_linenumber" name="L481" href="#L481">481</a>                     }
<a class="jxr_linenumber" name="L482" href="#L482">482</a>                 }
<a class="jxr_linenumber" name="L483" href="#L483">483</a>             } <strong class="jxr_keyword">catch</strong> (NoSuchSlotException e) {
<a class="jxr_linenumber" name="L484" href="#L484">484</a>                 log.error(<span class="jxr_string">"Slot as defined in the file "</span> + caTokenPropertiesFile + <span class="jxr_string">" was not found: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L485" href="#L485">485</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L486" href="#L486">486</a>             } <strong class="jxr_keyword">catch</strong> (CryptoTokenAuthenticationFailedException e) {
<a class="jxr_linenumber" name="L487" href="#L487">487</a>                 log.error(<span class="jxr_string">"Authentication to crypto token failed: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L488" href="#L488">488</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L489" href="#L489">489</a>             }
<a class="jxr_linenumber" name="L490" href="#L490">490</a>             <em class="jxr_comment">// Create the CA Token</em>
<a class="jxr_linenumber" name="L491" href="#L491">491</a>             <strong class="jxr_keyword">final</strong> CAToken caToken = <strong class="jxr_keyword">new</strong> CAToken(cryptoTokenId, caTokenProperties);
<a class="jxr_linenumber" name="L492" href="#L492">492</a>             caToken.setSignatureAlgorithm(signAlg);
<a class="jxr_linenumber" name="L493" href="#L493">493</a>             caToken.setEncryptionAlgorithm(AlgorithmConstants.SIGALG_SHA1_WITH_RSA);
<a class="jxr_linenumber" name="L494" href="#L494">494</a>             <em class="jxr_comment">// Generate CA keys if it is a soft CryptoToken</em>
<a class="jxr_linenumber" name="L495" href="#L495">495</a>             <strong class="jxr_keyword">if</strong> (<span class="jxr_string">"soft"</span>.equals(catokentype)) {
<a class="jxr_linenumber" name="L496" href="#L496">496</a>                 <strong class="jxr_keyword">final</strong> String signKeyAlias = caToken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN);
<a class="jxr_linenumber" name="L497" href="#L497">497</a>                 <strong class="jxr_keyword">final</strong> String signKeySpecification = <span class="jxr_string">"DSA"</span>.equals(keytype) ? <span class="jxr_string">"DSA"</span> + keyspec : keyspec;
<a class="jxr_linenumber" name="L498" href="#L498">498</a> 
<a class="jxr_linenumber" name="L499" href="#L499">499</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L500" href="#L500">500</a>                     cryptoTokenManagementSession.createKeyPair(getAuthenticationToken(), cryptoTokenId, signKeyAlias, signKeySpecification);
<a class="jxr_linenumber" name="L501" href="#L501">501</a>                 } <strong class="jxr_keyword">catch</strong> (InvalidAlgorithmParameterException e) {
<a class="jxr_linenumber" name="L502" href="#L502">502</a>                     log.error(signKeySpecification + <span class="jxr_string">" was not a valid alias: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L503" href="#L503">503</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L504" href="#L504">504</a>                 } <strong class="jxr_keyword">catch</strong> (InvalidKeyException e) {
<a class="jxr_linenumber" name="L505" href="#L505">505</a>                     log.error(<span class="jxr_string">"Key generation for alias "</span> + signKeyAlias + <span class="jxr_string">" failed."</span> + e.getMessage());
<a class="jxr_linenumber" name="L506" href="#L506">506</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L507" href="#L507">507</a>                 }
<a class="jxr_linenumber" name="L508" href="#L508">508</a>                 <strong class="jxr_keyword">final</strong> String defaultKeyAlias = caToken.getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_KEYENCRYPT);
<a class="jxr_linenumber" name="L509" href="#L509">509</a>                 <em class="jxr_comment">// Decryption key must be RSA</em>
<a class="jxr_linenumber" name="L510" href="#L510">510</a>                 <strong class="jxr_keyword">final</strong> String defaultKeySpecification = <span class="jxr_string">"RSA"</span>.equals(keytype) ? keyspec : <span class="jxr_string">"2048"</span>;
<a class="jxr_linenumber" name="L511" href="#L511">511</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L512" href="#L512">512</a>                     cryptoTokenManagementSession.createKeyPair(getAuthenticationToken(), cryptoTokenId, defaultKeyAlias, defaultKeySpecification);
<a class="jxr_linenumber" name="L513" href="#L513">513</a>                 } <strong class="jxr_keyword">catch</strong> (InvalidAlgorithmParameterException e) {
<a class="jxr_linenumber" name="L514" href="#L514">514</a>                     log.error(defaultKeySpecification + <span class="jxr_string">" was not a valid alias: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L515" href="#L515">515</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L516" href="#L516">516</a>                 } <strong class="jxr_keyword">catch</strong> (InvalidKeyException e) {
<a class="jxr_linenumber" name="L517" href="#L517">517</a>                     log.error(<span class="jxr_string">"Key generation for alias "</span> + defaultKeyAlias + <span class="jxr_string">" failed: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L518" href="#L518">518</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L519" href="#L519">519</a>                 }
<a class="jxr_linenumber" name="L520" href="#L520">520</a> 
<a class="jxr_linenumber" name="L521" href="#L521">521</a>             }
<a class="jxr_linenumber" name="L522" href="#L522">522</a>             <em class="jxr_comment">// Create the CA Info</em>
<a class="jxr_linenumber" name="L523" href="#L523">523</a>             CAInfo cainfo = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L524" href="#L524">524</a>             <strong class="jxr_keyword">switch</strong> (type) {
<a class="jxr_linenumber" name="L525" href="#L525">525</a>             <strong class="jxr_keyword">case</strong> CVC:
<a class="jxr_linenumber" name="L526" href="#L526">526</a>                 <em class="jxr_comment">// Get keysequence from SERIALNUMBER in DN is it exists</em>
<a class="jxr_linenumber" name="L527" href="#L527">527</a>                 <strong class="jxr_keyword">final</strong> String keysequence = CertTools.getPartFromDN(dn, <span class="jxr_string">"SN"</span>);
<a class="jxr_linenumber" name="L528" href="#L528">528</a>                 <strong class="jxr_keyword">if</strong> (keysequence != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L529" href="#L529">529</a>                     getLogger().info(<span class="jxr_string">"CVC key sequence: "</span> + keysequence);
<a class="jxr_linenumber" name="L530" href="#L530">530</a>                     caToken.setKeySequence(keysequence);
<a class="jxr_linenumber" name="L531" href="#L531">531</a>                     <strong class="jxr_keyword">if</strong> (StringUtils.isNumeric(keysequence)) {
<a class="jxr_linenumber" name="L532" href="#L532">532</a>                         getLogger().info(<span class="jxr_string">"CVC key sequence format is numeric."</span>);
<a class="jxr_linenumber" name="L533" href="#L533">533</a>                         caToken.setKeySequenceFormat(StringTools.KEY_SEQUENCE_FORMAT_NUMERIC);
<a class="jxr_linenumber" name="L534" href="#L534">534</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L535" href="#L535">535</a>                         getLogger().info(<span class="jxr_string">"CVC key sequence format is alphanumeric."</span>);
<a class="jxr_linenumber" name="L536" href="#L536">536</a>                         caToken.setKeySequenceFormat(StringTools.KEY_SEQUENCE_FORMAT_ALPHANUMERIC);
<a class="jxr_linenumber" name="L537" href="#L537">537</a>                     }
<a class="jxr_linenumber" name="L538" href="#L538">538</a>                 }
<a class="jxr_linenumber" name="L539" href="#L539">539</a>                 cainfo = createCVCCAInfo(dn, caname, certificateProfileId, encodedValidity, signedByCAId, caToken);
<a class="jxr_linenumber" name="L540" href="#L540">540</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L541" href="#L541">541</a>             <strong class="jxr_keyword">case</strong> X509:
<a class="jxr_linenumber" name="L542" href="#L542">542</a>                 <em class="jxr_comment">//Default, slip below.</em>
<a class="jxr_linenumber" name="L543" href="#L543">543</a>             <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L544" href="#L544">544</a>                 <em class="jxr_comment">// Create and active OSCP CA Service.</em>
<a class="jxr_linenumber" name="L545" href="#L545">545</a>                 ArrayList&lt;ExtendedCAServiceInfo&gt; extendedcaservices = <strong class="jxr_keyword">new</strong> ArrayList&lt;ExtendedCAServiceInfo&gt;();
<a class="jxr_linenumber" name="L546" href="#L546">546</a>                 String extendedServiceKeySpec = keyspec;
<a class="jxr_linenumber" name="L547" href="#L547">547</a>                 <strong class="jxr_keyword">if</strong> (keytype.equals(AlgorithmConstants.KEYALGORITHM_RSA)) {
<a class="jxr_linenumber" name="L548" href="#L548">548</a>                     <em class="jxr_comment">// Never use larger keys than 2048 bit RSA for OCSP signing</em>
<a class="jxr_linenumber" name="L549" href="#L549">549</a>                     <strong class="jxr_keyword">int</strong> len = Integer.parseInt(extendedServiceKeySpec);
<a class="jxr_linenumber" name="L550" href="#L550">550</a>                     <strong class="jxr_keyword">if</strong> (len &gt; 2048) {
<a class="jxr_linenumber" name="L551" href="#L551">551</a>                         extendedServiceKeySpec = <span class="jxr_string">"2048"</span>;
<a class="jxr_linenumber" name="L552" href="#L552">552</a>                     }
<a class="jxr_linenumber" name="L553" href="#L553">553</a>                 }
<a class="jxr_linenumber" name="L554" href="#L554">554</a>                 extendedcaservices.add(<strong class="jxr_keyword">new</strong> CmsCAServiceInfo(ExtendedCAServiceInfo.STATUS_INACTIVE, <span class="jxr_string">"CN=CmsCertificate, "</span> + dn, <span class="jxr_string">""</span>,
<a class="jxr_linenumber" name="L555" href="#L555">555</a>                         extendedServiceKeySpec, keytype));
<a class="jxr_linenumber" name="L556" href="#L556">556</a>                 extendedcaservices.add(<strong class="jxr_keyword">new</strong> HardTokenEncryptCAServiceInfo(ExtendedCAServiceInfo.STATUS_ACTIVE));
<a class="jxr_linenumber" name="L557" href="#L557">557</a>                 extendedcaservices.add(<strong class="jxr_keyword">new</strong> KeyRecoveryCAServiceInfo(ExtendedCAServiceInfo.STATUS_ACTIVE));
<a class="jxr_linenumber" name="L558" href="#L558">558</a>                 cainfo = createX509CaInfo(dn, subjectAltName, caname, certificateProfileId, encodedValidity, signedByCAId, caToken, policies, extendedcaservices);
<a class="jxr_linenumber" name="L559" href="#L559">559</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L560" href="#L560">560</a>             }
<a class="jxr_linenumber" name="L561" href="#L561">561</a>             getLogger().info(<span class="jxr_string">"Creating CA..."</span>);
<a class="jxr_linenumber" name="L562" href="#L562">562</a>             <em class="jxr_comment">// Make an error control before starting do do something else.</em>
<a class="jxr_linenumber" name="L563" href="#L563">563</a>             List&lt;Certificate&gt; cachain = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L564" href="#L564">564</a>             <strong class="jxr_keyword">if</strong> (cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA) {
<a class="jxr_linenumber" name="L565" href="#L565">565</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L566" href="#L566">566</a>                     cachain = CertTools.getCertsFromPEM(extcachainName, Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L567" href="#L567">567</a>                 } <strong class="jxr_keyword">catch</strong> (CertificateException e) {
<a class="jxr_linenumber" name="L568" href="#L568">568</a>                     log.error(<span class="jxr_string">"Certificate file "</span> + extcachainName + <span class="jxr_string">" did not contain a correct certificate."</span>);
<a class="jxr_linenumber" name="L569" href="#L569">569</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L570" href="#L570">570</a>                 }
<a class="jxr_linenumber" name="L571" href="#L571">571</a>                 <strong class="jxr_keyword">if</strong> (cachain == <strong class="jxr_keyword">null</strong> || cachain.isEmpty()) {
<a class="jxr_linenumber" name="L572" href="#L572">572</a>                     log.error(extcachainName + <span class="jxr_string">" does not seem to exist or contain any certificates in PEM format."</span>);
<a class="jxr_linenumber" name="L573" href="#L573">573</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L574" href="#L574">574</a>                 }
<a class="jxr_linenumber" name="L575" href="#L575">575</a>             }
<a class="jxr_linenumber" name="L576" href="#L576">576</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L577" href="#L577">577</a>                 EjbRemoteHelper.INSTANCE.getRemoteSession(CAAdminSessionRemote.<strong class="jxr_keyword">class</strong>).createCA(getAuthenticationToken(), cainfo);
<a class="jxr_linenumber" name="L578" href="#L578">578</a>             } <strong class="jxr_keyword">catch</strong> (CAExistsException e) {
<a class="jxr_linenumber" name="L579" href="#L579">579</a>                 log.error(<span class="jxr_string">"CA "</span> + caname + <span class="jxr_string">" already exists."</span>);
<a class="jxr_linenumber" name="L580" href="#L580">580</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L581" href="#L581">581</a>             } <strong class="jxr_keyword">catch</strong> (InvalidAlgorithmException e) {
<a class="jxr_linenumber" name="L582" href="#L582">582</a>                 log.error(<span class="jxr_string">"Algorithm was not valid: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L583" href="#L583">583</a>                 <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L584" href="#L584">584</a>             }
<a class="jxr_linenumber" name="L585" href="#L585">585</a>             <strong class="jxr_keyword">if</strong> (StringUtils.equalsIgnoreCase(explicitEcc, <span class="jxr_string">"true"</span>)) {
<a class="jxr_linenumber" name="L586" href="#L586">586</a>                 getLogger().info(
<a class="jxr_linenumber" name="L587" href="#L587">587</a>                         <span class="jxr_string">"Not re-reading CAInfo, since explicit ECC parameters were used, which is not serializable on Java 6. Use Web GUI for further interactions."</span>);
<a class="jxr_linenumber" name="L588" href="#L588">588</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L589" href="#L589">589</a>                 CAInfo newInfo;
<a class="jxr_linenumber" name="L590" href="#L590">590</a> 
<a class="jxr_linenumber" name="L591" href="#L591">591</a>                 newInfo = EjbRemoteHelper.INSTANCE.getRemoteSession(CaSessionRemote.<strong class="jxr_keyword">class</strong>).getCAInfo(getAuthenticationToken(), caname);
<a class="jxr_linenumber" name="L592" href="#L592">592</a> 
<a class="jxr_linenumber" name="L593" href="#L593">593</a>                 <strong class="jxr_keyword">int</strong> caid = newInfo.getCAId();
<a class="jxr_linenumber" name="L594" href="#L594">594</a>                 getLogger().info(<span class="jxr_string">"CAId for created CA: "</span> + caid);
<a class="jxr_linenumber" name="L595" href="#L595">595</a>             }
<a class="jxr_linenumber" name="L596" href="#L596">596</a>             <strong class="jxr_keyword">if</strong> (cainfo.getSignedBy() == CAInfo.SIGNEDBYEXTERNALCA) {
<a class="jxr_linenumber" name="L597" href="#L597">597</a>                 getLogger().info(<span class="jxr_string">"Creating a CA signed by an external CA, creating certificate request."</span>);
<a class="jxr_linenumber" name="L598" href="#L598">598</a>                 CAInfo info = EjbRemoteHelper.INSTANCE.getRemoteSession(CaSessionRemote.<strong class="jxr_keyword">class</strong>).getCAInfo(getAuthenticationToken(), caname);
<a class="jxr_linenumber" name="L599" href="#L599">599</a>                 <strong class="jxr_keyword">if</strong> (info.getStatus() != CAConstants.CA_WAITING_CERTIFICATE_RESPONSE) {
<a class="jxr_linenumber" name="L600" href="#L600">600</a>                     log.error(
<a class="jxr_linenumber" name="L601" href="#L601">601</a>                             <span class="jxr_string">"Creating a CA signed by an external CA should result in CA having status, CA_WAITING_CERTIFICATE_RESPONSE. Terminating process, please troubleshoot."</span>);
<a class="jxr_linenumber" name="L602" href="#L602">602</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L603" href="#L603">603</a>                 }
<a class="jxr_linenumber" name="L604" href="#L604">604</a>                 byte[] request;
<a class="jxr_linenumber" name="L605" href="#L605">605</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L606" href="#L606">606</a>                     request = EjbRemoteHelper.INSTANCE.getRemoteSession(CAAdminSessionRemote.<strong class="jxr_keyword">class</strong>).makeRequest(getAuthenticationToken(),
<a class="jxr_linenumber" name="L607" href="#L607">607</a>                             info.getCAId(), cachain, info.getCAToken().getAliasFromPurpose(CATokenConstants.CAKEYPURPOSE_CERTSIGN));
<a class="jxr_linenumber" name="L608" href="#L608">608</a>                 } <strong class="jxr_keyword">catch</strong> (CertPathValidatorException e) {
<a class="jxr_linenumber" name="L609" href="#L609">609</a>                     log.error(<span class="jxr_string">"Error creating certificate request for CA:"</span> + e.getMessage());
<a class="jxr_linenumber" name="L610" href="#L610">610</a>                     <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L611" href="#L611">611</a>                 }
<a class="jxr_linenumber" name="L612" href="#L612">612</a>                 <strong class="jxr_keyword">final</strong> String filename = info.getName() + <span class="jxr_string">"_csr.der"</span>;
<a class="jxr_linenumber" name="L613" href="#L613">613</a>                 FileOutputStream fos = <strong class="jxr_keyword">new</strong> FileOutputStream(filename);
<a class="jxr_linenumber" name="L614" href="#L614">614</a>                 fos.write(request);
<a class="jxr_linenumber" name="L615" href="#L615">615</a>                 fos.close();
<a class="jxr_linenumber" name="L616" href="#L616">616</a>                 getLogger().info(<span class="jxr_string">"Created CSR for CA, to be sent to external CA. Wrote CSR to file '"</span> + filename + <span class="jxr_string">"'."</span>);
<a class="jxr_linenumber" name="L617" href="#L617">617</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L618" href="#L618">618</a>                 getLogger().info(<span class="jxr_string">"Created and published initial CRL."</span>);
<a class="jxr_linenumber" name="L619" href="#L619">619</a>             }
<a class="jxr_linenumber" name="L620" href="#L620">620</a>      
<a class="jxr_linenumber" name="L621" href="#L621">621</a>             getLogger().info(<span class="jxr_string">"CA initialized"</span>);
<a class="jxr_linenumber" name="L622" href="#L622">622</a>             getLogger().info(<span class="jxr_string">"Note that any open browser sessions must be restarted to interact with this CA."</span>);
<a class="jxr_linenumber" name="L623" href="#L623">623</a>         } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L624" href="#L624">624</a>             log.error(<span class="jxr_string">"Current CLI user not authorized to create CA: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L625" href="#L625">625</a>             <strong class="jxr_keyword">return</strong> CommandResult.AUTHORIZATION_FAILURE;
<a class="jxr_linenumber" name="L626" href="#L626">626</a>         } <strong class="jxr_keyword">catch</strong> (CryptoTokenOfflineException e) {
<a class="jxr_linenumber" name="L627" href="#L627">627</a>             log.error(<span class="jxr_string">"Crypto token was unavailable: "</span> + e.getMessage());
<a class="jxr_linenumber" name="L628" href="#L628">628</a>             <strong class="jxr_keyword">return</strong> CommandResult.FUNCTIONAL_FAILURE;
<a class="jxr_linenumber" name="L629" href="#L629">629</a>         } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L630" href="#L630">630</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(<span class="jxr_string">"Unknown IOException was caught."</span>, e);
<a class="jxr_linenumber" name="L631" href="#L631">631</a>         }
<a class="jxr_linenumber" name="L632" href="#L632">632</a>         <strong class="jxr_keyword">return</strong> CommandResult.SUCCESS;
<a class="jxr_linenumber" name="L633" href="#L633">633</a>     }
<a class="jxr_linenumber" name="L634" href="#L634">634</a> 
<a class="jxr_linenumber" name="L635" href="#L635">635</a>     @Override
<a class="jxr_linenumber" name="L636" href="#L636">636</a>     <strong class="jxr_keyword">public</strong> String getMainCommand() {
<a class="jxr_linenumber" name="L637" href="#L637">637</a>         <strong class="jxr_keyword">return</strong> <span class="jxr_string">"init"</span>;
<a class="jxr_linenumber" name="L638" href="#L638">638</a>     }
<a class="jxr_linenumber" name="L639" href="#L639">639</a> 
<a class="jxr_linenumber" name="L640" href="#L640">640</a>     <strong class="jxr_keyword">private</strong> CAInfo createX509CaInfo(String dn, String subjectAltName, String caname, <strong class="jxr_keyword">int</strong> certificateProfileId, String validityString, <strong class="jxr_keyword">int</strong> signedByCAId, CAToken catokeninfo,
<a class="jxr_linenumber" name="L641" href="#L641">641</a>             List&lt;CertificatePolicy&gt; policies, List&lt;ExtendedCAServiceInfo&gt; extendedcaservices) {
<a class="jxr_linenumber" name="L642" href="#L642">642</a>         X509CAInfo cainfo = <strong class="jxr_keyword">new</strong> X509CAInfo(dn, caname, CAConstants.CA_ACTIVE, certificateProfileId, validityString,                                             
<a class="jxr_linenumber" name="L643" href="#L643">643</a>                 signedByCAId, <strong class="jxr_keyword">new</strong> ArrayList&lt;Certificate&gt;(), catokeninfo);
<a class="jxr_linenumber" name="L644" href="#L644">644</a>         cainfo.setSubjectAltName(subjectAltName);
<a class="jxr_linenumber" name="L645" href="#L645">645</a>         cainfo.setDescription(caname + <span class="jxr_string">"created using CLI"</span>);
<a class="jxr_linenumber" name="L646" href="#L646">646</a>         cainfo.setCertificateChain(<strong class="jxr_keyword">new</strong> ArrayList&lt;Certificate&gt;());
<a class="jxr_linenumber" name="L647" href="#L647">647</a>         cainfo.setPolicies(policies);
<a class="jxr_linenumber" name="L648" href="#L648">648</a>         cainfo.setExtendedCAServiceInfos(extendedcaservices);
<a class="jxr_linenumber" name="L649" href="#L649">649</a>         cainfo.setDeltaCRLPeriod(0 * SimpleTime.MILLISECONDS_PER_HOUR);
<a class="jxr_linenumber" name="L650" href="#L650">650</a>         <strong class="jxr_keyword">return</strong> cainfo;
<a class="jxr_linenumber" name="L651" href="#L651">651</a>     }
<a class="jxr_linenumber" name="L652" href="#L652">652</a> 
<a class="jxr_linenumber" name="L653" href="#L653">653</a>     <strong class="jxr_keyword">private</strong> CAInfo createCVCCAInfo(String dn, String caname, <strong class="jxr_keyword">int</strong> certificateProfileId, String validityString, <strong class="jxr_keyword">int</strong> signedByCa, CAToken catokeninfo) {
<a class="jxr_linenumber" name="L654" href="#L654">654</a>         CVCCAInfo cainfo = <strong class="jxr_keyword">new</strong> CVCCAInfo(dn, caname, CAConstants.CA_ACTIVE,
<a class="jxr_linenumber" name="L655" href="#L655">655</a>                 certificateProfileId, validityString, signedByCa, <strong class="jxr_keyword">new</strong> ArrayList&lt;Certificate&gt;(), catokeninfo);
<a class="jxr_linenumber" name="L656" href="#L656">656</a>         cainfo.setDescription(<span class="jxr_string">"Initial CA"</span>);
<a class="jxr_linenumber" name="L657" href="#L657">657</a>         <strong class="jxr_keyword">return</strong> cainfo;
<a class="jxr_linenumber" name="L658" href="#L658">658</a>     }
<a class="jxr_linenumber" name="L659" href="#L659">659</a> 
<a class="jxr_linenumber" name="L660" href="#L660">660</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> checkSubjectAltName(String subjectaltname) {
<a class="jxr_linenumber" name="L661" href="#L661">661</a>         <strong class="jxr_keyword">if</strong> (subjectaltname != <strong class="jxr_keyword">null</strong> &amp;&amp; !subjectaltname.trim().equals(<span class="jxr_string">""</span>)) {
<a class="jxr_linenumber" name="L662" href="#L662">662</a>             <strong class="jxr_keyword">final</strong> DNFieldExtractor subtest = <strong class="jxr_keyword">new</strong> DNFieldExtractor(subjectaltname,DNFieldExtractor.TYPE_SUBJECTALTNAME);                   
<a class="jxr_linenumber" name="L663" href="#L663">663</a>             <strong class="jxr_keyword">if</strong> (subtest.isIllegal() || subtest.existsOther()) {
<a class="jxr_linenumber" name="L664" href="#L664">664</a>                 <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L665" href="#L665">665</a>             }
<a class="jxr_linenumber" name="L666" href="#L666">666</a>         }
<a class="jxr_linenumber" name="L667" href="#L667">667</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L668" href="#L668">668</a>     }
<a class="jxr_linenumber" name="L669" href="#L669">669</a>     
<a class="jxr_linenumber" name="L670" href="#L670">670</a>     @Override
<a class="jxr_linenumber" name="L671" href="#L671">671</a>     <strong class="jxr_keyword">public</strong> String getCommandDescription() {
<a class="jxr_linenumber" name="L672" href="#L672">672</a>         <strong class="jxr_keyword">return</strong> <span class="jxr_string">"Create a CA and its first CRL. Publishes the CRL and CA certificate"</span>;
<a class="jxr_linenumber" name="L673" href="#L673">673</a> 
<a class="jxr_linenumber" name="L674" href="#L674">674</a>     }
<a class="jxr_linenumber" name="L675" href="#L675">675</a> 
<a class="jxr_linenumber" name="L676" href="#L676">676</a>     @Override
<a class="jxr_linenumber" name="L677" href="#L677">677</a>     <strong class="jxr_keyword">public</strong> String getFullHelpText() {
<a class="jxr_linenumber" name="L678" href="#L678">678</a>         <strong class="jxr_keyword">return</strong> getCommandDescription();
<a class="jxr_linenumber" name="L679" href="#L679">679</a>     }
<a class="jxr_linenumber" name="L680" href="#L680">680</a> 
<a class="jxr_linenumber" name="L681" href="#L681">681</a>     @Override
<a class="jxr_linenumber" name="L682" href="#L682">682</a>     <strong class="jxr_keyword">protected</strong> Logger getLogger() {
<a class="jxr_linenumber" name="L683" href="#L683">683</a>         <strong class="jxr_keyword">return</strong> log;
<a class="jxr_linenumber" name="L684" href="#L684">684</a>     }
<a class="jxr_linenumber" name="L685" href="#L685">685</a> 
<a class="jxr_linenumber" name="L686" href="#L686">686</a> }
</pre>
<hr/>
<div id="footer">Copyright &#169; 2020. All rights reserved.</div>
</body>
</html>