<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>EnrollMakeNewRequestBean xref</title>
<link type="text/css" rel="stylesheet" href="../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../apidocs/org/ejbca/ra/EnrollMakeNewRequestBean.html">View Javadoc</a></div><pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_javadoccomment">/*************************************************************************</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_javadoccomment"> *  EJBCA Community: The OpenSource Certificate Authority                *</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_javadoccomment"> *  This software is free software; you can redistribute it and/or       *</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_javadoccomment"> *  modify it under the terms of the GNU Lesser General Public           *</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_javadoccomment"> *  License as published by the Free Software Foundation; either         *</em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_javadoccomment"> *  version 2.1 of the License, or any later version.                    *</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_javadoccomment"> *  See terms of license at gnu.org.                                     *</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_javadoccomment"> *************************************************************************/</em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  <strong class="jxr_keyword">package</strong> org.ejbca.ra;
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <strong class="jxr_keyword">import</strong> java.io.IOException;
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <strong class="jxr_keyword">import</strong> java.io.OutputStream;
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <strong class="jxr_keyword">import</strong> java.io.Serializable;
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <strong class="jxr_keyword">import</strong> java.security.InvalidKeyException;
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <strong class="jxr_keyword">import</strong> java.security.NoSuchAlgorithmException;
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <strong class="jxr_keyword">import</strong> java.security.PublicKey;
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  <strong class="jxr_keyword">import</strong> java.security.SecureRandom;
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <strong class="jxr_keyword">import</strong> java.security.cert.Certificate;
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertificateEncodingException;
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertificateParsingException;
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <strong class="jxr_keyword">import</strong> java.security.cert.X509Certificate;
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <strong class="jxr_keyword">import</strong> java.util.Arrays;
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <strong class="jxr_keyword">import</strong> java.util.Collection;
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <strong class="jxr_keyword">import</strong> java.util.Collections;
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <strong class="jxr_keyword">import</strong> java.util.Comparator;
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <strong class="jxr_keyword">import</strong> java.util.Date;
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  <strong class="jxr_keyword">import</strong> java.util.HashSet;
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  <strong class="jxr_keyword">import</strong> java.util.LinkedList;
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <strong class="jxr_keyword">import</strong> java.util.Random;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <strong class="jxr_keyword">import</strong> java.util.Set;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <strong class="jxr_keyword">import</strong> javax.annotation.PostConstruct;
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <strong class="jxr_keyword">import</strong> javax.ejb.EJB;
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <strong class="jxr_keyword">import</strong> javax.faces.application.FacesMessage;
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ManagedBean;
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ManagedProperty;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ViewScoped;
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <strong class="jxr_keyword">import</strong> javax.faces.component.UIComponent;
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  <strong class="jxr_keyword">import</strong> javax.faces.component.UIInput;
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <strong class="jxr_keyword">import</strong> javax.faces.context.ExternalContext;
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <strong class="jxr_keyword">import</strong> javax.faces.context.FacesContext;
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <strong class="jxr_keyword">import</strong> javax.faces.event.AjaxBehaviorEvent;
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <strong class="jxr_keyword">import</strong> javax.faces.event.ComponentSystemEvent;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <strong class="jxr_keyword">import</strong> javax.faces.model.SelectItem;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <strong class="jxr_keyword">import</strong> javax.faces.validator.ValidatorException;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <strong class="jxr_keyword">import</strong> org.apache.commons.codec.binary.Base64;
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  <strong class="jxr_keyword">import</strong> org.apache.commons.lang.StringUtils;
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <strong class="jxr_keyword">import</strong> org.apache.log4j.Logger;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <strong class="jxr_keyword">import</strong> org.apache.myfaces.custom.fileupload.UploadedFile;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.asn1.x509.Extension;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.cms.CMSException;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.pkcs.PKCS10CertificationRequest;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.pkcs.jcajce.JcaPKCS10CertificationRequest;
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.util.encoders.Hex;
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <strong class="jxr_keyword">import</strong> org.cesecore.ErrorCode;
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <strong class="jxr_keyword">import</strong> org.cesecore.authorization.AuthorizationDeniedException;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.ApprovalRequestType;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CAInfo;
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.X509CAInfo;
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificateProfile;
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityConstants;
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityInformation;
<a class="jxr_linenumber" name="L70" href="#L70">70</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityType;
<a class="jxr_linenumber" name="L71" href="#L71">71</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityTypes;
<a class="jxr_linenumber" name="L72" href="#L72">72</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.ExtendedInformation;
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.AlgorithmConstants;
<a class="jxr_linenumber" name="L74" href="#L74">74</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.AlgorithmTools;
<a class="jxr_linenumber" name="L75" href="#L75">75</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.DnComponents;
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  <strong class="jxr_keyword">import</strong> org.cesecore.config.CesecoreConfiguration;
<a class="jxr_linenumber" name="L77" href="#L77">77</a>  <strong class="jxr_keyword">import</strong> org.cesecore.keys.util.KeyTools;
<a class="jxr_linenumber" name="L78" href="#L78">78</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.CeSecoreNameStyle;
<a class="jxr_linenumber" name="L79" href="#L79">79</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.CertTools;
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.PrintableStringNameStyle;
<a class="jxr_linenumber" name="L81" href="#L81">81</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.StringTools;
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.ValidityDate;
<a class="jxr_linenumber" name="L83" href="#L83">83</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.EjbcaException;
<a class="jxr_linenumber" name="L84" href="#L84">84</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.SecConst;
<a class="jxr_linenumber" name="L85" href="#L85">85</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.TokenDownloadType;
<a class="jxr_linenumber" name="L86" href="#L86">86</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.approval.WaitingForApprovalException;
<a class="jxr_linenumber" name="L87" href="#L87">87</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.authorization.AccessRulesConstants;
<a class="jxr_linenumber" name="L88" href="#L88">88</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.IdNameHashMap;
<a class="jxr_linenumber" name="L89" href="#L89">89</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.KeyToValueHolder;
<a class="jxr_linenumber" name="L90" href="#L90">90</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.RaMasterApiProxyBeanLocal;
<a class="jxr_linenumber" name="L91" href="#L91">91</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ra.raadmin.EndEntityProfile;
<a class="jxr_linenumber" name="L92" href="#L92">92</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ra.raadmin.EndEntityProfile.FieldInstance;
<a class="jxr_linenumber" name="L93" href="#L93">93</a>  
<a class="jxr_linenumber" name="L94" href="#L94">94</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L95" href="#L95">95</a>  <em class="jxr_javadoccomment"> * Managed bean that backs up the enrollingmakenewrequest.xhtml page.</em>
<a class="jxr_linenumber" name="L96" href="#L96">96</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L97" href="#L97">97</a>  <em class="jxr_javadoccomment"> * DEVELOP NOTE:</em>
<a class="jxr_linenumber" name="L98" href="#L98">98</a>  <em class="jxr_javadoccomment"> * Since the page this bean backs up has pretty advanced dependencies for what should be rendered when,</em>
<a class="jxr_linenumber" name="L99" href="#L99">99</a>  <em class="jxr_javadoccomment"> * an unconventional pattern is used where getters will calculate their current value based on the</em>
<a class="jxr_linenumber" name="L100" href="#L100">100</a> <em class="jxr_javadoccomment"> * current state of their dependencies.</em>
<a class="jxr_linenumber" name="L101" href="#L101">101</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L102" href="#L102">102</a> <em class="jxr_javadoccomment"> * (The normal pattern would be that changes/actions should calculate and modify everything that is</em>
<a class="jxr_linenumber" name="L103" href="#L103">103</a> <em class="jxr_javadoccomment"> * effected by this change. This would be harder to code and maintain since you have to think about</em>
<a class="jxr_linenumber" name="L104" href="#L104">104</a> <em class="jxr_javadoccomment"> * all permutations that could potentially be affected down the line.)</em>
<a class="jxr_linenumber" name="L105" href="#L105">105</a> <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L106" href="#L106">106</a> <em class="jxr_javadoccomment"> * @version $Id: EnrollMakeNewRequestBean.java 34396 2020-01-28 13:50:08Z samuellb $</em>
<a class="jxr_linenumber" name="L107" href="#L107">107</a> <em class="jxr_javadoccomment"> * TODO: Use CDI beans</em>
<a class="jxr_linenumber" name="L108" href="#L108">108</a> <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L109" href="#L109">109</a> @SuppressWarnings(<span class="jxr_string">"deprecation"</span>)
<a class="jxr_linenumber" name="L110" href="#L110">110</a> @ManagedBean
<a class="jxr_linenumber" name="L111" href="#L111">111</a> @ViewScoped
<a class="jxr_linenumber" name="L112" href="#L112">112</a> <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> <a name="EnrollMakeNewRequestBean" href="../../../org/ejbca/ra/EnrollMakeNewRequestBean.html#EnrollMakeNewRequestBean">EnrollMakeNewRequestBean</a> <strong class="jxr_keyword">implements</strong> Serializable {
<a class="jxr_linenumber" name="L113" href="#L113">113</a> 
<a class="jxr_linenumber" name="L114" href="#L114">114</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> serialVersionUID = 1L;
<a class="jxr_linenumber" name="L115" href="#L115">115</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Logger log = Logger.getLogger(EnrollMakeNewRequestBean.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L116" href="#L116">116</a> 
<a class="jxr_linenumber" name="L117" href="#L117">117</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> String PARAM_REQUESTID = <span class="jxr_string">"requestId"</span>;
<a class="jxr_linenumber" name="L118" href="#L118">118</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">int</strong> MAX_CSR_LENGTH = 10240;
<a class="jxr_linenumber" name="L119" href="#L119">119</a> 
<a class="jxr_linenumber" name="L120" href="#L120">120</a>     @EJB
<a class="jxr_linenumber" name="L121" href="#L121">121</a>     <strong class="jxr_keyword">private</strong> RaMasterApiProxyBeanLocal raMasterApiProxyBean;
<a class="jxr_linenumber" name="L122" href="#L122">122</a> 
<a class="jxr_linenumber" name="L123" href="#L123">123</a>     @ManagedProperty(value = <span class="jxr_string">"#{raAuthenticationBean}"</span>)
<a class="jxr_linenumber" name="L124" href="#L124">124</a>     <strong class="jxr_keyword">private</strong> <a name="RaAuthenticationBean" href="../../../org/ejbca/ra/RaAuthenticationBean.html#RaAuthenticationBean">RaAuthenticationBean</a> raAuthenticationBean;
<a class="jxr_linenumber" name="L125" href="#L125">125</a> 
<a class="jxr_linenumber" name="L126" href="#L126">126</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRaAuthenticationBean(<strong class="jxr_keyword">final</strong> <a name="RaAuthenticationBean" href="../../../org/ejbca/ra/RaAuthenticationBean.html#RaAuthenticationBean">RaAuthenticationBean</a> raAuthenticationBean) {
<a class="jxr_linenumber" name="L127" href="#L127">127</a>         <strong class="jxr_keyword">this</strong>.raAuthenticationBean = raAuthenticationBean;
<a class="jxr_linenumber" name="L128" href="#L128">128</a>     }
<a class="jxr_linenumber" name="L129" href="#L129">129</a> 
<a class="jxr_linenumber" name="L130" href="#L130">130</a>     @ManagedProperty(value = <span class="jxr_string">"#{raLocaleBean}"</span>)
<a class="jxr_linenumber" name="L131" href="#L131">131</a>     <strong class="jxr_keyword">private</strong> <a name="RaLocaleBean" href="../../../org/ejbca/ra/RaLocaleBean.html#RaLocaleBean">RaLocaleBean</a> raLocaleBean;
<a class="jxr_linenumber" name="L132" href="#L132">132</a> 
<a class="jxr_linenumber" name="L133" href="#L133">133</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRaLocaleBean(<strong class="jxr_keyword">final</strong> <a name="RaLocaleBean" href="../../../org/ejbca/ra/RaLocaleBean.html#RaLocaleBean">RaLocaleBean</a> raLocaleBean) {
<a class="jxr_linenumber" name="L134" href="#L134">134</a>         <strong class="jxr_keyword">this</strong>.raLocaleBean = raLocaleBean;
<a class="jxr_linenumber" name="L135" href="#L135">135</a>     }
<a class="jxr_linenumber" name="L136" href="#L136">136</a> 
<a class="jxr_linenumber" name="L137" href="#L137">137</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> renderNonModifiableTemplates = false;
<a class="jxr_linenumber" name="L138" href="#L138">138</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> renderNonModifiableFields = false;
<a class="jxr_linenumber" name="L139" href="#L139">139</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;EndEntityProfile&gt; authorizedEndEntityProfiles = <strong class="jxr_keyword">new</strong> IdNameHashMap&lt;EndEntityProfile&gt;();
<a class="jxr_linenumber" name="L140" href="#L140">140</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;CertificateProfile&gt; authorizedCertificateProfiles = <strong class="jxr_keyword">new</strong> IdNameHashMap&lt;&gt;();
<a class="jxr_linenumber" name="L141" href="#L141">141</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;CAInfo&gt; authorizedCAInfos = <strong class="jxr_keyword">new</strong> IdNameHashMap&lt;CAInfo&gt;();
<a class="jxr_linenumber" name="L142" href="#L142">142</a>     <strong class="jxr_keyword">private</strong> String selectedEndEntityProfile;
<a class="jxr_linenumber" name="L143" href="#L143">143</a>     <strong class="jxr_keyword">private</strong> String selectedCertificateProfile;
<a class="jxr_linenumber" name="L144" href="#L144">144</a>     <strong class="jxr_keyword">private</strong> String selectedCertificateAuthority;
<a class="jxr_linenumber" name="L145" href="#L145">145</a>     <strong class="jxr_keyword">private</strong> String validity = StringUtils.EMPTY;
<a class="jxr_linenumber" name="L146" href="#L146">146</a> 
<a class="jxr_linenumber" name="L147" href="#L147">147</a>     <em class="jxr_javadoccomment">/** Is private key generated by the server (CA) or is the key provided by the user (usually in the form of a CSR) */</em>
<a class="jxr_linenumber" name="L148" href="#L148">148</a>     <strong class="jxr_keyword">public</strong> enum KeyPairGeneration {
<a class="jxr_linenumber" name="L149" href="#L149">149</a>         ON_SERVER,
<a class="jxr_linenumber" name="L150" href="#L150">150</a>         PROVIDED_BY_USER;
<a class="jxr_linenumber" name="L151" href="#L151">151</a>     }
<a class="jxr_linenumber" name="L152" href="#L152">152</a>     <strong class="jxr_keyword">private</strong> KeyPairGeneration selectedKeyPairGeneration;
<a class="jxr_linenumber" name="L153" href="#L153">153</a>     <em class="jxr_javadoccomment">/** Heavy to calculate and needs to be cached. */</em>
<a class="jxr_linenumber" name="L154" href="#L154">154</a>     <strong class="jxr_keyword">private</strong> List&lt;SelectItem&gt; availableAlgorithmSelectItems = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L155" href="#L155">155</a> 
<a class="jxr_linenumber" name="L156" href="#L156">156</a>     <strong class="jxr_keyword">private</strong> String selectedAlgorithm; <em class="jxr_comment">//GENERATED ON SERVER</em>
<a class="jxr_linenumber" name="L157" href="#L157">157</a>     <strong class="jxr_keyword">private</strong> String algorithmFromCsr; <em class="jxr_comment">//PROVIDED BY USER</em>
<a class="jxr_linenumber" name="L158" href="#L158">158</a>     <strong class="jxr_keyword">private</strong> UploadedFile uploadFile;
<a class="jxr_linenumber" name="L159" href="#L159">159</a>     <strong class="jxr_keyword">private</strong> String certificateRequest;
<a class="jxr_linenumber" name="L160" href="#L160">160</a>     <strong class="jxr_keyword">private</strong> String publicKeyModulus;
<a class="jxr_linenumber" name="L161" href="#L161">161</a>     <strong class="jxr_keyword">private</strong> String publicKeyExponent;
<a class="jxr_linenumber" name="L162" href="#L162">162</a>     <strong class="jxr_keyword">private</strong> String sha256Fingerprint;
<a class="jxr_linenumber" name="L163" href="#L163">163</a>     <strong class="jxr_keyword">private</strong> String signature;
<a class="jxr_linenumber" name="L164" href="#L164">164</a>     <strong class="jxr_keyword">private</strong> String csrFileName;
<a class="jxr_linenumber" name="L165" href="#L165">165</a>     <strong class="jxr_keyword">private</strong> <a name="SubjectDn" href="../../../org/ejbca/ra/SubjectDn.html#SubjectDn">SubjectDn</a> subjectDn;
<a class="jxr_linenumber" name="L166" href="#L166">166</a>     <strong class="jxr_keyword">private</strong> <a name="SubjectAlternativeName" href="../../../org/ejbca/ra/SubjectAlternativeName.html#SubjectAlternativeName">SubjectAlternativeName</a> subjectAlternativeName;
<a class="jxr_linenumber" name="L167" href="#L167">167</a>     <strong class="jxr_keyword">private</strong> <a name="SubjectDirectoryAttributes" href="../../../org/ejbca/ra/SubjectDirectoryAttributes.html#SubjectDirectoryAttributes">SubjectDirectoryAttributes</a> subjectDirectoryAttributes;
<a class="jxr_linenumber" name="L168" href="#L168">168</a>     <strong class="jxr_keyword">private</strong> EndEntityInformation endEntityInformation;
<a class="jxr_linenumber" name="L169" href="#L169">169</a>     <strong class="jxr_keyword">private</strong> String confirmPassword;
<a class="jxr_linenumber" name="L170" href="#L170">170</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> requestId;
<a class="jxr_linenumber" name="L171" href="#L171">171</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> requestPreviewMoreDetails;
<a class="jxr_linenumber" name="L172" href="#L172">172</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> setCustomValidity;
<a class="jxr_linenumber" name="L173" href="#L173">173</a>     <strong class="jxr_keyword">private</strong> UIComponent subjectDnMessagesComponent;
<a class="jxr_linenumber" name="L174" href="#L174">174</a>     <strong class="jxr_keyword">private</strong> UIComponent userCredentialsMessagesComponent;
<a class="jxr_linenumber" name="L175" href="#L175">175</a>     <strong class="jxr_keyword">private</strong> UIComponent confirmPasswordComponent;
<a class="jxr_linenumber" name="L176" href="#L176">176</a>     <strong class="jxr_keyword">private</strong> UIComponent validityInputComponent;
<a class="jxr_linenumber" name="L177" href="#L177">177</a> 
<a class="jxr_linenumber" name="L178" href="#L178">178</a>     @PostConstruct
<a class="jxr_linenumber" name="L179" href="#L179">179</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> postContruct() {
<a class="jxr_linenumber" name="L180" href="#L180">180</a>         <strong class="jxr_keyword">this</strong>.authorizedEndEntityProfiles = raMasterApiProxyBean.getAuthorizedEndEntityProfiles(raAuthenticationBean.getAuthenticationToken(), AccessRulesConstants.CREATE_END_ENTITY);
<a class="jxr_linenumber" name="L181" href="#L181">181</a>         <strong class="jxr_keyword">this</strong>.authorizedCertificateProfiles = raMasterApiProxyBean.getAuthorizedCertificateProfiles(raAuthenticationBean.getAuthenticationToken());
<a class="jxr_linenumber" name="L182" href="#L182">182</a>         <strong class="jxr_keyword">this</strong>.authorizedCAInfos = raMasterApiProxyBean.getAuthorizedCAInfos(raAuthenticationBean.getAuthenticationToken());
<a class="jxr_linenumber" name="L183" href="#L183">183</a>     }
<a class="jxr_linenumber" name="L184" href="#L184">184</a> 
<a class="jxr_linenumber" name="L185" href="#L185">185</a>     <em class="jxr_comment">//-----------------------------------------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L186" href="#L186">186</a>     <em class="jxr_comment">// Helpers and is*Rendered() methods</em>
<a class="jxr_linenumber" name="L187" href="#L187">187</a> 
<a class="jxr_linenumber" name="L188" href="#L188">188</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRequestIdInfoRendered(){
<a class="jxr_linenumber" name="L189" href="#L189">189</a>         <strong class="jxr_keyword">return</strong> requestId != 0;
<a class="jxr_linenumber" name="L190" href="#L190">190</a>     }
<a class="jxr_linenumber" name="L191" href="#L191">191</a> 
<a class="jxr_linenumber" name="L192" href="#L192">192</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isUsernameRendered(){
<a class="jxr_linenumber" name="L193" href="#L193">193</a>         <strong class="jxr_keyword">return</strong> !getEndEntityProfile().isAutoGeneratedUsername();
<a class="jxr_linenumber" name="L194" href="#L194">194</a>     }
<a class="jxr_linenumber" name="L195" href="#L195">195</a> 
<a class="jxr_linenumber" name="L196" href="#L196">196</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isPasswordRendered() {
<a class="jxr_linenumber" name="L197" href="#L197">197</a>         <strong class="jxr_keyword">return</strong> getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp;
<a class="jxr_linenumber" name="L198" href="#L198">198</a>                 (isApprovalRequired() || KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) &amp;&amp;
<a class="jxr_linenumber" name="L199" href="#L199">199</a>                  !getEndEntityProfile().useAutoGeneratedPasswd();
<a class="jxr_linenumber" name="L200" href="#L200">200</a>     }
<a class="jxr_linenumber" name="L201" href="#L201">201</a> 
<a class="jxr_linenumber" name="L202" href="#L202">202</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isEmailRendered(){
<a class="jxr_linenumber" name="L203" href="#L203">203</a>         <strong class="jxr_keyword">return</strong> getEndEntityProfile().getUse(EndEntityProfile.EMAIL, 0);
<a class="jxr_linenumber" name="L204" href="#L204">204</a>     }
<a class="jxr_linenumber" name="L205" href="#L205">205</a> 
<a class="jxr_linenumber" name="L206" href="#L206">206</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isEmailRequired(){
<a class="jxr_linenumber" name="L207" href="#L207">207</a>         <strong class="jxr_keyword">return</strong> getEndEntityProfile().isRequired(EndEntityProfile.SENDNOTIFICATION, 0) ||
<a class="jxr_linenumber" name="L208" href="#L208">208</a>                 getEndEntityProfile().isRequired(EndEntityProfile.EMAIL, 0);
<a class="jxr_linenumber" name="L209" href="#L209">209</a>     }
<a class="jxr_linenumber" name="L210" href="#L210">210</a> 
<a class="jxr_linenumber" name="L211" href="#L211">211</a>     <em class="jxr_javadoccomment">/** @return true if keystore download options in JKS format should be provided (e.g. keystore generation was used and no approvals are required) */</em>
<a class="jxr_linenumber" name="L212" href="#L212">212</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isGenerateJksButtonRendered() {
<a class="jxr_linenumber" name="L213" href="#L213">213</a>         EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L214" href="#L214">214</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L215" href="#L215">215</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L216" href="#L216">216</a>         }
<a class="jxr_linenumber" name="L217" href="#L217">217</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L218" href="#L218">218</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_JKS))
<a class="jxr_linenumber" name="L219" href="#L219">219</a>                 &amp;&amp; getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp; KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())
<a class="jxr_linenumber" name="L220" href="#L220">220</a>                 &amp;&amp; !isApprovalRequired();
<a class="jxr_linenumber" name="L221" href="#L221">221</a>     }
<a class="jxr_linenumber" name="L222" href="#L222">222</a> 
<a class="jxr_linenumber" name="L223" href="#L223">223</a>     <em class="jxr_javadoccomment">/** @return true if keystore download options in PKCS#12 format should be provided (e.g. keystore generation was used and no approvals are required) */</em>
<a class="jxr_linenumber" name="L224" href="#L224">224</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isGenerateP12ButtonRendered() {
<a class="jxr_linenumber" name="L225" href="#L225">225</a>         EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L226" href="#L226">226</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L227" href="#L227">227</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L228" href="#L228">228</a>         }
<a class="jxr_linenumber" name="L229" href="#L229">229</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L230" href="#L230">230</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_P12))
<a class="jxr_linenumber" name="L231" href="#L231">231</a>                 &amp;&amp; getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp; KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())
<a class="jxr_linenumber" name="L232" href="#L232">232</a>                 &amp;&amp; !isApprovalRequired();
<a class="jxr_linenumber" name="L233" href="#L233">233</a>     }
<a class="jxr_linenumber" name="L234" href="#L234">234</a> 
<a class="jxr_linenumber" name="L235" href="#L235">235</a>     <em class="jxr_javadoccomment">/** @return true if keystore download options in PEM format should be provided (e.g. keystore generation was used and no approvals are required) */</em>
<a class="jxr_linenumber" name="L236" href="#L236">236</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isGeneratePemButtonRendered() {
<a class="jxr_linenumber" name="L237" href="#L237">237</a>         EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L238" href="#L238">238</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L239" href="#L239">239</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L240" href="#L240">240</a>         }
<a class="jxr_linenumber" name="L241" href="#L241">241</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L242" href="#L242">242</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_PEM))
<a class="jxr_linenumber" name="L243" href="#L243">243</a>                 &amp;&amp; getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp; KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())
<a class="jxr_linenumber" name="L244" href="#L244">244</a>                 &amp;&amp; !isApprovalRequired();
<a class="jxr_linenumber" name="L245" href="#L245">245</a>     }
<a class="jxr_linenumber" name="L246" href="#L246">246</a> 
<a class="jxr_linenumber" name="L247" href="#L247">247</a>     <em class="jxr_javadoccomment">/** @return true if certificate download options should be provided (e.g. a CSR was used and no approvals are required) */</em>
<a class="jxr_linenumber" name="L248" href="#L248">248</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isGenerateFromCsrButtonRendered() {
<a class="jxr_linenumber" name="L249" href="#L249">249</a>         EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L250" href="#L250">250</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L251" href="#L251">251</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L252" href="#L252">252</a>         }
<a class="jxr_linenumber" name="L253" href="#L253">253</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L254" href="#L254">254</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(EndEntityConstants.TOKEN_USERGEN))
<a class="jxr_linenumber" name="L255" href="#L255">255</a>                 &amp;&amp; getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp; KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum())
<a class="jxr_linenumber" name="L256" href="#L256">256</a>                 &amp;&amp; !isApprovalRequired();
<a class="jxr_linenumber" name="L257" href="#L257">257</a>     }
<a class="jxr_linenumber" name="L258" href="#L258">258</a> 
<a class="jxr_linenumber" name="L259" href="#L259">259</a>     <em class="jxr_javadoccomment">/** @return true if the current selection will require approvals */</em>
<a class="jxr_linenumber" name="L260" href="#L260">260</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isConfirmRequestButtonRendered(){
<a class="jxr_linenumber" name="L261" href="#L261">261</a>         <strong class="jxr_keyword">return</strong> isApprovalRequired();
<a class="jxr_linenumber" name="L262" href="#L262">262</a>     }
<a class="jxr_linenumber" name="L263" href="#L263">263</a> 
<a class="jxr_linenumber" name="L264" href="#L264">264</a>     <em class="jxr_javadoccomment">/** @return true if approvals are required as determined by state of dependencies by checking the RA API. */</em>
<a class="jxr_linenumber" name="L265" href="#L265">265</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isApprovalRequired() {
<a class="jxr_linenumber" name="L266" href="#L266">266</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L267" href="#L267">267</a>             <strong class="jxr_keyword">return</strong> raMasterApiProxyBean.getApprovalProfileForAction(raAuthenticationBean.getAuthenticationToken(),
<a class="jxr_linenumber" name="L268" href="#L268">268</a>                     ApprovalRequestType.ADDEDITENDENTITY, getCAInfo().getCAId(),
<a class="jxr_linenumber" name="L269" href="#L269">269</a>                     getAuthorizedCertificateProfiles().get(Integer.parseInt(getSelectedCertificateProfile())).getId()) != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L270" href="#L270">270</a>         } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L271" href="#L271">271</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(e);
<a class="jxr_linenumber" name="L272" href="#L272">272</a>         }
<a class="jxr_linenumber" name="L273" href="#L273">273</a>     }
<a class="jxr_linenumber" name="L274" href="#L274">274</a> 
<a class="jxr_linenumber" name="L275" href="#L275">275</a>     <em class="jxr_javadoccomment">/** @return true if when the certificate preview box should be rendered */</em>
<a class="jxr_linenumber" name="L276" href="#L276">276</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isUpdateRequestPreviewButtonRendered() {
<a class="jxr_linenumber" name="L277" href="#L277">277</a>         <strong class="jxr_keyword">return</strong> isKeyAlgorithmAvailable();
<a class="jxr_linenumber" name="L278" href="#L278">278</a>     }
<a class="jxr_linenumber" name="L279" href="#L279">279</a> 
<a class="jxr_linenumber" name="L280" href="#L280">280</a>     <em class="jxr_javadoccomment">/** @return true if the selection of certificate template should be rendered */</em>
<a class="jxr_linenumber" name="L281" href="#L281">281</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectRequestTemplateRendered() {
<a class="jxr_linenumber" name="L282" href="#L282">282</a>         <strong class="jxr_keyword">return</strong> isSelectEndEntityProfileRendered() || isSelectCertificateProfileRendered() || isSelectCertificateAuthorityRendered() || isSelectKeyPairGenerationRendered();
<a class="jxr_linenumber" name="L283" href="#L283">283</a>     }
<a class="jxr_linenumber" name="L284" href="#L284">284</a>     <em class="jxr_javadoccomment">/** @return true if the selection of end entity profile ("certificate type") should be rendered */</em>
<a class="jxr_linenumber" name="L285" href="#L285">285</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectEndEntityProfileRendered() {
<a class="jxr_linenumber" name="L286" href="#L286">286</a>         <strong class="jxr_keyword">return</strong> getAvailableEndEntityProfiles().size()&gt;1 ||
<a class="jxr_linenumber" name="L287" href="#L287">287</a>                 (getAvailableEndEntityProfiles().size()==1 &amp;&amp; isRenderNonModifiableTemplates());
<a class="jxr_linenumber" name="L288" href="#L288">288</a>     }
<a class="jxr_linenumber" name="L289" href="#L289">289</a>     <em class="jxr_javadoccomment">/** @return true if the selection of certificate profile ("certificate sub-type") should be rendered */</em>
<a class="jxr_linenumber" name="L290" href="#L290">290</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectCertificateProfileRendered() {
<a class="jxr_linenumber" name="L291" href="#L291">291</a>         <strong class="jxr_keyword">return</strong> StringUtils.isNotEmpty(getSelectedEndEntityProfile()) &amp;&amp; (getAvailableCertificateProfiles().size()&gt;1 ||
<a class="jxr_linenumber" name="L292" href="#L292">292</a>                 (getAvailableCertificateProfiles().size()==1 &amp;&amp; isRenderNonModifiableTemplates()));
<a class="jxr_linenumber" name="L293" href="#L293">293</a>     }
<a class="jxr_linenumber" name="L294" href="#L294">294</a>     <em class="jxr_javadoccomment">/** @return true if the selection of certificate authority should be rendered */</em>
<a class="jxr_linenumber" name="L295" href="#L295">295</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectCertificateAuthorityRendered() {
<a class="jxr_linenumber" name="L296" href="#L296">296</a>         <strong class="jxr_keyword">return</strong> StringUtils.isNotEmpty(getSelectedCertificateProfile()) &amp;&amp; (getAvailableCertificateAuthorities().size()&gt;1 ||
<a class="jxr_linenumber" name="L297" href="#L297">297</a>                 (getAvailableCertificateAuthorities().size()==1 &amp;&amp; isRenderNonModifiableTemplates()));
<a class="jxr_linenumber" name="L298" href="#L298">298</a>     }
<a class="jxr_linenumber" name="L299" href="#L299">299</a>     <em class="jxr_javadoccomment">/** @return true if the selection of key generation type should be rendered */</em>
<a class="jxr_linenumber" name="L300" href="#L300">300</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectKeyPairGenerationRendered() {
<a class="jxr_linenumber" name="L301" href="#L301">301</a>         <strong class="jxr_keyword">return</strong> StringUtils.isNotEmpty(getSelectedCertificateAuthority()) &amp;&amp; (getAvailableKeyPairGenerations().size()&gt;1 ||
<a class="jxr_linenumber" name="L302" href="#L302">302</a>                 (getAvailableKeyPairGenerations().size()==1 &amp;&amp; isRenderNonModifiableTemplates()));
<a class="jxr_linenumber" name="L303" href="#L303">303</a>     }
<a class="jxr_linenumber" name="L304" href="#L304">304</a> 
<a class="jxr_linenumber" name="L305" href="#L305">305</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L306" href="#L306">306</a> <em class="jxr_javadoccomment">     * Creates a help message whose content depends on the current value of the 'Validity'-field.</em>
<a class="jxr_linenumber" name="L307" href="#L307">307</a> <em class="jxr_javadoccomment">     * The help message reflects one of the following four (error) states:</em>
<a class="jxr_linenumber" name="L308" href="#L308">308</a> <em class="jxr_javadoccomment">     * &lt;ul&gt;</em>
<a class="jxr_linenumber" name="L309" href="#L309">309</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity is empty&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L310" href="#L310">310</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity is non-empty but cannot be parsed&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L311" href="#L311">311</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity is a parsable date or time interval but exceeds the maximum validity specified by the certificate profile&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L312" href="#L312">312</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity is valid (no error)&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L313" href="#L313">313</a> <em class="jxr_javadoccomment">     * &lt;/ul&gt;</em>
<a class="jxr_linenumber" name="L314" href="#L314">314</a> <em class="jxr_javadoccomment">     * @return String</em>
<a class="jxr_linenumber" name="L315" href="#L315">315</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L316" href="#L316">316</a>     <strong class="jxr_keyword">public</strong> String getValidityHelpMessage() {
<a class="jxr_linenumber" name="L317" href="#L317">317</a>         <strong class="jxr_keyword">if</strong> (validity == <strong class="jxr_keyword">null</strong> || validity.isEmpty()) {
<a class="jxr_linenumber" name="L318" href="#L318">318</a>             <strong class="jxr_keyword">return</strong> raLocaleBean.getMessage(<span class="jxr_string">"enroll_validity_help_empty"</span>);
<a class="jxr_linenumber" name="L319" href="#L319">319</a>         }
<a class="jxr_linenumber" name="L320" href="#L320">320</a>         <strong class="jxr_keyword">final</strong> Date now = <strong class="jxr_keyword">new</strong> Date();
<a class="jxr_linenumber" name="L321" href="#L321">321</a>         <strong class="jxr_keyword">final</strong> Date validityDate = ValidityDate.getDate(validity, now);
<a class="jxr_linenumber" name="L322" href="#L322">322</a>         <strong class="jxr_keyword">if</strong> (validityDate == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L323" href="#L323">323</a>             <strong class="jxr_keyword">return</strong> raLocaleBean.getMessage(<span class="jxr_string">"enroll_validity_help_unparsable"</span>);
<a class="jxr_linenumber" name="L324" href="#L324">324</a>         }
<a class="jxr_linenumber" name="L325" href="#L325">325</a>         <strong class="jxr_keyword">final</strong> Date maxDate = ValidityDate.getDate(getCertificateProfile().getEncodedValidity(), now);
<a class="jxr_linenumber" name="L326" href="#L326">326</a>         <strong class="jxr_keyword">if</strong> (validityDate.after(maxDate)) {
<a class="jxr_linenumber" name="L327" href="#L327">327</a>             <strong class="jxr_keyword">return</strong> raLocaleBean.getMessage(<span class="jxr_string">"enroll_validity_help_too_long"</span>);
<a class="jxr_linenumber" name="L328" href="#L328">328</a>         }
<a class="jxr_linenumber" name="L329" href="#L329">329</a>         <em class="jxr_comment">// No help needed</em>
<a class="jxr_linenumber" name="L330" href="#L330">330</a>         <strong class="jxr_keyword">return</strong> StringUtils.EMPTY;
<a class="jxr_linenumber" name="L331" href="#L331">331</a>     }
<a class="jxr_linenumber" name="L332" href="#L332">332</a> 
<a class="jxr_linenumber" name="L333" href="#L333">333</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L334" href="#L334">334</a> <em class="jxr_javadoccomment">     * Determines whether any non-modifiable (disabled) templates are rendered or exists as hidden.</em>
<a class="jxr_linenumber" name="L335" href="#L335">335</a> <em class="jxr_javadoccomment">     * If the selectable items havn't been selected yet, false is returned to not confuse a hidden item with an</em>
<a class="jxr_linenumber" name="L336" href="#L336">336</a> <em class="jxr_javadoccomment">     * unselected item (hence we check if an item is not rendered AND selected).</em>
<a class="jxr_linenumber" name="L337" href="#L337">337</a> <em class="jxr_javadoccomment">     * Hidden templates occur if there's only one selection or if the option is restricted to the profile.</em>
<a class="jxr_linenumber" name="L338" href="#L338">338</a> <em class="jxr_javadoccomment">     * @return true if there are hidden static template options or if hidden templates are already rendered</em>
<a class="jxr_linenumber" name="L339" href="#L339">339</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L340" href="#L340">340</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderNonModifiableTemplatesRendered() {
<a class="jxr_linenumber" name="L341" href="#L341">341</a>         <strong class="jxr_keyword">if</strong> (renderNonModifiableTemplates) {
<a class="jxr_linenumber" name="L342" href="#L342">342</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L343" href="#L343">343</a>         }
<a class="jxr_linenumber" name="L344" href="#L344">344</a>         <strong class="jxr_keyword">return</strong> !isSelectEndEntityProfileRendered() ||
<a class="jxr_linenumber" name="L345" href="#L345">345</a>                 (!isSelectCertificateProfileRendered() &amp;&amp; selectedEndEntityProfile != <strong class="jxr_keyword">null</strong>) ||
<a class="jxr_linenumber" name="L346" href="#L346">346</a>                 (!isSelectCertificateAuthorityRendered() &amp;&amp; selectedCertificateProfile != <strong class="jxr_keyword">null</strong>) ||
<a class="jxr_linenumber" name="L347" href="#L347">347</a>                 (!isSelectKeyPairGenerationRendered() &amp;&amp; selectedCertificateAuthority != <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L348" href="#L348">348</a>     }
<a class="jxr_linenumber" name="L349" href="#L349">349</a> 
<a class="jxr_linenumber" name="L350" href="#L350">350</a>     <em class="jxr_javadoccomment">/** @return true if the the selectKeyAlgorithm should be rendered */</em>
<a class="jxr_linenumber" name="L351" href="#L351">351</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSelectKeyAlgorithmRendered() {
<a class="jxr_linenumber" name="L352" href="#L352">352</a>         <strong class="jxr_keyword">return</strong> KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum()) &amp;&amp; (getAvailableAlgorithmSelectItems().size()&gt;1 ||
<a class="jxr_linenumber" name="L353" href="#L353">353</a>                 (getAvailableAlgorithmSelectItems().size()==1 &amp;&amp; isRenderNonModifiableTemplates()));
<a class="jxr_linenumber" name="L354" href="#L354">354</a>     }
<a class="jxr_linenumber" name="L355" href="#L355">355</a> 
<a class="jxr_linenumber" name="L356" href="#L356">356</a>     <em class="jxr_javadoccomment">/** @return true if the CSR upload form should be rendered */</em>
<a class="jxr_linenumber" name="L357" href="#L357">357</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isUploadCsrRendered() {
<a class="jxr_linenumber" name="L358" href="#L358">358</a>         <strong class="jxr_keyword">return</strong> getEndEntityProfile()!=<strong class="jxr_keyword">null</strong> &amp;&amp; getCertificateProfile()!=<strong class="jxr_keyword">null</strong> &amp;&amp; getCAInfo()!=<strong class="jxr_keyword">null</strong> &amp;&amp;
<a class="jxr_linenumber" name="L359" href="#L359">359</a>                 KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum());
<a class="jxr_linenumber" name="L360" href="#L360">360</a>     }
<a class="jxr_linenumber" name="L361" href="#L361">361</a> 
<a class="jxr_linenumber" name="L362" href="#L362">362</a>     <strong class="jxr_keyword">boolean</strong> uploadCsrDoneRendered = false;
<a class="jxr_linenumber" name="L363" href="#L363">363</a> 
<a class="jxr_linenumber" name="L364" href="#L364">364</a>     <em class="jxr_javadoccomment">/** @return true if the the CSR has been uploaded */</em>
<a class="jxr_linenumber" name="L365" href="#L365">365</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isUploadCsrDoneRendered() {
<a class="jxr_linenumber" name="L366" href="#L366">366</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">this</strong>.uploadCsrDoneRendered;
<a class="jxr_linenumber" name="L367" href="#L367">367</a>     }
<a class="jxr_linenumber" name="L368" href="#L368">368</a> 
<a class="jxr_linenumber" name="L369" href="#L369">369</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L370" href="#L370">370</a> <em class="jxr_javadoccomment">     * @return True if the option "Validity override" is enabled in the active certificate profile</em>
<a class="jxr_linenumber" name="L371" href="#L371">371</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L372" href="#L372">372</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isValidityOverrideEnabled() {
<a class="jxr_linenumber" name="L373" href="#L373">373</a>         <strong class="jxr_keyword">return</strong> getCertificateProfile().getAllowValidityOverride();
<a class="jxr_linenumber" name="L374" href="#L374">374</a>     }
<a class="jxr_linenumber" name="L375" href="#L375">375</a> 
<a class="jxr_linenumber" name="L376" href="#L376">376</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L377" href="#L377">377</a> <em class="jxr_javadoccomment">     * Determines if the custom validity date entered by the user is valid.</em>
<a class="jxr_linenumber" name="L378" href="#L378">378</a> <em class="jxr_javadoccomment">     * This method checks whether the following two conditions hold:</em>
<a class="jxr_linenumber" name="L379" href="#L379">379</a> <em class="jxr_javadoccomment">     * &lt;ul&gt;</em>
<a class="jxr_linenumber" name="L380" href="#L380">380</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity can be parsed and interpreted as a date.&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L381" href="#L381">381</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity does not exceed the validity of the certificate profile.&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L382" href="#L382">382</a> <em class="jxr_javadoccomment">     * &lt;/ul&gt;</em>
<a class="jxr_linenumber" name="L383" href="#L383">383</a> <em class="jxr_javadoccomment">     * @return True if the validity set by the user is valid</em>
<a class="jxr_linenumber" name="L384" href="#L384">384</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L385" href="#L385">385</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isValidityValid() {
<a class="jxr_linenumber" name="L386" href="#L386">386</a>         <strong class="jxr_keyword">if</strong> (!isSetCustomValidity()) {
<a class="jxr_linenumber" name="L387" href="#L387">387</a>             <em class="jxr_comment">// The validity of the certificate profile is used instead, and is always valid</em>
<a class="jxr_linenumber" name="L388" href="#L388">388</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L389" href="#L389">389</a>         }
<a class="jxr_linenumber" name="L390" href="#L390">390</a>         <strong class="jxr_keyword">return</strong> getUserDefinedValidityIfSpecified() != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L391" href="#L391">391</a>     }
<a class="jxr_linenumber" name="L392" href="#L392">392</a> 
<a class="jxr_linenumber" name="L393" href="#L393">393</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L394" href="#L394">394</a> <em class="jxr_javadoccomment">     * Returns the validity string specified by the user or null if one of the</em>
<a class="jxr_linenumber" name="L395" href="#L395">395</a> <em class="jxr_javadoccomment">     * following conditions hold:</em>
<a class="jxr_linenumber" name="L396" href="#L396">396</a> <em class="jxr_javadoccomment">     * &lt;ul&gt;</em>
<a class="jxr_linenumber" name="L397" href="#L397">397</a> <em class="jxr_javadoccomment">     * &lt;li&gt;Validity override is disabled in the certificate profile&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L398" href="#L398">398</a> <em class="jxr_javadoccomment">     * &lt;li&gt;User defined validity is disabled in the UI&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L399" href="#L399">399</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity cannot be parsed (invalid format)&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L400" href="#L400">400</a> <em class="jxr_javadoccomment">     * &lt;li&gt;The validity exceeds the maximum validity as specified by the certificate profile&lt;/li&gt;</em>
<a class="jxr_linenumber" name="L401" href="#L401">401</a> <em class="jxr_javadoccomment">     * &lt;/ul&gt;</em>
<a class="jxr_linenumber" name="L402" href="#L402">402</a> <em class="jxr_javadoccomment">     * @return The validity as a string or null</em>
<a class="jxr_linenumber" name="L403" href="#L403">403</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L404" href="#L404">404</a>     <strong class="jxr_keyword">private</strong> String getUserDefinedValidityIfSpecified() {
<a class="jxr_linenumber" name="L405" href="#L405">405</a>         <strong class="jxr_keyword">if</strong> (!isValidityOverrideEnabled()) {
<a class="jxr_linenumber" name="L406" href="#L406">406</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L407" href="#L407">407</a>         }
<a class="jxr_linenumber" name="L408" href="#L408">408</a>         <strong class="jxr_keyword">if</strong> (!isSetCustomValidity()) {
<a class="jxr_linenumber" name="L409" href="#L409">409</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L410" href="#L410">410</a>         }
<a class="jxr_linenumber" name="L411" href="#L411">411</a>         <strong class="jxr_keyword">final</strong> Date anchorDate = <strong class="jxr_keyword">new</strong> Date();
<a class="jxr_linenumber" name="L412" href="#L412">412</a>         <strong class="jxr_keyword">final</strong> String validityToCheck = validity;
<a class="jxr_linenumber" name="L413" href="#L413">413</a>         <strong class="jxr_keyword">final</strong> Date userDate = ValidityDate.getDate(validityToCheck, anchorDate);
<a class="jxr_linenumber" name="L414" href="#L414">414</a>         <strong class="jxr_keyword">if</strong> (userDate == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L415" href="#L415">415</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L416" href="#L416">416</a>         }
<a class="jxr_linenumber" name="L417" href="#L417">417</a>         <strong class="jxr_keyword">final</strong> Date maxDate = ValidityDate.getDate(getCertificateProfile().getEncodedValidity(), anchorDate);
<a class="jxr_linenumber" name="L418" href="#L418">418</a>         <strong class="jxr_keyword">if</strong> (userDate.after(maxDate)) {
<a class="jxr_linenumber" name="L419" href="#L419">419</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L420" href="#L420">420</a>         }
<a class="jxr_linenumber" name="L421" href="#L421">421</a>         <strong class="jxr_keyword">return</strong> validityToCheck;
<a class="jxr_linenumber" name="L422" href="#L422">422</a>     }
<a class="jxr_linenumber" name="L423" href="#L423">423</a> 
<a class="jxr_linenumber" name="L424" href="#L424">424</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L425" href="#L425">425</a> <em class="jxr_javadoccomment">     * Checks if each group of fields contains non-modifiable (disabled) values. If a specific fields is empty, the check is skipped</em>
<a class="jxr_linenumber" name="L426" href="#L426">426</a> <em class="jxr_javadoccomment">     * and false is returned to not confuse hidden fields with empty fields.</em>
<a class="jxr_linenumber" name="L427" href="#L427">427</a> <em class="jxr_javadoccomment">     * Hidden fields occur if there's only one selection or if the option is restricted to the profile.</em>
<a class="jxr_linenumber" name="L428" href="#L428">428</a> <em class="jxr_javadoccomment">     * @return true if not all fields (e.g. non-modifiable) are rendered by default or if hidden fields are already rendered.</em>
<a class="jxr_linenumber" name="L429" href="#L429">429</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L430" href="#L430">430</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderNonModifiableFieldsRendered() {
<a class="jxr_linenumber" name="L431" href="#L431">431</a>         <strong class="jxr_keyword">if</strong> (renderNonModifiableFields) {
<a class="jxr_linenumber" name="L432" href="#L432">432</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L433" href="#L433">433</a>         }
<a class="jxr_linenumber" name="L434" href="#L434">434</a>         <strong class="jxr_keyword">if</strong> (getSubjectDn() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L435" href="#L435">435</a>             <strong class="jxr_keyword">if</strong> (!isAllFieldInstancesRendered(getSubjectDn().getFieldInstances())) {
<a class="jxr_linenumber" name="L436" href="#L436">436</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L437" href="#L437">437</a>             }
<a class="jxr_linenumber" name="L438" href="#L438">438</a>         }
<a class="jxr_linenumber" name="L439" href="#L439">439</a>         <strong class="jxr_keyword">if</strong> (getSubjectAlternativeName() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L440" href="#L440">440</a>             <strong class="jxr_keyword">if</strong> (!isAllFieldInstancesRendered(getSubjectAlternativeName().getFieldInstances())) {
<a class="jxr_linenumber" name="L441" href="#L441">441</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L442" href="#L442">442</a>             }
<a class="jxr_linenumber" name="L443" href="#L443">443</a>         }
<a class="jxr_linenumber" name="L444" href="#L444">444</a>         <strong class="jxr_keyword">if</strong> (getSubjectDirectoryAttributes() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L445" href="#L445">445</a>             <strong class="jxr_keyword">if</strong> (!isAllFieldInstancesRendered(getSubjectDirectoryAttributes().getFieldInstances())) {
<a class="jxr_linenumber" name="L446" href="#L446">446</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L447" href="#L447">447</a>             }
<a class="jxr_linenumber" name="L448" href="#L448">448</a>         }
<a class="jxr_linenumber" name="L449" href="#L449">449</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L450" href="#L450">450</a>     }
<a class="jxr_linenumber" name="L451" href="#L451">451</a> 
<a class="jxr_linenumber" name="L452" href="#L452">452</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isAllFieldInstancesRendered(<strong class="jxr_keyword">final</strong> Collection&lt;FieldInstance&gt; fieldInstances) {
<a class="jxr_linenumber" name="L453" href="#L453">453</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> FieldInstance instance : fieldInstances) {
<a class="jxr_linenumber" name="L454" href="#L454">454</a>             <strong class="jxr_keyword">if</strong> (!isFieldInstanceRendered(instance)) {
<a class="jxr_linenumber" name="L455" href="#L455">455</a>                 <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L456" href="#L456">456</a>             }
<a class="jxr_linenumber" name="L457" href="#L457">457</a>         }
<a class="jxr_linenumber" name="L458" href="#L458">458</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L459" href="#L459">459</a>     }
<a class="jxr_linenumber" name="L460" href="#L460">460</a> 
<a class="jxr_linenumber" name="L461" href="#L461">461</a>     <em class="jxr_javadoccomment">/** @return the provideRequestMetadataRendered */</em>
<a class="jxr_linenumber" name="L462" href="#L462">462</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isProvideUserCredentialsRendered() {
<a class="jxr_linenumber" name="L463" href="#L463">463</a>         <strong class="jxr_keyword">return</strong> isKeyAlgorithmAvailable() &amp;&amp; (isUsernameRendered() || isPasswordRendered() || isEmailRendered());
<a class="jxr_linenumber" name="L464" href="#L464">464</a>     }
<a class="jxr_linenumber" name="L465" href="#L465">465</a> 
<a class="jxr_linenumber" name="L466" href="#L466">466</a>     <em class="jxr_javadoccomment">/** @return the confirmRequestRendered */</em>
<a class="jxr_linenumber" name="L467" href="#L467">467</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isConfirmRequestRendered() {
<a class="jxr_linenumber" name="L468" href="#L468">468</a>         <strong class="jxr_keyword">return</strong> isKeyAlgorithmAvailable();
<a class="jxr_linenumber" name="L469" href="#L469">469</a>     }
<a class="jxr_linenumber" name="L470" href="#L470">470</a> 
<a class="jxr_linenumber" name="L471" href="#L471">471</a>     <em class="jxr_javadoccomment">/** @return the provideRequestInfoRendered */</em>
<a class="jxr_linenumber" name="L472" href="#L472">472</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isProvideRequestInfoRendered() {
<a class="jxr_linenumber" name="L473" href="#L473">473</a>         <strong class="jxr_keyword">return</strong> isKeyAlgorithmAvailable();
<a class="jxr_linenumber" name="L474" href="#L474">474</a>     }
<a class="jxr_linenumber" name="L475" href="#L475">475</a> 
<a class="jxr_linenumber" name="L476" href="#L476">476</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isKeyAlgorithmAvailable() {
<a class="jxr_linenumber" name="L477" href="#L477">477</a>         <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum()) &amp;&amp; StringUtils.isNotEmpty(getSelectedAlgorithm())) {
<a class="jxr_linenumber" name="L478" href="#L478">478</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L479" href="#L479">479</a>         }
<a class="jxr_linenumber" name="L480" href="#L480">480</a>         <strong class="jxr_keyword">if</strong> (KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum()) &amp;&amp; algorithmFromCsr!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L481" href="#L481">481</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L482" href="#L482">482</a>         }
<a class="jxr_linenumber" name="L483" href="#L483">483</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L484" href="#L484">484</a>     }
<a class="jxr_linenumber" name="L485" href="#L485">485</a> 
<a class="jxr_linenumber" name="L486" href="#L486">486</a>     <em class="jxr_comment">//-----------------------------------------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L487" href="#L487">487</a>     <em class="jxr_comment">//All reset* methods should be able to clear/reset states that have changed during init* methods.</em>
<a class="jxr_linenumber" name="L488" href="#L488">488</a>     <em class="jxr_comment">//Always make sure that reset methods are properly chained</em>
<a class="jxr_linenumber" name="L489" href="#L489">489</a> 
<a class="jxr_linenumber" name="L490" href="#L490">490</a>     <em class="jxr_comment">//Invoked by commandButton id="resetButton"</em>
<a class="jxr_linenumber" name="L491" href="#L491">491</a>     <strong class="jxr_keyword">public</strong> String reset() {
<a class="jxr_linenumber" name="L492" href="#L492">492</a>         <em class="jxr_comment">//Invalidate view tree by redirecting to the same page</em>
<a class="jxr_linenumber" name="L493" href="#L493">493</a>         String viewId = FacesContext.getCurrentInstance().getViewRoot().getViewId();
<a class="jxr_linenumber" name="L494" href="#L494">494</a>         <strong class="jxr_keyword">return</strong> viewId+<span class="jxr_string">"?faces-redirect=true"</span>;
<a class="jxr_linenumber" name="L495" href="#L495">495</a>     }
<a class="jxr_linenumber" name="L496" href="#L496">496</a> 
<a class="jxr_linenumber" name="L497" href="#L497">497</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> resetAlgorithmCsrUpload() {
<a class="jxr_linenumber" name="L498" href="#L498">498</a>         algorithmFromCsr = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L499" href="#L499">499</a>         certificateRequest = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L500" href="#L500">500</a>     }
<a class="jxr_linenumber" name="L501" href="#L501">501</a> 
<a class="jxr_linenumber" name="L502" href="#L502">502</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> resetRequestInfo() {
<a class="jxr_linenumber" name="L503" href="#L503">503</a>         subjectDn = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L504" href="#L504">504</a>         subjectAlternativeName = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L505" href="#L505">505</a>         subjectDirectoryAttributes = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L506" href="#L506">506</a>         algorithmFromCsr = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L507" href="#L507">507</a>         endEntityInformation = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L508" href="#L508">508</a>         setRequestId(0);
<a class="jxr_linenumber" name="L509" href="#L509">509</a>     }
<a class="jxr_linenumber" name="L510" href="#L510">510</a> 
<a class="jxr_linenumber" name="L511" href="#L511">511</a>     <em class="jxr_comment">//-----------------------------------------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L512" href="#L512">512</a>     <em class="jxr_comment">//Action methods</em>
<a class="jxr_linenumber" name="L513" href="#L513">513</a> 
<a class="jxr_linenumber" name="L514" href="#L514">514</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> applyRequestTemplate(){
<a class="jxr_linenumber" name="L515" href="#L515">515</a>         <em class="jxr_comment">// NOOP here. Validators and setters do the real work.</em>
<a class="jxr_linenumber" name="L516" href="#L516">516</a>     }
<a class="jxr_linenumber" name="L517" href="#L517">517</a> 
<a class="jxr_linenumber" name="L518" href="#L518">518</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> applyAlgorithm(){
<a class="jxr_linenumber" name="L519" href="#L519">519</a>         <em class="jxr_comment">// NOOP here. Validators and setters do the real work.</em>
<a class="jxr_linenumber" name="L520" href="#L520">520</a>     }
<a class="jxr_linenumber" name="L521" href="#L521">521</a> 
<a class="jxr_linenumber" name="L522" href="#L522">522</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> renderCsrDetailedInfo = false;
<a class="jxr_linenumber" name="L523" href="#L523">523</a> 
<a class="jxr_linenumber" name="L524" href="#L524">524</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderCsrDetailedInfo() {
<a class="jxr_linenumber" name="L525" href="#L525">525</a>         <strong class="jxr_keyword">return</strong> renderCsrDetailedInfo;
<a class="jxr_linenumber" name="L526" href="#L526">526</a>     }
<a class="jxr_linenumber" name="L527" href="#L527">527</a> 
<a class="jxr_linenumber" name="L528" href="#L528">528</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRenderCsrDetailedInfo(<strong class="jxr_keyword">boolean</strong> renderCsrDetailedInfo) {
<a class="jxr_linenumber" name="L529" href="#L529">529</a>         <strong class="jxr_keyword">this</strong>.renderCsrDetailedInfo = renderCsrDetailedInfo;
<a class="jxr_linenumber" name="L530" href="#L530">530</a>     }
<a class="jxr_linenumber" name="L531" href="#L531">531</a> 
<a class="jxr_linenumber" name="L532" href="#L532">532</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> renderCsrDetailedInfoToggle() {
<a class="jxr_linenumber" name="L533" href="#L533">533</a>         renderCsrDetailedInfo = !renderCsrDetailedInfo;
<a class="jxr_linenumber" name="L534" href="#L534">534</a>     }
<a class="jxr_linenumber" name="L535" href="#L535">535</a> 
<a class="jxr_linenumber" name="L536" href="#L536">536</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> renderNonModifiableTemplatesToggle() {
<a class="jxr_linenumber" name="L537" href="#L537">537</a>         renderNonModifiableTemplates = !renderNonModifiableTemplates;
<a class="jxr_linenumber" name="L538" href="#L538">538</a>     }
<a class="jxr_linenumber" name="L539" href="#L539">539</a> 
<a class="jxr_linenumber" name="L540" href="#L540">540</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> renderNonModifiableFieldsToggle() {
<a class="jxr_linenumber" name="L541" href="#L541">541</a>         renderNonModifiableFields = !renderNonModifiableFields;
<a class="jxr_linenumber" name="L542" href="#L542">542</a>     }
<a class="jxr_linenumber" name="L543" href="#L543">543</a> 
<a class="jxr_linenumber" name="L544" href="#L544">544</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> renderRequestPreviewMoreToggle(){
<a class="jxr_linenumber" name="L545" href="#L545">545</a>         requestPreviewMoreDetails = !requestPreviewMoreDetails;
<a class="jxr_linenumber" name="L546" href="#L546">546</a>     }
<a class="jxr_linenumber" name="L547" href="#L547">547</a> 
<a class="jxr_linenumber" name="L548" href="#L548">548</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> renderSetCustomValidityToggle() {
<a class="jxr_linenumber" name="L549" href="#L549">549</a>         setCustomValidity = !setCustomValidity;
<a class="jxr_linenumber" name="L550" href="#L550">550</a>     }
<a class="jxr_linenumber" name="L551" href="#L551">551</a> 
<a class="jxr_linenumber" name="L552" href="#L552">552</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> uploadCsrChange() {
<a class="jxr_linenumber" name="L553" href="#L553">553</a>         algorithmFromCsr = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L554" href="#L554">554</a>         uploadCsrDoneRendered = false;
<a class="jxr_linenumber" name="L555" href="#L555">555</a>     }
<a class="jxr_linenumber" name="L556" href="#L556">556</a> 
<a class="jxr_linenumber" name="L557" href="#L557">557</a>     <em class="jxr_javadoccomment">/** Populate the state of modifiable fields with the CSR that was saved during file upload validation */</em>
<a class="jxr_linenumber" name="L558" href="#L558">558</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> uploadCsr() {
<a class="jxr_linenumber" name="L559" href="#L559">559</a>         validateCsr(certificateRequest);
<a class="jxr_linenumber" name="L560" href="#L560">560</a>         <em class="jxr_comment">//If PROVIDED BY USER key generation is selected, try fill Subject DN fields from CSR (Overwrite the fields set by previous CSR upload if any)</em>
<a class="jxr_linenumber" name="L561" href="#L561">561</a>         <strong class="jxr_keyword">if</strong> (getSelectedKeyPairGenerationEnum() != <strong class="jxr_keyword">null</strong> &amp;&amp; KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum()) &amp;&amp; algorithmFromCsr!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L562" href="#L562">562</a>             <strong class="jxr_keyword">final</strong> PKCS10CertificationRequest pkcs10CertificateRequest = CertTools.getCertificateRequestFromPem(getCertificateRequest());
<a class="jxr_linenumber" name="L563" href="#L563">563</a>             <strong class="jxr_keyword">if</strong> (pkcs10CertificateRequest.getSubject()!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L564" href="#L564">564</a>                 populateRequestFields(false, pkcs10CertificateRequest.getSubject().toString(), getSubjectDn().getFieldInstances());
<a class="jxr_linenumber" name="L565" href="#L565">565</a>                 getSubjectDn().update();
<a class="jxr_linenumber" name="L566" href="#L566">566</a>             }
<a class="jxr_linenumber" name="L567" href="#L567">567</a>             <strong class="jxr_keyword">final</strong> Extension sanExtension = CertTools.getExtension(pkcs10CertificateRequest, Extension.subjectAlternativeName.getId());
<a class="jxr_linenumber" name="L568" href="#L568">568</a>             <strong class="jxr_keyword">if</strong> (sanExtension!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L569" href="#L569">569</a>                 populateRequestFields(<strong class="jxr_keyword">true</strong>, CertTools.getAltNameStringFromExtension(sanExtension), getSubjectAlternativeName().getFieldInstances());
<a class="jxr_linenumber" name="L570" href="#L570">570</a>                 getSubjectAlternativeName().update();
<a class="jxr_linenumber" name="L571" href="#L571">571</a>             }
<a class="jxr_linenumber" name="L572" href="#L572">572</a>             <em class="jxr_comment">// Don't make the effort to populate Subject Directory Attribute fields. Too little real world use for that.</em>
<a class="jxr_linenumber" name="L573" href="#L573">573</a> 
<a class="jxr_linenumber" name="L574" href="#L574">574</a>             uploadCsrDoneRendered = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L575" href="#L575">575</a>         }
<a class="jxr_linenumber" name="L576" href="#L576">576</a>     }
<a class="jxr_linenumber" name="L577" href="#L577">577</a> 
<a class="jxr_linenumber" name="L578" href="#L578">578</a>     <em class="jxr_javadoccomment">/** Populate the fieldInstances parameter with values from the CSR when the instances are modifiable </em>
<a class="jxr_linenumber" name="L579" href="#L579">579</a> <em class="jxr_javadoccomment">     * @param isSubjectAlternativeName bool</em>
<a class="jxr_linenumber" name="L580" href="#L580">580</a> <em class="jxr_javadoccomment">     * @param subject Subject</em>
<a class="jxr_linenumber" name="L581" href="#L581">581</a> <em class="jxr_javadoccomment">     * @param fieldInstances Instances */</em>
<a class="jxr_linenumber" name="L582" href="#L582">582</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> populateRequestFields(<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> isSubjectAlternativeName, <strong class="jxr_keyword">final</strong> String subject, <strong class="jxr_keyword">final</strong> Collection&lt;FieldInstance&gt; fieldInstances) {
<a class="jxr_linenumber" name="L583" href="#L583">583</a>         <strong class="jxr_keyword">final</strong> List&lt;String&gt; subjectFieldsFromParsedCsr = CertTools.getX500NameComponents(subject);
<a class="jxr_linenumber" name="L584" href="#L584">584</a>         bothLoops: <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String subjectField : subjectFieldsFromParsedCsr) {
<a class="jxr_linenumber" name="L585" href="#L585">585</a>             <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()){
<a class="jxr_linenumber" name="L586" href="#L586">586</a>                 log.debug(<span class="jxr_string">"Parsing the subject "</span> + (isSubjectAlternativeName?<span class="jxr_string">"AN"</span>:<span class="jxr_string">"DN"</span>) + <span class="jxr_string">" field '"</span> + subjectField + <span class="jxr_string">"'..."</span>);
<a class="jxr_linenumber" name="L587" href="#L587">587</a>             }
<a class="jxr_linenumber" name="L588" href="#L588">588</a>             <strong class="jxr_keyword">final</strong> String[] nameValue = subjectField.split(<span class="jxr_string">"="</span>);
<a class="jxr_linenumber" name="L589" href="#L589">589</a>             <strong class="jxr_keyword">if</strong> (nameValue != <strong class="jxr_keyword">null</strong> &amp;&amp; nameValue.length == 2) {
<a class="jxr_linenumber" name="L590" href="#L590">590</a>                 <strong class="jxr_keyword">final</strong> Integer dnId = isSubjectAlternativeName ? DnComponents.getDnIdFromAltName(nameValue[0]) : DnComponents.getDnIdFromDnName(nameValue[0]);
<a class="jxr_linenumber" name="L591" href="#L591">591</a>                 <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L592" href="#L592">592</a>                     log.debug(<span class="jxr_string">" dnId="</span>+dnId);
<a class="jxr_linenumber" name="L593" href="#L593">593</a>                 }
<a class="jxr_linenumber" name="L594" href="#L594">594</a>                 <strong class="jxr_keyword">if</strong> (dnId != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L595" href="#L595">595</a>                     <em class="jxr_comment">//In the case of multiple fields (etc. two CNs), find the first modifiable with a non-default value</em>
<a class="jxr_linenumber" name="L596" href="#L596">596</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> FieldInstance fieldInstance : fieldInstances) {
<a class="jxr_linenumber" name="L597" href="#L597">597</a>                         <strong class="jxr_keyword">if</strong> (DnComponents.profileIdToDnId(fieldInstance.getProfileId()) == dnId.intValue()) {
<a class="jxr_linenumber" name="L598" href="#L598">598</a>                             <strong class="jxr_keyword">if</strong> (fieldInstance.isModifiable()) {
<a class="jxr_linenumber" name="L599" href="#L599">599</a>                                 <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L600" href="#L600">600</a>                                     log.debug(<span class="jxr_string">" fieldInstance.value="</span>+fieldInstance.getValue() + <span class="jxr_string">" fieldInstance.defaultValue="</span>+fieldInstance.getDefaultValue());
<a class="jxr_linenumber" name="L601" href="#L601">601</a>                                 }
<a class="jxr_linenumber" name="L602" href="#L602">602</a>                                 <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(fieldInstance.getValue()) || fieldInstance.getValue().equals(fieldInstance.getDefaultValue())) {
<a class="jxr_linenumber" name="L603" href="#L603">603</a>                                     fieldInstance.setValue(nameValue[1]);
<a class="jxr_linenumber" name="L604" href="#L604">604</a>                                     <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L605" href="#L605">605</a>                                         log.debug(<span class="jxr_string">"Modifiable subject field '"</span>+subjectField+<span class="jxr_string">"' successfully parsed from CSR"</span>);
<a class="jxr_linenumber" name="L606" href="#L606">606</a>                                     }
<a class="jxr_linenumber" name="L607" href="#L607">607</a>                                     <strong class="jxr_keyword">continue</strong> bothLoops;
<a class="jxr_linenumber" name="L608" href="#L608">608</a>                                 }
<a class="jxr_linenumber" name="L609" href="#L609">609</a>                             } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (fieldInstance.isSelectable()) {
<a class="jxr_linenumber" name="L610" href="#L610">610</a>                                 <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L611" href="#L611">611</a>                                     log.debug(<span class="jxr_string">" fieldInstance.value="</span>+fieldInstance.getValue() + <span class="jxr_string">" fieldInstance.defaultValue="</span>+fieldInstance.getDefaultValue());
<a class="jxr_linenumber" name="L612" href="#L612">612</a>                                 }
<a class="jxr_linenumber" name="L613" href="#L613">613</a>                                 <strong class="jxr_keyword">if</strong> (fieldInstance.getSelectableValues().contains(nameValue[1])) {
<a class="jxr_linenumber" name="L614" href="#L614">614</a>                                     fieldInstance.setValue(nameValue[1]);
<a class="jxr_linenumber" name="L615" href="#L615">615</a>                                     <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L616" href="#L616">616</a>                                         log.debug(<span class="jxr_string">"Selectable subject field '"</span>+subjectField+<span class="jxr_string">"' successfully parsed from CSR"</span>);
<a class="jxr_linenumber" name="L617" href="#L617">617</a>                                     }
<a class="jxr_linenumber" name="L618" href="#L618">618</a>                                     <strong class="jxr_keyword">continue</strong> bothLoops;
<a class="jxr_linenumber" name="L619" href="#L619">619</a>                                 }
<a class="jxr_linenumber" name="L620" href="#L620">620</a>                             }
<a class="jxr_linenumber" name="L621" href="#L621">621</a>                         }
<a class="jxr_linenumber" name="L622" href="#L622">622</a>                     }
<a class="jxr_linenumber" name="L623" href="#L623">623</a>                 }
<a class="jxr_linenumber" name="L624" href="#L624">624</a>             }
<a class="jxr_linenumber" name="L625" href="#L625">625</a>             <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L626" href="#L626">626</a>                 log.debug(<span class="jxr_string">"Unparsable subject "</span> + (isSubjectAlternativeName?<span class="jxr_string">"AN"</span>:<span class="jxr_string">"DN"</span>) + <span class="jxr_string">" field '"</span>+ subjectField +
<a class="jxr_linenumber" name="L627" href="#L627">627</a>                         <span class="jxr_string">"' from CSR, field is invalid or not a modifiable option in the end entity profile."</span>);
<a class="jxr_linenumber" name="L628" href="#L628">628</a>             }
<a class="jxr_linenumber" name="L629" href="#L629">629</a>         }
<a class="jxr_linenumber" name="L630" href="#L630">630</a>     }
<a class="jxr_linenumber" name="L631" href="#L631">631</a> 
<a class="jxr_linenumber" name="L632" href="#L632">632</a>     <em class="jxr_javadoccomment">/** Proceed with request that will require approval */</em>
<a class="jxr_linenumber" name="L633" href="#L633">633</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> confirmRequest() {
<a class="jxr_linenumber" name="L634" href="#L634">634</a>         String username = getEndEntityInformation().getUsername();
<a class="jxr_linenumber" name="L635" href="#L635">635</a>         <strong class="jxr_keyword">if</strong> (raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), username) == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L636" href="#L636">636</a>             <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L637" href="#L637">637</a>                 addEndEntityAndGenerateP12();
<a class="jxr_linenumber" name="L638" href="#L638">638</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L639" href="#L639">639</a>                 addEndEntityAndGenerateCertificateDer();
<a class="jxr_linenumber" name="L640" href="#L640">640</a>             }
<a class="jxr_linenumber" name="L641" href="#L641">641</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L642" href="#L642">642</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_username_already_exists"</span>, username);
<a class="jxr_linenumber" name="L643" href="#L643">643</a>         }
<a class="jxr_linenumber" name="L644" href="#L644">644</a>     }
<a class="jxr_linenumber" name="L645" href="#L645">645</a> 
<a class="jxr_linenumber" name="L646" href="#L646">646</a>     <em class="jxr_javadoccomment">/** Calculate the summary of holders from the current state for the certificate Subjects */</em>
<a class="jxr_linenumber" name="L647" href="#L647">647</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> updateRequestPreview() {
<a class="jxr_linenumber" name="L648" href="#L648">648</a>         getSubjectDn().update();
<a class="jxr_linenumber" name="L649" href="#L649">649</a>         getSubjectAlternativeName().update();
<a class="jxr_linenumber" name="L650" href="#L650">650</a>         getSubjectDirectoryAttributes().update();
<a class="jxr_linenumber" name="L651" href="#L651">651</a>     }
<a class="jxr_linenumber" name="L652" href="#L652">652</a> 
<a class="jxr_linenumber" name="L653" href="#L653">653</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateCertificateDer() {
<a class="jxr_linenumber" name="L654" href="#L654">654</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_USERGEN, <span class="jxr_string">"DER"</span>, TokenDownloadType.DER);
<a class="jxr_linenumber" name="L655" href="#L655">655</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".der"</span>);
<a class="jxr_linenumber" name="L656" href="#L656">656</a>     }
<a class="jxr_linenumber" name="L657" href="#L657">657</a> 
<a class="jxr_linenumber" name="L658" href="#L658">658</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateCertificatePkcs7() {
<a class="jxr_linenumber" name="L659" href="#L659">659</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_USERGEN, <span class="jxr_string">"PKCS#7"</span>, TokenDownloadType.PKCS7);
<a class="jxr_linenumber" name="L660" href="#L660">660</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".p7b"</span>);
<a class="jxr_linenumber" name="L661" href="#L661">661</a>     }
<a class="jxr_linenumber" name="L662" href="#L662">662</a> 
<a class="jxr_linenumber" name="L663" href="#L663">663</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateCertificatePemFullChain() {
<a class="jxr_linenumber" name="L664" href="#L664">664</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_USERGEN, <span class="jxr_string">"PEM"</span>, TokenDownloadType.PEM_FULL_CHAIN);
<a class="jxr_linenumber" name="L665" href="#L665">665</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L666" href="#L666">666</a>     }
<a class="jxr_linenumber" name="L667" href="#L667">667</a> 
<a class="jxr_linenumber" name="L668" href="#L668">668</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateCertificatePem() {
<a class="jxr_linenumber" name="L669" href="#L669">669</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_USERGEN, <span class="jxr_string">"PEM"</span>, TokenDownloadType.PEM);
<a class="jxr_linenumber" name="L670" href="#L670">670</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L671" href="#L671">671</a>     }
<a class="jxr_linenumber" name="L672" href="#L672">672</a> 
<a class="jxr_linenumber" name="L673" href="#L673">673</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateP12() {
<a class="jxr_linenumber" name="L674" href="#L674">674</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_SOFT_P12, <span class="jxr_string">"PKCS#12"</span>, <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L675" href="#L675">675</a>         downloadToken(token, <span class="jxr_string">"application/x-pkcs12"</span>, <span class="jxr_string">".p12"</span>);
<a class="jxr_linenumber" name="L676" href="#L676">676</a>     }
<a class="jxr_linenumber" name="L677" href="#L677">677</a> 
<a class="jxr_linenumber" name="L678" href="#L678">678</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGenerateJks() {
<a class="jxr_linenumber" name="L679" href="#L679">679</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_SOFT_JKS, <span class="jxr_string">"JKS"</span>, <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L680" href="#L680">680</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".jks"</span>);
<a class="jxr_linenumber" name="L681" href="#L681">681</a>     }
<a class="jxr_linenumber" name="L682" href="#L682">682</a> 
<a class="jxr_linenumber" name="L683" href="#L683">683</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> addEndEntityAndGeneratePem() {
<a class="jxr_linenumber" name="L684" href="#L684">684</a>         byte[] token = addEndEntityAndGenerateToken(EndEntityConstants.TOKEN_SOFT_PEM, <span class="jxr_string">"PEM"</span>, <strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L685" href="#L685">685</a>         downloadToken(token, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L686" href="#L686">686</a>     }
<a class="jxr_linenumber" name="L687" href="#L687">687</a> 
<a class="jxr_linenumber" name="L688" href="#L688">688</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L689" href="#L689">689</a> <em class="jxr_javadoccomment">     * Adds end entity and creates its token that will be downloaded. This method is responsible for deleting the end entity if something goes wrong with token creation.</em>
<a class="jxr_linenumber" name="L690" href="#L690">690</a> <em class="jxr_javadoccomment">     * @param tokenType the type of the token that will be created (one of: TOKEN_USERGEN, TOKEN_SOFT_P12, TOKEN_SOFT_JKS from EndEntityConstants)</em>
<a class="jxr_linenumber" name="L691" href="#L691">691</a> <em class="jxr_javadoccomment">     * @param tokenName the name of the token. It will be used only in messages and logs</em>
<a class="jxr_linenumber" name="L692" href="#L692">692</a> <em class="jxr_javadoccomment">     * @param tokenDownloadType the download type/format of the token. This is used only with TOKEN_USERGEN since this is the only one that have different formats: PEM, DER,...)</em>
<a class="jxr_linenumber" name="L693" href="#L693">693</a> <em class="jxr_javadoccomment">     * @return generated token as byte array or null if token could not be generated</em>
<a class="jxr_linenumber" name="L694" href="#L694">694</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L695" href="#L695">695</a>     <strong class="jxr_keyword">private</strong> byte[] addEndEntityAndGenerateToken(<strong class="jxr_keyword">int</strong> tokenType, String tokenName, TokenDownloadType tokenDownloadType) {
<a class="jxr_linenumber" name="L696" href="#L696">696</a>         <em class="jxr_comment">//Update the EndEntityInformation data</em>
<a class="jxr_linenumber" name="L697" href="#L697">697</a>         getSubjectDn().update();
<a class="jxr_linenumber" name="L698" href="#L698">698</a>         getSubjectAlternativeName().update();
<a class="jxr_linenumber" name="L699" href="#L699">699</a>         getSubjectDirectoryAttributes().update();
<a class="jxr_linenumber" name="L700" href="#L700">700</a> 
<a class="jxr_linenumber" name="L701" href="#L701">701</a>         <em class="jxr_comment">//Fill End Entity information</em>
<a class="jxr_linenumber" name="L702" href="#L702">702</a>         <strong class="jxr_keyword">final</strong> EndEntityInformation endEntityInformation = getEndEntityInformation();
<a class="jxr_linenumber" name="L703" href="#L703">703</a>         <strong class="jxr_keyword">final</strong> ExtendedInformation extendedInformation = <strong class="jxr_keyword">new</strong> ExtendedInformation();
<a class="jxr_linenumber" name="L704" href="#L704">704</a>         extendedInformation.setCertificateEndTime(getUserDefinedValidityIfSpecified());
<a class="jxr_linenumber" name="L705" href="#L705">705</a>         endEntityInformation.setCAId(getCAInfo().getCAId());
<a class="jxr_linenumber" name="L706" href="#L706">706</a>         endEntityInformation.setCardNumber(<span class="jxr_string">""</span>); <em class="jxr_comment">//TODO Card Number</em>
<a class="jxr_linenumber" name="L707" href="#L707">707</a>         endEntityInformation.setCertificateProfileId(authorizedCertificateProfiles.get(Integer.parseInt(getSelectedCertificateProfile())).getId());
<a class="jxr_linenumber" name="L708" href="#L708">708</a>         endEntityInformation.setDN(getSubjectDn().toString());
<a class="jxr_linenumber" name="L709" href="#L709">709</a>         endEntityInformation.setEndEntityProfileId(authorizedEndEntityProfiles.get(Integer.parseInt(getSelectedEndEntityProfile())).getId());
<a class="jxr_linenumber" name="L710" href="#L710">710</a>         endEntityInformation.setExtendedInformation(extendedInformation);
<a class="jxr_linenumber" name="L711" href="#L711">711</a>         endEntityInformation.setHardTokenIssuerId(0); <em class="jxr_comment">//TODO not sure....</em>
<a class="jxr_linenumber" name="L712" href="#L712">712</a>         endEntityInformation.setStatus(EndEntityConstants.STATUS_NEW);
<a class="jxr_linenumber" name="L713" href="#L713">713</a>         endEntityInformation.setSubjectAltName(getSubjectAlternativeName().toString());
<a class="jxr_linenumber" name="L714" href="#L714">714</a>         endEntityInformation.setTimeCreated(<strong class="jxr_keyword">new</strong> Date());
<a class="jxr_linenumber" name="L715" href="#L715">715</a>         endEntityInformation.setTimeModified(<strong class="jxr_keyword">new</strong> Date());
<a class="jxr_linenumber" name="L716" href="#L716">716</a>         endEntityInformation.setType(<strong class="jxr_keyword">new</strong> EndEntityType(EndEntityTypes.ENDUSER));
<a class="jxr_linenumber" name="L717" href="#L717">717</a>         <em class="jxr_comment">// sendnotification, keyrecoverable and print must be set after setType, because it adds to the type</em>
<a class="jxr_linenumber" name="L718" href="#L718">718</a>         endEntityInformation.setSendNotification(isDefaultInProfile(EndEntityProfile.SENDNOTIFICATION) &amp;&amp; !endEntityInformation.getSendNotification());
<a class="jxr_linenumber" name="L719" href="#L719">719</a>         endEntityInformation.setKeyRecoverable(isDefaultInProfile(EndEntityProfile.KEYRECOVERABLE) &amp;&amp; !endEntityInformation.getKeyRecoverable());
<a class="jxr_linenumber" name="L720" href="#L720">720</a>         endEntityInformation.setPrintUserData(false); <em class="jxr_comment">// TODO not sure...</em>
<a class="jxr_linenumber" name="L721" href="#L721">721</a>         endEntityInformation.setTokenType(tokenType);
<a class="jxr_linenumber" name="L722" href="#L722">722</a> 
<a class="jxr_linenumber" name="L723" href="#L723">723</a>         <em class="jxr_comment">// Fill end-entity information (Username and Password)</em>
<a class="jxr_linenumber" name="L724" href="#L724">724</a>         <strong class="jxr_keyword">final</strong> byte[] randomData = <strong class="jxr_keyword">new</strong> byte[16];
<a class="jxr_linenumber" name="L725" href="#L725">725</a>         <strong class="jxr_keyword">final</strong> Random random = <strong class="jxr_keyword">new</strong> SecureRandom();
<a class="jxr_linenumber" name="L726" href="#L726">726</a>         random.nextBytes(randomData);
<a class="jxr_linenumber" name="L727" href="#L727">727</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isBlank(endEntityInformation.getUsername())) {
<a class="jxr_linenumber" name="L728" href="#L728">728</a>             String autousername = <strong class="jxr_keyword">new</strong> String(Hex.encode(randomData));
<a class="jxr_linenumber" name="L729" href="#L729">729</a>             <strong class="jxr_keyword">while</strong> (raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), autousername) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L730" href="#L730">730</a>                 <strong class="jxr_keyword">if</strong>(log.isDebugEnabled()){
<a class="jxr_linenumber" name="L731" href="#L731">731</a>                     log.debug(<span class="jxr_string">"Autogenerated username '"</span> + autousername + <span class="jxr_string">"' is already reserved. Generating the new one..."</span>);
<a class="jxr_linenumber" name="L732" href="#L732">732</a>                 }
<a class="jxr_linenumber" name="L733" href="#L733">733</a>                 random.nextBytes(randomData);
<a class="jxr_linenumber" name="L734" href="#L734">734</a>                 autousername = <strong class="jxr_keyword">new</strong> String(Hex.encode(randomData));
<a class="jxr_linenumber" name="L735" href="#L735">735</a>             }
<a class="jxr_linenumber" name="L736" href="#L736">736</a>             <strong class="jxr_keyword">if</strong>(log.isDebugEnabled()){
<a class="jxr_linenumber" name="L737" href="#L737">737</a>                 log.debug(<span class="jxr_string">"Unique username '"</span> + autousername + <span class="jxr_string">"' has been generated"</span>);
<a class="jxr_linenumber" name="L738" href="#L738">738</a>             }
<a class="jxr_linenumber" name="L739" href="#L739">739</a>             endEntityInformation.setUsername(autousername);
<a class="jxr_linenumber" name="L740" href="#L740">740</a>         }
<a class="jxr_linenumber" name="L741" href="#L741">741</a>         <strong class="jxr_keyword">if</strong> (getEndEntityProfile().useAutoGeneratedPasswd()) {
<a class="jxr_linenumber" name="L742" href="#L742">742</a>             <em class="jxr_comment">// If auto-generated passwords are used, this is set on the CA side when adding or changing the EE as long as the password is null</em>
<a class="jxr_linenumber" name="L743" href="#L743">743</a>             endEntityInformation.setPassword(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L744" href="#L744">744</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(endEntityInformation.getPassword())) {
<a class="jxr_linenumber" name="L745" href="#L745">745</a>             <em class="jxr_comment">// If not needed just use some random data</em>
<a class="jxr_linenumber" name="L746" href="#L746">746</a>             random.nextBytes(randomData);
<a class="jxr_linenumber" name="L747" href="#L747">747</a>             endEntityInformation.setPassword(<strong class="jxr_keyword">new</strong> String(Hex.encode(CertTools.generateSHA256Fingerprint(randomData))));
<a class="jxr_linenumber" name="L748" href="#L748">748</a>         }
<a class="jxr_linenumber" name="L749" href="#L749">749</a> 
<a class="jxr_linenumber" name="L750" href="#L750">750</a>         <em class="jxr_comment">//Fill end-entity information (KeyStoreAlgorithm* or CertificateRequest)</em>
<a class="jxr_linenumber" name="L751" href="#L751">751</a>         <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L752" href="#L752">752</a>             <strong class="jxr_keyword">final</strong> String[] tokenKeySpecSplit = getSelectedAlgorithm().split(<span class="jxr_string">"_"</span>);
<a class="jxr_linenumber" name="L753" href="#L753">753</a>             endEntityInformation.getExtendedInformation().setKeyStoreAlgorithmType(tokenKeySpecSplit[0]);
<a class="jxr_linenumber" name="L754" href="#L754">754</a>             endEntityInformation.getExtendedInformation().setKeyStoreAlgorithmSubType(tokenKeySpecSplit[1]);
<a class="jxr_linenumber" name="L755" href="#L755">755</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L756" href="#L756">756</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L757" href="#L757">757</a>                 endEntityInformation.getExtendedInformation().setCertificateRequest(CertTools.getCertificateRequestFromPem(getCertificateRequest()).getEncoded());
<a class="jxr_linenumber" name="L758" href="#L758">758</a>             } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L759" href="#L759">759</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_invalid_certificate_request"</span>);
<a class="jxr_linenumber" name="L760" href="#L760">760</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L761" href="#L761">761</a>             }
<a class="jxr_linenumber" name="L762" href="#L762">762</a>         }
<a class="jxr_linenumber" name="L763" href="#L763">763</a> 
<a class="jxr_linenumber" name="L764" href="#L764">764</a>         ErrorCode errorCode = <strong class="jxr_keyword">null</strong>; <em class="jxr_comment">// we need to be able to check for USER_ALREADY_EXISTS error during cleanup</em>
<a class="jxr_linenumber" name="L765" href="#L765">765</a>         <strong class="jxr_keyword">try</strong>{
<a class="jxr_linenumber" name="L766" href="#L766">766</a>             <em class="jxr_comment">//Add end-entity</em>
<a class="jxr_linenumber" name="L767" href="#L767">767</a>             <em class="jxr_comment">//Generates a keystore token if user has specified "ON SERVER" key pair generation.</em>
<a class="jxr_linenumber" name="L768" href="#L768">768</a>             <em class="jxr_comment">//Generates a certificate token if user has specified "PROVIDED_BY_USER" key pair generation</em>
<a class="jxr_linenumber" name="L769" href="#L769">769</a>             byte[] ret = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L770" href="#L770">770</a>             <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L771" href="#L771">771</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L772" href="#L772">772</a>                     ret = raMasterApiProxyBean.addUserAndGenerateKeyStore(raAuthenticationBean.getAuthenticationToken(), endEntityInformation, false);
<a class="jxr_linenumber" name="L773" href="#L773">773</a>                 } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L774" href="#L774">774</a>                     raLocaleBean.addMessageInfo(<span class="jxr_string">"enroll_unauthorized_operation"</span>, e.getMessage());
<a class="jxr_linenumber" name="L775" href="#L775">775</a>                     log.info(raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" is not authorized to execute this operation"</span>, e);
<a class="jxr_linenumber" name="L776" href="#L776">776</a>                     <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L777" href="#L777">777</a>                 } <strong class="jxr_keyword">catch</strong> (WaitingForApprovalException e) {
<a class="jxr_linenumber" name="L778" href="#L778">778</a>                     requestId = e.getRequestId();
<a class="jxr_linenumber" name="L779" href="#L779">779</a>                     log.info(<span class="jxr_string">"Request with ID "</span> + requestId + <span class="jxr_string">" is still waiting for approval"</span>);
<a class="jxr_linenumber" name="L780" href="#L780">780</a>                     <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L781" href="#L781">781</a>                 } <strong class="jxr_keyword">catch</strong> (EjbcaException e) {
<a class="jxr_linenumber" name="L782" href="#L782">782</a>                     errorCode = EjbcaException.getErrorCode(e);
<a class="jxr_linenumber" name="L783" href="#L783">783</a>                     <strong class="jxr_keyword">if</strong> (errorCode != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L784" href="#L784">784</a>                         <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.USER_ALREADY_EXISTS)) {
<a class="jxr_linenumber" name="L785" href="#L785">785</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_username_already_exists"</span>, endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L786" href="#L786">786</a>                             log.info(<span class="jxr_string">"Client "</span> + raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" failed to add end entity since the username "</span> + endEntityInformation.getUsername() + <span class="jxr_string">" already exists"</span>);
<a class="jxr_linenumber" name="L787" href="#L787">787</a>                         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.CERTIFICATE_WITH_THIS_SUBJECTDN_ALREADY_EXISTS_FOR_ANOTHER_USER)) {
<a class="jxr_linenumber" name="L788" href="#L788">788</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_subject_dn_already_exists_for_another_user"</span>, subjectDn.getValue());
<a class="jxr_linenumber" name="L789" href="#L789">789</a>                             log.info(<span class="jxr_string">"Subject DN "</span> + subjectDn.getValue() + <span class="jxr_string">" already exists for another user"</span>, e);
<a class="jxr_linenumber" name="L790" href="#L790">790</a>                         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.LOGIN_ERROR)) {
<a class="jxr_linenumber" name="L791" href="#L791">791</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), errorCode);
<a class="jxr_linenumber" name="L792" href="#L792">792</a>                             log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername() + <span class="jxr_string">": "</span> + e.getMessage() + <span class="jxr_string">", "</span> + errorCode);
<a class="jxr_linenumber" name="L793" href="#L793">793</a>                         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L794" href="#L794">794</a>                             raLocaleBean.addMessageError(errorCode);
<a class="jxr_linenumber" name="L795" href="#L795">795</a>                             log.info(<span class="jxr_string">"Exception creating keystore. Error Code: "</span> + errorCode, e);
<a class="jxr_linenumber" name="L796" href="#L796">796</a>                         }
<a class="jxr_linenumber" name="L797" href="#L797">797</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L798" href="#L798">798</a>                         raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L799" href="#L799">799</a>                         log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername() + <span class="jxr_string">": "</span> + e.getMessage());
<a class="jxr_linenumber" name="L800" href="#L800">800</a>                     }
<a class="jxr_linenumber" name="L801" href="#L801">801</a>                 } <strong class="jxr_keyword">catch</strong>(Exception e) {
<a class="jxr_linenumber" name="L802" href="#L802">802</a>                     raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L803" href="#L803">803</a>                     log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername()+<span class="jxr_string">": "</span>+e.getMessage());
<a class="jxr_linenumber" name="L804" href="#L804">804</a>                 }
<a class="jxr_linenumber" name="L805" href="#L805">805</a>             } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L806" href="#L806">806</a>                 <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L807" href="#L807">807</a>                     endEntityInformation.getExtendedInformation().setCertificateRequest(CertTools.getCertificateRequestFromPem(getCertificateRequest()).getEncoded());
<a class="jxr_linenumber" name="L808" href="#L808">808</a>                     <strong class="jxr_keyword">final</strong> byte[] certificateDataToDownload = raMasterApiProxyBean.addUserAndCreateCertificate(raAuthenticationBean.getAuthenticationToken(),
<a class="jxr_linenumber" name="L809" href="#L809">809</a>                             endEntityInformation, false);
<a class="jxr_linenumber" name="L810" href="#L810">810</a>                     <strong class="jxr_keyword">if</strong> (certificateDataToDownload == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L811" href="#L811">811</a>                         raLocaleBean.addMessageError(<span class="jxr_string">"enroll_certificate_could_not_be_generated"</span>, endEntityInformation.getUsername(), <span class="jxr_string">"null"</span>);
<a class="jxr_linenumber" name="L812" href="#L812">812</a>                         log.info(<span class="jxr_string">"Certificate could not be generated for end entity with username "</span> + endEntityInformation.getUsername() + <span class="jxr_string">": null"</span>);
<a class="jxr_linenumber" name="L813" href="#L813">813</a>                     } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (tokenDownloadType == TokenDownloadType.PEM_FULL_CHAIN) {
<a class="jxr_linenumber" name="L814" href="#L814">814</a>                         X509Certificate certificate = CertTools.getCertfromByteArray(certificateDataToDownload, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L815" href="#L815">815</a>                         LinkedList&lt;Certificate&gt; chain = <strong class="jxr_keyword">new</strong> LinkedList&lt;Certificate&gt;(getCAInfo().getCertificateChain());
<a class="jxr_linenumber" name="L816" href="#L816">816</a>                         chain.addFirst(certificate);
<a class="jxr_linenumber" name="L817" href="#L817">817</a>                         ret = CertTools.getPemFromCertificateChain(chain);
<a class="jxr_linenumber" name="L818" href="#L818">818</a>                     } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (tokenDownloadType == TokenDownloadType.PKCS7) {
<a class="jxr_linenumber" name="L819" href="#L819">819</a>                         X509Certificate certificate = CertTools.getCertfromByteArray(certificateDataToDownload, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L820" href="#L820">820</a>                         LinkedList&lt;Certificate&gt; chain = <strong class="jxr_keyword">new</strong> LinkedList&lt;Certificate&gt;(getCAInfo().getCertificateChain());
<a class="jxr_linenumber" name="L821" href="#L821">821</a>                         chain.addFirst(certificate);
<a class="jxr_linenumber" name="L822" href="#L822">822</a>                         ret = CertTools.getPemFromPkcs7(CertTools.createCertsOnlyCMS(CertTools.convertCertificateChainToX509Chain(chain)));
<a class="jxr_linenumber" name="L823" href="#L823">823</a>                     } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (tokenDownloadType == TokenDownloadType.PEM) {
<a class="jxr_linenumber" name="L824" href="#L824">824</a>                         X509Certificate certificate = CertTools.getCertfromByteArray(certificateDataToDownload, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L825" href="#L825">825</a>                         ret = CertTools.getPemFromCertificateChain(Arrays.asList((Certificate) certificate));
<a class="jxr_linenumber" name="L826" href="#L826">826</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L827" href="#L827">827</a>                         ret = certificateDataToDownload;
<a class="jxr_linenumber" name="L828" href="#L828">828</a>                     }
<a class="jxr_linenumber" name="L829" href="#L829">829</a>                 } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L830" href="#L830">830</a>                     raLocaleBean.addMessageInfo(<span class="jxr_string">"enroll_unauthorized_operation"</span>, e.getMessage());
<a class="jxr_linenumber" name="L831" href="#L831">831</a>                     log.info(raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" is not authorized to execute this operation"</span>, e);
<a class="jxr_linenumber" name="L832" href="#L832">832</a>                 } <strong class="jxr_keyword">catch</strong> (WaitingForApprovalException e) {
<a class="jxr_linenumber" name="L833" href="#L833">833</a>                     requestId = e.getRequestId();
<a class="jxr_linenumber" name="L834" href="#L834">834</a>                     log.info(<span class="jxr_string">"Request with ID "</span> + requestId + <span class="jxr_string">" is still waiting for approval"</span>);
<a class="jxr_linenumber" name="L835" href="#L835">835</a>                     <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L836" href="#L836">836</a>                 }<strong class="jxr_keyword">catch</strong> (EjbcaException | CertificateEncodingException | CertificateParsingException | ClassCastException | CMSException | IOException e) {
<a class="jxr_linenumber" name="L837" href="#L837">837</a>                     errorCode = EjbcaException.getErrorCode(e);
<a class="jxr_linenumber" name="L838" href="#L838">838</a>                     <strong class="jxr_keyword">if</strong> (errorCode != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L839" href="#L839">839</a>                         <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.USER_ALREADY_EXISTS)) {
<a class="jxr_linenumber" name="L840" href="#L840">840</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_username_already_exists"</span>, endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L841" href="#L841">841</a>                             log.info(<span class="jxr_string">"Client "</span> + raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" failed to add end entity since the username "</span> + endEntityInformation.getUsername() + <span class="jxr_string">" already exists"</span>);
<a class="jxr_linenumber" name="L842" href="#L842">842</a>                         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.CERTIFICATE_WITH_THIS_SUBJECTDN_ALREADY_EXISTS_FOR_ANOTHER_USER)) {
<a class="jxr_linenumber" name="L843" href="#L843">843</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_subject_dn_already_exists_for_another_user"</span>, subjectDn.getValue());
<a class="jxr_linenumber" name="L844" href="#L844">844</a>                             log.info(<span class="jxr_string">"Subject DN "</span> + subjectDn.getValue() + <span class="jxr_string">" already exists for another user"</span> , e);
<a class="jxr_linenumber" name="L845" href="#L845">845</a>                         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.LOGIN_ERROR)) {
<a class="jxr_linenumber" name="L846" href="#L846">846</a>                             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_certificate_could_not_be_generated"</span>, endEntityInformation.getUsername(), errorCode);
<a class="jxr_linenumber" name="L847" href="#L847">847</a>                             log.info(<span class="jxr_string">"Certificate could not be generated for user "</span> + endEntityInformation.getUsername()+<span class="jxr_string">": "</span>+e.getMessage()+<span class="jxr_string">", "</span>+errorCode);
<a class="jxr_linenumber" name="L848" href="#L848">848</a>                         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L849" href="#L849">849</a>                             raLocaleBean.addMessageError(errorCode);
<a class="jxr_linenumber" name="L850" href="#L850">850</a>                             log.info(<span class="jxr_string">"Exception creating certificate. Error Code: "</span> + errorCode, e);
<a class="jxr_linenumber" name="L851" href="#L851">851</a>                         }
<a class="jxr_linenumber" name="L852" href="#L852">852</a>                     } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L853" href="#L853">853</a>                         raLocaleBean.addMessageError(<span class="jxr_string">"enroll_certificate_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L854" href="#L854">854</a>                         log.info(<span class="jxr_string">"Certificate could not be generated for end entity with username "</span> + endEntityInformation.getUsername(), e);
<a class="jxr_linenumber" name="L855" href="#L855">855</a>                     }
<a class="jxr_linenumber" name="L856" href="#L856">856</a>                 }
<a class="jxr_linenumber" name="L857" href="#L857">857</a>             }
<a class="jxr_linenumber" name="L858" href="#L858">858</a>             <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L859" href="#L859">859</a>         } <strong class="jxr_keyword">finally</strong> {
<a class="jxr_linenumber" name="L860" href="#L860">860</a>             <em class="jxr_comment">//End entity clean-up must be done if enrollment could not be completed (but end-entity has been added and wasn't already existing)</em>
<a class="jxr_linenumber" name="L861" href="#L861">861</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L862" href="#L862">862</a>                 <strong class="jxr_keyword">if</strong> (errorCode == <strong class="jxr_keyword">null</strong> || !errorCode.equals(ErrorCode.USER_ALREADY_EXISTS)) {
<a class="jxr_linenumber" name="L863" href="#L863">863</a>                     EndEntityInformation fromCA = raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L864" href="#L864">864</a>                     <strong class="jxr_keyword">if</strong>(fromCA != <strong class="jxr_keyword">null</strong> &amp;&amp; fromCA.getStatus() != EndEntityConstants.STATUS_GENERATED){
<a class="jxr_linenumber" name="L865" href="#L865">865</a>                         raMasterApiProxyBean.deleteUser(raAuthenticationBean.getAuthenticationToken(), endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L866" href="#L866">866</a>                     }
<a class="jxr_linenumber" name="L867" href="#L867">867</a>                 }
<a class="jxr_linenumber" name="L868" href="#L868">868</a>             } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L869" href="#L869">869</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> IllegalStateException(e);
<a class="jxr_linenumber" name="L870" href="#L870">870</a>             }
<a class="jxr_linenumber" name="L871" href="#L871">871</a>             endEntityInformation.setUsername(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L872" href="#L872">872</a>         }
<a class="jxr_linenumber" name="L873" href="#L873">873</a>     }
<a class="jxr_linenumber" name="L874" href="#L874">874</a> 
<a class="jxr_linenumber" name="L875" href="#L875">875</a>     <em class="jxr_javadoccomment">/** Returns true if the default value of the given field is true in the end entity profile </em>
<a class="jxr_linenumber" name="L876" href="#L876">876</a> <em class="jxr_javadoccomment">     * @param field Field</em>
<a class="jxr_linenumber" name="L877" href="#L877">877</a> <em class="jxr_javadoccomment">     * @return bool */</em>
<a class="jxr_linenumber" name="L878" href="#L878">878</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isDefaultInProfile(<strong class="jxr_keyword">final</strong> String field) {
<a class="jxr_linenumber" name="L879" href="#L879">879</a>         <strong class="jxr_keyword">return</strong> EndEntityProfile.TRUE.equals(getEndEntityProfile().getValue(field, 0));
<a class="jxr_linenumber" name="L880" href="#L880">880</a>     }
<a class="jxr_linenumber" name="L881" href="#L881">881</a> 
<a class="jxr_linenumber" name="L882" href="#L882">882</a>     <em class="jxr_javadoccomment">/** Send a file to the client if token parameter is not set to null </em>
<a class="jxr_linenumber" name="L883" href="#L883">883</a> <em class="jxr_javadoccomment">     * @param token Token</em>
<a class="jxr_linenumber" name="L884" href="#L884">884</a> <em class="jxr_javadoccomment">     * @param responseContentType Type </em>
<a class="jxr_linenumber" name="L885" href="#L885">885</a> <em class="jxr_javadoccomment">     * @param fileExtension Extension */</em>
<a class="jxr_linenumber" name="L886" href="#L886">886</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> downloadToken(byte[] token, String responseContentType, String fileExtension) {
<a class="jxr_linenumber" name="L887" href="#L887">887</a>         <strong class="jxr_keyword">if</strong> (token == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L888" href="#L888">888</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L889" href="#L889">889</a>         }
<a class="jxr_linenumber" name="L890" href="#L890">890</a>         <em class="jxr_comment">//Download the token</em>
<a class="jxr_linenumber" name="L891" href="#L891">891</a>         FacesContext fc = FacesContext.getCurrentInstance();
<a class="jxr_linenumber" name="L892" href="#L892">892</a>         ExternalContext ec = fc.getExternalContext();
<a class="jxr_linenumber" name="L893" href="#L893">893</a>         ec.responseReset(); <em class="jxr_comment">// Some JSF component library or some Filter might have set some headers in the buffer beforehand. We want to get rid of them, else it may collide.</em>
<a class="jxr_linenumber" name="L894" href="#L894">894</a>         ec.setResponseContentType(responseContentType);
<a class="jxr_linenumber" name="L895" href="#L895">895</a>         ec.setResponseContentLength(token.length);
<a class="jxr_linenumber" name="L896" href="#L896">896</a>         <strong class="jxr_keyword">final</strong> String fileName = getFileName();
<a class="jxr_linenumber" name="L897" href="#L897">897</a>         ec.setResponseHeader(<span class="jxr_string">"Content-Disposition"</span>,
<a class="jxr_linenumber" name="L898" href="#L898">898</a>                 <span class="jxr_string">"attachment; filename=\&quot;"</span> + fileName + fileExtension +  <span class="jxr_string">"\&quot;"</span>); <em class="jxr_comment">// The Save As popup magic is done here. You can give it any file name you want, this only won't work in MSIE, it will use current request URL as file name instead.</em>
<a class="jxr_linenumber" name="L899" href="#L899">899</a>         <strong class="jxr_keyword">try</strong> (<strong class="jxr_keyword">final</strong> OutputStream output = ec.getResponseOutputStream()) {
<a class="jxr_linenumber" name="L900" href="#L900">900</a>             output.write(token);
<a class="jxr_linenumber" name="L901" href="#L901">901</a>             output.flush();
<a class="jxr_linenumber" name="L902" href="#L902">902</a>             fc.responseComplete(); <em class="jxr_comment">// Important! Otherwise JSF will attempt to render the response which obviously will fail since it's already written with a file and closed.</em>
<a class="jxr_linenumber" name="L903" href="#L903">903</a>         } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L904" href="#L904">904</a>             raLocaleBean.addMessageError(raLocaleBean.getMessage(<span class="jxr_string">"enroll_token_could_not_be_downloaded"</span>, fileName), e);
<a class="jxr_linenumber" name="L905" href="#L905">905</a>             log.info(<span class="jxr_string">"Token "</span> + fileName + <span class="jxr_string">" could not be downloaded"</span>, e);
<a class="jxr_linenumber" name="L906" href="#L906">906</a>         }
<a class="jxr_linenumber" name="L907" href="#L907">907</a>     }
<a class="jxr_linenumber" name="L908" href="#L908">908</a> 
<a class="jxr_linenumber" name="L909" href="#L909">909</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L910" href="#L910">910</a> <em class="jxr_javadoccomment">     * Calculates the filename for a token (P12 or PEM file) sent back to the client based on</em>
<a class="jxr_linenumber" name="L911" href="#L911">911</a> <em class="jxr_javadoccomment">     * the common name of the certificate.</em>
<a class="jxr_linenumber" name="L912" href="#L912">912</a> <em class="jxr_javadoccomment">     * @return the file name to use in the content disposition header</em>
<a class="jxr_linenumber" name="L913" href="#L913">913</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L914" href="#L914">914</a>     <strong class="jxr_keyword">private</strong> String getFileName() {
<a class="jxr_linenumber" name="L915" href="#L915">915</a>         <strong class="jxr_keyword">final</strong> String commonName = CertTools.getPartFromDN(getEndEntityInformation().getDN(), <span class="jxr_string">"CN"</span>);
<a class="jxr_linenumber" name="L916" href="#L916">916</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(commonName)) {
<a class="jxr_linenumber" name="L917" href="#L917">917</a>             <strong class="jxr_keyword">return</strong> <span class="jxr_string">"certificatetoken"</span>;
<a class="jxr_linenumber" name="L918" href="#L918">918</a>         }
<a class="jxr_linenumber" name="L919" href="#L919">919</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isAsciiPrintable(commonName)) {
<a class="jxr_linenumber" name="L920" href="#L920">920</a>             <strong class="jxr_keyword">return</strong> commonName;
<a class="jxr_linenumber" name="L921" href="#L921">921</a>         }
<a class="jxr_linenumber" name="L922" href="#L922">922</a>         <strong class="jxr_keyword">return</strong> Base64.encodeBase64String(commonName.getBytes());
<a class="jxr_linenumber" name="L923" href="#L923">923</a>     }
<a class="jxr_linenumber" name="L924" href="#L924">924</a> 
<a class="jxr_linenumber" name="L925" href="#L925">925</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L926" href="#L926">926</a> <em class="jxr_javadoccomment">     * Update RFC822NAME and DNEMAILADDRESS with value from end entity email</em>
<a class="jxr_linenumber" name="L927" href="#L927">927</a> <em class="jxr_javadoccomment">     * @param event Event</em>
<a class="jxr_linenumber" name="L928" href="#L928">928</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L929" href="#L929">929</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> updateOtherEmailFields(AjaxBehaviorEvent event) {
<a class="jxr_linenumber" name="L930" href="#L930">930</a>         updateRfcAltName();
<a class="jxr_linenumber" name="L931" href="#L931">931</a>         EndEntityProfile.FieldInstance dnEmailAddress = subjectDn.getFieldInstancesMap().get(DnComponents.DNEMAILADDRESS).get(0);
<a class="jxr_linenumber" name="L932" href="#L932">932</a>         <strong class="jxr_keyword">if</strong> (dnEmailAddress != <strong class="jxr_keyword">null</strong> &amp;&amp; dnEmailAddress.isUsed()) {
<a class="jxr_linenumber" name="L933" href="#L933">933</a>             dnEmailAddress.setValue(getEndEntityInformation().getEmail());
<a class="jxr_linenumber" name="L934" href="#L934">934</a>         }
<a class="jxr_linenumber" name="L935" href="#L935">935</a>     }
<a class="jxr_linenumber" name="L936" href="#L936">936</a> 
<a class="jxr_linenumber" name="L937" href="#L937">937</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">void</strong> updateRfcAltName() {
<a class="jxr_linenumber" name="L938" href="#L938">938</a>         EndEntityProfile.FieldInstance rfc822Name = subjectAlternativeName.getFieldInstancesMap().get(DnComponents.RFC822NAME).get(0);
<a class="jxr_linenumber" name="L939" href="#L939">939</a>         <strong class="jxr_keyword">if</strong> (rfc822Name != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L940" href="#L940">940</a>             <strong class="jxr_keyword">if</strong> (rfc822Name.getRfcEmailUsed()) {
<a class="jxr_linenumber" name="L941" href="#L941">941</a>                 String email = getEndEntityInformation().getEmail();
<a class="jxr_linenumber" name="L942" href="#L942">942</a>                 <strong class="jxr_keyword">if</strong> (email != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L943" href="#L943">943</a>                     rfc822Name.setValue(email);
<a class="jxr_linenumber" name="L944" href="#L944">944</a>                     <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L945" href="#L945">945</a>                 }
<a class="jxr_linenumber" name="L946" href="#L946">946</a>             }
<a class="jxr_linenumber" name="L947" href="#L947">947</a>             rfc822Name.setValue(<span class="jxr_string">""</span>);
<a class="jxr_linenumber" name="L948" href="#L948">948</a>         }
<a class="jxr_linenumber" name="L949" href="#L949">949</a>     }
<a class="jxr_linenumber" name="L950" href="#L950">950</a> 
<a class="jxr_linenumber" name="L951" href="#L951">951</a>     <em class="jxr_comment">//-----------------------------------------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L952" href="#L952">952</a>     <em class="jxr_comment">//Validators</em>
<a class="jxr_linenumber" name="L953" href="#L953">953</a> 
<a class="jxr_linenumber" name="L954" href="#L954">954</a>     <em class="jxr_javadoccomment">/** Check if the currently set username exists and that the state of subject DN is valid via 2 calls to the RA API. */</em>
<a class="jxr_linenumber" name="L955" href="#L955">955</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> checkRequestPreview(){
<a class="jxr_linenumber" name="L956" href="#L956">956</a>         checkUserCredentials();
<a class="jxr_linenumber" name="L957" href="#L957">957</a>         checkSubjectDn();
<a class="jxr_linenumber" name="L958" href="#L958">958</a>     }
<a class="jxr_linenumber" name="L959" href="#L959">959</a> 
<a class="jxr_linenumber" name="L960" href="#L960">960</a>     <em class="jxr_javadoccomment">/** Check if the currently set username exists via the RA API and render an error message if it does. */</em>
<a class="jxr_linenumber" name="L961" href="#L961">961</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> checkUserCredentials() {
<a class="jxr_linenumber" name="L962" href="#L962">962</a>         <strong class="jxr_keyword">final</strong> String username = getEndEntityInformation().getUsername();
<a class="jxr_linenumber" name="L963" href="#L963">963</a>         <strong class="jxr_keyword">if</strong> (username != <strong class="jxr_keyword">null</strong> &amp;&amp; !username.isEmpty() &amp;&amp; raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), username) != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L964" href="#L964">964</a>             FacesContext.getCurrentInstance().addMessage(userCredentialsMessagesComponent.getClientId(), <strong class="jxr_keyword">new</strong> FacesMessage(FacesMessage.SEVERITY_WARN,
<a class="jxr_linenumber" name="L965" href="#L965">965</a>                     raLocaleBean.getMessage(<span class="jxr_string">"enroll_username_already_exists"</span>, username), <strong class="jxr_keyword">null</strong>));
<a class="jxr_linenumber" name="L966" href="#L966">966</a>         }
<a class="jxr_linenumber" name="L967" href="#L967">967</a>     }
<a class="jxr_linenumber" name="L968" href="#L968">968</a> 
<a class="jxr_linenumber" name="L969" href="#L969">969</a>     <em class="jxr_javadoccomment">/** Update the current state of the EE-holder and validate the subject DN via the RA API. */</em>
<a class="jxr_linenumber" name="L970" href="#L970">970</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> checkSubjectDn() {
<a class="jxr_linenumber" name="L971" href="#L971">971</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L972" href="#L972">972</a>             <strong class="jxr_keyword">final</strong> EndEntityInformation endEntityInformation = getEndEntityInformation();
<a class="jxr_linenumber" name="L973" href="#L973">973</a>             endEntityInformation.setCAId(getCAInfo().getCAId());
<a class="jxr_linenumber" name="L974" href="#L974">974</a>             <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L975" href="#L975">975</a>                 log.debug(<span class="jxr_string">"checkSubjectDn: '"</span>+subjectDn.getUpdatedValue()+<span class="jxr_string">"'"</span>);
<a class="jxr_linenumber" name="L976" href="#L976">976</a>             }
<a class="jxr_linenumber" name="L977" href="#L977">977</a>             endEntityInformation.setDN(subjectDn.getUpdatedValue());
<a class="jxr_linenumber" name="L978" href="#L978">978</a>             raMasterApiProxyBean.checkSubjectDn(raAuthenticationBean.getAuthenticationToken(), endEntityInformation);
<a class="jxr_linenumber" name="L979" href="#L979">979</a>         } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e) {
<a class="jxr_linenumber" name="L980" href="#L980">980</a>             log.error(e);
<a class="jxr_linenumber" name="L981" href="#L981">981</a>         } <strong class="jxr_keyword">catch</strong> (EjbcaException e) {
<a class="jxr_linenumber" name="L982" href="#L982">982</a>             <strong class="jxr_keyword">if</strong> (ErrorCode.CERTIFICATE_WITH_THIS_SUBJECTDN_ALREADY_EXISTS_FOR_ANOTHER_USER.equals(e.getErrorCode())) {
<a class="jxr_linenumber" name="L983" href="#L983">983</a>                 FacesContext.getCurrentInstance().addMessage(subjectDnMessagesComponent.getClientId(), <strong class="jxr_keyword">new</strong> FacesMessage(FacesMessage.SEVERITY_WARN,
<a class="jxr_linenumber" name="L984" href="#L984">984</a>                         raLocaleBean.getMessage(<span class="jxr_string">"enroll_certificate_with_subject_dn_already_exists"</span>, subjectDn.getValue()), <strong class="jxr_keyword">null</strong>));
<a class="jxr_linenumber" name="L985" href="#L985">985</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L986" href="#L986">986</a>                 FacesContext.getCurrentInstance().addMessage(subjectDnMessagesComponent.getClientId(),
<a class="jxr_linenumber" name="L987" href="#L987">987</a>                         <strong class="jxr_keyword">new</strong> FacesMessage(FacesMessage.SEVERITY_WARN, raLocaleBean.getErrorCodeMessage(e.getErrorCode()), <strong class="jxr_keyword">null</strong>));
<a class="jxr_linenumber" name="L988" href="#L988">988</a>             }
<a class="jxr_linenumber" name="L989" href="#L989">989</a>         }
<a class="jxr_linenumber" name="L990" href="#L990">990</a>     }
<a class="jxr_linenumber" name="L991" href="#L991">991</a> 
<a class="jxr_linenumber" name="L992" href="#L992">992</a>     <em class="jxr_javadoccomment">/** Validate that password and password confirm entries match and render error messages otherwise. </em>
<a class="jxr_linenumber" name="L993" href="#L993">993</a> <em class="jxr_javadoccomment">     * @param event Event*/</em>
<a class="jxr_linenumber" name="L994" href="#L994">994</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> validatePassword(ComponentSystemEvent event) {
<a class="jxr_linenumber" name="L995" href="#L995">995</a>         <strong class="jxr_keyword">if</strong> (isPasswordRendered()){
<a class="jxr_linenumber" name="L996" href="#L996">996</a>             FacesContext fc = FacesContext.getCurrentInstance();
<a class="jxr_linenumber" name="L997" href="#L997">997</a>             UIComponent components = event.getComponent();
<a class="jxr_linenumber" name="L998" href="#L998">998</a>             UIInput uiInputPassword = (UIInput) components.findComponent(<span class="jxr_string">"passwordField"</span>);
<a class="jxr_linenumber" name="L999" href="#L999">999</a>             String password = uiInputPassword.getLocalValue() == <strong class="jxr_keyword">null</strong> ? <span class="jxr_string">""</span> : uiInputPassword.getLocalValue().toString();
<a class="jxr_linenumber" name="L1000" href="#L1000">1000</a>             UIInput uiInputConfirmPassword = (UIInput) components.findComponent(<span class="jxr_string">"passwordConfirmField"</span>);
<a class="jxr_linenumber" name="L1001" href="#L1001">1001</a>             String confirmPassword = uiInputConfirmPassword.getLocalValue() == <strong class="jxr_keyword">null</strong> ? <span class="jxr_string">""</span> : uiInputConfirmPassword.getLocalValue().toString();
<a class="jxr_linenumber" name="L1002" href="#L1002">1002</a>             <strong class="jxr_keyword">if</strong> (password.isEmpty()){
<a class="jxr_linenumber" name="L1003" href="#L1003">1003</a>                 fc.addMessage(confirmPasswordComponent.getClientId(fc), raLocaleBean.getFacesMessage(<span class="jxr_string">"enroll_password_can_not_be_empty"</span>));
<a class="jxr_linenumber" name="L1004" href="#L1004">1004</a>                 fc.renderResponse();
<a class="jxr_linenumber" name="L1005" href="#L1005">1005</a>             }
<a class="jxr_linenumber" name="L1006" href="#L1006">1006</a>             <strong class="jxr_keyword">if</strong> (!password.equals(confirmPassword)) {
<a class="jxr_linenumber" name="L1007" href="#L1007">1007</a>                 fc.addMessage(confirmPasswordComponent.getClientId(fc), raLocaleBean.getFacesMessage(<span class="jxr_string">"enroll_passwords_are_not_equal"</span>));
<a class="jxr_linenumber" name="L1008" href="#L1008">1008</a>                 fc.renderResponse();
<a class="jxr_linenumber" name="L1009" href="#L1009">1009</a>             }
<a class="jxr_linenumber" name="L1010" href="#L1010">1010</a>         }
<a class="jxr_linenumber" name="L1011" href="#L1011">1011</a>     }
<a class="jxr_linenumber" name="L1012" href="#L1012">1012</a> 
<a class="jxr_linenumber" name="L1013" href="#L1013">1013</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> actionUpdateCsrInfoFields() {
<a class="jxr_linenumber" name="L1014" href="#L1014">1014</a>         String fileName = uploadFile.getName();
<a class="jxr_linenumber" name="L1015" href="#L1015">1015</a> 
<a class="jxr_linenumber" name="L1016" href="#L1016">1016</a>         csrFileName = fileName;
<a class="jxr_linenumber" name="L1017" href="#L1017">1017</a> 
<a class="jxr_linenumber" name="L1018" href="#L1018">1018</a>         String fileContents;
<a class="jxr_linenumber" name="L1019" href="#L1019">1019</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1020" href="#L1020">1020</a>             fileContents = <strong class="jxr_keyword">new</strong> String(uploadFile.getBytes());
<a class="jxr_linenumber" name="L1021" href="#L1021">1021</a>         } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L1022" href="#L1022">1022</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_invalid_certificate_request"</span>);
<a class="jxr_linenumber" name="L1023" href="#L1023">1023</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L1024" href="#L1024">1024</a>         }
<a class="jxr_linenumber" name="L1025" href="#L1025">1025</a> 
<a class="jxr_linenumber" name="L1026" href="#L1026">1026</a>         validateCsr(fileContents);
<a class="jxr_linenumber" name="L1027" href="#L1027">1027</a>         <strong class="jxr_keyword">if</strong> (algorithmFromCsr != <strong class="jxr_keyword">null</strong>) { <em class="jxr_comment">// valid CSR</em>
<a class="jxr_linenumber" name="L1028" href="#L1028">1028</a>             uploadCsr();
<a class="jxr_linenumber" name="L1029" href="#L1029">1029</a>         }
<a class="jxr_linenumber" name="L1030" href="#L1030">1030</a>     }
<a class="jxr_linenumber" name="L1031" href="#L1031">1031</a> 
<a class="jxr_linenumber" name="L1032" href="#L1032">1032</a>     <em class="jxr_javadoccomment">/** Validate an uploaded CSR and store the extracted key algorithm and CSR for later use. </em>
<a class="jxr_linenumber" name="L1033" href="#L1033">1033</a> <em class="jxr_javadoccomment">     * @param csrValue Value</em>
<a class="jxr_linenumber" name="L1034" href="#L1034">1034</a> <em class="jxr_javadoccomment">     * @throws ValidatorException Fail */</em>
<a class="jxr_linenumber" name="L1035" href="#L1035">1035</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> validateCsr(String csrValue) <strong class="jxr_keyword">throws</strong> ValidatorException {
<a class="jxr_linenumber" name="L1036" href="#L1036">1036</a>         algorithmFromCsr = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1037" href="#L1037">1037</a>         <strong class="jxr_keyword">if</strong> (csrValue != <strong class="jxr_keyword">null</strong> &amp;&amp; csrValue.length() &gt; EnrollMakeNewRequestBean.MAX_CSR_LENGTH) {
<a class="jxr_linenumber" name="L1038" href="#L1038">1038</a>             log.info(<span class="jxr_string">"CSR uploaded was too large: "</span>+csrValue.length());
<a class="jxr_linenumber" name="L1039" href="#L1039">1039</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_invalid_certificate_request"</span>);
<a class="jxr_linenumber" name="L1040" href="#L1040">1040</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L1041" href="#L1041">1041</a>         }
<a class="jxr_linenumber" name="L1042" href="#L1042">1042</a>         PKCS10CertificationRequest pkcs10CertificateRequest = CertTools.getCertificateRequestFromPem(csrValue);
<a class="jxr_linenumber" name="L1043" href="#L1043">1043</a>         <strong class="jxr_keyword">if</strong> (pkcs10CertificateRequest == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1044" href="#L1044">1044</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_invalid_certificate_request"</span>);
<a class="jxr_linenumber" name="L1045" href="#L1045">1045</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L1046" href="#L1046">1046</a>         }
<a class="jxr_linenumber" name="L1047" href="#L1047">1047</a> 
<a class="jxr_linenumber" name="L1048" href="#L1048">1048</a>         <em class="jxr_comment">//Get public key algorithm from CSR and check if it's allowed in certificate profile</em>
<a class="jxr_linenumber" name="L1049" href="#L1049">1049</a>         <strong class="jxr_keyword">final</strong> JcaPKCS10CertificationRequest jcaPKCS10CertificationRequest = <strong class="jxr_keyword">new</strong> JcaPKCS10CertificationRequest(pkcs10CertificateRequest);
<a class="jxr_linenumber" name="L1050" href="#L1050">1050</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L1051" href="#L1051">1051</a>             <strong class="jxr_keyword">final</strong> String keySpecification = AlgorithmTools.getKeySpecification(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L1052" href="#L1052">1052</a>             <strong class="jxr_keyword">final</strong> String keyAlgorithm = AlgorithmTools.getKeyAlgorithm(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L1053" href="#L1053">1053</a> 
<a class="jxr_linenumber" name="L1054" href="#L1054">1054</a>             <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L1055" href="#L1055">1055</a>             <strong class="jxr_keyword">if</strong> (!certificateProfile.isKeyTypeAllowed(keyAlgorithm, keySpecification)) {
<a class="jxr_linenumber" name="L1056" href="#L1056">1056</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_key_algorithm_is_not_available"</span>, keyAlgorithm + <span class="jxr_string">"_"</span> + keySpecification);
<a class="jxr_linenumber" name="L1057" href="#L1057">1057</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_key_algorithm_is_not_available"</span>, keyAlgorithm + <span class="jxr_string">"_"</span> + keySpecification)));
<a class="jxr_linenumber" name="L1058" href="#L1058">1058</a>             }
<a class="jxr_linenumber" name="L1059" href="#L1059">1059</a>             algorithmFromCsr = keyAlgorithm + <span class="jxr_string">" "</span> + keySpecification;<em class="jxr_comment">// Save for later use</em>
<a class="jxr_linenumber" name="L1060" href="#L1060">1060</a> 
<a class="jxr_linenumber" name="L1061" href="#L1061">1061</a>             certificateRequest = csrValue;
<a class="jxr_linenumber" name="L1062" href="#L1062">1062</a> 
<a class="jxr_linenumber" name="L1063" href="#L1063">1063</a>             PublicKey publicKey = jcaPKCS10CertificationRequest.getPublicKey();
<a class="jxr_linenumber" name="L1064" href="#L1064">1064</a>             publicKeyModulus = KeyTools.getKeyModulus(publicKey);
<a class="jxr_linenumber" name="L1065" href="#L1065">1065</a> 
<a class="jxr_linenumber" name="L1066" href="#L1066">1066</a>             publicKeyExponent = KeyTools.getKeyPublicExponent(publicKey);
<a class="jxr_linenumber" name="L1067" href="#L1067">1067</a>             sha256Fingerprint = KeyTools.getSha256Fingerprint(certificateRequest);
<a class="jxr_linenumber" name="L1068" href="#L1068">1068</a>             signature = KeyTools.getCertificateRequestSignature(jcaPKCS10CertificationRequest);
<a class="jxr_linenumber" name="L1069" href="#L1069">1069</a> 
<a class="jxr_linenumber" name="L1070" href="#L1070">1070</a>         } <strong class="jxr_keyword">catch</strong> (InvalidKeyException | NoSuchAlgorithmException e) {
<a class="jxr_linenumber" name="L1071" href="#L1071">1071</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_unknown_key_algorithm"</span>);
<a class="jxr_linenumber" name="L1072" href="#L1072">1072</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_unknown_key_algorithm"</span>)));
<a class="jxr_linenumber" name="L1073" href="#L1073">1073</a>         }
<a class="jxr_linenumber" name="L1074" href="#L1074">1074</a>     }
<a class="jxr_linenumber" name="L1075" href="#L1075">1075</a> 
<a class="jxr_linenumber" name="L1076" href="#L1076">1076</a> 
<a class="jxr_linenumber" name="L1077" href="#L1077">1077</a>     <em class="jxr_comment">//-----------------------------------------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L1078" href="#L1078">1078</a>     <em class="jxr_comment">// Getters and setters</em>
<a class="jxr_linenumber" name="L1079" href="#L1079">1079</a> 
<a class="jxr_linenumber" name="L1080" href="#L1080">1080</a>     <em class="jxr_javadoccomment">/** @return the authorizedEndEntityProfiles */</em>
<a class="jxr_linenumber" name="L1081" href="#L1081">1081</a>     <strong class="jxr_keyword">public</strong> IdNameHashMap&lt;EndEntityProfile&gt; getAuthorizedEndEntityProfiles() {
<a class="jxr_linenumber" name="L1082" href="#L1082">1082</a>         <strong class="jxr_keyword">return</strong> authorizedEndEntityProfiles;
<a class="jxr_linenumber" name="L1083" href="#L1083">1083</a>     }
<a class="jxr_linenumber" name="L1084" href="#L1084">1084</a> 
<a class="jxr_linenumber" name="L1085" href="#L1085">1085</a>     <em class="jxr_javadoccomment">/** @return true if fields that the client can't modify should still be rendered */</em>
<a class="jxr_linenumber" name="L1086" href="#L1086">1086</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderNonModifiableTemplates() {
<a class="jxr_linenumber" name="L1087" href="#L1087">1087</a>         <strong class="jxr_keyword">return</strong> renderNonModifiableTemplates;
<a class="jxr_linenumber" name="L1088" href="#L1088">1088</a>     }
<a class="jxr_linenumber" name="L1089" href="#L1089">1089</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRenderNonModifiableTemplates(<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> renderNonModifiableTemplates) {
<a class="jxr_linenumber" name="L1090" href="#L1090">1090</a>         <strong class="jxr_keyword">this</strong>.renderNonModifiableTemplates = renderNonModifiableTemplates;
<a class="jxr_linenumber" name="L1091" href="#L1091">1091</a>     }
<a class="jxr_linenumber" name="L1092" href="#L1092">1092</a>     <em class="jxr_javadoccomment">/** @return true if fields that the client can't modify should still be rendered */</em>
<a class="jxr_linenumber" name="L1093" href="#L1093">1093</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderNonModifiableFields() {
<a class="jxr_linenumber" name="L1094" href="#L1094">1094</a>         <strong class="jxr_keyword">return</strong> renderNonModifiableFields;
<a class="jxr_linenumber" name="L1095" href="#L1095">1095</a>     }
<a class="jxr_linenumber" name="L1096" href="#L1096">1096</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRenderNonModifiableFields(<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> renderNonModifiableFields) {
<a class="jxr_linenumber" name="L1097" href="#L1097">1097</a>         <strong class="jxr_keyword">this</strong>.renderNonModifiableFields = renderNonModifiableFields;
<a class="jxr_linenumber" name="L1098" href="#L1098">1098</a>     }
<a class="jxr_linenumber" name="L1099" href="#L1099">1099</a> 
<a class="jxr_linenumber" name="L1100" href="#L1100">1100</a>     <em class="jxr_javadoccomment">/** @return the current EndEntityProfile as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1101" href="#L1101">1101</a>     <strong class="jxr_keyword">public</strong> EndEntityProfile getEndEntityProfile() {
<a class="jxr_linenumber" name="L1102" href="#L1102">1102</a>         <strong class="jxr_keyword">if</strong> (getSelectedEndEntityProfile() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1103" href="#L1103">1103</a>             <strong class="jxr_keyword">final</strong> KeyToValueHolder&lt;EndEntityProfile&gt; temp = authorizedEndEntityProfiles.get(Integer.parseInt(getSelectedEndEntityProfile()));
<a class="jxr_linenumber" name="L1104" href="#L1104">1104</a>             <strong class="jxr_keyword">if</strong> (temp != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1105" href="#L1105">1105</a>                 <strong class="jxr_keyword">return</strong> temp.getValue();
<a class="jxr_linenumber" name="L1106" href="#L1106">1106</a>             }
<a class="jxr_linenumber" name="L1107" href="#L1107">1107</a>         }
<a class="jxr_linenumber" name="L1108" href="#L1108">1108</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1109" href="#L1109">1109</a>     }
<a class="jxr_linenumber" name="L1110" href="#L1110">1110</a> 
<a class="jxr_linenumber" name="L1111" href="#L1111">1111</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1112" href="#L1112">1112</a> <em class="jxr_javadoccomment">     * @return The user-defined validity for the private key.</em>
<a class="jxr_linenumber" name="L1113" href="#L1113">1113</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L1114" href="#L1114">1114</a>     <strong class="jxr_keyword">public</strong> String getValidity() {
<a class="jxr_linenumber" name="L1115" href="#L1115">1115</a>         <strong class="jxr_keyword">return</strong> validity;
<a class="jxr_linenumber" name="L1116" href="#L1116">1116</a>     }
<a class="jxr_linenumber" name="L1117" href="#L1117">1117</a> 
<a class="jxr_linenumber" name="L1118" href="#L1118">1118</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1119" href="#L1119">1119</a> <em class="jxr_javadoccomment">     * Set a user-defined validity for the private key.</em>
<a class="jxr_linenumber" name="L1120" href="#L1120">1120</a> <em class="jxr_javadoccomment">     * @param validity Validity</em>
<a class="jxr_linenumber" name="L1121" href="#L1121">1121</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L1122" href="#L1122">1122</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setValidity(<strong class="jxr_keyword">final</strong> String validity) {
<a class="jxr_linenumber" name="L1123" href="#L1123">1123</a>         <strong class="jxr_keyword">this</strong>.validity = validity;
<a class="jxr_linenumber" name="L1124" href="#L1124">1124</a>     }
<a class="jxr_linenumber" name="L1125" href="#L1125">1125</a> 
<a class="jxr_linenumber" name="L1126" href="#L1126">1126</a>     <em class="jxr_javadoccomment">/** @return the current CertificateProfile as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1127" href="#L1127">1127</a>     <strong class="jxr_keyword">private</strong> CertificateProfile getCertificateProfile() {
<a class="jxr_linenumber" name="L1128" href="#L1128">1128</a>         <strong class="jxr_keyword">if</strong> (getSelectedCertificateProfile() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1129" href="#L1129">1129</a>             KeyToValueHolder&lt;CertificateProfile&gt; temp = authorizedCertificateProfiles.get(Integer.parseInt(getSelectedCertificateProfile()));
<a class="jxr_linenumber" name="L1130" href="#L1130">1130</a>             <strong class="jxr_keyword">if</strong> (temp != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1131" href="#L1131">1131</a>                 <strong class="jxr_keyword">return</strong> temp.getValue();
<a class="jxr_linenumber" name="L1132" href="#L1132">1132</a>             }
<a class="jxr_linenumber" name="L1133" href="#L1133">1133</a>         }
<a class="jxr_linenumber" name="L1134" href="#L1134">1134</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1135" href="#L1135">1135</a>     }
<a class="jxr_linenumber" name="L1136" href="#L1136">1136</a> 
<a class="jxr_linenumber" name="L1137" href="#L1137">1137</a>     <em class="jxr_javadoccomment">/** @return the current CAInfo as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1138" href="#L1138">1138</a>     <strong class="jxr_keyword">private</strong> CAInfo getCAInfo() {
<a class="jxr_linenumber" name="L1139" href="#L1139">1139</a>         <strong class="jxr_keyword">if</strong> (getSelectedCertificateAuthority() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1140" href="#L1140">1140</a>             KeyToValueHolder&lt;CAInfo&gt; temp = authorizedCAInfos.get(Integer.parseInt(getSelectedCertificateAuthority()));
<a class="jxr_linenumber" name="L1141" href="#L1141">1141</a>             <strong class="jxr_keyword">if</strong> (temp != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1142" href="#L1142">1142</a>                 <strong class="jxr_keyword">return</strong> temp.getValue();
<a class="jxr_linenumber" name="L1143" href="#L1143">1143</a>             }
<a class="jxr_linenumber" name="L1144" href="#L1144">1144</a>         }
<a class="jxr_linenumber" name="L1145" href="#L1145">1145</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1146" href="#L1146">1146</a>     }
<a class="jxr_linenumber" name="L1147" href="#L1147">1147</a> 
<a class="jxr_linenumber" name="L1148" href="#L1148">1148</a>     <em class="jxr_javadoccomment">/** @return the current key algorithm as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1149" href="#L1149">1149</a>     <strong class="jxr_keyword">public</strong> String getAlgorithm(){
<a class="jxr_linenumber" name="L1150" href="#L1150">1150</a>         <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L1151" href="#L1151">1151</a>             <strong class="jxr_keyword">return</strong> getSelectedAlgorithm();
<a class="jxr_linenumber" name="L1152" href="#L1152">1152</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1153" href="#L1153">1153</a>             <strong class="jxr_keyword">return</strong> algorithmFromCsr;
<a class="jxr_linenumber" name="L1154" href="#L1154">1154</a>         }
<a class="jxr_linenumber" name="L1155" href="#L1155">1155</a>     }
<a class="jxr_linenumber" name="L1156" href="#L1156">1156</a> 
<a class="jxr_linenumber" name="L1157" href="#L1157">1157</a>     <em class="jxr_javadoccomment">/** @return the current lazy initialized selectedEndEntityProfile */</em>
<a class="jxr_linenumber" name="L1158" href="#L1158">1158</a>     <strong class="jxr_keyword">public</strong> String getSelectedEndEntityProfile() {
<a class="jxr_linenumber" name="L1159" href="#L1159">1159</a>         <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableEndEntityProfiles = getAvailableEndEntityProfiles();
<a class="jxr_linenumber" name="L1160" href="#L1160">1160</a>         <strong class="jxr_keyword">if</strong> (availableEndEntityProfiles.size()==1) {
<a class="jxr_linenumber" name="L1161" href="#L1161">1161</a>             setSelectedEndEntityProfile(String.valueOf(availableEndEntityProfiles.get(0)));
<a class="jxr_linenumber" name="L1162" href="#L1162">1162</a>         }
<a class="jxr_linenumber" name="L1163" href="#L1163">1163</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedEndEntityProfile)) {
<a class="jxr_linenumber" name="L1164" href="#L1164">1164</a>             <strong class="jxr_keyword">if</strong> (!availableEndEntityProfiles.contains(Integer.parseInt(selectedEndEntityProfile))) {
<a class="jxr_linenumber" name="L1165" href="#L1165">1165</a>                 setSelectedEndEntityProfile(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1166" href="#L1166">1166</a>             }
<a class="jxr_linenumber" name="L1167" href="#L1167">1167</a>         }
<a class="jxr_linenumber" name="L1168" href="#L1168">1168</a>         <strong class="jxr_keyword">return</strong> selectedEndEntityProfile;
<a class="jxr_linenumber" name="L1169" href="#L1169">1169</a>     }
<a class="jxr_linenumber" name="L1170" href="#L1170">1170</a> 
<a class="jxr_linenumber" name="L1171" href="#L1171">1171</a>     <em class="jxr_javadoccomment">/** @param selectedEndEntityProfile the selectedEndEntityProfile to set */</em>
<a class="jxr_linenumber" name="L1172" href="#L1172">1172</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedEndEntityProfile(<strong class="jxr_keyword">final</strong> String selectedEndEntityProfile) {
<a class="jxr_linenumber" name="L1173" href="#L1173">1173</a>         <strong class="jxr_keyword">if</strong> (!StringUtils.equals(selectedEndEntityProfile, <strong class="jxr_keyword">this</strong>.selectedEndEntityProfile)) {
<a class="jxr_linenumber" name="L1174" href="#L1174">1174</a>             <em class="jxr_comment">// When ever the end entity profile changes this affects available request fields</em>
<a class="jxr_linenumber" name="L1175" href="#L1175">1175</a>             resetRequestInfo();
<a class="jxr_linenumber" name="L1176" href="#L1176">1176</a>         }
<a class="jxr_linenumber" name="L1177" href="#L1177">1177</a>         <strong class="jxr_keyword">this</strong>.selectedEndEntityProfile = selectedEndEntityProfile;
<a class="jxr_linenumber" name="L1178" href="#L1178">1178</a>     }
<a class="jxr_linenumber" name="L1179" href="#L1179">1179</a> 
<a class="jxr_linenumber" name="L1180" href="#L1180">1180</a>     <em class="jxr_javadoccomment">/** @return the current key generation type as determined by state of dependencies as String */</em>
<a class="jxr_linenumber" name="L1181" href="#L1181">1181</a>     <strong class="jxr_keyword">public</strong> String getSelectedKeyPairGeneration() {
<a class="jxr_linenumber" name="L1182" href="#L1182">1182</a>         <strong class="jxr_keyword">return</strong> getSelectedKeyPairGenerationEnum()==<strong class="jxr_keyword">null</strong> ? <strong class="jxr_keyword">null</strong> : getSelectedKeyPairGenerationEnum().name();
<a class="jxr_linenumber" name="L1183" href="#L1183">1183</a>     }
<a class="jxr_linenumber" name="L1184" href="#L1184">1184</a> 
<a class="jxr_linenumber" name="L1185" href="#L1185">1185</a>     <em class="jxr_javadoccomment">/** @return the current key generation type as determined by state of dependencies as enum */</em>
<a class="jxr_linenumber" name="L1186" href="#L1186">1186</a>     <strong class="jxr_keyword">private</strong> KeyPairGeneration getSelectedKeyPairGenerationEnum() {
<a class="jxr_linenumber" name="L1187" href="#L1187">1187</a>         <strong class="jxr_keyword">if</strong> (getAvailableKeyPairGenerationSelectItems().size() == 1) {
<a class="jxr_linenumber" name="L1188" href="#L1188">1188</a>             setSelectedKeyPairGeneration(getAvailableKeyPairGenerations().get(0).name());
<a class="jxr_linenumber" name="L1189" href="#L1189">1189</a>         }
<a class="jxr_linenumber" name="L1190" href="#L1190">1190</a>         <strong class="jxr_keyword">return</strong> selectedKeyPairGeneration;
<a class="jxr_linenumber" name="L1191" href="#L1191">1191</a>     }
<a class="jxr_linenumber" name="L1192" href="#L1192">1192</a> 
<a class="jxr_linenumber" name="L1193" href="#L1193">1193</a>     <em class="jxr_javadoccomment">/** @param selectedKeyStoreGeneration the selectedKeyPairGeneration to set */</em>
<a class="jxr_linenumber" name="L1194" href="#L1194">1194</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedKeyPairGeneration(<strong class="jxr_keyword">final</strong> String selectedKeyStoreGeneration) {
<a class="jxr_linenumber" name="L1195" href="#L1195">1195</a>         <strong class="jxr_keyword">final</strong> String currentSelection = <strong class="jxr_keyword">this</strong>.selectedKeyPairGeneration==<strong class="jxr_keyword">null</strong> ? <strong class="jxr_keyword">null</strong> : <strong class="jxr_keyword">this</strong>.selectedKeyPairGeneration.name();
<a class="jxr_linenumber" name="L1196" href="#L1196">1196</a>         <strong class="jxr_keyword">if</strong> (!StringUtils.equals(selectedKeyStoreGeneration, currentSelection)) {
<a class="jxr_linenumber" name="L1197" href="#L1197">1197</a>             resetAlgorithmCsrUpload();
<a class="jxr_linenumber" name="L1198" href="#L1198">1198</a>         }
<a class="jxr_linenumber" name="L1199" href="#L1199">1199</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedKeyStoreGeneration)) {
<a class="jxr_linenumber" name="L1200" href="#L1200">1200</a>             <strong class="jxr_keyword">this</strong>.selectedKeyPairGeneration = KeyPairGeneration.valueOf(selectedKeyStoreGeneration);
<a class="jxr_linenumber" name="L1201" href="#L1201">1201</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1202" href="#L1202">1202</a>             <strong class="jxr_keyword">this</strong>.selectedKeyPairGeneration = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1203" href="#L1203">1203</a>         }
<a class="jxr_linenumber" name="L1204" href="#L1204">1204</a>     }
<a class="jxr_linenumber" name="L1205" href="#L1205">1205</a> 
<a class="jxr_linenumber" name="L1206" href="#L1206">1206</a>     <em class="jxr_javadoccomment">/** @return the current available key generation types as determined by state of dependencies for UI rendering */</em>
<a class="jxr_linenumber" name="L1207" href="#L1207">1207</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableKeyPairGenerationSelectItems() {
<a class="jxr_linenumber" name="L1208" href="#L1208">1208</a>         <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1209" href="#L1209">1209</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> KeyPairGeneration keyPairGeneration : getAvailableKeyPairGenerations()) {
<a class="jxr_linenumber" name="L1210" href="#L1210">1210</a>             <strong class="jxr_keyword">final</strong> String label = raLocaleBean.getMessage(<span class="jxr_string">"enroll_key_pair_generation_"</span> + keyPairGeneration.name().toLowerCase());
<a class="jxr_linenumber" name="L1211" href="#L1211">1211</a>             ret.add(<strong class="jxr_keyword">new</strong> SelectItem(keyPairGeneration.name(), label));
<a class="jxr_linenumber" name="L1212" href="#L1212">1212</a>         }
<a class="jxr_linenumber" name="L1213" href="#L1213">1213</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1214" href="#L1214">1214</a>     }
<a class="jxr_linenumber" name="L1215" href="#L1215">1215</a> 
<a class="jxr_linenumber" name="L1216" href="#L1216">1216</a>     <em class="jxr_javadoccomment">/** @return the current available key generation types as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1217" href="#L1217">1217</a>     <strong class="jxr_keyword">private</strong> List&lt;KeyPairGeneration&gt; getAvailableKeyPairGenerations() {
<a class="jxr_linenumber" name="L1218" href="#L1218">1218</a>         <strong class="jxr_keyword">final</strong> List&lt;KeyPairGeneration&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1219" href="#L1219">1219</a>         <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1220" href="#L1220">1220</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1221" href="#L1221">1221</a>             <strong class="jxr_keyword">final</strong> String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L1222" href="#L1222">1222</a>             <strong class="jxr_keyword">if</strong> (availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_P12))
<a class="jxr_linenumber" name="L1223" href="#L1223">1223</a>                     || availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_JKS))
<a class="jxr_linenumber" name="L1224" href="#L1224">1224</a>                     || availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_PEM))) {
<a class="jxr_linenumber" name="L1225" href="#L1225">1225</a>                 ret.add(KeyPairGeneration.ON_SERVER);
<a class="jxr_linenumber" name="L1226" href="#L1226">1226</a>             }
<a class="jxr_linenumber" name="L1227" href="#L1227">1227</a>             <strong class="jxr_keyword">if</strong> (availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_BROWSERGEN))) {
<a class="jxr_linenumber" name="L1228" href="#L1228">1228</a>                 ret.add(KeyPairGeneration.PROVIDED_BY_USER);
<a class="jxr_linenumber" name="L1229" href="#L1229">1229</a>             }
<a class="jxr_linenumber" name="L1230" href="#L1230">1230</a>         }
<a class="jxr_linenumber" name="L1231" href="#L1231">1231</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1232" href="#L1232">1232</a>     }
<a class="jxr_linenumber" name="L1233" href="#L1233">1233</a> 
<a class="jxr_linenumber" name="L1234" href="#L1234">1234</a>     <em class="jxr_javadoccomment">/** @return a List of available end entity profiles for UI rendering */</em>
<a class="jxr_linenumber" name="L1235" href="#L1235">1235</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableEndEntityProfileSelectItems() {
<a class="jxr_linenumber" name="L1236" href="#L1236">1236</a>         <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1237" href="#L1237">1237</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Integer id : getAvailableEndEntityProfiles()) {
<a class="jxr_linenumber" name="L1238" href="#L1238">1238</a>             ret.add(<strong class="jxr_keyword">new</strong> SelectItem(String.valueOf(id), authorizedEndEntityProfiles.get(id).getName()));
<a class="jxr_linenumber" name="L1239" href="#L1239">1239</a>         }
<a class="jxr_linenumber" name="L1240" href="#L1240">1240</a>         <strong class="jxr_keyword">if</strong> (ret.size()&gt;1 &amp;&amp; StringUtils.isEmpty(getSelectedEndEntityProfile())) {
<a class="jxr_linenumber" name="L1241" href="#L1241">1241</a>             ret.add(<strong class="jxr_keyword">new</strong> SelectItem(<strong class="jxr_keyword">null</strong>, raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_eep_nochoice"</span>), raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_eep_nochoice"</span>), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1242" href="#L1242">1242</a>         }
<a class="jxr_linenumber" name="L1243" href="#L1243">1243</a>         EnrollMakeNewRequestBean.sortSelectItemsByLabel(ret);
<a class="jxr_linenumber" name="L1244" href="#L1244">1244</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1245" href="#L1245">1245</a>     }
<a class="jxr_linenumber" name="L1246" href="#L1246">1246</a> 
<a class="jxr_linenumber" name="L1247" href="#L1247">1247</a>     <em class="jxr_javadoccomment">/** @return a List of available end entity profile identifiers */</em>
<a class="jxr_linenumber" name="L1248" href="#L1248">1248</a>     <strong class="jxr_keyword">private</strong> List&lt;Integer&gt; getAvailableEndEntityProfiles() {
<a class="jxr_linenumber" name="L1249" href="#L1249">1249</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;(authorizedEndEntityProfiles.idKeySet());
<a class="jxr_linenumber" name="L1250" href="#L1250">1250</a>     }
<a class="jxr_linenumber" name="L1251" href="#L1251">1251</a> 
<a class="jxr_linenumber" name="L1252" href="#L1252">1252</a>     <em class="jxr_javadoccomment">/** @return the current List of available certificate profiles as determined by state of dependencies for UI rendering */</em>
<a class="jxr_linenumber" name="L1253" href="#L1253">1253</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableCertificateProfileSelectItems() {
<a class="jxr_linenumber" name="L1254" href="#L1254">1254</a>         <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1255" href="#L1255">1255</a>         <strong class="jxr_keyword">final</strong> String defaultId = getEndEntityProfile().getValue(EndEntityProfile.DEFAULTCERTPROFILE, 0);
<a class="jxr_linenumber" name="L1256" href="#L1256">1256</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Integer id : getAvailableCertificateProfiles()) {
<a class="jxr_linenumber" name="L1257" href="#L1257">1257</a>             <strong class="jxr_keyword">if</strong> (defaultId.equals(String.valueOf(id))) {
<a class="jxr_linenumber" name="L1258" href="#L1258">1258</a>                 <em class="jxr_comment">// TODO: Localize</em>
<a class="jxr_linenumber" name="L1259" href="#L1259">1259</a>                 ret.add(<strong class="jxr_keyword">new</strong> SelectItem(String.valueOf(id), authorizedCertificateProfiles.get(id).getName() + <span class="jxr_string">" (default)"</span>));
<a class="jxr_linenumber" name="L1260" href="#L1260">1260</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1261" href="#L1261">1261</a>                 ret.add(<strong class="jxr_keyword">new</strong> SelectItem(String.valueOf(id), authorizedCertificateProfiles.get(id).getName()));
<a class="jxr_linenumber" name="L1262" href="#L1262">1262</a>             }
<a class="jxr_linenumber" name="L1263" href="#L1263">1263</a>         }
<a class="jxr_linenumber" name="L1264" href="#L1264">1264</a>         <strong class="jxr_keyword">if</strong> (ret.size()&gt;1 &amp;&amp; StringUtils.isEmpty(getSelectedCertificateProfile())) {
<a class="jxr_linenumber" name="L1265" href="#L1265">1265</a>             ret.add(<strong class="jxr_keyword">new</strong> SelectItem(<strong class="jxr_keyword">null</strong>, raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_cp_nochoice"</span>), raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_cp_nochoice"</span>), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1266" href="#L1266">1266</a>         }
<a class="jxr_linenumber" name="L1267" href="#L1267">1267</a>         EnrollMakeNewRequestBean.sortSelectItemsByLabel(ret);
<a class="jxr_linenumber" name="L1268" href="#L1268">1268</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1269" href="#L1269">1269</a>     }
<a class="jxr_linenumber" name="L1270" href="#L1270">1270</a> 
<a class="jxr_linenumber" name="L1271" href="#L1271">1271</a>     <em class="jxr_javadoccomment">/** @return the current List of available certificate profile identifiers as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1272" href="#L1272">1272</a>     <strong class="jxr_keyword">private</strong> List&lt;Integer&gt; getAvailableCertificateProfiles() {
<a class="jxr_linenumber" name="L1273" href="#L1273">1273</a>         <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1274" href="#L1274">1274</a>         <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1275" href="#L1275">1275</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1276" href="#L1276">1276</a>             <strong class="jxr_keyword">final</strong> String[] availableCertificateProfileIds = endEntityProfile.getValue(EndEntityProfile.AVAILCERTPROFILES, 0).split(EndEntityProfile.SPLITCHAR);
<a class="jxr_linenumber" name="L1277" href="#L1277">1277</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String availableId : availableCertificateProfileIds) {
<a class="jxr_linenumber" name="L1278" href="#L1278">1278</a>                 <strong class="jxr_keyword">final</strong> Integer id = Integer.parseInt(availableId);
<a class="jxr_linenumber" name="L1279" href="#L1279">1279</a>                 <strong class="jxr_keyword">if</strong> (authorizedCertificateProfiles.containsKey(id)) {
<a class="jxr_linenumber" name="L1280" href="#L1280">1280</a>                     ret.add(id);
<a class="jxr_linenumber" name="L1281" href="#L1281">1281</a>                 }
<a class="jxr_linenumber" name="L1282" href="#L1282">1282</a>             }
<a class="jxr_linenumber" name="L1283" href="#L1283">1283</a>         }
<a class="jxr_linenumber" name="L1284" href="#L1284">1284</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1285" href="#L1285">1285</a>     }
<a class="jxr_linenumber" name="L1286" href="#L1286">1286</a> 
<a class="jxr_linenumber" name="L1287" href="#L1287">1287</a>     <em class="jxr_javadoccomment">/** @return the current List of available CAs as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1288" href="#L1288">1288</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableCertificateAuthoritySelectItems() {
<a class="jxr_linenumber" name="L1289" href="#L1289">1289</a>         <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1290" href="#L1290">1290</a>         <strong class="jxr_keyword">final</strong> String defaultId = getEndEntityProfile().getValue(EndEntityProfile.DEFAULTCA, 0);
<a class="jxr_linenumber" name="L1291" href="#L1291">1291</a>         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> Integer id : getAvailableCertificateAuthorities()) {
<a class="jxr_linenumber" name="L1292" href="#L1292">1292</a>             <strong class="jxr_keyword">if</strong> (defaultId.equals(String.valueOf(id))) {
<a class="jxr_linenumber" name="L1293" href="#L1293">1293</a>                 <em class="jxr_comment">// TODO: Localize</em>
<a class="jxr_linenumber" name="L1294" href="#L1294">1294</a>                 ret.add(<strong class="jxr_keyword">new</strong> SelectItem(String.valueOf(id), authorizedCAInfos.get(id).getName() + <span class="jxr_string">" (default)"</span>));
<a class="jxr_linenumber" name="L1295" href="#L1295">1295</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1296" href="#L1296">1296</a>                 ret.add(<strong class="jxr_keyword">new</strong> SelectItem(String.valueOf(id), authorizedCAInfos.get(id).getName()));
<a class="jxr_linenumber" name="L1297" href="#L1297">1297</a>             }
<a class="jxr_linenumber" name="L1298" href="#L1298">1298</a>         }
<a class="jxr_linenumber" name="L1299" href="#L1299">1299</a>         <strong class="jxr_keyword">if</strong> (ret.size()&gt;1 &amp;&amp; StringUtils.isEmpty(getSelectedCertificateAuthority())) {
<a class="jxr_linenumber" name="L1300" href="#L1300">1300</a>             ret.add(<strong class="jxr_keyword">new</strong> SelectItem(<strong class="jxr_keyword">null</strong>, raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ca_nochoice"</span>), raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ca_nochoice"</span>), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1301" href="#L1301">1301</a>         }
<a class="jxr_linenumber" name="L1302" href="#L1302">1302</a>         EnrollMakeNewRequestBean.sortSelectItemsByLabel(ret);
<a class="jxr_linenumber" name="L1303" href="#L1303">1303</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1304" href="#L1304">1304</a>     }
<a class="jxr_linenumber" name="L1305" href="#L1305">1305</a> 
<a class="jxr_linenumber" name="L1306" href="#L1306">1306</a>     <em class="jxr_javadoccomment">/** @return the current List of available CA identifiers as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1307" href="#L1307">1307</a>     <strong class="jxr_keyword">private</strong> List&lt;Integer&gt; getAvailableCertificateAuthorities() {
<a class="jxr_linenumber" name="L1308" href="#L1308">1308</a>         <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; ret = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1309" href="#L1309">1309</a>         <em class="jxr_comment">// Get all available CAs from the selected EEP</em>
<a class="jxr_linenumber" name="L1310" href="#L1310">1310</a>         <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1311" href="#L1311">1311</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1312" href="#L1312">1312</a>             <strong class="jxr_keyword">final</strong> String[] availableCAsFromEEPArray = endEntityProfile.getValue(EndEntityProfile.AVAILCAS, 0).split(EndEntityProfile.SPLITCHAR);
<a class="jxr_linenumber" name="L1313" href="#L1313">1313</a>             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> anyCAAvailableFromEEP = availableCAsFromEEPArray.length == 1 &amp;&amp; availableCAsFromEEPArray[0].equalsIgnoreCase(String.valueOf(SecConst.ALLCAS));
<a class="jxr_linenumber" name="L1314" href="#L1314">1314</a>             <em class="jxr_comment">// Get all available CAs from the selected CP</em>
<a class="jxr_linenumber" name="L1315" href="#L1315">1315</a>             <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L1316" href="#L1316">1316</a>             <strong class="jxr_keyword">if</strong> (certificateProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1317" href="#L1317">1317</a>                 <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableCAsFromCP = certificateProfile.getAvailableCAs();
<a class="jxr_linenumber" name="L1318" href="#L1318">1318</a>                 <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">boolean</strong> anyCAAvailableFromCP = availableCAsFromCP.size() == 1 &amp;&amp; availableCAsFromCP.iterator().next() == CertificateProfile.ANYCA;
<a class="jxr_linenumber" name="L1319" href="#L1319">1319</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> KeyToValueHolder&lt;CAInfo&gt; tuple : authorizedCAInfos.values()) {
<a class="jxr_linenumber" name="L1320" href="#L1320">1320</a>                     <strong class="jxr_keyword">if</strong> ((anyCAAvailableFromEEP || Arrays.asList(availableCAsFromEEPArray).contains(String.valueOf(tuple.getId())))
<a class="jxr_linenumber" name="L1321" href="#L1321">1321</a>                             &amp;&amp; (anyCAAvailableFromCP || availableCAsFromCP.contains(tuple.getId()))) {
<a class="jxr_linenumber" name="L1322" href="#L1322">1322</a>                         ret.add(tuple.getId());
<a class="jxr_linenumber" name="L1323" href="#L1323">1323</a>                     }
<a class="jxr_linenumber" name="L1324" href="#L1324">1324</a>                 }
<a class="jxr_linenumber" name="L1325" href="#L1325">1325</a>             }
<a class="jxr_linenumber" name="L1326" href="#L1326">1326</a>         }
<a class="jxr_linenumber" name="L1327" href="#L1327">1327</a>         <strong class="jxr_keyword">return</strong> ret;
<a class="jxr_linenumber" name="L1328" href="#L1328">1328</a>     }
<a class="jxr_linenumber" name="L1329" href="#L1329">1329</a> 
<a class="jxr_linenumber" name="L1330" href="#L1330">1330</a>     <em class="jxr_javadoccomment">/** @return the current selectedCertificateProfile as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1331" href="#L1331">1331</a>     <strong class="jxr_keyword">public</strong> String getSelectedCertificateProfile() {
<a class="jxr_linenumber" name="L1332" href="#L1332">1332</a>         <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableCertificateProfiles = getAvailableCertificateProfiles();
<a class="jxr_linenumber" name="L1333" href="#L1333">1333</a>         <strong class="jxr_keyword">if</strong> (availableCertificateProfiles.size()==1) {
<a class="jxr_linenumber" name="L1334" href="#L1334">1334</a>             setSelectedCertificateProfile(String.valueOf(availableCertificateProfiles.get(0)));
<a class="jxr_linenumber" name="L1335" href="#L1335">1335</a>         }
<a class="jxr_linenumber" name="L1336" href="#L1336">1336</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedCertificateProfile)) {
<a class="jxr_linenumber" name="L1337" href="#L1337">1337</a>             <strong class="jxr_keyword">if</strong> (!availableCertificateProfiles.contains(Integer.parseInt(selectedCertificateProfile))) {
<a class="jxr_linenumber" name="L1338" href="#L1338">1338</a>                 setSelectedCertificateProfile(<strong class="jxr_keyword">null</strong>);
<a class="jxr_linenumber" name="L1339" href="#L1339">1339</a>             }
<a class="jxr_linenumber" name="L1340" href="#L1340">1340</a>         }
<a class="jxr_linenumber" name="L1341" href="#L1341">1341</a>         <strong class="jxr_keyword">return</strong> selectedCertificateProfile;
<a class="jxr_linenumber" name="L1342" href="#L1342">1342</a>     }
<a class="jxr_linenumber" name="L1343" href="#L1343">1343</a> 
<a class="jxr_linenumber" name="L1344" href="#L1344">1344</a>     <em class="jxr_javadoccomment">/** @param selectedCertificateProfile the selectedCertificateProfile to set */</em>
<a class="jxr_linenumber" name="L1345" href="#L1345">1345</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedCertificateProfile(<strong class="jxr_keyword">final</strong> String selectedCertificateProfile) {
<a class="jxr_linenumber" name="L1346" href="#L1346">1346</a>         <strong class="jxr_keyword">if</strong> (!StringUtils.equals(selectedCertificateProfile, <strong class="jxr_keyword">this</strong>.selectedCertificateProfile)) {
<a class="jxr_linenumber" name="L1347" href="#L1347">1347</a>             <em class="jxr_comment">// When ever the certificate profile changes this affects the available key algorithms</em>
<a class="jxr_linenumber" name="L1348" href="#L1348">1348</a>             availableAlgorithmSelectItems = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1349" href="#L1349">1349</a>             <em class="jxr_comment">// ...and any uploaded CSR needs to be revalidated (and we can do this by forcing a re-upload)</em>
<a class="jxr_linenumber" name="L1350" href="#L1350">1350</a>             resetAlgorithmCsrUpload();
<a class="jxr_linenumber" name="L1351" href="#L1351">1351</a>         }
<a class="jxr_linenumber" name="L1352" href="#L1352">1352</a>         <strong class="jxr_keyword">this</strong>.selectedCertificateProfile = selectedCertificateProfile;
<a class="jxr_linenumber" name="L1353" href="#L1353">1353</a>     }
<a class="jxr_linenumber" name="L1354" href="#L1354">1354</a> 
<a class="jxr_linenumber" name="L1355" href="#L1355">1355</a>     <em class="jxr_javadoccomment">/** @return the current availableAlgorithms as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1356" href="#L1356">1356</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableAlgorithmSelectItems() {
<a class="jxr_linenumber" name="L1357" href="#L1357">1357</a>         <strong class="jxr_keyword">if</strong> (<strong class="jxr_keyword">this</strong>.availableAlgorithmSelectItems == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1358" href="#L1358">1358</a>             <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; availableAlgorithmSelectItems = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L1359" href="#L1359">1359</a>             <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L1360" href="#L1360">1360</a>             <strong class="jxr_keyword">if</strong> (certificateProfile!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1361" href="#L1361">1361</a>                 <strong class="jxr_keyword">final</strong> List&lt;String&gt; availableKeyAlgorithms = certificateProfile.getAvailableKeyAlgorithmsAsList();
<a class="jxr_linenumber" name="L1362" href="#L1362">1362</a>                 <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableBitLengths = certificateProfile.getAvailableBitLengthsAsList();
<a class="jxr_linenumber" name="L1363" href="#L1363">1363</a>                 <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_DSA)) {
<a class="jxr_linenumber" name="L1364" href="#L1364">1364</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> availableBitLength : availableBitLengths) {
<a class="jxr_linenumber" name="L1365" href="#L1365">1365</a>                         <strong class="jxr_keyword">if</strong> (availableBitLength == 1024) {
<a class="jxr_linenumber" name="L1366" href="#L1366">1366</a>                             availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_DSA + <span class="jxr_string">"_"</span> + availableBitLength,
<a class="jxr_linenumber" name="L1367" href="#L1367">1367</a>                                     AlgorithmConstants.KEYALGORITHM_DSA + <span class="jxr_string">" "</span> + availableBitLength + <span class="jxr_string">" bits"</span>));
<a class="jxr_linenumber" name="L1368" href="#L1368">1368</a>                         }
<a class="jxr_linenumber" name="L1369" href="#L1369">1369</a>                     }
<a class="jxr_linenumber" name="L1370" href="#L1370">1370</a>                 }
<a class="jxr_linenumber" name="L1371" href="#L1371">1371</a>                 <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_RSA)) {
<a class="jxr_linenumber" name="L1372" href="#L1372">1372</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> availableBitLength : availableBitLengths) {
<a class="jxr_linenumber" name="L1373" href="#L1373">1373</a>                         <strong class="jxr_keyword">if</strong> (availableBitLength &gt;= 1024) {
<a class="jxr_linenumber" name="L1374" href="#L1374">1374</a>                             availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_RSA + <span class="jxr_string">"_"</span> + availableBitLength,
<a class="jxr_linenumber" name="L1375" href="#L1375">1375</a>                                     AlgorithmConstants.KEYALGORITHM_RSA + <span class="jxr_string">" "</span> + availableBitLength + <span class="jxr_string">" bits"</span>));
<a class="jxr_linenumber" name="L1376" href="#L1376">1376</a>                         }
<a class="jxr_linenumber" name="L1377" href="#L1377">1377</a>                     }
<a class="jxr_linenumber" name="L1378" href="#L1378">1378</a>                 }
<a class="jxr_linenumber" name="L1379" href="#L1379">1379</a>                 <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_ECDSA)) {
<a class="jxr_linenumber" name="L1380" href="#L1380">1380</a>                     <strong class="jxr_keyword">final</strong> Set&lt;String&gt; ecChoices = <strong class="jxr_keyword">new</strong> HashSet&lt;&gt;();
<a class="jxr_linenumber" name="L1381" href="#L1381">1381</a>                     <strong class="jxr_keyword">if</strong> (certificateProfile.getAvailableEcCurvesAsList().contains(CertificateProfile.ANY_EC_CURVE)) {
<a class="jxr_linenumber" name="L1382" href="#L1382">1382</a>                         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String ecNamedCurve : AlgorithmTools.getNamedEcCurvesMap(false).keySet()) {
<a class="jxr_linenumber" name="L1383" href="#L1383">1383</a>                             <strong class="jxr_keyword">if</strong> (CertificateProfile.ANY_EC_CURVE.equals(ecNamedCurve)) {
<a class="jxr_linenumber" name="L1384" href="#L1384">1384</a>                                 <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1385" href="#L1385">1385</a>                             }
<a class="jxr_linenumber" name="L1386" href="#L1386">1386</a>                             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> bitLength = AlgorithmTools.getNamedEcCurveBitLength(ecNamedCurve);
<a class="jxr_linenumber" name="L1387" href="#L1387">1387</a>                             <strong class="jxr_keyword">if</strong> (availableBitLengths.contains(Integer.valueOf(bitLength))) {
<a class="jxr_linenumber" name="L1388" href="#L1388">1388</a>                                 ecChoices.add(ecNamedCurve);
<a class="jxr_linenumber" name="L1389" href="#L1389">1389</a>                             }
<a class="jxr_linenumber" name="L1390" href="#L1390">1390</a>                         }
<a class="jxr_linenumber" name="L1391" href="#L1391">1391</a>                     }
<a class="jxr_linenumber" name="L1392" href="#L1392">1392</a>                     ecChoices.addAll(certificateProfile.getAvailableEcCurvesAsList());
<a class="jxr_linenumber" name="L1393" href="#L1393">1393</a>                     ecChoices.remove(CertificateProfile.ANY_EC_CURVE);
<a class="jxr_linenumber" name="L1394" href="#L1394">1394</a>                     <strong class="jxr_keyword">final</strong> List&lt;String&gt; ecChoicesList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;(ecChoices);
<a class="jxr_linenumber" name="L1395" href="#L1395">1395</a>                     Collections.sort(ecChoicesList);
<a class="jxr_linenumber" name="L1396" href="#L1396">1396</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String ecNamedCurve : ecChoicesList) {
<a class="jxr_linenumber" name="L1397" href="#L1397">1397</a>                         <strong class="jxr_keyword">if</strong> (!AlgorithmTools.isKnownAlias(ecNamedCurve)) {
<a class="jxr_linenumber" name="L1398" href="#L1398">1398</a>                             log.warn(<span class="jxr_string">"Ignoring unknown curve "</span> + ecNamedCurve + <span class="jxr_string">" from being displayed in the RA web."</span>);
<a class="jxr_linenumber" name="L1399" href="#L1399">1399</a>                             <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L1400" href="#L1400">1400</a>                         }
<a class="jxr_linenumber" name="L1401" href="#L1401">1401</a>                         availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_ECDSA + <span class="jxr_string">"_"</span> + ecNamedCurve, AlgorithmConstants.KEYALGORITHM_ECDSA + <span class="jxr_string">" "</span>
<a class="jxr_linenumber" name="L1402" href="#L1402">1402</a>                                         + StringTools.getAsStringWithSeparator(<span class="jxr_string">" / "</span>, AlgorithmTools.getAllCurveAliasesFromAlias(ecNamedCurve))));
<a class="jxr_linenumber" name="L1403" href="#L1403">1403</a>                     }
<a class="jxr_linenumber" name="L1404" href="#L1404">1404</a>                 }
<a class="jxr_linenumber" name="L1405" href="#L1405">1405</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String algName : CesecoreConfiguration.getExtraAlgs()) {
<a class="jxr_linenumber" name="L1406" href="#L1406">1406</a>                     <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(CesecoreConfiguration.getExtraAlgTitle(algName))) {
<a class="jxr_linenumber" name="L1407" href="#L1407">1407</a>                         <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String subAlg : CesecoreConfiguration.getExtraAlgSubAlgs(algName)) {
<a class="jxr_linenumber" name="L1408" href="#L1408">1408</a>                             <strong class="jxr_keyword">final</strong> String name = CesecoreConfiguration.getExtraAlgSubAlgName(algName, subAlg);
<a class="jxr_linenumber" name="L1409" href="#L1409">1409</a>                             <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> bitLength = AlgorithmTools.getNamedEcCurveBitLength(name);
<a class="jxr_linenumber" name="L1410" href="#L1410">1410</a>                             <strong class="jxr_keyword">if</strong> (availableBitLengths.contains(Integer.valueOf(bitLength))) {
<a class="jxr_linenumber" name="L1411" href="#L1411">1411</a>                                 availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(CesecoreConfiguration.getExtraAlgTitle(algName) + <span class="jxr_string">"_"</span> + name,
<a class="jxr_linenumber" name="L1412" href="#L1412">1412</a>                                         CesecoreConfiguration.getExtraAlgSubAlgTitle(algName, subAlg)));
<a class="jxr_linenumber" name="L1413" href="#L1413">1413</a>                             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L1414" href="#L1414">1414</a>                                 <strong class="jxr_keyword">if</strong> (log.isTraceEnabled()) {
<a class="jxr_linenumber" name="L1415" href="#L1415">1415</a>                                     log.trace(<span class="jxr_string">"Excluding "</span> + name + <span class="jxr_string">" from enrollment options since bit length "</span> + bitLength + <span class="jxr_string">" is not available."</span>);
<a class="jxr_linenumber" name="L1416" href="#L1416">1416</a>                                 }
<a class="jxr_linenumber" name="L1417" href="#L1417">1417</a>                             }
<a class="jxr_linenumber" name="L1418" href="#L1418">1418</a>                         }
<a class="jxr_linenumber" name="L1419" href="#L1419">1419</a>                     }
<a class="jxr_linenumber" name="L1420" href="#L1420">1420</a>                 }
<a class="jxr_linenumber" name="L1421" href="#L1421">1421</a>                 <strong class="jxr_keyword">if</strong> (availableAlgorithmSelectItems.size()&gt;1 &amp;&amp; StringUtils.isEmpty(getSelectedAlgorithm(availableAlgorithmSelectItems))) {
<a class="jxr_linenumber" name="L1422" href="#L1422">1422</a>                     availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(<strong class="jxr_keyword">null</strong>, raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ka_nochoice"</span>), raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ka_nochoice"</span>), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L1423" href="#L1423">1423</a>                 }
<a class="jxr_linenumber" name="L1424" href="#L1424">1424</a>             }
<a class="jxr_linenumber" name="L1425" href="#L1425">1425</a>             EnrollMakeNewRequestBean.sortSelectItemsByLabel(availableAlgorithmSelectItems);
<a class="jxr_linenumber" name="L1426" href="#L1426">1426</a>             <strong class="jxr_keyword">this</strong>.availableAlgorithmSelectItems = availableAlgorithmSelectItems;
<a class="jxr_linenumber" name="L1427" href="#L1427">1427</a>         }
<a class="jxr_linenumber" name="L1428" href="#L1428">1428</a>         <strong class="jxr_keyword">return</strong> availableAlgorithmSelectItems;
<a class="jxr_linenumber" name="L1429" href="#L1429">1429</a>     }
<a class="jxr_linenumber" name="L1430" href="#L1430">1430</a> 
<a class="jxr_linenumber" name="L1431" href="#L1431">1431</a>     <em class="jxr_javadoccomment">/** Sort the provided list by label with the exception of any item with null value that ends up first. </em>
<a class="jxr_linenumber" name="L1432" href="#L1432">1432</a> <em class="jxr_javadoccomment">     * @param items Items*/</em>
<a class="jxr_linenumber" name="L1433" href="#L1433">1433</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">void</strong> sortSelectItemsByLabel(<strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; items) {
<a class="jxr_linenumber" name="L1434" href="#L1434">1434</a>         Collections.sort(items, <strong class="jxr_keyword">new</strong> Comparator&lt;SelectItem&gt;() {
<a class="jxr_linenumber" name="L1435" href="#L1435">1435</a>             @Override
<a class="jxr_linenumber" name="L1436" href="#L1436">1436</a>             <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> compare(<strong class="jxr_keyword">final</strong> SelectItem item1, <strong class="jxr_keyword">final</strong> SelectItem item2) {
<a class="jxr_linenumber" name="L1437" href="#L1437">1437</a>                 <strong class="jxr_keyword">if</strong> (item1.getValue()==<strong class="jxr_keyword">null</strong> || (item1.getValue() instanceof String &amp;&amp; ((String)item1.getValue()).isEmpty())) {
<a class="jxr_linenumber" name="L1438" href="#L1438">1438</a>                     <strong class="jxr_keyword">return</strong> Integer.MIN_VALUE;
<a class="jxr_linenumber" name="L1439" href="#L1439">1439</a>                 } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (item2.getValue()==<strong class="jxr_keyword">null</strong> || (item2.getValue() instanceof String &amp;&amp; ((String)item2.getValue()).isEmpty())) {
<a class="jxr_linenumber" name="L1440" href="#L1440">1440</a>                     <strong class="jxr_keyword">return</strong> Integer.MAX_VALUE;
<a class="jxr_linenumber" name="L1441" href="#L1441">1441</a>                 }
<a class="jxr_linenumber" name="L1442" href="#L1442">1442</a>                 <strong class="jxr_keyword">if</strong> (item1.getLabel()==<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1443" href="#L1443">1443</a>                     <strong class="jxr_keyword">return</strong> Integer.MIN_VALUE;
<a class="jxr_linenumber" name="L1444" href="#L1444">1444</a>                 }
<a class="jxr_linenumber" name="L1445" href="#L1445">1445</a>                 <strong class="jxr_keyword">return</strong> item1.getLabel().compareTo(item2.getLabel());
<a class="jxr_linenumber" name="L1446" href="#L1446">1446</a>             }
<a class="jxr_linenumber" name="L1447" href="#L1447">1447</a>         });
<a class="jxr_linenumber" name="L1448" href="#L1448">1448</a>     }
<a class="jxr_linenumber" name="L1449" href="#L1449">1449</a> 
<a class="jxr_linenumber" name="L1450" href="#L1450">1450</a>     <em class="jxr_javadoccomment">/** @return the current selectedAlgorithm as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1451" href="#L1451">1451</a>     <strong class="jxr_keyword">public</strong> String getSelectedAlgorithm() {
<a class="jxr_linenumber" name="L1452" href="#L1452">1452</a>         <strong class="jxr_keyword">return</strong> getSelectedAlgorithm(getAvailableAlgorithmSelectItems());
<a class="jxr_linenumber" name="L1453" href="#L1453">1453</a>     }
<a class="jxr_linenumber" name="L1454" href="#L1454">1454</a> 
<a class="jxr_linenumber" name="L1455" href="#L1455">1455</a>     <em class="jxr_javadoccomment">/** @param availableAlgorithmSelectItems Items</em>
<a class="jxr_linenumber" name="L1456" href="#L1456">1456</a> <em class="jxr_javadoccomment">     * @return the current selectedAlgorithm as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1457" href="#L1457">1457</a>     <strong class="jxr_keyword">private</strong> String getSelectedAlgorithm(<strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; availableAlgorithmSelectItems) {
<a class="jxr_linenumber" name="L1458" href="#L1458">1458</a>         <strong class="jxr_keyword">if</strong> (availableAlgorithmSelectItems.size()==1) {
<a class="jxr_linenumber" name="L1459" href="#L1459">1459</a>             selectedAlgorithm = String.valueOf(availableAlgorithmSelectItems.get(0).getValue());
<a class="jxr_linenumber" name="L1460" href="#L1460">1460</a>         }
<a class="jxr_linenumber" name="L1461" href="#L1461">1461</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedAlgorithm)) {
<a class="jxr_linenumber" name="L1462" href="#L1462">1462</a>             <strong class="jxr_keyword">boolean</strong> found = false;
<a class="jxr_linenumber" name="L1463" href="#L1463">1463</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> SelectItem selectItem : availableAlgorithmSelectItems) {
<a class="jxr_linenumber" name="L1464" href="#L1464">1464</a>                 <strong class="jxr_keyword">if</strong> (selectedAlgorithm.equals(selectItem.getValue())) {
<a class="jxr_linenumber" name="L1465" href="#L1465">1465</a>                     found = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1466" href="#L1466">1466</a>                     <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L1467" href="#L1467">1467</a>                 }
<a class="jxr_linenumber" name="L1468" href="#L1468">1468</a>             }
<a class="jxr_linenumber" name="L1469" href="#L1469">1469</a>             <strong class="jxr_keyword">if</strong> (!found) {
<a class="jxr_linenumber" name="L1470" href="#L1470">1470</a>                 selectedAlgorithm = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1471" href="#L1471">1471</a>             }
<a class="jxr_linenumber" name="L1472" href="#L1472">1472</a>         }
<a class="jxr_linenumber" name="L1473" href="#L1473">1473</a>         <strong class="jxr_keyword">return</strong> selectedAlgorithm;
<a class="jxr_linenumber" name="L1474" href="#L1474">1474</a>     }
<a class="jxr_linenumber" name="L1475" href="#L1475">1475</a> 
<a class="jxr_linenumber" name="L1476" href="#L1476">1476</a>     <em class="jxr_javadoccomment">/** @param selectedAlgorithm the selectedAlgorithm to set */</em>
<a class="jxr_linenumber" name="L1477" href="#L1477">1477</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedAlgorithm(<strong class="jxr_keyword">final</strong> String selectedAlgorithm) {
<a class="jxr_linenumber" name="L1478" href="#L1478">1478</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedAlgorithm)) {
<a class="jxr_linenumber" name="L1479" href="#L1479">1479</a>             <strong class="jxr_keyword">this</strong>.selectedAlgorithm = selectedAlgorithm;
<a class="jxr_linenumber" name="L1480" href="#L1480">1480</a>         }
<a class="jxr_linenumber" name="L1481" href="#L1481">1481</a>     }
<a class="jxr_linenumber" name="L1482" href="#L1482">1482</a> 
<a class="jxr_linenumber" name="L1483" href="#L1483">1483</a>     <em class="jxr_javadoccomment">/** @return the endEntityInformation */</em>
<a class="jxr_linenumber" name="L1484" href="#L1484">1484</a>     <strong class="jxr_keyword">public</strong> EndEntityInformation getEndEntityInformation() {
<a class="jxr_linenumber" name="L1485" href="#L1485">1485</a>         <strong class="jxr_keyword">if</strong> (endEntityInformation==<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1486" href="#L1486">1486</a>             endEntityInformation = <strong class="jxr_keyword">new</strong> EndEntityInformation();
<a class="jxr_linenumber" name="L1487" href="#L1487">1487</a>         }
<a class="jxr_linenumber" name="L1488" href="#L1488">1488</a>         <strong class="jxr_keyword">return</strong> endEntityInformation;
<a class="jxr_linenumber" name="L1489" href="#L1489">1489</a>     }
<a class="jxr_linenumber" name="L1490" href="#L1490">1490</a> 
<a class="jxr_linenumber" name="L1491" href="#L1491">1491</a>     <em class="jxr_javadoccomment">/** @param endEntityInformation the endEntityInformation to set */</em>
<a class="jxr_linenumber" name="L1492" href="#L1492">1492</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setEndEntityInformation(EndEntityInformation endEntityInformation) {
<a class="jxr_linenumber" name="L1493" href="#L1493">1493</a>         <strong class="jxr_keyword">this</strong>.endEntityInformation = endEntityInformation;
<a class="jxr_linenumber" name="L1494" href="#L1494">1494</a>     }
<a class="jxr_linenumber" name="L1495" href="#L1495">1495</a> 
<a class="jxr_linenumber" name="L1496" href="#L1496">1496</a>     <em class="jxr_javadoccomment">/** @return the confirmPassword */</em>
<a class="jxr_linenumber" name="L1497" href="#L1497">1497</a>     <strong class="jxr_keyword">public</strong> String getConfirmPassword() {
<a class="jxr_linenumber" name="L1498" href="#L1498">1498</a>         <strong class="jxr_keyword">return</strong> confirmPassword;
<a class="jxr_linenumber" name="L1499" href="#L1499">1499</a>     }
<a class="jxr_linenumber" name="L1500" href="#L1500">1500</a> 
<a class="jxr_linenumber" name="L1501" href="#L1501">1501</a>     <em class="jxr_javadoccomment">/** @param confirmPassword the confirmPassword to set */</em>
<a class="jxr_linenumber" name="L1502" href="#L1502">1502</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setConfirmPassword(String confirmPassword) {
<a class="jxr_linenumber" name="L1503" href="#L1503">1503</a>         <strong class="jxr_keyword">this</strong>.confirmPassword = confirmPassword;
<a class="jxr_linenumber" name="L1504" href="#L1504">1504</a>     }
<a class="jxr_linenumber" name="L1505" href="#L1505">1505</a> 
<a class="jxr_linenumber" name="L1506" href="#L1506">1506</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRequestPreviewMoreDetails() {
<a class="jxr_linenumber" name="L1507" href="#L1507">1507</a>         <strong class="jxr_keyword">return</strong> requestPreviewMoreDetails;
<a class="jxr_linenumber" name="L1508" href="#L1508">1508</a>     }
<a class="jxr_linenumber" name="L1509" href="#L1509">1509</a> 
<a class="jxr_linenumber" name="L1510" href="#L1510">1510</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSetCustomValidity() {
<a class="jxr_linenumber" name="L1511" href="#L1511">1511</a>         <strong class="jxr_keyword">return</strong> setCustomValidity;
<a class="jxr_linenumber" name="L1512" href="#L1512">1512</a>     }
<a class="jxr_linenumber" name="L1513" href="#L1513">1513</a> 
<a class="jxr_linenumber" name="L1514" href="#L1514">1514</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRequestPreviewMoreDetails(<strong class="jxr_keyword">boolean</strong> requestPreviewMoreDetails) {
<a class="jxr_linenumber" name="L1515" href="#L1515">1515</a>         <strong class="jxr_keyword">this</strong>.requestPreviewMoreDetails = requestPreviewMoreDetails;
<a class="jxr_linenumber" name="L1516" href="#L1516">1516</a>     }
<a class="jxr_linenumber" name="L1517" href="#L1517">1517</a> 
<a class="jxr_linenumber" name="L1518" href="#L1518">1518</a>     <em class="jxr_javadoccomment">/** @return the current selectedCertificateAuthority as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1519" href="#L1519">1519</a>     <strong class="jxr_keyword">public</strong> String getSelectedCertificateAuthority() {
<a class="jxr_linenumber" name="L1520" href="#L1520">1520</a>         <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableCertificateAuthorities = getAvailableCertificateAuthorities();
<a class="jxr_linenumber" name="L1521" href="#L1521">1521</a>         <strong class="jxr_keyword">if</strong> (availableCertificateAuthorities.size()==1) {
<a class="jxr_linenumber" name="L1522" href="#L1522">1522</a>             selectedCertificateAuthority = String.valueOf(availableCertificateAuthorities.get(0));
<a class="jxr_linenumber" name="L1523" href="#L1523">1523</a>         }
<a class="jxr_linenumber" name="L1524" href="#L1524">1524</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedCertificateAuthority)) {
<a class="jxr_linenumber" name="L1525" href="#L1525">1525</a>             <strong class="jxr_keyword">if</strong> (!availableCertificateAuthorities.contains(Integer.parseInt(selectedCertificateAuthority))) {
<a class="jxr_linenumber" name="L1526" href="#L1526">1526</a>                 selectedCertificateAuthority = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1527" href="#L1527">1527</a>             }
<a class="jxr_linenumber" name="L1528" href="#L1528">1528</a>         }
<a class="jxr_linenumber" name="L1529" href="#L1529">1529</a>         <strong class="jxr_keyword">return</strong> selectedCertificateAuthority;
<a class="jxr_linenumber" name="L1530" href="#L1530">1530</a>     }
<a class="jxr_linenumber" name="L1531" href="#L1531">1531</a> 
<a class="jxr_linenumber" name="L1532" href="#L1532">1532</a>     <em class="jxr_javadoccomment">/** @param selectedCertificateAuthority the selectedCertificateAuthority to set */</em>
<a class="jxr_linenumber" name="L1533" href="#L1533">1533</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedCertificateAuthority(String selectedCertificateAuthority) {
<a class="jxr_linenumber" name="L1534" href="#L1534">1534</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isNotEmpty(selectedCertificateAuthority)) {
<a class="jxr_linenumber" name="L1535" href="#L1535">1535</a>             <strong class="jxr_keyword">this</strong>.selectedCertificateAuthority = selectedCertificateAuthority;
<a class="jxr_linenumber" name="L1536" href="#L1536">1536</a>         }
<a class="jxr_linenumber" name="L1537" href="#L1537">1537</a>     }
<a class="jxr_linenumber" name="L1538" href="#L1538">1538</a> 
<a class="jxr_linenumber" name="L1539" href="#L1539">1539</a>     <em class="jxr_javadoccomment">/** @return the cached authorized certificate profiles */</em>
<a class="jxr_linenumber" name="L1540" href="#L1540">1540</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;CertificateProfile&gt; getAuthorizedCertificateProfiles() {
<a class="jxr_linenumber" name="L1541" href="#L1541">1541</a>         <strong class="jxr_keyword">return</strong> authorizedCertificateProfiles;
<a class="jxr_linenumber" name="L1542" href="#L1542">1542</a>     }
<a class="jxr_linenumber" name="L1543" href="#L1543">1543</a> 
<a class="jxr_linenumber" name="L1544" href="#L1544">1544</a>     <em class="jxr_javadoccomment">/** @return the if there is at least one field in subject dn that should be rendered as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1545" href="#L1545">1545</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSubjectDnRendered() {
<a class="jxr_linenumber" name="L1546" href="#L1546">1546</a>         <strong class="jxr_keyword">if</strong> (getSubjectDn()!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1547" href="#L1547">1547</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> FieldInstance fieldInstance : getSubjectDn().getFieldInstances()) {
<a class="jxr_linenumber" name="L1548" href="#L1548">1548</a>                 <strong class="jxr_keyword">if</strong> (isFieldInstanceRendered(fieldInstance)) {
<a class="jxr_linenumber" name="L1549" href="#L1549">1549</a>                     <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1550" href="#L1550">1550</a>                 }
<a class="jxr_linenumber" name="L1551" href="#L1551">1551</a>             }
<a class="jxr_linenumber" name="L1552" href="#L1552">1552</a>         }
<a class="jxr_linenumber" name="L1553" href="#L1553">1553</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L1554" href="#L1554">1554</a>     }
<a class="jxr_linenumber" name="L1555" href="#L1555">1555</a> 
<a class="jxr_linenumber" name="L1556" href="#L1556">1556</a>     <em class="jxr_javadoccomment">/** @return the current Subject DN as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1557" href="#L1557">1557</a>     <strong class="jxr_keyword">public</strong> <a name="SubjectDn" href="../../../org/ejbca/ra/SubjectDn.html#SubjectDn">SubjectDn</a> getSubjectDn() {
<a class="jxr_linenumber" name="L1558" href="#L1558">1558</a>         <strong class="jxr_keyword">if</strong> (subjectDn == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1559" href="#L1559">1559</a>             <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1560" href="#L1560">1560</a>             <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L1561" href="#L1561">1561</a>             <strong class="jxr_keyword">final</strong> X509CAInfo x509cainfo = (X509CAInfo) getCAInfo();
<a class="jxr_linenumber" name="L1562" href="#L1562">1562</a>             <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong> &amp;&amp; certificateProfile != <strong class="jxr_keyword">null</strong> &amp;&amp; x509cainfo != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1563" href="#L1563">1563</a>                 subjectDn = <strong class="jxr_keyword">new</strong> <a name="SubjectDn" href="../../../org/ejbca/ra/SubjectDn.html#SubjectDn">SubjectDn</a>(endEntityProfile);
<a class="jxr_linenumber" name="L1564" href="#L1564">1564</a>                 subjectDn.setLdapOrder(x509cainfo.getUseLdapDnOrder() &amp;&amp; certificateProfile.getUseLdapDnOrder());
<a class="jxr_linenumber" name="L1565" href="#L1565">1565</a>                 subjectDn.setNameStyle(x509cainfo.getUsePrintableStringSubjectDN() ? PrintableStringNameStyle.INSTANCE : CeSecoreNameStyle.INSTANCE);
<a class="jxr_linenumber" name="L1566" href="#L1566">1566</a>             }
<a class="jxr_linenumber" name="L1567" href="#L1567">1567</a>         }
<a class="jxr_linenumber" name="L1568" href="#L1568">1568</a>         <strong class="jxr_keyword">return</strong> subjectDn;
<a class="jxr_linenumber" name="L1569" href="#L1569">1569</a>     }
<a class="jxr_linenumber" name="L1570" href="#L1570">1570</a> 
<a class="jxr_linenumber" name="L1571" href="#L1571">1571</a>     <em class="jxr_javadoccomment">/** @return the if there is at least one field in subjectAlternativeName that should be rendered as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1572" href="#L1572">1572</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSubjectAlternativeNameRendered() {
<a class="jxr_linenumber" name="L1573" href="#L1573">1573</a>         <strong class="jxr_keyword">if</strong> (getSubjectAlternativeName()!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1574" href="#L1574">1574</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> FieldInstance fieldInstance : getSubjectAlternativeName().getFieldInstances()) {
<a class="jxr_linenumber" name="L1575" href="#L1575">1575</a>                 <strong class="jxr_keyword">if</strong> (isFieldInstanceRendered(fieldInstance)) {
<a class="jxr_linenumber" name="L1576" href="#L1576">1576</a>                     <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1577" href="#L1577">1577</a>                 }
<a class="jxr_linenumber" name="L1578" href="#L1578">1578</a>             }
<a class="jxr_linenumber" name="L1579" href="#L1579">1579</a>         }
<a class="jxr_linenumber" name="L1580" href="#L1580">1580</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L1581" href="#L1581">1581</a>     }
<a class="jxr_linenumber" name="L1582" href="#L1582">1582</a> 
<a class="jxr_linenumber" name="L1583" href="#L1583">1583</a>     <em class="jxr_javadoccomment">/** @return the current Subject Alternative Name as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1584" href="#L1584">1584</a>     <strong class="jxr_keyword">public</strong> <a name="SubjectAlternativeName" href="../../../org/ejbca/ra/SubjectAlternativeName.html#SubjectAlternativeName">SubjectAlternativeName</a> getSubjectAlternativeName() {
<a class="jxr_linenumber" name="L1585" href="#L1585">1585</a>         <strong class="jxr_keyword">if</strong> (subjectAlternativeName == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1586" href="#L1586">1586</a>             <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1587" href="#L1587">1587</a>             <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1588" href="#L1588">1588</a>                 subjectAlternativeName = <strong class="jxr_keyword">new</strong> <a name="SubjectAlternativeName" href="../../../org/ejbca/ra/SubjectAlternativeName.html#SubjectAlternativeName">SubjectAlternativeName</a>(endEntityProfile);
<a class="jxr_linenumber" name="L1589" href="#L1589">1589</a>             }
<a class="jxr_linenumber" name="L1590" href="#L1590">1590</a>         }
<a class="jxr_linenumber" name="L1591" href="#L1591">1591</a>         <strong class="jxr_keyword">return</strong> subjectAlternativeName;
<a class="jxr_linenumber" name="L1592" href="#L1592">1592</a>     }
<a class="jxr_linenumber" name="L1593" href="#L1593">1593</a> 
<a class="jxr_linenumber" name="L1594" href="#L1594">1594</a>     <em class="jxr_javadoccomment">/** @return the if there is at least one field in subject directory attributes that should be rendered */</em>
<a class="jxr_linenumber" name="L1595" href="#L1595">1595</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isSubjectDirectoryAttributesRendered() {
<a class="jxr_linenumber" name="L1596" href="#L1596">1596</a> <em class="jxr_comment">//        if (getSubjectDirectoryAttributes()!=null) {</em>
<a class="jxr_linenumber" name="L1597" href="#L1597">1597</a> <em class="jxr_comment">//            for (final FieldInstance fieldInstance : getSubjectDirectoryAttributes().getFieldInstances()) {</em>
<a class="jxr_linenumber" name="L1598" href="#L1598">1598</a> <em class="jxr_comment">//                if (isFieldInstanceRendered(fieldInstance)) {</em>
<a class="jxr_linenumber" name="L1599" href="#L1599">1599</a> <em class="jxr_comment">//                    return true;</em>
<a class="jxr_linenumber" name="L1600" href="#L1600">1600</a> <em class="jxr_comment">//                }</em>
<a class="jxr_linenumber" name="L1601" href="#L1601">1601</a> <em class="jxr_comment">//            }</em>
<a class="jxr_linenumber" name="L1602" href="#L1602">1602</a> <em class="jxr_comment">//        }</em>
<a class="jxr_linenumber" name="L1603" href="#L1603">1603</a>         <em class="jxr_comment">//Commented out since Subject Directory Attributes are not supported atm.</em>
<a class="jxr_linenumber" name="L1604" href="#L1604">1604</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L1605" href="#L1605">1605</a>     }
<a class="jxr_linenumber" name="L1606" href="#L1606">1606</a> 
<a class="jxr_linenumber" name="L1607" href="#L1607">1607</a>     <em class="jxr_javadoccomment">/** @return the current Subject Directory Attributes as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1608" href="#L1608">1608</a>     <strong class="jxr_keyword">public</strong> <a name="SubjectDirectoryAttributes" href="../../../org/ejbca/ra/SubjectDirectoryAttributes.html#SubjectDirectoryAttributes">SubjectDirectoryAttributes</a> getSubjectDirectoryAttributes() {
<a class="jxr_linenumber" name="L1609" href="#L1609">1609</a>         <strong class="jxr_keyword">if</strong> (subjectDirectoryAttributes == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1610" href="#L1610">1610</a>             <strong class="jxr_keyword">final</strong> EndEntityProfile endEntityProfile = getEndEntityProfile();
<a class="jxr_linenumber" name="L1611" href="#L1611">1611</a>             <strong class="jxr_keyword">if</strong> (endEntityProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1612" href="#L1612">1612</a>                 subjectDirectoryAttributes = <strong class="jxr_keyword">new</strong> <a name="SubjectDirectoryAttributes" href="../../../org/ejbca/ra/SubjectDirectoryAttributes.html#SubjectDirectoryAttributes">SubjectDirectoryAttributes</a>(endEntityProfile);
<a class="jxr_linenumber" name="L1613" href="#L1613">1613</a>             }
<a class="jxr_linenumber" name="L1614" href="#L1614">1614</a>         }
<a class="jxr_linenumber" name="L1615" href="#L1615">1615</a>         <strong class="jxr_keyword">return</strong> subjectDirectoryAttributes;
<a class="jxr_linenumber" name="L1616" href="#L1616">1616</a>     }
<a class="jxr_linenumber" name="L1617" href="#L1617">1617</a> 
<a class="jxr_linenumber" name="L1618" href="#L1618">1618</a>     <em class="jxr_javadoccomment">/** @param fieldInstance Instance</em>
<a class="jxr_linenumber" name="L1619" href="#L1619">1619</a> <em class="jxr_javadoccomment">     * @return true if the field instance should be rendered */</em>
<a class="jxr_linenumber" name="L1620" href="#L1620">1620</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isFieldInstanceRendered(<strong class="jxr_keyword">final</strong> FieldInstance fieldInstance) {
<a class="jxr_linenumber" name="L1621" href="#L1621">1621</a>         <strong class="jxr_keyword">if</strong> (log.isTraceEnabled()) {
<a class="jxr_linenumber" name="L1622" href="#L1622">1622</a>             log.trace(<span class="jxr_string">"isFieldInstanceRendered name="</span> + fieldInstance.getName() + <span class="jxr_string">" used="</span> +fieldInstance.isUsed() + <span class="jxr_string">" selectable="</span> + fieldInstance.isSelectable() +
<a class="jxr_linenumber" name="L1623" href="#L1623">1623</a>                     <span class="jxr_string">" modifiable="</span> + fieldInstance.isModifiable() + <span class="jxr_string">" selectableValues.size="</span> + (fieldInstance.getSelectableValues()==<strong class="jxr_keyword">null</strong>?0:fieldInstance.getSelectableValues().size()));
<a class="jxr_linenumber" name="L1624" href="#L1624">1624</a>         }
<a class="jxr_linenumber" name="L1625" href="#L1625">1625</a>         <em class="jxr_comment">// For the email fields "used" means use EE email address</em>
<a class="jxr_linenumber" name="L1626" href="#L1626">1626</a>         <strong class="jxr_keyword">if</strong> (fieldInstance.isUsed() || DnComponents.DNEMAILADDRESS.equals(fieldInstance.getName()) || DnComponents.RFC822NAME.equals(fieldInstance.getName())) {
<a class="jxr_linenumber" name="L1627" href="#L1627">1627</a>             <strong class="jxr_keyword">if</strong> (isRenderNonModifiableFields()) {
<a class="jxr_linenumber" name="L1628" href="#L1628">1628</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1629" href="#L1629">1629</a>             }
<a class="jxr_linenumber" name="L1630" href="#L1630">1630</a>             <strong class="jxr_keyword">if</strong> ((!fieldInstance.isSelectable() &amp;&amp; fieldInstance.isModifiable()) || (fieldInstance.isSelectable() &amp;&amp; fieldInstance.getSelectableValues().size() &gt; 1)
<a class="jxr_linenumber" name="L1631" href="#L1631">1631</a>                     || (!fieldInstance.isModifiable() &amp;&amp; (fieldInstance.getName().equals(<span class="jxr_string">"RFC822NAME"</span>) || fieldInstance.getName().equals(<span class="jxr_string">"UPN"</span>)))) {
<a class="jxr_linenumber" name="L1632" href="#L1632">1632</a>                 <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L1633" href="#L1633">1633</a>             }
<a class="jxr_linenumber" name="L1634" href="#L1634">1634</a>         }
<a class="jxr_linenumber" name="L1635" href="#L1635">1635</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L1636" href="#L1636">1636</a>     }
<a class="jxr_linenumber" name="L1637" href="#L1637">1637</a> 
<a class="jxr_linenumber" name="L1638" href="#L1638">1638</a>     <strong class="jxr_keyword">public</strong> UploadedFile getUploadFile() {
<a class="jxr_linenumber" name="L1639" href="#L1639">1639</a>         <strong class="jxr_keyword">return</strong> uploadFile;
<a class="jxr_linenumber" name="L1640" href="#L1640">1640</a>     }
<a class="jxr_linenumber" name="L1641" href="#L1641">1641</a> 
<a class="jxr_linenumber" name="L1642" href="#L1642">1642</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setUploadFile(UploadedFile uploadFile) {
<a class="jxr_linenumber" name="L1643" href="#L1643">1643</a>         <strong class="jxr_keyword">this</strong>.uploadFile = uploadFile;
<a class="jxr_linenumber" name="L1644" href="#L1644">1644</a>     }
<a class="jxr_linenumber" name="L1645" href="#L1645">1645</a> 
<a class="jxr_linenumber" name="L1646" href="#L1646">1646</a>     <strong class="jxr_keyword">public</strong> String getPublicKeyModulus() {
<a class="jxr_linenumber" name="L1647" href="#L1647">1647</a>         <strong class="jxr_keyword">return</strong> publicKeyModulus;
<a class="jxr_linenumber" name="L1648" href="#L1648">1648</a>     }
<a class="jxr_linenumber" name="L1649" href="#L1649">1649</a> 
<a class="jxr_linenumber" name="L1650" href="#L1650">1650</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setPublicKeyModulus(String publicKeyModulus) {
<a class="jxr_linenumber" name="L1651" href="#L1651">1651</a>         <strong class="jxr_keyword">this</strong>.publicKeyModulus = publicKeyModulus;
<a class="jxr_linenumber" name="L1652" href="#L1652">1652</a>     }
<a class="jxr_linenumber" name="L1653" href="#L1653">1653</a> 
<a class="jxr_linenumber" name="L1654" href="#L1654">1654</a>     <strong class="jxr_keyword">public</strong> String getPublicKeyExponent() {
<a class="jxr_linenumber" name="L1655" href="#L1655">1655</a>         <strong class="jxr_keyword">return</strong> publicKeyExponent;
<a class="jxr_linenumber" name="L1656" href="#L1656">1656</a>     }
<a class="jxr_linenumber" name="L1657" href="#L1657">1657</a> 
<a class="jxr_linenumber" name="L1658" href="#L1658">1658</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setPublicKeyExponent(String publicKeyExponent) {
<a class="jxr_linenumber" name="L1659" href="#L1659">1659</a>         <strong class="jxr_keyword">this</strong>.publicKeyExponent = publicKeyExponent;
<a class="jxr_linenumber" name="L1660" href="#L1660">1660</a>     }
<a class="jxr_linenumber" name="L1661" href="#L1661">1661</a> 
<a class="jxr_linenumber" name="L1662" href="#L1662">1662</a>     <strong class="jxr_keyword">public</strong> String getSha256Fingerprint() {
<a class="jxr_linenumber" name="L1663" href="#L1663">1663</a>         <strong class="jxr_keyword">return</strong> sha256Fingerprint;
<a class="jxr_linenumber" name="L1664" href="#L1664">1664</a>     }
<a class="jxr_linenumber" name="L1665" href="#L1665">1665</a> 
<a class="jxr_linenumber" name="L1666" href="#L1666">1666</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSha256Fingerprint(String sha256Fingerprint) {
<a class="jxr_linenumber" name="L1667" href="#L1667">1667</a>         <strong class="jxr_keyword">this</strong>.sha256Fingerprint = sha256Fingerprint;
<a class="jxr_linenumber" name="L1668" href="#L1668">1668</a>     }
<a class="jxr_linenumber" name="L1669" href="#L1669">1669</a> 
<a class="jxr_linenumber" name="L1670" href="#L1670">1670</a>     <strong class="jxr_keyword">public</strong> String getSignature() {
<a class="jxr_linenumber" name="L1671" href="#L1671">1671</a>         <strong class="jxr_keyword">return</strong> signature;
<a class="jxr_linenumber" name="L1672" href="#L1672">1672</a>     }
<a class="jxr_linenumber" name="L1673" href="#L1673">1673</a> 
<a class="jxr_linenumber" name="L1674" href="#L1674">1674</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSignature(String signature) {
<a class="jxr_linenumber" name="L1675" href="#L1675">1675</a>         <strong class="jxr_keyword">this</strong>.signature = signature;
<a class="jxr_linenumber" name="L1676" href="#L1676">1676</a>     }
<a class="jxr_linenumber" name="L1677" href="#L1677">1677</a> 
<a class="jxr_linenumber" name="L1678" href="#L1678">1678</a>     <strong class="jxr_keyword">public</strong> String getCsrFileName() {
<a class="jxr_linenumber" name="L1679" href="#L1679">1679</a>         <strong class="jxr_keyword">return</strong> csrFileName;
<a class="jxr_linenumber" name="L1680" href="#L1680">1680</a>     }
<a class="jxr_linenumber" name="L1681" href="#L1681">1681</a> 
<a class="jxr_linenumber" name="L1682" href="#L1682">1682</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setCsrFileName(String csrFileName) {
<a class="jxr_linenumber" name="L1683" href="#L1683">1683</a>         <strong class="jxr_keyword">this</strong>.csrFileName = csrFileName;
<a class="jxr_linenumber" name="L1684" href="#L1684">1684</a>     }
<a class="jxr_linenumber" name="L1685" href="#L1685">1685</a> 
<a class="jxr_linenumber" name="L1686" href="#L1686">1686</a>     <em class="jxr_javadoccomment">/** @return the current certificateRequest if available */</em>
<a class="jxr_linenumber" name="L1687" href="#L1687">1687</a>     <strong class="jxr_keyword">public</strong> String getCertificateRequest() {
<a class="jxr_linenumber" name="L1688" href="#L1688">1688</a>         <strong class="jxr_keyword">if</strong> (KeyPairGeneration.ON_SERVER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L1689" href="#L1689">1689</a>             certificateRequest = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L1690" href="#L1690">1690</a>         } <strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong> (KeyPairGeneration.PROVIDED_BY_USER.equals(getSelectedKeyPairGenerationEnum())) {
<a class="jxr_linenumber" name="L1691" href="#L1691">1691</a>             <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(certificateRequest)) {
<a class="jxr_linenumber" name="L1692" href="#L1692">1692</a>                 <em class="jxr_comment">// Multi-line place holders are not allowed according to https://www.w3.org/TR/html5/forms.html#the-placeholder-attribute</em>
<a class="jxr_linenumber" name="L1693" href="#L1693">1693</a>                 certificateRequest = raLocaleBean.getMessage(<span class="jxr_string">"enroll_upload_csr_placeholder"</span>);
<a class="jxr_linenumber" name="L1694" href="#L1694">1694</a>             }
<a class="jxr_linenumber" name="L1695" href="#L1695">1695</a>         }
<a class="jxr_linenumber" name="L1696" href="#L1696">1696</a>         <strong class="jxr_keyword">return</strong> certificateRequest;
<a class="jxr_linenumber" name="L1697" href="#L1697">1697</a>     }
<a class="jxr_linenumber" name="L1698" href="#L1698">1698</a> 
<a class="jxr_linenumber" name="L1699" href="#L1699">1699</a>     <em class="jxr_javadoccomment">/** @param certificateRequest the certificateRequest to set */</em>
<a class="jxr_linenumber" name="L1700" href="#L1700">1700</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setCertificateRequest(<strong class="jxr_keyword">final</strong> String certificateRequest) {
<a class="jxr_linenumber" name="L1701" href="#L1701">1701</a>         <strong class="jxr_keyword">this</strong>.certificateRequest = certificateRequest;
<a class="jxr_linenumber" name="L1702" href="#L1702">1702</a>     }
<a class="jxr_linenumber" name="L1703" href="#L1703">1703</a> 
<a class="jxr_linenumber" name="L1704" href="#L1704">1704</a>     <em class="jxr_javadoccomment">/** @return the requestId */</em>
<a class="jxr_linenumber" name="L1705" href="#L1705">1705</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> getRequestId() {
<a class="jxr_linenumber" name="L1706" href="#L1706">1706</a>         <strong class="jxr_keyword">return</strong> requestId;
<a class="jxr_linenumber" name="L1707" href="#L1707">1707</a>     }
<a class="jxr_linenumber" name="L1708" href="#L1708">1708</a> 
<a class="jxr_linenumber" name="L1709" href="#L1709">1709</a>     <em class="jxr_javadoccomment">/** @param requestId the requestId to set */</em>
<a class="jxr_linenumber" name="L1710" href="#L1710">1710</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRequestId(<strong class="jxr_keyword">int</strong> requestId) {
<a class="jxr_linenumber" name="L1711" href="#L1711">1711</a>         <strong class="jxr_keyword">this</strong>.requestId = requestId;
<a class="jxr_linenumber" name="L1712" href="#L1712">1712</a>     }
<a class="jxr_linenumber" name="L1713" href="#L1713">1713</a> 
<a class="jxr_linenumber" name="L1714" href="#L1714">1714</a>     <em class="jxr_javadoccomment">/** @return the current state of the request preview as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L1715" href="#L1715">1715</a>     <strong class="jxr_keyword">public</strong> <a name="RaRequestPreview" href="../../../org/ejbca/ra/RaRequestPreview.html#RaRequestPreview">RaRequestPreview</a> getRequestPreview() {
<a class="jxr_linenumber" name="L1716" href="#L1716">1716</a>         <a name="RaRequestPreview" href="../../../org/ejbca/ra/RaRequestPreview.htm<a name="RaRequestPreview" href="../../../org/ejbca/ra/RaRequestPreview.html#RaRequestPreview">RaRequestPreview</a>ew">RaRequestPreview</a> requestPreview = <strong class="jxr_keyword">new</strong> <a name="RaRequestPreview" href="../../../org/ejbca/ra/RaRequestPreview.html#RaRequestPreview">RaRequestPreview</a>();
<a class="jxr_linenumber" name="L1717" href="#L1717">1717</a>         requestPreview.updateSubjectDn(getSubjectDn());
<a class="jxr_linenumber" name="L1718" href="#L1718">1718</a>         requestPreview.updateSubjectAlternativeName(getSubjectAlternativeName());
<a class="jxr_linenumber" name="L1719" href="#L1719">1719</a>         requestPreview.updateSubjectDirectoryAttributes(getSubjectDirectoryAttributes());
<a class="jxr_linenumber" name="L1720" href="#L1720">1720</a>         requestPreview.setPublicKeyAlgorithm(getAlgorithm());
<a class="jxr_linenumber" name="L1721" href="#L1721">1721</a>         requestPreview.updateCA(getCAInfo());
<a class="jxr_linenumber" name="L1722" href="#L1722">1722</a>         requestPreview.updateCertificateProfile(getCertificateProfile());
<a class="jxr_linenumber" name="L1723" href="#L1723">1723</a>         requestPreview.setMore(requestPreviewMoreDetails);
<a class="jxr_linenumber" name="L1724" href="#L1724">1724</a>         <strong class="jxr_keyword">return</strong> requestPreview;
<a class="jxr_linenumber" name="L1725" href="#L1725">1725</a>     }
<a class="jxr_linenumber" name="L1726" href="#L1726">1726</a> 
<a class="jxr_linenumber" name="L1727" href="#L1727">1727</a>     <em class="jxr_javadoccomment">/** @return name of HTTP GET request parameter for checking approval status */</em>
<a class="jxr_linenumber" name="L1728" href="#L1728">1728</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">final</strong> String getParamRequestId(){
<a class="jxr_linenumber" name="L1729" href="#L1729">1729</a>         <strong class="jxr_keyword">return</strong> PARAM_REQUESTID;
<a class="jxr_linenumber" name="L1730" href="#L1730">1730</a>     }
<a class="jxr_linenumber" name="L1731" href="#L1731">1731</a> 
<a class="jxr_linenumber" name="L1732" href="#L1732">1732</a>     <strong class="jxr_keyword">public</strong> UIComponent getUserCredentialsMessagesComponent() {
<a class="jxr_linenumber" name="L1733" href="#L1733">1733</a>         <strong class="jxr_keyword">return</strong> userCredentialsMessagesComponent;
<a class="jxr_linenumber" name="L1734" href="#L1734">1734</a>     }
<a class="jxr_linenumber" name="L1735" href="#L1735">1735</a> 
<a class="jxr_linenumber" name="L1736" href="#L1736">1736</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setUserCredentialsMessagesComponent(UIComponent userCredentialsMessagesComponent) {
<a class="jxr_linenumber" name="L1737" href="#L1737">1737</a>         <strong class="jxr_keyword">this</strong>.userCredentialsMessagesComponent = userCredentialsMessagesComponent;
<a class="jxr_linenumber" name="L1738" href="#L1738">1738</a>     }
<a class="jxr_linenumber" name="L1739" href="#L1739">1739</a> 
<a class="jxr_linenumber" name="L1740" href="#L1740">1740</a>     <strong class="jxr_keyword">public</strong> UIComponent getSubjectDnMessagesComponent() {
<a class="jxr_linenumber" name="L1741" href="#L1741">1741</a>         <strong class="jxr_keyword">return</strong> subjectDnMessagesComponent;
<a class="jxr_linenumber" name="L1742" href="#L1742">1742</a>     }
<a class="jxr_linenumber" name="L1743" href="#L1743">1743</a> 
<a class="jxr_linenumber" name="L1744" href="#L1744">1744</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSubjectDnMessagesComponent(UIComponent subjectDnMessagesComponent) {
<a class="jxr_linenumber" name="L1745" href="#L1745">1745</a>         <strong class="jxr_keyword">this</strong>.subjectDnMessagesComponent = subjectDnMessagesComponent;
<a class="jxr_linenumber" name="L1746" href="#L1746">1746</a>     }
<a class="jxr_linenumber" name="L1747" href="#L1747">1747</a> 
<a class="jxr_linenumber" name="L1748" href="#L1748">1748</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1749" href="#L1749">1749</a> <em class="jxr_javadoccomment">     * @return the confirmPasswordComponent</em>
<a class="jxr_linenumber" name="L1750" href="#L1750">1750</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L1751" href="#L1751">1751</a>     <strong class="jxr_keyword">public</strong> UIComponent getConfirmPasswordComponent() {
<a class="jxr_linenumber" name="L1752" href="#L1752">1752</a>         <strong class="jxr_keyword">return</strong> confirmPasswordComponent;
<a class="jxr_linenumber" name="L1753" href="#L1753">1753</a>     }
<a class="jxr_linenumber" name="L1754" href="#L1754">1754</a> 
<a class="jxr_linenumber" name="L1755" href="#L1755">1755</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1756" href="#L1756">1756</a> <em class="jxr_javadoccomment">     * @param confirmPasswordComponent the confirmPasswordComponent to set</em>
<a class="jxr_linenumber" name="L1757" href="#L1757">1757</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L1758" href="#L1758">1758</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setConfirmPasswordComponent(UIComponent confirmPasswordComponent) {
<a class="jxr_linenumber" name="L1759" href="#L1759">1759</a>         <strong class="jxr_keyword">this</strong>.confirmPasswordComponent = confirmPasswordComponent;
<a class="jxr_linenumber" name="L1760" href="#L1760">1760</a>     }
<a class="jxr_linenumber" name="L1761" href="#L1761">1761</a> 
<a class="jxr_linenumber" name="L1762" href="#L1762">1762</a>     <strong class="jxr_keyword">public</strong> UIComponent getValidityInputComponent() {
<a class="jxr_linenumber" name="L1763" href="#L1763">1763</a>         <strong class="jxr_keyword">return</strong> validityInputComponent;
<a class="jxr_linenumber" name="L1764" href="#L1764">1764</a>     }
<a class="jxr_linenumber" name="L1765" href="#L1765">1765</a> 
<a class="jxr_linenumber" name="L1766" href="#L1766">1766</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setValidityInputComponent(<strong class="jxr_keyword">final</strong> UIComponent validityInputComponent) {
<a class="jxr_linenumber" name="L1767" href="#L1767">1767</a>         <strong class="jxr_keyword">this</strong>.validityInputComponent = validityInputComponent;
<a class="jxr_linenumber" name="L1768" href="#L1768">1768</a>     }
<a class="jxr_linenumber" name="L1769" href="#L1769">1769</a> 
<a class="jxr_linenumber" name="L1770" href="#L1770">1770</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L1771" href="#L1771">1771</a> <em class="jxr_javadoccomment">     * Finds the UPN/RFC822 email and domain in an Ajax event, concatenates them and</em>
<a class="jxr_linenumber" name="L1772" href="#L1772">1772</a> <em class="jxr_javadoccomment">     * sets the value of the appropriate FieldInstance.</em>
<a class="jxr_linenumber" name="L1773" href="#L1773">1773</a> <em class="jxr_javadoccomment">     *</em>
<a class="jxr_linenumber" name="L1774" href="#L1774">1774</a> <em class="jxr_javadoccomment">     * @param event the Ajax event</em>
<a class="jxr_linenumber" name="L1775" href="#L1775">1775</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L1776" href="#L1776">1776</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> upnRfc(AjaxBehaviorEvent event) {
<a class="jxr_linenumber" name="L1777" href="#L1777">1777</a>         UIComponent components = event.getComponent();
<a class="jxr_linenumber" name="L1778" href="#L1778">1778</a>         UIInput emailInput = (UIInput) components.findComponent(<span class="jxr_string">"upnRfcEmail"</span>);
<a class="jxr_linenumber" name="L1779" href="#L1779">1779</a>         UIInput domainInput = (UIInput) components.findComponent(<span class="jxr_string">"upnRfcDomain"</span>);
<a class="jxr_linenumber" name="L1780" href="#L1780">1780</a>         <strong class="jxr_keyword">int</strong> index = -1;
<a class="jxr_linenumber" name="L1781" href="#L1781">1781</a>         String email = <span class="jxr_string">""</span>;
<a class="jxr_linenumber" name="L1782" href="#L1782">1782</a>         <strong class="jxr_keyword">if</strong> (emailInput != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1783" href="#L1783">1783</a>             email = emailInput.getValue().toString();
<a class="jxr_linenumber" name="L1784" href="#L1784">1784</a>             <em class="jxr_comment">// Split the clientId on ':', the second to last substring is the loop index</em>
<a class="jxr_linenumber" name="L1785" href="#L1785">1785</a>             String[] split = emailInput.getClientId().split(<span class="jxr_string">":"</span>);
<a class="jxr_linenumber" name="L1786" href="#L1786">1786</a>             index = Integer.parseInt(split[split.length - 2]);
<a class="jxr_linenumber" name="L1787" href="#L1787">1787</a>         }
<a class="jxr_linenumber" name="L1788" href="#L1788">1788</a>         String domain = <span class="jxr_string">""</span>;
<a class="jxr_linenumber" name="L1789" href="#L1789">1789</a>         <strong class="jxr_keyword">if</strong> (domainInput != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L1790" href="#L1790">1790</a>             domain = domainInput.getValue().toString();
<a class="jxr_linenumber" name="L1791" href="#L1791">1791</a>         }
<a class="jxr_linenumber" name="L1792" href="#L1792">1792</a>         String concatenated = <span class="jxr_string">""</span>;
<a class="jxr_linenumber" name="L1793" href="#L1793">1793</a>         <strong class="jxr_keyword">if</strong> (!email.trim().isEmpty() &amp;&amp; !domain.trim().isEmpty()) {
<a class="jxr_linenumber" name="L1794" href="#L1794">1794</a>             concatenated = email + <span class="jxr_string">"@"</span> + domain;
<a class="jxr_linenumber" name="L1795" href="#L1795">1795</a>         }
<a class="jxr_linenumber" name="L1796" href="#L1796">1796</a>         List&lt;EndEntityProfile.FieldInstance&gt; fieldInstances = (List&lt;EndEntityProfile.FieldInstance&gt;) subjectAlternativeName.getFieldInstances();
<a class="jxr_linenumber" name="L1797" href="#L1797">1797</a>         <strong class="jxr_keyword">if</strong> (index &gt;= 0 &amp;&amp; index &lt; fieldInstances.size()) {
<a class="jxr_linenumber" name="L1798" href="#L1798">1798</a>             fieldInstances.get(index).setValue(concatenated);
<a class="jxr_linenumber" name="L1799" href="#L1799">1799</a>         }
<a class="jxr_linenumber" name="L1800" href="#L1800">1800</a>     }
<a class="jxr_linenumber" name="L1801" href="#L1801">1801</a> }
</pre>
<hr/>
<div id="footer">Copyright &#169; 2020. All rights reserved.</div>
</body>
</html>