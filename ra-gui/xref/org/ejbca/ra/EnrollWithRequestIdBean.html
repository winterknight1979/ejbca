<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>EnrollWithRequestIdBean xref</title>
<link type="text/css" rel="stylesheet" href="../../../stylesheet.css" />
</head>
<body>
<div id="overview"><a href="../../../../apidocs/org/ejbca/ra/EnrollWithRequestIdBean.html">View Javadoc</a></div><pre>
<a class="jxr_linenumber" name="L1" href="#L1">1</a>   <em class="jxr_javadoccomment">/*************************************************************************</em>
<a class="jxr_linenumber" name="L2" href="#L2">2</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L3" href="#L3">3</a>   <em class="jxr_javadoccomment"> *  EJBCA Community: The OpenSource Certificate Authority                *</em>
<a class="jxr_linenumber" name="L4" href="#L4">4</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L5" href="#L5">5</a>   <em class="jxr_javadoccomment"> *  This software is free software; you can redistribute it and/or       *</em>
<a class="jxr_linenumber" name="L6" href="#L6">6</a>   <em class="jxr_javadoccomment"> *  modify it under the terms of the GNU Lesser General Public           *</em>
<a class="jxr_linenumber" name="L7" href="#L7">7</a>   <em class="jxr_javadoccomment"> *  License as published by the Free Software Foundation; either         *</em>
<a class="jxr_linenumber" name="L8" href="#L8">8</a>   <em class="jxr_javadoccomment"> *  version 2.1 of the License, or any later version.                    *</em>
<a class="jxr_linenumber" name="L9" href="#L9">9</a>   <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L10" href="#L10">10</a>  <em class="jxr_javadoccomment"> *  See terms of license at gnu.org.                                     *</em>
<a class="jxr_linenumber" name="L11" href="#L11">11</a>  <em class="jxr_javadoccomment"> *                                                                       *</em>
<a class="jxr_linenumber" name="L12" href="#L12">12</a>  <em class="jxr_javadoccomment"> *************************************************************************/</em>
<a class="jxr_linenumber" name="L13" href="#L13">13</a>  <strong class="jxr_keyword">package</strong> org.ejbca.ra;
<a class="jxr_linenumber" name="L14" href="#L14">14</a>  
<a class="jxr_linenumber" name="L15" href="#L15">15</a>  <strong class="jxr_keyword">import</strong> java.io.ByteArrayOutputStream;
<a class="jxr_linenumber" name="L16" href="#L16">16</a>  <strong class="jxr_keyword">import</strong> java.io.IOException;
<a class="jxr_linenumber" name="L17" href="#L17">17</a>  <strong class="jxr_keyword">import</strong> java.io.OutputStream;
<a class="jxr_linenumber" name="L18" href="#L18">18</a>  <strong class="jxr_keyword">import</strong> java.io.Serializable;
<a class="jxr_linenumber" name="L19" href="#L19">19</a>  <strong class="jxr_keyword">import</strong> java.security.InvalidKeyException;
<a class="jxr_linenumber" name="L20" href="#L20">20</a>  <strong class="jxr_keyword">import</strong> java.security.NoSuchAlgorithmException;
<a class="jxr_linenumber" name="L21" href="#L21">21</a>  <strong class="jxr_keyword">import</strong> java.security.cert.Certificate;
<a class="jxr_linenumber" name="L22" href="#L22">22</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertificateEncodingException;
<a class="jxr_linenumber" name="L23" href="#L23">23</a>  <strong class="jxr_keyword">import</strong> java.security.cert.CertificateParsingException;
<a class="jxr_linenumber" name="L24" href="#L24">24</a>  <strong class="jxr_keyword">import</strong> java.security.cert.X509Certificate;
<a class="jxr_linenumber" name="L25" href="#L25">25</a>  <strong class="jxr_keyword">import</strong> java.util.ArrayList;
<a class="jxr_linenumber" name="L26" href="#L26">26</a>  <strong class="jxr_keyword">import</strong> java.util.Arrays;
<a class="jxr_linenumber" name="L27" href="#L27">27</a>  <strong class="jxr_keyword">import</strong> java.util.Collections;
<a class="jxr_linenumber" name="L28" href="#L28">28</a>  <strong class="jxr_keyword">import</strong> java.util.HashSet;
<a class="jxr_linenumber" name="L29" href="#L29">29</a>  <strong class="jxr_keyword">import</strong> java.util.LinkedList;
<a class="jxr_linenumber" name="L30" href="#L30">30</a>  <strong class="jxr_keyword">import</strong> java.util.List;
<a class="jxr_linenumber" name="L31" href="#L31">31</a>  <strong class="jxr_keyword">import</strong> java.util.Set;
<a class="jxr_linenumber" name="L32" href="#L32">32</a>  
<a class="jxr_linenumber" name="L33" href="#L33">33</a>  <strong class="jxr_keyword">import</strong> javax.annotation.PostConstruct;
<a class="jxr_linenumber" name="L34" href="#L34">34</a>  <strong class="jxr_keyword">import</strong> javax.ejb.EJB;
<a class="jxr_linenumber" name="L35" href="#L35">35</a>  <strong class="jxr_keyword">import</strong> javax.faces.application.FacesMessage;
<a class="jxr_linenumber" name="L36" href="#L36">36</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ManagedBean;
<a class="jxr_linenumber" name="L37" href="#L37">37</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ManagedProperty;
<a class="jxr_linenumber" name="L38" href="#L38">38</a>  <strong class="jxr_keyword">import</strong> javax.faces.bean.ViewScoped;
<a class="jxr_linenumber" name="L39" href="#L39">39</a>  <strong class="jxr_keyword">import</strong> javax.faces.component.UIComponent;
<a class="jxr_linenumber" name="L40" href="#L40">40</a>  <strong class="jxr_keyword">import</strong> javax.faces.context.ExternalContext;
<a class="jxr_linenumber" name="L41" href="#L41">41</a>  <strong class="jxr_keyword">import</strong> javax.faces.context.FacesContext;
<a class="jxr_linenumber" name="L42" href="#L42">42</a>  <strong class="jxr_keyword">import</strong> javax.faces.model.SelectItem;
<a class="jxr_linenumber" name="L43" href="#L43">43</a>  <strong class="jxr_keyword">import</strong> javax.faces.validator.ValidatorException;
<a class="jxr_linenumber" name="L44" href="#L44">44</a>  <strong class="jxr_keyword">import</strong> javax.servlet.http.HttpServletRequest;
<a class="jxr_linenumber" name="L45" href="#L45">45</a>  
<a class="jxr_linenumber" name="L46" href="#L46">46</a>  <strong class="jxr_keyword">import</strong> org.apache.commons.lang.StringUtils;
<a class="jxr_linenumber" name="L47" href="#L47">47</a>  <strong class="jxr_keyword">import</strong> org.apache.log4j.Logger;
<a class="jxr_linenumber" name="L48" href="#L48">48</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.cms.CMSException;
<a class="jxr_linenumber" name="L49" href="#L49">49</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.pkcs.PKCS10CertificationRequest;
<a class="jxr_linenumber" name="L50" href="#L50">50</a>  <strong class="jxr_keyword">import</strong> org.bouncycastle.pkcs.jcajce.JcaPKCS10CertificationRequest;
<a class="jxr_linenumber" name="L51" href="#L51">51</a>  <strong class="jxr_keyword">import</strong> org.cesecore.ErrorCode;
<a class="jxr_linenumber" name="L52" href="#L52">52</a>  <strong class="jxr_keyword">import</strong> org.cesecore.authorization.AuthorizationDeniedException;
<a class="jxr_linenumber" name="L53" href="#L53">53</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.ca.CAInfo;
<a class="jxr_linenumber" name="L54" href="#L54">54</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.certificateprofile.CertificateProfile;
<a class="jxr_linenumber" name="L55" href="#L55">55</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityConstants;
<a class="jxr_linenumber" name="L56" href="#L56">56</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.EndEntityInformation;
<a class="jxr_linenumber" name="L57" href="#L57">57</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.endentity.ExtendedInformation;
<a class="jxr_linenumber" name="L58" href="#L58">58</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.AlgorithmConstants;
<a class="jxr_linenumber" name="L59" href="#L59">59</a>  <strong class="jxr_keyword">import</strong> org.cesecore.certificates.util.AlgorithmTools;
<a class="jxr_linenumber" name="L60" href="#L60">60</a>  <strong class="jxr_keyword">import</strong> org.cesecore.config.CesecoreConfiguration;
<a class="jxr_linenumber" name="L61" href="#L61">61</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.CertTools;
<a class="jxr_linenumber" name="L62" href="#L62">62</a>  <strong class="jxr_keyword">import</strong> org.cesecore.util.StringTools;
<a class="jxr_linenumber" name="L63" href="#L63">63</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.EjbcaException;
<a class="jxr_linenumber" name="L64" href="#L64">64</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.ejb.ra.NoSuchEndEntityException;
<a class="jxr_linenumber" name="L65" href="#L65">65</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.SecConst;
<a class="jxr_linenumber" name="L66" href="#L66">66</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.approval.ApprovalDataVO;
<a class="jxr_linenumber" name="L67" href="#L67">67</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.approval.ApprovalRequest;
<a class="jxr_linenumber" name="L68" href="#L68">68</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.approval.approvalrequests.KeyRecoveryApprovalRequest;
<a class="jxr_linenumber" name="L69" href="#L69">69</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.authorization.AccessRulesConstants;
<a class="jxr_linenumber" name="L70" href="#L70">70</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ca.AuthLoginException;
<a class="jxr_linenumber" name="L71" href="#L71">71</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ca.AuthStatusException;
<a class="jxr_linenumber" name="L72" href="#L72">72</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.IdNameHashMap;
<a class="jxr_linenumber" name="L73" href="#L73">73</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.RaApprovalRequestInfo;
<a class="jxr_linenumber" name="L74" href="#L74">74</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.era.RaMasterApiProxyBeanLocal;
<a class="jxr_linenumber" name="L75" href="#L75">75</a>  <strong class="jxr_keyword">import</strong> org.ejbca.core.model.ra.raadmin.EndEntityProfile;
<a class="jxr_linenumber" name="L76" href="#L76">76</a>  
<a class="jxr_linenumber" name="L77" href="#L77">77</a>  <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L78" href="#L78">78</a>  <em class="jxr_javadoccomment"> * Managed bean that backs up the enrollwithrequestid.xhtml page</em>
<a class="jxr_linenumber" name="L79" href="#L79">79</a>  <em class="jxr_javadoccomment"> *</em>
<a class="jxr_linenumber" name="L80" href="#L80">80</a>  <em class="jxr_javadoccomment"> * @version $Id: EnrollWithRequestIdBean.java 29541 2018-08-01 09:53:21Z anatom $</em>
<a class="jxr_linenumber" name="L81" href="#L81">81</a>  <em class="jxr_javadoccomment"> * TODO: Use CDI beans</em>
<a class="jxr_linenumber" name="L82" href="#L82">82</a>  <em class="jxr_javadoccomment"> */</em>
<a class="jxr_linenumber" name="L83" href="#L83">83</a>  @SuppressWarnings(<span class="jxr_string">"deprecation"</span>)
<a class="jxr_linenumber" name="L84" href="#L84">84</a>  @ManagedBean
<a class="jxr_linenumber" name="L85" href="#L85">85</a>  @ViewScoped
<a class="jxr_linenumber" name="L86" href="#L86">86</a>  <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">class</strong> <a name="EnrollWithRequestIdBean" href="../../../org/ejbca/ra/EnrollWithRequestIdBean.html#EnrollWithRequestIdBean">EnrollWithRequestIdBean</a> <strong class="jxr_keyword">implements</strong> Serializable {
<a class="jxr_linenumber" name="L87" href="#L87">87</a>  
<a class="jxr_linenumber" name="L88" href="#L88">88</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">long</strong> serialVersionUID = 1L;
<a class="jxr_linenumber" name="L89" href="#L89">89</a>      <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">static</strong> <strong class="jxr_keyword">final</strong> Logger log = Logger.getLogger(EnrollWithRequestIdBean.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L90" href="#L90">90</a>  
<a class="jxr_linenumber" name="L91" href="#L91">91</a>      @EJB
<a class="jxr_linenumber" name="L92" href="#L92">92</a>      <strong class="jxr_keyword">private</strong> RaMasterApiProxyBeanLocal raMasterApiProxyBean;
<a class="jxr_linenumber" name="L93" href="#L93">93</a>  
<a class="jxr_linenumber" name="L94" href="#L94">94</a>      @ManagedProperty(value = <span class="jxr_string">"#{raAuthenticationBean}"</span>)
<a class="jxr_linenumber" name="L95" href="#L95">95</a>      <strong class="jxr_keyword">private</strong> <a name="RaAuthenticationBean" href="../../../org/ejbca/ra/RaAuthenticationBean.html#RaAuthenticationBean">RaAuthenticationBean</a> raAuthenticationBean;
<a class="jxr_linenumber" name="L96" href="#L96">96</a>  
<a class="jxr_linenumber" name="L97" href="#L97">97</a>      <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRaAuthenticationBean(<strong class="jxr_keyword">final</strong> <a name="RaAuthenticationBean" href="../../../org/ejbca/ra/RaAuthenticationBean.html#RaAuthenticationBean">RaAuthenticationBean</a> raAuthenticationBean) {
<a class="jxr_linenumber" name="L98" href="#L98">98</a>          <strong class="jxr_keyword">this</strong>.raAuthenticationBean = raAuthenticationBean;
<a class="jxr_linenumber" name="L99" href="#L99">99</a>      }
<a class="jxr_linenumber" name="L100" href="#L100">100</a> 
<a class="jxr_linenumber" name="L101" href="#L101">101</a>     @ManagedProperty(value = <span class="jxr_string">"#{raLocaleBean}"</span>)
<a class="jxr_linenumber" name="L102" href="#L102">102</a>     <strong class="jxr_keyword">protected</strong> <a name="RaLocaleBean" href="../../../org/ejbca/ra/RaLocaleBean.html#RaLocaleBean">RaLocaleBean</a> raLocaleBean;
<a class="jxr_linenumber" name="L103" href="#L103">103</a> 
<a class="jxr_linenumber" name="L104" href="#L104">104</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRaLocaleBean(<strong class="jxr_keyword">final</strong> <a name="RaLocaleBean" href="../../../org/ejbca/ra/RaLocaleBean.html#RaLocaleBean">RaLocaleBean</a> raLocaleBean) {
<a class="jxr_linenumber" name="L105" href="#L105">105</a>         <strong class="jxr_keyword">this</strong>.raLocaleBean = raLocaleBean;
<a class="jxr_linenumber" name="L106" href="#L106">106</a>     }
<a class="jxr_linenumber" name="L107" href="#L107">107</a> 
<a class="jxr_linenumber" name="L108" href="#L108">108</a>     <strong class="jxr_keyword">private</strong> CertificateProfile certificateProfile;
<a class="jxr_linenumber" name="L109" href="#L109">109</a>     <strong class="jxr_keyword">private</strong> String requestId;
<a class="jxr_linenumber" name="L110" href="#L110">110</a>     <strong class="jxr_keyword">private</strong> String requestUsername;
<a class="jxr_linenumber" name="L111" href="#L111">111</a>     <strong class="jxr_keyword">private</strong> String selectedAlgorithm;
<a class="jxr_linenumber" name="L112" href="#L112">112</a>     <strong class="jxr_keyword">private</strong> String certificateRequest;
<a class="jxr_linenumber" name="L113" href="#L113">113</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">int</strong> requestStatus;
<a class="jxr_linenumber" name="L114" href="#L114">114</a>     <strong class="jxr_keyword">private</strong> EndEntityInformation endEntityInformation;
<a class="jxr_linenumber" name="L115" href="#L115">115</a>     <strong class="jxr_keyword">private</strong> byte[] generatedToken;
<a class="jxr_linenumber" name="L116" href="#L116">116</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;CAInfo&gt; authorizedCAInfos;
<a class="jxr_linenumber" name="L117" href="#L117">117</a>     <strong class="jxr_keyword">private</strong> IdNameHashMap&lt;EndEntityProfile&gt; authorizedEndEntityProfiles = <strong class="jxr_keyword">new</strong> IdNameHashMap&lt;&gt;();
<a class="jxr_linenumber" name="L118" href="#L118">118</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isCsrChanged;
<a class="jxr_linenumber" name="L119" href="#L119">119</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">boolean</strong> isKeyRecovery;
<a class="jxr_linenumber" name="L120" href="#L120">120</a> 
<a class="jxr_linenumber" name="L121" href="#L121">121</a>     @PostConstruct
<a class="jxr_linenumber" name="L122" href="#L122">122</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> postConstruct() {
<a class="jxr_linenumber" name="L123" href="#L123">123</a>         HttpServletRequest httpServletRequest = (HttpServletRequest)FacesContext.getCurrentInstance().getExternalContext().getRequest();
<a class="jxr_linenumber" name="L124" href="#L124">124</a>         <strong class="jxr_keyword">this</strong>.authorizedEndEntityProfiles = raMasterApiProxyBean.getAuthorizedEndEntityProfiles(raAuthenticationBean.getAuthenticationToken(), AccessRulesConstants.CREATE_END_ENTITY);
<a class="jxr_linenumber" name="L125" href="#L125">125</a>         requestId = httpServletRequest.getParameter(EnrollMakeNewRequestBean.PARAM_REQUESTID);
<a class="jxr_linenumber" name="L126" href="#L126">126</a>         <strong class="jxr_keyword">this</strong>.authorizedCAInfos = raMasterApiProxyBean.getAuthorizedCAInfos(raAuthenticationBean.getAuthenticationToken());
<a class="jxr_linenumber" name="L127" href="#L127">127</a>         reset();
<a class="jxr_linenumber" name="L128" href="#L128">128</a>     }
<a class="jxr_linenumber" name="L129" href="#L129">129</a> 
<a class="jxr_linenumber" name="L130" href="#L130">130</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> reset() {
<a class="jxr_linenumber" name="L131" href="#L131">131</a>         requestStatus = ApprovalDataVO.STATUS_WAITINGFORAPPROVAL;
<a class="jxr_linenumber" name="L132" href="#L132">132</a>         endEntityInformation = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L133" href="#L133">133</a>         selectedAlgorithm = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L134" href="#L134">134</a>         certificateProfile = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L135" href="#L135">135</a>     }
<a class="jxr_linenumber" name="L136" href="#L136">136</a> 
<a class="jxr_linenumber" name="L137" href="#L137">137</a>     <em class="jxr_javadoccomment">/** Check the status of request ID */</em>
<a class="jxr_linenumber" name="L138" href="#L138">138</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> checkRequestId() {
<a class="jxr_linenumber" name="L139" href="#L139">139</a>         <strong class="jxr_keyword">if</strong> (Integer.parseInt(requestId) != 0) {
<a class="jxr_linenumber" name="L140" href="#L140">140</a>             RaApprovalRequestInfo raApprovalRequestInfo = raMasterApiProxyBean
<a class="jxr_linenumber" name="L141" href="#L141">141</a>                     .getApprovalRequest(raAuthenticationBean.getAuthenticationToken(), Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L142" href="#L142">142</a>             <strong class="jxr_keyword">if</strong> (raApprovalRequestInfo == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L143" href="#L143">143</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enrollwithrequestid_could_not_find_request_with_request_id"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L144" href="#L144">144</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L145" href="#L145">145</a>             }
<a class="jxr_linenumber" name="L146" href="#L146">146</a> 
<a class="jxr_linenumber" name="L147" href="#L147">147</a>             requestStatus = raApprovalRequestInfo.getStatus();
<a class="jxr_linenumber" name="L148" href="#L148">148</a>             <strong class="jxr_keyword">switch</strong> (requestStatus) {
<a class="jxr_linenumber" name="L149" href="#L149">149</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_WAITINGFORAPPROVAL:
<a class="jxr_linenumber" name="L150" href="#L150">150</a>                 raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_request_with_request_id_is_still_waiting_for_approval"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L151" href="#L151">151</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L152" href="#L152">152</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_REJECTED:
<a class="jxr_linenumber" name="L153" href="#L153">153</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_EXECUTIONDENIED:
<a class="jxr_linenumber" name="L154" href="#L154">154</a>                 raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_request_with_request_id_has_been_rejected"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L155" href="#L155">155</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L156" href="#L156">156</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_APPROVED:
<a class="jxr_linenumber" name="L157" href="#L157">157</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_EXECUTED:
<a class="jxr_linenumber" name="L158" href="#L158">158</a>                 ApprovalRequest approvalRequest = raApprovalRequestInfo.getApprovalData().getApprovalRequest();
<a class="jxr_linenumber" name="L159" href="#L159">159</a>                 <strong class="jxr_keyword">if</strong> (approvalRequest instanceof KeyRecoveryApprovalRequest) {
<a class="jxr_linenumber" name="L160" href="#L160">160</a>                     KeyRecoveryApprovalRequest keyRecoveryApprovalRequest = (KeyRecoveryApprovalRequest) approvalRequest;
<a class="jxr_linenumber" name="L161" href="#L161">161</a>                     requestUsername = keyRecoveryApprovalRequest.getUsername();
<a class="jxr_linenumber" name="L162" href="#L162">162</a>                     isKeyRecovery = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L163" href="#L163">163</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L164" href="#L164">164</a>                     requestUsername = raApprovalRequestInfo.getEditableData().getUsername();
<a class="jxr_linenumber" name="L165" href="#L165">165</a>                 }
<a class="jxr_linenumber" name="L166" href="#L166">166</a>                 endEntityInformation = raMasterApiProxyBean.searchUser(raAuthenticationBean.getAuthenticationToken(), requestUsername);
<a class="jxr_linenumber" name="L167" href="#L167">167</a>                 <strong class="jxr_keyword">if</strong> (endEntityInformation == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L168" href="#L168">168</a>                     log.error(<span class="jxr_string">"Could not find endEntity for the username='"</span> + requestUsername + <span class="jxr_string">"'"</span>);
<a class="jxr_linenumber" name="L169" href="#L169">169</a>                 }<strong class="jxr_keyword">else</strong> <strong class="jxr_keyword">if</strong>(endEntityInformation.getStatus() == EndEntityConstants.STATUS_GENERATED){
<a class="jxr_linenumber" name="L170" href="#L170">170</a>                     raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_enrollment_with_request_id_has_already_been_finalized"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L171" href="#L171">171</a>                 }<strong class="jxr_keyword">else</strong>{
<a class="jxr_linenumber" name="L172" href="#L172">172</a>                     raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_request_with_request_id_has_been_approved"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L173" href="#L173">173</a>                 }
<a class="jxr_linenumber" name="L174" href="#L174">174</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L175" href="#L175">175</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_EXPIRED:
<a class="jxr_linenumber" name="L176" href="#L176">176</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_EXPIREDANDNOTIFIED:
<a class="jxr_linenumber" name="L177" href="#L177">177</a>                 raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_request_with_request_id_has_been_expired"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L178" href="#L178">178</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L179" href="#L179">179</a>             <strong class="jxr_keyword">case</strong> ApprovalDataVO.STATUS_EXECUTIONFAILED:
<a class="jxr_linenumber" name="L180" href="#L180">180</a>                 raLocaleBean.addMessageInfo(<span class="jxr_string">"enrollwithrequestid_request_with_request_id_could_not_be_executed"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L181" href="#L181">181</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L182" href="#L182">182</a>             <strong class="jxr_keyword">default</strong>:
<a class="jxr_linenumber" name="L183" href="#L183">183</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enrollwithrequestid_status_of_request_id_is_unknown"</span>, Integer.parseInt(requestId));
<a class="jxr_linenumber" name="L184" href="#L184">184</a>                 <strong class="jxr_keyword">break</strong>;
<a class="jxr_linenumber" name="L185" href="#L185">185</a>             }
<a class="jxr_linenumber" name="L186" href="#L186">186</a>         }
<a class="jxr_linenumber" name="L187" href="#L187">187</a>     }
<a class="jxr_linenumber" name="L188" href="#L188">188</a> 
<a class="jxr_linenumber" name="L189" href="#L189">189</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isFinalizeEnrollmentRendered() {
<a class="jxr_linenumber" name="L190" href="#L190">190</a>         <strong class="jxr_keyword">return</strong> (requestStatus == ApprovalDataVO.STATUS_APPROVED || requestStatus == ApprovalDataVO.STATUS_EXECUTED) &amp;&amp; endEntityInformation != <strong class="jxr_keyword">null</strong> &amp;&amp;
<a class="jxr_linenumber" name="L191" href="#L191">191</a>                 (endEntityInformation.getStatus() == EndEntityConstants.STATUS_NEW || endEntityInformation.getStatus() == EndEntityConstants.STATUS_KEYRECOVERY);
<a class="jxr_linenumber" name="L192" href="#L192">192</a>     }
<a class="jxr_linenumber" name="L193" href="#L193">193</a> 
<a class="jxr_linenumber" name="L194" href="#L194">194</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateCertificatePem() {
<a class="jxr_linenumber" name="L195" href="#L195">195</a>         generateCertificate();
<a class="jxr_linenumber" name="L196" href="#L196">196</a>         <strong class="jxr_keyword">if</strong> (generatedToken != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L197" href="#L197">197</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L198" href="#L198">198</a>                 X509Certificate certificate = CertTools.getCertfromByteArray(generatedToken, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L199" href="#L199">199</a>                 byte[] pemToDownload = CertTools.getPemFromCertificateChain(Arrays.asList((Certificate) certificate));
<a class="jxr_linenumber" name="L200" href="#L200">200</a>                 downloadToken(pemToDownload, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L201" href="#L201">201</a>             } <strong class="jxr_keyword">catch</strong> (CertificateParsingException | CertificateEncodingException e) {
<a class="jxr_linenumber" name="L202" href="#L202">202</a>                 log.info(e);
<a class="jxr_linenumber" name="L203" href="#L203">203</a>             }
<a class="jxr_linenumber" name="L204" href="#L204">204</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L205" href="#L205">205</a>             log.debug(<span class="jxr_string">"No token was generated an error message should have been logged"</span>);
<a class="jxr_linenumber" name="L206" href="#L206">206</a>         }
<a class="jxr_linenumber" name="L207" href="#L207">207</a>         reset();
<a class="jxr_linenumber" name="L208" href="#L208">208</a>     }
<a class="jxr_linenumber" name="L209" href="#L209">209</a> 
<a class="jxr_linenumber" name="L210" href="#L210">210</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateCertificatePemFullChain() {
<a class="jxr_linenumber" name="L211" href="#L211">211</a>         generateCertificate();
<a class="jxr_linenumber" name="L212" href="#L212">212</a>         <strong class="jxr_keyword">if</strong> (generatedToken != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L213" href="#L213">213</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L214" href="#L214">214</a>                 X509Certificate certificate = CertTools.getCertfromByteArray(generatedToken, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L215" href="#L215">215</a>                 CAInfo caInfo = authorizedCAInfos.get(endEntityInformation.getCAId()).getValue();
<a class="jxr_linenumber" name="L216" href="#L216">216</a>                 LinkedList&lt;Certificate&gt; chain = <strong class="jxr_keyword">new</strong> LinkedList&lt;&gt;(caInfo.getCertificateChain());
<a class="jxr_linenumber" name="L217" href="#L217">217</a>                 chain.addFirst(certificate);
<a class="jxr_linenumber" name="L218" href="#L218">218</a>                 byte[] pemToDownload = CertTools.getPemFromCertificateChain(chain);
<a class="jxr_linenumber" name="L219" href="#L219">219</a>                 downloadToken(pemToDownload, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L220" href="#L220">220</a>             } <strong class="jxr_keyword">catch</strong> (CertificateParsingException | CertificateEncodingException e) {
<a class="jxr_linenumber" name="L221" href="#L221">221</a>                 log.info(e);
<a class="jxr_linenumber" name="L222" href="#L222">222</a>             }
<a class="jxr_linenumber" name="L223" href="#L223">223</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L224" href="#L224">224</a>             log.debug(<span class="jxr_string">"No token was generated an error message should have been logged"</span>);
<a class="jxr_linenumber" name="L225" href="#L225">225</a>         }
<a class="jxr_linenumber" name="L226" href="#L226">226</a>         reset();
<a class="jxr_linenumber" name="L227" href="#L227">227</a>     }
<a class="jxr_linenumber" name="L228" href="#L228">228</a> 
<a class="jxr_linenumber" name="L229" href="#L229">229</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateCertificateDer() {
<a class="jxr_linenumber" name="L230" href="#L230">230</a>         generateCertificate();
<a class="jxr_linenumber" name="L231" href="#L231">231</a>         downloadToken(generatedToken, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".der"</span>);
<a class="jxr_linenumber" name="L232" href="#L232">232</a>         reset();
<a class="jxr_linenumber" name="L233" href="#L233">233</a>     }
<a class="jxr_linenumber" name="L234" href="#L234">234</a> 
<a class="jxr_linenumber" name="L235" href="#L235">235</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateCertificatePkcs7() {
<a class="jxr_linenumber" name="L236" href="#L236">236</a>         generateCertificate();
<a class="jxr_linenumber" name="L237" href="#L237">237</a>         <strong class="jxr_keyword">if</strong> (generatedToken != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L238" href="#L238">238</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L239" href="#L239">239</a>                 X509Certificate certificate = CertTools.getCertfromByteArray(generatedToken, X509Certificate.<strong class="jxr_keyword">class</strong>);
<a class="jxr_linenumber" name="L240" href="#L240">240</a>                 CAInfo caInfo = authorizedCAInfos.get(endEntityInformation.getCAId()).getValue();
<a class="jxr_linenumber" name="L241" href="#L241">241</a>                 LinkedList&lt;Certificate&gt; chain = <strong class="jxr_keyword">new</strong> LinkedList&lt;&gt;(caInfo.getCertificateChain());
<a class="jxr_linenumber" name="L242" href="#L242">242</a>                 chain.addFirst(certificate);
<a class="jxr_linenumber" name="L243" href="#L243">243</a>                 byte[] pkcs7ToDownload = CertTools.getPemFromPkcs7(CertTools.createCertsOnlyCMS(CertTools.convertCertificateChainToX509Chain(chain)));
<a class="jxr_linenumber" name="L244" href="#L244">244</a>                 downloadToken(pkcs7ToDownload, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".p7b"</span>);
<a class="jxr_linenumber" name="L245" href="#L245">245</a>             } <strong class="jxr_keyword">catch</strong> (CertificateParsingException | CertificateEncodingException | ClassCastException | CMSException e) {
<a class="jxr_linenumber" name="L246" href="#L246">246</a>                 log.info(e);
<a class="jxr_linenumber" name="L247" href="#L247">247</a>             }
<a class="jxr_linenumber" name="L248" href="#L248">248</a>         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L249" href="#L249">249</a>             log.debug(<span class="jxr_string">"No token was generated an error message should have been logged"</span>);
<a class="jxr_linenumber" name="L250" href="#L250">250</a>         }
<a class="jxr_linenumber" name="L251" href="#L251">251</a>         reset();
<a class="jxr_linenumber" name="L252" href="#L252">252</a>     }
<a class="jxr_linenumber" name="L253" href="#L253">253</a> 
<a class="jxr_linenumber" name="L254" href="#L254">254</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> generateCertificateAfterCheck(){
<a class="jxr_linenumber" name="L255" href="#L255">255</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L256" href="#L256">256</a>             generatedToken = raMasterApiProxyBean.createCertificate(raAuthenticationBean.getAuthenticationToken(), endEntityInformation);
<a class="jxr_linenumber" name="L257" href="#L257">257</a>             log.info(endEntityInformation.getTokenType() + <span class="jxr_string">" token has been generated for the end entity with username "</span> +
<a class="jxr_linenumber" name="L258" href="#L258">258</a>                     endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L259" href="#L259">259</a>         } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e){
<a class="jxr_linenumber" name="L260" href="#L260">260</a>             raLocaleBean.addMessageInfo(<span class="jxr_string">"enroll_unauthorized_operation"</span>, e.getMessage());
<a class="jxr_linenumber" name="L261" href="#L261">261</a>             log.info(raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" is not authorized to execute this operation"</span>, e);
<a class="jxr_linenumber" name="L262" href="#L262">262</a>         } <strong class="jxr_keyword">catch</strong> (EjbcaException e) {
<a class="jxr_linenumber" name="L263" href="#L263">263</a>             ErrorCode errorCode = EjbcaException.getErrorCode(e);
<a class="jxr_linenumber" name="L264" href="#L264">264</a>             <strong class="jxr_keyword">if</strong> (errorCode != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L265" href="#L265">265</a>                 <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.LOGIN_ERROR)) {
<a class="jxr_linenumber" name="L266" href="#L266">266</a>                     raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), errorCode);
<a class="jxr_linenumber" name="L267" href="#L267">267</a>                     log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername()+<span class="jxr_string">": "</span>+e.getMessage()+<span class="jxr_string">", "</span>+errorCode);
<a class="jxr_linenumber" name="L268" href="#L268">268</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L269" href="#L269">269</a>                     raLocaleBean.addMessageError(errorCode);
<a class="jxr_linenumber" name="L270" href="#L270">270</a>                     log.info(<span class="jxr_string">"Exception generating certificate. Error Code: "</span> + errorCode, e);
<a class="jxr_linenumber" name="L271" href="#L271">271</a>                 }
<a class="jxr_linenumber" name="L272" href="#L272">272</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L273" href="#L273">273</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_certificate_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L274" href="#L274">274</a>                 log.info(<span class="jxr_string">"Certificate could not be generated for end entity with username "</span> + endEntityInformation.getUsername(), e);
<a class="jxr_linenumber" name="L275" href="#L275">275</a>             }
<a class="jxr_linenumber" name="L276" href="#L276">276</a>         }
<a class="jxr_linenumber" name="L277" href="#L277">277</a>     }
<a class="jxr_linenumber" name="L278" href="#L278">278</a> 
<a class="jxr_linenumber" name="L279" href="#L279">279</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> generateCertificate() {
<a class="jxr_linenumber" name="L280" href="#L280">280</a>         <strong class="jxr_keyword">if</strong> (getEndEntityInformation().getExtendedInformation() == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L281" href="#L281">281</a>             getEndEntityInformation().setExtendedInformation(<strong class="jxr_keyword">new</strong> ExtendedInformation());
<a class="jxr_linenumber" name="L282" href="#L282">282</a>         }
<a class="jxr_linenumber" name="L283" href="#L283">283</a>         byte[] certificateRequest = getEndEntityInformation().getExtendedInformation().getCertificateRequest();
<a class="jxr_linenumber" name="L284" href="#L284">284</a>         <strong class="jxr_keyword">if</strong> (certificateRequest == <strong class="jxr_keyword">null</strong> || isCsrChanged) {
<a class="jxr_linenumber" name="L285" href="#L285">285</a>             <strong class="jxr_keyword">if</strong> (getCertificateRequest() == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L286" href="#L286">286</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enrollwithrequestid_could_not_find_csr_inside_enrollment_request_with_request_id"</span>, requestId);
<a class="jxr_linenumber" name="L287" href="#L287">287</a>                 log.info(<span class="jxr_string">"Could not find CSR inside enrollment request with ID "</span> + requestId);
<a class="jxr_linenumber" name="L288" href="#L288">288</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L289" href="#L289">289</a>             }
<a class="jxr_linenumber" name="L290" href="#L290">290</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L291" href="#L291">291</a>                 getEndEntityInformation().getExtendedInformation().setCertificateRequest(CertTools.getCertificateRequestFromPem(getCertificateRequest()).getEncoded());
<a class="jxr_linenumber" name="L292" href="#L292">292</a>             } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L293" href="#L293">293</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_invalid_certificate_request"</span>);
<a class="jxr_linenumber" name="L294" href="#L294">294</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L295" href="#L295">295</a>             }
<a class="jxr_linenumber" name="L296" href="#L296">296</a>         }
<a class="jxr_linenumber" name="L297" href="#L297">297</a>         generateCertificateAfterCheck();
<a class="jxr_linenumber" name="L298" href="#L298">298</a>     }
<a class="jxr_linenumber" name="L299" href="#L299">299</a> 
<a class="jxr_linenumber" name="L300" href="#L300">300</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateKeyStoreJks() {
<a class="jxr_linenumber" name="L301" href="#L301">301</a>         endEntityInformation.setTokenType(EndEntityConstants.TOKEN_SOFT_JKS);
<a class="jxr_linenumber" name="L302" href="#L302">302</a>         generateKeyStore();
<a class="jxr_linenumber" name="L303" href="#L303">303</a>         downloadToken(generatedToken, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".jks"</span>);
<a class="jxr_linenumber" name="L304" href="#L304">304</a>         reset();
<a class="jxr_linenumber" name="L305" href="#L305">305</a>     }
<a class="jxr_linenumber" name="L306" href="#L306">306</a> 
<a class="jxr_linenumber" name="L307" href="#L307">307</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateKeyStorePkcs12() {
<a class="jxr_linenumber" name="L308" href="#L308">308</a>         endEntityInformation.setTokenType(EndEntityConstants.TOKEN_SOFT_P12);
<a class="jxr_linenumber" name="L309" href="#L309">309</a>         generateKeyStore();
<a class="jxr_linenumber" name="L310" href="#L310">310</a>         downloadToken(generatedToken, <span class="jxr_string">"application/x-pkcs12"</span>, <span class="jxr_string">".p12"</span>);
<a class="jxr_linenumber" name="L311" href="#L311">311</a>         reset();
<a class="jxr_linenumber" name="L312" href="#L312">312</a>     }
<a class="jxr_linenumber" name="L313" href="#L313">313</a> 
<a class="jxr_linenumber" name="L314" href="#L314">314</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> generateKeyStorePem() {
<a class="jxr_linenumber" name="L315" href="#L315">315</a>         endEntityInformation.setTokenType(EndEntityConstants.TOKEN_SOFT_PEM);
<a class="jxr_linenumber" name="L316" href="#L316">316</a>         generateKeyStore();
<a class="jxr_linenumber" name="L317" href="#L317">317</a>         downloadToken(generatedToken, <span class="jxr_string">"application/octet-stream"</span>, <span class="jxr_string">".pem"</span>);
<a class="jxr_linenumber" name="L318" href="#L318">318</a>         reset();
<a class="jxr_linenumber" name="L319" href="#L319">319</a>     }
<a class="jxr_linenumber" name="L320" href="#L320">320</a> 
<a class="jxr_linenumber" name="L321" href="#L321">321</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> generateKeyStore() {
<a class="jxr_linenumber" name="L322" href="#L322">322</a>         <strong class="jxr_keyword">if</strong> (isKeyRecovery) {
<a class="jxr_linenumber" name="L323" href="#L323">323</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L324" href="#L324">324</a>                 raMasterApiProxyBean.checkUserStatus(raAuthenticationBean.getAuthenticationToken(), endEntityInformation.getUsername(), endEntityInformation.getPassword());
<a class="jxr_linenumber" name="L325" href="#L325">325</a>             } <strong class="jxr_keyword">catch</strong> (NoSuchEndEntityException | AuthStatusException | AuthLoginException e) {
<a class="jxr_linenumber" name="L326" href="#L326">326</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enrollwithusername_user_not_found_or_wrongstatus_or_invalid_enrollmentcode"</span>, endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L327" href="#L327">327</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L328" href="#L328">328</a>             }
<a class="jxr_linenumber" name="L329" href="#L329">329</a>         }
<a class="jxr_linenumber" name="L330" href="#L330">330</a>         <em class="jxr_comment">// If key algorithm is missing from EEI, we need to fetch it from CSR / select list first</em>
<a class="jxr_linenumber" name="L331" href="#L331">331</a>         <strong class="jxr_keyword">if</strong> (!isKeyAlgorithmPreSet()) {
<a class="jxr_linenumber" name="L332" href="#L332">332</a>             <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(selectedAlgorithm)) {
<a class="jxr_linenumber" name="L333" href="#L333">333</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_no_key_algorithm"</span>);
<a class="jxr_linenumber" name="L334" href="#L334">334</a>                 log.info(<span class="jxr_string">"No key algorithm was provided."</span>);
<a class="jxr_linenumber" name="L335" href="#L335">335</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L336" href="#L336">336</a>             }
<a class="jxr_linenumber" name="L337" href="#L337">337</a>             <strong class="jxr_keyword">final</strong> String[] parts = StringUtils.split(selectedAlgorithm, '_');
<a class="jxr_linenumber" name="L338" href="#L338">338</a>             <strong class="jxr_keyword">if</strong> (parts == <strong class="jxr_keyword">null</strong> || parts.length &lt; 2) {
<a class="jxr_linenumber" name="L339" href="#L339">339</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_no_key_algorithm"</span>);
<a class="jxr_linenumber" name="L340" href="#L340">340</a>                 log.info(<span class="jxr_string">"No full key algorithm was provided: "</span>+selectedAlgorithm);
<a class="jxr_linenumber" name="L341" href="#L341">341</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L342" href="#L342">342</a>             }
<a class="jxr_linenumber" name="L343" href="#L343">343</a>             <strong class="jxr_keyword">final</strong> String keyAlg = parts[0];
<a class="jxr_linenumber" name="L344" href="#L344">344</a>             <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(keyAlg)) {
<a class="jxr_linenumber" name="L345" href="#L345">345</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_no_key_algorithm"</span>);
<a class="jxr_linenumber" name="L346" href="#L346">346</a>                 log.info(<span class="jxr_string">"No key algorithm was provided: "</span>+selectedAlgorithm);
<a class="jxr_linenumber" name="L347" href="#L347">347</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L348" href="#L348">348</a>             }
<a class="jxr_linenumber" name="L349" href="#L349">349</a>             <strong class="jxr_keyword">final</strong> String keySpec = parts[1];
<a class="jxr_linenumber" name="L350" href="#L350">350</a>             <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(keySpec)) {
<a class="jxr_linenumber" name="L351" href="#L351">351</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_no_key_specification"</span>);
<a class="jxr_linenumber" name="L352" href="#L352">352</a>                 log.info(<span class="jxr_string">"No key specification was provided: "</span>+selectedAlgorithm);
<a class="jxr_linenumber" name="L353" href="#L353">353</a>                 <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L354" href="#L354">354</a>             }
<a class="jxr_linenumber" name="L355" href="#L355">355</a>             <strong class="jxr_keyword">if</strong> (getEndEntityInformation().getExtendedInformation() == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L356" href="#L356">356</a>                 getEndEntityInformation().setExtendedInformation(<strong class="jxr_keyword">new</strong> ExtendedInformation());
<a class="jxr_linenumber" name="L357" href="#L357">357</a>             }
<a class="jxr_linenumber" name="L358" href="#L358">358</a>             getEndEntityInformation().getExtendedInformation().setKeyStoreAlgorithmType(keyAlg);
<a class="jxr_linenumber" name="L359" href="#L359">359</a>             getEndEntityInformation().getExtendedInformation().setKeyStoreAlgorithmSubType(keySpec);
<a class="jxr_linenumber" name="L360" href="#L360">360</a>         }
<a class="jxr_linenumber" name="L361" href="#L361">361</a> 
<a class="jxr_linenumber" name="L362" href="#L362">362</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L363" href="#L363">363</a>             byte[] keystoreAsByteArray = raMasterApiProxyBean.generateKeyStore(raAuthenticationBean.getAuthenticationToken(), endEntityInformation);
<a class="jxr_linenumber" name="L364" href="#L364">364</a>             log.info(endEntityInformation.getTokenType() + <span class="jxr_string">" token has been generated for the end entity with username "</span> +
<a class="jxr_linenumber" name="L365" href="#L365">365</a>                     endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L366" href="#L366">366</a>             <strong class="jxr_keyword">try</strong>(ByteArrayOutputStream buffer = <strong class="jxr_keyword">new</strong> ByteArrayOutputStream()){
<a class="jxr_linenumber" name="L367" href="#L367">367</a>                 buffer.write(keystoreAsByteArray);
<a class="jxr_linenumber" name="L368" href="#L368">368</a>                 generatedToken = buffer.toByteArray();
<a class="jxr_linenumber" name="L369" href="#L369">369</a>             }
<a class="jxr_linenumber" name="L370" href="#L370">370</a>         } <strong class="jxr_keyword">catch</strong> (AuthorizationDeniedException e){
<a class="jxr_linenumber" name="L371" href="#L371">371</a>             raLocaleBean.addMessageInfo(<span class="jxr_string">"enroll_unauthorized_operation"</span>, e.getMessage());
<a class="jxr_linenumber" name="L372" href="#L372">372</a>             log.info(raAuthenticationBean.getAuthenticationToken() + <span class="jxr_string">" is not authorized to execute this operation"</span>, e);
<a class="jxr_linenumber" name="L373" href="#L373">373</a>         } <strong class="jxr_keyword">catch</strong> (EjbcaException | IOException e) {
<a class="jxr_linenumber" name="L374" href="#L374">374</a>             ErrorCode errorCode = EjbcaException.getErrorCode(e);
<a class="jxr_linenumber" name="L375" href="#L375">375</a>             <strong class="jxr_keyword">if</strong> (errorCode != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L376" href="#L376">376</a>                 <strong class="jxr_keyword">if</strong> (errorCode.equals(ErrorCode.LOGIN_ERROR)) {
<a class="jxr_linenumber" name="L377" href="#L377">377</a>                     raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), errorCode);
<a class="jxr_linenumber" name="L378" href="#L378">378</a>                     log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername()+<span class="jxr_string">": "</span>+e.getMessage()+<span class="jxr_string">", "</span>+errorCode);
<a class="jxr_linenumber" name="L379" href="#L379">379</a>                 } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L380" href="#L380">380</a>                     raLocaleBean.addMessageError(errorCode);
<a class="jxr_linenumber" name="L381" href="#L381">381</a>                     log.info(<span class="jxr_string">"Exception generating keystore. Error Code: "</span> + errorCode, e);
<a class="jxr_linenumber" name="L382" href="#L382">382</a>                 }
<a class="jxr_linenumber" name="L383" href="#L383">383</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L384" href="#L384">384</a>                 raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L385" href="#L385">385</a>                 log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L386" href="#L386">386</a>             }
<a class="jxr_linenumber" name="L387" href="#L387">387</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L388" href="#L388">388</a>         } <strong class="jxr_keyword">catch</strong> (Exception e){
<a class="jxr_linenumber" name="L389" href="#L389">389</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_keystore_could_not_be_generated"</span>, endEntityInformation.getUsername(), e.getMessage());
<a class="jxr_linenumber" name="L390" href="#L390">390</a>             log.info(<span class="jxr_string">"Keystore could not be generated for user "</span> + endEntityInformation.getUsername());
<a class="jxr_linenumber" name="L391" href="#L391">391</a>         }
<a class="jxr_linenumber" name="L392" href="#L392">392</a>     }
<a class="jxr_linenumber" name="L393" href="#L393">393</a> 
<a class="jxr_linenumber" name="L394" href="#L394">394</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderGenerateCertificate(){
<a class="jxr_linenumber" name="L395" href="#L395">395</a>         <strong class="jxr_keyword">if</strong> (endEntityInformation.getTokenType() == EndEntityConstants.TOKEN_USERGEN) {
<a class="jxr_linenumber" name="L396" href="#L396">396</a>             <em class="jxr_comment">// If CSR is already uploaded, load its key algorithm and display it to end user</em>
<a class="jxr_linenumber" name="L397" href="#L397">397</a>             <strong class="jxr_keyword">if</strong> (isCsrPreSet() &amp;&amp; !isCsrChanged) {
<a class="jxr_linenumber" name="L398" href="#L398">398</a>                 selectKeyAlgorithmFromCsr();
<a class="jxr_linenumber" name="L399" href="#L399">399</a>             }
<a class="jxr_linenumber" name="L400" href="#L400">400</a>             <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L401" href="#L401">401</a>         }
<a class="jxr_linenumber" name="L402" href="#L402">402</a>         <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L403" href="#L403">403</a>     }
<a class="jxr_linenumber" name="L404" href="#L404">404</a> 
<a class="jxr_linenumber" name="L405" href="#L405">405</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderGenerateKeyStoreJks(){
<a class="jxr_linenumber" name="L406" href="#L406">406</a>         <strong class="jxr_keyword">if</strong>(endEntityInformation.getTokenType() == EndEntityConstants.TOKEN_USERGEN){
<a class="jxr_linenumber" name="L407" href="#L407">407</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L408" href="#L408">408</a>         }
<a class="jxr_linenumber" name="L409" href="#L409">409</a>         EndEntityProfile endEntityProfile = authorizedEndEntityProfiles.get(endEntityInformation.getEndEntityProfileId()).getValue();
<a class="jxr_linenumber" name="L410" href="#L410">410</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L411" href="#L411">411</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L412" href="#L412">412</a>         }
<a class="jxr_linenumber" name="L413" href="#L413">413</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L414" href="#L414">414</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_JKS));
<a class="jxr_linenumber" name="L415" href="#L415">415</a>     }
<a class="jxr_linenumber" name="L416" href="#L416">416</a> 
<a class="jxr_linenumber" name="L417" href="#L417">417</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderGenerateKeyStorePkcs12(){
<a class="jxr_linenumber" name="L418" href="#L418">418</a>         <strong class="jxr_keyword">if</strong>(endEntityInformation.getTokenType() == EndEntityConstants.TOKEN_USERGEN){
<a class="jxr_linenumber" name="L419" href="#L419">419</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L420" href="#L420">420</a>         }
<a class="jxr_linenumber" name="L421" href="#L421">421</a>         EndEntityProfile endEntityProfile = authorizedEndEntityProfiles.get(endEntityInformation.getEndEntityProfileId()).getValue();
<a class="jxr_linenumber" name="L422" href="#L422">422</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L423" href="#L423">423</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L424" href="#L424">424</a>         }
<a class="jxr_linenumber" name="L425" href="#L425">425</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L426" href="#L426">426</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_P12));
<a class="jxr_linenumber" name="L427" href="#L427">427</a>     }
<a class="jxr_linenumber" name="L428" href="#L428">428</a> 
<a class="jxr_linenumber" name="L429" href="#L429">429</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderGenerateKeyStorePem(){
<a class="jxr_linenumber" name="L430" href="#L430">430</a>         <strong class="jxr_keyword">if</strong>(endEntityInformation.getTokenType() == EndEntityConstants.TOKEN_USERGEN){
<a class="jxr_linenumber" name="L431" href="#L431">431</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L432" href="#L432">432</a>         }
<a class="jxr_linenumber" name="L433" href="#L433">433</a>         EndEntityProfile endEntityProfile = authorizedEndEntityProfiles.get(endEntityInformation.getEndEntityProfileId()).getValue();
<a class="jxr_linenumber" name="L434" href="#L434">434</a>         <strong class="jxr_keyword">if</strong> (endEntityProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L435" href="#L435">435</a>             <strong class="jxr_keyword">return</strong> false;
<a class="jxr_linenumber" name="L436" href="#L436">436</a>         }
<a class="jxr_linenumber" name="L437" href="#L437">437</a>         String availableKeyStores = endEntityProfile.getValue(EndEntityProfile.AVAILKEYSTORE, 0);
<a class="jxr_linenumber" name="L438" href="#L438">438</a>         <strong class="jxr_keyword">return</strong> availableKeyStores != <strong class="jxr_keyword">null</strong> &amp;&amp; availableKeyStores.contains(String.valueOf(SecConst.TOKEN_SOFT_PEM));
<a class="jxr_linenumber" name="L439" href="#L439">439</a>     }
<a class="jxr_linenumber" name="L440" href="#L440">440</a> 
<a class="jxr_linenumber" name="L441" href="#L441">441</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L442" href="#L442">442</a> <em class="jxr_javadoccomment">     * Checks if key algorithm is already set in an earlier stage or by a CSR.</em>
<a class="jxr_linenumber" name="L443" href="#L443">443</a> <em class="jxr_javadoccomment">     * @return true if key algorithm is set in EEI or to be uploaded by CSR</em>
<a class="jxr_linenumber" name="L444" href="#L444">444</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L445" href="#L445">445</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isKeyAlgorithmPreSet() {
<a class="jxr_linenumber" name="L446" href="#L446">446</a>         <strong class="jxr_keyword">return</strong>  (endEntityInformation.getExtendedInformation() != <strong class="jxr_keyword">null</strong> &amp;&amp; endEntityInformation.getExtendedInformation().getKeyStoreAlgorithmType() != <strong class="jxr_keyword">null</strong>) ||
<a class="jxr_linenumber" name="L447" href="#L447">447</a>                 endEntityInformation.getTokenType() == EndEntityConstants.TOKEN_USERGEN ||
<a class="jxr_linenumber" name="L448" href="#L448">448</a>                 endEntityInformation.getStatus() == EndEntityConstants.STATUS_KEYRECOVERY;
<a class="jxr_linenumber" name="L449" href="#L449">449</a>     }
<a class="jxr_linenumber" name="L450" href="#L450">450</a> 
<a class="jxr_linenumber" name="L451" href="#L451">451</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L452" href="#L452">452</a> <em class="jxr_javadoccomment">     * Checks if a non-modifiable text displaying the previously set key algorithm should be shown.</em>
<a class="jxr_linenumber" name="L453" href="#L453">453</a> <em class="jxr_javadoccomment">     * @return bool</em>
<a class="jxr_linenumber" name="L454" href="#L454">454</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L455" href="#L455">455</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isPreSetKeyAlgorithmRendered() {
<a class="jxr_linenumber" name="L456" href="#L456">456</a>         <strong class="jxr_keyword">return</strong> endEntityInformation.getExtendedInformation() != <strong class="jxr_keyword">null</strong> &amp;&amp;
<a class="jxr_linenumber" name="L457" href="#L457">457</a>                endEntityInformation.getExtendedInformation().getKeyStoreAlgorithmType() != <strong class="jxr_keyword">null</strong> &amp;&amp;
<a class="jxr_linenumber" name="L458" href="#L458">458</a>                endEntityInformation.getStatus() != EndEntityConstants.STATUS_KEYRECOVERY;
<a class="jxr_linenumber" name="L459" href="#L459">459</a>     }
<a class="jxr_linenumber" name="L460" href="#L460">460</a> 
<a class="jxr_linenumber" name="L461" href="#L461">461</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L462" href="#L462">462</a> <em class="jxr_javadoccomment">     * Checks if a CSR has been uploaded in an earlier stage (before the finalize enrollment stage)</em>
<a class="jxr_linenumber" name="L463" href="#L463">463</a> <em class="jxr_javadoccomment">     * @return true if a CSR is set in EEI</em>
<a class="jxr_linenumber" name="L464" href="#L464">464</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L465" href="#L465">465</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isCsrPreSet() {
<a class="jxr_linenumber" name="L466" href="#L466">466</a>         <strong class="jxr_keyword">return</strong> endEntityInformation.getExtendedInformation() != <strong class="jxr_keyword">null</strong> &amp;&amp; endEntityInformation.getExtendedInformation().getCertificateRequest() != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L467" href="#L467">467</a>     }
<a class="jxr_linenumber" name="L468" href="#L468">468</a> 
<a class="jxr_linenumber" name="L469" href="#L469">469</a>     <strong class="jxr_keyword">private</strong> <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">void</strong> downloadToken(byte[] token, String responseContentType, String fileExtension) {
<a class="jxr_linenumber" name="L470" href="#L470">470</a>         <strong class="jxr_keyword">if</strong> (token == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L471" href="#L471">471</a>             <strong class="jxr_keyword">return</strong>;
<a class="jxr_linenumber" name="L472" href="#L472">472</a>         }
<a class="jxr_linenumber" name="L473" href="#L473">473</a>         <em class="jxr_comment">//Download the token</em>
<a class="jxr_linenumber" name="L474" href="#L474">474</a>         FacesContext fc = FacesContext.getCurrentInstance();
<a class="jxr_linenumber" name="L475" href="#L475">475</a>         ExternalContext ec = fc.getExternalContext();
<a class="jxr_linenumber" name="L476" href="#L476">476</a>         ec.responseReset(); <em class="jxr_comment">// Some JSF component library or some Filter might have set some headers in the buffer beforehand. We want to get rid of them, else it may collide.</em>
<a class="jxr_linenumber" name="L477" href="#L477">477</a>         ec.setResponseContentType(responseContentType);
<a class="jxr_linenumber" name="L478" href="#L478">478</a>         ec.setResponseContentLength(token.length);
<a class="jxr_linenumber" name="L479" href="#L479">479</a>         String fileName = CertTools.getPartFromDN(endEntityInformation.getDN(), <span class="jxr_string">"CN"</span>);
<a class="jxr_linenumber" name="L480" href="#L480">480</a>         <strong class="jxr_keyword">if</strong>(fileName == <strong class="jxr_keyword">null</strong>){
<a class="jxr_linenumber" name="L481" href="#L481">481</a>             fileName = <span class="jxr_string">"certificatetoken"</span>;
<a class="jxr_linenumber" name="L482" href="#L482">482</a>         }
<a class="jxr_linenumber" name="L483" href="#L483">483</a> 
<a class="jxr_linenumber" name="L484" href="#L484">484</a>         <strong class="jxr_keyword">final</strong> String filename = StringTools.stripFilename(fileName + fileExtension);
<a class="jxr_linenumber" name="L485" href="#L485">485</a>         ec.setResponseHeader(<span class="jxr_string">"Content-Disposition"</span>, <span class="jxr_string">"attachment; filename=\&quot;"</span> + filename + <span class="jxr_string">"\&quot;"</span>); <em class="jxr_comment">// The Save As popup magic is done here. You can give it any file name you want, this only won't work in MSIE, it will use current request URL as file name instead.</em>
<a class="jxr_linenumber" name="L486" href="#L486">486</a>         <strong class="jxr_keyword">try</strong> (<strong class="jxr_keyword">final</strong> OutputStream output = ec.getResponseOutputStream()) {
<a class="jxr_linenumber" name="L487" href="#L487">487</a>             output.write(token);
<a class="jxr_linenumber" name="L488" href="#L488">488</a>             output.flush();
<a class="jxr_linenumber" name="L489" href="#L489">489</a>             fc.responseComplete(); <em class="jxr_comment">// Important! Otherwise JSF will attempt to render the response which obviously will fail since it's already written with a file and closed.</em>
<a class="jxr_linenumber" name="L490" href="#L490">490</a>         } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L491" href="#L491">491</a>             log.info(<span class="jxr_string">"Token "</span> + filename + <span class="jxr_string">" could not be downloaded"</span>, e);
<a class="jxr_linenumber" name="L492" href="#L492">492</a>             raLocaleBean.addMessageError(<span class="jxr_string">"enroll_token_could_not_be_downloaded"</span>, filename);
<a class="jxr_linenumber" name="L493" href="#L493">493</a>         }
<a class="jxr_linenumber" name="L494" href="#L494">494</a>     }
<a class="jxr_linenumber" name="L495" href="#L495">495</a> 
<a class="jxr_linenumber" name="L496" href="#L496">496</a>     <em class="jxr_javadoccomment">/** @return true if the the CSR has been uploaded */</em>
<a class="jxr_linenumber" name="L497" href="#L497">497</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isUploadCsrDoneRendered() {
<a class="jxr_linenumber" name="L498" href="#L498">498</a>         <strong class="jxr_keyword">return</strong> selectedAlgorithm != <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L499" href="#L499">499</a>     }
<a class="jxr_linenumber" name="L500" href="#L500">500</a> 
<a class="jxr_linenumber" name="L501" href="#L501">501</a>     <em class="jxr_javadoccomment">/** @return the current certificateRequest if available */</em>
<a class="jxr_linenumber" name="L502" href="#L502">502</a>     <strong class="jxr_keyword">public</strong> String getCertificateRequest() {
<a class="jxr_linenumber" name="L503" href="#L503">503</a>         <strong class="jxr_keyword">if</strong> (StringUtils.isEmpty(certificateRequest)) {
<a class="jxr_linenumber" name="L504" href="#L504">504</a>             <em class="jxr_comment">// Multi-line place holders are not allowed according to https://www.w3.org/TR/html5/forms.html#the-placeholder-attribute</em>
<a class="jxr_linenumber" name="L505" href="#L505">505</a>             certificateRequest = raLocaleBean.getMessage(<span class="jxr_string">"enroll_upload_csr_placeholder"</span>);
<a class="jxr_linenumber" name="L506" href="#L506">506</a>         }
<a class="jxr_linenumber" name="L507" href="#L507">507</a>         <strong class="jxr_keyword">return</strong> certificateRequest;
<a class="jxr_linenumber" name="L508" href="#L508">508</a>     }
<a class="jxr_linenumber" name="L509" href="#L509">509</a> 
<a class="jxr_linenumber" name="L510" href="#L510">510</a>     <em class="jxr_javadoccomment">/** @param certificateRequest the certificateRequest to set */</em>
<a class="jxr_linenumber" name="L511" href="#L511">511</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setCertificateRequest(<strong class="jxr_keyword">final</strong> String certificateRequest) {
<a class="jxr_linenumber" name="L512" href="#L512">512</a>         <strong class="jxr_keyword">this</strong>.certificateRequest = certificateRequest;
<a class="jxr_linenumber" name="L513" href="#L513">513</a>     }
<a class="jxr_linenumber" name="L514" href="#L514">514</a> 
<a class="jxr_linenumber" name="L515" href="#L515">515</a>     <em class="jxr_javadoccomment">/** Backing method for upload CSR button (used for uploading pasted CSR) populating fields is handled by AJAX */</em>
<a class="jxr_linenumber" name="L516" href="#L516">516</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> uploadCsr() {
<a class="jxr_linenumber" name="L517" href="#L517">517</a>     }
<a class="jxr_linenumber" name="L518" href="#L518">518</a> 
<a class="jxr_linenumber" name="L519" href="#L519">519</a>     <em class="jxr_javadoccomment">/** Resets selected key algorithm and flags CSR as changed */</em>
<a class="jxr_linenumber" name="L520" href="#L520">520</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> uploadCsrChange() {
<a class="jxr_linenumber" name="L521" href="#L521">521</a>         selectedAlgorithm = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L522" href="#L522">522</a>         isCsrChanged = <strong class="jxr_keyword">true</strong>;
<a class="jxr_linenumber" name="L523" href="#L523">523</a>     }
<a class="jxr_linenumber" name="L524" href="#L524">524</a> 
<a class="jxr_linenumber" name="L525" href="#L525">525</a>     <em class="jxr_javadoccomment">/** Updates selected algorithm with key algorithm and key size from the CSR preset in EEI. */</em>
<a class="jxr_linenumber" name="L526" href="#L526">526</a>     <strong class="jxr_keyword">protected</strong> <strong class="jxr_keyword">void</strong> selectKeyAlgorithmFromCsr() {
<a class="jxr_linenumber" name="L527" href="#L527">527</a>         <strong class="jxr_keyword">if</strong> (endEntityInformation.getExtendedInformation() != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L528" href="#L528">528</a>             <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L529" href="#L529">529</a>                 PKCS10CertificationRequest pkcs10CertificationRequest = <strong class="jxr_keyword">new</strong> PKCS10CertificationRequest(endEntityInformation.getExtendedInformation().getCertificateRequest());
<a class="jxr_linenumber" name="L530" href="#L530">530</a>                 <strong class="jxr_keyword">final</strong> JcaPKCS10CertificationRequest jcaPKCS10CertificationRequest = <strong class="jxr_keyword">new</strong> JcaPKCS10CertificationRequest(pkcs10CertificationRequest);
<a class="jxr_linenumber" name="L531" href="#L531">531</a>                 <strong class="jxr_keyword">final</strong> String keySpecification = AlgorithmTools.getKeySpecification(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L532" href="#L532">532</a>                 <strong class="jxr_keyword">final</strong> String keyAlgorithm = AlgorithmTools.getKeyAlgorithm(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L533" href="#L533">533</a>                 selectedAlgorithm = keyAlgorithm + <span class="jxr_string">" "</span> + keySpecification; <em class="jxr_comment">// Save for later use</em>
<a class="jxr_linenumber" name="L534" href="#L534">534</a>             } <strong class="jxr_keyword">catch</strong> (IOException e) {
<a class="jxr_linenumber" name="L535" href="#L535">535</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L536" href="#L536">536</a>             } <strong class="jxr_keyword">catch</strong> (InvalidKeyException | NoSuchAlgorithmException e) {
<a class="jxr_linenumber" name="L537" href="#L537">537</a>                 <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_unknown_key_algorithm"</span>)));
<a class="jxr_linenumber" name="L538" href="#L538">538</a>             }
<a class="jxr_linenumber" name="L539" href="#L539">539</a>         }
<a class="jxr_linenumber" name="L540" href="#L540">540</a>     }
<a class="jxr_linenumber" name="L541" href="#L541">541</a> 
<a class="jxr_linenumber" name="L542" href="#L542">542</a>     <em class="jxr_javadoccomment">/** Validate an uploaded CSR and store the extracted key algorithm and CSR for later use. </em>
<a class="jxr_linenumber" name="L543" href="#L543">543</a> <em class="jxr_javadoccomment">     * @param context Context</em>
<a class="jxr_linenumber" name="L544" href="#L544">544</a> <em class="jxr_javadoccomment">     * @param component Component</em>
<a class="jxr_linenumber" name="L545" href="#L545">545</a> <em class="jxr_javadoccomment">     * @param value Value</em>
<a class="jxr_linenumber" name="L546" href="#L546">546</a> <em class="jxr_javadoccomment">     * @throws ValidatorException Fail */</em>
<a class="jxr_linenumber" name="L547" href="#L547">547</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> validateCsr(FacesContext context, UIComponent component, Object value) <strong class="jxr_keyword">throws</strong> ValidatorException {
<a class="jxr_linenumber" name="L548" href="#L548">548</a>         selectedAlgorithm = <strong class="jxr_keyword">null</strong>;
<a class="jxr_linenumber" name="L549" href="#L549">549</a>         <strong class="jxr_keyword">final</strong> String valueStr = value.toString();
<a class="jxr_linenumber" name="L550" href="#L550">550</a>         <strong class="jxr_keyword">if</strong> (valueStr != <strong class="jxr_keyword">null</strong> &amp;&amp; valueStr.length() &gt; EnrollMakeNewRequestBean.MAX_CSR_LENGTH) {
<a class="jxr_linenumber" name="L551" href="#L551">551</a>             log.info(<span class="jxr_string">"CSR uploaded was too large: "</span>+valueStr.length());
<a class="jxr_linenumber" name="L552" href="#L552">552</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L553" href="#L553">553</a>         }
<a class="jxr_linenumber" name="L554" href="#L554">554</a>         PKCS10CertificationRequest pkcs10CertificateRequest = CertTools.getCertificateRequestFromPem(valueStr);
<a class="jxr_linenumber" name="L555" href="#L555">555</a>         <strong class="jxr_keyword">if</strong> (pkcs10CertificateRequest == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L556" href="#L556">556</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_invalid_certificate_request"</span>)));
<a class="jxr_linenumber" name="L557" href="#L557">557</a>         }
<a class="jxr_linenumber" name="L558" href="#L558">558</a> 
<a class="jxr_linenumber" name="L559" href="#L559">559</a>         <em class="jxr_comment">//Get public key algorithm from CSR and check if it's allowed in certificate profile</em>
<a class="jxr_linenumber" name="L560" href="#L560">560</a>         <strong class="jxr_keyword">final</strong> JcaPKCS10CertificationRequest jcaPKCS10CertificationRequest = <strong class="jxr_keyword">new</strong> JcaPKCS10CertificationRequest(pkcs10CertificateRequest);
<a class="jxr_linenumber" name="L561" href="#L561">561</a>         <strong class="jxr_keyword">try</strong> {
<a class="jxr_linenumber" name="L562" href="#L562">562</a>             <strong class="jxr_keyword">final</strong> String keySpecification = AlgorithmTools.getKeySpecification(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L563" href="#L563">563</a>             <strong class="jxr_keyword">final</strong> String keyAlgorithm = AlgorithmTools.getKeyAlgorithm(jcaPKCS10CertificationRequest.getPublicKey());
<a class="jxr_linenumber" name="L564" href="#L564">564</a>             <em class="jxr_comment">// If we have an End Entity, use this to verify that the algorithm and keyspec are allowed</em>
<a class="jxr_linenumber" name="L565" href="#L565">565</a>             <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L566" href="#L566">566</a>             <strong class="jxr_keyword">if</strong> (certificateProfile != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L567" href="#L567">567</a>                 <strong class="jxr_keyword">if</strong> (!certificateProfile.isKeyTypeAllowed(keyAlgorithm, keySpecification)) {
<a class="jxr_linenumber" name="L568" href="#L568">568</a>                     <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_key_algorithm_is_not_available"</span>, keyAlgorithm + <span class="jxr_string">"_"</span> + keySpecification)));
<a class="jxr_linenumber" name="L569" href="#L569">569</a>                 }
<a class="jxr_linenumber" name="L570" href="#L570">570</a>             } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L571" href="#L571">571</a>                 <strong class="jxr_keyword">if</strong> (log.isDebugEnabled()) {
<a class="jxr_linenumber" name="L572" href="#L572">572</a>                     log.debug(<span class="jxr_string">"Ignoring algorithm validation on CSR because we can not find a Certificate Profile for request with ID: "</span> + requestId);
<a class="jxr_linenumber" name="L573" href="#L573">573</a>                 }
<a class="jxr_linenumber" name="L574" href="#L574">574</a>             }
<a class="jxr_linenumber" name="L575" href="#L575">575</a>             selectedAlgorithm = keyAlgorithm + <span class="jxr_string">" "</span> + keySpecification; <em class="jxr_comment">// Save for later use</em>
<a class="jxr_linenumber" name="L576" href="#L576">576</a>             <em class="jxr_comment">// For yet unknown reasons, the setter is never when invoked during AJAX request</em>
<a class="jxr_linenumber" name="L577" href="#L577">577</a>             certificateRequest = value.toString();
<a class="jxr_linenumber" name="L578" href="#L578">578</a>         } <strong class="jxr_keyword">catch</strong> (InvalidKeyException | NoSuchAlgorithmException e) {
<a class="jxr_linenumber" name="L579" href="#L579">579</a>             <strong class="jxr_keyword">throw</strong> <strong class="jxr_keyword">new</strong> ValidatorException(<strong class="jxr_keyword">new</strong> FacesMessage(raLocaleBean.getMessage(<span class="jxr_string">"enroll_unknown_key_algorithm"</span>)));
<a class="jxr_linenumber" name="L580" href="#L580">580</a>         }
<a class="jxr_linenumber" name="L581" href="#L581">581</a>     }
<a class="jxr_linenumber" name="L582" href="#L582">582</a> 
<a class="jxr_linenumber" name="L583" href="#L583">583</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">boolean</strong> isRenderPassword() {
<a class="jxr_linenumber" name="L584" href="#L584">584</a>         EndEntityProfile endEntityProfile = authorizedEndEntityProfiles.get(endEntityInformation.getEndEntityProfileId()).getValue();
<a class="jxr_linenumber" name="L585" href="#L585">585</a>         <strong class="jxr_keyword">return</strong> !endEntityProfile.useAutoGeneratedPasswd();
<a class="jxr_linenumber" name="L586" href="#L586">586</a>     }
<a class="jxr_linenumber" name="L587" href="#L587">587</a> 
<a class="jxr_linenumber" name="L588" href="#L588">588</a>     <strong class="jxr_keyword">private</strong> CertificateProfile getCertificateProfile() {
<a class="jxr_linenumber" name="L589" href="#L589">589</a>         <strong class="jxr_keyword">if</strong> (<strong class="jxr_keyword">this</strong>.certificateProfile == <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L590" href="#L590">590</a>             EndEntityInformation ei = getEndEntityInformation();
<a class="jxr_linenumber" name="L591" href="#L591">591</a>             <strong class="jxr_keyword">if</strong> (ei != <strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L592" href="#L592">592</a>                 <strong class="jxr_keyword">this</strong>.certificateProfile = raMasterApiProxyBean.getCertificateProfile(ei.getCertificateProfileId());
<a class="jxr_linenumber" name="L593" href="#L593">593</a>             }
<a class="jxr_linenumber" name="L594" href="#L594">594</a>         }
<a class="jxr_linenumber" name="L595" href="#L595">595</a>         <strong class="jxr_keyword">return</strong> <strong class="jxr_keyword">this</strong>.certificateProfile;
<a class="jxr_linenumber" name="L596" href="#L596">596</a>     }
<a class="jxr_linenumber" name="L597" href="#L597">597</a> 
<a class="jxr_linenumber" name="L598" href="#L598">598</a>     <em class="jxr_javadoccomment">/** @return the current availableAlgorithms as determined by state of dependencies */</em>
<a class="jxr_linenumber" name="L599" href="#L599">599</a>     <strong class="jxr_keyword">public</strong> List&lt;SelectItem&gt; getAvailableAlgorithmSelectItems() {
<a class="jxr_linenumber" name="L600" href="#L600">600</a>         <strong class="jxr_keyword">final</strong> List&lt;SelectItem&gt; availableAlgorithmSelectItems = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;();
<a class="jxr_linenumber" name="L601" href="#L601">601</a>         <strong class="jxr_keyword">final</strong> CertificateProfile certificateProfile = getCertificateProfile();
<a class="jxr_linenumber" name="L602" href="#L602">602</a>         <strong class="jxr_keyword">if</strong> (certificateProfile!=<strong class="jxr_keyword">null</strong>) {
<a class="jxr_linenumber" name="L603" href="#L603">603</a>             <strong class="jxr_keyword">final</strong> List&lt;String&gt; availableKeyAlgorithms = certificateProfile.getAvailableKeyAlgorithmsAsList();
<a class="jxr_linenumber" name="L604" href="#L604">604</a>             <strong class="jxr_keyword">final</strong> List&lt;Integer&gt; availableBitLengths = certificateProfile.getAvailableBitLengthsAsList();
<a class="jxr_linenumber" name="L605" href="#L605">605</a>             <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_DSA)) {
<a class="jxr_linenumber" name="L606" href="#L606">606</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> availableBitLength : availableBitLengths) {
<a class="jxr_linenumber" name="L607" href="#L607">607</a>                     <strong class="jxr_keyword">if</strong> (availableBitLength == 1024) {
<a class="jxr_linenumber" name="L608" href="#L608">608</a>                         availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_DSA + <span class="jxr_string">"_"</span> + availableBitLength,
<a class="jxr_linenumber" name="L609" href="#L609">609</a>                                 AlgorithmConstants.KEYALGORITHM_DSA + <span class="jxr_string">" "</span> + availableBitLength + <span class="jxr_string">" bits"</span>));
<a class="jxr_linenumber" name="L610" href="#L610">610</a>                     }
<a class="jxr_linenumber" name="L611" href="#L611">611</a>                 }
<a class="jxr_linenumber" name="L612" href="#L612">612</a>             }
<a class="jxr_linenumber" name="L613" href="#L613">613</a>             <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_RSA)) {
<a class="jxr_linenumber" name="L614" href="#L614">614</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> availableBitLength : availableBitLengths) {
<a class="jxr_linenumber" name="L615" href="#L615">615</a>                     <strong class="jxr_keyword">if</strong> (availableBitLength &gt;= 1024) {
<a class="jxr_linenumber" name="L616" href="#L616">616</a>                         availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_RSA + <span class="jxr_string">"_"</span> + availableBitLength,
<a class="jxr_linenumber" name="L617" href="#L617">617</a>                                 AlgorithmConstants.KEYALGORITHM_RSA + <span class="jxr_string">" "</span> + availableBitLength + <span class="jxr_string">" bits"</span>));
<a class="jxr_linenumber" name="L618" href="#L618">618</a>                     }
<a class="jxr_linenumber" name="L619" href="#L619">619</a>                 }
<a class="jxr_linenumber" name="L620" href="#L620">620</a>             }
<a class="jxr_linenumber" name="L621" href="#L621">621</a>             <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(AlgorithmConstants.KEYALGORITHM_ECDSA)) {
<a class="jxr_linenumber" name="L622" href="#L622">622</a>                 <strong class="jxr_keyword">final</strong> Set&lt;String&gt; ecChoices = <strong class="jxr_keyword">new</strong> HashSet&lt;&gt;();
<a class="jxr_linenumber" name="L623" href="#L623">623</a>                 <strong class="jxr_keyword">if</strong> (certificateProfile.getAvailableEcCurvesAsList().contains(CertificateProfile.ANY_EC_CURVE)) {
<a class="jxr_linenumber" name="L624" href="#L624">624</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String ecNamedCurve : AlgorithmTools.getNamedEcCurvesMap(false).keySet()) {
<a class="jxr_linenumber" name="L625" href="#L625">625</a>                         <strong class="jxr_keyword">if</strong> (CertificateProfile.ANY_EC_CURVE.equals(ecNamedCurve)) {
<a class="jxr_linenumber" name="L626" href="#L626">626</a>                             <strong class="jxr_keyword">continue</strong>;
<a class="jxr_linenumber" name="L627" href="#L627">627</a>                         }
<a class="jxr_linenumber" name="L628" href="#L628">628</a>                         <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> bitLength = AlgorithmTools.getNamedEcCurveBitLength(ecNamedCurve);
<a class="jxr_linenumber" name="L629" href="#L629">629</a>                         <strong class="jxr_keyword">if</strong> (availableBitLengths.contains(Integer.valueOf(bitLength))) {
<a class="jxr_linenumber" name="L630" href="#L630">630</a>                             ecChoices.add(ecNamedCurve);
<a class="jxr_linenumber" name="L631" href="#L631">631</a>                         }
<a class="jxr_linenumber" name="L632" href="#L632">632</a>                     }
<a class="jxr_linenumber" name="L633" href="#L633">633</a>                 }
<a class="jxr_linenumber" name="L634" href="#L634">634</a>                 ecChoices.addAll(certificateProfile.getAvailableEcCurvesAsList());
<a class="jxr_linenumber" name="L635" href="#L635">635</a>                 ecChoices.remove(CertificateProfile.ANY_EC_CURVE);
<a class="jxr_linenumber" name="L636" href="#L636">636</a>                 <strong class="jxr_keyword">final</strong> List&lt;String&gt; ecChoicesList = <strong class="jxr_keyword">new</strong> ArrayList&lt;&gt;(ecChoices);
<a class="jxr_linenumber" name="L637" href="#L637">637</a>                 Collections.sort(ecChoicesList);
<a class="jxr_linenumber" name="L638" href="#L638">638</a>                 <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String ecNamedCurve : ecChoicesList) {
<a class="jxr_linenumber" name="L639" href="#L639">639</a>                     availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(AlgorithmConstants.KEYALGORITHM_ECDSA + <span class="jxr_string">"_"</span> + ecNamedCurve, AlgorithmConstants.KEYALGORITHM_ECDSA + <span class="jxr_string">" "</span>
<a class="jxr_linenumber" name="L640" href="#L640">640</a>                                     + StringTools.getAsStringWithSeparator(<span class="jxr_string">" / "</span>, AlgorithmTools.getAllCurveAliasesFromAlias(ecNamedCurve))));
<a class="jxr_linenumber" name="L641" href="#L641">641</a>                 }
<a class="jxr_linenumber" name="L642" href="#L642">642</a>             }
<a class="jxr_linenumber" name="L643" href="#L643">643</a>             <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String algName : CesecoreConfiguration.getExtraAlgs()) {
<a class="jxr_linenumber" name="L644" href="#L644">644</a>                 <strong class="jxr_keyword">if</strong> (availableKeyAlgorithms.contains(CesecoreConfiguration.getExtraAlgTitle(algName))) {
<a class="jxr_linenumber" name="L645" href="#L645">645</a>                     <strong class="jxr_keyword">for</strong> (<strong class="jxr_keyword">final</strong> String subAlg : CesecoreConfiguration.getExtraAlgSubAlgs(algName)) {
<a class="jxr_linenumber" name="L646" href="#L646">646</a>                         <strong class="jxr_keyword">final</strong> String name = CesecoreConfiguration.getExtraAlgSubAlgName(algName, subAlg);
<a class="jxr_linenumber" name="L647" href="#L647">647</a>                         <strong class="jxr_keyword">final</strong> <strong class="jxr_keyword">int</strong> bitLength = AlgorithmTools.getNamedEcCurveBitLength(name);
<a class="jxr_linenumber" name="L648" href="#L648">648</a>                         <strong class="jxr_keyword">if</strong> (availableBitLengths.contains(Integer.valueOf(bitLength))) {
<a class="jxr_linenumber" name="L649" href="#L649">649</a>                             availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(CesecoreConfiguration.getExtraAlgTitle(algName) + <span class="jxr_string">"_"</span> + name,
<a class="jxr_linenumber" name="L650" href="#L650">650</a>                                     CesecoreConfiguration.getExtraAlgSubAlgTitle(algName, subAlg)));
<a class="jxr_linenumber" name="L651" href="#L651">651</a>                         } <strong class="jxr_keyword">else</strong> {
<a class="jxr_linenumber" name="L652" href="#L652">652</a>                             <strong class="jxr_keyword">if</strong> (log.isTraceEnabled()) {
<a class="jxr_linenumber" name="L653" href="#L653">653</a>                                 log.trace(<span class="jxr_string">"Excluding "</span> + name + <span class="jxr_string">" from enrollment options since bit length "</span> + bitLength + <span class="jxr_string">" is not available."</span>);
<a class="jxr_linenumber" name="L654" href="#L654">654</a>                             }
<a class="jxr_linenumber" name="L655" href="#L655">655</a>                         }
<a class="jxr_linenumber" name="L656" href="#L656">656</a>                     }
<a class="jxr_linenumber" name="L657" href="#L657">657</a>                 }
<a class="jxr_linenumber" name="L658" href="#L658">658</a>             }
<a class="jxr_linenumber" name="L659" href="#L659">659</a>             <strong class="jxr_keyword">if</strong> (availableAlgorithmSelectItems.size() &lt; 1) {
<a class="jxr_linenumber" name="L660" href="#L660">660</a>                 availableAlgorithmSelectItems.add(<strong class="jxr_keyword">new</strong> SelectItem(<strong class="jxr_keyword">null</strong>, raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ka_nochoice"</span>), raLocaleBean.getMessage(<span class="jxr_string">"enroll_select_ka_nochoice"</span>), <strong class="jxr_keyword">true</strong>));
<a class="jxr_linenumber" name="L661" href="#L661">661</a>             }
<a class="jxr_linenumber" name="L662" href="#L662">662</a>         }
<a class="jxr_linenumber" name="L663" href="#L663">663</a>         EnrollMakeNewRequestBean.sortSelectItemsByLabel(availableAlgorithmSelectItems);
<a class="jxr_linenumber" name="L664" href="#L664">664</a>         <strong class="jxr_keyword">return</strong> availableAlgorithmSelectItems;
<a class="jxr_linenumber" name="L665" href="#L665">665</a>     }
<a class="jxr_linenumber" name="L666" href="#L666">666</a> 
<a class="jxr_linenumber" name="L667" href="#L667">667</a>     <em class="jxr_comment">//-----------------------------------------------------------------</em>
<a class="jxr_linenumber" name="L668" href="#L668">668</a>     <em class="jxr_comment">//Getters/setters</em>
<a class="jxr_linenumber" name="L669" href="#L669">669</a> 
<a class="jxr_linenumber" name="L670" href="#L670">670</a>     <em class="jxr_javadoccomment">/** @return EEI of current end entity*/</em>
<a class="jxr_linenumber" name="L671" href="#L671">671</a>     <strong class="jxr_keyword">public</strong> EndEntityInformation getEndEntityInformation() {
<a class="jxr_linenumber" name="L672" href="#L672">672</a>         <strong class="jxr_keyword">return</strong> endEntityInformation;
<a class="jxr_linenumber" name="L673" href="#L673">673</a>     }
<a class="jxr_linenumber" name="L674" href="#L674">674</a> 
<a class="jxr_linenumber" name="L675" href="#L675">675</a>     <em class="jxr_javadoccomment">/** @param endEntityInformation EEI to be set*/</em>
<a class="jxr_linenumber" name="L676" href="#L676">676</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setEndEntityInformation(EndEntityInformation endEntityInformation) {
<a class="jxr_linenumber" name="L677" href="#L677">677</a>         <strong class="jxr_keyword">this</strong>.endEntityInformation = endEntityInformation;
<a class="jxr_linenumber" name="L678" href="#L678">678</a>     }
<a class="jxr_linenumber" name="L679" href="#L679">679</a> 
<a class="jxr_linenumber" name="L680" href="#L680">680</a>      <em class="jxr_javadoccomment">/** @return the requestId */</em>
<a class="jxr_linenumber" name="L681" href="#L681">681</a>     <strong class="jxr_keyword">public</strong> String getRequestId() {
<a class="jxr_linenumber" name="L682" href="#L682">682</a>         <strong class="jxr_keyword">return</strong> requestId;
<a class="jxr_linenumber" name="L683" href="#L683">683</a>     }
<a class="jxr_linenumber" name="L684" href="#L684">684</a> 
<a class="jxr_linenumber" name="L685" href="#L685">685</a>     <em class="jxr_javadoccomment">/** @param requestId the requestId to set */</em>
<a class="jxr_linenumber" name="L686" href="#L686">686</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRequestId(String requestId) {
<a class="jxr_linenumber" name="L687" href="#L687">687</a>         <strong class="jxr_keyword">this</strong>.requestId = requestId;
<a class="jxr_linenumber" name="L688" href="#L688">688</a>     }
<a class="jxr_linenumber" name="L689" href="#L689">689</a> 
<a class="jxr_linenumber" name="L690" href="#L690">690</a>     <em class="jxr_javadoccomment">/** @return the request status*/</em>
<a class="jxr_linenumber" name="L691" href="#L691">691</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">int</strong> getRequestStatus() {
<a class="jxr_linenumber" name="L692" href="#L692">692</a>         <strong class="jxr_keyword">return</strong> requestStatus;
<a class="jxr_linenumber" name="L693" href="#L693">693</a>     }
<a class="jxr_linenumber" name="L694" href="#L694">694</a> 
<a class="jxr_linenumber" name="L695" href="#L695">695</a>     <em class="jxr_javadoccomment">/** @param requestStatus the request status to be set*/</em>
<a class="jxr_linenumber" name="L696" href="#L696">696</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setRequestStatus(<strong class="jxr_keyword">int</strong> requestStatus) {
<a class="jxr_linenumber" name="L697" href="#L697">697</a>         <strong class="jxr_keyword">this</strong>.requestStatus = requestStatus;
<a class="jxr_linenumber" name="L698" href="#L698">698</a>     }
<a class="jxr_linenumber" name="L699" href="#L699">699</a> 
<a class="jxr_linenumber" name="L700" href="#L700">700</a>     <em class="jxr_javadoccomment">/** @return key algorithm and size to be used for keystore / certificate enrollment. Format: 'algorithm keysize' */</em>
<a class="jxr_linenumber" name="L701" href="#L701">701</a>     <strong class="jxr_keyword">public</strong> String getSelectedAlgorithm() {
<a class="jxr_linenumber" name="L702" href="#L702">702</a>         <strong class="jxr_keyword">return</strong> selectedAlgorithm;
<a class="jxr_linenumber" name="L703" href="#L703">703</a>     }
<a class="jxr_linenumber" name="L704" href="#L704">704</a> 
<a class="jxr_linenumber" name="L705" href="#L705">705</a>     <em class="jxr_javadoccomment">/** @param selectedAlgorithm sets the algorithm and key size to be used for keystore / certificate enrollment. Format: 'algorithm keysize'*/</em>
<a class="jxr_linenumber" name="L706" href="#L706">706</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setSelectedAlgorithm(String selectedAlgorithm) {
<a class="jxr_linenumber" name="L707" href="#L707">707</a>         <strong class="jxr_keyword">this</strong>.selectedAlgorithm = selectedAlgorithm;
<a class="jxr_linenumber" name="L708" href="#L708">708</a>     }
<a class="jxr_linenumber" name="L709" href="#L709">709</a> 
<a class="jxr_linenumber" name="L710" href="#L710">710</a>     <em class="jxr_javadoccomment">/**</em>
<a class="jxr_linenumber" name="L711" href="#L711">711</a> <em class="jxr_javadoccomment">     * @return the generatedToken (.p12, .jks or .pem without full chain)</em>
<a class="jxr_linenumber" name="L712" href="#L712">712</a> <em class="jxr_javadoccomment">     */</em>
<a class="jxr_linenumber" name="L713" href="#L713">713</a>     <strong class="jxr_keyword">public</strong> byte[] getGeneratedToken() {
<a class="jxr_linenumber" name="L714" href="#L714">714</a>         <strong class="jxr_keyword">return</strong> generatedToken;
<a class="jxr_linenumber" name="L715" href="#L715">715</a>     }
<a class="jxr_linenumber" name="L716" href="#L716">716</a> 
<a class="jxr_linenumber" name="L717" href="#L717">717</a>     <em class="jxr_javadoccomment">/** @param generatedToken byte array of generated token*/</em>
<a class="jxr_linenumber" name="L718" href="#L718">718</a>     <strong class="jxr_keyword">public</strong> <strong class="jxr_keyword">void</strong> setGeneratedToken(byte[] generatedToken) {
<a class="jxr_linenumber" name="L719" href="#L719">719</a>         <strong class="jxr_keyword">this</strong>.generatedToken = generatedToken;
<a class="jxr_linenumber" name="L720" href="#L720">720</a>     }
<a class="jxr_linenumber" name="L721" href="#L721">721</a> 
<a class="jxr_linenumber" name="L722" href="#L722">722</a>     <strong class="jxr_keyword">public</strong> String getPreSetKeyAlgorithm() {
<a class="jxr_linenumber" name="L723" href="#L723">723</a>         <strong class="jxr_keyword">return</strong> endEntityInformation.getExtendedInformation().getKeyStoreAlgorithmType() + <span class="jxr_string">" "</span> + endEntityInformation.getExtendedInformation().getKeyStoreAlgorithmSubType();
<a class="jxr_linenumber" name="L724" href="#L724">724</a>     }
<a class="jxr_linenumber" name="L725" href="#L725">725</a> }
</pre>
<hr/>
<div id="footer">Copyright &#169; 2020. All rights reserved.</div>
</body>
</html>