<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoleMemberData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security JPA Entities</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.roles.member</a> &gt; <span class="el_source">RoleMemberData.java</span></div><h1>RoleMemberData.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/

package org.cesecore.roles.member;

import java.io.Serializable;
import javax.persistence.Entity;
import javax.persistence.PostLoad;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;
import javax.persistence.Transient;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.builder.CompareToBuilder;
import org.cesecore.dbprotection.ProtectedData;
import org.cesecore.dbprotection.ProtectionStringBuilder;

/**
 * Entity bean for Role members. Does not correspond to a physical entity, but
 * rather to an individual credential linked to an entity. The same individuals
 * may share the same credential (such as belonging to the same organization, or
 * sharing an account, while one individual may have access to several
 * credentials (such as a user using several different certificates for
 * identification depending on location).
 *
 * &lt;p&gt;Each member is linked to a Role, though not intrinsically so via foreign
 * keys
 *
 * @version $Id: RoleMemberData.java 25634 2017-04-03 12:02:08Z jeklund $
 */
@Entity
@Table(name = &quot;RoleMemberData&quot;)
public class RoleMemberData extends ProtectedData
    implements Serializable, Comparable&lt;RoleMemberData&gt; {

  private static final long serialVersionUID = 1L;

  /** Param. */
  private int primaryKey;

  /** Param. */
  private String tokenType;
  /** Param. */
  private int tokenIssuerId;
  /** Param. */
  private int tokenMatchKey;
  /** Param. */
  private int tokenMatchOperator;
  /** Param. */
  private String tokenMatchValueColumn;
  /** Param. */
  private int roleId;
  /** Param. */
  private String descriptionColumn;

  /** Param. */
<span class="nc" id="L67">  private int rowVersion = 0;</span>
  /** Param. */
  private String rowProtection;

  /** Null constructor. */
<span class="nc" id="L72">  public RoleMemberData()  { }</span>

  /**
   * Construct the object from RoleMember value object.
   *
   * @param roleMember member
   */
<span class="nc" id="L79">  public RoleMemberData(final RoleMember roleMember) {</span>
<span class="nc" id="L80">    setPrimaryKey(roleMember.getId());</span>
<span class="nc" id="L81">    updateValuesFromValueObject(roleMember);</span>
<span class="nc" id="L82">  }</span>

  /**
   * Slightly more verbose constructor used for upgrades.
   *
   * @param aPrimaryKey the primary key for this object. It's required to check
   *     the database for any objects with the same key, otherwise that object
   *     will be overridden
   * @param aTokenType a string which defined the implementation of
   *     AcceessMatchValue used by this member
   * @param aTokenIssuerId the issuer of token if relevant or 0
   *     (RoleMember.NO_ISSUER) otherwise
   * @param aTokenMatchKey the integer value determining how to interpret the
   *     tokenMatchValue, defined in a class that inherits the interface
   *     AcceessMatchValue
   * @param aTokenMatchOperator how to perform the match. 0
   *     (AccessMatchType.UNUSED.getNumericValue())to let the determine this
   *     from tokenSubType.
   * @param tokenMatchValue the actual value with which to match
   * @param aRoleId the ID of the role to which this member
   * belongs. May be null.
   * @param description a human readable description of this role member. Null
   *     will be treated as an empty String.
   */
  public RoleMemberData(
      final int aPrimaryKey,
      final String aTokenType,
      final int aTokenIssuerId,
      final int aTokenMatchKey,
      final int aTokenMatchOperator,
      final String tokenMatchValue,
      final int aRoleId,
<span class="nc" id="L114">      final String description) {</span>
<span class="nc" id="L115">    this.primaryKey = aPrimaryKey;</span>
<span class="nc" id="L116">    this.tokenType = aTokenType;</span>
<span class="nc" id="L117">    this.tokenIssuerId = aTokenIssuerId;</span>
<span class="nc" id="L118">    this.tokenMatchKey = aTokenMatchKey;</span>
<span class="nc" id="L119">    this.tokenMatchOperator = aTokenMatchOperator;</span>
<span class="nc" id="L120">    this.tokenMatchValueColumn = tokenMatchValue;</span>
<span class="nc" id="L121">    this.roleId = aRoleId;</span>
<span class="nc" id="L122">    this.setDescription(description);</span>
<span class="nc" id="L123">  }</span>

  /** @return the primary key of this entity bean, a pseudo-random integer */
  public int getPrimaryKey() {
<span class="nc" id="L127">    return primaryKey;</span>
  }

  /**
   * @param aPrimaryKey PK
   */
  public void setPrimaryKey(final int aPrimaryKey) {
<span class="nc" id="L134">    this.primaryKey = aPrimaryKey;</span>
<span class="nc" id="L135">  }</span>

  /**
   * @return the authentication token type that this member identifies to (such
   *     as X509CertificateAuthenticationToken)
   */
  public String getTokenType() {
<span class="nc" id="L142">    return tokenType;</span>
  }

  /**
   * @param aTokenType type
   */
  public void setTokenType(final String aTokenType) {
<span class="nc" id="L149">    this.tokenType = aTokenType;</span>
<span class="nc" id="L150">  }</span>

  /**
   * @return issuer identifier of this token or 0 (RoleMember.NO_ISSUER) if this
   *     is not relevant for this token type
   */
  public int getTokenIssuerId() {
<span class="nc" id="L157">    return tokenIssuerId;</span>
  }

  /**
   * @param aTokenIssuerId ID
   */
  public void setTokenIssuerId(final int aTokenIssuerId) {
<span class="nc" id="L164">    this.tokenIssuerId = aTokenIssuerId;</span>
<span class="nc" id="L165">  }</span>

  /**
   * @return the match value type with to match, i.e. CN, serial number, or
   *     username
   */
  public int getTokenMatchKey() {
<span class="nc" id="L172">    return tokenMatchKey;</span>
  }

  /**
   * @param aTokenMatchKey key
   */
  public void setTokenMatchKey(final int aTokenMatchKey) {
<span class="nc" id="L179">    this.tokenMatchKey = aTokenMatchKey;</span>
<span class="nc" id="L180">  }</span>

  /** @return what kind of operator to apply to the match value */
  public int getTokenMatchOperator() {
<span class="nc" id="L184">    return tokenMatchOperator;</span>
  }

  /**
   * @param aTokenMatchOperator Op
   */
  public void setTokenMatchOperator(final int aTokenMatchOperator) {
<span class="nc" id="L191">    this.tokenMatchOperator = aTokenMatchOperator;</span>
<span class="nc" id="L192">  }</span>

  // @Column(name=&quot;tokenMatchValue&quot;)
  /** @return column
 * @deprecated (Only for database mapping) {@link #getTokenMatchValue()} */
  @Deprecated
  public String getTokenMatchValueColumn() {
<span class="nc" id="L199">    return tokenMatchValueColumn;</span>
  }


  /**
   * @param aTokenMatchValueColumn column
 * @deprecated (Only for database mapping) {@link #setTokenMatchValue(String)}
   */
  @Deprecated
  public void setTokenMatchValueColumn(final String aTokenMatchValueColumn) {
<span class="nc" id="L209">    this.tokenMatchValueColumn = aTokenMatchValueColumn;</span>
<span class="nc" id="L210">  }</span>

  /** @return the actual value with which we match (never returns null) */
  @Transient
  public String getTokenMatchValue() {
<span class="nc" id="L215">    return StringUtils.defaultIfEmpty(getTokenMatchValueColumn(), &quot;&quot;);</span>
  }

  /**
   * @param tokenMatchValue value
   */
  @Transient
  public void setTokenMatchValue(final String tokenMatchValue) {
<span class="nc" id="L223">    this.setTokenMatchValueColumn(</span>
<span class="nc" id="L224">        StringUtils.defaultIfEmpty(tokenMatchValue, null));</span>
<span class="nc" id="L225">  }</span>

  /**
   * @return the role to which this member belongs or 0 if it is not assigned to
   *     a role.
   */
  public int getRoleId() {
<span class="nc" id="L232">    return roleId;</span>
  }

  /**
   * @param aRoleId ID
   */
  public void setRoleId(final int aRoleId) {
<span class="nc" id="L239">    this.roleId = aRoleId;</span>
<span class="nc" id="L240">  }</span>

  // @Column(name=&quot;description&quot;)
  /** @return column
 * @deprecated (Only for database mapping) {@link #getDescription()} */
  @Deprecated
  public String getDescriptionColumn() {
<span class="nc" id="L247">    return descriptionColumn;</span>
  }


  /** @param aDescriptionColumn column
 * @deprecated (Only for database mapping) {@link #setDescription(String)}.
   */
  @Deprecated
  public void setDescriptionColumn(final String aDescriptionColumn) {
<span class="nc" id="L256">    this.descriptionColumn = aDescriptionColumn;</span>
<span class="nc" id="L257">  }</span>


  /** @return a human readable description of the role member */
  @Transient
  public String getDescription() {
<span class="nc" id="L263">    return StringUtils.defaultIfEmpty(getDescriptionColumn(), &quot;&quot;);</span>
  }

  /**
   * @param description desc
   */
  @Transient
  public void setDescription(final String description) {
<span class="nc" id="L271">    this.setDescriptionColumn(StringUtils.defaultIfEmpty(description, null));</span>
<span class="nc" id="L272">  }</span>

  /**
   * @return version
   */
  public int getRowVersion() {
<span class="nc" id="L278">    return rowVersion;</span>
  }

  /**
   * @param aRowVersion version
   */
  public void setRowVersion(final int aRowVersion) {
<span class="nc" id="L285">    this.rowVersion = aRowVersion;</span>
<span class="nc" id="L286">  }</span>

  /** @return the row integrity protection String */
  public String getRowProtection() {
<span class="nc" id="L290">    return getZzzRowProtection();</span>
  }

  /**
   *  @param aRowProtection protection
   */
  public void setRowProtection(final String aRowProtection) {
<span class="nc" id="L297">    this.setZzzRowProtection(aRowProtection);</span>
<span class="nc" id="L298">  }</span>

  /**
   * Horrible work-around due to the fact that Oracle needs to have (LONG and)
   * CLOB values last in order to avoid ORA-24816.
   *
   * &lt;p&gt;Since Hibernate sorts columns by the property names, naming this
   * Z-something will apparently ensure that this column is used last.
   *
   * @return string
   * @deprecated Use {@link #getRowProtection()} instead
   */
  @Deprecated
  public String getZzzRowProtection() {
<span class="nc" id="L312">    return rowProtection;</span>
  }
  /**
   * @param zzzRowProtection string
   * @deprecated Use {@link #setRowProtection(String)} instead
   */
  @Deprecated
  public void setZzzRowProtection(final String zzzRowProtection) {
<span class="nc" id="L320">    this.rowProtection = zzzRowProtection;</span>
<span class="nc" id="L321">  }</span>

  // Start Database integrity protection methods
  @Transient
  @Override
  protected String getProtectString(final int version) {
<span class="nc" id="L327">    final ProtectionStringBuilder build = new ProtectionStringBuilder();</span>
    // What is important to protect here is the data that we define
    // rowVersion is automatically updated by JPA, so it's not important, it is
    // only used for optimistic locking
<span class="nc" id="L331">    build</span>
<span class="nc" id="L332">        .append(getPrimaryKey())</span>
<span class="nc" id="L333">        .append(getTokenType())</span>
<span class="nc" id="L334">        .append(getTokenIssuerId())</span>
<span class="nc" id="L335">        .append(getTokenMatchKey())</span>
<span class="nc" id="L336">        .append(getTokenMatchOperator())</span>
<span class="nc" id="L337">        .append(getTokenMatchValue())</span>
<span class="nc" id="L338">        .append(getRoleId())</span>
<span class="nc" id="L339">        .append(getDescription());</span>
<span class="nc" id="L340">    return build.toString();</span>
  }

  @Transient
  @Override
  protected int getProtectVersion() {
<span class="nc" id="L346">    return 1;</span>
  }

  @PrePersist
  @PreUpdate
  @Override
  protected void protectData() {
<span class="nc" id="L353">    super.protectData();</span>
<span class="nc" id="L354">  }</span>

  @PostLoad
  @Override
  protected void verifyData() {
<span class="nc" id="L359">    super.verifyData();</span>
<span class="nc" id="L360">  }</span>

  @Override
  @Transient
  protected String getRowId() {
<span class="nc" id="L365">    return String.valueOf(getPrimaryKey());</span>
  }

  //
  // End Database integrity protection methods
  //

  @Override
  public int compareTo(final RoleMemberData o) {
<span class="nc" id="L374">    return new CompareToBuilder()</span>
<span class="nc" id="L375">        .append(this.tokenType, o.tokenType)</span>
<span class="nc" id="L376">        .append(this.tokenIssuerId, o.tokenIssuerId)</span>
<span class="nc" id="L377">        .append(this.tokenMatchKey, o.tokenMatchKey)</span>
<span class="nc" id="L378">        .append(this.tokenMatchOperator, o.tokenMatchOperator)</span>
<span class="nc" id="L379">        .append(this.tokenMatchValueColumn, o.tokenMatchValueColumn)</span>
<span class="nc" id="L380">        .toComparison();</span>
  }

  /**
   * @return member
   */
  @Transient
  public RoleMember asValueObject() {
<span class="nc" id="L388">    return new RoleMember(</span>
        primaryKey,
        tokenType,
        tokenIssuerId,
        tokenMatchKey,
        tokenMatchOperator,
<span class="nc" id="L394">        getTokenMatchValue(),</span>
        roleId,
<span class="nc" id="L396">        getDescription());</span>
  }

  /**
   * Sets all fields except the ID.
   *
   * @param roleMember member
   */
  @Transient
  public void updateValuesFromValueObject(final RoleMember roleMember) {
<span class="nc" id="L406">    setTokenType(roleMember.getTokenType());</span>
<span class="nc" id="L407">    setTokenIssuerId(roleMember.getTokenIssuerId());</span>
<span class="nc" id="L408">    setTokenMatchKey(roleMember.getTokenMatchKey());</span>
<span class="nc" id="L409">    setTokenMatchOperator(roleMember.getTokenMatchOperator());</span>
<span class="nc" id="L410">    setTokenMatchValue(roleMember.getTokenMatchValue());</span>
<span class="nc" id="L411">    setRoleId(roleMember.getRoleId());</span>
<span class="nc" id="L412">    setDescription(roleMember.getDescription());</span>
<span class="nc" id="L413">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>