<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CertificateData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security JPA Entities</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.certificates.certificate</a> &gt; <span class="el_source">CertificateData.java</span></div><h1>CertificateData.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.certificates.certificate;

import java.io.Serializable;
import java.security.PublicKey;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.util.Date;
import java.util.List;
import javax.persistence.ColumnResult;
import javax.persistence.Entity;
import javax.persistence.EntityManager;
import javax.persistence.PostLoad;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Query;
import javax.persistence.SqlResultSetMapping;
import javax.persistence.SqlResultSetMappings;
import javax.persistence.Table;
import javax.persistence.Transient;
import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.cesecore.certificates.crl.RevokedCertInfo;
import org.cesecore.dbprotection.ProtectionStringBuilder;
import org.cesecore.keys.util.KeyTools;
import org.cesecore.util.Base64;
import org.cesecore.util.CertTools;
import org.cesecore.util.StringTools;

/**
 * Representation of a certificate and related information.
 *
 * @version $Id: CertificateData.java 30355 2018-11-01 15:54:35Z samuellb $
 */
@Entity
@Table(name = &quot;CertificateData&quot;)
@SqlResultSetMappings(
    value = {
      @SqlResultSetMapping(
          name = &quot;RevokedCertInfoSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;serialNumber&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;CertificateInfoSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;issuerDN&quot;),
            @ColumnResult(name = &quot;subjectDN&quot;),
            @ColumnResult(name = &quot;cAFingerprint&quot;),
            @ColumnResult(name = &quot;status&quot;),
            @ColumnResult(name = &quot;type&quot;),
            @ColumnResult(name = &quot;serialNumber&quot;),
            @ColumnResult(name = &quot;notBefore&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;),
            @ColumnResult(name = &quot;username&quot;),
            @ColumnResult(name = &quot;tag&quot;),
            @ColumnResult(name = &quot;certificateProfileId&quot;),
            @ColumnResult(name = &quot;endEntityProfileId&quot;),
            @ColumnResult(name = &quot;updateTime&quot;),
            @ColumnResult(name = &quot;subjectKeyId&quot;),
            @ColumnResult(name = &quot;subjectAltName&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;CertificateInfoSubset2&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;subjectDN&quot;),
            @ColumnResult(name = &quot;cAFingerprint&quot;),
            @ColumnResult(name = &quot;status&quot;),
            @ColumnResult(name = &quot;type&quot;),
            @ColumnResult(name = &quot;notBefore&quot;),
            @ColumnResult(name = &quot;expireDate&quot;),
            @ColumnResult(name = &quot;revocationDate&quot;),
            @ColumnResult(name = &quot;revocationReason&quot;),
            @ColumnResult(name = &quot;username&quot;),
            @ColumnResult(name = &quot;tag&quot;),
            @ColumnResult(name = &quot;certificateProfileId&quot;),
            @ColumnResult(name = &quot;endEntityProfileId&quot;),
            @ColumnResult(name = &quot;updateTime&quot;),
            @ColumnResult(name = &quot;subjectKeyId&quot;),
            @ColumnResult(name = &quot;subjectAltName&quot;)
          }),
      @SqlResultSetMapping(
          name = &quot;FingerprintUsernameSubset&quot;,
          columns = {
            @ColumnResult(name = &quot;fingerprint&quot;),
            @ColumnResult(name = &quot;username&quot;)
          })
    })
public class CertificateData extends BaseCertificateData
    implements Serializable {

  private static final long serialVersionUID = -8493105317760641442L;

  /** Logger. */
<span class="nc" id="L113">  private static final Logger LOG = Logger.getLogger(CertificateData.class);</span>
  /** Param. */
  private String issuerDN;
  /** Param. */
  private String subjectDN;
  /** Param. */
<span class="nc" id="L119">  private String subjectAltName = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L121">  private String fingerprint = &quot;&quot;;</span>
  /** Param. */
  private String cAFingerprint;
  /** Param. */
<span class="nc" id="L125">  private int status = 0;</span>
  /** Param. */
<span class="nc" id="L127">  private int type = 0;</span>
  /** Param. */
  private String serialNumber;
  /** Param. */
<span class="nc" id="L131">  private Long notBefore = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L133">  private long expireDate = 0;</span>
  /** Param. */
<span class="nc" id="L135">  private long revocationDate = 0;</span>
  /** Param. */
<span class="nc" id="L137">  private int revocationReason = 0;</span>
  /** Param. */
  private String base64Cert;
  /** Param. */
  private String username;
  /** Param. */
  private String tag;
  /** Param. */
  private Integer certificateProfileId;
  /** Param. */
<span class="nc" id="L147">  private Integer endEntityProfileId = null; // @since EJBCA 6.6.0</span>
  /** Param. */
<span class="nc" id="L149">  private long updateTime = 0;</span>
  /** Param. */
  private String subjectKeyId;
  /** Param. */
<span class="nc" id="L153">  private int rowVersion = 0;</span>
  /** Protect. */
  private String rowProtection;

  /**
   * Entity holding info about a certificate. Create by sending in the
   * certificate, which extracts (from the cert) fingerprint (primary key),
   * subjectDN, issuerDN, serial number, expiration date. Status, Type,
   * CAFingerprint, revocationDate and revocationReason are set to default
   * values (CERT_UNASSIGNED, USER_INVALID, null, null and
   * REVOCATION_REASON_UNSPECIFIED) and should be set using the respective
   * set-methods.
   *
   * &lt;p&gt;NOTE! Never use this constructor without considering the
   * useBase64CertTable below!
   *
   * @param certificate the (X509)Certificate to be stored in the database. If
   *     the property &quot;database.useSeparateCertificateTable&quot; is true then it
   *     should be null.
   * @param enrichedpubkey possibly an EC public key enriched with the full set
   *     of parameters, if the public key in the certificate does not have
   *     parameters. Can be null if RSA or certificate public key contains all
   *     parameters.
   * @param aUsername the username in UserData to map the certificate to
   * @param cafp CA certificate fingerprint, can be null
   * @param aStatus status of the certificate, active, revoked etcc, i.e.
   *     CertificateConstants.CERT_ACTIVE etc
   * @param aType the user type the certificate belongs to, i.e.
   *     EndEntityTypes.USER_ENDUSER etc
   * @param certprofileid certificate profile id, can be 0 for &quot;no profile&quot;
   * @param anEndEntityProfileId end entity profile id, can be 0
   *         for &quot;no profile&quot;
   * @param aTag a custom tag to map the certificate to any custom defined tag
   * @param updatetime the time the certificate was updated in the database,
   *     i.e. System.currentTimeMillis().
   * @param storeCertificate true if the certificate should be stored in this
   *     table in the base64Cert column, false if certificate data isn't to be
   *     stored in this table. NOTE: If false and the data should be stored in
   *     Base64CertData then the caller must store the certificate in
   *     Base64CertData as well.
   * @param storeSubjectAltName true if the subjectAltName column should be
   *     populated with the Subject Alternative Name of the certificate
   */
  public CertificateData(
      final Certificate certificate,
      final PublicKey enrichedpubkey,
      final String aUsername,
      final String cafp,
      final int aStatus,
      final int aType,
      final int certprofileid,
      final int anEndEntityProfileId,
      final String aTag,
      final long updatetime,
      final boolean storeCertificate,
<span class="nc" id="L208">      final boolean storeSubjectAltName) {</span>
    // Extract all fields to store with the certificate.
    try {
<span class="nc bnc" id="L211" title="All 2 branches missed.">      if (storeCertificate) {</span>
<span class="nc" id="L212">        setBase64Cert(new String(Base64.encode(certificate.getEncoded())));</span>
      }

<span class="nc" id="L215">      String fp = CertTools.getFingerprintAsString(certificate);</span>
<span class="nc" id="L216">      setFingerprint(fp);</span>

      // Make sure names are always looking the same
<span class="nc" id="L219">      setSubjectDN(CertTools.getSubjectDN(certificate));</span>
<span class="nc" id="L220">      setIssuerDN(CertTools.getIssuerDN(certificate));</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">      if (storeSubjectAltName) {</span>
<span class="nc" id="L222">        setSubjectAltName(CertTools.getSubjectAlternativeName(certificate));</span>
      }
<span class="nc bnc" id="L224" title="All 2 branches missed.">      if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L225">        LOG.debug(</span>
            &quot;Creating CertificateData, subjectDN=&quot;
<span class="nc" id="L227">                + getSubjectDnNeverNull()</span>
                + &quot;, subjectAltName=&quot;
<span class="nc" id="L229">                + getSubjectAltNameNeverNull()</span>
                + &quot;, issuer=&quot;
<span class="nc" id="L231">                + getIssuerDN()</span>
                + &quot;, fingerprint=&quot;
                + fp
                + &quot;, storeSubjectAltName=&quot;
                + storeSubjectAltName);
      }
<span class="nc" id="L237">      setSerialNumber(CertTools.getSerialNumber(certificate).toString());</span>

<span class="nc" id="L239">      setUsername(aUsername);</span>
      // Values for status and type
<span class="nc" id="L241">      setStatus(aStatus);</span>
<span class="nc" id="L242">      setType(aType);</span>
<span class="nc" id="L243">      setCaFingerprint(cafp);</span>
<span class="nc" id="L244">      final Date aNotBefore = CertTools.getNotBefore(certificate);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if (aNotBefore == null) {</span>
<span class="nc" id="L246">        setNotBefore(null);</span>
      } else {
<span class="nc" id="L248">        setNotBefore(aNotBefore.getTime());</span>
      }
<span class="nc" id="L250">      setExpireDate(CertTools.getNotAfter(certificate));</span>
<span class="nc" id="L251">      setRevocationDate(-1L);</span>
<span class="nc" id="L252">      setRevocationReason(RevokedCertInfo.NOT_REVOKED);</span>
<span class="nc" id="L253">      setUpdateTime(updatetime); // (new Date().getTime());</span>
<span class="nc" id="L254">      setCertificateProfileId(certprofileid);</span>
<span class="nc" id="L255">      setEndEntityProfileId(Integer.valueOf(anEndEntityProfileId));</span>
      // Create a key identifier
<span class="nc" id="L257">      PublicKey pubk = certificate.getPublicKey();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      if (enrichedpubkey != null) {</span>
<span class="nc" id="L259">        pubk = enrichedpubkey;</span>
      }
      // Creating the KeyId may just throw an exception, we will log this but
      // store the cert and ignore the error
<span class="nc" id="L263">      String keyId = null;</span>
      try {
<span class="nc" id="L265">        keyId =</span>
            new String(
<span class="nc" id="L267">                Base64.encode(</span>
<span class="nc" id="L268">                    KeyTools.createSubjectKeyId(pubk).getKeyIdentifier(),</span>
                    false));
<span class="nc" id="L270">      } catch (Exception e) {</span>
<span class="nc" id="L271">        LOG.warn(</span>
            &quot;Error creating subjectKeyId for certificate with fingerprint '&quot;
                + fp
                + &quot;: &quot;,
            e);
<span class="nc" id="L276">      }</span>
<span class="nc" id="L277">      setSubjectKeyId(keyId);</span>
<span class="nc" id="L278">      setTag(aTag);</span>
<span class="nc" id="L279">    } catch (CertificateEncodingException cee) {</span>
<span class="nc" id="L280">      final String msg = &quot;Can't extract DER encoded certificate information.&quot;;</span>
<span class="nc" id="L281">      LOG.error(msg, cee);</span>
<span class="nc" id="L282">      throw new RuntimeException(msg);</span>
<span class="nc" id="L283">    }</span>
<span class="nc" id="L284">  }</span>

  /**
   * Copy Constructor.
   *
   * @param copy data
   */
<span class="nc" id="L291">  public CertificateData(final BaseCertificateData copy) {</span>
<span class="nc" id="L292">    setBase64Cert(copy.getBase64Cert());</span>
<span class="nc" id="L293">    setFingerprint(copy.getFingerprint());</span>
<span class="nc" id="L294">    setSubjectDN(copy.getSubjectDN());</span>
<span class="nc" id="L295">    setIssuerDN(copy.getIssuerDN());</span>
<span class="nc" id="L296">    setSubjectAltName(copy.getSubjectAltName());</span>
<span class="nc" id="L297">    setSerialNumber(copy.getSerialNumber());</span>
<span class="nc" id="L298">    setUsername(copy.getUsername());</span>
<span class="nc" id="L299">    setStatus(copy.getStatus());</span>
<span class="nc" id="L300">    setType(copy.getType());</span>
<span class="nc" id="L301">    setCaFingerprint(copy.getCaFingerprint());</span>
<span class="nc" id="L302">    setNotBefore(copy.getNotBefore());</span>
<span class="nc" id="L303">    setExpireDate(copy.getExpireDate());</span>
<span class="nc" id="L304">    setRevocationDate(copy.getRevocationDate());</span>
<span class="nc" id="L305">    setRevocationReason(copy.getRevocationReason());</span>
<span class="nc" id="L306">    setUpdateTime(copy.getUpdateTime());</span>
<span class="nc" id="L307">    setCertificateProfileId(copy.getCertificateProfileId());</span>
<span class="nc" id="L308">    setEndEntityProfileId(copy.getEndEntityProfileId());</span>
<span class="nc" id="L309">    setSubjectKeyId(copy.getSubjectKeyId());</span>
<span class="nc" id="L310">    setTag(copy.getTag());</span>
<span class="nc" id="L311">    setRowVersion(copy.getRowVersion());</span>
<span class="nc" id="L312">    setRowProtection(copy.getRowProtection());</span>
<span class="nc" id="L313">  }</span>

  /** Null constructor. */
<span class="nc" id="L316">  public CertificateData() { }</span>

  @Override
  public String getFingerprint() {
<span class="nc" id="L320">    return fingerprint;</span>
  }

  @Override
  public void setFingerprint(final String aFingerprint) {
<span class="nc" id="L325">    this.fingerprint = aFingerprint;</span>
<span class="nc" id="L326">  }</span>

  @Override
  public String getIssuerDN() {
<span class="nc" id="L330">    return issuerDN;</span>
  }

  @Override
  public void setIssuerDN(final String anIssuerDN) {
<span class="nc" id="L335">    this.issuerDN = anIssuerDN;</span>
<span class="nc" id="L336">  }</span>

  @Override
  public String getSubjectDN() {
<span class="nc" id="L340">    return subjectDN;</span>
  }

  /**
   * Use setSubject instead.
   *
   * @param aSubjectDN subject dn
   * @see #setSubject(String)
   */
  public void setSubjectDN(final String aSubjectDN) {
<span class="nc" id="L350">    this.subjectDN = aSubjectDN;</span>
<span class="nc" id="L351">  }</span>

  /**
   * @return Subject Alternative Name from the certificate if it was saved at
   *     the time of issuance.
   */
  @Transient
  public String getSubjectAltNameNeverNull() {
<span class="nc" id="L359">    final String aSubjectAltName = getSubjectAltName();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">    return aSubjectAltName == null ? &quot;&quot; : aSubjectAltName;</span>
  }

  @Override
  public String getSubjectAltName() {
<span class="nc" id="L365">    return subjectAltName;</span>
  }

  /**
   * @param aSubjectAltName Name
   */
  public void setSubjectAltName(final String aSubjectAltName) {
<span class="nc" id="L372">    this.subjectAltName = aSubjectAltName;</span>
<span class="nc" id="L373">  }</span>

  @Override
  public String getCaFingerprint() {
<span class="nc" id="L377">    return cAFingerprint;</span>
  }

  @Override
  public void setCaFingerprint(final String aCAFingerprint) {
<span class="nc" id="L382">    this.cAFingerprint = aCAFingerprint;</span>
<span class="nc" id="L383">  }</span>

  @Override
  public int getStatus() {
<span class="nc" id="L387">    return status;</span>
  }

  @Override
  public void setStatus(final int aStatus) {
<span class="nc" id="L392">    this.status = aStatus;</span>
<span class="nc" id="L393">  }</span>

  @Override
  public int getType() {
<span class="nc" id="L397">    return type;</span>
  }

  @Override
  public void setType(final int aType) {
<span class="nc" id="L402">    this.type = aType;</span>
<span class="nc" id="L403">  }</span>

  @Override
  public String getSerialNumber() {
<span class="nc" id="L407">    return serialNumber;</span>
  }

  @Override
  public void setSerialNumber(final String aSerialNumber) {
<span class="nc" id="L412">    this.serialNumber = aSerialNumber;</span>
<span class="nc" id="L413">  }</span>

  @Override
  public Long getNotBefore() {
<span class="nc" id="L417">    return notBefore;</span>
  }

  /**
   * @param aNotBefore start
   */
  public void setNotBefore(final Long aNotBefore) {
<span class="nc" id="L424">    this.notBefore = aNotBefore;</span>
<span class="nc" id="L425">  }</span>

  @Override
  public long getExpireDate() {
<span class="nc" id="L429">    return expireDate;</span>
  }

  @Override
  public void setExpireDate(final long anExpireDate) {
<span class="nc" id="L434">    this.expireDate = anExpireDate;</span>
<span class="nc" id="L435">  }</span>

  @Override
  public long getRevocationDate() {
<span class="nc" id="L439">    return revocationDate;</span>
  }

  @Override
  public void setRevocationDate(final long aRevocationDate) {
<span class="nc" id="L444">    this.revocationDate = aRevocationDate;</span>
<span class="nc" id="L445">  }</span>

  @Override
  public int getRevocationReason() {
<span class="nc" id="L449">    return revocationReason;</span>
  }

  @Override
  public void setRevocationReason(final int aRevocationReason) {
<span class="nc" id="L454">    this.revocationReason = aRevocationReason;</span>
<span class="nc" id="L455">  }</span>

  @Override
  public String getBase64Cert() {
<span class="nc" id="L459">    return this.getZzzBase64Cert();</span>
  }

  /**
   * The certificate itself.
   *
   * @param aBase64Cert base64 encoded certificate
   */
  public void setBase64Cert(final String aBase64Cert) {
<span class="nc" id="L468">    this.setZzzBase64Cert(aBase64Cert);</span>
<span class="nc" id="L469">  }</span>

  /**
   * Horrible work-around due to the fact that Oracle needs to have (LONG and)
   * CLOB values last in order to avoid ORA-24816.
   *
   * &lt;p&gt;Since Hibernate sorts columns by the property names, naming this
   * Z-something will apparently ensure that this column is used last.
   *
   * @return string
   * @deprecated Use {@link #getBase64Cert()} instead
   */
  @Deprecated
  public String getZzzBase64Cert() {
<span class="nc" id="L483">    return base64Cert;</span>
  }

  /**
   * @param zzzBase64Cert string
   * @deprecated Use {@link #setBase64Cert(String)} instead
   */
  @Deprecated
  public void setZzzBase64Cert(final String zzzBase64Cert) {
<span class="nc" id="L492">    this.base64Cert = zzzBase64Cert;</span>
<span class="nc" id="L493">  }</span>

  @Override
  public String getUsername() {
<span class="nc" id="L497">    return username;</span>
  }

  @Override
  public void setUsername(final String aUsername) {
<span class="nc" id="L502">    this.username = StringTools.stripUsername(aUsername);</span>
<span class="nc" id="L503">  }</span>

  @Override
  public String getTag() {
<span class="nc" id="L507">    return tag;</span>
  }

  /**
   * tag in database. This field was added for the 3.9.0 release, but is not
   * used yet.
   *
   * @param aTag tag
   */
  public void setTag(final String aTag) {
<span class="nc" id="L517">    this.tag = aTag;</span>
<span class="nc" id="L518">  }</span>

  @Override
  public Integer getCertificateProfileId() {
<span class="nc" id="L522">    return certificateProfileId;</span>
  }

  @Override
  public void setCertificateProfileId(final Integer aCertificateProfileId) {
<span class="nc" id="L527">    this.certificateProfileId = aCertificateProfileId;</span>
<span class="nc" id="L528">  }</span>

  @Override
  public Long getUpdateTime() {
<span class="nc" id="L532">    return updateTime;</span>
  }

  // Hibernate + Oracle ignores nullable=false so we can expect null-objects as
  // input after upgrade. TODO: Verify if still true!
  @Override
  public void setUpdateTime(final Long anUpdateTime) {
<span class="nc bnc" id="L539" title="All 2 branches missed.">    this.updateTime = (anUpdateTime == null ? this.updateTime : anUpdateTime);</span>
<span class="nc" id="L540">  }</span>

  @Override
  public String getSubjectKeyId() {
<span class="nc" id="L544">    return subjectKeyId;</span>
  }

  /**
   * The ID of the public key of the certificate.
   *
   * @param aSubjectKeyId ID
   */
  public void setSubjectKeyId(final String aSubjectKeyId) {
<span class="nc" id="L553">    this.subjectKeyId = aSubjectKeyId;</span>
<span class="nc" id="L554">  }</span>

  @Override
  public int getRowVersion() {
<span class="nc" id="L558">    return rowVersion;</span>
  }

  /**
   * @param aRowVersion cversion
   */
  public void setRowVersion(final int aRowVersion) {
<span class="nc" id="L565">    this.rowVersion = aRowVersion;</span>
<span class="nc" id="L566">  }</span>

  @Override
  public String getRowProtection() {
<span class="nc" id="L570">    return this.getZzzRowProtection();</span>
  }

  @Override
  public void setRowProtection(final String aRowProtection) {
<span class="nc" id="L575">    this.setZzzRowProtection(aRowProtection);</span>
<span class="nc" id="L576">  }</span>

  /**
   * Horrible work-around due to the fact that Oracle needs to have (LONG and)
   * CLOB values last in order to avoid ORA-24816.
   *
   * &lt;p&gt;Since Hibernate sorts columns by the property names, naming this
   * Z-something will apparently ensure that this column is used last.
   *
   * @return String
   * @deprecated Use {@link #getRowProtection()} instead
   */
  @Deprecated
  public String getZzzRowProtection() {
<span class="nc" id="L590">    return rowProtection;</span>
  }

  /**
   * @param zzzRowProtection String
   * @deprecated Use {@link #setRowProtection(String)} instead
   */
  @Deprecated
  public void setZzzRowProtection(final String zzzRowProtection) {
<span class="nc" id="L599">    this.rowProtection = zzzRowProtection;</span>
<span class="nc" id="L600">  }</span>

  //
  // Public business methods used to help us manage certificates
  //

  @Override
  public void setIssuer(final String dn) {
<span class="nc" id="L608">    setIssuerDN(CertTools.stringToBCDNString(dn));</span>
<span class="nc" id="L609">  }</span>

  @Override
  public void setSubject(final String dn) {
<span class="nc" id="L613">    setSubjectDN(CertTools.stringToBCDNString(dn));</span>
<span class="nc" id="L614">  }</span>

  @Override
  public void setEndEntityProfileId(final Integer anEndEntityProfileId) {
<span class="nc" id="L618">    this.endEntityProfileId = anEndEntityProfileId;</span>
<span class="nc" id="L619">  }</span>

  @Override
  public Integer getEndEntityProfileId() {
<span class="nc" id="L623">    return endEntityProfileId;</span>
  }

  // Comparators

  @Override
  public boolean equals(final Object obj) {
<span class="nc bnc" id="L630" title="All 2 branches missed.">    if (!(obj instanceof CertificateData)) {</span>
<span class="nc" id="L631">      return false;</span>
    }
<span class="nc" id="L633">    return equals((CertificateData) obj, true);</span>
  }

  /**
   * @param certificateData data
   * @param mode mode
   * @param strictStatus Status
   * @return bool
   */
  public boolean equals(
      final CertificateData certificateData,
      final boolean mode,
      final boolean strictStatus) {
<span class="nc bnc" id="L646" title="All 2 branches missed.">    if (mode) {</span>
<span class="nc" id="L647">      return equalsNonSensitive(certificateData, strictStatus);</span>
    }
<span class="nc" id="L649">    return equals(certificateData, strictStatus);</span>
  }

  private boolean equals(
      final CertificateData certificateData, final boolean strictStatus) {
<span class="nc bnc" id="L654" title="All 2 branches missed.">    if (!equalsNonSensitive(certificateData, strictStatus)) {</span>
<span class="nc" id="L655">      return false;</span>
    }
<span class="nc bnc" id="L657" title="All 4 branches missed.">    if (this.base64Cert == null &amp;&amp; certificateData.base64Cert == null) {</span>
<span class="nc" id="L658">      return true; // test before shows that fingerprint is equal and then both</span>
                   // objects must refer to same row in Base64CertData
    }
<span class="nc bnc" id="L661" title="All 4 branches missed.">    if (this.base64Cert == null || certificateData.base64Cert == null) {</span>
<span class="nc" id="L662">      return false; // one is null and the other not null</span>
    }
<span class="nc bnc" id="L664" title="All 2 branches missed.">    if (!this.base64Cert.equals(certificateData.base64Cert)) {</span>
<span class="nc" id="L665">      return false;</span>
    }
<span class="nc" id="L667">    return true;</span>
  }

  private boolean equalsNonSensitive(
      final CertificateData certificateData, final boolean strictStatus) {
<span class="nc bnc" id="L672" title="All 2 branches missed.">    if (!issuerDN.equals(certificateData.issuerDN)) {</span>
<span class="nc" id="L673">      return false;</span>
    }
<span class="nc bnc" id="L675" title="All 2 branches missed.">    if (!subjectDN.equals(certificateData.subjectDN)) {</span>
<span class="nc" id="L676">      return false;</span>
    }
<span class="nc bnc" id="L678" title="All 2 branches missed.">    if (!fingerprint.equals(certificateData.fingerprint)) {</span>
<span class="nc" id="L679">      return false;</span>
    }
<span class="nc bnc" id="L681" title="All 2 branches missed.">    if (!StringUtils.equals(cAFingerprint, certificateData.cAFingerprint)) {</span>
<span class="nc" id="L682">      return false;</span>
    }
<span class="nc bnc" id="L684" title="All 2 branches missed.">    if (!equalsStatus(certificateData, strictStatus)) {</span>
<span class="nc" id="L685">      return false;</span>
    }
<span class="nc bnc" id="L687" title="All 2 branches missed.">    if (type != certificateData.type) {</span>
<span class="nc" id="L688">      return false;</span>
    }
<span class="nc bnc" id="L690" title="All 2 branches missed.">    if (!serialNumber.equals(certificateData.serialNumber)) {</span>
<span class="nc" id="L691">      return false;</span>
    }
<span class="nc bnc" id="L693" title="All 2 branches missed.">    if (notBefore == null) {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">      if (certificateData.notBefore != null) {</span>
<span class="nc" id="L695">        return false;</span>
      }
    } else {
<span class="nc bnc" id="L698" title="All 2 branches missed.">      if (!notBefore.equals(certificateData.notBefore)) {</span>
<span class="nc" id="L699">        return false;</span>
      }
    }
<span class="nc bnc" id="L702" title="All 2 branches missed.">    if (expireDate != certificateData.expireDate) {</span>
<span class="nc" id="L703">      return false;</span>
    }
<span class="nc bnc" id="L705" title="All 2 branches missed.">    if (revocationDate != certificateData.revocationDate) {</span>
<span class="nc" id="L706">      return false;</span>
    }
<span class="nc bnc" id="L708" title="All 2 branches missed.">    if (revocationReason != certificateData.revocationReason) {</span>
<span class="nc" id="L709">      return false;</span>
    }
<span class="nc bnc" id="L711" title="All 2 branches missed.">    if (!StringUtils.equals(username, certificateData.username)) {</span>
<span class="nc" id="L712">      return false;</span>
    }
<span class="nc bnc" id="L714" title="All 2 branches missed.">    if (!StringUtils.equals(tag, certificateData.tag)) {</span>
<span class="nc" id="L715">      return false;</span>
    }
<span class="nc bnc" id="L717" title="All 4 branches missed.">    if (certificateProfileId == null</span>
        &amp;&amp; certificateData.certificateProfileId != null) {
<span class="nc" id="L719">      return false;</span>
    }
<span class="nc bnc" id="L721" title="All 2 branches missed.">    if (certificateProfileId != null</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        &amp;&amp; !certificateProfileId.equals(certificateData.certificateProfileId)) {</span>
<span class="nc" id="L723">      return false;</span>
    }
<span class="nc bnc" id="L725" title="All 2 branches missed.">    if (endEntityProfileId == null) {</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">      if (certificateData.endEntityProfileId != null) {</span>
<span class="nc" id="L727">        return false;</span>
      }
    } else {
<span class="nc bnc" id="L730" title="All 2 branches missed.">      if (!endEntityProfileId.equals(certificateData.endEntityProfileId)) {</span>
<span class="nc" id="L731">        return false;</span>
      }
    }
<span class="nc bnc" id="L734" title="All 2 branches missed.">    if (updateTime != certificateData.updateTime) {</span>
<span class="nc" id="L735">      return false;</span>
    }
<span class="nc bnc" id="L737" title="All 2 branches missed.">    if (!StringUtils.equals(subjectAltName, certificateData.subjectAltName)) {</span>
<span class="nc" id="L738">      return false;</span>
    }
<span class="nc" id="L740">    return true;</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L745">    return fingerprint.hashCode() * 11;</span>
  }

  /**
   * @param certificateData Data
   * @param inclusionMode Mode
   */
  public void updateWith(
      final CertificateData certificateData, final boolean inclusionMode) {
<span class="nc" id="L754">    issuerDN = certificateData.issuerDN;</span>
<span class="nc" id="L755">    subjectDN = certificateData.subjectDN;</span>
<span class="nc" id="L756">    fingerprint = certificateData.fingerprint;</span>
<span class="nc" id="L757">    cAFingerprint = certificateData.cAFingerprint;</span>
<span class="nc" id="L758">    status = certificateData.status;</span>
<span class="nc" id="L759">    type = certificateData.type;</span>
<span class="nc" id="L760">    serialNumber = certificateData.serialNumber;</span>
<span class="nc" id="L761">    expireDate = certificateData.expireDate;</span>
<span class="nc" id="L762">    revocationDate = certificateData.revocationDate;</span>
<span class="nc" id="L763">    revocationReason = certificateData.revocationReason;</span>
<span class="nc" id="L764">    setUsername(certificateData.username);</span>
<span class="nc" id="L765">    tag = certificateData.tag;</span>
<span class="nc" id="L766">    certificateProfileId = certificateData.certificateProfileId;</span>
<span class="nc" id="L767">    updateTime = certificateData.updateTime;</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">    base64Cert = inclusionMode ? null : certificateData.base64Cert;</span>
<span class="nc" id="L769">  }</span>

  //
  // Search functions (deprecated, use methods in CertificateDataSession
  // instead)
  //

  /**
   * @param entityManager EM
   * @param fingerprint FP
   * @return cert
   * @deprecated Since 6.13.0. Use method in CertificateDataSession instead
   */
  @Deprecated
  public static CertificateData findByFingerprint(
      final EntityManager entityManager, final String fingerprint) {
<span class="nc" id="L785">    return entityManager.find(CertificateData.class, fingerprint);</span>
  }

  /**
   * Get next batchSize row ordered by fingerprint. Used by OcspMonitoringTool.
   *
   * @param entityManager EM
   * @param certificateProfileId ID
   * @param currentFingerprint FP
   * @param batchSize Size
   * @return List of certificates
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public static List&lt;CertificateData&gt; getNextBatch(
      final EntityManager entityManager,
      final int certificateProfileId,
      final String currentFingerprint,
      final int batchSize) {
<span class="nc" id="L803">    final Query query =</span>
<span class="nc" id="L804">        entityManager.createQuery(</span>
            &quot;SELECT a FROM CertificateData a WHERE&quot;
                + &quot; a.fingerprint&gt;:currentFingerprint AND&quot;
                + &quot; a.certificateProfileId=:certificateProfileId ORDER BY&quot;
                + &quot; a.fingerprint ASC&quot;);
<span class="nc" id="L809">    query.setParameter(&quot;certificateProfileId&quot;, certificateProfileId);</span>
<span class="nc" id="L810">    query.setParameter(&quot;currentFingerprint&quot;, currentFingerprint);</span>
<span class="nc" id="L811">    query.setMaxResults(batchSize);</span>
<span class="nc" id="L812">    return query.getResultList();</span>
  }

  /**
   * Returns the number of entries with the given certificate profile. Used by
   * OcspMonitoringTool.
   *
   * @param entityManager EM
   * @param certificateProfileId ID
   * @return count
   */
  public static long getCount(
      final EntityManager entityManager, final int certificateProfileId) {
<span class="nc" id="L825">    final Query countQuery =</span>
<span class="nc" id="L826">        entityManager.createQuery(</span>
            &quot;SELECT COUNT(a) FROM CertificateData a WHERE&quot;
                + &quot; a.certificateProfileId=:certificateProfileId&quot;);
<span class="nc" id="L829">    countQuery.setParameter(&quot;certificateProfileId&quot;, certificateProfileId);</span>
<span class="nc" id="L830">    return ((Long) countQuery.getSingleResult())</span>
<span class="nc" id="L831">        .longValue(); // Always returns a result</span>
  }

  /**
   * Returns a list of Certificate Profile IDs that are used in certificates.
   * Used by OcspMonitoringTool.
   *
   * @param entityManager EM
   * @return IDs
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public static List&lt;Integer&gt; getUsedCertificateProfileIds(
      final EntityManager entityManager) {
<span class="nc" id="L844">    final Query query =</span>
<span class="nc" id="L845">        entityManager.createQuery(</span>
            &quot;SELECT DISTINCT a.certificateProfileId FROM CertificateData a&quot;
                + &quot; ORDER BY a.certificateProfileId&quot;);
<span class="nc" id="L848">    return query.getResultList();</span>
  }

  //
  // Start Database integrity protection methods
  //

  @Transient
  @Override
  protected String getProtectString(final int version) {
<span class="nc" id="L858">    final int cap = 3000;</span>
<span class="nc" id="L859">    final ProtectionStringBuilder build = new ProtectionStringBuilder(cap);</span>
    // What is important to protect here is the data that we define, id, name
    // and certificate profile data
    // rowVersion is automatically updated by JPA, so it's not important, it is
    // only used for optimistic locking
<span class="nc" id="L864">    build.append(getFingerprint()).append(getIssuerDN());</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">    if (version &gt;= 3) {</span>
      // From version 3 for EJBCA 6.7 we always use empty String here to allow
      // future migration between databases when this value is unset
<span class="nc" id="L868">      build.append(getSubjectDnNeverNull());</span>
    } else {
<span class="nc" id="L870">      build.append(getSubjectDN());</span>
    }
<span class="nc" id="L872">    build</span>
<span class="nc" id="L873">        .append(getCaFingerprint())</span>
<span class="nc" id="L874">        .append(getStatus())</span>
<span class="nc" id="L875">        .append(getType())</span>
<span class="nc" id="L876">        .append(getSerialNumber())</span>
<span class="nc" id="L877">        .append(getExpireDate())</span>
<span class="nc" id="L878">        .append(getRevocationDate())</span>
<span class="nc" id="L879">        .append(getRevocationReason())</span>
<span class="nc" id="L880">        .append(getBase64Cert())</span>
<span class="nc" id="L881">        .append(getUsername())</span>
<span class="nc" id="L882">        .append(getTag())</span>
<span class="nc" id="L883">        .append(getCertificateProfileId())</span>
<span class="nc" id="L884">        .append(getUpdateTime())</span>
<span class="nc" id="L885">        .append(getSubjectKeyId());</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">    if (version &gt;= 2) {</span>
      // In version 2 for EJBCA 6.6 the following columns where added
<span class="nc" id="L888">      build.append(String.valueOf(getNotBefore()));</span>
<span class="nc" id="L889">      build.append(String.valueOf(getEndEntityProfileId()));</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">      if (version &gt;= 3) {</span>
        // From version 3 for EJBCA 6.7 we always use empty String here to allow
        // future migration between databases when this value is unset
<span class="nc" id="L893">        build.append(getSubjectAltNameNeverNull());</span>
      } else {
<span class="nc" id="L895">        build.append(String.valueOf(getSubjectAltName()));</span>
      }
    }
<span class="nc bnc" id="L898" title="All 2 branches missed.">    if (LOG.isDebugEnabled()) {</span>
      // Some profiling
<span class="nc bnc" id="L900" title="All 2 branches missed.">      if (build.length() &gt; cap) {</span>
<span class="nc" id="L901">        LOG.debug(</span>
<span class="nc" id="L902">            &quot;CertificateData.getProtectString gives size: &quot; + build.length());</span>
      }
    }
<span class="nc" id="L905">    return build.toString();</span>
  }

  @Transient
  @Override
  protected int getProtectVersion() {
<span class="nc" id="L911">    final int version = 3;</span>
<span class="nc" id="L912">    return version;</span>
  }

  @PrePersist
  @PreUpdate
  @Override
  protected void protectData() {
<span class="nc" id="L919">    super.protectData();</span>
<span class="nc" id="L920">  }</span>

  @PostLoad
  @Override
  protected void verifyData() {
<span class="nc" id="L925">    super.verifyData();</span>
<span class="nc" id="L926">  }</span>

  @Override
  @Transient
  protected String getRowId() {
<span class="nc" id="L931">    return getFingerprint();</span>
  }

  //
  // End Database integrity protection methods
  //
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>