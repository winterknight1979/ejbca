<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuditRecordData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CeSeCore Security JPA Entities</a> &gt; <a href="index.source.html" class="el_package">org.cesecore.audit.impl.integrityprotected</a> &gt; <span class="el_source">AuditRecordData.java</span></div><h1>AuditRecordData.java</h1><pre class="source lang-java linenums">/*************************************************************************
 *                                                                       *
 *  CESeCore: CE Security Core                                           *
 *                                                                       *
 *  This software is free software; you can redistribute it and/or       *
 *  modify it under the terms of the GNU Lesser General Public           *
 *  License as published by the Free Software Foundation; either         *
 *  version 2.1 of the License, or any later version.                    *
 *                                                                       *
 *  See terms of license at gnu.org.                                     *
 *                                                                       *
 *************************************************************************/
package org.cesecore.audit.impl.integrityprotected;

import java.io.Serializable;
import java.util.Map;
import javax.persistence.Entity;
import javax.persistence.PostLoad;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;
import javax.persistence.Transient;
import org.apache.commons.lang.StringUtils;
import org.cesecore.audit.AuditLogEntry;
import org.cesecore.audit.enums.EventStatus;
import org.cesecore.audit.enums.EventType;
import org.cesecore.audit.enums.EventTypeHolder;
import org.cesecore.audit.enums.ModuleType;
import org.cesecore.audit.enums.ModuleTypeHolder;
import org.cesecore.audit.enums.ServiceType;
import org.cesecore.audit.enums.ServiceTypeHolder;
import org.cesecore.dbprotection.ProtectedData;
import org.cesecore.dbprotection.ProtectionStringBuilder;
import org.cesecore.util.CertTools;
import org.cesecore.util.GUIDGenerator;
import org.cesecore.util.XmlSerializer;

/**
 * This class represents an audit log record.
 *
 * &lt;p&gt;The following index is recommended as a minimum: create unique index
 * auditrecorddata_idx1 on AuditRecordData (nodeId,timeStamp,sequenceNumber);
 *
 * @version $Id: AuditRecordData.java 28560 2018-03-27 12:39:10Z
 *     jekaterina_b_helmes $
 */
@Entity
@Table(name = &quot;AuditRecordData&quot;)
public class AuditRecordData extends ProtectedData
    implements Serializable, AuditLogEntry {

  private static final long serialVersionUID = 3998646190932834045L;

  /** Key. */
  private String pk;
  /** ID. */
  private String nodeId;
  /** Sequence. */
  private Long sequenceNumber;
  /** Time. */
  private Long timeStamp;
  /** Type. */
  private String eventType;
  /** Status. */
  private String eventStatus;
  /** Auth. */
  private String authToken;
  /** Service. */
  private String service;
  /** Mod. */
  private String module;
  /**ID. */
  private String customId;
  /** Search. */
  private String searchDetail1;
  /** Search. */
  private String searchDetail2;
  /** Details. */
  private String additionalDetails;
  /** Version. */
<span class="nc" id="L81">  private int rowVersion = 0;</span>
  /** Protection. */
  private String rowProtection;

  /** Null constructor. */
<span class="nc" id="L86">  public AuditRecordData() { }</span>

  /**   *
   * @param aNodeId ID
   * @param aSequenceNumber SN
   * @param aTimeStamp TS
   * @param anEventType Type
   * @param anEventStatus Status
   * @param anAuthToken Token
   * @param aService Service
   * @param aModule Mod
   * @param aCustomId ID
   * @param theSearchDetail1 Search
   * @param theSearchDetail2 Search
   * @param theAdditionalDetails Details
   */
  public AuditRecordData(
      final String aNodeId,
      final Long aSequenceNumber,
      final Long aTimeStamp,
      final EventType anEventType,
      final EventStatus anEventStatus,
      final String anAuthToken,
      final ServiceType aService,
      final ModuleType aModule,
      final String aCustomId,
      final String theSearchDetail1,
      final String theSearchDetail2,
<span class="nc" id="L114">      final Map&lt;String, Object&gt; theAdditionalDetails) {</span>
<span class="nc" id="L115">    this.pk = GUIDGenerator.generateGUID(this);</span>
<span class="nc" id="L116">    this.nodeId = aNodeId;</span>
<span class="nc" id="L117">    this.sequenceNumber = aSequenceNumber;</span>
<span class="nc" id="L118">    this.timeStamp = aTimeStamp;</span>
<span class="nc" id="L119">    this.eventType = anEventType.toString();</span>
<span class="nc" id="L120">    this.eventStatus = anEventStatus.toString();</span>
<span class="nc" id="L121">    this.authToken = anAuthToken;</span>
<span class="nc" id="L122">    this.service = aService.toString();</span>
<span class="nc" id="L123">    this.module = aModule.toString();</span>
<span class="nc" id="L124">    this.customId = aCustomId;</span>
<span class="nc" id="L125">    this.searchDetail1 = theSearchDetail1;</span>
<span class="nc" id="L126">    this.searchDetail2 = theSearchDetail2;</span>
<span class="nc" id="L127">    setMapAdditionalDetails(theAdditionalDetails);</span>
<span class="nc" id="L128">  }</span>

  /** @return the primary key */
  public String getPk() {
<span class="nc" id="L132">    return pk;</span>
  }

  /** @param apk is the primary key */
  public void setPk(final String apk) {
<span class="nc" id="L137">    this.pk = apk;</span>
<span class="nc" id="L138">  }</span>

  @Override
  public String getNodeId() {
<span class="nc" id="L142">    return nodeId;</span>
  }

  /** @param aNodeId The node identifier that this log record comes from. */
  public void setNodeId(final String aNodeId) {
<span class="nc" id="L147">    this.nodeId = aNodeId;</span>
<span class="nc" id="L148">  }</span>

  @Override
  public Long getSequenceNumber() {
<span class="nc" id="L152">    return sequenceNumber;</span>
  }

  /** @param aSequenceNumber This log sequence number MUST be unique. */
  public void setSequenceNumber(final Long aSequenceNumber) {
<span class="nc" id="L157">    this.sequenceNumber = aSequenceNumber;</span>
<span class="nc" id="L158">  }</span>

  @Override
  public Long getTimeStamp() {
<span class="nc" id="L162">    return timeStamp;</span>
  }

  /** @param aTimeStamp Sets Timestamp to this value. */
  public void setTimeStamp(final Long aTimeStamp) {
<span class="nc" id="L167">    this.timeStamp = aTimeStamp;</span>
<span class="nc" id="L168">  }</span>

  /** @return event type string. @see EventTypes */
  public String getEventType() {
<span class="nc" id="L172">    return eventType;</span>
  }

  /**
   * Sets event type. @see EventTypes
   *
   * @param anEventType should match the enumeration names.
   */
  public void setEventType(final String anEventType) {
<span class="nc" id="L181">    this.eventType = anEventType;</span>
<span class="nc" id="L182">  }</span>

  /** @return event status. @see EventStatusEnum */
  public String getEventStatus() {
<span class="nc" id="L186">    return eventStatus;</span>
  }

  @Transient
  @Override
  public EventStatus getEventStatusValue() {
<span class="nc" id="L192">    return EventStatus.valueOf(getEventStatus());</span>
  }

  /**
   * Sets event type. @see EventStatusEnum
   *
   * @param anEventStatus should match the enumeration names.
   */
  public void setEventStatus(final String anEventStatus) {
<span class="nc" id="L201">    this.eventStatus = anEventStatus;</span>
<span class="nc" id="L202">  }</span>

  @Override
  public String getAuthToken() {
<span class="nc" id="L206">    return authToken;</span>
  }

  /**
   * Sets the user that triggered the creation of a log.
   *
   * @param anAuthToken user id. Normally obtained by the following example:
   *     authenticationToken.toString()
   */
  public void setAuthToken(final String anAuthToken) {
<span class="nc" id="L216">    this.authToken = anAuthToken;</span>
<span class="nc" id="L217">  }</span>

  /**
   * Gets service type. @see ServiceTypes
   *
   * @return service
   */
  public String getService() {
<span class="nc" id="L225">    return service;</span>
  }

  /**
   * Sets service type. @see ServiceTypes
   *
   * @param aService service
   */
  public void setService(final String aService) {
<span class="nc" id="L234">    this.service = aService;</span>
<span class="nc" id="L235">  }</span>

  /**
   * Gets module type. @see ModuleTypes
   *
   * @return module type.
   */
  public String getModule() {
<span class="nc" id="L243">    return module;</span>
  }

  /**
   * Sets module type. @see ModuleTypes
   *
   * @param aModule Module type.
   */
  public void setModule(final String aModule) {
<span class="nc" id="L252">    this.module = aModule;</span>
<span class="nc" id="L253">  }</span>

  @Override
  public String getCustomId() {
<span class="nc" id="L257">    return customId;</span>
  }

  /**
   * @param aCustomId ID
   */
  public void setCustomId(final String aCustomId) {
<span class="nc" id="L264">    this.customId = aCustomId;</span>
<span class="nc" id="L265">  }</span>

  @Override
  public String getSearchDetail1() {
<span class="nc" id="L269">    return searchDetail1;</span>
  }

  /**
   * @param aSearchDetail1 Search
   */
  public void setSearchDetail1(final String aSearchDetail1) {
<span class="nc" id="L276">    this.searchDetail1 = aSearchDetail1;</span>
<span class="nc" id="L277">  }</span>

  @Override
  public String getSearchDetail2() {
<span class="nc" id="L281">    return searchDetail2;</span>
  }

  /**
   * @param aSearchDetail2 Search
   */
  public void setSearchDetail2(final String aSearchDetail2) {
<span class="nc" id="L288">    this.searchDetail2 = aSearchDetail2;</span>
<span class="nc" id="L289">  }</span>

  /**
   * @return RDN value
   */
  @Transient
  public String getUnescapedRndValue() {
<span class="nc" id="L296">    String value = getAdditionalDetails();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">    if (StringUtils.isNotEmpty(value)) {</span>
<span class="nc" id="L298">      return CertTools.getUnescapedRdnValue(value);</span>
    } else {
<span class="nc" id="L300">      return value;</span>
    }
  }

  /** @return additional details in raw format. */
  public String getAdditionalDetails() {
<span class="nc" id="L306">    return additionalDetails;</span>
  }

  /**
   * Sets additional details in raw format.
   *
   * @param theAdditionalDetails details
   */
  public void setAdditionalDetails(final String theAdditionalDetails) {
<span class="nc" id="L315">    this.additionalDetails = theAdditionalDetails;</span>
<span class="nc" id="L316">  }</span>

  /**
   * @return version
   */
  // @Version @Column
  public int getRowVersion() {
<span class="nc" id="L323">    return rowVersion;</span>
  }

  /**
   * @param aRowVersion version
   */
  public void setRowVersion(final int aRowVersion) {
<span class="nc" id="L330">    this.rowVersion = aRowVersion;</span>
<span class="nc" id="L331">  }</span>

  // @Column @Lob
  @Override
  public String getRowProtection() {
<span class="nc" id="L336">    return rowProtection;</span>
  }

  @Override
  public void setRowProtection(final String aRowProtection) {
<span class="nc" id="L341">    this.rowProtection = aRowProtection;</span>
<span class="nc" id="L342">  }</span>

  /** @return additional details. */
  @Transient
  @Override
  public Map&lt;String, Object&gt; getMapAdditionalDetails() {
    // TODO: Decide on which implementation to use for serialization of the
    // additional details
<span class="nc" id="L350">    return XmlSerializer.decode(getUnescapedRndValue());</span>
  }

  /** @param theAdditionalDetails additional details. */
  @Transient
  public void setMapAdditionalDetails(
      final Map&lt;String, Object&gt; theAdditionalDetails) {
    // TODO: Decide on which implementation to use for serialization of the
    // additional details
<span class="nc" id="L359">    setAdditionalDetails(XmlSerializer.encode(theAdditionalDetails));</span>
    // setAdditionalDetails(JsonSerializer.toJSON(additionalDetails));
<span class="nc" id="L361">  }</span>

  //
  // Start Database integrity protection methods
  //

  @Transient
  @Override
  protected String getProtectString(final int version) {
<span class="nc" id="L370">    final ProtectionStringBuilder build = new ProtectionStringBuilder();</span>
    // What is important to protect here is the data that we define
    // rowVersion is automatically updated by JPA, so it's not important, it is
    // only used for optimistic locking
<span class="nc" id="L374">    build</span>
<span class="nc" id="L375">        .append(getPk())</span>
<span class="nc" id="L376">        .append(getNodeId())</span>
<span class="nc" id="L377">        .append(getSequenceNumber())</span>
<span class="nc" id="L378">        .append(getTimeStamp());</span>
<span class="nc" id="L379">    build</span>
<span class="nc" id="L380">        .append(getEventType())</span>
<span class="nc" id="L381">        .append(getEventStatus())</span>
<span class="nc" id="L382">        .append(getAuthToken())</span>
<span class="nc" id="L383">        .append(getService())</span>
<span class="nc" id="L384">        .append(getModule());</span>
<span class="nc" id="L385">    build</span>
<span class="nc" id="L386">        .append(getCustomId())</span>
<span class="nc" id="L387">        .append(getSearchDetail1())</span>
<span class="nc" id="L388">        .append(getSearchDetail2())</span>
<span class="nc" id="L389">        .append(getAdditionalDetails());</span>
<span class="nc" id="L390">    return build.toString();</span>
  }

  @Transient
  @Override
  protected int getProtectVersion() {
<span class="nc" id="L396">    return 1;</span>
  }

  @PrePersist
  @PreUpdate
  @Override
  protected void protectData() {
<span class="nc" id="L403">    super.protectData();</span>
<span class="nc" id="L404">  }</span>

  @PostLoad
  @Override
  protected void verifyData() {
<span class="nc" id="L409">    super.verifyData();</span>
<span class="nc" id="L410">  }</span>

  @Override
  @Transient
  protected String getRowId() {
<span class="nc" id="L415">    return getPk();</span>
  }
  //
  // End Database integrity protection methods
  //

  @Override
  @Transient
  public EventType getEventTypeValue() {
<span class="nc" id="L424">    return new EventTypeHolder(getEventType());</span>
  }

  @Override
  @Transient
  public ModuleType getModuleTypeValue() {
<span class="nc" id="L430">    return new ModuleTypeHolder(getModule());</span>
  }

  @Override
  @Transient
  public ServiceType getServiceTypeValue() {
<span class="nc" id="L436">    return new ServiceTypeHolder(getService());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>